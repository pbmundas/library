---
layout: default
title:  Execution
category: Threat-Hunting-Queries  # This becomes a main topic in sidebar
---

## Execution

### T1059: Command and Scripting Interpreter
# Threat Hunting Hypotheses for MITRE ATT&CK T1059: Command and Scripting Interpreter

### T1059.001: PowerShell

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. PowerShell Executions from Suspicious IPs | Adversaries execute PowerShell from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency PowerShell Executions | High-frequency PowerShell executions, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. PowerShell Executions Outside Business Hours | PowerShell executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. PowerShell Executions Triggering Suspicious Processes | PowerShell spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*powershell.exe" Image IN ("*rundll32.exe*", "*regsvr32.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "powershell.exe" and ProcessName has_any ("rundll32.exe", "regsvr32.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*powershell.exe" AND process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. PowerShell Executions from Anomalous Locations | PowerShell executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. PowerShell Executions in Cloud Environments | PowerShell used in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*powershell.exe" AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "powershell.exe" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*powershell.exe" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. PowerShell Executions with Suspicious User Agents | PowerShell accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. PowerShell Executions Followed by File Creation | PowerShell executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.ps1")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".ps1")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.ps1") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. PowerShell Executions with Anomalous Protocols | PowerShell executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. PowerShell Executions via Known Vulnerable Services | PowerShell executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1059.002: AppleScript

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. AppleScript Executions from Suspicious IPs | Adversaries execute AppleScript from known malicious IPs, as in Lazarus Group. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency AppleScript Executions | High-frequency AppleScript executions, as in APT32. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. AppleScript Executions Outside Business Hours | AppleScript executions outside business hours, as in APT29 macOS variants. | - Process Creation (DS0009: Sysmon-like on macOS) | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. AppleScript Executions Triggering Suspicious Processes | AppleScript spawning suspicious child processes, as in Cobalt Strike macOS beacons. | - Process Creation (DS0009: Sysmon-like on macOS) | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" \| join dest_host [search index=endpoint sourcetype=macos:process EventCode=1 ParentImage="*osascript" Image IN ("*sh", "*bash")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "osascript" and ProcessName has_any ("sh", "bash")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*osascript" AND process.executable : ("*sh" OR "*bash") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. AppleScript Executions from Anomalous Locations | AppleScript executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. AppleScript Executions in Cloud Environments | AppleScript used in cloud-managed macOS endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*osascript" AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "osascript" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*osascript" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. AppleScript Executions with Suspicious User Agents | AppleScript accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. AppleScript Executions Followed by File Creation | AppleScript executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- File Creation (DS0013) | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" \| join dest_host [search index=endpoint sourcetype=macos:file EventCode=11 FileName IN ("*.sh", "*.app", "*.dmg")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".sh", ".app", ".dmg")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.sh" OR "*.app" OR "*.dmg") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. AppleScript Executions with Anomalous Protocols | AppleScript executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. AppleScript Executions via Known Vulnerable Services | AppleScript executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1059.003: Windows Command Shell

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Windows Command Shell Executions from Suspicious IPs | Adversaries execute cmd.exe from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Windows Command Shell Executions | High-frequency cmd.exe executions, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Windows Command Shell Executions Outside Business Hours | cmd.exe executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Windows Command Shell Executions Triggering Suspicious Processes | cmd.exe spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*cmd.exe" Image IN ("*net.exe*", "*whoami.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "cmd.exe" and ProcessName has_any ("net.exe", "whoami.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*cmd.exe" AND process.executable : ("*net.exe*" OR "*whoami.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Windows Command Shell Executions from Anomalous Locations | cmd.exe executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Windows Command Shell Executions in Cloud Environments | cmd.exe used in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*cmd.exe" AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "cmd.exe" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*cmd.exe" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Windows Command Shell Executions with Suspicious User Agents | cmd.exe accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Windows Command Shell Executions Followed by File Creation | cmd.exe executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.bat", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".bat", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.bat" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Windows Command Shell Executions with Anomalous Protocols | cmd.exe executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Windows Command Shell Executions via Known Vulnerable Services | cmd.exe executed via vulnerable services, as in Patchwork APT. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1059.004: Unix Shell

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Unix Shell Executions from Suspicious IPs | Adversaries execute Unix shells from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Unix Shell Executions | High-frequency Unix shell executions, as in APT41. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Unix Shell Executions Outside Business Hours | Unix shell executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon-like on Linux) | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Unix Shell Executions Triggering Suspicious Processes | Unix shells spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon-like on Linux) | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") \| join dest_host [search index=endpoint sourcetype=linux:process EventCode=1 ParentImage IN ("*bash", "*sh") Image IN ("*curl*", "*wget*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("bash", "sh") and ProcessName has_any ("curl", "wget")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*bash" OR "*sh") AND process.executable : ("*curl*" OR "*wget*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Unix Shell Executions from Anomalous Locations | Unix shell executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Unix Shell Executions in Cloud Environments | Unix shells used in cloud-managed Linux endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*bash", "*sh") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("bash", "sh") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*bash" OR "*sh") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Unix Shell Executions with Suspicious User Agents | Unix shells accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Unix Shell Executions Followed by File Creation | Unix shell executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- File Creation (DS0013) | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") \| join dest_host [search index=endpoint sourcetype=linux:file EventCode=11 FileName IN ("*.elf", "*.sh", "*.so")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".elf", ".sh", ".so")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.elf" OR "*.sh" OR "*.so") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Unix Shell Executions with Anomalous Protocols | Unix shells executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Unix Shell Executions via Known Vulnerable Services | Unix shells executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1059.005: Visual Basic

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Visual Basic Executions from Suspicious IPs | Adversaries execute Visual Basic scripts from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Visual Basic Executions | High-frequency Visual Basic script executions, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Visual Basic Executions Outside Business Hours | Visual Basic script executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Visual Basic Executions Triggering Suspicious Processes | Visual Basic scripts spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*wscript.exe", "*cscript.exe") Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("wscript.exe", "cscript.exe") and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*wscript.exe" OR "*cscript.exe") AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Visual Basic Executions from Anomalous Locations | Visual Basic script executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Visual Basic Executions in Cloud Environments | Visual Basic scripts used in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*wscript.exe", "*cscript.exe") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("wscript.exe", "cscript.exe") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*wscript.exe" OR "*cscript.exe") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Visual Basic Executions with Suspicious User Agents | Visual Basic scripts accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Visual Basic Executions Followed by File Creation | Visual Basic script executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.vbs", "*.dll")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".vbs", ".dll")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.vbs" OR "*.dll") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Visual Basic Executions with Anomalous Protocols | Visual Basic scripts executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Visual Basic Executions via Known Vulnerable Services | Visual Basic scripts executed via vulnerable services, as in APT28. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`.
