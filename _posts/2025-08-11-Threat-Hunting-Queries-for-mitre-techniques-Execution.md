---
layout: default
title:  Execution
category: Threat-Hunting-Queries  # This becomes a main topic in sidebar
---

## Execution

### T1059: Command and Scripting Interpreter
# Threat Hunting Hypotheses for MITRE ATT&CK T1059: Command and Scripting Interpreter

### T1059.001: PowerShell

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. PowerShell Executions from Suspicious IPs | Adversaries execute PowerShell from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency PowerShell Executions | High-frequency PowerShell executions, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. PowerShell Executions Outside Business Hours | PowerShell executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. PowerShell Executions Triggering Suspicious Processes | PowerShell spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*powershell.exe" Image IN ("*rundll32.exe*", "*regsvr32.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "powershell.exe" and ProcessName has_any ("rundll32.exe", "regsvr32.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*powershell.exe" AND process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. PowerShell Executions from Anomalous Locations | PowerShell executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. PowerShell Executions in Cloud Environments | PowerShell used in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*powershell.exe" AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "powershell.exe" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*powershell.exe" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. PowerShell Executions with Suspicious User Agents | PowerShell accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. PowerShell Executions Followed by File Creation | PowerShell executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.ps1")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".ps1")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.ps1") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. PowerShell Executions with Anomalous Protocols | PowerShell executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. PowerShell Executions via Known Vulnerable Services | PowerShell executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1059.002: AppleScript

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. AppleScript Executions from Suspicious IPs | Adversaries execute AppleScript from known malicious IPs, as in Lazarus Group. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency AppleScript Executions | High-frequency AppleScript executions, as in APT32. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. AppleScript Executions Outside Business Hours | AppleScript executions outside business hours, as in APT29 macOS variants. | - Process Creation (DS0009: Sysmon-like on macOS) | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. AppleScript Executions Triggering Suspicious Processes | AppleScript spawning suspicious child processes, as in Cobalt Strike macOS beacons. | - Process Creation (DS0009: Sysmon-like on macOS) | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" \| join dest_host [search index=endpoint sourcetype=macos:process EventCode=1 ParentImage="*osascript" Image IN ("*sh", "*bash")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "osascript" and ProcessName has_any ("sh", "bash")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*osascript" AND process.executable : ("*sh" OR "*bash") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. AppleScript Executions from Anomalous Locations | AppleScript executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. AppleScript Executions in Cloud Environments | AppleScript used in cloud-managed macOS endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*osascript" AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "osascript" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*osascript" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. AppleScript Executions with Suspicious User Agents | AppleScript accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. AppleScript Executions Followed by File Creation | AppleScript executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- File Creation (DS0013) | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" \| join dest_host [search index=endpoint sourcetype=macos:file EventCode=11 FileName IN ("*.sh", "*.app", "*.dmg")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".sh", ".app", ".dmg")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.sh" OR "*.app" OR "*.dmg") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. AppleScript Executions with Anomalous Protocols | AppleScript executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. AppleScript Executions via Known Vulnerable Services | AppleScript executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1059.003: Windows Command Shell

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Windows Command Shell Executions from Suspicious IPs | Adversaries execute cmd.exe from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Windows Command Shell Executions | High-frequency cmd.exe executions, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Windows Command Shell Executions Outside Business Hours | cmd.exe executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Windows Command Shell Executions Triggering Suspicious Processes | cmd.exe spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*cmd.exe" Image IN ("*net.exe*", "*whoami.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "cmd.exe" and ProcessName has_any ("net.exe", "whoami.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*cmd.exe" AND process.executable : ("*net.exe*" OR "*whoami.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Windows Command Shell Executions from Anomalous Locations | cmd.exe executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Windows Command Shell Executions in Cloud Environments | cmd.exe used in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*cmd.exe" AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "cmd.exe" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*cmd.exe" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Windows Command Shell Executions with Suspicious User Agents | cmd.exe accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Windows Command Shell Executions Followed by File Creation | cmd.exe executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.bat", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".bat", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.bat" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Windows Command Shell Executions with Anomalous Protocols | cmd.exe executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Windows Command Shell Executions via Known Vulnerable Services | cmd.exe executed via vulnerable services, as in Patchwork APT. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1059.004: Unix Shell

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Unix Shell Executions from Suspicious IPs | Adversaries execute Unix shells from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Unix Shell Executions | High-frequency Unix shell executions, as in APT41. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Unix Shell Executions Outside Business Hours | Unix shell executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon-like on Linux) | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Unix Shell Executions Triggering Suspicious Processes | Unix shells spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon-like on Linux) | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") \| join dest_host [search index=endpoint sourcetype=linux:process EventCode=1 ParentImage IN ("*bash", "*sh") Image IN ("*curl*", "*wget*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("bash", "sh") and ProcessName has_any ("curl", "wget")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*bash" OR "*sh") AND process.executable : ("*curl*" OR "*wget*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Unix Shell Executions from Anomalous Locations | Unix shell executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Unix Shell Executions in Cloud Environments | Unix shells used in cloud-managed Linux endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*bash", "*sh") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("bash", "sh") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*bash" OR "*sh") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Unix Shell Executions with Suspicious User Agents | Unix shells accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Unix Shell Executions Followed by File Creation | Unix shell executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- File Creation (DS0013) | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") \| join dest_host [search index=endpoint sourcetype=linux:file EventCode=11 FileName IN ("*.elf", "*.sh", "*.so")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".elf", ".sh", ".so")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.elf" OR "*.sh" OR "*.so") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Unix Shell Executions with Anomalous Protocols | Unix shells executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Unix Shell Executions via Known Vulnerable Services | Unix shells executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1059.005: Visual Basic

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Visual Basic Executions from Suspicious IPs | Adversaries execute Visual Basic scripts from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Visual Basic Executions | High-frequency Visual Basic script executions, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Visual Basic Executions Outside Business Hours | Visual Basic script executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Visual Basic Executions Triggering Suspicious Processes | Visual Basic scripts spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*wscript.exe", "*cscript.exe") Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("wscript.exe", "cscript.exe") and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*wscript.exe" OR "*cscript.exe") AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Visual Basic Executions from Anomalous Locations | Visual Basic script executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Visual Basic Executions in Cloud Environments | Visual Basic scripts used in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*wscript.exe", "*cscript.exe") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("wscript.exe", "cscript.exe") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*wscript.exe" OR "*cscript.exe") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Visual Basic Executions with Suspicious User Agents | Visual Basic scripts accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Visual Basic Executions Followed by File Creation | Visual Basic script executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.vbs", "*.dll")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".vbs", ".dll")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.vbs" OR "*.dll") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Visual Basic Executions with Anomalous Protocols | Visual Basic scripts executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Visual Basic Executions via Known Vulnerable Services | Visual Basic scripts executed via vulnerable services, as in APT28. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`.


### T1059.006: Python

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Python Executions from Suspicious IPs | Adversaries execute Python scripts from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Python Executions | High-frequency Python script executions, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Python Executions Outside Business Hours | Python executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Python Executions Triggering Suspicious Processes | Python spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*python.exe" Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "python.exe" and ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*python.exe" AND process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Python Executions from Anomalous Locations | Python executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Python Executions in Cloud Environments | Python used in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*python.exe" AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "python.exe" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*python.exe" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Python Executions with Suspicious User Agents | Python accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Python Executions Followed by File Creation | Python executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.py", "*.dll")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".py", ".dll")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.py" OR "*.dll") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Python Executions with Anomalous Protocols | Python executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Python Executions via Known Vulnerable Services | Python executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1059.007: JavaScript

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. JavaScript Executions from Suspicious IPs | Adversaries execute JavaScript from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency JavaScript Executions | High-frequency JavaScript executions, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. JavaScript Executions Outside Business Hours | JavaScript executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. JavaScript Executions Triggering Suspicious Processes | JavaScript spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*node.exe", "*wscript.exe", "*cscript.exe") Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. JavaScript Executions from Anomalous Locations | JavaScript executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. JavaScript Executions in Cloud Environments | JavaScript used in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. JavaScript Executions with Suspicious User Agents | JavaScript accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. JavaScript Executions Followed by File Creation | JavaScript executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.js", "*.dll")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".js", ".dll")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.js" OR "*.dll") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. JavaScript Executions with Anomalous Protocols | JavaScript executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. JavaScript Executions via Known Vulnerable Services | JavaScript executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1059.008: Network Device CLI

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Network Device CLI Commands from Suspicious IPs | Adversaries execute CLI commands on network devices from known malicious IPs, as in Volt Typhoon. | - Network Device Logs (DS0003: Syslog)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") AND src_ip IN (threat_intel_ips) \| stats count by src_ip, dest_host, command \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") and RemoteIP in (threatIntelIPs) \| summarize count() by RemoteIP, DeviceName, AdditionalFields.Command \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY source.ip, host.name, event.command HAVING COUNT() > 5`. |
| 2. High-Frequency Network Device CLI Commands | High-frequency CLI command executions, as in APT41. | - Network Device Logs (DS0003: Syslog)<br>- Metrics | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") \| timechart span=1h count by dest_host, command \| where count > avg(count)*3`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName, AdditionalFields.Command \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name, event.command \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Network Device CLI Commands Outside Business Hours | CLI commands executed outside business hours, as in APT29. | - Network Device Logs (DS0003: Syslog) | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") AND (_time < "08:00" OR _time > "18:00") \| stats count by src_ip, dest_host, command \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by RemoteIP, DeviceName, AdditionalFields.Command \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY source.ip, host.name, event.command HAVING COUNT() > 5`. |
| 4. Network Device CLI Commands Triggering Suspicious Actions | CLI commands triggering suspicious configuration changes, as in Cobalt Strike. | - Network Device Logs (DS0003: Syslog) | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") command IN ("*config t*", "*set policy*") \| stats count by src_ip, dest_host, command \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") and AdditionalFields.Command has_any ("config t", "set policy") \| summarize count() by RemoteIP, DeviceName, AdditionalFields.Command \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] AND event.command : ("*config t*" OR "*set policy*") \| STATS COUNT() BY source.ip, host.name, event.command HAVING COUNT() > 5`. |
| 5. Network Device CLI Commands from Anomalous Locations | CLI commands from unexpected geographic locations, as in FIN7. | - Network Device Logs (DS0003: Syslog)<br>- GeoIP Data | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") AND src_geo NOT IN (trusted_locations) \| stats count by src_geo, dest_host, command \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") and GeoLocation !in (trustedLocations) \| summarize count() by GeoLocation, DeviceName, AdditionalFields.Command \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY source.geo.location, host.name, event.command HAVING COUNT() > 5`. |
| 6. Network Device CLI Commands in Cloud Environments | CLI commands executed on cloud-managed network devices, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Device Logs (DS0003) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("ExecuteCommand", "ModifyConfig") AND device_type IN ("cisco", "juniper") AND src_ip NOT IN (trusted_ips) \| stats count by src_ip, device_name, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ExecuteCommand", "ModifyConfig") and DeviceType has_any ("cisco", "juniper") and ClientIP !in (trustedIPs) \| summarize count() by ClientIP, DeviceName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['ExecuteCommand', 'ModifyConfig'] AND event.device IN ['cisco', 'juniper'] AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, event.device, event.action HAVING COUNT() > 5`. |
| 7. Network Device CLI Commands with Suspicious User Agents | CLI commands accessed with non-standard user agents, as in Volt Typhoon. | - Network Device Logs (DS0003: Syslog)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by dest_host, command, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by DeviceName, AdditionalFields.Command, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY host.name, event.command, http.user_agent HAVING COUNT() > 5`. |
| 8. Network Device CLI Commands Followed by Config Changes | CLI commands leading to suspicious configuration changes, as in APT41. | - Network Device Logs (DS0003: Syslog) | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") command IN ("*write memory*", "*commit*") \| stats count by src_ip, dest_host, command \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") and AdditionalFields.Command has_any ("write memory", "commit") \| summarize count() by RemoteIP, DeviceName, AdditionalFields.Command \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] AND event.command : ("*write memory*" OR "*commit*") \| STATS COUNT() BY source.ip, host.name, event.command HAVING COUNT() > 5`. |
| 9. Network Device CLI Commands with Anomalous Protocols | CLI commands executed via non-standard protocols, as in 2025 trends. | - Network Device Logs (DS0003: Syslog)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("ssh", "telnet")] \| stats count by dest_host, command, service \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("ssh", "telnet")) on DeviceName \| summarize count() by DeviceName, AdditionalFields.Command, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['ssh', 'telnet'] \| STATS COUNT() BY host.name, event.command, network.protocol HAVING COUNT() > 5`. |
| 10. Network Device CLI Commands via Known Vulnerable Services | CLI commands executed via vulnerable services, as in FIN7. | - Network Device Logs (DS0003: Syslog)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") AND service IN (known_vuln_services) \| stats count by src_ip, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") and AdditionalFields.Service in (knownVulnServices) \| summarize count() by RemoteIP, DeviceName, AdditionalFields.Service \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] AND event.service IN ['known_vuln_services'] \| STATS COUNT() BY source.ip, host.name, event.service HAVING COUNT() > 5`. |

### T1059.009: Cloud API

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Cloud API Calls from Suspicious IPs | Adversaries execute Cloud API calls from known malicious IPs, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances", "CreateUser") AND src_ip IN (threat_intel_ips) \| stats count by user, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances", "CreateUser") and ClientIP in (threatIntelIPs) \| summarize count() by Account, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances', 'CreateUser'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY user.name, source.ip, event.action HAVING COUNT() > 5`. |
| 2. High-Frequency Cloud API Calls | High-frequency Cloud API calls, as in APT41. | - Cloud Audit Logs (AWS IAM, Azure AD) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances", "CreateUser") \| timechart span=1h count by user, eventName \| where count > avg(count)*3`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances", "CreateUser") \| summarize HourlyCount=count() by bin(Timestamp, 1h), Account, ActionType \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances', 'CreateUser'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), user.name, event.action \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Cloud API Calls Outside Business Hours | Cloud API calls executed outside business hours, as in APT29. | - Cloud Audit Logs (AWS IAM, Azure AD) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances", "CreateUser") AND (_time < "08:00" OR _time > "18:00") \| stats count by user, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances", "CreateUser") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by Account, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances', 'CreateUser'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY user.name, source.ip, event.action HAVING COUNT() > 5`. |
| 4. Cloud API Calls Triggering Suspicious Actions | Cloud API calls triggering suspicious actions, as in Cobalt Strike. | - Cloud Audit Logs (AWS IAM, Azure AD) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("DeleteUser", "ModifyInstance", "AttachPolicy") \| stats count by user, eventName, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("DeleteUser", "ModifyInstance", "AttachPolicy") \| summarize count() by Account, ActionType, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['DeleteUser', 'ModifyInstance', 'AttachPolicy'] \| STATS COUNT() BY user.name, event.action, source.ip HAVING COUNT() > 5`. |
| 5. Cloud API Calls from Anomalous Locations | Cloud API calls from unexpected geographic locations, as in FIN7. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- GeoIP Data | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances", "CreateUser") AND src_geo NOT IN (trusted_locations) \| stats count by user, src_geo, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances", "CreateUser") and GeoLocation !in (trustedLocations) \| summarize count() by Account, GeoLocation, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances', 'CreateUser'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY user.name, source.geo.location, event.action HAVING COUNT() > 5`. |
| 6. Cloud API Calls with Suspicious User Agents | Cloud API calls with non-standard user agents, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances", "CreateUser") \| join src_ip [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by user, src_ip, user_agent \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances", "CreateUser") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on ClientIP \| summarize count() by Account, ClientIP, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances', 'CreateUser'] \| JOIN logs-zeek.http-* ON source.ip WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY user.name, source.ip, http.user_agent HAVING COUNT() > 5`. |
| 7. Cloud API Calls Followed by File Creation | Cloud API calls leading to suspicious file creation, as in APT41. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances") \| join user [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.zip", "*.scr")] \| stats count by user, FileName, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".zip", ".scr")) on Account \| summarize count() by Account, FileName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances'] \| JOIN logs-endpoint.file-* ON user.name WHERE file.name : ("*.exe" OR "*.zip" OR "*.scr") \| STATS COUNT() BY user.name, file.name, event.action HAVING COUNT() > 5`. |
| 8. Cloud API Calls with High Rate Limits | Cloud API calls exceeding rate limits, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("APICall") \| timechart span=1m count by user \| where count > rate_limit_threshold`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("APICall") \| summarize MinuteCount=count() by bin(Timestamp, 1m), Account \| where MinuteCount > rateLimitThreshold`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['APICall'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), user.name \| WHERE COUNT() > rate_limit_threshold`. |
| 9. Cloud API Calls with Anomalous Patterns | Cloud API calls with repetitive or scripted patterns, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances", "CreateUser") \| timechart span=1s count by user \| where count > avg(count)*5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances", "CreateUser") \| summarize SecondCount=count() by bin(Timestamp, 1s), Account \| where SecondCount > avg(SecondCount) * 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances', 'CreateUser'] \| STATS COUNT() BY date_histogram(@timestamp, '1s'), user.name \| WHERE COUNT() > AVG(COUNT()) * 5`. |
| 10. Cloud API Calls via Known Vulnerable Services | Cloud API calls via vulnerable services, as in FIN7. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances", "CreateUser") AND service IN (known_vuln_services) \| stats count by user, service, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances", "CreateUser") and ServiceName in (knownVulnServices) \| summarize count() by Account, ServiceName, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances', 'CreateUser'] AND event.service IN ['known_vuln_services'] \| STATS COUNT() BY user.name, event.service, source.ip HAVING COUNT() > 5`. |


### T1106: Native API

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Native API Calls from Suspicious IPs | Adversaries use Native API calls from malicious IPs, as seen in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Native API Calls | High-frequency Native API calls, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Native API Calls Outside Business Hours | Native API executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Native API Calls Triggering Suspicious Processes | Native API calls spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*rundll32.exe*", "*regsvr32.exe*") Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Native API Calls from Anomalous Locations | Native API calls from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Native API Calls in Cloud Environments | Native API calls in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*rundll32.exe*", "*regsvr32.exe*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("rundll32.exe", "regsvr32.exe") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Native API Calls with Suspicious User Agents | Native API calls with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Native API Calls Followed by File Creation | Native API calls leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Native API Calls with Anomalous Protocols | Native API calls executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Native API Calls via Known Vulnerable Services | Native API calls executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1204: User Execution
### T1204.001: Malicious Link

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Malicious Link Access from Suspicious IPs | Users access malicious links from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0029: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) AND src_ip IN (threat_intel_ips) \| stats count by src_ip, uri, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) and RemoteIP in (threatIntelIPs) \| summarize count() by RemoteIP, AdditionalFields.Uri, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY source.ip, http.uri, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Malicious Link Access | High-frequency access to malicious links, as in APT41. | - Network Traffic (DS0029: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) \| timechart span=1h count by uri, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) \| summarize HourlyCount=count() by bin(Timestamp, 1h), AdditionalFields.Uri, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), http.uri, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Malicious Link Access Outside Business Hours | Malicious link access outside business hours, as in APT29. | - Network Traffic (DS0029: Zeek HTTP) | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) AND (_time < "08:00" OR _time > "18:00") \| stats count by src_ip, uri, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by RemoteIP, AdditionalFields.Uri, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY source.ip, http.uri, host.name HAVING COUNT() > 5`. |
| 4. Malicious Link Access Triggering Suspicious Processes | Malicious link access followed by suspicious process execution, as in Cobalt Strike. | - Network Traffic (DS0029: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by src_ip, uri, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by RemoteIP, AdditionalFields.Uri, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY source.ip, http.uri, process.executable HAVING COUNT() > 5`. |
| 5. Malicious Link Access from Anomalous Locations | Malicious link access from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029: Zeek HTTP)<br>- GeoIP Data | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) AND src_geo NOT IN (trusted_locations) \| stats count by src_geo, uri, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) and GeoLocation !in (trustedLocations) \| summarize count() by GeoLocation, AdditionalFields.Uri, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY source.geo.location, http.uri, host.name HAVING COUNT() > 5`. |
| 6. Malicious Link Access in Cloud Environments | Malicious link access in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0029: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("AccessResource") AND uri IN (threat_intel_urls) AND src_ip NOT IN (trusted_ips) \| stats count by src_ip, uri, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("AccessResource") and AdditionalFields.Uri in (threatIntelUrls) and ClientIP !in (trustedIPs) \| summarize count() by ClientIP, AdditionalFields.Uri, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['AccessResource'] AND http.uri IN ['threat_intel_urls'] AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, http.uri, event.action HAVING COUNT() > 5`. |
| 7. Malicious Link Access with Suspicious User Agents | Malicious link access with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0029: Zeek HTTP) | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) AND user_agent NOT IN (known_agents) \| stats count by src_ip, uri, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) and AdditionalFields.UserAgent !in (knownAgents) \| summarize count() by RemoteIP, AdditionalFields.Uri, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] AND http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY source.ip, http.uri, http.user_agent HAVING COUNT() > 5`. |
| 8. Malicious Link Access Followed by File Creation | Malicious link access leading to suspicious file creation, as in APT41. | - Network Traffic (DS0029: Zeek HTTP)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.zip")] \| stats count by src_ip, uri, FileName \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".zip")) on DeviceName \| summarize count() by RemoteIP, AdditionalFields.Uri, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.zip") \| STATS COUNT() BY source.ip, http.uri, file.name HAVING COUNT() > 5`. |
| 9. Malicious Link Access with Anomalous Protocols | Malicious link access via non-standard protocols, as in 2025 trends. | - Network Traffic (DS0029: Zeek Conn) | - **Splunk**: `index=network sourcetype=zeek_conn uri IN (threat_intel_urls) AND service NOT IN ("http", "https") \| stats count by src_ip, uri, service \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) and Protocol !in ("http", "https") \| summarize count() by RemoteIP, AdditionalFields.Uri, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE http.uri IN ['threat_intel_urls'] AND network.protocol NOT IN ['http', 'https'] \| STATS COUNT() BY source.ip, http.uri, network.protocol HAVING COUNT() > 5`. |
| 10. Malicious Link Access via Known Vulnerable Services | Malicious link access via vulnerable services, as in FIN7. | - Network Traffic (DS0029: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) AND service IN (known_vuln_services) \| stats count by src_ip, uri, service \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) and AdditionalFields.Service in (knownVulnServices) \| summarize count() by RemoteIP, AdditionalFields.Uri, AdditionalFields.Service \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] AND event.service IN ['known_vuln_services'] \| STATS COUNT() BY source.ip, http.uri, event.service HAVING COUNT() > 5`. |

### T1204.002: Malicious File

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Malicious File Execution from Suspicious IPs | Malicious files executed from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Malicious File Execution | High-frequency execution of malicious files, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Malicious File Execution Outside Business Hours | Malicious file executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Malicious File Execution Triggering Suspicious Processes | Malicious file executions spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*.exe", "*.dll", "*.scr") Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any (".exe", ".dll", ".scr") and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*.exe" OR "*.dll" OR "*.scr") AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Malicious File Execution from Anomalous Locations | Malicious file executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Malicious File Execution in Cloud Environments | Malicious file executions in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*.exe", "*.dll", "*.scr") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any (".exe", ".dll", ".scr") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*.exe" OR "*.dll" OR "*.scr") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Malicious File Execution with Suspicious User Agents | Malicious file executions with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Malicious File Execution Followed by File Creation | Malicious file executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.zip")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".zip")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.zip") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Malicious File Execution with Anomalous Protocols | Malicious file executions via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Malicious File Execution via Known Vulnerable Services | Malicious file executions via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1204.003: Malicious Image

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Malicious Image Execution from Suspicious IPs | Malicious images executed from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Malicious Image Execution | High-frequency execution of malicious images, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Malicious Image Execution Outside Business Hours | Malicious image executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Malicious Image Execution Triggering Suspicious Processes | Malicious image executions spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*.exe", "*.dll") Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any (".exe", ".dll") and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*.exe" OR "*.dll") AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Malicious Image Execution from Anomalous Locations | Malicious image executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Malicious Image Execution in Cloud Environments | Malicious image executions in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Malicious Image Execution with Suspicious User Agents | Malicious image executions with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Malicious Image Execution Followed by File Creation | Malicious image executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.zip")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".zip")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.zip") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Malicious Image Execution with Anomalous Protocols | Malicious image executions via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Malicious Image Execution via Known Vulnerable Services | Malicious image executions via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1053: Scheduled Task/Job

### T1053.002: At

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious 'at' Task Creation from Malicious IPs | Adversaries create 'at' tasks from known malicious IPs, as seen in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency 'at' Task Creation | High-frequency 'at' task creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. 'at' Task Creation Outside Business Hours | 'at' tasks created outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. 'at' Tasks Triggering Suspicious Processes | 'at' tasks spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*at.exe" Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "at.exe" and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*at.exe" AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. 'at' Tasks from Anomalous Locations | 'at' tasks created from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. 'at' Tasks in Cloud Environments | 'at' tasks in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*at.exe" AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "at.exe" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*at.exe" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. 'at' Tasks with Suspicious User Agents | 'at' tasks with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. 'at' Tasks Followed by File Creation | 'at' tasks leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. 'at' Tasks with Anomalous Protocols | 'at' tasks executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. 'at' Tasks via Known Vulnerable Services | 'at' tasks executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1053.003: Cron

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Cron Job Creation from Malicious IPs | Adversaries create cron jobs from known malicious IPs, as in Volt Typhoon. | - File Creation (DS0013: Sysmon ID 11)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") AND src_ip IN (threat_intel_ips) \| stats count by FileName, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by FileName, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY file.name, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Cron Job Modifications | High-frequency cron job modifications, as in APT41. | - File Creation (DS0013: Sysmon ID 11)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") \| timechart span=1h count by FileName, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") \| summarize HourlyCount=count() by bin(Timestamp, 1h), FileName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), file.name, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Cron Job Creation Outside Business Hours | Cron jobs created outside business hours, as in APT29. | - File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") AND (_time < "08:00" OR _time > "18:00") \| stats count by FileName, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by FileName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY file.name, host.name HAVING COUNT() > 5`. |
| 4. Cron Jobs Triggering Suspicious Processes | Cron jobs spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*powershell.exe*", "*cmd.exe*", "*sh*")] \| stats count by FileName, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("powershell.exe", "cmd.exe", "sh")) on DeviceName \| summarize count() by FileName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*powershell.exe*" OR "*cmd.exe*" OR "*sh*") \| STATS COUNT() BY file.name, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Cron Jobs from Anomalous Locations | Cron jobs created from unexpected geographic locations, as in FIN7. | - File Creation (DS0013: Sysmon ID 11)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") AND src_geo NOT IN (trusted_locations) \| stats count by FileName, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") and GeoLocation !in (trustedLocations) \| summarize count() by FileName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY file.name, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Cron Jobs in Cloud Environments | Cron jobs in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- File Creation (DS0013) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("ModifyFile", "CreateFile") AND FileName IN ("*crontab*", "*cron.d/*") AND src_ip NOT IN (trusted_ips) \| stats count by FileName, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyFile", "CreateFile") and FileName has_any ("crontab", "cron.d/") and ClientIP !in (trustedIPs) \| summarize count() by FileName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['ModifyFile', 'CreateFile'] AND file.name : ("*crontab*" OR "*cron.d/*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY file.name, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Cron Jobs with Suspicious User Agents | Cron jobs with non-standard user agents, as in Volt Typhoon. | - File Creation (DS0013: Sysmon ID 11)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by FileName, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by FileName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY file.name, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Cron Jobs Followed by File Creation | Cron jobs leading to suspicious file creation, as in APT41. | - File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.sh", "*.py")] \| stats count by FileName, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".sh", ".py")) on DeviceName \| summarize count() by FileName, DeviceName, FileName1 \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.sh" OR "*.py") \| STATS COUNT() BY file.name, host.name, file.name HAVING COUNT() > 5`. |
| 9. Cron Jobs with Anomalous Protocols | Cron jobs executed via non-standard protocols, as in 2025 trends. | - File Creation (DS0013: Sysmon ID 11)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by FileName, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by FileName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY file.name, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Cron Jobs via Known Vulnerable Services | Cron jobs executed via vulnerable services, as in FIN7. | - File Creation (DS0013: Sysmon ID 11)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") AND ParentImage IN (known_vuln_services) \| stats count by FileName, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") and InitiatingProcessName in (knownVulnServices) \| summarize count() by FileName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY file.name, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1053.005: Scheduled Task

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Scheduled Task Creation from Malicious IPs | Adversaries create scheduled tasks from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Scheduled Task Creation | High-frequency scheduled task creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Scheduled Task Creation Outside Business Hours | Scheduled tasks created outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Scheduled Tasks Triggering Suspicious Processes | Scheduled tasks spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*schtasks.exe" Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "schtasks.exe" and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*schtasks.exe" AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Scheduled Tasks from Anomalous Locations | Scheduled tasks created from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Scheduled Tasks in Cloud Environments | Scheduled tasks in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*schtasks.exe" AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "schtasks.exe" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*schtasks.exe" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Scheduled Tasks with Suspicious User Agents | Scheduled tasks with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Scheduled Tasks Followed by File Creation | Scheduled tasks leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Scheduled Tasks with Anomalous Protocols | Scheduled tasks executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Scheduled Tasks via Known Vulnerable Services | Scheduled tasks executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1053.006: Systemd Timers

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Systemd Timer Creation from Malicious IPs | Adversaries create systemd timers from known malicious IPs, as in Volt Typhoon. | - File Creation (DS0013: Sysmon ID 11)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") AND src_ip IN (threat_intel_ips) \| stats count by FileName, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by FileName, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY file.name, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Systemd Timer Modifications | High-frequency systemd timer modifications, as in APT41. | - File Creation (DS0013: Sysmon ID 11)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") \| timechart span=1h count by FileName, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") \| summarize HourlyCount=count() by bin(Timestamp, 1h), FileName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), file.name, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Systemd Timer Creation Outside Business Hours | Systemd timers created outside business hours, as in APT29. | - File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") AND (_time < "08:00" OR _time > "18:00") \| stats count by FileName, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by FileName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY file.name, host.name HAVING COUNT() > 5`. |
| 4. Systemd Timers Triggering Suspicious Processes | Systemd timers spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*powershell.exe*", "*cmd.exe*", "*sh*")] \| stats count by FileName, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("powershell.exe", "cmd.exe", "sh")) on DeviceName \| summarize count() by FileName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*powershell.exe*" OR "*cmd.exe*" OR "*sh*") \| STATS COUNT() BY file.name, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Systemd Timers from Anomalous Locations | Systemd timers created from unexpected geographic locations, as in FIN7. | - File Creation (DS0013: Sysmon ID 11)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") AND src_geo NOT IN (trusted_locations) \| stats count by FileName, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") and GeoLocation !in (trustedLocations) \| summarize count() by FileName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY file.name, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Systemd Timers in Cloud Environments | Systemd timers in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- File Creation (DS0013) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("ModifyFile", "CreateFile") AND FileName IN ("*.timer", "*systemd/*") AND src_ip NOT IN (trusted_ips) \| stats count by FileName, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyFile", "CreateFile") and FileName has_any (".timer", "systemd/") and ClientIP !in (trustedIPs) \| summarize count() by FileName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['ModifyFile', 'CreateFile'] AND file.name : ("*.timer" OR "*systemd/*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY file.name, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Systemd Timers with Suspicious User Agents | Systemd timers with non-standard user agents, as in Volt Typhoon. | - File Creation (DS0013: Sysmon ID 11)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by FileName, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by FileName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY file.name, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Systemd Timers Followed by File Creation | Systemd timers leading to suspicious file creation, as in APT41. | - File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.sh", "*.py")] \| stats count by FileName, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".sh", ".py")) on DeviceName \| summarize count() by FileName, DeviceName, FileName1 \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.sh" OR "*.py") \| STATS COUNT() BY file.name, host.name, file.name HAVING COUNT() > 5`. |
| 9. Systemd Timers with Anomalous Protocols | Systemd timers executed via non-standard protocols, as in 2025 trends. | - File Creation (DS0013: Sysmon ID 11)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by FileName, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by FileName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY file.name, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Systemd Timers via Known Vulnerable Services | Systemd timers executed via vulnerable services, as in FIN7. | - File Creation (DS0013: Sysmon ID 11)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") AND ParentImage IN (known_vuln_services) \| stats count by FileName, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") and InitiatingProcessName in (knownVulnServices) \| summarize count() by FileName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY file.name, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1053.007: Container Orchestration Job

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Container Orchestration Job Creation from Malicious IPs | Adversaries create container orchestration jobs from known malicious IPs, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") AND src_ip IN (threat_intel_ips) \| stats count by user, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") and ClientIP in (threatIntelIPs) \| summarize count() by Account, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY user.name, source.ip, event.action HAVING COUNT() > 5`. |
| 2. High-Frequency Container Orchestration Job Creation | High-frequency container orchestration job creation, as in APT41. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes)<br>- Metrics | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") \| timechart span=1h count by user, eventName \| where count > avg(count)*3`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") \| summarize HourlyCount=count() by bin(Timestamp, 1h), Account, ActionType \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), user.name, event.action \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Container Orchestration Job Creation Outside Business Hours | Container orchestration jobs created outside business hours, as in APT29. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes) | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") AND (_time < "08:00" OR _time > "18:00") \| stats count by user, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by Account, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY user.name, source.ip, event.action HAVING COUNT() > 5`. |
| 4. Container Orchestration Jobs Triggering Suspicious Processes | Container orchestration jobs spawning suspicious processes, as in Cobalt Strike. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") \| join user [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*powershell.exe*", "*cmd.exe*", "*sh*")] \| stats count by user, Image, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("powershell.exe", "cmd.exe", "sh")) on Account \| summarize count() by Account, ProcessName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] \| JOIN logs-endpoint.process-* ON user.name WHERE process.executable : ("*powershell.exe*" OR "*cmd.exe*" OR "*sh*") \| STATS COUNT() BY user.name, process.executable, event.action HAVING COUNT() > 5`. |
| 5. Container Orchestration Jobs from Anomalous Locations | Container orchestration jobs created from unexpected geographic locations, as in FIN7. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes)<br>- GeoIP Data | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") AND src_geo NOT IN (trusted_locations) \| stats count by user, src_geo, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") and GeoLocation !in (trustedLocations) \| summarize count() by Account, GeoLocation, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY user.name, source.geo.location, event.action HAVING COUNT() > 5`. |
| 6. Container Orchestration Jobs with Suspicious User Agents | Container orchestration jobs with non-standard user agents, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") \| join src_ip [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by user, src_ip, user_agent \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on ClientIP \| summarize count() by Account, ClientIP, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] \| JOIN logs-zeek.http-* ON source.ip WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY user.name, source.ip, http.user_agent HAVING COUNT() > 5`. |
| 7. Container Orchestration Jobs Followed by File Creation | Container orchestration jobs leading to suspicious file creation, as in APT41. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") \| join user [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.sh", "*.py")] \| stats count by user, FileName, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".sh", ".py")) on Account \| summarize count() by Account, FileName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] \| JOIN logs-endpoint.file-* ON user.name WHERE file.name : ("*.exe" OR "*.sh" OR "*.py") \| STATS COUNT() BY user.name, file.name, event.action HAVING COUNT() > 5`. |
| 8. Container Orchestration Jobs with High Rate Limits | Container orchestration jobs exceeding rate limits, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes) | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") \| timechart span=1m count by user \| where count > rate_limit_threshold`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") \| summarize MinuteCount=count() by bin(Timestamp, 1m), Account \| where MinuteCount > rateLimitThreshold`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), user.name \| WHERE COUNT() > rate_limit_threshold`. |
| 9. Container Orchestration Jobs with Anomalous Patterns | Container orchestration jobs with repetitive or scripted patterns, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes) | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") \| timechart span=1s count by user \| where count > avg(count)*5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") \| summarize SecondCount=count() by bin(Timestamp, 1s), Account \| where SecondCount > avg(SecondCount) * 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] \| STATS COUNT() BY date_histogram(@timestamp, '1s'), user.name \| WHERE COUNT() > AVG(COUNT()) * 5`. |
| 10. Container Orchestration Jobs via Known Vulnerable Services | Container orchestration jobs via vulnerable services, as in FIN7. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") AND service IN (known_vuln_services) \| stats count by user, service, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") and ServiceName in (knownVulnServices) \| summarize count() by Account, ServiceName, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] AND event.service IN ['known_vuln_services'] \| STATS COUNT() BY user.name, event.service, source.ip HAVING COUNT() > 5`. |

### T1569: System Services
