---
layout: default
title:  Execution
category: Threat-Hunting-Queries  # This becomes a main topic in sidebar
---

## Execution

### T1059: Command and Scripting Interpreter
# Threat Hunting Hypotheses for MITRE ATT&CK T1059: Command and Scripting Interpreter

### T1059.001: PowerShell

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. PowerShell Executions from Suspicious IPs | Adversaries execute PowerShell from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency PowerShell Executions | High-frequency PowerShell executions, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. PowerShell Executions Outside Business Hours | PowerShell executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. PowerShell Executions Triggering Suspicious Processes | PowerShell spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*powershell.exe" Image IN ("*rundll32.exe*", "*regsvr32.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "powershell.exe" and ProcessName has_any ("rundll32.exe", "regsvr32.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*powershell.exe" AND process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. PowerShell Executions from Anomalous Locations | PowerShell executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. PowerShell Executions in Cloud Environments | PowerShell used in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*powershell.exe" AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "powershell.exe" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*powershell.exe" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. PowerShell Executions with Suspicious User Agents | PowerShell accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. PowerShell Executions Followed by File Creation | PowerShell executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.ps1")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".ps1")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.ps1") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. PowerShell Executions with Anomalous Protocols | PowerShell executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. PowerShell Executions via Known Vulnerable Services | PowerShell executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1059.002: AppleScript

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. AppleScript Executions from Suspicious IPs | Adversaries execute AppleScript from known malicious IPs, as in Lazarus Group. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency AppleScript Executions | High-frequency AppleScript executions, as in APT32. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. AppleScript Executions Outside Business Hours | AppleScript executions outside business hours, as in APT29 macOS variants. | - Process Creation (DS0009: Sysmon-like on macOS) | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. AppleScript Executions Triggering Suspicious Processes | AppleScript spawning suspicious child processes, as in Cobalt Strike macOS beacons. | - Process Creation (DS0009: Sysmon-like on macOS) | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" \| join dest_host [search index=endpoint sourcetype=macos:process EventCode=1 ParentImage="*osascript" Image IN ("*sh", "*bash")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "osascript" and ProcessName has_any ("sh", "bash")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*osascript" AND process.executable : ("*sh" OR "*bash") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. AppleScript Executions from Anomalous Locations | AppleScript executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. AppleScript Executions in Cloud Environments | AppleScript used in cloud-managed macOS endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*osascript" AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "osascript" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*osascript" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. AppleScript Executions with Suspicious User Agents | AppleScript accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. AppleScript Executions Followed by File Creation | AppleScript executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- File Creation (DS0013) | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" \| join dest_host [search index=endpoint sourcetype=macos:file EventCode=11 FileName IN ("*.sh", "*.app", "*.dmg")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".sh", ".app", ".dmg")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.sh" OR "*.app" OR "*.dmg") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. AppleScript Executions with Anomalous Protocols | AppleScript executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. AppleScript Executions via Known Vulnerable Services | AppleScript executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1059.003: Windows Command Shell

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Windows Command Shell Executions from Suspicious IPs | Adversaries execute cmd.exe from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Windows Command Shell Executions | High-frequency cmd.exe executions, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Windows Command Shell Executions Outside Business Hours | cmd.exe executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Windows Command Shell Executions Triggering Suspicious Processes | cmd.exe spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*cmd.exe" Image IN ("*net.exe*", "*whoami.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "cmd.exe" and ProcessName has_any ("net.exe", "whoami.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*cmd.exe" AND process.executable : ("*net.exe*" OR "*whoami.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Windows Command Shell Executions from Anomalous Locations | cmd.exe executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Windows Command Shell Executions in Cloud Environments | cmd.exe used in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*cmd.exe" AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "cmd.exe" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*cmd.exe" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Windows Command Shell Executions with Suspicious User Agents | cmd.exe accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Windows Command Shell Executions Followed by File Creation | cmd.exe executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.bat", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".bat", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.bat" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Windows Command Shell Executions with Anomalous Protocols | cmd.exe executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Windows Command Shell Executions via Known Vulnerable Services | cmd.exe executed via vulnerable services, as in Patchwork APT. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1059.004: Unix Shell

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Unix Shell Executions from Suspicious IPs | Adversaries execute Unix shells from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Unix Shell Executions | High-frequency Unix shell executions, as in APT41. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Unix Shell Executions Outside Business Hours | Unix shell executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon-like on Linux) | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Unix Shell Executions Triggering Suspicious Processes | Unix shells spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon-like on Linux) | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") \| join dest_host [search index=endpoint sourcetype=linux:process EventCode=1 ParentImage IN ("*bash", "*sh") Image IN ("*curl*", "*wget*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("bash", "sh") and ProcessName has_any ("curl", "wget")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*bash" OR "*sh") AND process.executable : ("*curl*" OR "*wget*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Unix Shell Executions from Anomalous Locations | Unix shell executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Unix Shell Executions in Cloud Environments | Unix shells used in cloud-managed Linux endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*bash", "*sh") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("bash", "sh") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*bash" OR "*sh") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Unix Shell Executions with Suspicious User Agents | Unix shells accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Unix Shell Executions Followed by File Creation | Unix shell executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- File Creation (DS0013) | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") \| join dest_host [search index=endpoint sourcetype=linux:file EventCode=11 FileName IN ("*.elf", "*.sh", "*.so")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".elf", ".sh", ".so")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.elf" OR "*.sh" OR "*.so") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Unix Shell Executions with Anomalous Protocols | Unix shells executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Unix Shell Executions via Known Vulnerable Services | Unix shells executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1059.005: Visual Basic

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Visual Basic Executions from Suspicious IPs | Adversaries execute Visual Basic scripts from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Visual Basic Executions | High-frequency Visual Basic script executions, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Visual Basic Executions Outside Business Hours | Visual Basic script executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Visual Basic Executions Triggering Suspicious Processes | Visual Basic scripts spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*wscript.exe", "*cscript.exe") Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("wscript.exe", "cscript.exe") and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*wscript.exe" OR "*cscript.exe") AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Visual Basic Executions from Anomalous Locations | Visual Basic script executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Visual Basic Executions in Cloud Environments | Visual Basic scripts used in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*wscript.exe", "*cscript.exe") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("wscript.exe", "cscript.exe") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*wscript.exe" OR "*cscript.exe") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Visual Basic Executions with Suspicious User Agents | Visual Basic scripts accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Visual Basic Executions Followed by File Creation | Visual Basic script executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.vbs", "*.dll")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".vbs", ".dll")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.vbs" OR "*.dll") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Visual Basic Executions with Anomalous Protocols | Visual Basic scripts executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Visual Basic Executions via Known Vulnerable Services | Visual Basic scripts executed via vulnerable services, as in APT28. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`.


### T1059.006: Python

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Python Executions from Suspicious IPs | Adversaries execute Python scripts from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Python Executions | High-frequency Python script executions, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Python Executions Outside Business Hours | Python executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Python Executions Triggering Suspicious Processes | Python spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*python.exe" Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "python.exe" and ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*python.exe" AND process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Python Executions from Anomalous Locations | Python executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Python Executions in Cloud Environments | Python used in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*python.exe" AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "python.exe" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*python.exe" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Python Executions with Suspicious User Agents | Python accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Python Executions Followed by File Creation | Python executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.py", "*.dll")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".py", ".dll")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.py" OR "*.dll") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Python Executions with Anomalous Protocols | Python executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Python Executions via Known Vulnerable Services | Python executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1059.007: JavaScript

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. JavaScript Executions from Suspicious IPs | Adversaries execute JavaScript from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency JavaScript Executions | High-frequency JavaScript executions, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. JavaScript Executions Outside Business Hours | JavaScript executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. JavaScript Executions Triggering Suspicious Processes | JavaScript spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*node.exe", "*wscript.exe", "*cscript.exe") Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. JavaScript Executions from Anomalous Locations | JavaScript executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. JavaScript Executions in Cloud Environments | JavaScript used in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. JavaScript Executions with Suspicious User Agents | JavaScript accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. JavaScript Executions Followed by File Creation | JavaScript executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.js", "*.dll")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".js", ".dll")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.js" OR "*.dll") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. JavaScript Executions with Anomalous Protocols | JavaScript executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. JavaScript Executions via Known Vulnerable Services | JavaScript executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1059.008: Network Device CLI

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Network Device CLI Commands from Suspicious IPs | Adversaries execute CLI commands on network devices from known malicious IPs, as in Volt Typhoon. | - Network Device Logs (DS0003: Syslog)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") AND src_ip IN (threat_intel_ips) \| stats count by src_ip, dest_host, command \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") and RemoteIP in (threatIntelIPs) \| summarize count() by RemoteIP, DeviceName, AdditionalFields.Command \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY source.ip, host.name, event.command HAVING COUNT() > 5`. |
| 2. High-Frequency Network Device CLI Commands | High-frequency CLI command executions, as in APT41. | - Network Device Logs (DS0003: Syslog)<br>- Metrics | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") \| timechart span=1h count by dest_host, command \| where count > avg(count)*3`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName, AdditionalFields.Command \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name, event.command \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Network Device CLI Commands Outside Business Hours | CLI commands executed outside business hours, as in APT29. | - Network Device Logs (DS0003: Syslog) | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") AND (_time < "08:00" OR _time > "18:00") \| stats count by src_ip, dest_host, command \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by RemoteIP, DeviceName, AdditionalFields.Command \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY source.ip, host.name, event.command HAVING COUNT() > 5`. |
| 4. Network Device CLI Commands Triggering Suspicious Actions | CLI commands triggering suspicious configuration changes, as in Cobalt Strike. | - Network Device Logs (DS0003: Syslog) | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") command IN ("*config t*", "*set policy*") \| stats count by src_ip, dest_host, command \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") and AdditionalFields.Command has_any ("config t", "set policy") \| summarize count() by RemoteIP, DeviceName, AdditionalFields.Command \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] AND event.command : ("*config t*" OR "*set policy*") \| STATS COUNT() BY source.ip, host.name, event.command HAVING COUNT() > 5`. |
| 5. Network Device CLI Commands from Anomalous Locations | CLI commands from unexpected geographic locations, as in FIN7. | - Network Device Logs (DS0003: Syslog)<br>- GeoIP Data | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") AND src_geo NOT IN (trusted_locations) \| stats count by src_geo, dest_host, command \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") and GeoLocation !in (trustedLocations) \| summarize count() by GeoLocation, DeviceName, AdditionalFields.Command \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY source.geo.location, host.name, event.command HAVING COUNT() > 5`. |
| 6. Network Device CLI Commands in Cloud Environments | CLI commands executed on cloud-managed network devices, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Device Logs (DS0003) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("ExecuteCommand", "ModifyConfig") AND device_type IN ("cisco", "juniper") AND src_ip NOT IN (trusted_ips) \| stats count by src_ip, device_name, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ExecuteCommand", "ModifyConfig") and DeviceType has_any ("cisco", "juniper") and ClientIP !in (trustedIPs) \| summarize count() by ClientIP, DeviceName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['ExecuteCommand', 'ModifyConfig'] AND event.device IN ['cisco', 'juniper'] AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, event.device, event.action HAVING COUNT() > 5`. |
| 7. Network Device CLI Commands with Suspicious User Agents | CLI commands accessed with non-standard user agents, as in Volt Typhoon. | - Network Device Logs (DS0003: Syslog)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by dest_host, command, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by DeviceName, AdditionalFields.Command, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY host.name, event.command, http.user_agent HAVING COUNT() > 5`. |
| 8. Network Device CLI Commands Followed by Config Changes | CLI commands leading to suspicious configuration changes, as in APT41. | - Network Device Logs (DS0003: Syslog) | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") command IN ("*write memory*", "*commit*") \| stats count by src_ip, dest_host, command \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") and AdditionalFields.Command has_any ("write memory", "commit") \| summarize count() by RemoteIP, DeviceName, AdditionalFields.Command \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] AND event.command : ("*write memory*" OR "*commit*") \| STATS COUNT() BY source.ip, host.name, event.command HAVING COUNT() > 5`. |
| 9. Network Device CLI Commands with Anomalous Protocols | CLI commands executed via non-standard protocols, as in 2025 trends. | - Network Device Logs (DS0003: Syslog)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("ssh", "telnet")] \| stats count by dest_host, command, service \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("ssh", "telnet")) on DeviceName \| summarize count() by DeviceName, AdditionalFields.Command, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['ssh', 'telnet'] \| STATS COUNT() BY host.name, event.command, network.protocol HAVING COUNT() > 5`. |
| 10. Network Device CLI Commands via Known Vulnerable Services | CLI commands executed via vulnerable services, as in FIN7. | - Network Device Logs (DS0003: Syslog)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") AND service IN (known_vuln_services) \| stats count by src_ip, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") and AdditionalFields.Service in (knownVulnServices) \| summarize count() by RemoteIP, DeviceName, AdditionalFields.Service \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] AND event.service IN ['known_vuln_services'] \| STATS COUNT() BY source.ip, host.name, event.service HAVING COUNT() > 5`. |

### T1059.009: Cloud API

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Cloud API Calls from Suspicious IPs | Adversaries execute Cloud API calls from known malicious IPs, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances", "CreateUser") AND src_ip IN (threat_intel_ips) \| stats count by user, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances", "CreateUser") and ClientIP in (threatIntelIPs) \| summarize count() by Account, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances', 'CreateUser'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY user.name, source.ip, event.action HAVING COUNT() > 5`. |
| 2. High-Frequency Cloud API Calls | High-frequency Cloud API calls, as in APT41. | - Cloud Audit Logs (AWS IAM, Azure AD) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances", "CreateUser") \| timechart span=1h count by user, eventName \| where count > avg(count)*3`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances", "CreateUser") \| summarize HourlyCount=count() by bin(Timestamp, 1h), Account, ActionType \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances', 'CreateUser'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), user.name, event.action \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Cloud API Calls Outside Business Hours | Cloud API calls executed outside business hours, as in APT29. | - Cloud Audit Logs (AWS IAM, Azure AD) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances", "CreateUser") AND (_time < "08:00" OR _time > "18:00") \| stats count by user, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances", "CreateUser") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by Account, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances', 'CreateUser'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY user.name, source.ip, event.action HAVING COUNT() > 5`. |
| 4. Cloud API Calls Triggering Suspicious Actions | Cloud API calls triggering suspicious actions, as in Cobalt Strike. | - Cloud Audit Logs (AWS IAM, Azure AD) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("DeleteUser", "ModifyInstance", "AttachPolicy") \| stats count by user, eventName, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("DeleteUser", "ModifyInstance", "AttachPolicy") \| summarize count() by Account, ActionType, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['DeleteUser', 'ModifyInstance', 'AttachPolicy'] \| STATS COUNT() BY user.name, event.action, source.ip HAVING COUNT() > 5`. |
| 5. Cloud API Calls from Anomalous Locations | Cloud API calls from unexpected geographic locations, as in FIN7. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- GeoIP Data | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances", "CreateUser") AND src_geo NOT IN (trusted_locations) \| stats count by user, src_geo, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances", "CreateUser") and GeoLocation !in (trustedLocations) \| summarize count() by Account, GeoLocation, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances', 'CreateUser'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY user.name, source.geo.location, event.action HAVING COUNT() > 5`. |
| 6. Cloud API Calls with Suspicious User Agents | Cloud API calls with non-standard user agents, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances", "CreateUser") \| join src_ip [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by user, src_ip, user_agent \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances", "CreateUser") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on ClientIP \| summarize count() by Account, ClientIP, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances', 'CreateUser'] \| JOIN logs-zeek.http-* ON source.ip WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY user.name, source.ip, http.user_agent HAVING COUNT() > 5`. |
| 7. Cloud API Calls Followed by File Creation | Cloud API calls leading to suspicious file creation, as in APT41. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances") \| join user [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.zip", "*.scr")] \| stats count by user, FileName, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".zip", ".scr")) on Account \| summarize count() by Account, FileName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances'] \| JOIN logs-endpoint.file-* ON user.name WHERE file.name : ("*.exe" OR "*.zip" OR "*.scr") \| STATS COUNT() BY user.name, file.name, event.action HAVING COUNT() > 5`. |
| 8. Cloud API Calls with High Rate Limits | Cloud API calls exceeding rate limits, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("APICall") \| timechart span=1m count by user \| where count > rate_limit_threshold`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("APICall") \| summarize MinuteCount=count() by bin(Timestamp, 1m), Account \| where MinuteCount > rateLimitThreshold`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['APICall'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), user.name \| WHERE COUNT() > rate_limit_threshold`. |
| 9. Cloud API Calls with Anomalous Patterns | Cloud API calls with repetitive or scripted patterns, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances", "CreateUser") \| timechart span=1s count by user \| where count > avg(count)*5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances", "CreateUser") \| summarize SecondCount=count() by bin(Timestamp, 1s), Account \| where SecondCount > avg(SecondCount) * 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances', 'CreateUser'] \| STATS COUNT() BY date_histogram(@timestamp, '1s'), user.name \| WHERE COUNT() > AVG(COUNT()) * 5`. |
| 10. Cloud API Calls via Known Vulnerable Services | Cloud API calls via vulnerable services, as in FIN7. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances", "CreateUser") AND service IN (known_vuln_services) \| stats count by user, service, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances", "CreateUser") and ServiceName in (knownVulnServices) \| summarize count() by Account, ServiceName, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances', 'CreateUser'] AND event.service IN ['known_vuln_services'] \| STATS COUNT() BY user.name, event.service, source.ip HAVING COUNT() > 5`. |


### T1106: Native API

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Native API Calls from Suspicious IPs | Adversaries use Native API calls from malicious IPs, as seen in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Native API Calls | High-frequency Native API calls, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Native API Calls Outside Business Hours | Native API executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Native API Calls Triggering Suspicious Processes | Native API calls spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*rundll32.exe*", "*regsvr32.exe*") Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Native API Calls from Anomalous Locations | Native API calls from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Native API Calls in Cloud Environments | Native API calls in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*rundll32.exe*", "*regsvr32.exe*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("rundll32.exe", "regsvr32.exe") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Native API Calls with Suspicious User Agents | Native API calls with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Native API Calls Followed by File Creation | Native API calls leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Native API Calls with Anomalous Protocols | Native API calls executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Native API Calls via Known Vulnerable Services | Native API calls executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1204: User Execution
### T1204.001: Malicious Link

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Malicious Link Access from Suspicious IPs | Users access malicious links from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0029: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) AND src_ip IN (threat_intel_ips) \| stats count by src_ip, uri, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) and RemoteIP in (threatIntelIPs) \| summarize count() by RemoteIP, AdditionalFields.Uri, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY source.ip, http.uri, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Malicious Link Access | High-frequency access to malicious links, as in APT41. | - Network Traffic (DS0029: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) \| timechart span=1h count by uri, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) \| summarize HourlyCount=count() by bin(Timestamp, 1h), AdditionalFields.Uri, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), http.uri, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Malicious Link Access Outside Business Hours | Malicious link access outside business hours, as in APT29. | - Network Traffic (DS0029: Zeek HTTP) | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) AND (_time < "08:00" OR _time > "18:00") \| stats count by src_ip, uri, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by RemoteIP, AdditionalFields.Uri, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY source.ip, http.uri, host.name HAVING COUNT() > 5`. |
| 4. Malicious Link Access Triggering Suspicious Processes | Malicious link access followed by suspicious process execution, as in Cobalt Strike. | - Network Traffic (DS0029: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by src_ip, uri, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by RemoteIP, AdditionalFields.Uri, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY source.ip, http.uri, process.executable HAVING COUNT() > 5`. |
| 5. Malicious Link Access from Anomalous Locations | Malicious link access from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029: Zeek HTTP)<br>- GeoIP Data | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) AND src_geo NOT IN (trusted_locations) \| stats count by src_geo, uri, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) and GeoLocation !in (trustedLocations) \| summarize count() by GeoLocation, AdditionalFields.Uri, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY source.geo.location, http.uri, host.name HAVING COUNT() > 5`. |
| 6. Malicious Link Access in Cloud Environments | Malicious link access in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0029: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("AccessResource") AND uri IN (threat_intel_urls) AND src_ip NOT IN (trusted_ips) \| stats count by src_ip, uri, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("AccessResource") and AdditionalFields.Uri in (threatIntelUrls) and ClientIP !in (trustedIPs) \| summarize count() by ClientIP, AdditionalFields.Uri, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['AccessResource'] AND http.uri IN ['threat_intel_urls'] AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, http.uri, event.action HAVING COUNT() > 5`. |
| 7. Malicious Link Access with Suspicious User Agents | Malicious link access with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0029: Zeek HTTP) | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) AND user_agent NOT IN (known_agents) \| stats count by src_ip, uri, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) and AdditionalFields.UserAgent !in (knownAgents) \| summarize count() by RemoteIP, AdditionalFields.Uri, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] AND http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY source.ip, http.uri, http.user_agent HAVING COUNT() > 5`. |
| 8. Malicious Link Access Followed by File Creation | Malicious link access leading to suspicious file creation, as in APT41. | - Network Traffic (DS0029: Zeek HTTP)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.zip")] \| stats count by src_ip, uri, FileName \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".zip")) on DeviceName \| summarize count() by RemoteIP, AdditionalFields.Uri, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.zip") \| STATS COUNT() BY source.ip, http.uri, file.name HAVING COUNT() > 5`. |
| 9. Malicious Link Access with Anomalous Protocols | Malicious link access via non-standard protocols, as in 2025 trends. | - Network Traffic (DS0029: Zeek Conn) | - **Splunk**: `index=network sourcetype=zeek_conn uri IN (threat_intel_urls) AND service NOT IN ("http", "https") \| stats count by src_ip, uri, service \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) and Protocol !in ("http", "https") \| summarize count() by RemoteIP, AdditionalFields.Uri, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE http.uri IN ['threat_intel_urls'] AND network.protocol NOT IN ['http', 'https'] \| STATS COUNT() BY source.ip, http.uri, network.protocol HAVING COUNT() > 5`. |
| 10. Malicious Link Access via Known Vulnerable Services | Malicious link access via vulnerable services, as in FIN7. | - Network Traffic (DS0029: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) AND service IN (known_vuln_services) \| stats count by src_ip, uri, service \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) and AdditionalFields.Service in (knownVulnServices) \| summarize count() by RemoteIP, AdditionalFields.Uri, AdditionalFields.Service \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] AND event.service IN ['known_vuln_services'] \| STATS COUNT() BY source.ip, http.uri, event.service HAVING COUNT() > 5`. |

### T1204.002: Malicious File

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Malicious File Execution from Suspicious IPs | Malicious files executed from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Malicious File Execution | High-frequency execution of malicious files, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Malicious File Execution Outside Business Hours | Malicious file executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Malicious File Execution Triggering Suspicious Processes | Malicious file executions spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*.exe", "*.dll", "*.scr") Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any (".exe", ".dll", ".scr") and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*.exe" OR "*.dll" OR "*.scr") AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Malicious File Execution from Anomalous Locations | Malicious file executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Malicious File Execution in Cloud Environments | Malicious file executions in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*.exe", "*.dll", "*.scr") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any (".exe", ".dll", ".scr") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*.exe" OR "*.dll" OR "*.scr") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Malicious File Execution with Suspicious User Agents | Malicious file executions with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Malicious File Execution Followed by File Creation | Malicious file executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.zip")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".zip")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.zip") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Malicious File Execution with Anomalous Protocols | Malicious file executions via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Malicious File Execution via Known Vulnerable Services | Malicious file executions via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1204.003: Malicious Image

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Malicious Image Execution from Suspicious IPs | Malicious images executed from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Malicious Image Execution | High-frequency execution of malicious images, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Malicious Image Execution Outside Business Hours | Malicious image executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Malicious Image Execution Triggering Suspicious Processes | Malicious image executions spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*.exe", "*.dll") Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any (".exe", ".dll") and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*.exe" OR "*.dll") AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Malicious Image Execution from Anomalous Locations | Malicious image executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Malicious Image Execution in Cloud Environments | Malicious image executions in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Malicious Image Execution with Suspicious User Agents | Malicious image executions with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Malicious Image Execution Followed by File Creation | Malicious image executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.zip")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".zip")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.zip") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Malicious Image Execution with Anomalous Protocols | Malicious image executions via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Malicious Image Execution via Known Vulnerable Services | Malicious image executions via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1053: Scheduled Task/Job

### T1053.002: At

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious 'at' Task Creation from Malicious IPs | Adversaries create 'at' tasks from known malicious IPs, as seen in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency 'at' Task Creation | High-frequency 'at' task creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. 'at' Task Creation Outside Business Hours | 'at' tasks created outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. 'at' Tasks Triggering Suspicious Processes | 'at' tasks spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*at.exe" Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "at.exe" and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*at.exe" AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. 'at' Tasks from Anomalous Locations | 'at' tasks created from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. 'at' Tasks in Cloud Environments | 'at' tasks in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*at.exe" AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "at.exe" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*at.exe" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. 'at' Tasks with Suspicious User Agents | 'at' tasks with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. 'at' Tasks Followed by File Creation | 'at' tasks leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. 'at' Tasks with Anomalous Protocols | 'at' tasks executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. 'at' Tasks via Known Vulnerable Services | 'at' tasks executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1053.003: Cron

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Cron Job Creation from Malicious IPs | Adversaries create cron jobs from known malicious IPs, as in Volt Typhoon. | - File Creation (DS0013: Sysmon ID 11)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") AND src_ip IN (threat_intel_ips) \| stats count by FileName, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by FileName, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY file.name, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Cron Job Modifications | High-frequency cron job modifications, as in APT41. | - File Creation (DS0013: Sysmon ID 11)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") \| timechart span=1h count by FileName, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") \| summarize HourlyCount=count() by bin(Timestamp, 1h), FileName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), file.name, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Cron Job Creation Outside Business Hours | Cron jobs created outside business hours, as in APT29. | - File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") AND (_time < "08:00" OR _time > "18:00") \| stats count by FileName, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by FileName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY file.name, host.name HAVING COUNT() > 5`. |
| 4. Cron Jobs Triggering Suspicious Processes | Cron jobs spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*powershell.exe*", "*cmd.exe*", "*sh*")] \| stats count by FileName, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("powershell.exe", "cmd.exe", "sh")) on DeviceName \| summarize count() by FileName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*powershell.exe*" OR "*cmd.exe*" OR "*sh*") \| STATS COUNT() BY file.name, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Cron Jobs from Anomalous Locations | Cron jobs created from unexpected geographic locations, as in FIN7. | - File Creation (DS0013: Sysmon ID 11)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") AND src_geo NOT IN (trusted_locations) \| stats count by FileName, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") and GeoLocation !in (trustedLocations) \| summarize count() by FileName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY file.name, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Cron Jobs in Cloud Environments | Cron jobs in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- File Creation (DS0013) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("ModifyFile", "CreateFile") AND FileName IN ("*crontab*", "*cron.d/*") AND src_ip NOT IN (trusted_ips) \| stats count by FileName, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyFile", "CreateFile") and FileName has_any ("crontab", "cron.d/") and ClientIP !in (trustedIPs) \| summarize count() by FileName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['ModifyFile', 'CreateFile'] AND file.name : ("*crontab*" OR "*cron.d/*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY file.name, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Cron Jobs with Suspicious User Agents | Cron jobs with non-standard user agents, as in Volt Typhoon. | - File Creation (DS0013: Sysmon ID 11)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by FileName, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by FileName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY file.name, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Cron Jobs Followed by File Creation | Cron jobs leading to suspicious file creation, as in APT41. | - File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.sh", "*.py")] \| stats count by FileName, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".sh", ".py")) on DeviceName \| summarize count() by FileName, DeviceName, FileName1 \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.sh" OR "*.py") \| STATS COUNT() BY file.name, host.name, file.name HAVING COUNT() > 5`. |
| 9. Cron Jobs with Anomalous Protocols | Cron jobs executed via non-standard protocols, as in 2025 trends. | - File Creation (DS0013: Sysmon ID 11)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by FileName, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by FileName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY file.name, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Cron Jobs via Known Vulnerable Services | Cron jobs executed via vulnerable services, as in FIN7. | - File Creation (DS0013: Sysmon ID 11)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") AND ParentImage IN (known_vuln_services) \| stats count by FileName, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") and InitiatingProcessName in (knownVulnServices) \| summarize count() by FileName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY file.name, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1053.005: Scheduled Task

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Scheduled Task Creation from Malicious IPs | Adversaries create scheduled tasks from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Scheduled Task Creation | High-frequency scheduled task creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Scheduled Task Creation Outside Business Hours | Scheduled tasks created outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Scheduled Tasks Triggering Suspicious Processes | Scheduled tasks spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*schtasks.exe" Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "schtasks.exe" and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*schtasks.exe" AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Scheduled Tasks from Anomalous Locations | Scheduled tasks created from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Scheduled Tasks in Cloud Environments | Scheduled tasks in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*schtasks.exe" AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "schtasks.exe" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*schtasks.exe" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Scheduled Tasks with Suspicious User Agents | Scheduled tasks with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Scheduled Tasks Followed by File Creation | Scheduled tasks leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Scheduled Tasks with Anomalous Protocols | Scheduled tasks executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Scheduled Tasks via Known Vulnerable Services | Scheduled tasks executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1053.006: Systemd Timers

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Systemd Timer Creation from Malicious IPs | Adversaries create systemd timers from known malicious IPs, as in Volt Typhoon. | - File Creation (DS0013: Sysmon ID 11)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") AND src_ip IN (threat_intel_ips) \| stats count by FileName, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by FileName, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY file.name, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Systemd Timer Modifications | High-frequency systemd timer modifications, as in APT41. | - File Creation (DS0013: Sysmon ID 11)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") \| timechart span=1h count by FileName, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") \| summarize HourlyCount=count() by bin(Timestamp, 1h), FileName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), file.name, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Systemd Timer Creation Outside Business Hours | Systemd timers created outside business hours, as in APT29. | - File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") AND (_time < "08:00" OR _time > "18:00") \| stats count by FileName, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by FileName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY file.name, host.name HAVING COUNT() > 5`. |
| 4. Systemd Timers Triggering Suspicious Processes | Systemd timers spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*powershell.exe*", "*cmd.exe*", "*sh*")] \| stats count by FileName, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("powershell.exe", "cmd.exe", "sh")) on DeviceName \| summarize count() by FileName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*powershell.exe*" OR "*cmd.exe*" OR "*sh*") \| STATS COUNT() BY file.name, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Systemd Timers from Anomalous Locations | Systemd timers created from unexpected geographic locations, as in FIN7. | - File Creation (DS0013: Sysmon ID 11)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") AND src_geo NOT IN (trusted_locations) \| stats count by FileName, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") and GeoLocation !in (trustedLocations) \| summarize count() by FileName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY file.name, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Systemd Timers in Cloud Environments | Systemd timers in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- File Creation (DS0013) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("ModifyFile", "CreateFile") AND FileName IN ("*.timer", "*systemd/*") AND src_ip NOT IN (trusted_ips) \| stats count by FileName, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyFile", "CreateFile") and FileName has_any (".timer", "systemd/") and ClientIP !in (trustedIPs) \| summarize count() by FileName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['ModifyFile', 'CreateFile'] AND file.name : ("*.timer" OR "*systemd/*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY file.name, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Systemd Timers with Suspicious User Agents | Systemd timers with non-standard user agents, as in Volt Typhoon. | - File Creation (DS0013: Sysmon ID 11)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by FileName, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by FileName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY file.name, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Systemd Timers Followed by File Creation | Systemd timers leading to suspicious file creation, as in APT41. | - File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.sh", "*.py")] \| stats count by FileName, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".sh", ".py")) on DeviceName \| summarize count() by FileName, DeviceName, FileName1 \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.sh" OR "*.py") \| STATS COUNT() BY file.name, host.name, file.name HAVING COUNT() > 5`. |
| 9. Systemd Timers with Anomalous Protocols | Systemd timers executed via non-standard protocols, as in 2025 trends. | - File Creation (DS0013: Sysmon ID 11)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by FileName, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by FileName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY file.name, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Systemd Timers via Known Vulnerable Services | Systemd timers executed via vulnerable services, as in FIN7. | - File Creation (DS0013: Sysmon ID 11)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") AND ParentImage IN (known_vuln_services) \| stats count by FileName, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") and InitiatingProcessName in (knownVulnServices) \| summarize count() by FileName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY file.name, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1053.007: Container Orchestration Job

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Container Orchestration Job Creation from Malicious IPs | Adversaries create container orchestration jobs from known malicious IPs, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") AND src_ip IN (threat_intel_ips) \| stats count by user, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") and ClientIP in (threatIntelIPs) \| summarize count() by Account, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY user.name, source.ip, event.action HAVING COUNT() > 5`. |
| 2. High-Frequency Container Orchestration Job Creation | High-frequency container orchestration job creation, as in APT41. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes)<br>- Metrics | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") \| timechart span=1h count by user, eventName \| where count > avg(count)*3`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") \| summarize HourlyCount=count() by bin(Timestamp, 1h), Account, ActionType \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), user.name, event.action \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Container Orchestration Job Creation Outside Business Hours | Container orchestration jobs created outside business hours, as in APT29. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes) | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") AND (_time < "08:00" OR _time > "18:00") \| stats count by user, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by Account, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY user.name, source.ip, event.action HAVING COUNT() > 5`. |
| 4. Container Orchestration Jobs Triggering Suspicious Processes | Container orchestration jobs spawning suspicious processes, as in Cobalt Strike. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") \| join user [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*powershell.exe*", "*cmd.exe*", "*sh*")] \| stats count by user, Image, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("powershell.exe", "cmd.exe", "sh")) on Account \| summarize count() by Account, ProcessName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] \| JOIN logs-endpoint.process-* ON user.name WHERE process.executable : ("*powershell.exe*" OR "*cmd.exe*" OR "*sh*") \| STATS COUNT() BY user.name, process.executable, event.action HAVING COUNT() > 5`. |
| 5. Container Orchestration Jobs from Anomalous Locations | Container orchestration jobs created from unexpected geographic locations, as in FIN7. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes)<br>- GeoIP Data | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") AND src_geo NOT IN (trusted_locations) \| stats count by user, src_geo, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") and GeoLocation !in (trustedLocations) \| summarize count() by Account, GeoLocation, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY user.name, source.geo.location, event.action HAVING COUNT() > 5`. |
| 6. Container Orchestration Jobs with Suspicious User Agents | Container orchestration jobs with non-standard user agents, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") \| join src_ip [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by user, src_ip, user_agent \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on ClientIP \| summarize count() by Account, ClientIP, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] \| JOIN logs-zeek.http-* ON source.ip WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY user.name, source.ip, http.user_agent HAVING COUNT() > 5`. |
| 7. Container Orchestration Jobs Followed by File Creation | Container orchestration jobs leading to suspicious file creation, as in APT41. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") \| join user [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.sh", "*.py")] \| stats count by user, FileName, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".sh", ".py")) on Account \| summarize count() by Account, FileName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] \| JOIN logs-endpoint.file-* ON user.name WHERE file.name : ("*.exe" OR "*.sh" OR "*.py") \| STATS COUNT() BY user.name, file.name, event.action HAVING COUNT() > 5`. |
| 8. Container Orchestration Jobs with High Rate Limits | Container orchestration jobs exceeding rate limits, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes) | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") \| timechart span=1m count by user \| where count > rate_limit_threshold`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") \| summarize MinuteCount=count() by bin(Timestamp, 1m), Account \| where MinuteCount > rateLimitThreshold`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), user.name \| WHERE COUNT() > rate_limit_threshold`. |
| 9. Container Orchestration Jobs with Anomalous Patterns | Container orchestration jobs with repetitive or scripted patterns, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes) | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") \| timechart span=1s count by user \| where count > avg(count)*5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") \| summarize SecondCount=count() by bin(Timestamp, 1s), Account \| where SecondCount > avg(SecondCount) * 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] \| STATS COUNT() BY date_histogram(@timestamp, '1s'), user.name \| WHERE COUNT() > AVG(COUNT()) * 5`. |
| 10. Container Orchestration Jobs via Known Vulnerable Services | Container orchestration jobs via vulnerable services, as in FIN7. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") AND service IN (known_vuln_services) \| stats count by user, service, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") and ServiceName in (knownVulnServices) \| summarize count() by Account, ServiceName, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] AND event.service IN ['known_vuln_services'] \| STATS COUNT() BY user.name, event.service, source.ip HAVING COUNT() > 5`. |

### T1569: System Services

### T1569.001: Launchctl

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Launchctl Execution from Malicious IPs | Adversaries execute launchctl commands from known malicious IPs, as seen in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*launchctl" AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "launchctl" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*launchctl" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Launchctl Execution | High-frequency launchctl command execution, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*launchctl" \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "launchctl" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*launchctl" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Launchctl Execution Outside Business Hours | Launchctl commands executed outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*launchctl" AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "launchctl" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*launchctl" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Launchctl Triggering Suspicious Processes | Launchctl commands spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*launchctl" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*launchctl" Image IN ("*bash*", "*sh*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "launchctl" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "launchctl" and ProcessName has_any ("bash", "sh")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*launchctl" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*launchctl" AND process.executable : ("*bash*" OR "*sh*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Launchctl Execution from Anomalous Locations | Launchctl commands executed from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*launchctl" AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "launchctl" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*launchctl" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Launchctl in Cloud Environments | Launchctl commands in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*launchctl" AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "launchctl" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*launchctl" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Launchctl with Suspicious User Agents | Launchctl commands with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*launchctl" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "launchctl" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*launchctl" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Launchctl Followed by File Creation | Launchctl commands leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*launchctl" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.sh", "*.py", "*.bin")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "launchctl" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".sh", ".py", ".bin")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*launchctl" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.sh" OR "*.py" OR "*.bin") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Launchctl with Anomalous Protocols | Launchctl commands executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*launchctl" \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "launchctl" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*launchctl" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Launchctl via Known Vulnerable Services | Launchctl commands executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*launchctl" AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "launchctl" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*launchctl" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1569.002: Service

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Service Creation from Malicious IPs | Adversaries create services from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*sc.exe", "*systemctl") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("sc.exe", "systemctl") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*sc.exe" OR "*systemctl") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Service Creation | High-frequency service creation or modification, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*sc.exe", "*systemctl") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("sc.exe", "systemctl") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*sc.exe" OR "*systemctl") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Service Creation Outside Business Hours | Service creation outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*sc.exe", "*systemctl") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("sc.exe", "systemctl") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*sc.exe" OR "*systemctl") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Services Triggering Suspicious Processes | Services spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*sc.exe", "*systemctl") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*sc.exe", "*systemctl") Image IN ("*powershell.exe*", "*cmd.exe*", "*sh*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("sc.exe", "systemctl") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("sc.exe", "systemctl") and ProcessName has_any ("powershell.exe", "cmd.exe", "sh")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*sc.exe" OR "*systemctl") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*sc.exe" OR "*systemctl") AND process.executable : ("*powershell.exe*" OR "*cmd.exe*" OR "*sh*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Service Creation from Anomalous Locations | Services created from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*sc.exe", "*systemctl") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("sc.exe", "systemctl") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*sc.exe" OR "*systemctl") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Service Creation in Cloud Environments | Service creation in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*sc.exe", "*systemctl") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("sc.exe", "systemctl") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*sc.exe" OR "*systemctl") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Services with Suspicious User Agents | Services created with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*sc.exe", "*systemctl") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("sc.exe", "systemctl") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*sc.exe" OR "*systemctl") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Service Creation Followed by File Creation | Service creation leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*sc.exe", "*systemctl") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.sh")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("sc.exe", "systemctl") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".sh")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*sc.exe" OR "*systemctl") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.sh") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Services with Anomalous Protocols | Services executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*sc.exe", "*systemctl") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("sc.exe", "systemctl") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*sc.exe" OR "*systemctl") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Services via Known Vulnerable Services | Services executed via known vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*sc.exe", "*systemctl") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("sc.exe", "systemctl") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*sc.exe" OR "*systemctl") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1569.003: Windows Service

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Windows Service Creation from Malicious IPs | Adversaries create Windows services from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*sc.exe" AND CommandLine IN ("*create*", "*config*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "sc.exe" and ProcessCommandLine has_any ("create", "config") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*sc.exe" AND process.command_line : ("*create*" OR "*config*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Windows Service Creation | High-frequency Windows service creation or modification, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*sc.exe" AND CommandLine IN ("*create*", "*config*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "sc.exe" and ProcessCommandLine has_any ("create", "config") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*sc.exe" AND process.command_line : ("*create*" OR "*config*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Windows Service Creation Outside Business Hours | Windows service creation outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*sc.exe" AND CommandLine IN ("*create*", "*config*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "sc.exe" and ProcessCommandLine has_any ("create", "config") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*sc.exe" AND process.command_line : ("*create*" OR "*config*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Windows Services Triggering Suspicious Processes | Windows services spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*sc.exe" AND CommandLine IN ("*create*", "*config*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*sc.exe" Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "sc.exe" and ProcessCommandLine has_any ("create", "config") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "sc.exe" and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*sc.exe" AND process.command_line : ("*create*" OR "*config*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*sc.exe" AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Windows Service Creation from Anomalous Locations | Windows services created from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*sc.exe" AND CommandLine IN ("*create*", "*config*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "sc.exe" and ProcessCommandLine has_any ("create", "config") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*sc.exe" AND process.command_line : ("*create*" OR "*config*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Windows Service Creation in Cloud Environments | Windows service creation in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*sc.exe" AND CommandLine IN ("*create*", "*config*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "sc.exe" and ProcessCommandLine has_any ("create", "config") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*sc.exe" AND process.command_line : ("*create*" OR "*config*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Windows Services with Suspicious User Agents | Windows services created with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*sc.exe" AND CommandLine IN ("*create*", "*config*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "sc.exe" and ProcessCommandLine has_any ("create", "config") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*sc.exe" AND process.command_line : ("*create*" OR "*config*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Windows Service Creation Followed by File Creation | Windows service creation leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*sc.exe" AND CommandLine IN ("*create*", "*config*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "sc.exe" and ProcessCommandLine has_any ("create", "config") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*sc.exe" AND process.command_line : ("*create*" OR "*config*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Windows Services with Anomalous Protocols | Windows services executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*sc.exe" AND CommandLine IN ("*create*", "*config*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "sc.exe" and ProcessCommandLine has_any ("create", "config") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*sc.exe" AND process.command_line : ("*create*" OR "*config*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Windows Services via Known Vulnerable Services | Windows services executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*sc.exe" AND CommandLine IN ("*create*", "*config*") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "sc.exe" and ProcessCommandLine has_any ("create", "config") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*sc.exe" AND process.command_line : ("*create*" OR "*config*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1569.004: Remote Services

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Remote Service Execution from Malicious IPs | Adversaries execute remote services from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0029)<br>- Cloud Audit Logs (AWS IAM, Azure AD)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("StartService", "InvokeService") AND src_ip IN (threat_intel_ips) \| stats count by eventName, src_ip, user \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("StartService", "InvokeService") and ClientIP in (threatIntelIPs) \| summarize count() by ActionType, ClientIP, Account \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['StartService', 'InvokeService'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY event.action, source.ip, user.name HAVING COUNT() > 5`. |
| 2. High-Frequency Remote Service Execution | High-frequency remote service execution, as in APT41. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Metrics | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("StartService", "InvokeService") \| timechart span=1h count by eventName, user \| where count > avg(count)*3`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("StartService", "InvokeService") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ActionType, Account \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['StartService', 'InvokeService'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), event.action, user.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Remote Service Execution Outside Business Hours | Remote service execution outside business hours, as in APT29. | - Cloud Audit Logs (AWS IAM, Azure AD) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("StartService", "InvokeService") AND (_time < "08:00" OR _time > "18:00") \| stats count by eventName, src_ip, user \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("StartService", "InvokeService") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ActionType, ClientIP, Account \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['StartService', 'InvokeService'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY event.action, source.ip, user.name HAVING COUNT() > 5`. |
| 4. Remote Services Triggering Suspicious Processes | Remote services spawning suspicious processes, as in Cobalt Strike. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("StartService", "InvokeService") \| join user [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*powershell.exe*", "*cmd.exe*", "*sh*")] \| stats count by eventName, user, Image \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("StartService", "InvokeService") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("powershell.exe", "cmd.exe", "sh")) on Account \| summarize count() by ActionType, Account, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['StartService', 'InvokeService'] \| JOIN logs-endpoint.process-* ON user.name WHERE process.executable : ("*powershell.exe*" OR "*cmd.exe*" OR "*sh*") \| STATS COUNT() BY event.action, user.name, process.executable HAVING COUNT() > 5`. |
| 5. Remote Service Execution from Anomalous Locations | Remote services executed from unexpected geographic locations, as in FIN7. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- GeoIP Data | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("StartService", "InvokeService") AND src_geo NOT IN (trusted_locations) \| stats count by eventName, src_geo, user \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("StartService", "InvokeService") and GeoLocation !in (trustedLocations) \| summarize count() by ActionType, GeoLocation, Account \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['StartService', 'InvokeService'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY event.action, source.geo.location, user.name HAVING COUNT() > 5`. |
| 6. Remote Services with Suspicious User Agents | Remote services executed with non-standard user agents, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("StartService", "InvokeService") \| join src_ip [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by eventName, src_ip, user_agent \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("StartService", "InvokeService") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on ClientIP \| summarize count() by ActionType, ClientIP, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['StartService', 'InvokeService'] \| JOIN logs-zeek.http-* ON source.ip WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY event.action, source.ip, http.user_agent HAVING COUNT() > 5`. |
| 7. Remote Services Followed by File Creation | Remote services leading to suspicious file creation, as in APT41. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("StartService", "InvokeService") \| join user [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.sh")] \| stats count by eventName, user, FileName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("StartService", "InvokeService") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".sh")) on Account \| summarize count() by ActionType, Account, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['StartService', 'InvokeService'] \| JOIN logs-endpoint.file-* ON user.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.sh") \| STATS COUNT() BY event.action, user.name, file.name HAVING COUNT() > 5`. |
| 8. Remote Services with High Rate Limits | Remote services exceeding rate limits, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("StartService", "InvokeService") \| timechart span=1m count by user \| where count > rate_limit_threshold`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("StartService", "InvokeService") \| summarize MinuteCount=count() by bin(Timestamp, 1m), Account \| where MinuteCount > rateLimitThreshold`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['StartService', 'InvokeService'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), user.name \| WHERE COUNT() > rate_limit_threshold`. |
| 9. Remote Services with Anomalous Patterns | Remote services with repetitive or scripted patterns, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("StartService", "InvokeService") \| timechart span=1s count by user \| where count > avg(count)*5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("StartService", "InvokeService") \| summarize SecondCount=count() by bin(Timestamp, 1s), Account \| where SecondCount > avg(SecondCount) * 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['StartService', 'InvokeService'] \| STATS COUNT() BY date_histogram(@timestamp, '1s'), user.name \| WHERE COUNT() > AVG(COUNT()) * 5`. |
| 10. Remote Services via Known Vulnerable Services | Remote services executed via vulnerable services, as in FIN7. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("StartService", "InvokeService") AND service IN (known_vuln_services) \| stats count by eventName, service, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("StartService", "InvokeService") and ServiceName in (knownVulnServices) \| summarize count() by ActionType, ServiceName, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['StartService', 'InvokeService'] AND event.service IN ['known_vuln_services'] \| STATS COUNT() BY event.action, event.service, source.ip HAVING COUNT() > 5`. |

### T1047: Windows Management Instrumentation

### T1047.001: WMI Event Subscription

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious WMI Event Subscription from Malicious IPs | Adversaries create WMI event subscriptions from known malicious IPs, as seen in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*wmiprvse.exe" AND CommandLine IN ("*eventfilter*", "*eventsubscription*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "wmiprvse.exe" and ProcessCommandLine has_any ("eventfilter", "eventsubscription") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*wmiprvse.exe" AND process.command_line : ("*eventfilter*" OR "*eventsubscription*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency WMI Event Subscription Creation | High-frequency WMI event subscription creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*wmiprvse.exe" AND CommandLine IN ("*eventfilter*", "*eventsubscription*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "wmiprvse.exe" and ProcessCommandLine has_any ("eventfilter", "eventsubscription") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*wmiprvse.exe" AND process.command_line : ("*eventfilter*" OR "*eventsubscription*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. WMI Event Subscription Outside Business Hours | WMI event subscriptions created outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*wmiprvse.exe" AND CommandLine IN ("*eventfilter*", "*eventsubscription*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "wmiprvse.exe" and ProcessCommandLine has_any ("eventfilter", "eventsubscription") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*wmiprvse.exe" AND process.command_line : ("*eventfilter*" OR "*eventsubscription*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. WMI Event Subscriptions Triggering Suspicious Processes | WMI event subscriptions spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*wmiprvse.exe" AND CommandLine IN ("*eventfilter*", "*eventsubscription*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*wmiprvse.exe" Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "wmiprvse.exe" and ProcessCommandLine has_any ("eventfilter", "eventsubscription") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "wmiprvse.exe" and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*wmiprvse.exe" AND process.command_line : ("*eventfilter*" OR "*eventsubscription*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*wmiprvse.exe" AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. WMI Event Subscriptions from Anomalous Locations | WMI event subscriptions created from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*wmiprvse.exe" AND CommandLine IN ("*eventfilter*", "*eventsubscription*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "wmiprvse.exe" and ProcessCommandLine has_any ("eventfilter", "eventsubscription") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*wmiprvse.exe" AND process.command_line : ("*eventfilter*" OR "*eventsubscription*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. WMI Event Subscriptions in Cloud Environments | WMI event subscriptions in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*wmiprvse.exe" AND CommandLine IN ("*eventfilter*", "*eventsubscription*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "wmiprvse.exe" and ProcessCommandLine has_any ("eventfilter", "eventsubscription") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*wmiprvse.exe" AND process.command_line : ("*eventfilter*" OR "*eventsubscription*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. WMI Event Subscriptions with Suspicious User Agents | WMI event subscriptions with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*wmiprvse.exe" AND CommandLine IN ("*eventfilter*", "*eventsubscription*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "wmiprvse.exe" and ProcessCommandLine has_any ("eventfilter", "eventsubscription") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*wmiprvse.exe" AND process.command_line : ("*eventfilter*" OR "*eventsubscription*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. WMI Event Subscriptions Followed by File Creation | WMI event subscriptions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*wmiprvse.exe" AND CommandLine IN ("*eventfilter*", "*eventsubscription*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "wmiprvse.exe" and ProcessCommandLine has_any ("eventfilter", "eventsubscription") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*wmiprvse.exe" AND process.command_line : ("*eventfilter*" OR "*eventsubscription*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. WMI Event Subscriptions with Anomalous Protocols | WMI event subscriptions executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*wmiprvse.exe" AND CommandLine IN ("*eventfilter*", "*eventsubscription*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "wmiprvse.exe" and ProcessCommandLine has_any ("eventfilter", "eventsubscription") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*wmiprvse.exe" AND process.command_line : ("*eventfilter*" OR "*eventsubscription*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. WMI Event Subscriptions via Known Vulnerable Services | WMI event subscriptions executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*wmiprvse.exe" AND CommandLine IN ("*eventfilter*", "*eventsubscription*") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "wmiprvse.exe" and ProcessCommandLine has_any ("eventfilter", "eventsubscription") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*wmiprvse.exe" AND process.command_line : ("*eventfilter*" OR "*eventsubscription*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1047.002: PowerShell DDA

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious PowerShell DDA Execution from Malicious IPs | Adversaries execute PowerShell DDA (Dynamic Data Access) via WMI from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND CommandLine IN ("*wmic*", "*Invoke-WmiMethod*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and ProcessCommandLine has_any ("wmic", "Invoke-WmiMethod") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND process.command_line : ("*wmic*" OR "*Invoke-WmiMethod*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency PowerShell DDA Execution | High-frequency PowerShell DDA execution via WMI, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND CommandLine IN ("*wmic*", "*Invoke-WmiMethod*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and ProcessCommandLine has_any ("wmic", "Invoke-WmiMethod") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND process.command_line : ("*wmic*" OR "*Invoke-WmiMethod*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. PowerShell DDA Execution Outside Business Hours | PowerShell DDA execution via WMI outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND CommandLine IN ("*wmic*", "*Invoke-WmiMethod*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and ProcessCommandLine has_any ("wmic", "Invoke-WmiMethod") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND process.command_line : ("*wmic*" OR "*Invoke-WmiMethod*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. PowerShell DDA Triggering Suspicious Processes | PowerShell DDA via WMI spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND CommandLine IN ("*wmic*", "*Invoke-WmiMethod*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*powershell.exe" Image IN ("*cmd.exe*", "*mshta.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and ProcessCommandLine has_any ("wmic", "Invoke-WmiMethod") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "powershell.exe" and ProcessName has_any ("cmd.exe", "mshta.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND process.command_line : ("*wmic*" OR "*Invoke-WmiMethod*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*powershell.exe" AND process.executable : ("*cmd.exe*" OR "*mshta.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. PowerShell DDA from Anomalous Locations | PowerShell DDA via WMI executed from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND CommandLine IN ("*wmic*", "*Invoke-WmiMethod*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and ProcessCommandLine has_any ("wmic", "Invoke-WmiMethod") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND process.command_line : ("*wmic*" OR "*Invoke-WmiMethod*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. PowerShell DDA in Cloud Environments | PowerShell DDA via WMI in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*powershell.exe" AND CommandLine IN ("*wmic*", "*Invoke-WmiMethod*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "powershell.exe" and ProcessCommandLine has_any ("wmic", "Invoke-WmiMethod") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*powershell.exe" AND process.command_line : ("*wmic*" OR "*Invoke-WmiMethod*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. PowerShell DDA with Suspicious User Agents | PowerShell DDA via WMI with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND CommandLine IN ("*wmic*", "*Invoke-WmiMethod*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and ProcessCommandLine has_any ("wmic", "Invoke-WmiMethod") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND process.command_line : ("*wmic*" OR "*Invoke-WmiMethod*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. PowerShell DDA Followed by File Creation | PowerShell DDA via WMI leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND CommandLine IN ("*wmic*", "*Invoke-WmiMethod*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and ProcessCommandLine has_any ("wmic", "Invoke-WmiMethod") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND process.command_line : ("*wmic*" OR "*Invoke-WmiMethod*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. PowerShell DDA with Anomalous Protocols | PowerShell DDA via WMI executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND CommandLine IN ("*wmic*", "*Invoke-WmiMethod*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and ProcessCommandLine has_any ("wmic", "Invoke-WmiMethod") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND process.command_line : ("*wmic*" OR "*Invoke-WmiMethod*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. PowerShell DDA via Known Vulnerable Services | PowerShell DDA via WMI executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND CommandLine IN ("*wmic*", "*Invoke-WmiMethod*") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and ProcessCommandLine has_any ("wmic", "Invoke-WmiMethod") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND process.command_line : ("*wmic*" OR "*Invoke-WmiMethod*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1047.003: WMI Query

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious WMI Query Execution from Malicious IPs | Adversaries execute WMI queries from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*wmic*query*", "*Get-WmiObject*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("wmic query", "Get-WmiObject") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*wmic*query*" OR "*Get-WmiObject*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency WMI Query Execution | High-frequency WMI query execution, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*wmic*query*", "*Get-WmiObject*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("wmic query", "Get-WmiObject") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*wmic*query*" OR "*Get-WmiObject*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. WMI Query Execution Outside Business Hours | WMI queries executed outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*wmic*query*", "*Get-WmiObject*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("wmic query", "Get-WmiObject") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*wmic*query*" OR "*Get-WmiObject*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. WMI Queries Triggering Suspicious Processes | WMI queries spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*wmic*query*", "*Get-WmiObject*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*wmic.exe", "*powershell.exe") Image IN ("*cmd.exe*", "*mshta.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("wmic query", "Get-WmiObject") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("wmic.exe", "powershell.exe") and ProcessName has_any ("cmd.exe", "mshta.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*wmic*query*" OR "*Get-WmiObject*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*wmic.exe" OR "*powershell.exe") AND process.executable : ("*cmd.exe*" OR "*mshta.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. WMI Queries from Anomalous Locations | WMI queries executed from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*wmic*query*", "*Get-WmiObject*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("wmic query", "Get-WmiObject") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*wmic*query*" OR "*Get-WmiObject*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. WMI Queries in Cloud Environments | WMI queries in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*wmic*query*", "*Get-WmiObject*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("wmic query", "Get-WmiObject") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*wmic*query*" OR "*Get-WmiObject*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. WMI Queries with Suspicious User Agents | WMI queries with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*wmic*query*", "*Get-WmiObject*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("wmic query", "Get-WmiObject") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*wmic*query*" OR "*Get-WmiObject*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. WMI Queries Followed by File Creation | WMI queries leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*wmic*query*", "*Get-WmiObject*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("wmic query", "Get-WmiObject") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*wmic*query*" OR "*Get-WmiObject*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. WMI Queries with Anomalous Protocols | WMI queries executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*wmic*query*", "*Get-WmiObject*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("wmic query", "Get-WmiObject") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*wmic*query*" OR "*Get-WmiObject*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. WMI Queries via Known Vulnerable Services | WMI queries executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*wmic*query*", "*Get-WmiObject*") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("wmic query", "Get-WmiObject") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*wmic*query*" OR "*Get-WmiObject*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1047.004: WQL

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious WQL Query Execution from Malicious IPs | Adversaries execute WQL queries via WMI from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*SELECT*FROM*", "*WQL*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("SELECT FROM", "WQL") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*SELECT*FROM*" OR "*WQL*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency WQL Query Execution | High-frequency WQL query execution, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*SELECT*FROM*", "*WQL*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("SELECT FROM", "WQL") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*SELECT*FROM*" OR "*WQL*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. WQL Query Execution Outside Business Hours | WQL queries executed outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*SELECT*FROM*", "*WQL*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("SELECT FROM", "WQL") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*SELECT*FROM*" OR "*WQL*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. WQL Queries Triggering Suspicious Processes | WQL queries spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*SELECT*FROM*", "*WQL*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*wmic.exe", "*powershell.exe") Image IN ("*cmd.exe*", "*mshta.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("SELECT FROM", "WQL") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("wmic.exe", "powershell.exe") and ProcessName has_any ("cmd.exe", "mshta.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*SELECT*FROM*" OR "*WQL*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*wmic.exe" OR "*powershell.exe") AND process.executable : ("*cmd.exe*" OR "*mshta.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. WQL Queries from Anomalous Locations | WQL queries executed from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*SELECT*FROM*", "*WQL*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("SELECT FROM", "WQL") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*SELECT*FROM*" OR "*WQL*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. WQL Queries in Cloud Environments | WQL queries in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*SELECT*FROM*", "*WQL*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("SELECT FROM", "WQL") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*SELECT*FROM*" OR "*WQL*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. WQL Queries with Suspicious User Agents | WQL queries with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*SELECT*FROM*", "*WQL*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("SELECT FROM", "WQL") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*SELECT*FROM*" OR "*WQL*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. WQL Queries Followed by File Creation | WQL queries leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*SELECT*FROM*", "*WQL*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("SELECT FROM", "WQL") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*SELECT*FROM*" OR "*WQL*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. WQL Queries with Anomalous Protocols | WQL queries executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*SELECT*FROM*", "*WQL*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("SELECT FROM", "WQL") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*SELECT*FROM*" OR "*WQL*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. WQL Queries via Known Vulnerable Services | WQL queries executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*SELECT*FROM*", "*WQL*") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("SELECT FROM", "WQL") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*SELECT*FROM*" OR "*WQL*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1047.005: CIM/WMI Queries

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious CIM/WMI Query Execution from Malicious IPs | Adversaries execute CIM/WMI queries from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*Win32_*", "*CIM_*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("Win32_", "CIM_") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*Win32_*" OR "*CIM_*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency CIM/WMI Query Execution | High-frequency CIM/WMI query execution, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*Win32_*", "*CIM_*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("Win32_", "CIM_") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*Win32_*" OR "*CIM_*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. CIM/WMI Query Execution Outside Business Hours | CIM/WMI queries executed outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*Win32_*", "*CIM_*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("Win32_", "CIM_") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*Win32_*" OR "*CIM_*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. CIM/WMI Queries Triggering Suspicious Processes | CIM/WMI queries spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*Win32_*", "*CIM_*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*wmic.exe", "*powershell.exe") Image IN ("*cmd.exe*", "*mshta.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("Win32_", "CIM_") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("wmic.exe", "powershell.exe") and ProcessName has_any ("cmd.exe", "mshta.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*Win32_*" OR "*CIM_*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*wmic.exe" OR "*powershell.exe") AND process.executable : ("*cmd.exe*" OR "*mshta.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. CIM/WMI Queries from Anomalous Locations | CIM/WMI queries executed from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*Win32_*", "*CIM_*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("Win32_", "CIM_") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*Win32_*" OR "*CIM_*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. CIM/WMI Queries in Cloud Environments | CIM/WMI queries in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*Win32_*", "*CIM_*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("Win32_", "CIM_") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*Win32_*" OR "*CIM_*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. CIM/WMI Queries with Suspicious User Agents | CIM/WMI queries with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*Win32_*", "*CIM_*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("Win32_", "CIM_") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*Win32_*" OR "*CIM_*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. CIM/WMI Queries Followed by File Creation | CIM/WMI queries leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*Win32_*", "*CIM_*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("Win32_", "CIM_") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*Win32_*" OR "*CIM_*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. CIM/WMI Queries with Anomalous Protocols | CIM/WMI queries executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*Win32_*", "*CIM_*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("Win32_", "CIM_") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*Win32_*" OR "*CIM_*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. CIM/WMI Queries via Known Vulnerable Services | CIM/WMI queries executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*Win32_*", "*CIM_*") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("Win32_", "CIM_") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*Win32_*" OR "*CIM_*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |


### T1047.006: WCF Enumeration

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious WCF Enumeration from Malicious IPs | Adversaries perform WCF (Windows Communication Foundation) enumeration via WMI from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*WCF*", "*Win32_Service*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("WCF", "Win32_Service") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*WCF*" OR "*Win32_Service*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency WCF Enumeration | High-frequency WCF enumeration via WMI, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*WCF*", "*Win32_Service*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("WCF", "Win32_Service") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*WCF*" OR "*Win32_Service*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. WCF Enumeration Outside Business Hours | WCF enumeration via WMI outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*WCF*", "*Win32_Service*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("WCF", "Win32_Service") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*WCF*" OR "*Win32_Service*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. WCF Enumeration Triggering Suspicious Processes | WCF enumeration spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*WCF*", "*Win32_Service*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*wmic.exe", "*powershell.exe") Image IN ("*cmd.exe*", "*mshta.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("WCF", "Win32_Service") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("wmic.exe", "powershell.exe") and ProcessName has_any ("cmd.exe", "mshta.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*WCF*" OR "*Win32_Service*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*wmic.exe" OR "*powershell.exe") AND process.executable : ("*cmd.exe*" OR "*mshta.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. WCF Enumeration from Anomalous Locations | WCF enumeration executed from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*WCF*", "*Win32_Service*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("WCF", "Win32_Service") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*WCF*" OR "*Win32_Service*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. WCF Enumeration in Cloud Environments | WCF enumeration in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*WCF*", "*Win32_Service*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("WCF", "Win32_Service") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*WCF*" OR "*Win32_Service*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. WCF Enumeration with Suspicious User Agents | WCF enumeration with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*WCF*", "*Win32_Service*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("WCF", "Win32_Service") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*WCF*" OR "*Win32_Service*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. WCF Enumeration Followed by File Creation | WCF enumeration leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*WCF*", "*Win32_Service*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("WCF", "Win32_Service") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*WCF*" OR "*Win32_Service*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. WCF Enumeration with Anomalous Protocols | WCF enumeration executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*WCF*", "*Win32_Service*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("WCF", "Win32_Service") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*WCF*" OR "*Win32_Service*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. WCF Enumeration via Known Vulnerable Services | WCF enumeration executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*WCF*", "*Win32_Service*") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("WCF", "Win32_Service") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*WCF*" OR "*Win32_Service*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1610: Deploy Container
### T1610.001: Malicious Image

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Malicious Image Deployment from Malicious IPs | Adversaries deploy malicious container images from known malicious IPs, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("RunContainer", "PullImage") AND src_ip IN (threat_intel_ips) \| stats count by eventName, src_ip, image_name \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunContainer", "PullImage") and ClientIP in (threatIntelIPs) \| summarize count() by ActionType, ClientIP, ImageName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['RunContainer', 'PullImage'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY event.action, source.ip, container.image.name HAVING COUNT() > 5`. |
| 2. High-Frequency Malicious Image Pulls | High-frequency pulling or deployment of container images, as in APT41. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Metrics | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("RunContainer", "PullImage") \| timechart span=1h count by eventName, image_name \| where count > avg(count)*3`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunContainer", "PullImage") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ActionType, ImageName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['RunContainer', 'PullImage'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), event.action, container.image.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Malicious Image Deployment Outside Business Hours | Malicious image deployment outside business hours, as in APT29. | - Cloud Audit Logs (AWS ECS, Azure AKS) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("RunContainer", "PullImage") AND (_time < "08:00" OR _time > "18:00") \| stats count by eventName, image_name, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunContainer", "PullImage") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ActionType, ImageName, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['RunContainer', 'PullImage'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY event.action, container.image.name, source.ip HAVING COUNT() > 5`. |
| 4. Malicious Image Triggering Suspicious Processes | Malicious images spawning suspicious processes, as in Cobalt Strike. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("RunContainer", "PullImage") \| join image_name [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*bash*", "*sh*", "*powershell.exe*")] \| stats count by eventName, image_name, Image \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunContainer", "PullImage") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("bash", "sh", "powershell.exe")) on ImageName \| summarize count() by ActionType, ImageName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['RunContainer', 'PullImage'] \| JOIN logs-endpoint.process-* ON container.image.name WHERE process.executable : ("*bash*" OR "*sh*" OR "*powershell.exe*") \| STATS COUNT() BY event.action, container.image.name, process.executable HAVING COUNT() > 5`. |
| 5. Malicious Image Deployment from Anomalous Locations | Malicious images deployed from unexpected geographic locations, as in FIN7. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- GeoIP Data | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("RunContainer", "PullImage") AND src_geo NOT IN (trusted_locations) \| stats count by eventName, src_geo, image_name \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunContainer", "PullImage") and GeoLocation !in (trustedLocations) \| summarize count() by ActionType, GeoLocation, ImageName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['RunContainer', 'PullImage'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY event.action, source.geo.location, container.image.name HAVING COUNT() > 5`. |
| 6. Malicious Image Deployment with Suspicious User Agents | Malicious images deployed with non-standard user agents, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("RunContainer", "PullImage") \| join src_ip [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by eventName, src_ip, user_agent \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunContainer", "PullImage") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on ClientIP \| summarize count() by ActionType, ClientIP, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['RunContainer', 'PullImage'] \| JOIN logs-zeek.http-* ON source.ip WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY event.action, source.ip, http.user_agent HAVING COUNT() > 5`. |
| 7. Malicious Image Deployment Followed by File Creation | Malicious image deployment leading to suspicious file creation, as in APT41. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("RunContainer", "PullImage") \| join image_name [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.sh", "*.py", "*.bin")] \| stats count by eventName, image_name, FileName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunContainer", "PullImage") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".sh", ".py", ".bin")) on ImageName \| summarize count() by ActionType, ImageName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['RunContainer', 'PullImage'] \| JOIN logs-endpoint.file-* ON container.image.name WHERE file.name : ("*.sh" OR "*.py" OR "*.bin") \| STATS COUNT() BY event.action, container.image.name, file.name HAVING COUNT() > 5`. |
| 8. Malicious Image with High Resource Usage | Malicious images causing high CPU/memory usage, as in 2025 trends. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Metrics (CPU, Memory) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("RunContainer", "PullImage") \| join image_name [search index=metrics sourcetype=cloudwatch_metrics cpu_usage > 80 OR memory_usage > 80] \| stats count by eventName, image_name, metric_name \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunContainer", "PullImage") \| join kind=inner (Perf \| where CounterName in ("cpu_usage", "memory_usage") and CounterValue > 80) on ImageName \| summarize count() by ActionType, ImageName, CounterName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['RunContainer', 'PullImage'] \| JOIN logs-metrics-* ON container.image.name WHERE metric.name IN ['cpu_usage', 'memory_usage'] AND metric.value > 80 \| STATS COUNT() BY event.action, container.image.name, metric.name HAVING COUNT() > 5`. |
| 9. Malicious Image with Anomalous Network Patterns | Malicious images initiating anomalous network traffic, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("RunContainer", "PullImage") \| join image_name [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "dns")] \| stats count by eventName, image_name, service \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunContainer", "PullImage") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "dns")) on ImageName \| summarize count() by ActionType, ImageName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['RunContainer', 'PullImage'] \| JOIN logs-zeek.conn-* ON container.image.name WHERE network.protocol NOT IN ['http', 'https', 'dns'] \| STATS COUNT() BY event.action, container.image.name, network.protocol HAVING COUNT() > 5`. |
| 10. Malicious Image via Known Vulnerable Registries | Malicious images pulled from known vulnerable registries, as in FIN7. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("RunContainer", "PullImage") AND image_registry IN (known_vuln_registries) \| stats count by eventName, image_registry, image_name \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunContainer", "PullImage") and ImageRegistry in (knownVulnRegistries) \| summarize count() by ActionType, ImageRegistry, ImageName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['RunContainer', 'PullImage'] AND container.image.registry IN ['known_vuln_registries'] \| STATS COUNT() BY event.action, container.image.registry, container.image.name HAVING COUNT() > 5`. |

### T1609: Container Administration
### T1609.001: Manipulate Container Configuration

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Container Configuration Changes from Malicious IPs | Adversaries manipulate container configurations from known malicious IPs, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("UpdateContainerConfig", "ModifyContainer") AND src_ip IN (threat_intel_ips) \| stats count by eventName, src_ip, container_id \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("UpdateContainerConfig", "ModifyContainer") and ClientIP in (threatIntelIPs) \| summarize count() by ActionType, ClientIP, ContainerID \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['UpdateContainerConfig', 'ModifyContainer'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY event.action, source.ip, container.id HAVING COUNT() > 5`. |
| 2. High-Frequency Container Configuration Changes | High-frequency container configuration changes, as in APT41. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Metrics | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("UpdateContainerConfig", "ModifyContainer") \| timechart span=1h count by eventName, container_id \| where count > avg(count)*3`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("UpdateContainerConfig", "ModifyContainer") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ActionType, ContainerID \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['UpdateContainerConfig', 'ModifyContainer'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), event.action, container.id \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Container Configuration Changes Outside Business Hours | Container configuration changes outside business hours, as in APT29. | - Cloud Audit Logs (AWS ECS, Azure AKS) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("UpdateContainerConfig", "ModifyContainer") AND (_time < "08:00" OR _time > "18:00") \| stats count by eventName, container_id, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("UpdateContainerConfig", "ModifyContainer") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ActionType, ContainerID, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['UpdateContainerConfig', 'ModifyContainer'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY event.action, container.id, source.ip HAVING COUNT() > 5`. |
| 4. Container Configuration Changes Triggering Suspicious Processes | Container configuration changes leading to suspicious process execution, as in Cobalt Strike. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("UpdateContainerConfig", "ModifyContainer") \| join container_id [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*bash*", "*sh*", "*powershell.exe*")] \| stats count by eventName, container_id, Image \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("UpdateContainerConfig", "ModifyContainer") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("bash", "sh", "powershell.exe")) on ContainerID \| summarize count() by ActionType, ContainerID, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['UpdateContainerConfig', 'ModifyContainer'] \| JOIN logs-endpoint.process-* ON container.id WHERE process.executable : ("*bash*" OR "*sh*" OR "*powershell.exe*") \| STATS COUNT() BY event.action, container.id, process.executable HAVING COUNT() > 5`. |
| 5. Container Configuration Changes from Anomalous Locations | Container configuration changes from unexpected geographic locations, as in FIN7. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- GeoIP Data | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("UpdateContainerConfig", "ModifyContainer") AND src_geo NOT IN (trusted_locations) \| stats count by eventName, src_geo, container_id \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("UpdateContainerConfig", "ModifyContainer") and GeoLocation !in (trustedLocations) \| summarize count() by ActionType, GeoLocation, ContainerID \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['UpdateContainerConfig', 'ModifyContainer'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY event.action, source.geo.location, container.id HAVING COUNT() > 5`. |
| 6. Container Configuration Changes with Suspicious User Agents | Container configuration changes with non-standard user agents, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("UpdateContainerConfig", "ModifyContainer") \| join src_ip [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by eventName, src_ip, user_agent \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("UpdateContainerConfig", "ModifyContainer") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on ClientIP \| summarize count() by ActionType, ClientIP, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['UpdateContainerConfig', 'ModifyContainer'] \| JOIN logs-zeek.http-* ON source.ip WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY event.action, source.ip, http.user_agent HAVING COUNT() > 5`. |
| 7. Container Configuration Changes Followed by File Creation | Container configuration changes leading to suspicious file creation, as in APT41. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("UpdateContainerConfig", "ModifyContainer") \| join container_id [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.sh", "*.py", "*.bin")] \| stats count by eventName, container_id, FileName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("UpdateContainerConfig", "ModifyContainer") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".sh", ".py", ".bin")) on ContainerID \| summarize count() by ActionType, ContainerID, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['UpdateContainerConfig', 'ModifyContainer'] \| JOIN logs-endpoint.file-* ON container.id WHERE file.name : ("*.sh" OR "*.py" OR "*.bin") \| STATS COUNT() BY event.action, container.id, file.name HAVING COUNT() > 5`. |
| 8. Container Configuration Changes with High Resource Usage | Container configuration changes causing high CPU/memory usage, as in 2025 trends. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Metrics (CPU, Memory) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("UpdateContainerConfig", "ModifyContainer") \| join container_id [search index=metrics sourcetype=cloudwatch_metrics cpu_usage > 80 OR memory_usage > 80] \| stats count by eventName, container_id, metric_name \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("UpdateContainerConfig", "ModifyContainer") \| join kind=inner (Perf \| where CounterName in ("cpu_usage", "memory_usage") and CounterValue > 80) on ContainerID \| summarize count() by ActionType, ContainerID, CounterName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['UpdateContainerConfig', 'ModifyContainer'] \| JOIN logs-metrics-* ON container.id WHERE metric.name IN ['cpu_usage', 'memory_usage'] AND metric.value > 80 \| STATS COUNT() BY event.action, container.id, metric.name HAVING COUNT() > 5`. |
| 9. Container Configuration Changes with Anomalous Network Patterns | Container configuration changes initiating anomalous network traffic, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("UpdateContainerConfig", "ModifyContainer") \| join container_id [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "dns")] \| stats count by eventName, container_id, service \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("UpdateContainerConfig", "ModifyContainer") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "dns")) on ContainerID \| summarize count() by ActionType, ContainerID, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['UpdateContainerConfig', 'ModifyContainer'] \| JOIN logs-zeek.conn-* ON container.id WHERE network.protocol NOT IN ['http', 'https', 'dns'] \| STATS COUNT() BY event.action, container.id, network.protocol HAVING COUNT() > 5`. |
| 10. Container Configuration Changes via Known Vulnerable Services | Container configuration changes via known vulnerable services, as in FIN7. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("UpdateContainerConfig", "ModifyContainer") AND service IN (known_vuln_services) \| stats count by eventName, service, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("UpdateContainerConfig", "ModifyContainer") and ServiceName in (knownVulnServices) \| summarize count() by ActionType, ServiceName, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['UpdateContainerConfig', 'ModifyContainer'] AND event.service IN ['known_vuln_services'] \| STATS COUNT() BY event.action, event.service, source.ip HAVING COUNT() > 5`. |

### T1609.002: Manipulate Container Image

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Container Image Manipulation from Malicious IPs | Adversaries manipulate container images from known malicious IPs, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("BuildImage", "PushImage") AND src_ip IN (threat_intel_ips) \| stats count by eventName, src_ip, image_name \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("BuildImage", "PushImage") and ClientIP in (threatIntelIPs) \| summarize count() by ActionType, ClientIP, ImageName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['BuildImage', 'PushImage'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY event.action, source.ip, container.image.name HAVING COUNT() > 5`. |
| 2. High-Frequency Container Image Manipulation | High-frequency container image manipulation, as in APT41. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Metrics | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("BuildImage", "PushImage") \| timechart span=1h count by eventName, image_name \| where count > avg(count)*3`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("BuildImage", "PushImage") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ActionType, ImageName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['BuildImage', 'PushImage'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), event.action, container.image.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Container Image Manipulation Outside Business Hours | Container image manipulation outside business hours, as in APT29. | - Cloud Audit Logs (AWS ECS, Azure AKS) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("BuildImage", "PushImage") AND (_time < "08:00" OR _time > "18:00") \| stats count by eventName, image_name, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("BuildImage", "PushImage") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ActionType, ImageName, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['BuildImage', 'PushImage'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY event.action, container.image.name, source.ip HAVING COUNT() > 5`. |
| 4. Container Image Manipulation Triggering Suspicious Processes | Container image manipulation leading to suspicious process execution, as in Cobalt Strike. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("BuildImage", "PushImage") \| join image_name [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*bash*", "*sh*", "*powershell.exe*")] \| stats count by eventName, image_name, Image \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("BuildImage", "PushImage") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("bash", "sh", "powershell.exe")) on ImageName \| summarize count() by ActionType, ImageName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['BuildImage', 'PushImage'] \| JOIN logs-endpoint.process-* ON container.image.name WHERE process.executable : ("*bash*" OR "*sh*" OR "*powershell.exe*") \| STATS COUNT() BY event.action, container.image.name, process.executable HAVING COUNT() > 5`. |
| 5. Container Image Manipulation from Anomalous Locations | Container image manipulation from unexpected geographic locations, as in FIN7. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- GeoIP Data | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("BuildImage", "PushImage") AND src_geo NOT IN (trusted_locations) \| stats count by eventName, src_geo, image_name \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("BuildImage", "PushImage") and GeoLocation !in (trustedLocations) \| summarize count() by ActionType, GeoLocation, ImageName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['BuildImage', 'PushImage'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY event.action, source.geo.location, container.image.name HAVING COUNT() > 5`. |
| 6. Container Image Manipulation with Suspicious User Agents | Container image manipulation with non-standard user agents, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("BuildImage", "PushImage") \| join src_ip [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by eventName, src_ip, user_agent \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("BuildImage", "PushImage") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on ClientIP \| summarize count() by ActionType, ClientIP, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['BuildImage', 'PushImage'] \| JOIN logs-zeek.http-* ON source.ip WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY event.action, source.ip, http.user_agent HAVING COUNT() > 5`. |
| 7. Container Image Manipulation Followed by File Creation | Container image manipulation leading to suspicious file creation, as in APT41. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("BuildImage", "PushImage") \| join image_name [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.sh", "*.py", "*.bin")] \| stats count by eventName, image_name, FileName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("BuildImage", "PushImage") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".sh", ".py", ".bin")) on ImageName \| summarize count() by ActionType, ImageName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['BuildImage', 'PushImage'] \| JOIN logs-endpoint.file-* ON container.image.name WHERE file.name : ("*.sh" OR "*.py" OR "*.bin") \| STATS COUNT() BY event.action, container.image.name, file.name HAVING COUNT() > 5`. |
| 8. Container Image Manipulation with High Resource Usage | Container image manipulation causing high CPU/memory usage, as in 2025 trends. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Metrics (CPU, Memory) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("BuildImage", "PushImage") \| join image_name [search index=metrics sourcetype=cloudwatch_metrics cpu_usage > 80 OR memory_usage > 80] \| stats count by eventName, image_name, metric_name \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("BuildImage", "PushImage") \| join kind=inner (Perf \| where CounterName in ("cpu_usage", "memory_usage") and CounterValue > 80) on ImageName \| summarize count() by ActionType, ImageName, CounterName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['BuildImage', 'PushImage'] \| JOIN logs-metrics-* ON container.image.name WHERE metric.name IN ['cpu_usage', 'memory_usage'] AND metric.value > 80 \| STATS COUNT() BY event.action, container.image.name, metric.name HAVING COUNT() > 5`. |
| 9. Container Image Manipulation with Anomalous Network Patterns | Container image manipulation initiating anomalous network traffic, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("BuildImage", "PushImage") \| join image_name [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "dns")] \| stats count by eventName, image_name, service \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("BuildImage", "PushImage") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "dns")) on ImageName \| summarize count() by ActionType, ImageName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['BuildImage', 'PushImage'] \| JOIN logs-zeek.conn-* ON container.image.name WHERE network.protocol NOT IN ['http', 'https', 'dns'] \| STATS COUNT() BY event.action, container.image.name, network.protocol HAVING COUNT() > 5`. |
| 10. Container Image Manipulation via Known Vulnerable Registries | Container images manipulated via known vulnerable registries, as in FIN7. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("BuildImage", "PushImage") AND image_registry IN (known_vuln_registries) \| stats count by eventName, image_registry, image_name \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("BuildImage", "PushImage") and ImageRegistry in (knownVulnRegistries) \| summarize count() by ActionType, ImageRegistry, ImageName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['BuildImage', 'PushImage'] AND container.image.registry IN ['known_vuln_registries'] \| STATS COUNT() BY event.action, container.image.registry, container.image.name HAVING COUNT() > 5`. |

### T1609.003: Manipulate Container Runtime

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Container Runtime Manipulation from Malicious IPs | Adversaries manipulate container runtimes from known malicious IPs, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("ModifyRuntime", "UpdateRuntimeConfig") AND src_ip IN (threat_intel_ips) \| stats count by eventName, src_ip, container_id \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyRuntime", "UpdateRuntimeConfig") and ClientIP in (threatIntelIPs) \| summarize count() by ActionType, ClientIP, ContainerID \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['ModifyRuntime', 'UpdateRuntimeConfig'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY event.action, source.ip, container.id HAVING COUNT() > 5`. |
| 2. High-Frequency Container Runtime Manipulation | High-frequency container runtime manipulation, as in APT41. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Metrics | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("ModifyRuntime", "UpdateRuntimeConfig") \| timechart span=1h count by eventName, container_id \| where count > avg(count)*3`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyRuntime", "UpdateRuntimeConfig") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ActionType, ContainerID \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['ModifyRuntime', 'UpdateRuntimeConfig'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), event.action, container.id \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Container Runtime Manipulation Outside Business Hours | Container runtime manipulation outside business hours, as in APT29. | - Cloud Audit Logs (AWS ECS, Azure AKS) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("ModifyRuntime", "UpdateRuntimeConfig") AND (_time < "08:00" OR _time > "18:00") \| stats count by eventName, container_id, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyRuntime", "UpdateRuntimeConfig") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ActionType, ContainerID, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['ModifyRuntime', 'UpdateRuntimeConfig'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY event.action, container.id, source.ip HAVING COUNT() > 5`. |
| 4. Container Runtime Manipulation Triggering Suspicious Processes | Container runtime manipulation leading to suspicious process execution, as in Cobalt Strike. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("ModifyRuntime", "UpdateRuntimeConfig") \| join container_id [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*bash*", "*sh*", "*powershell.exe*")] \| stats count by eventName, container_id, Image \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyRuntime", "UpdateRuntimeConfig") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("bash", "sh", "powershell.exe")) on ContainerID \| summarize count() by ActionType, ContainerID, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['ModifyRuntime', 'UpdateRuntimeConfig'] \| JOIN logs-endpoint.process-* ON container.id WHERE process.executable : ("*bash*" OR "*sh*" OR "*powershell.exe*") \| STATS COUNT() BY event.action, container.id, process.executable HAVING COUNT() > 5`. |
| 5. Container Runtime Manipulation from Anomalous Locations | Container runtime manipulation from unexpected geographic locations, as in FIN7. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- GeoIP Data | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("ModifyRuntime", "UpdateRuntimeConfig") AND src_geo NOT IN (trusted_locations) \| stats count by eventName, src_geo, container_id \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyRuntime", "UpdateRuntimeConfig") and GeoLocation !in (trustedLocations) \| summarize count() by ActionType, GeoLocation, ContainerID \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['ModifyRuntime', 'UpdateRuntimeConfig'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY event.action, source.geo.location, container.id HAVING COUNT() > 5`. |
| 6. Container Runtime Manipulation with Suspicious User Agents | Container runtime manipulation with non-standard user agents, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("ModifyRuntime", "UpdateRuntimeConfig") \| join src_ip [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by eventName, src_ip, user_agent \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyRuntime", "UpdateRuntimeConfig") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on ClientIP \| summarize count() by ActionType, ClientIP, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['ModifyRuntime', 'UpdateRuntimeConfig'] \| JOIN logs-zeek.http-* ON source.ip WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY event.action, source.ip, http.user_agent HAVING COUNT() > 5`. |
| 7. Container Runtime Manipulation Followed by File Creation | Container runtime manipulation leading to suspicious file creation, as in APT41. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("ModifyRuntime", "UpdateRuntimeConfig") \| join container_id [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.sh", "*.py", "*.bin")] \| stats count by eventName, container_id, FileName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyRuntime", "UpdateRuntimeConfig") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".sh", ".py", ".bin")) on ContainerID \| summarize count() by ActionType, ContainerID, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['ModifyRuntime', 'UpdateRuntimeConfig'] \| JOIN logs-endpoint.file-* ON container.id WHERE file.name : ("*.sh" OR "*.py" OR "*.bin") \| STATS COUNT() BY event.action, container.id, file.name HAVING COUNT() > 5`. |
| 8. Container Runtime Manipulation with High Resource Usage | Container runtime manipulation causing high CPU/memory usage, as in 2025 trends. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Metrics (CPU, Memory) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("ModifyRuntime", "UpdateRuntimeConfig") \| join container_id [search index=metrics sourcetype=cloudwatch_metrics cpu_usage > 80 OR memory_usage > 80] \| stats count by eventName, container_id, metric_name \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyRuntime", "UpdateRuntimeConfig") \| join kind=inner (Perf \| where CounterName in ("cpu_usage", "memory_usage") and CounterValue > 80) on ContainerID \| summarize count() by ActionType, ContainerID, CounterName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['ModifyRuntime', 'UpdateRuntimeConfig'] \| JOIN logs-metrics-* ON container.id WHERE metric.name IN ['cpu_usage', 'memory_usage'] AND metric.value > 80 \| STATS COUNT() BY event.action, container.id, metric.name HAVING COUNT() > 5`. |
| 9. Container Runtime Manipulation with Anomalous Network Patterns | Container runtime manipulation initiating anomalous network traffic, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("ModifyRuntime", "UpdateRuntimeConfig") \| join container_id [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "dns")] \| stats count by eventName, container_id, service \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyRuntime", "UpdateRuntimeConfig") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "dns")) on ContainerID \| summarize count() by ActionType, ContainerID, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['ModifyRuntime', 'UpdateRuntimeConfig'] \| JOIN logs-zeek.conn-* ON container.id WHERE network.protocol NOT IN ['http', 'https', 'dns'] \| STATS COUNT() BY event.action, container.id, network.protocol HAVING COUNT() > 5`. |
| 10. Container Runtime Manipulation via Known Vulnerable Services | Container runtime manipulation via known vulnerable services, as in FIN7. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("ModifyRuntime", "UpdateRuntimeConfig") AND service IN (known_vuln_services) \| stats count by eventName, service, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyRuntime", "UpdateRuntimeConfig") and ServiceName in (knownVulnServices) \| summarize count() by ActionType, ServiceName, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['ModifyRuntime', 'UpdateRuntimeConfig'] AND event.service IN ['known_vuln_services'] \| STATS COUNT() BY event.action, event.service, source.ip HAVING COUNT() > 5`. |

### T1559: Inter-Process Communication

### T1559.001: Component Object Model

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious COM Object Execution from Malicious IPs | Adversaries leverage COM objects for malicious execution from known malicious IPs, as seen in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe", "*regsvr32.exe") AND CommandLine IN ("*ole32.dll*", "*combase.dll*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessCommandLine has_any ("ole32.dll", "combase.dll") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe" OR "*regsvr32.exe") AND process.command_line : ("*ole32.dll*" OR "*combase.dll*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency COM Object Execution | High-frequency COM object execution indicating potential abuse, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe", "*regsvr32.exe") AND CommandLine IN ("*ole32.dll*", "*combase.dll*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessCommandLine has_any ("ole32.dll", "combase.dll") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe" OR "*regsvr32.exe") AND process.command_line : ("*ole32.dll*" OR "*combase.dll*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. COM Object Execution Outside Business Hours | COM object execution outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe", "*regsvr32.exe") AND CommandLine IN ("*ole32.dll*", "*combase.dll*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessCommandLine has_any ("ole32.dll", "combase.dll") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe" OR "*regsvr32.exe") AND process.command_line : ("*ole32.dll*" OR "*combase.dll*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. COM Object Execution Spawning Suspicious Processes | COM object execution spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe", "*regsvr32.exe") AND CommandLine IN ("*ole32.dll*", "*combase.dll*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*rundll32.exe", "*regsvr32.exe") Image IN ("*cmd.exe*", "*mshta.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessCommandLine has_any ("ole32.dll", "combase.dll") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessName has_any ("cmd.exe", "mshta.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe" OR "*regsvr32.exe") AND process.command_line : ("*ole32.dll*" OR "*combase.dll*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*rundll32.exe" OR "*regsvr32.exe") AND process.executable : ("*cmd.exe*" OR "*mshta.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. COM Object Execution from Anomalous Locations | COM object execution from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe", "*regsvr32.exe") AND CommandLine IN ("*ole32.dll*", "*combase.dll*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessCommandLine has_any ("ole32.dll", "combase.dll") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe" OR "*regsvr32.exe") AND process.command_line : ("*ole32.dll*" OR "*combase.dll*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. COM Object Execution in Cloud Environments | COM object execution in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*rundll32.exe", "*regsvr32.exe") AND CommandLine IN ("*ole32.dll*", "*combase.dll*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessCommandLine has_any ("ole32.dll", "combase.dll") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*rundll32.exe" OR "*regsvr32.exe") AND process.command_line : ("*ole32.dll*" OR "*combase.dll*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. COM Object Execution with Suspicious User Agents | COM object execution with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe", "*regsvr32.exe") AND CommandLine IN ("*ole32.dll*", "*combase.dll*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessCommandLine has_any ("ole32.dll", "combase.dll") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe" OR "*regsvr32.exe") AND process.command_line : ("*ole32.dll*" OR "*combase.dll*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. COM Object Execution Followed by File Creation | COM object execution leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe", "*regsvr32.exe") AND CommandLine IN ("*ole32.dll*", "*combase.dll*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessCommandLine has_any ("ole32.dll", "combase.dll") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe" OR "*regsvr32.exe") AND process.command_line : ("*ole32.dll*" OR "*combase.dll*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. COM Object Execution with Anomalous Protocols | COM object execution using non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe", "*regsvr32.exe") AND CommandLine IN ("*ole32.dll*", "*combase.dll*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessCommandLine has_any ("ole32.dll", "combase.dll") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe" OR "*regsvr32.exe") AND process.command_line : ("*ole32.dll*" OR "*combase.dll*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. COM Object Execution via Known Vulnerable Services | COM object execution via known vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe", "*regsvr32.exe") AND CommandLine IN ("*ole32.dll*", "*combase.dll*") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessCommandLine has_any ("ole32.dll", "combase.dll") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe" OR "*regsvr32.exe") AND process.command_line : ("*ole32.dll*" OR "*combase.dll*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1559.002: Dynamic Data Exchange

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious DDE Execution from Malicious IPs | Adversaries use DDE for malicious execution from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe", "*word.exe", "*msra.exe") AND CommandLine IN ("*ddeexec*", "*dde*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("excel.exe", "word.exe", "msra.exe") and ProcessCommandLine has_any ("ddeexec", "dde") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*excel.exe" OR "*word.exe" OR "*msra.exe") AND process.command_line : ("*ddeexec*" OR "*dde*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency DDE Execution | High-frequency DDE execution indicating potential abuse, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe", "*word.exe", "*msra.exe") AND CommandLine IN ("*ddeexec*", "*dde*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("excel.exe", "word.exe", "msra.exe") and ProcessCommandLine has_any ("ddeexec", "dde") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*excel.exe" OR "*word.exe" OR "*msra.exe") AND process.command_line : ("*ddeexec*" OR "*dde*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. DDE Execution Outside Business Hours | DDE execution outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe", "*word.exe", "*msra.exe") AND CommandLine IN ("*ddeexec*", "*dde*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("excel.exe", "word.exe", "msra.exe") and ProcessCommandLine has_any ("ddeexec", "dde") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*excel.exe" OR "*word.exe" OR "*msra.exe") AND process.command_line : ("*ddeexec*" OR "*dde*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. DDE Execution Spawning Suspicious Processes | DDE execution spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe", "*word.exe", "*msra.exe") AND CommandLine IN ("*ddeexec*", "*dde*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*excel.exe", "*word.exe", "*msra.exe") Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("excel.exe", "word.exe", "msra.exe") and ProcessCommandLine has_any ("ddeexec", "dde") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("excel.exe", "word.exe", "msra.exe") and ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*excel.exe" OR "*word.exe" OR "*msra.exe") AND process.command_line : ("*ddeexec*" OR "*dde*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*excel.exe" OR "*word.exe" OR "*msra.exe") AND process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. DDE Execution from Anomalous Locations | DDE execution from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe", "*word.exe", "*msra.exe") AND CommandLine IN ("*ddeexec*", "*dde*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("excel.exe", "word.exe", "msra.exe") and ProcessCommandLine has_any ("ddeexec", "dde") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*excel.exe" OR "*word.exe" OR "*msra.exe") AND process.command_line : ("*ddeexec*" OR "*dde*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. DDE Execution in Cloud Environments | DDE execution in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*excel.exe", "*word.exe", "*msra.exe") AND CommandLine IN ("*ddeexec*", "*dde*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("excel.exe", "word.exe", "msra.exe") and ProcessCommandLine has_any ("ddeexec", "dde") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*excel.exe" OR "*word.exe" OR "*msra.exe") AND process.command_line : ("*ddeexec*" OR "*dde*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. DDE Execution with Suspicious User Agents | DDE execution with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe", "*word.exe", "*msra.exe") AND CommandLine IN ("*ddeexec*", "*dde*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("excel.exe", "word.exe", "msra.exe") and ProcessCommandLine has_any ("ddeexec", "dde") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*excel.exe" OR "*word.exe" OR "*msra.exe") AND process.command_line : ("*ddeexec*" OR "*dde*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. DDE Execution Followed by File Creation | DDE execution leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe", "*word.exe", "*msra.exe") AND CommandLine IN ("*ddeexec*", "*dde*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("excel.exe", "word.exe", "msra.exe") and ProcessCommandLine has_any ("ddeexec", "dde") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*excel.exe" OR "*word.exe" OR "*msra.exe") AND process.command_line : ("*ddeexec*" OR "*dde*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. DDE Execution with Anomalous Protocols | DDE execution using non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe", "*word.exe", "*msra.exe") AND CommandLine IN ("*ddeexec*", "*dde*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("excel.exe", "word.exe", "msra.exe") and ProcessCommandLine has_any ("ddeexec", "dde") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*excel.exe" OR "*word.exe" OR "*msra.exe") AND process.command_line : ("*ddeexec*" OR "*dde*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. DDE Execution via Known Vulnerable Services | DDE execution via known vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe", "*word.exe", "*msra.exe") AND CommandLine IN ("*ddeexec*", "*dde*") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("excel.exe", "word.exe", "msra.exe") and ProcessCommandLine has_any ("ddeexec", "dde") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*excel.exe" OR "*word.exe" OR "*msra.exe") AND process.command_line : ("*ddeexec*" OR "*dde*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1559.003: Named Pipe

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Named Pipe Creation from Malicious IPs | Adversaries create named pipes for inter-process communication from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Named Pipe Creation (DS0023: Sysmon ID 17)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=17 PipeName IN ("*\\\\.\\pipe\\*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 AND src_ip IN (threat_intel_ips)] \| stats count by PipeName, Image, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "NamedPipeCreated" and AdditionalFields.PipeName has "\\\\.\\pipe\\" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessRemoteIP in (threatIntelIPs)) on DeviceName \| summarize count() by AdditionalFields.PipeName, ProcessName, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "17" AND winlog.event_data.PipeName : "*\\\\.\\pipe\\*" \| JOIN logs-endpoint.process-* ON host.name WHERE source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY winlog.event_data.PipeName, process.executable, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Named Pipe Creation | High-frequency named pipe creation indicating potential abuse, as in APT41. | - Named Pipe Creation (DS0023: Sysmon ID 17)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=17 PipeName IN ("*\\\\.\\pipe\\*") \| timechart span=1h count by PipeName, Image \| where count > avg(count)*3`.<br>- **KQL**: `DeviceEvents \| where ActionType == "NamedPipeCreated" and AdditionalFields.PipeName has "\\\\.\\pipe\\" \| summarize HourlyCount=count() by bin(Timestamp, 1h), AdditionalFields.PipeName, ProcessName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "17" AND winlog.event_data.PipeName : "*\\\\.\\pipe\\*" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), winlog.event_data.PipeName, process.executable \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Named Pipe Creation Outside Business Hours | Named pipe creation outside business hours, as in APT29. | - Named Pipe Creation (DS0023: Sysmon ID 17) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=17 PipeName IN ("*\\\\.\\pipe\\*") AND (_time < "08:00" OR _time > "18:00") \| stats count by PipeName, Image, dest_host \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "NamedPipeCreated" and AdditionalFields.PipeName has "\\\\.\\pipe\\" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by AdditionalFields.PipeName, ProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "17" AND winlog.event_data.PipeName : "*\\\\.\\pipe\\*" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY winlog.event_data.PipeName, process.executable, host.name HAVING COUNT() > 5`. |
| 4. Named Pipe Creation Spawning Suspicious Processes | Named pipe creation followed by suspicious process execution, as in Cobalt Strike. | - Named Pipe Creation (DS0023: Sysmon ID 17)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=17 PipeName IN ("*\\\\.\\pipe\\*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by PipeName, Image, dest_host \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "NamedPipeCreated" and AdditionalFields.PipeName has "\\\\.\\pipe\\" \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by AdditionalFields.PipeName, ProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "17" AND winlog.event_data.PipeName : "*\\\\.\\pipe\\*" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY winlog.event_data.PipeName, process.executable, host.name HAVING COUNT() > 5`. |
| 5. Named Pipe Creation from Anomalous Locations | Named pipe creation from unexpected geographic locations, as in FIN7. | - Named Pipe Creation (DS0023: Sysmon ID 17)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=17 PipeName IN ("*\\\\.\\pipe\\*") AND src_geo NOT IN (trusted_locations) \| stats count by PipeName, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "NamedPipeCreated" and AdditionalFields.PipeName has "\\\\.\\pipe\\" and GeoLocation !in (trustedLocations) \| summarize count() by AdditionalFields.PipeName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "17" AND winlog.event_data.PipeName : "*\\\\.\\pipe\\*" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY winlog.event_data.PipeName, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Named Pipe Creation in Cloud Environments | Named pipe creation in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Named Pipe Creation (DS0023: Sysmon ID 17) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=17 PipeName IN ("*\\\\.\\pipe\\*") AND src_ip NOT IN (trusted_ips)] \| stats count by PipeName, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceEvents \| where ActionType == "NamedPipeCreated" and AdditionalFields.PipeName has "\\\\.\\pipe\\" and ClientIP !in (trustedIPs)) on DeviceName \| summarize count() by AdditionalFields.PipeName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-endpoint.events-* ON host.name WHERE event.code : "17" AND winlog.event_data.PipeName : "*\\\\.\\pipe\\*" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY winlog.event_data.PipeName, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Named Pipe Creation with Suspicious User Agents | Named pipe creation with non-standard user agents, as in Volt Typhoon. | - Named Pipe Creation (DS0023: Sysmon ID 17)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=17 PipeName IN ("*\\\\.\\pipe\\*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by PipeName, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "NamedPipeCreated" and AdditionalFields.PipeName has "\\\\.\\pipe\\" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by AdditionalFields.PipeName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "17" AND winlog.event_data.PipeName : "*\\\\.\\pipe\\*" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY winlog.event_data.PipeName, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Named Pipe Creation Followed by File Creation | Named pipe creation leading to suspicious file creation, as in APT41. | - Named Pipe Creation (DS0023: Sysmon ID 17)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=17 PipeName IN ("*\\\\.\\pipe\\*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by PipeName, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "NamedPipeCreated" and AdditionalFields.PipeName has "\\\\.\\pipe\\" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by AdditionalFields.PipeName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "17" AND winlog.event_data.PipeName : "*\\\\.\\pipe\\*" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY winlog.event_data.PipeName, host.name, file.name HAVING COUNT() > 5`. |
| 9. Named Pipe Creation with Anomalous Protocols | Named pipe creation using non-standard protocols, as in 2025 trends. | - Named Pipe Creation (DS0023: Sysmon ID 17)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=17 PipeName IN ("*\\\\.\\pipe\\*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by PipeName, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "NamedPipeCreated" and AdditionalFields.PipeName has "\\\\.\\pipe\\" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by AdditionalFields.PipeName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "17" AND winlog.event_data.PipeName : "*\\\\.\\pipe\\*" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY winlog.event_data.PipeName, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Named Pipe Creation via Known Vulnerable Services | Named pipe creation via known vulnerable services, as in FIN7. | - Named Pipe Creation (DS0023: Sysmon ID 17)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=17 PipeName IN ("*\\\\.\\pipe\\*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN (known_vuln_services)] \| stats count by PipeName, Image, dest_host \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "NamedPipeCreated" and AdditionalFields.PipeName has "\\\\.\\pipe\\" \| join kind=inner (DeviceProcessEvents \| where ProcessName in (knownVulnServices)) on DeviceName \| summarize count() by AdditionalFields.PipeName, ProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "17" AND winlog.event_data.PipeName : "*\\\\.\\pipe\\*" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable IN ['known_vuln_services'] \| STATS COUNT() BY winlog.event_data.PipeName, process.executable, host.name HAVING COUNT() > 5`. |

### T1606: Forge Web Credentials
### T1606.001: SAML Tokens

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious SAML Token Usage from Malicious IPs | Adversaries use forged or stolen SAML tokens from known malicious IPs, as seen in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=azure:ad OR sourcetype=aws:iam eventName IN ("Authenticate", "SAMLResponse") AND src_ip IN (threat_intel_ips) \| stats count by eventName, src_ip, user \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("Authenticate", "SAMLResponse") and ClientIP in (threatIntelIPs) \| summarize count() by ActionType, ClientIP, User \| where count_ > 5`.<br>- **ELK**: `FROM logs-azure.ad-* OR logs-aws.iam-* \| WHERE event.action IN ['Authenticate', 'SAMLResponse'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY event.action, source.ip, user.name HAVING COUNT() > 5`. |
| 2. High-Frequency SAML Token Authentication | High-frequency SAML token authentication attempts, indicating potential abuse, as in APT41. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Metrics | - **Splunk**: `index=cloud sourcetype=azure:ad OR sourcetype=aws:iam eventName IN ("Authenticate", "SAMLResponse") \| timechart span=1h count by eventName, user \| where count > avg(count)*3`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("Authenticate", "SAMLResponse") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ActionType, User \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-azure.ad-* OR logs-aws.iam-* \| WHERE event.action IN ['Authenticate', 'SAMLResponse'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), event.action, user.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. SAML Token Usage Outside Business Hours | SAML token authentication outside business hours, as in APT29. | - Cloud Audit Logs (AWS IAM, Azure AD) | - **Splunk**: `index=cloud sourcetype=azure:ad OR sourcetype=aws:iam eventName IN ("Authenticate", "SAMLResponse") AND (_time < "08:00" OR _time > "18:00") \| stats count by eventName, user, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("Authenticate", "SAMLResponse") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ActionType, User, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-azure.ad-* OR logs-aws.iam-* \| WHERE event.action IN ['Authenticate', 'SAMLResponse'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY event.action, user.name, source.ip HAVING COUNT() > 5`. |
| 4. SAML Token Usage Triggering Suspicious Processes | SAML token usage followed by suspicious process execution, as in Cobalt Strike. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=azure:ad OR sourcetype=aws:iam eventName IN ("Authenticate", "SAMLResponse") \| join user [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by eventName, user, Image \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("Authenticate", "SAMLResponse") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on User \| summarize count() by ActionType, User, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-azure.ad-* OR logs-aws.iam-* \| WHERE event.action IN ['Authenticate', 'SAMLResponse'] \| JOIN logs-endpoint.process-* ON user.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY event.action, user.name, process.executable HAVING COUNT() > 5`. |
| 5. SAML Token Usage from Anomalous Locations | SAML token usage from unexpected geographic locations, as in FIN7. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- GeoIP Data | - **Splunk**: `index=cloud sourcetype=azure:ad OR sourcetype=aws:iam eventName IN ("Authenticate", "SAMLResponse") AND src_geo NOT IN (trusted_locations) \| stats count by eventName, src_geo, user \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("Authenticate", "SAMLResponse") and GeoLocation !in (trustedLocations) \| summarize count() by ActionType, GeoLocation, User \| where count_ > 5`.<br>- **ELK**: `FROM logs-azure.ad-* OR logs-aws.iam-* \| WHERE event.action IN ['Authenticate', 'SAMLResponse'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY event.action, source.geo.location, user.name HAVING COUNT() > 5`. |
| 6. SAML Token Usage with Suspicious User Agents | SAML token usage with non-standard user agents, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=azure:ad OR sourcetype=aws:iam eventName IN ("Authenticate", "SAMLResponse") \| join src_ip [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by eventName, src_ip, user_agent \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("Authenticate", "SAMLResponse") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on ClientIP \| summarize count() by ActionType, ClientIP, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-azure.ad-* OR logs-aws.iam-* \| WHERE event.action IN ['Authenticate', 'SAMLResponse'] \| JOIN logs-zeek.http-* ON source.ip WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY event.action, source.ip, http.user_agent HAVING COUNT() > 5`. |
| 7. SAML Token Usage Followed by File Creation | SAML token usage leading to suspicious file creation, as in APT41. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=cloud sourcetype=azure:ad OR sourcetype=aws:iam eventName IN ("Authenticate", "SAMLResponse") \| join user [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by eventName, user, FileName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("Authenticate", "SAMLResponse") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on User \| summarize count() by ActionType, User, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-azure.ad-* OR logs-aws.iam-* \| WHERE event.action IN ['Authenticate', 'SAMLResponse'] \| JOIN logs-endpoint.file-* ON user.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY event.action, user.name, file.name HAVING COUNT() > 5`. |
| 8. SAML Token Usage with High Resource Usage | SAML token usage associated with high CPU/memory usage, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Metrics (CPU, Memory) | - **Splunk**: `index=cloud sourcetype=azure:ad OR sourcetype=aws:iam eventName IN ("Authenticate", "SAMLResponse") \| join user [search index=metrics sourcetype=cloudwatch_metrics cpu_usage > 80 OR memory_usage > 80] \| stats count by eventName, user, metric_name \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("Authenticate", "SAMLResponse") \| join kind=inner (Perf \| where CounterName in ("cpu_usage", "memory_usage") and CounterValue > 80) on User \| summarize count() by ActionType, User, CounterName \| where count_ > 5`.<br>- **ELK**: `FROM logs-azure.ad-* OR logs-aws.iam-* \| WHERE event.action IN ['Authenticate', 'SAMLResponse'] \| JOIN logs-metrics-* ON user.name WHERE metric.name IN ['cpu_usage', 'memory_usage'] AND metric.value > 80 \| STATS COUNT() BY event.action, user.name, metric.name HAVING COUNT() > 5`. |
| 9. SAML Token Usage with Anomalous Network Patterns | SAML token usage initiating anomalous network traffic, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=cloud sourcetype=azure:ad OR sourcetype=aws:iam eventName IN ("Authenticate", "SAMLResponse") \| join src_ip [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "dns")] \| stats count by eventName, src_ip, service \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("Authenticate", "SAMLResponse") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "dns")) on ClientIP \| summarize count() by ActionType, ClientIP, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-azure.ad-* OR logs-aws.iam-* \| WHERE event.action IN ['Authenticate', 'SAMLResponse'] \| JOIN logs-zeek.conn-* ON source.ip WHERE network.protocol NOT IN ['http', 'https', 'dns'] \| STATS COUNT() BY event.action, source.ip, network.protocol HAVING COUNT() > 5`. |
| 10. SAML Token Usage via Known Vulnerable Services | SAML token usage via known vulnerable services, as in FIN7. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=azure:ad OR sourcetype=aws:iam eventName IN ("Authenticate", "SAMLResponse") AND service IN (known_vuln_services) \| stats count by eventName, service, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("Authenticate", "SAMLResponse") and ServiceName in (knownVulnServices) \| summarize count() by ActionType, ServiceName, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-azure.ad-* OR logs-aws.iam-* \| WHERE event.action IN ['Authenticate', 'SAMLResponse'] AND event.service IN ['known_vuln_services'] \| STATS COUNT() BY event.action, event.service, source.ip HAVING COUNT() > 5`. |

### T1203: Exploitation for Client Execution
### T1203.001: Scheduled Task

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Scheduled Task Creation from Malicious IPs | Adversaries create scheduled tasks from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Scheduled Task Creation (DS0002: Sysmon ID 13)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*schtasks.exe", "*at.exe") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=13 AND src_ip IN (threat_intel_ips)] \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("schtasks.exe", "at.exe") \| join kind=inner (DeviceEvents \| where ActionType == "ScheduledTaskCreated" and InitiatingProcessRemoteIP in (threatIntelIPs)) on DeviceName \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*schtasks.exe" OR "*at.exe") \| JOIN logs-endpoint.events-* ON host.name WHERE event.code : "13" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Scheduled Task Creation | High-frequency scheduled task creation indicating potential abuse, as in APT41. | - Scheduled Task Creation (DS0002: Sysmon ID 13)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=13 \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceEvents \| where ActionType == "ScheduledTaskCreated" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "13" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Scheduled Task Creation Outside Business Hours | Scheduled task creation outside business hours, as in APT29. | - Scheduled Task Creation (DS0002: Sysmon ID 13) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=13 AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "ScheduledTaskCreated" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "13" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Scheduled Task Creation Spawning Suspicious Processes | Scheduled task creation followed by suspicious process execution, as in Cobalt Strike. | - Scheduled Task Creation (DS0002: Sysmon ID 13)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=13 \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by Image, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "ScheduledTaskCreated" \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by ProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "13" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY process.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Scheduled Task Creation from Anomalous Locations | Scheduled task creation from unexpected geographic locations, as in FIN7. | - Scheduled Task Creation (DS0002: Sysmon ID 13)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=13 AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "ScheduledTaskCreated" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "13" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Scheduled Task Creation in Cloud Environments | Scheduled task creation in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Scheduled Task Creation (DS0002: Sysmon ID 13) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=13 AND src_ip NOT IN (trusted_ips)] \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceEvents \| where ActionType == "ScheduledTaskCreated" and ClientIP !in (trustedIPs)) on DeviceName \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-endpoint.events-* ON host.name WHERE event.code : "13" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Scheduled Task Creation with Suspicious User Agents | Scheduled task creation with non-standard user agents, as in Volt Typhoon. | - Scheduled Task Creation (DS0002: Sysmon ID 13)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=13 \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "ScheduledTaskCreated" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "13" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Scheduled Task Creation Followed by File Creation | Scheduled task creation leading to suspicious file creation, as in APT41. | - Scheduled Task Creation (DS0002: Sysmon ID 13)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=13 \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "ScheduledTaskCreated" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "13" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Scheduled Task Creation with Anomalous Protocols | Scheduled task creation using non-standard protocols, as in 2025 trends. | - Scheduled Task Creation (DS0002: Sysmon ID 13)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=13 \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "ScheduledTaskCreated" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "13" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Scheduled Task Creation via Known Vulnerable Services | Scheduled task creation via known vulnerable services, as in FIN7. | - Scheduled Task Creation (DS0002: Sysmon ID 13)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=13 AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "ScheduledTaskCreated" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "13" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1203.002: Dynamic Linker Hijacking

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Dynamic Linker Hijacking from Malicious IPs | Adversaries perform dynamic linker hijacking from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*ld.so*", "*dyld*") AND CommandLine IN ("*LD_PRELOAD*", "*DYLD_INSERT_LIBRARIES*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("ld.so", "dyld") and ProcessCommandLine has_any ("LD_PRELOAD", "DYLD_INSERT_LIBRARIES") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*ld.so*" OR "*dyld*") AND process.command_line : ("*LD_PRELOAD*" OR "*DYLD_INSERT_LIBRARIES*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Dynamic Linker Hijacking | High-frequency dynamic linker hijacking attempts, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*ld.so*", "*dyld*") AND CommandLine IN ("*LD_PRELOAD*", "*DYLD_INSERT_LIBRARIES*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("ld.so", "dyld") and ProcessCommandLine has_any ("LD_PRELOAD", "DYLD_INSERT_LIBRARIES") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*ld.so*" OR "*dyld*") AND process.command_line : ("*LD_PRELOAD*" OR "*DYLD_INSERT_LIBRARIES*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Dynamic Linker Hijacking Outside Business Hours | Dynamic linker hijacking outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*ld.so*", "*dyld*") AND CommandLine IN ("*LD_PRELOAD*", "*DYLD_INSERT_LIBRARIES*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("ld.so", "dyld") and ProcessCommandLine has_any ("LD_PRELOAD", "DYLD_INSERT_LIBRARIES") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*ld.so*" OR "*dyld*") AND process.command_line : ("*LD_PRELOAD*" OR "*DYLD_INSERT_LIBRARIES*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Dynamic Linker Hijacking Spawning Suspicious Processes | Dynamic linker hijacking spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*ld.so*", "*dyld*") AND CommandLine IN ("*LD_PRELOAD*", "*DYLD_INSERT_LIBRARIES*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*ld.so*", "*dyld*") Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("ld.so", "dyld") and ProcessCommandLine has_any ("LD_PRELOAD", "DYLD_INSERT_LIBRARIES") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("ld.so", "dyld") and ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*ld.so*" OR "*dyld*") AND process.command_line : ("*LD_PRELOAD*" OR "*DYLD_INSERT_LIBRARIES*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*ld.so*" OR "*dyld*") AND process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Dynamic Linker Hijacking from Anomalous Locations | Dynamic linker hijacking from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*ld.so*", "*dyld*") AND CommandLine IN ("*LD_PRELOAD*", "*DYLD_INSERT_LIBRARIES*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("ld.so", "dyld") and ProcessCommandLine has_any ("LD_PRELOAD", "DYLD_INSERT_LIBRARIES") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*ld.so*" OR "*dyld*") AND process.command_line : ("*LD_PRELOAD*" OR "*DYLD_INSERT_LIBRARIES*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Dynamic Linker Hijacking in Cloud Environments | Dynamic linker hijacking in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*ld.so*", "*dyld*") AND CommandLine IN ("*LD_PRELOAD*", "*DYLD_INSERT_LIBRARIES*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("ld.so", "dyld") and ProcessCommandLine has_any ("LD_PRELOAD", "DYLD_INSERT_LIBRARIES") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*ld.so*" OR "*dyld*") AND process.command_line : ("*LD_PRELOAD*" OR "*DYLD_INSERT_LIBRARIES*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Dynamic Linker Hijacking with Suspicious User Agents | Dynamic linker hijacking with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*ld.so*", "*dyld*") AND CommandLine IN ("*LD_PRELOAD*", "*DYLD_INSERT_LIBRARIES*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("ld.so", "dyld") and ProcessCommandLine has_any ("LD_PRELOAD", "DYLD_INSERT_LIBRARIES") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*ld.so*" OR "*dyld*") AND process.command_line : ("*LD_PRELOAD*" OR "*DYLD_INSERT_LIBRARIES*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Dynamic Linker Hijacking Followed by File Creation | Dynamic linker hijacking leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*ld.so*", "*dyld*") AND CommandLine IN ("*LD_PRELOAD*", "*DYLD_INSERT_LIBRARIES*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.so", "*.dylib", "*.dll")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("ld.so", "dyld") and ProcessCommandLine has_any ("LD_PRELOAD", "DYLD_INSERT_LIBRARIES") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".so", ".dylib", ".dll")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*ld.so*" OR "*dyld*") AND process.command_line : ("*LD_PRELOAD*" OR "*DYLD_INSERT_LIBRARIES*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.so" OR "*.dylib" OR "*.dll") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Dynamic Linker Hijacking with Anomalous Protocols | Dynamic linker hijacking using non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*ld.so*", "*dyld*") AND CommandLine IN ("*LD_PRELOAD*", "*DYLD_INSERT_LIBRARIES*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("ld.so", "dyld") and ProcessCommandLine has_any ("LD_PRELOAD", "DYLD_INSERT_LIBRARIES") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*ld.so*" OR "*dyld*") AND process.command_line : ("*LD_PRELOAD*" OR "*DYLD_INSERT_LIBRARIES*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Dynamic Linker Hijacking via Known Vulnerable Services | Dynamic linker hijacking via known vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*ld.so*", "*dyld*") AND CommandLine IN ("*LD_PRELOAD*", "*DYLD_INSERT_LIBRARIES*") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("ld.so", "dyld") and ProcessCommandLine has_any ("LD_PRELOAD", "DYLD_INSERT_LIBRARIES") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*ld.so*" OR "*dyld*") AND process.command_line : ("*LD_PRELOAD*" OR "*DYLD_INSERT_LIBRARIES*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1203.003: Browser Extensions

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Browser Extension Installation from Malicious IPs | Adversaries install malicious browser extensions from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*chrome.exe", "*firefox.exe", "*edge.exe") AND CommandLine IN ("*--load-extension*", "*--install-extension*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("chrome.exe", "firefox.exe", "edge.exe") and ProcessCommandLine has_any ("--load-extension", "--install-extension") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*chrome.exe" OR "*firefox.exe" OR "*edge.exe") AND process.command_line : ("*--load-extension*" OR "*--install-extension*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Browser Extension Installation | High-frequency browser extension installation indicating potential abuse, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*chrome.exe", "*firefox.exe", "*edge.exe") AND CommandLine IN ("*--load-extension*", "*--install-extension*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("chrome.exe", "firefox.exe", "edge.exe") and ProcessCommandLine has_any ("--load-extension", "--install-extension") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*chrome.exe" OR "*firefox.exe" OR "*edge.exe") AND process.command_line : ("*--load-extension*" OR "*--install-extension*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Browser Extension Installation Outside Business Hours | Browser extension installation outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*chrome.exe", "*firefox.exe", "*edge.exe") AND CommandLine IN ("*--load-extension*", "*--install-extension*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("chrome.exe", "firefox.exe", "edge.exe") and ProcessCommandLine has_any ("--load-extension", "--install-extension") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*chrome.exe" OR "*firefox.exe" OR "*edge.exe") AND process.command_line : ("*--load-extension*" OR "*--install-extension*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Browser Extension Installation Spawning Suspicious Processes | Browser extension installation spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*chrome.exe", "*firefox.exe", "*edge.exe") AND CommandLine IN ("*--load-extension*", "*--install-extension*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*chrome.exe", "*firefox.exe", "*edge.exe") Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("chrome.exe", "firefox.exe", "edge.exe") and ProcessCommandLine has_any ("--load-extension", "--install-extension") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("chrome.exe", "firefox.exe", "edge.exe") and ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*chrome.exe" OR "*firefox.exe" OR "*edge.exe") AND process.command_line : ("*--load-extension*" OR "*--install-extension*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*chrome.exe" OR "*firefox.exe" OR "*edge.exe") AND process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Browser Extension Installation from Anomalous Locations | Browser extension installation from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*chrome.exe", "*firefox.exe", "*edge.exe") AND CommandLine IN ("*--load-extension*", "*--install-extension*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("chrome.exe", "firefox.exe", "edge.exe") and ProcessCommandLine has_any ("--load-extension", "--install-extension") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*chrome.exe" OR "*firefox.exe" OR "*edge.exe") AND process.command_line : ("*--load-extension*" OR "*--install-extension*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Browser Extension Installation in Cloud Environments | Browser extension installation in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*chrome.exe", "*firefox.exe", "*edge.exe") AND CommandLine IN ("*--load-extension*", "*--install-extension*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("chrome.exe", "firefox.exe", "edge.exe") and ProcessCommandLine has_any ("--load-extension", "--install-extension") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*chrome.exe" OR "*firefox.exe" OR "*edge.exe") AND process.command_line : ("*--load-extension*" OR "*--install-extension*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Browser Extension Installation with Suspicious User Agents | Browser extension installation with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*chrome.exe", "*firefox.exe", "*edge.exe") AND CommandLine IN ("*--load-extension*", "*--install-extension*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("chrome.exe", "firefox.exe", "edge.exe") and ProcessCommandLine has_any ("--load-extension", "--install-extension") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*chrome.exe" OR "*firefox.exe" OR "*edge.exe") AND process.command_line : ("*--load-extension*" OR "*--install-extension*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Browser Extension Installation Followed by File Creation | Browser extension installation leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*chrome.exe", "*firefox.exe", "*edge.exe") AND CommandLine IN ("*--load-extension*", "*--install-extension*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.js", "*.crx", "*.xpi")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("chrome.exe", "firefox.exe", "edge.exe") and ProcessCommandLine has_any ("--load-extension", "--install-extension") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".js", ".crx", ".xpi")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*chrome.exe" OR "*firefox.exe" OR "*edge.exe") AND process.command_line : ("*--load-extension*" OR "*--install-extension*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.js" OR "*.crx" OR "*.xpi") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Browser Extension Installation with Anomalous Network Patterns | Browser extension installation initiating anomalous network traffic, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*chrome.exe", "*firefox.exe", "*edge.exe") AND CommandLine IN ("*--load-extension*", "*--install-extension*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "dns")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("chrome.exe", "firefox.exe", "edge.exe") and ProcessCommandLine has_any ("--load-extension", "--install-extension") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "dns")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- 


### T1203.004: Search Order Hijacking

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Search Order Hijacking from Malicious IPs | Adversaries exploit search order hijacking by placing malicious DLLs in directories searched before legitimate ones, initiated from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe") AND CommandLine IN ("*.dll*") AND src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.dll") TargetFilename IN ("*\\Program Files\\*", "*\\Windows\\*")] \| stats count by Image, CommandLine, src_ip, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName endswith ".exe" and ProcessCommandLine has ".dll" and InitiatingProcessRemoteIP in (threatIntelIPs) \| join kind=inner (DeviceFileEvents \| where FileName endswith ".dll" and FolderPath has_any ("Program Files", "Windows")) on DeviceName \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*.exe" AND process.command_line : "*.dll*" AND source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : "*.dll" AND file.path : ("*\\Program Files\\*" OR "*\\Windows\\*") \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name, file.name HAVING COUNT() > 5`. |
| 2. High-Frequency DLL Load Anomalies | High-frequency loading of unexpected DLLs, indicating potential search order hijacking, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Module Load (DS0009: Sysmon ID 7)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded NOT IN (known_dlls) \| timechart span=1h count by Image, ImageLoaded \| where count > avg(count)*3`.<br>- **KQL**: `DeviceImageLoadEvents \| where ImageLoaded !in (knownDLLs) \| summarize HourlyCount=count() by bin(Timestamp, 1h), InitiatingProcessName, ImageLoaded \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.image_load-* \| WHERE winlog.event_data.ImageLoaded NOT IN ['known_dlls'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, winlog.event_data.ImageLoaded \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Search Order Hijacking Outside Business Hours | DLL loading from non-standard paths outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1)<br>- Module Load (DS0009: Sysmon ID 7) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded IN ("*.dll") AND ImageLoaded NOT IN ("*\\Windows\\System32\\*", "*\\Program Files\\*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, ImageLoaded, dest_host \| where count > 5`.<br>- **KQL**: `DeviceImageLoadEvents \| where ImageLoaded endswith ".dll" and ImageLoaded !has_any ("Windows\\System32", "Program Files") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by InitiatingProcessName, ImageLoaded, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.image_load-* \| WHERE winlog.event_data.ImageLoaded : "*.dll" AND winlog.event_data.ImageLoaded NOT LIKE ("*\\Windows\\System32\\*" OR "*\\Program Files\\*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, winlog.event_data.ImageLoaded, host.name HAVING COUNT() > 5`. |
| 4. Search Order Hijacking Spawning Suspicious Processes | Malicious DLL loading followed by suspicious child process execution, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- Module Load (DS0009: Sysmon ID 7) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded IN ("*.dll") AND ImageLoaded NOT IN ("*\\Windows\\System32\\*", "*\\Program Files\\*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*.exe") Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by ImageLoaded, ParentImage, Image, dest_host \| where count > 5`.<br>- **KQL**: `DeviceImageLoadEvents \| where ImageLoaded endswith ".dll" and ImageLoaded !has_any ("Windows\\System32", "Program Files") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName endswith ".exe" and ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by ImageLoaded, InitiatingProcessName, ProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.image_load-* \| WHERE winlog.event_data.ImageLoaded : "*.dll" AND winlog.event_data.ImageLoaded NOT LIKE ("*\\Windows\\System32\\*" OR "*\\Program Files\\*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*.exe" AND process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY winlog.event_data.ImageLoaded, process.parent.executable, process.executable, host.name HAVING COUNT() > 5`. |
| 5. Search Order Hijacking from Anomalous Locations | DLL loading from unexpected geographic locations, as in FIN7. | - Module Load (DS0009: Sysmon ID 7)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded IN ("*.dll") AND ImageLoaded NOT IN ("*\\Windows\\System32\\*", "*\\Program Files\\*") AND src_geo NOT IN (trusted_locations) \| stats count by ImageLoaded, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceImageLoadEvents \| where ImageLoaded endswith ".dll" and ImageLoaded !has_any ("Windows\\System32", "Program Files") and GeoLocation !in (trustedLocations) \| summarize count() by ImageLoaded, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.image_load-* \| WHERE winlog.event_data.ImageLoaded : "*.dll" AND winlog.event_data.ImageLoaded NOT LIKE ("*\\Windows\\System32\\*" OR "*\\Program Files\\*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY winlog.event_data.ImageLoaded, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Search Order Hijacking in Cloud Environments | Search order hijacking in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Module Load (DS0009: Sysmon ID 7) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded IN ("*.dll") AND ImageLoaded NOT IN ("*\\Windows\\System32\\*", "*\\Program Files\\*") AND src_ip NOT IN (trusted_ips)] \| stats count by ImageLoaded, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceImageLoadEvents \| where ImageLoaded endswith ".dll" and ImageLoaded !has_any ("Windows\\System32", "Program Files") and ClientIP !in (trustedIPs)) on DeviceName \| summarize count() by ImageLoaded, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-endpoint.image_load-* ON host.name WHERE winlog.event_data.ImageLoaded : "*.dll" AND winlog.event_data.ImageLoaded NOT LIKE ("*\\Windows\\System32\\*" OR "*\\Program Files\\*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY winlog.event_data.ImageLoaded, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Search Order Hijacking with Suspicious User Agents | Search order hijacking with non-standard user agents, as in Volt Typhoon. | - Module Load (DS0009: Sysmon ID 7)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded IN ("*.dll") AND ImageLoaded NOT IN ("*\\Windows\\System32\\*", "*\\Program Files\\*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by ImageLoaded, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceImageLoadEvents \| where ImageLoaded endswith ".dll" and ImageLoaded !has_any ("Windows\\System32", "Program Files") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ImageLoaded, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.image_load-* \| WHERE winlog.event_data.ImageLoaded : "*.dll" AND winlog.event_data.ImageLoaded NOT LIKE ("*\\Windows\\System32\\*" OR "*\\Program Files\\*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY winlog.event_data.ImageLoaded, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Search Order Hijacking Followed by File Creation | Search order hijacking leading to suspicious file creation, as in APT41. | - Module Load (DS0009: Sysmon ID 7)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded IN ("*.dll") AND ImageLoaded NOT IN ("*\\Windows\\System32\\*", "*\\Program Files\\*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by ImageLoaded, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceImageLoadEvents \| where ImageLoaded endswith ".dll" and ImageLoaded !has_any ("Windows\\System32", "Program Files") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ImageLoaded, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.image_load-* \| WHERE winlog.event_data.ImageLoaded : "*.dll" AND winlog.event_data.ImageLoaded NOT LIKE ("*\\Windows\\System32\\*" OR "*\\Program Files\\*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY winlog.event_data.ImageLoaded, host.name, file.name HAVING COUNT() > 5`. |
| 9. Search Order Hijacking with Anomalous Protocols | Search order hijacking using non-standard protocols, as in 2025 trends. | - Module Load (DS0009: Sysmon ID 7)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded IN ("*.dll") AND ImageLoaded NOT IN ("*\\Windows\\System32\\*", "*\\Program Files\\*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by ImageLoaded, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceImageLoadEvents \| where ImageLoaded endswith ".dll" and ImageLoaded !has_any ("Windows\\System32", "Program Files") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ImageLoaded, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.image_load-* \| WHERE winlog.event_data.ImageLoaded : "*.dll" AND winlog.event_data.ImageLoaded NOT LIKE ("*\\Windows\\System32\\*" OR "*\\Program Files\\*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY winlog.event_data.ImageLoaded, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Search Order Hijacking via Known Vulnerable Services | Search order hijacking via known vulnerable services, as in FIN7. | - Module Load (DS0009: Sysmon ID 7)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded IN ("*.dll") AND ImageLoaded NOT IN ("*\\Windows\\System32\\*", "*\\Program Files\\*") AND InitiatingProcessImage IN (known_vuln_services) \| stats count by ImageLoaded, InitiatingProcessImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceImageLoadEvents \| where ImageLoaded endswith ".dll" and ImageLoaded !has_any ("Windows\\System32", "Program Files") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ImageLoaded, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.image_load-* \| WHERE winlog.event_data.ImageLoaded : "*.dll" AND winlog.event_data.ImageLoaded NOT LIKE ("*\\Windows\\System32\\*" OR "*\\Program Files\\*") AND process.executable IN ['known_vuln_services'] \| STATS COUNT() BY winlog.event_data.ImageLoaded, process.executable, host.name HAVING COUNT() > 5`. |

### T1203.005: VBScript/HTML Application

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious VBScript/HTML Application Execution from Malicious IPs | Adversaries execute malicious VBScript or HTML applications from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe", "*mshta.exe") AND CommandLine IN ("*.vbs", "*.hta") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe", "mshta.exe") and ProcessCommandLine has_any (".vbs", ".hta") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe" OR "*mshta.exe") AND process.command_line : ("*.vbs" OR "*.hta") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency VBScript/HTML Application Execution | High-frequency execution of VBScript or HTML applications, indicating potential abuse, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe", "*mshta.exe") AND CommandLine IN ("*.vbs", "*.hta") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe", "mshta.exe") and ProcessCommandLine has_any (".vbs", ".hta") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe" OR "*mshta.exe") AND process.command_line : ("*.vbs" OR "*.hta") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. VBScript/HTML Application Execution Outside Business Hours | VBScript or HTML application execution outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe", "*mshta.exe") AND CommandLine IN ("*.vbs", "*.hta") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe", "mshta.exe") and ProcessCommandLine has_any (".vbs", ".hta") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe" OR "*mshta.exe") AND process.command_line : ("*.vbs" OR "*.hta") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. VBScript/HTML Application Execution Spawning Suspicious Processes | VBScript or HTML application execution spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe", "*mshta.exe") AND CommandLine IN ("*.vbs", "*.hta") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*wscript.exe", "*cscript.exe", "*mshta.exe") Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe", "mshta.exe") and ProcessCommandLine has_any (".vbs", ".hta") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("wscript.exe", "cscript.exe", "mshta.exe") and ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe" OR "*mshta.exe") AND process.command_line : ("*.vbs" OR "*.hta") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*wscript.exe" OR "*cscript.exe" OR "*mshta.exe") AND process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. VBScript/HTML Application Execution from Anomalous Locations | VBScript or HTML application execution from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe", "*mshta.exe") AND CommandLine IN ("*.vbs", "*.hta") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe", "mshta.exe") and ProcessCommandLine has_any (".vbs", ".hta") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe" OR "*mshta.exe") AND process.command_line : ("*.vbs" OR "*.hta") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. VBScript/HTML Application Execution in Cloud Environments | VBScript or HTML application execution in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*wscript.exe", "*cscript.exe", "*mshta.exe") AND CommandLine IN ("*.vbs", "*.hta") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("wscript.exe", "cscript.exe", "mshta.exe") and ProcessCommandLine has_any (".vbs", ".hta") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*wscript.exe" OR "*cscript.exe" OR "*mshta.exe") AND process.command_line : ("*.vbs" OR "*.hta") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. VBScript/HTML Application Execution with Suspicious User Agents | VBScript or HTML application execution with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe", "*mshta.exe") AND CommandLine IN ("*.vbs", "*.hta") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe", "mshta.exe") and ProcessCommandLine has_any (".vbs", ".hta") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe" OR "*mshta.exe") AND process.command_line : ("*.vbs" OR "*.hta") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. VBScript/HTML Application Execution Followed by File Creation | VBScript or HTML application execution leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe", "*mshta.exe") AND CommandLine IN ("*.vbs", "*.hta") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe", "mshta.exe") and ProcessCommandLine has_any (".vbs", ".hta") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe" OR "*mshta.exe") AND process.command_line : ("*.vbs" OR "*.hta") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. VBScript/HTML Application Execution with Anomalous Protocols | VBScript or HTML application execution using non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe", "*mshta.exe") AND CommandLine IN ("*.vbs", "*.hta") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe", "mshta.exe") and ProcessCommandLine has_any (".vbs", ".hta") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe" OR "*mshta.exe") AND process.command_line : ("*.vbs" OR "*.hta") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. VBScript/HTML Application Execution via Known Vulnerable Services | VBScript or HTML application execution via known vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe", "*mshta.exe") AND CommandLine IN ("*.vbs", "*.hta") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe", "mshta.exe") and ProcessCommandLine has_any (".vbs", ".hta") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe" OR "*mshta.exe") AND process.command_line : ("*.vbs" OR "*.hta") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1203.006: Browser Extensions (Chrome)

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Chrome Extension Installation from Malicious IPs | Adversaries install malicious Chrome extensions from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*chrome.exe") AND CommandLine IN ("*--load-extension*", "*--install-extension*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "chrome.exe" and ProcessCommandLine has_any ("--load-extension", "--install-extension") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*chrome.exe" AND process.command_line : ("*--load-extension*" OR "*--install-extension*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Chrome Extension Installation | High-frequency Chrome extension installation indicating potential abuse, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*chrome.exe") AND CommandLine IN ("*--load-extension*", "*--install-extension*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "chrome.exe" and ProcessCommandLine has_any ("--load-extension", "--install-extension") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*chrome.exe" AND process.command_line : ("*--load-extension*" OR "*--install-extension*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Chrome Extension Installation Outside Business Hours | Chrome extension installation outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*chrome.exe") AND CommandLine IN ("*--load-extension*", "*--install-extension*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "chrome.exe" and ProcessCommandLine has_any ("--load-extension", "--install-extension") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*chrome.exe" AND process.command_line : ("*--load-extension*" OR "*--install-extension*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Chrome Extension Installation Spawning Suspicious Processes | Chrome extension installation spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*chrome.exe") AND CommandLine IN ("*--load-extension*", "*--install-extension*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*chrome.exe") Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "chrome.exe" and ProcessCommandLine has_any ("--load-extension", "--install-extension") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has "chrome.exe" and ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*chrome.exe" AND process.command_line : ("*--load-extension*" OR "*--install-extension*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*chrome.exe" AND process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Chrome Extension Installation from Anomalous Locations | Chrome extension installation from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*chrome.exe") AND CommandLine IN ("*--load-extension*", "*--install-extension*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "chrome.exe" and ProcessCommandLine has_any ("--load-extension", "--install-extension") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*chrome.exe" AND process.command_line : ("*--load-extension*" OR "*--install-extension*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Chrome Extension Installation in Cloud Environments | Chrome extension installation in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*chrome.exe") AND CommandLine IN ("*--load-extension*", "*--install-extension*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has "chrome.exe" and ProcessCommandLine has_any ("--load-extension", "--install-extension") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*chrome.exe" AND process.command_line : ("*--load-extension*" OR "*--install-extension*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Chrome Extension Installation with Suspicious User Agents | Chrome extension installation with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*chrome.exe") AND CommandLine IN ("*--load-extension*", "*--install-extension*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "chrome.exe" and ProcessCommandLine has_any ("--load-extension", "--install-extension") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*chrome.exe" AND process.command_line : ("*--load-extension*" OR "*--install-extension*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Chrome Extension Installation Followed by File Creation | Chrome extension installation leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*chrome.exe") AND CommandLine IN ("*--load-extension*", "*--install-extension*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.js", "*.crx")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "chrome.exe" and ProcessCommandLine has_any ("--load-extension", "--install-extension") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".js", ".crx")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*chrome.exe" AND process.command_line : ("*--load-extension*" OR "*--install-extension*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.js" OR "*.crx") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Chrome Extension Installation with Anomalous Network Patterns | Chrome extension installation initiating anomalous network traffic, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*chrome.exe") AND CommandLine IN ("*--load-extension*", "*--install-extension*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "dns")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "chrome.exe" and ProcessCommandLine has_any ("--load-extension", "--install-extension") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "dns")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*chrome.exe" AND process.command_line : ("*--load-extension*" OR "*--install-extension*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'dns'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Chrome Extension Installation via Known Vulnerable Services | Chrome extension installation via known vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*chrome.exe") AND CommandLine IN ("*--load-extension*", "*--install-extension*") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "chrome.exe" and ProcessCommandLine has_any ("--load-extension", "--install-extension") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*chrome.exe" AND process.command_line : ("*--load-extension*" OR "*--install-extension*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |


### T1203.007: XLL File

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious XLL File Execution from Malicious IPs | Adversaries execute malicious XLL files in Microsoft Excel from known malicious IPs, as seen in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe") AND CommandLine IN ("*.xll") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "excel.exe" and ProcessCommandLine has ".xll" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*excel.exe" AND process.command_line : "*.xll" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency XLL File Execution | High-frequency execution of XLL files, indicating potential abuse, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe") AND CommandLine IN ("*.xll") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "excel.exe" and ProcessCommandLine has ".xll" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*excel.exe" AND process.command_line : "*.xll" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. XLL File Execution Outside Business Hours | XLL file execution outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe") AND CommandLine IN ("*.xll") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "excel.exe" and ProcessCommandLine has ".xll" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*excel.exe" AND process.command_line : "*.xll" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. XLL File Execution Spawning Suspicious Processes | XLL file execution spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe") AND CommandLine IN ("*.xll") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*excel.exe") Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "excel.exe" and ProcessCommandLine has ".xll" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has "excel.exe" and ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*excel.exe" AND process.command_line : "*.xll" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*excel.exe" AND process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. XLL File Execution from Anomalous Locations | XLL file execution from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe") AND CommandLine IN ("*.xll") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "excel.exe" and ProcessCommandLine has ".xll" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*excel.exe" AND process.command_line : "*.xll" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. XLL File Execution in Cloud Environments | XLL file execution in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*excel.exe") AND CommandLine IN ("*.xll") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has "excel.exe" and ProcessCommandLine has ".xll" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*excel.exe" AND process.command_line : "*.xll" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. XLL File Execution with Suspicious User Agents | XLL file execution with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe") AND CommandLine IN ("*.xll") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "excel.exe" and ProcessCommandLine has ".xll" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*excel.exe" AND process.command_line : "*.xll" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. XLL File Execution Followed by File Creation | XLL file execution leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe") AND CommandLine IN ("*.xll") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "excel.exe" and ProcessCommandLine has ".xll" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*excel.exe" AND process.command_line : "*.xll" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. XLL File Execution with Anomalous Network Patterns | XLL file execution initiating anomalous network traffic, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe") AND CommandLine IN ("*.xll") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "dns")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "excel.exe" and ProcessCommandLine has ".xll" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "dns")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*excel.exe" AND process.command_line : "*.xll" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'dns'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. XLL File Execution via Known Vulnerable Services | XLL file execution via known vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe") AND CommandLine IN ("*.xll") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "excel.exe" and ProcessCommandLine has ".xll" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*excel.exe" AND process.command_line : "*.xll" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1203.008: Thin Client Hijacking

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Thin Client Hijacking from Malicious IPs | Adversaries hijack thin client sessions from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mstsc.exe", "*rdpclip.exe") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("mstsc.exe", "rdpclip.exe") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*mstsc.exe" OR "*rdpclip.exe") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Thin Client Session Activity | High-frequency thin client session activity, indicating potential abuse, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mstsc.exe", "*rdpclip.exe") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("mstsc.exe", "rdpclip.exe") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*mstsc.exe" OR "*rdpclip.exe") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Thin Client Hijacking Outside Business Hours | Thin client session activity outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mstsc.exe", "*rdpclip.exe") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("mstsc.exe", "rdpclip.exe") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*mstsc.exe" OR "*rdpclip.exe") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Thin Client Hijacking Spawning Suspicious Processes | Thin client session activity spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mstsc.exe", "*rdpclip.exe") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*mstsc.exe", "*rdpclip.exe") Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("mstsc.exe", "rdpclip.exe") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("mstsc.exe", "rdpclip.exe") and ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*mstsc.exe" OR "*rdpclip.exe") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*mstsc.exe" OR "*rdpclip.exe") AND process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Thin Client Hijacking from Anomalous Locations | Thin client session activity from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mstsc.exe", "*rdpclip.exe") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("mstsc.exe", "rdpclip.exe") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*mstsc.exe" OR "*rdpclip.exe") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Thin Client Hijacking in Cloud Environments | Thin client session activity in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*mstsc.exe", "*rdpclip.exe") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("mstsc.exe", "rdpclip.exe") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*mstsc.exe" OR "*rdpclip.exe") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Thin Client Hijacking with Suspicious User Agents | Thin client session activity with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mstsc.exe", "*rdpclip.exe") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("mstsc.exe", "rdpclip.exe") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*mstsc.exe" OR "*rdpclip.exe") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Thin Client Hijacking Followed by File Creation | Thin client session activity leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mstsc.exe", "*rdpclip.exe") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("mstsc.exe", "rdpclip.exe") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*mstsc.exe" OR "*rdpclip.exe") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Thin Client Hijacking with Anomalous Network Patterns | Thin client session activity initiating anomalous network traffic, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mstsc.exe", "*rdpclip.exe") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "rdp")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("mstsc.exe", "rdpclip.exe") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "rdp")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*mstsc.exe" OR "*rdpclip.exe") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'rdp'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Thin Client Hijacking via Known Vulnerable Services | Thin client session activity via known vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mstsc.exe", "*rdpclip.exe") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("mstsc.exe", "rdpclip.exe") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*mstsc.exe" OR "*rdpclip.exe") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1203.009: Executable Extensions

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Executable Extension Execution from Malicious IPs | Adversaries execute files with uncommon executable extensions (e.g., .scr, .pif) from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.scr", "*.pif", "*.com") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".scr", ".pif", ".com") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.scr" OR "*.pif" OR "*.com") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Executable Extension Execution | High-frequency execution of uncommon executable extensions, indicating potential abuse, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.scr", "*.pif", "*.com") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".scr", ".pif", ".com") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.scr" OR "*.pif" OR "*.com") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Executable Extension Execution Outside Business Hours | Execution of uncommon executable extensions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.scr", "*.pif", "*.com") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".scr", ".pif", ".com") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.scr" OR "*.pif" OR "*.com") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Executable Extension Execution Spawning Suspicious Processes | Execution of uncommon executable extensions spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.scr", "*.pif", "*.com") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*.scr", "*.pif", "*.com") Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".scr", ".pif", ".com") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any (".scr", ".pif", ".com") and ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.scr" OR "*.pif" OR "*.com") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*.scr" OR "*.pif" OR "*.com") AND process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Executable Extension Execution from Anomalous Locations | Execution of uncommon executable extensions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.scr", "*.pif", "*.com") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".scr", ".pif", ".com") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.scr" OR "*.pif" OR "*.com") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Executable Extension Execution in Cloud Environments | Execution of uncommon executable extensions in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*.scr", "*.pif", "*.com") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any (".scr", ".pif", ".com") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*.scr" OR "*.pif" OR "*.com") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Executable Extension Execution with Suspicious User Agents | Execution of uncommon executable extensions with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.scr", "*.pif", "*.com") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".scr", ".pif", ".com") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.scr" OR "*.pif" OR "*.com") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Executable Extension Execution Followed by File Creation | Execution of uncommon executable extensions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.scr", "*.pif", "*.com") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".scr", ".pif", ".com") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.scr" OR "*.pif" OR "*.com") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Executable Extension Execution with Anomalous Network Patterns | Execution of uncommon executable extensions initiating anomalous network traffic, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.scr", "*.pif", "*.com") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "dns")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".scr", ".pif", ".com") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "dns")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.scr" OR "*.pif" OR "*.com") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'dns'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Executable Extension Execution via Known Vulnerable Services | Execution of uncommon executable extensions via known vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.scr", "*.pif", "*.com") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".scr", ".pif", ".com") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.scr" OR "*.pif" OR "*.com") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1203.010: User Mode API Hijacking

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious User Mode API Hijacking from Malicious IPs | Adversaries perform user mode API hijacking by injecting malicious code into processes from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Module Load (DS0009: Sysmon ID 7)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded IN ("*.dll") AND ImageLoaded NOT IN ("*\\Windows\\System32\\*", "*\\Program Files\\*") AND src_ip IN (threat_intel_ips) \| stats count by Image, ImageLoaded, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceImageLoadEvents \| where ImageLoaded endswith ".dll" and ImageLoaded !has_any ("Windows\\System32", "Program Files") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by InitiatingProcessName, ImageLoaded, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.image_load-* \| WHERE winlog.event_data.ImageLoaded : "*.dll" AND winlog.event_data.ImageLoaded NOT LIKE ("*\\Windows\\System32\\*" OR "*\\Program Files\\*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, winlog.event_data.ImageLoaded, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency API Hijacking Activity | High-frequency loading of suspicious DLLs, indicating potential API hijacking, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Module Load (DS0009: Sysmon ID 7)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded IN ("*.dll") AND ImageLoaded NOT IN ("*\\Windows\\System32\\*", "*\\Program Files\\*") \| timechart span=1h count by Image, ImageLoaded \| where count > avg(count)*3`.<br>- **KQL**: `DeviceImageLoadEvents \| where ImageLoaded endswith ".dll" and ImageLoaded !has_any ("Windows\\System32", "Program Files") \| summarize HourlyCount=count() by bin(Timestamp, 1h), InitiatingProcessName, ImageLoaded \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.image_load-* \| WHERE winlog.event_data.ImageLoaded : "*.dll" AND winlog.event_data.ImageLoaded NOT LIKE ("*\\Windows\\System32\\*" OR "*\\Program Files\\*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, winlog.event_data.ImageLoaded \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. User Mode API Hijacking Outside Business Hours | Suspicious DLL loading outside business hours, as in APT29. | - Module Load (DS0009: Sysmon ID 7) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded IN ("*.dll") AND ImageLoaded NOT IN ("*\\Windows\\System32\\*", "*\\Program Files\\*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, ImageLoaded, dest_host \| where count > 5`.<br>- **KQL**: `DeviceImageLoadEvents \| where ImageLoaded endswith ".dll" and ImageLoaded !has_any ("Windows\\System32", "Program Files") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by InitiatingProcessName, ImageLoaded, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.image_load-* \| WHERE winlog.event_data.ImageLoaded : "*.dll" AND winlog.event_data.ImageLoaded NOT LIKE ("*\\Windows\\System32\\*" OR "*\\Program Files\\*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, winlog.event_data.ImageLoaded, host.name HAVING COUNT() > 5`. |
| 4. User Mode API Hijacking Spawning Suspicious Processes | Suspicious DLL loading followed by suspicious child process execution, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- Module Load (DS0009: Sysmon ID 7) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded IN ("*.dll") AND ImageLoaded NOT IN ("*\\Windows\\System32\\*", "*\\Program Files\\*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by ImageLoaded, Image, dest_host \| where count > 5`.<br>- **KQL**: `DeviceImageLoadEvents \| where ImageLoaded endswith ".dll" and ImageLoaded !has_any ("Windows\\System32", "Program Files") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by ImageLoaded, ProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.image_load-* \| WHERE winlog.event_data.ImageLoaded : "*.dll" AND winlog.event_data.ImageLoaded NOT LIKE ("*\\Windows\\System32\\*" OR "*\\Program Files\\*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY winlog.event_data.ImageLoaded, process.executable, host.name HAVING COUNT() > 5`. |
| 5. User Mode API Hijacking from Anomalous Locations | Suspicious DLL loading from unexpected geographic locations, as in FIN7. | - Module Load (DS0009: Sysmon ID 7)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded IN ("*.dll") AND ImageLoaded NOT IN ("*\\Windows\\System32\\*", "*\\Program Files\\*") AND src_geo NOT IN (trusted_locations) \| stats count by ImageLoaded, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceImageLoadEvents \| where ImageLoaded endswith ".dll" and ImageLoaded !has_any ("Windows\\System32", "Program Files") and GeoLocation !in (trustedLocations) \| summarize count() by ImageLoaded, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.image_load-* \| WHERE winlog.event_data.ImageLoaded : "*.dll" AND winlog.event_data.ImageLoaded NOT LIKE ("*\\Windows\\System32\\*" OR "*\\Program Files\\*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY winlog.event_data.ImageLoaded, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. User Mode API Hijacking in Cloud Environments | Suspicious DLL loading in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Module Load (DS0009: Sysmon ID 7) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded IN ("*.dll") AND ImageLoaded NOT IN ("*\\Windows\\System32\\*", "*\\Program Files\\*") AND src_ip NOT IN (trusted_ips)] \| stats count by ImageLoaded, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceImageLoadEvents \| where ImageLoaded endswith ".dll" and ImageLoaded !has_any ("Windows\\System32", "Program Files") and ClientIP !in (trustedIPs)) on DeviceName \| summarize count() by ImageLoaded, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-endpoint.image_load-* ON host.name WHERE winlog.event_data.ImageLoaded : "*.dll" AND winlog.event_data.ImageLoaded NOT LIKE ("*\\Windows\\System32\\*" OR "*\\Program Files\\*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY winlog.event_data.ImageLoaded, source.ip, event.action HAVING COUNT() > 5`. |
| 7. User Mode API Hijacking with Suspicious User Agents | Suspicious DLL loading with non-standard user agents, as in Volt Typhoon. | - Module Load (DS0009: Sysmon ID 7)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded IN ("*.dll") AND ImageLoaded NOT IN ("*\\Windows\\System32\\*", "*\\Program Files\\*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by ImageLoaded, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceImageLoadEvents \| where ImageLoaded endswith ".dll" and ImageLoaded !has_any ("Windows\\System32", "Program Files") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ImageLoaded, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.image_load-* \| WHERE winlog.event_data.ImageLoaded : "*.dll" AND winlog.event_data.ImageLoaded NOT LIKE ("*\\Windows\\System32\\*" OR "*\\Program Files\\*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY winlog.event_data.ImageLoaded, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. User Mode API Hijacking Followed by File Creation | Suspicious DLL loading leading to suspicious file creation, as in APT41. | - Module Load (DS0009: Sysmon ID 7)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded IN ("*.dll") AND ImageLoaded NOT IN ("*\\Windows\\System32\\*", "*\\Program Files\\*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by ImageLoaded, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceImageLoadEvents \| where ImageLoaded endswith ".dll" and ImageLoaded !has_any ("Windows\\System32", "Program Files") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ImageLoaded, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.image_load-* \| WHERE winlog.event_data.ImageLoaded : "*.dll" AND winlog.event_data.ImageLoaded NOT LIKE ("*\\Windows\\System32\\*" OR "*\\Program Files\\*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY winlog.event_data.ImageLoaded, host.name, file.name HAVING COUNT() > 5`. |
| 9. User Mode API Hijacking with Anomalous Network Patterns | Suspicious DLL loading initiating anomalous network traffic, as in Volt Typhoon. | - Module Load (DS0009: Sysmon ID 7)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded IN ("*.dll") AND ImageLoaded NOT IN ("*\\Windows\\System32\\*", "*\\Program Files\\*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "dns")] \| stats count by ImageLoaded, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceImageLoadEvents \| where ImageLoaded endswith ".dll" and ImageLoaded !has_any ("Windows\\System32", "Program Files") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "dns")) on DeviceName \| summarize count() by ImageLoaded, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.image_load-* \| WHERE winlog.event_data.ImageLoaded : "*.dll" AND winlog.event_data.ImageLoaded NOT LIKE ("*\\Windows\\System32\\*" OR "*\\Program Files\\*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'dns'] \| STATS COUNT() BY winlog.event_data.ImageLoaded, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. User Mode API Hijacking via Known Vulnerable Services | Suspicious DLL loading via known vulnerable services, as in FIN7. | - Module Load (DS0009: Sysmon ID 7)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded IN ("*.dll") AND ImageLoaded NOT IN ("*\\Windows\\System32\\*", "*\\Program Files\\*") AND InitiatingProcessImage IN (known_vuln_services) \| stats count by ImageLoaded, InitiatingProcessImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceImageLoadEvents \| where ImageLoaded endswith ".dll" and ImageLoaded !has_any ("Windows\\System32", "Program Files") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ImageLoaded, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.image_load-* \| WHERE winlog.event_data.ImageLoaded : "*.dll" AND winlog.event_data.ImageLoaded NOT LIKE ("*\\Windows\\System32\\*" OR "*\\Program Files\\*") AND process.executable IN ['known_vuln_services'] \| STATS COUNT() BY winlog.event_data.ImageLoaded, process.executable, host.name HAVING COUNT() > 5`. |


### T1210: Exploitation of Remote Services
### T1210.001: RPC (Remote Procedure Call)

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious RPC Activity from Malicious IPs | Adversaries exploit RPC for lateral movement from known malicious IPs, as seen in Volt Typhoon. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="rpc" AND src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*svchost.exe", "*rpcss.exe")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "rpc" and RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("svchost.exe", "rpcss.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "rpc" AND source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*svchost.exe" OR "*rpcss.exe") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 2. High-Frequency RPC Connections | High-frequency RPC connections indicating potential lateral movement, as in APT41. | - Network Traffic (DS0029)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_conn service="rpc" \| timechart span=1h count by src_ip, dest_ip \| where count > avg(count)*3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "rpc" \| summarize HourlyCount=count() by bin(Timestamp, 1h), RemoteIP, LocalIP \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "rpc" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip, destination.ip \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. RPC Activity Outside Business Hours | RPC connections occurring outside business hours, as in APT29. | - Network Traffic (DS0029) | - **Splunk**: `index=network sourcetype=zeek_conn service="rpc" AND (_time < "08:00" OR _time > "18:00") \| stats count by src_ip, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "rpc" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by RemoteIP, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "rpc" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY source.ip, destination.ip, host.name HAVING COUNT() > 5`. |
| 4. RPC Activity Spawning Suspicious Processes | RPC connections followed by suspicious process execution, as in Cobalt Strike. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="rpc" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "rpc" \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "rpc" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 5. RPC Activity from Anomalous Locations | RPC connections from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data | - **Splunk**: `index=network sourcetype=zeek_conn service="rpc" AND src_geo NOT IN (trusted_locations) \| stats count by src_ip, src_geo, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "rpc" and GeoLocation !in (trustedLocations) \| summarize count() by RemoteIP, GeoLocation, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "rpc" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY source.ip, source.geo.location, destination.ip, host.name HAVING COUNT() > 5`. |
| 6. RPC Activity in Cloud Environments | RPC connections in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0029) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=network sourcetype=zeek_conn service="rpc" AND src_ip NOT IN (trusted_ips)] \| stats count by src_ip, dest_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceNetworkEvents \| where Protocol has "rpc" and RemoteIP !in (trustedIPs)) on DeviceName \| summarize count() by RemoteIP, LocalIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol : "rpc" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, destination.ip, event.action HAVING COUNT() > 5`. |
| 7. RPC Activity with Suspicious User Agents | RPC connections with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="rpc" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by src_ip, dest_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "rpc" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "rpc" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY source.ip, destination.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. RPC Activity Followed by File Creation | RPC connections leading to suspicious file creation, as in APT41. | - Network Traffic (DS0029)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=network sourcetype=zeek_conn service="rpc" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by src_ip, dest_ip, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "rpc" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "rpc" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY source.ip, destination.ip, host.name, file.name HAVING COUNT() > 5`. |
| 9. RPC Activity with Anomalous Protocols | RPC connections using non-standard protocols, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=network sourcetype=zeek_conn service="rpc" AND proto NOT IN ("tcp") \| stats count by src_ip, dest_ip, dest_host, proto \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "rpc" and Protocol !in ("tcp") \| summarize count() by RemoteIP, LocalIP, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "rpc" AND network.transport NOT IN ['tcp'] \| STATS COUNT() BY source.ip, destination.ip, host.name, network.transport HAVING COUNT() > 5`. |
| 10. RPC Activity via Known Vulnerable Services | RPC connections via known vulnerable services, as in FIN7. | - Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="rpc" AND dest_port IN (known_vuln_ports) \| stats count by src_ip, dest_ip, dest_port, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "rpc" and RemotePort in (knownVulnPorts) \| summarize count() by RemoteIP, LocalIP, RemotePort, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "rpc" AND destination.port IN ['known_vuln_ports'] \| STATS COUNT() BY source.ip, destination.ip, destination.port, host.name HAVING COUNT() > 5`. |

### T1210.002: SMB/Windows Admin Shares

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious SMB Admin Share Access from Malicious IPs | Adversaries access SMB/Windows Admin Shares from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="smb" AND dest_port IN (445, 139) AND src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*net.exe", "*psexec.exe")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "smb" and RemotePort in (445, 139) and RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("net.exe", "psexec.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "smb" AND destination.port IN [445, 139] AND source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*net.exe" OR "*psexec.exe") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 2. High-Frequency SMB Admin Share Access | High-frequency SMB Admin Share access, indicating potential lateral movement, as in APT41. | - Network Traffic (DS0029)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_conn service="smb" AND dest_port IN (445, 139) \| timechart span=1h count by src_ip, dest_ip \| where count > avg(count)*3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "smb" and RemotePort in (445, 139) \| summarize HourlyCount=count() by bin(Timestamp, 1h), RemoteIP, LocalIP \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "smb" AND destination.port IN [445, 139] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip, destination.ip \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. SMB Admin Share Access Outside Business Hours | SMB Admin Share access outside business hours, as in APT29. | - Network Traffic (DS0029) | - **Splunk**: `index=network sourcetype=zeek_conn service="smb" AND dest_port IN (445, 139) AND (_time < "08:00" OR _time > "18:00") \| stats count by src_ip, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "smb" and RemotePort in (445, 139) and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by RemoteIP, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "smb" AND destination.port IN [445, 139] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY source.ip, destination.ip, host.name HAVING COUNT() > 5`. |
| 4. SMB Admin Share Access Spawning Suspicious Processes | SMB Admin Share access followed by suspicious process execution, as in Cobalt Strike. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="smb" AND dest_port IN (445, 139) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "smb" and RemotePort in (445, 139) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "smb" AND destination.port IN [445, 139] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 5. SMB Admin Share Access from Anomalous Locations | SMB Admin Share access from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data | - **Splunk**: `index=network sourcetype=zeek_conn service="smb" AND dest_port IN (445, 139) AND src_geo NOT IN (trusted_locations) \| stats count by src_ip, src_geo, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "smb" and RemotePort in (445, 139) and GeoLocation !in (trustedLocations) \| summarize count() by RemoteIP, GeoLocation, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "smb" AND destination.port IN [445, 139] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY source.ip, source.geo.location, destination.ip, host.name HAVING COUNT() > 5`. |
| 6. SMB Admin Share Access in Cloud Environments | SMB Admin Share access in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0029) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=network sourcetype=zeek_conn service="smb" AND dest_port IN (445, 139) AND src_ip NOT IN (trusted_ips)] \| stats count by src_ip, dest_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceNetworkEvents \| where Protocol has "smb" and RemotePort in (445, 139) and RemoteIP !in (trustedIPs)) on DeviceName \| summarize count() by RemoteIP, LocalIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol : "smb" AND destination.port IN [445, 139] AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, destination.ip, event.action HAVING COUNT() > 5`. |
| 7. SMB Admin Share Access with Suspicious User Agents | SMB Admin Share access with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="smb" AND dest_port IN (445, 139) \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by src_ip, dest_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "smb" and RemotePort in (445, 139) \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "smb" AND destination.port IN [445, 139] \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY source.ip, destination.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. SMB Admin Share Access Followed by File Creation | SMB Admin Share access leading to suspicious file creation, as in APT41. | - Network Traffic (DS0029)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=network sourcetype=zeek_conn service="smb" AND dest_port IN (445, 139) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by src_ip, dest_ip, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "smb" and RemotePort in (445, 139) \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "smb" AND destination.port IN [445, 139] \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY source.ip, destination.ip, host.name, file.name HAVING COUNT() > 5`. |
| 9. SMB Admin Share Access with Anomalous Protocols | SMB Admin Share access using non-standard protocols, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=network sourcetype=zeek_conn service="smb" AND dest_port IN (445, 139) AND proto NOT IN ("tcp") \| stats count by src_ip, dest_ip, dest_host, proto \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "smb" and RemotePort in (445, 139) and Protocol !in ("tcp") \| summarize count() by RemoteIP, LocalIP, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "smb" AND destination.port IN [445, 139] AND network.transport NOT IN ['tcp'] \| STATS COUNT() BY source.ip, destination.ip, host.name, network.transport HAVING COUNT() > 5`. |
| 10. SMB Admin Share Access via Known Vulnerable Services | SMB Admin Share access via known vulnerable services, as in FIN7. | - Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="smb" AND dest_port IN (445, 139) AND dest_port IN (known_vuln_ports) \| stats count by src_ip, dest_ip, dest_port, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "smb" and RemotePort in (445, 139) and RemotePort in (knownVulnPorts) \| summarize count() by RemoteIP, LocalIP, RemotePort, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "smb" AND destination.port IN [445, 139] AND destination.port IN ['known_vuln_ports'] \| STATS COUNT() BY source.ip, destination.ip, destination.port, host.name HAVING COUNT() > 5`. |

### T1210.003: Printer Spoofing

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Printer Spoofing from Malicious IPs | Adversaries spoof printer services to facilitate lateral movement from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service IN ("ipp", "lpd") AND src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*spoolsv.exe", "*print.exe")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has_any ("ipp", "lpd") and RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("spoolsv.exe", "print.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol IN ['ipp', 'lpd'] AND source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*spoolsv.exe" OR "*print.exe") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 2. High-Frequency Printer Service Activity | High-frequency printer service activity, indicating potential spoofing, as in APT41. | - Network Traffic (DS0029)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_conn service IN ("ipp", "lpd") \| timechart span=1h count by src_ip, dest_ip \| where count > avg(count)*3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has_any ("ipp", "lpd") \| summarize HourlyCount=count() by bin(Timestamp, 1h), RemoteIP, LocalIP \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol IN ['ipp', 'lpd'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip, destination.ip \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Printer Spoofing Outside Business Hours | Printer service activity outside business hours, as in APT29. | - Network Traffic (DS0029) | - **Splunk**: `index=network sourcetype=zeek_conn service IN ("ipp", "lpd") AND (_time < "08:00" OR _time > "18:00") \| stats count by src_ip, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has_any ("ipp", "lpd") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by RemoteIP, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol IN ['ipp', 'lpd'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY source.ip, destination.ip, host.name HAVING COUNT() > 5`. |
| 4. Printer Spoofing Spawning Suspicious Processes | Printer service activity followed by suspicious process execution, as in Cobalt Strike. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service IN ("ipp", "lpd") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has_any ("ipp", "lpd") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol IN ['ipp', 'lpd'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd VITAMIN*.exe*" OR "*powershell.exe*") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Printer Spoofing from Anomalous Locations | Printer service activity from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data | - **Splunk**: `index=network sourcetype=zeek_conn service IN ("ipp", "lpd") AND src_geo NOT IN (trusted_locations) \| stats count by src_ip, src_geo, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has_any ("ipp", "lpd") and GeoLocation !in (trustedLocations) \| summarize count() by RemoteIP, GeoLocation, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol IN ['ipp', 'lpd'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY source.ip, source.geo.location, destination.ip, host.name HAVING COUNT() > 5`. |
| 6. Printer Spoofing in Cloud Environments | Printer service activity in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0029) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=network sourcetype=zeek_conn service IN ("ipp", "lpd") AND src_ip NOT IN (trusted_ips)] \| stats count by src_ip, dest_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceNetworkEvents \| where Protocol has_any ("ipp", "lpd") and RemoteIP !in (trustedIPs)) on DeviceName \| summarize count() by RemoteIP, LocalIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol IN ['ipp', 'lpd'] AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, destination.ip, event.action HAVING COUNT() > 5`. |
| 7. Printer Spoofing with Suspicious User Agents | Printer service activity with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service IN ("ipp", "lpd") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by src_ip, dest_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has_any ("ipp", "lpd") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol IN ['ipp', 'lpd'] \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY source.ip, destination.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Printer Spoofing Followed by File Creation | Printer service activity leading to suspicious file creation, as in APT41. | - Network Traffic (DS0029)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=network sourcetype=zeek_conn service IN ("ipp", "lpd") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by src_ip, dest_ip, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has_any ("ipp", "lpd") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol IN ['ipp', 'lpd'] \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY source.ip, destination.ip, host.name, file.name HAVING COUNT() > 5`. |
| 9. Printer Spoofing with Anomalous Protocols | Printer service activity using non-standard protocols, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=network sourcetype=zeek_conn service IN ("ipp", "lpd") AND proto NOT IN ("tcp", "udp") \| stats count by src_ip, dest_ip, dest_host, proto \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has_any ("ipp", "lpd") and Protocol !in ("tcp", "udp") \| summarize count() by RemoteIP, LocalIP, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol IN ['ipp', 'lpd'] AND network.transport NOT IN ['tcp', 'udp'] \| STATS COUNT() BY source.ip, destination.ip, host.name, network.transport HAVING COUNT() > 5`. |
| 10. Printer Spoofing via Known Vulnerable Services | Printer service activity via known vulnerable services, as in FIN7. | - Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service IN ("ipp", "lpd") AND dest_port IN (known_vuln_ports) \| stats count by src_ip, dest_ip, dest_port, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has_any ("ipp", "lpd") and RemotePort in (knownVulnPorts) \| summarize count() by RemoteIP, LocalIP, RemotePort, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol IN ['ipp', 'lpd'] AND destination.port IN ['known_vuln_ports'] \| STATS COUNT() BY source.ip, destination.ip, destination.port, host.name HAVING COUNT() > 5`. |

### T1210.004: MS-RPRN (Print System Remote Protocol)

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious MS-RPRN Activity from Malicious IPs | Adversaries exploit MS-RPRN for lateral movement from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*spoolsv.exe", "*rundll32.exe")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("spoolsv.exe", "rundll32.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*spoolsv.exe" OR "*rundll32.exe") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 2. High-Frequency MS-RPRN Activity | High-frequency MS-RPRN activity, indicating potential abuse, as in APT41. | - Network Traffic (DS0029)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" \| timechart span=1h count by src_ip, dest_ip \| where count > avg(count)*3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" \| summarize HourlyCount=count() by bin(Timestamp, 1h), RemoteIP, LocalIP \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip, destination.ip \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. MS-RPRN Activity Outside Business Hours | MS-RPRN activity outside business hours, as in APT29. | - Network Traffic (DS0029) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND (_time < "08:00" OR _time > "18:00") \| stats count by src_ip, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by RemoteIP, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY source.ip, destination.ip, host.name HAVING COUNT() > 5`. |
| 4. MS-RPRN Activity Spawning Suspicious Processes | MS-RPRN activity followed by suspicious process execution, as in Cobalt Strike. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 5. MS-RPRN Activity from Anomalous Locations | MS-RPRN activity from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND src_geo NOT IN (trusted_locations) \| stats count by src_ip, src_geo, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and GeoLocation !in (trustedLocations) \| summarize count() by RemoteIP, GeoLocation, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY source.ip, source.geo.location, destination.ip, host.name HAVING COUNT() > 5`. |
| 6. MS-RPRN Activity in Cloud Environments | MS-RPRN activity in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0029) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=network sourcetype=zeek_conn service="ms-rprn" AND src_ip NOT IN (trusted_ips)] \| stats count by src_ip, dest_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceNetworkEvents \| where Protocol has "ms-rprn" and RemoteIP !in (trustedIPs)) on DeviceName \| summarize count() by RemoteIP, LocalIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol : "ms-rprn" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, destination.ip, event.action HAVING COUNT() > 5`. |
| 7. MS-RPRN Activity with Suspicious User Agents | MS-RPRN activity with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by src_ip, dest_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY source.ip, destination.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. MS-RPRN Activity Followed by File Creation | MS-RPRN activity leading to suspicious file creation, as in APT41. | - Network Traffic (DS0029)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by src_ip, dest_ip, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY source.ip, destination.ip, host.name, file.name HAVING COUNT() > 5`. |
| 9. MS-RPRN Activity with Anomalous Protocols | MS-RPRN activity using non-standard protocols, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND proto NOT IN ("tcp") \| stats count by src_ip, dest_ip, dest_host, proto \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and Protocol !in ("tcp") \| summarize count() by RemoteIP, LocalIP, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND network.transport NOT IN ['tcp'] \| STATS COUNT() BY source.ip, destination.ip, host.name, network.transport HAVING COUNT() > 5`. |
| 10. MS-RPRN Activity via Known Vulnerable Services | MS-RPRN activity via known vulnerable services, as in FIN7. | - Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND dest_port IN (known_vuln_ports) \| stats count by src_ip, dest_ip, dest_port, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and RemotePort in (knownVulnPorts) \| summarize count() by RemoteIP, LocalIP, RemotePort, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND destination.port IN ['known_vuln_ports'] \| STATS COUNT() BY source.ip, destination.ip, destination.port, host.name HAVING COUNT() > 5`. |


### T1210.005: MS-PARAF (Print System Asynchronous Remote Protocol)

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious MS-PARAF Activity from Malicious IPs | Adversaries exploit MS-PARAF for lateral movement from known malicious IPs, as seen in Volt Typhoon. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-paraf" AND src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*spoolsv.exe", "*rundll32.exe")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-paraf" and RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("spoolsv.exe", "rundll32.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-paraf" AND source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*spoolsv.exe" OR "*rundll32.exe") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 2. High-Frequency MS-PARAF Activity | High-frequency MS-PARAF activity, indicating potential abuse, as in APT41. | - Network Traffic (DS0029)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-paraf" \| timechart span=1h count by src_ip, dest_ip \| where count > avg(count)*3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-paraf" \| summarize HourlyCount=count() by bin(Timestamp, 1h), RemoteIP, LocalIP \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-paraf" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip, destination.ip \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. MS-PARAF Activity Outside Business Hours | MS-PARAF activity outside business hours, as in APT29. | - Network Traffic (DS0029) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-paraf" AND (_time < "08:00" OR _time > "18:00") \| stats count by src_ip, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-paraf" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by RemoteIP, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-paraf" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY source.ip, destination.ip, host.name HAVING COUNT() > 5`. |
| 4. MS-PARAF Activity Spawning Suspicious Processes | MS-PARAF activity followed by suspicious process execution, as in Cobalt Strike. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-paraf" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-paraf" \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-paraf" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 5. MS-PARAF Activity from Anomalous Locations | MS-PARAF activity from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-paraf" AND src_geo NOT IN (trusted_locations) \| stats count by src_ip, src_geo, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-paraf" and GeoLocation !in (trustedLocations) \| summarize count() by RemoteIP, GeoLocation, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-paraf" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY source.ip, source.geo.location, destination.ip, host.name HAVING COUNT() > 5`. |
| 6. MS-PARAF Activity in Cloud Environments | MS-PARAF activity in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0029) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=network sourcetype=zeek_conn service="ms-paraf" AND src_ip NOT IN (trusted_ips)] \| stats count by src_ip, dest_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceNetworkEvents \| where Protocol has "ms-paraf" and RemoteIP !in (trustedIPs)) on DeviceName \| summarize count() by RemoteIP, LocalIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol : "ms-paraf" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, destination.ip, event.action HAVING COUNT() > 5`. |
| 7. MS-PARAF Activity with Suspicious User Agents | MS-PARAF activity with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-paraf" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by src_ip, dest_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-paraf" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-paraf" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY source.ip, destination.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. MS-PARAF Activity Followed by File Creation | MS-PARAF activity leading to suspicious file creation, as in APT41. | - Network Traffic (DS0029)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-paraf" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by src_ip, dest_ip, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-paraf" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-paraf" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY source.ip, destination.ip, host.name, file.name HAVING COUNT() > 5`. |
| 9. MS-PARAF Activity with Anomalous Protocols | MS-PARAF activity using non-standard protocols, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-paraf" AND proto NOT IN ("tcp") \| stats count by src_ip, dest_ip, dest_host, proto \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-paraf" and Protocol !in ("tcp") \| summarize count() by RemoteIP, LocalIP, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-paraf" AND network.transport NOT IN ['tcp'] \| STATS COUNT() BY source.ip, destination.ip, host.name, network.transport HAVING COUNT() > 5`. |
| 10. MS-PARAF Activity via Known Vulnerable Services | MS-PARAF activity via known vulnerable services, as in FIN7. | - Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-paraf" AND dest_port IN (known_vuln_ports) \| stats count by src_ip, dest_ip, dest_port, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-paraf" and RemotePort in (knownVulnPorts) \| summarize count() by RemoteIP, LocalIP, RemotePort, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-paraf" AND destination.port IN ['known_vuln_ports'] \| STATS COUNT() BY source.ip, destination.ip, destination.port, host.name HAVING COUNT() > 5`. |

### T1210.006: MS-PKCS12

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious MS-PKCS12 Activity from Malicious IPs | Adversaries exploit MS-PKCS12 for lateral movement via certificate-based attacks from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-pkcs12" AND src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*certutil.exe", "*powershell.exe")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-pkcs12" and RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("certutil.exe", "powershell.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-pkcs12" AND source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*certutil.exe" OR "*powershell.exe") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 2. High-Frequency MS-PKCS12 Activity | High-frequency MS-PKCS12 activity, indicating potential certificate misuse, as in APT41. | - Network Traffic (DS0029)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-pkcs12" \| timechart span=1h count by src_ip, dest_ip \| where count > avg(count)*3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-pkcs12" \| summarize HourlyCount=count() by bin(Timestamp, 1h), RemoteIP, LocalIP \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-pkcs12" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip, destination.ip \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. MS-PKCS12 Activity Outside Business Hours | MS-PKCS12 activity outside business hours, as in APT29. | - Network Traffic (DS0029) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-pkcs12" AND (_time < "08:00" OR _time > "18:00") \| stats count by src_ip, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-pkcs12" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by RemoteIP, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-pkcs12" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY source.ip, destination.ip, host.name HAVING COUNT() > 5`. |
| 4. MS-PKCS12 Activity Spawning Suspicious Processes | MS-PKCS12 activity followed by suspicious process execution, as in Cobalt Strike. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-pkcs12" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-pkcs12" \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-pkcs12" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 5. MS-PKCS12 Activity from Anomalous Locations | MS-PKCS12 activity from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-pkcs12" AND src_geo NOT IN (trusted_locations) \| stats count by src_ip, src_geo, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-pkcs12" and GeoLocation !in (trustedLocations) \| summarize count() by RemoteIP, GeoLocation, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-pkcs12" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY source.ip, source.geo.location, destination.ip, host.name HAVING COUNT() > 5`. |
| 6. MS-PKCS12 Activity in Cloud Environments | MS-PKCS12 activity in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0029) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=network sourcetype=zeek_conn service="ms-pkcs12" AND src_ip NOT IN (trusted_ips)] \| stats count by src_ip, dest_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceNetworkEvents \| where Protocol has "ms-pkcs12" and RemoteIP !in (trustedIPs)) on DeviceName \| summarize count() by RemoteIP, LocalIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol : "ms-pkcs12" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, destination.ip, event.action HAVING COUNT() > 5`. |
| 7. MS-PKCS12 Activity with Suspicious User Agents | MS-PKCS12 activity with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-pkcs12" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by src_ip, dest_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-pkcs12" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-pkcs12" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY source.ip, destination.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. MS-PKCS12 Activity Followed by File Creation | MS-PKCS12 activity leading to suspicious file creation, as in APT41. | - Network Traffic (DS0029)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-pkcs12" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by src_ip, dest_ip, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-pkcs12" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-pkcs12" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY source.ip, destination.ip, host.name, file.name HAVING COUNT() > 5`. |
| 9. MS-PKCS12 Activity with Anomalous Protocols | MS-PKCS12 activity using non-standard protocols, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-pkcs12" AND proto NOT IN ("tcp") \| stats count by src_ip, dest_ip, dest_host, proto \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-pkcs12" and Protocol !in ("tcp") \| summarize count() by RemoteIP, LocalIP, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-pkcs12" AND network.transport NOT IN ['tcp'] \| STATS COUNT() BY source.ip, destination.ip, host.name, network.transport HAVING COUNT() > 5`. |
| 10. MS-PKCS12 Activity via Known Vulnerable Services | MS-PKCS12 activity via known vulnerable services, as in FIN7. | - Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-pkcs12" AND dest_port IN (known_vuln_ports) \| stats count by src_ip, dest_ip, dest_port, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-pkcs12" and RemotePort in (knownVulnPorts) \| summarize count() by RemoteIP, LocalIP, RemotePort, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-pkcs12" AND destination.port IN ['known_vuln_ports'] \| STATS COUNT() BY source.ip, destination.ip, destination.port, host.name HAVING COUNT() > 5`. |

### T1210.007: MS-RPRN with Printer Bug

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious MS-RPRN Printer Bug Exploitation from Malicious IPs | Adversaries exploit MS-RPRN with Printer Bug (e.g., PrintNightmare) from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*spoolsv.exe", "*rundll32.exe") AND CommandLine IN ("*RpcAddPrinterDriver*")] \| stats count by src_ip, dest_ip, dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("spoolsv.exe", "rundll32.exe") and ProcessCommandLine has "RpcAddPrinterDriver") on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*spoolsv.exe" OR "*rundll32.exe") AND process.command_line : "*RpcAddPrinterDriver*" \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 2. High-Frequency MS-RPRN Printer Bug Activity | High-frequency MS-RPRN activity targeting Printer Bug vulnerabilities, as in APT41. | - Network Traffic (DS0029)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND CommandLine IN ("*RpcAddPrinterDriver*") \| timechart span=1h count by src_ip, dest_ip \| where count > avg(count)*3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and ProcessCommandLine has "RpcAddPrinterDriver" \| summarize HourlyCount=count() by bin(Timestamp, 1h), RemoteIP, LocalIP \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND process.command_line : "*RpcAddPrinterDriver*" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip, destination.ip \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. MS-RPRN Printer Bug Activity Outside Business Hours | MS-RPRN Printer Bug activity outside business hours, as in APT29. | - Network Traffic (DS0029) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND (_time < "08:00" OR _time > "18:00") AND CommandLine IN ("*RpcAddPrinterDriver*") \| stats count by src_ip, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and ProcessCommandLine has "RpcAddPrinterDriver" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by RemoteIP, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND process.command_line : "*RpcAddPrinterDriver*" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY source.ip, destination.ip, host.name HAVING COUNT() > 5`. |
| 4. MS-RPRN Printer Bug Activity Spawning Suspicious Processes | MS-RPRN Printer Bug activity followed by suspicious process execution, as in Cobalt Strike. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND CommandLine IN ("*RpcAddPrinterDriver*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and ProcessCommandLine has "RpcAddPrinterDriver" \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND process.command_line : "*RpcAddPrinterDriver*" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 5. MS-RPRN Printer Bug Activity from Anomalous Locations | MS-RPRN Printer Bug activity from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND src_geo NOT IN (trusted_locations) AND CommandLine IN ("*RpcAddPrinterDriver*") \| stats count by src_ip, src_geo, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and GeoLocation !in (trustedLocations) and ProcessCommandLine has "RpcAddPrinterDriver" \| summarize count() by RemoteIP, GeoLocation, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND source.geo.location NOT IN ['trusted_locations'] AND process.command_line : "*RpcAddPrinterDriver*" \| STATS COUNT() BY source.ip, source.geo.location, destination.ip, host.name HAVING COUNT() > 5`. |
| 6. MS-RPRN Printer Bug Activity in Cloud Environments | MS-RPRN Printer Bug activity in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0029) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=network sourcetype=zeek_conn service="ms-rprn" AND src_ip NOT IN (trusted_ips) AND CommandLine IN ("*RpcAddPrinterDriver*")] \| stats count by src_ip, dest_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceNetworkEvents \| where Protocol has "ms-rprn" and RemoteIP !in (trustedIPs) and ProcessCommandLine has "RpcAddPrinterDriver") on DeviceName \| summarize count() by RemoteIP, LocalIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol : "ms-rprn" AND source.ip NOT IN ['trusted_ips'] AND process.command_line : "*RpcAddPrinterDriver*" \| STATS COUNT() BY source.ip, destination.ip, event.action HAVING COUNT() > 5`. |
| 7. MS-RPRN Printer Bug Activity with Suspicious User Agents | MS-RPRN Printer Bug activity with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND CommandLine IN ("*RpcAddPrinterDriver*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by src_ip, dest_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and ProcessCommandLine has "RpcAddPrinterDriver" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND process.command_line : "*RpcAddPrinterDriver*" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY source.ip, destination.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. MS-RPRN Printer Bug Activity Followed by File Creation | MS-RPRN Printer Bug activity leading to suspicious file creation, as in APT41. | - Network Traffic (DS0029)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND CommandLine IN ("*RpcAddPrinterDriver*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by src_ip, dest_ip, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and ProcessCommandLine has "RpcAddPrinterDriver" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND process.command_line : "*RpcAddPrinterDriver*" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY source.ip, destination.ip, host.name, file.name HAVING COUNT() > 5`. |
| 9. MS-RPRN Printer Bug Activity with Anomalous Protocols | MS-RPRN Printer Bug activity using non-standard protocols, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND proto NOT IN ("tcp") AND CommandLine IN ("*RpcAddPrinterDriver*") \| stats count by src_ip, dest_ip, dest_host, proto \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and Protocol !in ("tcp") and ProcessCommandLine has "RpcAddPrinterDriver" \| summarize count() by RemoteIP, LocalIP, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND network.transport NOT IN ['tcp'] AND process.command_line : "*RpcAddPrinterDriver*" \| STATS COUNT() BY source.ip, destination.ip, host.name, network.transport HAVING COUNT() > 5`. |
| 10. MS-RPRN Printer Bug Activity via Known Vulnerable Services | MS-RPRN Printer Bug activity via known vulnerable services, as in FIN7. | - Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND dest_port IN (known_vuln_ports) AND CommandLine IN ("*RpcAddPrinterDriver*") \| stats count by src_ip, dest_ip, dest_port, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and RemotePort in (knownVulnPorts) and ProcessCommandLine has "RpcAddPrinterDriver" \| summarize count() by RemoteIP, LocalIP, RemotePort, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND destination.port IN ['known_vuln_ports'] AND process.command_line : "*RpcAddPrinterDriver*" \| STATS COUNT() BY source.ip, destination.ip, destination.port, host.name HAVING COUNT() > 5`. |

### T1210.008: MS-EFSRPC (Encrypting File System Remote Protocol)

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious MS-EFSRPC Activity from Malicious IPs | Adversaries exploit MS-EFSRPC for lateral movement from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-efsrpc" AND src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*lsass.exe", "*svchost.exe")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-efsrpc" and RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("lsass.exe", "svchost.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-efsrpc" AND source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*lsass.exe" OR "*svchost.exe") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 2. High-Frequency MS-EFSRPC Activity | High-frequency MS-EFSRPC activity, indicating potential abuse, as in APT41. | - Network Traffic (DS0029)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-efsrpc" \| timechart span=1h count by src_ip, dest_ip \| where count > avg(count)*3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-efsrpc" \| summarize HourlyCount=count() by bin(Timestamp, 1h), RemoteIP, LocalIP \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-efsrpc" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip, destination.ip \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. MS-EFSRPC Activity Outside Business Hours | MS-EFSRPC activity outside business hours, as in APT29. | - Network Traffic (DS0029) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-efsrpc" AND (_time < "08:00" OR _time > "18:00") \| stats count by src_ip, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-efsrpc" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by RemoteIP, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-efsrpc" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY source.ip, destination.ip, host.name HAVING COUNT() > 5`. |
| 4. MS-EFSRPC Activity Spawning Suspicious Processes | MS-EFSRPC activity followed by suspicious process execution, as in Cobalt Strike. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-efsrpc" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-efsrpc" \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-efsrpc" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 5. MS-EFSRPC Activity from Anomalous Locations | MS-EFSRPC activity from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-efsrpc" AND src_geo NOT IN (trusted_locations) \| stats count by src_ip, src_geo, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-efsrpc" and GeoLocation !in (trustedLocations) \| summarize count() by RemoteIP, GeoLocation, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-efsrpc" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY source.ip, source.geo.location, destination.ip, host.name HAVING COUNT() > 5`. |
| 6. MS-EFSRPC Activity in Cloud Environments | MS-EFSRPC activity in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0029) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=network sourcetype=zeek_conn service="ms-efsrpc" AND src_ip NOT IN (trusted_ips)] \| stats count by src_ip, dest_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceNetworkEvents \| where Protocol has "ms-efsrpc" and RemoteIP !in (trustedIPs)) on DeviceName \| summarize count() by RemoteIP, LocalIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol : "ms-efsrpc" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, destination.ip, event.action HAVING COUNT() > 5`. |
| 7. MS-EFSRPC Activity with Suspicious User Agents | MS-EFSRPC activity with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-efsrpc" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by src_ip, dest_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-efsrpc" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-efsrpc" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY source.ip, destination.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. MS-EFSRPC Activity Followed by File Creation | MS-EFSRPC activity leading to suspicious file creation, as in APT41. | - Network Traffic (DS0029)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-efsrpc" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by src_ip, dest_ip, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-efsrpc" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-efsrpc" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY source.ip, destination.ip, host.name, file.name HAVING COUNT() > 5`. |
| 9. MS-EFSRPC Activity with Anomalous Protocols | MS-EFSRPC activity using non-standard protocols, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-efsrpc" AND proto NOT IN ("tcp") \| stats count by src_ip, dest_ip, dest_host, proto \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-efsrpc" and Protocol !in ("tcp") \| summarize count() by RemoteIP, LocalIP, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-efsrpc" AND network.transport NOT IN ['tcp'] \| STATS COUNT() BY source.ip, destination.ip, host.name, network.transport HAVING COUNT() > 5`. |
| 10. MS-EFSRPC Activity via Known Vulnerable Services | MS-EFSRPC activity via known vulnerable services, as in FIN7. | - Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-efsrpc" AND dest_port IN (known_vuln_ports) \| stats count by src_ip, dest_ip, dest_port, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-efsrpc" and RemotePort in (knownVulnPorts) \| summarize count() by RemoteIP, LocalIP, RemotePort, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-efsrpc" AND destination.port IN ['known_vuln_ports'] \| STATS COUNT() BY source.ip, destination.ip, destination.port, host.name HAVING COUNT() > 5`. |


### T1210.009: MS-PNP (Microsoft Plug and Play)

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious MS-PNP Activity from Malicious IPs | Adversaries exploit MS-PNP for lateral movement from known malicious IPs, as seen in Volt Typhoon. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-pnp" AND src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*svchost.exe", "*rundll32.exe")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-pnp" and RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("svchost.exe", "rundll32.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-pnp" AND source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*svchost.exe" OR "*rundll32.exe") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 2. High-Frequency MS-PNP Activity | High-frequency MS-PNP activity, indicating potential abuse, as in APT41. | - Network Traffic (DS0029)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-pnp" \| timechart span=1h count by src_ip, dest_ip \| where count > avg(count)*3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-pnp" \| summarize HourlyCount=count() by bin(Timestamp, 1h), RemoteIP, LocalIP \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-pnp" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip, destination.ip \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. MS-PNP Activity Outside Business Hours | MS-PNP activity outside business hours, as in APT29. | - Network Traffic (DS0029) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-pnp" AND (_time < "08:00" OR _time > "18:00") \| stats count by src_ip, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-pnp" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by RemoteIP, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-pnp" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY source.ip, destination.ip, host.name HAVING COUNT() > 5`. |
| 4. MS-PNP Activity Spawning Suspicious Processes | MS-PNP activity followed by suspicious process execution, as in Cobalt Strike. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-pnp" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-pnp" \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-pnp" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 5. MS-PNP Activity from Anomalous Locations | MS-PNP activity from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-pnp" AND src_geo NOT IN (trusted_locations) \| stats count by src_ip, src_geo, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-pnp" and GeoLocation !in (trustedLocations) \| summarize count() by RemoteIP, GeoLocation, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-pnp" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY source.ip, source.geo.location, destination.ip, host.name HAVING COUNT() > 5`. |
| 6. MS-PNP Activity in Cloud Environments | MS-PNP activity in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0029) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=network sourcetype=zeek_conn service="ms-pnp" AND src_ip NOT IN (trusted_ips)] \| stats count by src_ip, dest_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceNetworkEvents \| where Protocol has "ms-pnp" and RemoteIP !in (trustedIPs)) on DeviceName \| summarize count() by RemoteIP, LocalIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol : "ms-pnp" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, destination.ip, event.action HAVING COUNT() > 5`. |
| 7. MS-PNP Activity with Suspicious User Agents | MS-PNP activity with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-pnp" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by src_ip, dest_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-pnp" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-pnp" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY source.ip, destination.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. MS-PNP Activity Followed by File Creation | MS-PNP activity leading to suspicious file creation, as in APT41. | - Network Traffic (DS0029)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-pnp" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by src_ip, dest_ip, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-pnp" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-pnp" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY source.ip, destination.ip, host.name, file.name HAVING COUNT() > 5`. |
| 9. MS-PNP Activity with Anomalous Protocols | MS-PNP activity using non-standard protocols, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-pnp" AND proto NOT IN ("tcp", "udp") \| stats count by src_ip, dest_ip, dest_host, proto \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-pnp" and Protocol !in ("tcp", "udp") \| summarize count() by RemoteIP, LocalIP, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-pnp" AND network.transport NOT IN ['tcp', 'udp'] \| STATS COUNT() BY source.ip, destination.ip, host.name, network.transport HAVING COUNT() > 5`. |
| 10. MS-PNP Activity via Known Vulnerable Services | MS-PNP activity via known vulnerable services, as in FIN7. | - Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-pnp" AND dest_port IN (known_vuln_ports) \| stats count by src_ip, dest_ip, dest_port, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-pnp" and RemotePort in (knownVulnPorts) \| summarize count() by RemoteIP, LocalIP, RemotePort, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-pnp" AND destination.port IN ['known_vuln_ports'] \| STATS COUNT() BY source.ip, destination.ip, destination.port, host.name HAVING COUNT() > 5`. |

### T1210.010: MS-ERR (Microsoft Error Reporting)

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious MS-ERR Activity from Malicious IPs | Adversaries exploit MS-ERR for lateral movement from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-err" AND src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*werfault.exe", "*wermgr.exe")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-err" and RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("werfault.exe", "wermgr.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-err" AND source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*werfault.exe" OR "*wermgr.exe") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 2. High-Frequency MS-ERR Activity | High-frequency MS-ERR activity, indicating potential abuse, as in APT41. | - Network Traffic (DS0029)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-err" \| timechart span=1h count by src_ip, dest_ip \| where count > avg(count)*3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-err" \| summarize HourlyCount=count() by bin(Timestamp, 1h), RemoteIP, LocalIP \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-err" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip, destination.ip \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. MS-ERR Activity Outside Business Hours | MS-ERR activity outside business hours, as in APT29. | - Network Traffic (DS0029) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-err" AND (_time < "08:00" OR _time > "18:00") \| stats count by src_ip, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-err" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by RemoteIP, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-err" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY source.ip, destination.ip, host.name HAVING COUNT() > 5`. |
| 4. MS-ERR Activity Spawning Suspicious Processes | MS-ERR activity followed by suspicious process execution, as in Cobalt Strike. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-err" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-err" \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-err" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 5. MS-ERR Activity from Anomalous Locations | MS-ERR activity from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-err" AND src_geo NOT IN (trusted_locations) \| stats count by src_ip, src_geo, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-err" and GeoLocation !in (trustedLocations) \| summarize count() by RemoteIP, GeoLocation, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-err" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY source.ip, source.geo.location, destination.ip, host.name HAVING COUNT() > 5`. |
| 6. MS-ERR Activity in Cloud Environments | MS-ERR activity in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0029) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=network sourcetype=zeek_conn service="ms-err" AND src_ip NOT IN (trusted_ips)] \| stats count by src_ip, dest_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceNetworkEvents \| where Protocol has "ms-err" and RemoteIP !in (trustedIPs)) on DeviceName \| summarize count() by RemoteIP, LocalIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol : "ms-err" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, destination.ip, event.action HAVING COUNT() > 5`. |
| 7. MS-ERR Activity with Suspicious User Agents | MS-ERR activity with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-err" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by src_ip, dest_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-err" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-err" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY source.ip, destination.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. MS-ERR Activity Followed by File Creation | MS-ERR activity leading to suspicious file creation, as in APT41. | - Network Traffic (DS0029)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-err" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by src_ip, dest_ip, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-err" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-err" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY source.ip, destination.ip, host.name, file.name HAVING COUNT() > 5`. |
| 9. MS-ERR Activity with Anomalous Protocols | MS-ERR activity using non-standard protocols, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-err" AND proto NOT IN ("tcp") \| stats count by src_ip, dest_ip, dest_host, proto \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-err" and Protocol !in ("tcp") \| summarize count() by RemoteIP, LocalIP, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-err" AND network.transport NOT IN ['tcp'] \| STATS COUNT() BY source.ip, destination.ip, host.name, network.transport HAVING COUNT() > 5`. |
| 10. MS-ERR Activity via Known Vulnerable Services | MS-ERR activity via known vulnerable services, as in FIN7. | - Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-err" AND dest_port IN (known_vuln_ports) \| stats count by src_ip, dest_ip, dest_port, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-err" and RemotePort in (knownVulnPorts) \| summarize count() by RemoteIP, LocalIP, RemotePort, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-err" AND destination.port IN ['known_vuln_ports'] \| STATS COUNT() BY source.ip, destination.ip, destination.port, host.name HAVING COUNT() > 5`. |

### T1210.011: MS-WPRN (Web Point-and-Print Protocol)

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious MS-WPRN Activity from Malicious IPs | Adversaries exploit MS-WPRN for lateral movement from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-wprn" AND src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*spoolsv.exe", "*rundll32.exe")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-wprn" and RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("spoolsv.exe", "rundll32.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-wprn" AND source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*spoolsv.exe" OR "*rundll32.exe") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 2. High-Frequency MS-WPRN Activity | High-frequency MS-WPRN activity, indicating potential abuse, as in APT41. | - Network Traffic (DS0029)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-wprn" \| timechart span=1h count by src_ip, dest_ip \| where count > avg(count)*3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-wprn" \| summarize HourlyCount=count() by bin(Timestamp, 1h), RemoteIP, LocalIP \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-wprn" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip, destination.ip \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. MS-WPRN Activity Outside Business Hours | MS-WPRN activity outside business hours, as in APT29. | - Network Traffic (DS0029) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-wprn" AND (_time < "08:00" OR _time > "18:00") \| stats count by src_ip, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-wprn" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by RemoteIP, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-wprn" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY source.ip, destination.ip, host.name HAVING COUNT() > 5`. |
| 4. MS-WPRN Activity Spawning Suspicious Processes | MS-WPRN activity followed by suspicious process execution, as in Cobalt Strike. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-wprn" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-wprn" \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-wprn" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 5. MS-WPRN Activity from Anomalous Locations | MS-WPRN activity from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-wprn" AND src_geo NOT IN (trusted_locations) \| stats count by src_ip, src_geo, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-wprn" and GeoLocation !in (trustedLocations) \| summarize count() by RemoteIP, GeoLocation, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-wprn" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY source.ip, source.geo.location, destination.ip, host.name HAVING COUNT() > 5`. |
| 6. MS-WPRN Activity in Cloud Environments | MS-WPRN activity in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0029) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=network sourcetype=zeek_conn service="ms-wprn" AND src_ip NOT IN (trusted_ips)] \| stats count by src_ip, dest_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceNetworkEvents \| where Protocol has "ms-wprn" and RemoteIP !in (trustedIPs)) on DeviceName \| summarize count() by RemoteIP, LocalIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol : "ms-wprn" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, destination.ip, event.action HAVING COUNT() > 5`. |
| 7. MS-WPRN Activity with Suspicious User Agents | MS-WPRN activity with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-wprn" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by src_ip, dest_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-wprn" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-wprn" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY source.ip, destination.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. MS-WPRN Activity Followed by File Creation | MS-WPRN activity leading to suspicious file creation, as in APT41. | - Network Traffic (DS0029)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-wprn" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by src_ip, dest_ip, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-wprn" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-wprn" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY source.ip, destination.ip, host.name, file.name HAVING COUNT() > 5`. |
| 9. MS-WPRN Activity with Anomalous Protocols | MS-WPRN activity using non-standard protocols, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-wprn" AND proto NOT IN ("tcp") \| stats count by src_ip, dest_ip, dest_host, proto \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-wprn" and Protocol !in ("tcp") \| summarize count() by RemoteIP, LocalIP, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-wprn" AND network.transport NOT IN ['tcp'] \| STATS COUNT() BY source.ip, destination.ip, host.name, network.transport HAVING COUNT() > 5`. |
| 10. MS-WPRN Activity via Known Vulnerable Services | MS-WPRN activity via known vulnerable services, as in FIN7. | - Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-wprn" AND dest_port IN (known_vuln_ports) \| stats count by src_ip, dest_ip, dest_port, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-wprn" and RemotePort in (knownVulnPorts) \| summarize count() by RemoteIP, LocalIP, RemotePort, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-wprn" AND destination.port IN ['known_vuln_ports'] \| STATS COUNT() BY source.ip, destination.ip, destination.port, host.name HAVING COUNT() > 5`. |

#### T1210.012: MS-RDPELE (Remote Desktop Protocol Elevation)

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious MS-RDPELE Activity from Malicious IPs | Adversaries exploit MS-RDPELE for privilege escalation or lateral movement from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rdpele" AND src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mstsc.exe", "*svchost.exe")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rdpele" and RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("mstsc.exe", "svchost.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rdpele" AND source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*mstsc.exe" OR "*svchost.exe") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 2. High-Frequency MS-RDPELE Activity | High-frequency MS-RDPELE activity, indicating potential abuse, as in APT41. | - Network Traffic (DS0029)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rdpele" \| timechart span=1h count by src_ip, dest_ip \| where count > avg(count)*3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rdpele" \| summarize HourlyCount=count() by bin(Timestamp, 1h), RemoteIP, LocalIP \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rdpele" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip, destination.ip \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. MS-RDPELE Activity Outside Business Hours | MS-RDPELE activity outside business hours, as in APT29. | - Network Traffic (DS0029) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rdpele" AND (_time < "08:00" OR _time > "18:00") \| stats count by src_ip, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rdpele" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by RemoteIP, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rdpele" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY source.ip, destination.ip, host.name HAVING COUNT() > 5`. |
| 4. MS-RDPELE Activity Spawning Suspicious Processes | MS-RDPELE activity followed by suspicious process execution, as in Cobalt Strike. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rdpele" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rdpele" \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rdpele" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 5. MS-RDPELE Activity from Anomalous Locations | MS-RDPELE activity from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rdpele" AND src_geo NOT IN (trusted_locations) \| stats count by src_ip, src_geo, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rdpele" and GeoLocation !in (trustedLocations) \| summarize count() by RemoteIP, GeoLocation, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rdpele" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY source.ip, source.geo.location, destination.ip, host.name HAVING COUNT() > 5`. |
| 6. MS-RDPELE Activity in Cloud Environments | MS-RDPELE activity in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0029) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=network sourcetype=zeek_conn service="ms-rdpele" AND src_ip NOT IN (trusted_ips)] \| stats count by src_ip, dest_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceNetworkEvents \| where Protocol has "ms-rdpele" and RemoteIP !in (trustedIPs)) on DeviceName \| summarize count() by RemoteIP, LocalIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol : "ms-rdpele" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, destination.ip, event.action HAVING COUNT() > 5`. |
| 7. MS-RDPELE Activity with Suspicious User Agents | MS-RDPELE activity with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rdpele" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by src_ip, dest_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rdpele" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rdpele" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY source.ip, destination.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. MS-RDPELE Activity Followed by File Creation | MS-RDPELE activity leading to suspicious file creation, as in APT41. | - Network Traffic (DS0029)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rdpele" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by src_ip, dest_ip, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rdpele" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rdpele" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY source.ip, destination.ip, host.name, file.name HAVING COUNT() > 5`. |
| 9. MS-RDPELE Activity with Anomalous Protocols | MS-RDPELE activity using non-standard protocols, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rdpele" AND proto NOT IN ("tcp") \| stats count by src_ip, dest_ip, dest_host, proto \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rdpele" and Protocol !in ("tcp") \| summarize count() by RemoteIP, LocalIP, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rdpele" AND network.transport NOT IN ['tcp'] \| STATS COUNT() BY source.ip, destination.ip, host.name, network.transport HAVING COUNT() > 5`. |
| 10. MS-RDPELE Activity via Known Vulnerable Services | MS-RDPELE activity via known vulnerable services, as in FIN7. | - Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rdpele" AND dest_port IN (known_vuln_ports) \| stats count by src_ip, dest_ip, dest_port, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rdpele" and RemotePort in (knownVulnPorts) \| summarize count() by RemoteIP, LocalIP, RemotePort, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rdpele" AND destination.port IN ['known_vuln_ports'] \| STATS COUNT() BY source.ip, destination.ip, destination.port, host.name HAVING COUNT() > 5`. |


### T1210.013: MS-RPRN with Printer Nightmares

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious MS-RPRN Printer Nightmares Exploitation from Malicious IPs | Adversaries exploit MS-RPRN with Printer Nightmares (e.g., CVE-2021-34527) from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*spoolsv.exe", "*rundll32.exe") AND CommandLine IN ("*RpcAddPrinterDriver*", "*RpcAsync*")] \| stats count by src_ip, dest_ip, dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("spoolsv.exe", "rundll32.exe") and ProcessCommandLine has_any ("RpcAddPrinterDriver", "RpcAsync")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*spoolsv.exe" OR "*rundll32.exe") AND process.command_line : ("*RpcAddPrinterDriver*" OR "*RpcAsync*") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 2. High-Frequency MS-RPRN Printer Nightmares Activity | High-frequency MS-RPRN activity targeting Printer Nightmares vulnerabilities, as in APT41. | - Network Traffic (DS0029)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND CommandLine IN ("*RpcAddPrinterDriver*", "*RpcAsync*") \| timechart span=1h count by src_ip, dest_ip \| where count > avg(count)*3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and ProcessCommandLine has_any ("RpcAddPrinterDriver", "RpcAsync") \| summarize HourlyCount=count() by bin(Timestamp, 1h), RemoteIP, LocalIP \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND process.command_line : ("*RpcAddPrinterDriver*" OR "*RpcAsync*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip, destination.ip \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. MS-RPRN Printer Nightmares Activity Outside Business Hours | MS-RPRN Printer Nightmares activity outside business hours, as in APT29. | - Network Traffic (DS0029) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND (_time < "08:00" OR _time > "18:00") AND CommandLine IN ("*RpcAddPrinterDriver*", "*RpcAsync*") \| stats count by src_ip, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and ProcessCommandLine has_any ("RpcAddPrinterDriver", "RpcAsync") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by RemoteIP, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND process.command_line : ("*RpcAddPrinterDriver*" OR "*RpcAsync*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY source.ip, destination.ip, host.name HAVING COUNT() > 5`. |
| 4. MS-RPRN Printer Nightmares Activity Spawning Suspicious Processes | MS-RPRN Printer Nightmares activity followed by suspicious process execution, as in Cobalt Strike. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND CommandLine IN ("*RpcAddPrinterDriver*", "*RpcAsync*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and ProcessCommandLine has_any ("RpcAddPrinterDriver", "RpcAsync") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND process.command_line : ("*RpcAddPrinterDriver*" OR "*RpcAsync*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 5. MS-RPRN Printer Nightmares Activity from Anomalous Locations | MS-RPRN Printer Nightmares activity from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND src_geo NOT IN (trusted_locations) AND CommandLine IN ("*RpcAddPrinterDriver*", "*RpcAsync*") \| stats count by src_ip, src_geo, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and GeoLocation !in (trustedLocations) and ProcessCommandLine has_any ("RpcAddPrinterDriver", "RpcAsync") \| summarize count() by RemoteIP, GeoLocation, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND source.geo.location NOT IN ['trusted_locations'] AND process.command_line : ("*RpcAddPrinterDriver*" OR "*RpcAsync*") \| STATS COUNT() BY source.ip, source.geo.location, destination.ip, host.name HAVING COUNT() > 5`. |
| 6. MS-RPRN Printer Nightmares Activity in Cloud Environments | MS-RPRN Printer Nightmares activity in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0029) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=network sourcetype=zeek_conn service="ms-rprn" AND src_ip NOT IN (trusted_ips) AND CommandLine IN ("*RpcAddPrinterDriver*", "*RpcAsync*")] \| stats count by src_ip, dest_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceNetworkEvents \| where Protocol has "ms-rprn" and RemoteIP !in (trustedIPs) and ProcessCommandLine has_any ("RpcAddPrinterDriver", "RpcAsync")) on DeviceName \| summarize count() by RemoteIP, LocalIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol : "ms-rprn" AND source.ip NOT IN ['trusted_ips'] AND process.command_line : ("*RpcAddPrinterDriver*" OR "*RpcAsync*") \| STATS COUNT() BY source.ip, destination.ip, event.action HAVING COUNT() > 5`. |
| 7. MS-RPRN Printer Nightmares Activity with Suspicious User Agents | MS-RPRN Printer Nightmares activity with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND CommandLine IN ("*RpcAddPrinterDriver*", "*RpcAsync*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by src_ip, dest_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and ProcessCommandLine has_any ("RpcAddPrinterDriver", "RpcAsync") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND process.command_line : ("*RpcAddPrinterDriver*" OR "*RpcAsync*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY source.ip, destination.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. MS-RPRN Printer Nightmares Activity Followed by File Creation | MS-RPRN Printer Nightmares activity leading to suspicious file creation, as in APT41. | - Network Traffic (DS0029)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND CommandLine IN ("*RpcAddPrinterDriver*", "*RpcAsync*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by src_ip, dest_ip, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and ProcessCommandLine has_any ("RpcAddPrinterDriver", "RpcAsync") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND process.command_line : ("*RpcAddPrinterDriver*" OR "*RpcAsync*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY source.ip, destination.ip, host.name, file.name HAVING COUNT() > 5`. |
| 9. MS-RPRN Printer Nightmares Activity with Anomalous Protocols | MS-RPRN Printer Nightmares activity using non-standard protocols, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND proto NOT IN ("tcp") AND CommandLine IN ("*RpcAddPrinterDriver*", "*RpcAsync*") \| stats count by src_ip, dest_ip, dest_host, proto \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and Protocol !in ("tcp") and ProcessCommandLine has_any ("RpcAddPrinterDriver", "RpcAsync") \| summarize count() by RemoteIP, LocalIP, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND network.transport NOT IN ['tcp'] AND process.command_line : ("*RpcAddPrinterDriver*" OR "*RpcAsync*") \| STATS COUNT() BY source.ip, destination.ip, host.name, network.transport HAVING COUNT() > 5`. |
| 10. MS-RPRN Printer Nightmares Activity via Known Vulnerable Services | MS-RPRN Printer Nightmares activity via known vulnerable services, as in FIN7. | - Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND dest_port IN (known_vuln_ports) AND CommandLine IN ("*RpcAddPrinterDriver*", "*RpcAsync*") \| stats count by src_ip, dest_ip, dest_port, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and RemotePort in (knownVulnPorts) and ProcessCommandLine has_any ("RpcAddPrinterDriver", "RpcAsync") \| summarize count() by RemoteIP, LocalIP, RemotePort, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND destination.port IN ['known_vuln_ports'] AND process.command_line : ("*RpcAddPrinterDriver*" OR "*RpcAsync*") \| STATS COUNT() BY source.ip, destination.ip, destination.port, host.name HAVING COUNT() > 5`. |

### T1210.014: MS-RPRN with Printer Pool

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious MS-RPRN Printer Pool Exploitation from Malicious IPs | Adversaries exploit MS-RPRN Printer Pool for lateral movement from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*spoolsv.exe", "*rundll32.exe") AND CommandLine IN ("*AddPrinter*", "*SetPrinter*")] \| stats count by src_ip, dest_ip, dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("spoolsv.exe", "rundll32.exe") and ProcessCommandLine has_any ("AddPrinter", "SetPrinter")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*spoolsv.exe" OR "*rundll32.exe") AND process.command_line : ("*AddPrinter*" OR "*SetPrinter*") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 2. High-Frequency MS-RPRN Printer Pool Activity | High-frequency MS-RPRN Printer Pool activity, indicating potential abuse, as in APT41. | - Network Traffic (DS0029)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND CommandLine IN ("*AddPrinter*", "*SetPrinter*") \| timechart span=1h count by src_ip, dest_ip \| where count > avg(count)*3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and ProcessCommandLine has_any ("AddPrinter", "SetPrinter") \| summarize HourlyCount=count() by bin(Timestamp, 1h), RemoteIP, LocalIP \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND process.command_line : ("*AddPrinter*" OR "*SetPrinter*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip, destination.ip \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. MS-RPRN Printer Pool Activity Outside Business Hours | MS-RPRN Printer Pool activity outside business hours, as in APT29. | - Network Traffic (DS0029) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND (_time < "08:00" OR _time > "18:00") AND CommandLine IN ("*AddPrinter*", "*SetPrinter*") \| stats count by src_ip, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and ProcessCommandLine has_any ("AddPrinter", "SetPrinter") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by RemoteIP, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND process.command_line : ("*AddPrinter*" OR "*SetPrinter*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY source.ip, destination.ip, host.name HAVING COUNT() > 5`. |
| 4. MS-RPRN Printer Pool Activity Spawning Suspicious Processes | MS-RPRN Printer Pool activity followed by suspicious process execution, as in Cobalt Strike. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND CommandLine IN ("*AddPrinter*", "*SetPrinter*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and ProcessCommandLine has_any ("AddPrinter", "SetPrinter") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND process.command_line : ("*AddPrinter*" OR "*SetPrinter*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 5. MS-RPRN Printer Pool Activity from Anomalous Locations | MS-RPRN Printer Pool activity from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND src_geo NOT IN (trusted_locations) AND CommandLine IN ("*AddPrinter*", "*SetPrinter*") \| stats count by src_ip, src_geo, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and GeoLocation !in (trustedLocations) and ProcessCommandLine has_any ("AddPrinter", "SetPrinter") \| summarize count() by RemoteIP, GeoLocation, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND source.geo.location NOT IN ['trusted_locations'] AND process.command_line : ("*AddPrinter*" OR "*SetPrinter*") \| STATS COUNT() BY source.ip, source.geo.location, destination.ip, host.name HAVING COUNT() > 5`. |
| 6. MS-RPRN Printer Pool Activity in Cloud Environments | MS-RPRN Printer Pool activity in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0029) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=network sourcetype=zeek_conn service="ms-rprn" AND src_ip NOT IN (trusted_ips) AND CommandLine IN ("*AddPrinter*", "*SetPrinter*")] \| stats count by src_ip, dest_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceNetworkEvents \| where Protocol has "ms-rprn" and RemoteIP !in (trustedIPs) and ProcessCommandLine has_any ("AddPrinter", "SetPrinter")) on DeviceName \| summarize count() by RemoteIP, LocalIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol : "ms-rprn" AND source.ip NOT IN ['trusted_ips'] AND process.command_line : ("*AddPrinter*" OR "*SetPrinter*") \| STATS COUNT() BY source.ip, destination.ip, event.action HAVING COUNT() > 5`. |
| 7. MS-RPRN Printer Pool Activity with Suspicious User Agents | MS-RPRN Printer Pool activity with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND CommandLine IN ("*AddPrinter*", "*SetPrinter*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by src_ip, dest_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and ProcessCommandLine has_any ("AddPrinter", "SetPrinter") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND process.command_line : ("*AddPrinter*" OR "*SetPrinter*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY source.ip, destination.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. MS-RPRN Printer Pool Activity Followed by File Creation | MS-RPRN Printer Pool activity leading to suspicious file creation, as in APT41. | - Network Traffic (DS0029)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND CommandLine IN ("*AddPrinter*", "*SetPrinter*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by src_ip, dest_ip, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and ProcessCommandLine has_any ("AddPrinter", "SetPrinter") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND process.command_line : ("*AddPrinter*" OR "*SetPrinter*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY source.ip, destination.ip, host.name, file.name HAVING COUNT() > 5`. |
| 9. MS-RPRN Printer Pool Activity with Anomalous Protocols | MS-RPRN Printer Pool activity using non-standard protocols, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND proto NOT IN ("tcp") AND CommandLine IN ("*AddPrinter*", "*SetPrinter*") \| stats count by src_ip, dest_ip, dest_host, proto \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and Protocol !in ("tcp") and ProcessCommandLine has_any ("AddPrinter", "SetPrinter") \| summarize count() by RemoteIP, LocalIP, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND network.transport NOT IN ['tcp'] AND process.command_line : ("*AddPrinter*" OR "*SetPrinter*") \| STATS COUNT() BY source.ip, destination.ip, host.name, network.transport HAVING COUNT() > 5`. |
| 10. MS-RPRN Printer Pool Activity via Known Vulnerable Services | MS-RPRN Printer Pool activity via known vulnerable services, as in FIN7. | - Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND dest_port IN (known_vuln_ports) AND CommandLine IN ("*AddPrinter*", "*SetPrinter*") \| stats count by src_ip, dest_ip, dest_port, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and RemotePort in (knownVulnPorts) and ProcessCommandLine has_any ("AddPrinter", "SetPrinter") \| summarize count() by RemoteIP, LocalIP, RemotePort, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND destination.port IN ['known_vuln_ports'] AND process.command_line : ("*AddPrinter*" OR "*SetPrinter*") \| STATS COUNT() BY source.ip, destination.ip, destination.port, host.name HAVING COUNT() > 5`. |

### T1210.015: MS-RPRN with PrinterDriverHost

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious MS-RPRN PrinterDriverHost Exploitation from Malicious IPs | Adversaries exploit MS-RPRN PrinterDriverHost for lateral movement from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*spoolsv.exe", "*rundll32.exe") AND CommandLine IN ("*PrintDriverHost*")] \| stats count by src_ip, dest_ip, dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("spoolsv.exe", "rundll32.exe") and ProcessCommandLine has "PrintDriverHost") on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*spoolsv.exe" OR "*rundll32.exe") AND process.command_line : "*PrintDriverHost*" \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 2. High-Frequency MS-RPRN PrinterDriverHost Activity | High-frequency MS-RPRN PrinterDriverHost activity, indicating potential abuse, as in APT41. | - Network Traffic (DS0029)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND CommandLine IN ("*PrintDriverHost*") \| timechart span=1h count by src_ip, dest_ip \| where count > avg(count)*3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and ProcessCommandLine has "PrintDriverHost" \| summarize HourlyCount=count() by bin(Timestamp, 1h), RemoteIP, LocalIP \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND process.command_line : "*PrintDriverHost*" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip, destination.ip \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. MS-RPRN PrinterDriverHost Activity Outside Business Hours | MS-RPRN PrinterDriverHost activity outside business hours, as in APT29. | - Network Traffic (DS0029) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND (_time < "08:00" OR _time > "18:00") AND CommandLine IN ("*PrintDriverHost*") \| stats count by src_ip, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and ProcessCommandLine has "PrintDriverHost" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by RemoteIP, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND process.command_line : "*PrintDriverHost*" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY source.ip, destination.ip, host.name HAVING COUNT() > 5`. |
| 4. MS-RPRN PrinterDriverHost Activity Spawning Suspicious Processes | MS-RPRN PrinterDriverHost activity followed by suspicious process execution, as in Cobalt Strike. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND CommandLine IN ("*PrintDriverHost*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by src_ip, dest_ip, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and ProcessCommandLine has "PrintDriverHost" \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND process.command_line : "*PrintDriverHost*" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable HAVING COUNT() > 5`. |
| 5. MS-RPRN PrinterDriverHost Activity from Anomalous Locations | MS-RPRN PrinterDriverHost activity from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND src_geo NOT IN (trusted_locations) AND CommandLine IN ("*PrintDriverHost*") \| stats count by src_ip, src_geo, dest_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and GeoLocation !in (trustedLocations) and ProcessCommandLine has "PrintDriverHost" \| summarize count() by RemoteIP, GeoLocation, LocalIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND source.geo.location NOT IN ['trusted_locations'] AND process.command_line : "*PrintDriverHost*" \| STATS COUNT() BY source.ip, source.geo.location, destination.ip, host.name HAVING COUNT() > 5`. |
| 6. MS-RPRN PrinterDriverHost Activity in Cloud Environments | MS-RPRN PrinterDriverHost activity in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0029) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=network sourcetype=zeek_conn service="ms-rprn" AND src_ip NOT IN (trusted_ips) AND CommandLine IN ("*PrintDriverHost*")] \| stats count by src_ip, dest_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceNetworkEvents \| where Protocol has "ms-rprn" and RemoteIP !in (trustedIPs) and ProcessCommandLine has "PrintDriverHost") on DeviceName \| summarize count() by RemoteIP, LocalIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol : "ms-rprn" AND source.ip NOT IN ['trusted_ips'] AND process.command_line : "*PrintDriverHost*" \| STATS COUNT() BY source.ip, destination.ip, event.action HAVING COUNT() > 5`. |
| 7. MS-RPRN PrinterDriverHost Activity with Suspicious User Agents | MS-RPRN PrinterDriverHost activity with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND CommandLine IN ("*PrintDriverHost*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by src_ip, dest_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and ProcessCommandLine has "PrintDriverHost" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND process.command_line : "*PrintDriverHost*" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY source.ip, destination.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. MS-RPRN PrinterDriverHost Activity Followed by File Creation | MS-RPRN PrinterDriverHost activity leading to suspicious file creation, as in APT41. | - Network Traffic (DS0029)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND CommandLine IN ("*PrintDriverHost*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by src_ip, dest_ip, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and ProcessCommandLine has "PrintDriverHost" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND process.command_line : "*PrintDriverHost*" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY source.ip, destination.ip, host.name, file.name HAVING COUNT() > 5`. |
| 9. MS-RPRN PrinterDriverHost Activity with Anomalous Protocols | MS-RPRN PrinterDriverHost activity using non-standard protocols, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND proto NOT IN ("tcp") AND CommandLine IN ("*PrintDriverHost*") \| stats count by src_ip, dest_ip, dest_host, proto \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and Protocol !in ("tcp") and ProcessCommandLine has "PrintDriverHost" \| summarize count() by RemoteIP, LocalIP, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND network.transport NOT IN ['tcp'] AND process.command_line : "*PrintDriverHost*" \| STATS COUNT() BY source.ip, destination.ip, host.name, network.transport HAVING COUNT() > 5`. |
| 10. MS-RPRN PrinterDriverHost Activity via Known Vulnerable Services | MS-RPRN PrinterDriverHost activity via known vulnerable services, as in FIN7. | - Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn service="ms-rprn" AND dest_port IN (known_vuln_ports) AND CommandLine IN ("*PrintDriverHost*") \| stats count by src_ip, dest_ip, dest_port, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol has "ms-rprn" and RemotePort in (knownVulnPorts) and ProcessCommandLine has "PrintDriverHost" \| summarize count() by RemoteIP, LocalIP, RemotePort, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.protocol : "ms-rprn" AND destination.port IN ['known_vuln_ports'] AND process.command_line : "*PrintDriverHost*" \| STATS COUNT() BY source.ip, destination.ip, destination.port, host.name HAVING COUNT() > 5`. |

### T1218: System Binary Proxy Execution
### T1218.001: Compiled HTML File (CHM)

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious CHM File Execution from Malicious IPs | Adversaries execute malicious CHM files downloaded from known malicious IPs, as seen in APT41. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*hh.exe", "*cmd.exe") AND CommandLine IN ("*.chm*")] \| stats count by src_ip, dest_ip, dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("hh.exe", "cmd.exe") and ProcessCommandLine has ".chm") on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*hh.exe" OR "*cmd.exe") AND process.command_line : "*.chm*" \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 2. High-Frequency CHM File Execution | High-frequency execution of CHM files, indicating potential abuse, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*hh.exe") AND CommandLine IN ("*.chm*") \| timechart span=1h count by dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "hh.exe" and ProcessCommandLine has ".chm" \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*hh.exe" AND process.command_line : "*.chm*" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. CHM File Execution Outside Business Hours | CHM file execution outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*hh.exe") AND CommandLine IN ("*.chm*") AND (_time < "08:00" OR _time > "18:00") \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "hh.exe" and ProcessCommandLine has ".chm" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*hh.exe" AND process.command_line : "*.chm*" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 4. CHM File Execution Spawning Suspicious Processes | CHM file execution followed by suspicious process execution, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*hh.exe") AND CommandLine IN ("*.chm*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "hh.exe" and ProcessCommandLine has ".chm" \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*hh.exe" AND process.command_line : "*.chm*" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 5. CHM File Execution from Anomalous Locations | CHM file execution from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn src_geo NOT IN (trusted_locations) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*hh.exe") AND CommandLine IN ("*.chm*")] \| stats count by src_ip, src_geo, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where GeoLocation !in (trustedLocations) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "hh.exe" and ProcessCommandLine has ".chm") on DeviceName \| summarize count() by RemoteIP, GeoLocation, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.geo.location NOT IN ['trusted_locations'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*hh.exe" AND process.command_line : "*.chm*" \| STATS COUNT() BY source.ip, source.geo.location, host.name, process.executable HAVING COUNT() > 5`. |
| 6. CHM File Execution in Cloud Environments | CHM file execution in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*hh.exe") AND CommandLine IN ("*.chm*")] \| stats count by src_ip, dest_host, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceProcessEvents \| where ProcessName has "hh.exe" and ProcessCommandLine has ".chm") on DeviceName \| summarize count() by RemoteIP, DeviceName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*hh.exe" AND process.command_line : "*.chm*" \| STATS COUNT() BY source.ip, host.name, event.action HAVING COUNT() > 5`. |
| 7. CHM File Execution with Suspicious User Agents | CHM file execution with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*hh.exe") AND CommandLine IN ("*.chm*")] \| stats count by src_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| join kind=inner (DeviceProcessEvents \| where ProcessName has "hh.exe" and ProcessCommandLine has ".chm") on DeviceName \| summarize count() by RemoteIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*hh.exe" AND process.command_line : "*.chm*" \| STATS COUNT() BY source.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. CHM File Execution Followed by File Creation | CHM file execution leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*hh.exe") AND CommandLine IN ("*.chm*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by dest_host, FileName, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "hh.exe" and ProcessCommandLine has ".chm" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by DeviceName, FileName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*hh.exe" AND process.command_line : "*.chm*" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY host.name, file.name, process.executable HAVING COUNT() > 5`. |
| 9. CHM File Execution with Anomalous Parent Processes | CHM file execution spawned by unusual parent processes, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*hh.exe") AND CommandLine IN ("*.chm*") AND ParentImage NOT IN ("*explorer.exe", "*cmd.exe") \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "hh.exe" and ProcessCommandLine has ".chm" and ParentProcessName !has_any ("explorer.exe", "cmd.exe") \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*hh.exe" AND process.command_line : "*.chm*" AND process.parent.executable NOT IN ["*explorer.exe", "*cmd.exe"] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |
| 10. CHM File Execution via Known Vulnerable Applications | CHM file execution via known vulnerable applications, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*hh.exe") AND CommandLine IN ("*.chm*") AND ParentImage IN (known_vuln_apps) \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "hh.exe" and ProcessCommandLine has ".chm" and ParentProcessName in (knownVulnApps) \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*hh.exe" AND process.command_line : "*.chm*" AND process.parent.executable IN ['known_vuln_apps'] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |

### T1218.002: Control Panel

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Control Panel Execution from Malicious IPs | Adversaries execute malicious Control Panel items (.cpl) from known malicious IPs, as in APT41. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*control.exe", "*rundll32.exe") AND CommandLine IN ("*.cpl*")] \| stats count by src_ip, dest_ip, dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("control.exe", "rundll32.exe") and ProcessCommandLine has ".cpl") on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*control.exe" OR "*rundll32.exe") AND process.command_line : "*.cpl*" \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 2. High-Frequency Control Panel Execution | High-frequency execution of Control Panel items, indicating potential abuse, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*control.exe", "*rundll32.exe") AND CommandLine IN ("*.cpl*") \| timechart span=1h count by dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("control.exe", "rundll32.exe") and ProcessCommandLine has ".cpl" \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*control.exe" OR "*rundll32.exe") AND process.command_line : "*.cpl*" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Control Panel Execution Outside Business Hours | Control Panel execution outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*control.exe", "*rundll32.exe") AND CommandLine IN ("*.cpl*") AND (_time < "08:00" OR _time > "18:00") \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("control.exe", "rundll32.exe") and ProcessCommandLine has ".cpl" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*control.exe" OR "*rundll32.exe") AND process.command_line : "*.cpl*" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 4. Control Panel Execution Spawning Suspicious Processes | Control Panel execution followed by suspicious process execution, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*control.exe", "*rundll32.exe") AND CommandLine IN ("*.cpl*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("control.exe", "rundll32.exe") and ProcessCommandLine has ".cpl" \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*control.exe" OR "*rundll32.exe") AND process.command_line : "*.cpl*" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 5. Control Panel Execution from Anomalous Locations | Control Panel execution from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn src_geo NOT IN (trusted_locations) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*control.exe", "*rundll32.exe") AND CommandLine IN ("*.cpl*")] \| stats count by src_ip, src_geo, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where GeoLocation !in (trustedLocations) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("control.exe", "rundll32.exe") and ProcessCommandLine has ".cpl") on DeviceName \| summarize count() by RemoteIP, GeoLocation, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.geo.location NOT IN ['trusted_locations'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*control.exe" OR "*rundll32.exe") AND process.command_line : "*.cpl*" \| STATS COUNT() BY source.ip, source.geo.location, host.name, process.executable HAVING COUNT() > 5`. |
| 6. Control Panel Execution in Cloud Environments | Control Panel execution in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*control.exe", "*rundll32.exe") AND CommandLine IN ("*.cpl*")] \| stats count by src_ip, dest_host, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("control.exe", "rundll32.exe") and ProcessCommandLine has ".cpl") on DeviceName \| summarize count() by RemoteIP, DeviceName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*control.exe" OR "*rundll32.exe") AND process.command_line : "*.cpl*" \| STATS COUNT() BY source.ip, host.name, event.action HAVING COUNT() > 5`. |
| 7. Control Panel Execution with Suspicious User Agents | Control Panel execution with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*control.exe", "*rundll32.exe") AND CommandLine IN ("*.cpl*")] \| stats count by src_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("control.exe", "rundll32.exe") and ProcessCommandLine has ".cpl") on DeviceName \| summarize count() by RemoteIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*control.exe" OR "*rundll32.exe") AND process.command_line : "*.cpl*" \| STATS COUNT() BY source.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Control Panel Execution Followed by File Creation | Control Panel execution leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*control.exe", "*rundll32.exe") AND CommandLine IN ("*.cpl*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by dest_host, FileName, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("control.exe", "rundll32.exe") and ProcessCommandLine has ".cpl" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by DeviceName, FileName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*control.exe" OR "*rundll32.exe") AND process.command_line : "*.cpl*" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY host.name, file.name, process.executable HAVING COUNT() > 5`. |
| 9. Control Panel Execution with Anomalous Parent Processes | Control Panel execution spawned by unusual parent processes, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*control.exe", "*rundll32.exe") AND CommandLine IN ("*.cpl*") AND ParentImage NOT IN ("*explorer.exe", "*cmd.exe") \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("control.exe", "rundll32.exe") and ProcessCommandLine has ".cpl" and ParentProcessName !has_any ("explorer.exe", "cmd.exe") \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*control.exe" OR "*rundll32.exe") AND process.command_line : "*.cpl*" AND process.parent.executable NOT IN ["*explorer.exe", "*cmd.exe"] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |
| 10. Control Panel Execution via Known Vulnerable Applications | Control Panel execution via known vulnerable applications, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*control.exe", "*rundll32.exe") AND CommandLine IN ("*.cpl*") AND ParentImage IN (known_vuln_apps) \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("control.exe", "rundll32.exe") and ProcessCommandLine has ".cpl" and ParentProcessName in (knownVulnApps) \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*control.exe" OR "*rundll32.exe") AND process.command_line : "*.cpl*" AND process.parent.executable IN ['known_vuln_apps'] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |

### T1218.003: CMSTP

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious CMSTP Execution from Malicious IPs | Adversaries execute CMSTP from known malicious IPs, as in APT41. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmstp.exe") AND CommandLine IN ("*.inf*")] \| stats count by src_ip, dest_ip, dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "cmstp.exe" and ProcessCommandLine has ".inf") on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*cmstp.exe" AND process.command_line : "*.inf*" \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 2. High-Frequency CMSTP Execution | High-frequency execution of CMSTP, indicating potential abuse, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmstp.exe") AND CommandLine IN ("*.inf*") \| timechart span=1h count by dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "cmstp.exe" and ProcessCommandLine has ".inf" \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmstp.exe" AND process.command_line : "*.inf*" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. CMSTP Execution Outside Business Hours | CMSTP execution outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmstp.exe") AND CommandLine IN ("*.inf*") AND (_time < "08:00" OR _time > "18:00") \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "cmstp.exe" and ProcessCommandLine has ".inf" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmstp.exe" AND process.command_line : "*.inf*" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 4. CMSTP Execution Spawning Suspicious Processes | CMSTP execution followed by suspicious process execution, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmstp.exe") AND CommandLine IN ("*.inf*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "cmstp.exe" and ProcessCommandLine has ".inf" \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmstp.exe" AND process.command_line : "*.inf*" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 5. CMSTP Execution from Anomalous Locations | CMSTP execution from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn src_geo NOT IN (trusted_locations) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmstp.exe") AND CommandLine IN ("*.inf*")] \| stats count by src_ip, src_geo, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where GeoLocation !in (trustedLocations) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "cmstp.exe" and ProcessCommandLine has ".inf") on DeviceName \| summarize count() by RemoteIP, GeoLocation, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.geo.location NOT IN ['trusted_locations'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*cmstp.exe" AND process.command_line : "*.inf*" \| STATS COUNT() BY source.ip, source.geo.location, host.name, process.executable HAVING COUNT() > 5`. |
| 6. CMSTP Execution in Cloud Environments | CMSTP execution in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmstp.exe") AND CommandLine IN ("*.inf*")] \| stats count by src_ip, dest_host, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceProcessEvents \| where ProcessName has "cmstp.exe" and ProcessCommandLine has ".inf") on DeviceName \| summarize count() by RemoteIP, DeviceName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*cmstp.exe" AND process.command_line : "*.inf*" \| STATS COUNT() BY source.ip, host.name, event.action HAVING COUNT() > 5`. |
| 7. CMSTP Execution with Suspicious User Agents | CMSTP execution with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmstp.exe") AND CommandLine IN ("*.inf*")] \| stats count by src_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| join kind=inner (DeviceProcessEvents \| where ProcessName has "cmstp.exe" and ProcessCommandLine has ".inf") on DeviceName \| summarize count() by RemoteIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*cmstp.exe" AND process.command_line : "*.inf*" \| STATS COUNT() BY source.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. CMSTP Execution Followed by File Creation | CMSTP execution leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmstp.exe") AND CommandLine IN ("*.inf*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by dest_host, FileName, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "cmstp.exe" and ProcessCommandLine has ".inf" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by DeviceName, FileName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmstp.exe" AND process.command_line : "*.inf*" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY host.name, file.name, process.executable HAVING COUNT() > 5`. |
| 9. CMSTP Execution with Anomalous Parent Processes | CMSTP execution spawned by unusual parent processes, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmstp.exe") AND CommandLine IN ("*.inf*") AND ParentImage NOT IN ("*explorer.exe", "*cmd.exe") \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "cmstp.exe" and ProcessCommandLine has ".inf" and ParentProcessName !has_any ("explorer.exe", "cmd.exe") \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmstp.exe" AND process.command_line : "*.inf*" AND process.parent.executable NOT IN ["*explorer.exe", "*cmd.exe"] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |
| 10. CMSTP Execution via Known Vulnerable Applications | CMSTP execution via known vulnerable applications, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmstp.exe") AND CommandLine IN ("*.inf*") AND ParentImage IN (known_vuln_apps) \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "cmstp.exe" and ProcessCommandLine has ".inf" and ParentProcessName in (knownVulnApps) \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmstp.exe" AND process.command_line : "*.inf*" AND process.parent.executable IN ['known_vuln_apps'] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |

### T1218.004: InstallUtil

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious InstallUtil Execution from Malicious IPs | Adversaries execute InstallUtil from known malicious IPs, as in APT41. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*InstallUtil.exe") AND CommandLine IN ("*/i*")] \| stats count by src_ip, dest_ip, dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "InstallUtil.exe" and ProcessCommandLine has "/i") on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*InstallUtil.exe" AND process.command_line : "*/i*" \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 2. High-Frequency InstallUtil Execution | High-frequency execution of InstallUtil, indicating potential abuse, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*InstallUtil.exe") AND CommandLine IN ("*/i*") \| timechart span=1h count by dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "InstallUtil.exe" and ProcessCommandLine has "/i" \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*InstallUtil.exe" AND process.command_line : "*/i*" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. InstallUtil Execution Outside Business Hours | InstallUtil execution outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*InstallUtil.exe") AND CommandLine IN ("*/i*") AND (_time < "08:00" OR _time > "18:00") \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "InstallUtil.exe" and ProcessCommandLine has "/i" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*InstallUtil.exe" AND process.command_line : "*/i*" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 4. InstallUtil Execution Spawning Suspicious Processes | InstallUtil execution followed by suspicious process execution, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*InstallUtil.exe") AND CommandLine IN ("*/i*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "InstallUtil.exe" and ProcessCommandLine has "/i" \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*InstallUtil.exe" AND process.command_line : "*/i*" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 5. InstallUtil Execution from Anomalous Locations | InstallUtil execution from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn src_geo NOT IN (trusted_locations) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*InstallUtil.exe") AND CommandLine IN ("*/i*")] \| stats count by src_ip, src_geo, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where GeoLocation !in (trustedLocations) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "InstallUtil.exe" and ProcessCommandLine has "/i") on DeviceName \| summarize count() by RemoteIP, GeoLocation, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.geo.location NOT IN ['trusted_locations'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*InstallUtil.exe" AND process.command_line : "*/i*" \| STATS COUNT() BY source.ip, source.geo.location, host.name, process.executable HAVING COUNT() > 5`. |
| 6. InstallUtil Execution in Cloud Environments | InstallUtil execution in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*InstallUtil.exe") AND CommandLine IN ("*/i*")] \| stats count by src_ip, dest_host, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceProcessEvents \| where ProcessName has "InstallUtil.exe" and ProcessCommandLine has "/i") on DeviceName \| summarize count() by RemoteIP, DeviceName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*InstallUtil.exe" AND process.command_line : "*/i*" \| STATS COUNT() BY source.ip, host.name, event.action HAVING COUNT() > 5`. |
| 7. InstallUtil Execution with Suspicious User Agents | InstallUtil execution with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*InstallUtil.exe") AND CommandLine IN ("*/i*")] \| stats count by src_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| join kind=inner (DeviceProcessEvents \| where ProcessName has "InstallUtil.exe" and ProcessCommandLine has "/i") on DeviceName \| summarize count() by RemoteIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*InstallUtil.exe" AND process.command_line : "*/i*" \| STATS COUNT() BY source.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. InstallUtil Execution Followed by File Creation | InstallUtil execution leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*InstallUtil.exe") AND CommandLine IN ("*/i*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by dest_host, FileName, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "InstallUtil.exe" and ProcessCommandLine has "/i" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by DeviceName, FileName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*InstallUtil.exe" AND process.command_line : "*/i*" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY host.name, file.name, process.executable HAVING COUNT() > 5`. |
| 9. InstallUtil Execution with Anomalous Parent Processes | InstallUtil execution spawned by unusual parent processes, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*InstallUtil.exe") AND CommandLine IN ("*/i*") AND ParentImage NOT IN ("*explorer.exe", "*cmd.exe") \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "InstallUtil.exe" and ProcessCommandLine has "/i" and ParentProcessName !has_any ("explorer.exe", "cmd.exe") \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*InstallUtil.exe" AND process.command_line : "*/i*" AND process.parent.executable NOT IN ["*explorer.exe", "*cmd.exe"] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |
| 10. InstallUtil Execution via Known Vulnerable Applications | InstallUtil execution via known vulnerable applications, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*InstallUtil.exe") AND CommandLine IN ("*/i*") AND ParentImage IN (known_vuln_apps) \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "InstallUtil.exe" and ProcessCommandLine has "/i" and ParentProcessName in (knownVulnApps) \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*InstallUtil.exe" AND process.command_line : "*/i*" AND process.parent.executable IN ['known_vuln_apps'] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |


### T1218.005: MSBuild

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious MSBuild Execution from Malicious IPs | Adversaries execute MSBuild from known malicious IPs, as in APT41. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*MSBuild.exe") AND CommandLine IN ("*.proj*","*.csproj*","*.vbproj*")] \| stats count by src_ip, dest_ip, dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "MSBuild.exe" and ProcessCommandLine has_any (".proj",".csproj",".vbproj")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*MSBuild.exe" AND process.command_line : ("*.proj*" OR "*.csproj*" OR "*.vbproj*") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 2. High-Frequency MSBuild Execution | High-frequency execution of MSBuild, indicating potential abuse, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*MSBuild.exe") AND CommandLine IN ("*.proj*","*.csproj*","*.vbproj*") \| timechart span=1h count by dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "MSBuild.exe" and ProcessCommandLine has_any (".proj",".csproj",".vbproj") \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*MSBuild.exe" AND process.command_line : ("*.proj*" OR "*.csproj*" OR "*.vbproj*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. MSBuild Execution Outside Business Hours | MSBuild execution outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*MSBuild.exe") AND CommandLine IN ("*.proj*","*.csproj*","*.vbproj*") AND (_time < "08:00" OR _time > "18:00") \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "MSBuild.exe" and ProcessCommandLine has_any (".proj",".csproj",".vbproj") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*MSBuild.exe" AND process.command_line : ("*.proj*" OR "*.csproj*" OR "*.vbproj*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 4. MSBuild Execution Spawning Suspicious Processes | MSBuild execution followed by suspicious process execution, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*MSBuild.exe") AND CommandLine IN ("*.proj*","*.csproj*","*.vbproj*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "MSBuild.exe" and ProcessCommandLine has_any (".proj",".csproj",".vbproj") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*MSBuild.exe" AND process.command_line : ("*.proj*" OR "*.csproj*" OR "*.vbproj*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 5. MSBuild Execution from Anomalous Locations | MSBuild execution from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn src_geo NOT IN (trusted_locations) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*MSBuild.exe") AND CommandLine IN ("*.proj*","*.csproj*","*.vbproj*")] \| stats count by src_ip, src_geo, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where GeoLocation !in (trustedLocations) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "MSBuild.exe" and ProcessCommandLine has_any (".proj",".csproj",".vbproj")) on DeviceName \| summarize count() by RemoteIP, GeoLocation, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.geo.location NOT IN ['trusted_locations'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*MSBuild.exe" AND process.command_line : ("*.proj*" OR "*.csproj*" OR "*.vbproj*") \| STATS COUNT() BY source.ip, source.geo.location, host.name, process.executable HAVING COUNT() > 5`. |
| 6. MSBuild Execution in Cloud Environments | MSBuild execution in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*MSBuild.exe") AND CommandLine IN ("*.proj*","*.csproj*","*.vbproj*")] \| stats count by src_ip, dest_host, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceProcessEvents \| where ProcessName has "MSBuild.exe" and ProcessCommandLine has_any (".proj",".csproj",".vbproj")) on DeviceName \| summarize count() by RemoteIP, DeviceName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*MSBuild.exe" AND process.command_line : ("*.proj*" OR "*.csproj*" OR "*.vbproj*") \| STATS COUNT() BY source.ip, host.name, event.action HAVING COUNT() > 5`. |
| 7. MSBuild Execution with Suspicious User Agents | MSBuild execution with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*MSBuild.exe") AND CommandLine IN ("*.proj*","*.csproj*","*.vbproj*")] \| stats count by src_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| join kind=inner (DeviceProcessEvents \| where ProcessName has "MSBuild.exe" and ProcessCommandLine has_any (".proj",".csproj",".vbproj")) on DeviceName \| summarize count() by RemoteIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*MSBuild.exe" AND process.command_line : ("*.proj*" OR "*.csproj*" OR "*.vbproj*") \| STATS COUNT() BY source.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. MSBuild Execution Followed by File Creation | MSBuild execution leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*MSBuild.exe") AND CommandLine IN ("*.proj*","*.csproj*","*.vbproj*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by dest_host, FileName, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "MSBuild.exe" and ProcessCommandLine has_any (".proj",".csproj",".vbproj") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by DeviceName, FileName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*MSBuild.exe" AND process.command_line : ("*.proj*" OR "*.csproj*" OR "*.vbproj*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY host.name, file.name, process.executable HAVING COUNT() > 5`. |
| 9. MSBuild Execution with Anomalous Parent Processes | MSBuild execution spawned by unusual parent processes, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*MSBuild.exe") AND CommandLine IN ("*.proj*","*.csproj*","*.vbproj*") AND ParentImage NOT IN ("*explorer.exe", "*cmd.exe", "*devenv.exe") \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "MSBuild.exe" and ProcessCommandLine has_any (".proj",".csproj",".vbproj") and ParentProcessName !has_any ("explorer.exe", "cmd.exe", "devenv.exe") \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*MSBuild.exe" AND process.command_line : ("*.proj*" OR "*.csproj*" OR "*.vbproj*") AND process.parent.executable NOT IN ["*explorer.exe", "*cmd.exe", "*devenv.exe"] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |
| 10. MSBuild Execution via Known Vulnerable Applications | MSBuild execution via known vulnerable applications, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*MSBuild.exe") AND CommandLine IN ("*.proj*","*.csproj*","*.vbproj*") AND ParentImage IN (known_vuln_apps) \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "MSBuild.exe" and ProcessCommandLine has_any (".proj",".csproj",".vbproj") and ParentProcessName in (knownVulnApps) \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*MSBuild.exe" AND process.command_line : ("*.proj*" OR "*.csproj*" OR "*.vbproj*") AND process.parent.executable IN ['known_vuln_apps'] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |

### T1218.007: Mshta

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Mshta Execution from Malicious IPs | Adversaries execute Mshta from known malicious IPs, as in APT41. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mshta.exe") AND CommandLine IN ("*.hta*","*vbscript*","*javascript*")] \| stats count by src_ip, dest_ip, dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "mshta.exe" and ProcessCommandLine has_any (".hta","vbscript","javascript")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*mshta.exe" AND process.command_line : ("*.hta*" OR "*vbscript*" OR "*javascript*") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 2. High-Frequency Mshta Execution | High-frequency execution of Mshta, indicating potential abuse, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mshta.exe") AND CommandLine IN ("*.hta*","*vbscript*","*javascript*") \| timechart span=1h count by dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "mshta.exe" and ProcessCommandLine has_any (".hta","vbscript","javascript") \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*mshta.exe" AND process.command_line : ("*.hta*" OR "*vbscript*" OR "*javascript*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Mshta Execution Outside Business Hours | Mshta execution outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mshta.exe") AND CommandLine IN ("*.hta*","*vbscript*","*javascript*") AND (_time < "08:00" OR _time > "18:00") \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "mshta.exe" and ProcessCommandLine has_any (".hta","vbscript","javascript") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*mshta.exe" AND process.command_line : ("*.hta*" OR "*vbscript*" OR "*javascript*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 4. Mshta Execution Spawning Suspicious Processes | Mshta execution followed by suspicious process execution, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mshta.exe") AND CommandLine IN ("*.hta*","*vbscript*","*javascript*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "mshta.exe" and ProcessCommandLine has_any (".hta","vbscript","javascript") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*mshta.exe" AND process.command_line : ("*.hta*" OR "*vbscript*" OR "*javascript*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 5. Mshta Execution from Anomalous Locations | Mshta execution from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn src_geo NOT IN (trusted_locations) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mshta.exe") AND CommandLine IN ("*.hta*","*vbscript*","*javascript*")] \| stats count by src_ip, src_geo, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where GeoLocation !in (trustedLocations) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "mshta.exe" and ProcessCommandLine has_any (".hta","vbscript","javascript")) on DeviceName \| summarize count() by RemoteIP, GeoLocation, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.geo.location NOT IN ['trusted_locations'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*mshta.exe" AND process.command_line : ("*.hta*" OR "*vbscript*" OR "*javascript*") \| STATS COUNT() BY source.ip, source.geo.location, host.name, process.executable HAVING COUNT() > 5`. |
| 6. Mshta Execution in Cloud Environments | Mshta execution in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mshta.exe") AND CommandLine IN ("*.hta*","*vbscript*","*javascript*")] \| stats count by src_ip, dest_host, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceProcessEvents \| where ProcessName has "mshta.exe" and ProcessCommandLine has_any (".hta","vbscript","javascript")) on DeviceName \| summarize count() by RemoteIP, DeviceName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*mshta.exe" AND process.command_line : ("*.hta*" OR "*vbscript*" OR "*javascript*") \| STATS COUNT() BY source.ip, host.name, event.action HAVING COUNT() > 5`. |
| 7. Mshta Execution with Suspicious User Agents | Mshta execution with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mshta.exe") AND CommandLine IN ("*.hta*","*vbscript*","*javascript*")] \| stats count by src_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| join kind=inner (DeviceProcessEvents \| where ProcessName has "mshta.exe" and ProcessCommandLine has_any (".hta","vbscript","javascript")) on DeviceName \| summarize count() by RemoteIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*mshta.exe" AND process.command_line : ("*.hta*" OR "*vbscript*" OR "*javascript*") \| STATS COUNT() BY source.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Mshta Execution Followed by File Creation | Mshta execution leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mshta.exe") AND CommandLine IN ("*.hta*","*vbscript*","*javascript*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by dest_host, FileName, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "mshta.exe" and ProcessCommandLine has_any (".hta","vbscript","javascript") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by DeviceName, FileName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*mshta.exe" AND process.command_line : ("*.hta*" OR "*vbscript*" OR "*javascript*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY host.name, file.name, process.executable HAVING COUNT() > 5`. |
| 9. Mshta Execution with Anomalous Parent Processes | Mshta execution spawned by unusual parent processes, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mshta.exe") AND CommandLine IN ("*.hta*","*vbscript*","*javascript*") AND ParentImage NOT IN ("*explorer.exe", "*cmd.exe") \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "mshta.exe" and ProcessCommandLine has_any (".hta","vbscript","javascript") and ParentProcessName !has_any ("explorer.exe", "cmd.exe") \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*mshta.exe" AND process.command_line : ("*.hta*" OR "*vbscript*" OR "*javascript*") AND process.parent.executable NOT IN ["*explorer.exe", "*cmd.exe"] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |
| 10. Mshta Execution via Known Vulnerable Applications | Mshta execution via known vulnerable applications, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mshta.exe") AND CommandLine IN ("*.hta*","*vbscript*","*javascript*") AND ParentImage IN (known_vuln_apps) \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "mshta.exe" and ProcessCommandLine has_any (".hta","vbscript","javascript") and ParentProcessName in (knownVulnApps) \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*mshta.exe" AND process.command_line : ("*.hta*" OR "*vbscript*" OR "*javascript*") AND process.parent.executable IN ['known_vuln_apps'] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |

### T1218.008: Odbcconf

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Odbcconf Execution from Malicious IPs | Adversaries execute Odbcconf from known malicious IPs, as in APT41. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*odbcconf.exe") AND CommandLine IN ("*/f*","*.rsp*","*REGSVR*")] \| stats count by src_ip, dest_ip, dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "odbcconf.exe" and ProcessCommandLine has_any ("/f",".rsp","REGSVR")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*odbcconf.exe" AND process.command_line : ("*/f*" OR "*.rsp*" OR "*REGSVR*") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 2. High-Frequency Odbcconf Execution | High-frequency execution of Odbcconf, indicating potential abuse, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*odbcconf.exe") AND CommandLine IN ("*/f*","*.rsp*","*REGSVR*") \| timechart span=1h count by dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "odbcconf.exe" and ProcessCommandLine has_any ("/f",".rsp","REGSVR") \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*odbcconf.exe" AND process.command_line : ("*/f*" OR "*.rsp*" OR "*REGSVR*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Odbcconf Execution Outside Business Hours | Odbcconf execution outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*odbcconf.exe") AND CommandLine IN ("*/f*","*.rsp*","*REGSVR*") AND (_time < "08:00" OR _time > "18:00") \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "odbcconf.exe" and ProcessCommandLine has_any ("/f",".rsp","REGSVR") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*odbcconf.exe" AND process.command_line : ("*/f*" OR "*.rsp*" OR "*REGSVR*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 4. Odbcconf Execution Spawning Suspicious Processes | Odbcconf execution followed by suspicious process execution, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*odbcconf.exe") AND CommandLine IN ("*/f*","*.rsp*","*REGSVR*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "odbcconf.exe" and ProcessCommandLine has_any ("/f",".rsp","REGSVR") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*odbcconf.exe" AND process.command_line : ("*/f*" OR "*.rsp*" OR "*REGSVR*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 5. Odbcconf Execution from Anomalous Locations | Odbcconf execution from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn src_geo NOT IN (trusted_locations) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*odbcconf.exe") AND CommandLine IN ("*/f*","*.rsp*","*REGSVR*")] \| stats count by src_ip, src_geo, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where GeoLocation !in (trustedLocations) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "odbcconf.exe" and ProcessCommandLine has_any ("/f",".rsp","REGSVR")) on DeviceName \| summarize count() by RemoteIP, GeoLocation, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.geo.location NOT IN ['trusted_locations'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*odbcconf.exe" AND process.command_line : ("*/f*" OR "*.rsp*" OR "*REGSVR*") \| STATS COUNT() BY source.ip, source.geo.location, host.name, process.executable HAVING COUNT() > 5`. |
| 6. Odbcconf Execution in Cloud Environments | Odbcconf execution in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*odbcconf.exe") AND CommandLine IN ("*/f*","*.rsp*","*REGSVR*")] \| stats count by src_ip, dest_host, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceProcessEvents \| where ProcessName has "odbcconf.exe" and ProcessCommandLine has_any ("/f",".rsp","REGSVR")) on DeviceName \| summarize count() by RemoteIP, DeviceName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*odbcconf.exe" AND process.command_line : ("*/f*" OR "*.rsp*" OR "*REGSVR*") \| STATS COUNT() BY source.ip, host.name, event.action HAVING COUNT() > 5`. |
| 7. Odbcconf Execution with Suspicious User Agents | Odbcconf execution with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*odbcconf.exe") AND CommandLine IN ("*/f*","*.rsp*","*REGSVR*")] \| stats count by src_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| join kind=inner (DeviceProcessEvents \| where ProcessName has "odbcconf.exe" and ProcessCommandLine has_any ("/f",".rsp","REGSVR")) on DeviceName \| summarize count() by RemoteIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*odbcconf.exe" AND process.command_line : ("*/f*" OR "*.rsp*" OR "*REGSVR*") \| STATS COUNT() BY source.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Odbcconf Execution Followed by File Creation | Odbcconf execution leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*odbcconf.exe") AND CommandLine IN ("*/f*","*.rsp*","*REGSVR*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by dest_host, FileName, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "odbcconf.exe" and ProcessCommandLine has_any ("/f",".rsp","REGSVR") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by DeviceName, FileName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*odbcconf.exe" AND process.command_line : ("*/f*" OR "*.rsp*" OR "*REGSVR*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY host.name, file.name, process.executable HAVING COUNT() > 5`. |
| 9. Odbcconf Execution with Anomalous Parent Processes | Odbcconf execution spawned by unusual parent processes, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*odbcconf.exe") AND CommandLine IN ("*/f*","*.rsp*","*REGSVR*") AND ParentImage NOT IN ("*explorer.exe", "*cmd.exe") \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "odbcconf.exe" and ProcessCommandLine has_any ("/f",".rsp","REGSVR") and ParentProcessName !has_any ("explorer.exe", "cmd.exe") \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*odbcconf.exe" AND process.command_line : ("*/f*" OR "*.rsp*" OR "*REGSVR*") AND process.parent.executable NOT IN ["*explorer.exe", "*cmd.exe"] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |
| 10. Odbcconf Execution via Known Vulnerable Applications | Odbcconf execution via known vulnerable applications, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*odbcconf.exe") AND CommandLine IN ("*/f*","*.rsp*","*REGSVR*") AND ParentImage IN (known_vuln_apps) \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "odbcconf.exe" and ProcessCommandLine has_any ("/f",".rsp","REGSVR") and ParentProcessName in (knownVulnApps) \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*odbcconf.exe" AND process.command_line : ("*/f*" OR "*.rsp*" OR "*REGSVR*") AND process.parent.executable IN ['known_vuln_apps'] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |

### T1218.009: Regsvcs/Regasm

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Regsvcs/Regasm Execution from Malicious IPs | Adversaries execute Regsvcs or Regasm from known malicious IPs, as in APT41. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*regsvcs.exe","*regasm.exe") AND CommandLine IN ("*.dll*")] \| stats count by src_ip, dest_ip, dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("regsvcs.exe","regasm.exe") and ProcessCommandLine has ".dll") on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*regsvcs.exe" OR "*regasm.exe") AND process.command_line : "*.dll*" \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 2. High-Frequency Regsvcs/Regasm Execution | High-frequency execution of Regsvcs or Regasm, indicating potential abuse, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*regsvcs.exe","*regasm.exe") AND CommandLine IN ("*.dll*") \| timechart span=1h count by dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("regsvcs.exe","regasm.exe") and ProcessCommandLine has ".dll" \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*regsvcs.exe" OR "*regasm.exe") AND process.command_line : "*.dll*" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Regsvcs/Regasm Execution Outside Business Hours | Regsvcs or Regasm execution outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*regsvcs.exe","*regasm.exe") AND CommandLine IN ("*.dll*") AND (_time < "08:00" OR _time > "18:00") \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("regsvcs.exe","regasm.exe") and ProcessCommandLine has ".dll" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*regsvcs.exe" OR "*regasm.exe") AND process.command_line : "*.dll*" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 4. Regsvcs/Regasm Execution Spawning Suspicious Processes | Regsvcs or Regasm execution followed by suspicious process execution, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*regsvcs.exe","*regasm.exe") AND CommandLine IN ("*.dll*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("regsvcs.exe","regasm.exe") and ProcessCommandLine has ".dll" \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*regsvcs.exe" OR "*regasm.exe") AND process.command_line : "*.dll*" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 5. Regsvcs/Regasm Execution from Anomalous Locations | Regsvcs or Regasm execution from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn src_geo NOT IN (trusted_locations) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*regsvcs.exe","*regasm.exe") AND CommandLine IN ("*.dll*")] \| stats count by src_ip, src_geo, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where GeoLocation !in (trustedLocations) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("regsvcs.exe","regasm.exe") and ProcessCommandLine has ".dll") on DeviceName \| summarize count() by RemoteIP, GeoLocation, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.geo.location NOT IN ['trusted_locations'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*regsvcs.exe" OR "*regasm.exe") AND process.command_line : "*.dll*" \| STATS COUNT() BY source.ip, source.geo.location, host.name, process.executable HAVING COUNT() > 5`. |
| 6. Regsvcs/Regasm Execution in Cloud Environments | Regsvcs or Regasm execution in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*regsvcs.exe","*regasm.exe") AND CommandLine IN ("*.dll*")] \| stats count by src_ip, dest_host, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("regsvcs.exe","regasm.exe") and ProcessCommandLine has ".dll") on DeviceName \| summarize count() by RemoteIP, DeviceName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*regsvcs.exe" OR "*regasm.exe") AND process.command_line : "*.dll*" \| STATS COUNT() BY source.ip, host.name, event.action HAVING COUNT() > 5`. |
| 7. Regsvcs/Regasm Execution with Suspicious User Agents | Regsvcs or Regasm execution with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*regsvcs.exe","*regasm.exe") AND CommandLine IN ("*.dll*")] \| stats count by src_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("regsvcs.exe","regasm.exe") and ProcessCommandLine has ".dll") on DeviceName \| summarize count() by RemoteIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*regsvcs.exe" OR "*regasm.exe") AND process.command_line : "*.dll*" \| STATS COUNT() BY source.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Regsvcs/Regasm Execution Followed by File Creation | Regsvcs or Regasm execution leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*regsvcs.exe","*regasm.exe") AND CommandLine IN ("*.dll*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by dest_host, FileName, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("regsvcs.exe","regasm.exe") and ProcessCommandLine has ".dll" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by DeviceName, FileName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*regsvcs.exe" OR "*regasm.exe") AND process.command_line : "*.dll*" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY host.name, file.name, process.executable HAVING COUNT() > 5`. |
| 9. Regsvcs/Regasm Execution with Anomalous Parent Processes | Regsvcs or Regasm execution spawned by unusual parent processes, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*regsvcs.exe","*regasm.exe") AND CommandLine IN ("*.dll*") AND ParentImage NOT IN ("*explorer.exe", "*cmd.exe") \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("regsvcs.exe","regasm.exe") and ProcessCommandLine has ".dll" and ParentProcessName !has_any ("explorer.exe", "cmd.exe") \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*regsvcs.exe" OR "*regasm.exe") AND process.command_line : "*.dll*" AND process.parent.executable NOT IN ["*explorer.exe", "*cmd.exe"] \| STATS COUNT() BY host.nameVulners, process.executable, process.parent.executable HAVING COUNT() > 5`. |
| 10. Regsvcs/Regasm Execution via Known Vulnerable Applications | Regsvcs or Regasm execution via known vulnerable applications, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*regsvcs.exe","*regasm.exe") AND CommandLine IN ("*.dll*") AND ParentImage IN (known_vuln_apps) \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("regsvcs.exe","regasm.exe") and ProcessCommandLine has ".dll" and ParentProcessName in (knownVulnApps) \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*regsvcs.exe" OR "*regasm.exe") AND process.command_line : "*.dll*" AND process.parent.executable IN ['known_vuln_apps'] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |


### T1218.010: Regsvr32

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Regsvr32 Execution from Malicious IPs | Adversaries execute Regsvr32 from known malicious IPs, as in APT41. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*regsvr32.exe") AND CommandLine IN ("*.dll*","*.ocx*","*/i:*")] \| stats count by src_ip, dest_ip, dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "regsvr32.exe" and ProcessCommandLine has_any (".dll",".ocx","/i:")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*regsvr32.exe" AND process.command_line : ("*.dll*" OR "*.ocx*" OR "*/i:*") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 2. High-Frequency Regsvr32 Execution | High-frequency execution of Regsvr32, indicating potential abuse, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*regsvr32.exe") AND CommandLine IN ("*.dll*","*.ocx*","*/i:*") \| timechart span=1h count by dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "regsvr32.exe" and ProcessCommandLine has_any (".dll",".ocx","/i:") \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*regsvr32.exe" AND process.command_line : ("*.dll*" OR "*.ocx*" OR "*/i:*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Regsvr32 Execution Outside Business Hours | Regsvr32 execution outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*regsvr32.exe") AND CommandLine IN ("*.dll*","*.ocx*","*/i:*") AND (_time < "08:00" OR _time > "18:00") \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "regsvr32.exe" and ProcessCommandLine has_any (".dll",".ocx","/i:") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*regsvr32.exe" AND process.command_line : ("*.dll*" OR "*.ocx*" OR "*/i:*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 4. Regsvr32 Execution Spawning Suspicious Processes | Regsvr32 execution followed by suspicious process execution, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*regsvr32.exe") AND CommandLine IN ("*.dll*","*.ocx*","*/i:*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "regsvr32.exe" and ProcessCommandLine has_any (".dll",".ocx","/i:") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*regsvr32.exe" AND process.command_line : ("*.dll*" OR "*.ocx*" OR "*/i:*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 5. Regsvr32 Execution from Anomalous Locations | Regsvr32 execution from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn src_geo NOT IN (trusted_locations) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*regsvr32.exe") AND CommandLine IN ("*.dll*","*.ocx*","*/i:*")] \| stats count by src_ip, src_geo, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where GeoLocation !in (trustedLocations) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "regsvr32.exe" and ProcessCommandLine has_any (".dll",".ocx","/i:")) on DeviceName \| summarize count() by RemoteIP, GeoLocation, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.geo.location NOT IN ['trusted_locations'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*regsvr32.exe" AND process.command_line : ("*.dll*" OR "*.ocx*" OR "*/i:*") \| STATS COUNT() BY source.ip, source.geo.location, host.name, process.executable HAVING COUNT() > 5`. |
| 6. Regsvr32 Execution in Cloud Environments | Regsvr32 execution in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*regsvr32.exe") AND CommandLine IN ("*.dll*","*.ocx*","*/i:*")] \| stats count by src_ip, dest_host, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceProcessEvents \| where ProcessName has "regsvr32.exe" and ProcessCommandLine has_any (".dll",".ocx","/i:")) on DeviceName \| summarize count() by RemoteIP, DeviceName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*regsvr32.exe" AND process.command_line : ("*.dll*" OR "*.ocx*" OR "*/i:*") \| STATS COUNT() BY source.ip, host.name, event.action HAVING COUNT() > 5`. |
| 7. Regsvr32 Execution with Suspicious User Agents | Regsvr32 execution with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*regsvr32.exe") AND CommandLine IN ("*.dll*","*.ocx*","*/i:*")] \| stats count by src_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| join kind=inner (DeviceProcessEvents \| where ProcessName has "regsvr32.exe" and ProcessCommandLine has_any (".dll",".ocx","/i:")) on DeviceName \| summarize count() by RemoteIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*regsvr32.exe" AND process.command_line : ("*.dll*" OR "*.ocx*" OR "*/i:*") \| STATS COUNT() BY source.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Regsvr32 Execution Followed by File Creation | Regsvr32 execution leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*regsvr32.exe") AND CommandLine IN ("*.dll*","*.ocx*","*/i:*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by dest_host, FileName, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "regsvr32.exe" and ProcessCommandLine has_any (".dll",".ocx","/i:") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by DeviceName, FileName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*regsvr32.exe" AND process.command_line : ("*.dll*" OR "*.ocx*" OR "*/i:*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY host.name, file.name, process.executable HAVING COUNT() > 5`. |
| 9. Regsvr32 Execution with Anomalous Parent Processes | Regsvr32 execution spawned by unusual parent processes, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*regsvr32.exe") AND CommandLine IN ("*.dll*","*.ocx*","*/i:*") AND ParentImage NOT IN ("*explorer.exe", "*cmd.exe") \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "regsvr32.exe" and ProcessCommandLine has_any (".dll",".ocx","/i:") and ParentProcessName !has_any ("explorer.exe", "cmd.exe") \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*regsvr32.exe" AND process.command_line : ("*.dll*" OR "*.ocx*" OR "*/i:*") AND process.parent.executable NOT IN ["*explorer.exe", "*cmd.exe"] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |
| 10. Regsvr32 Execution via Known Vulnerable Applications | Regsvr32 execution via known vulnerable applications, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*regsvr32.exe") AND CommandLine IN ("*.dll*","*.ocx*","*/i:*") AND ParentImage IN (known_vuln_apps) \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "regsvr32.exe" and ProcessCommandLine has_any (".dll",".ocx","/i:") and ParentProcessName in (knownVulnApps) \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*regsvr32.exe" AND process.command_line : ("*.dll*" OR "*.ocx*" OR "*/i:*") AND process.parent.executable IN ['known_vuln_apps'] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |

### T1218.011: Rundll32

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Rundll32 Execution from Malicious IPs | Adversaries execute Rundll32 from known malicious IPs, as in APT41. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe") AND CommandLine IN ("*.dll*")] \| stats count by src_ip, dest_ip, dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "rundll32.exe" and ProcessCommandLine has ".dll") on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*rundll32.exe" AND process.command_line : "*.dll*" \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 2. High-Frequency Rundll32 Execution | High-frequency execution of Rundll32, indicating potential abuse, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe") AND CommandLine IN ("*.dll*") \| timechart span=1h count by dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "rundll32.exe" and ProcessCommandLine has ".dll" \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*rundll32.exe" AND process.command_line : "*.dll*" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Rundll32 Execution Outside Business Hours | Rundll32 execution outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe") AND CommandLine IN ("*.dll*") AND (_time < "08:00" OR _time > "18:00") \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "rundll32.exe" and ProcessCommandLine has ".dll" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*rundll32.exe" AND process.command_line : "*.dll*" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 4. Rundll32 Execution Spawning Suspicious Processes | Rundll32 execution followed by suspicious process execution, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe") AND CommandLine IN ("*.dll*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "rundll32.exe" and ProcessCommandLine has ".dll" \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*rundll32.exe" AND process.command_line : "*.dll*" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 5. Rundll32 Execution from Anomalous Locations | Rundll32 execution from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn src_geo NOT IN (trusted_locations) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe") AND CommandLine IN ("*.dll*")] \| stats count by src_ip, src_geo, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where GeoLocation !in (trustedLocations) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "rundll32.exe" and ProcessCommandLine has ".dll") on DeviceName \| summarize count() by RemoteIP, GeoLocation, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.geo.location NOT IN ['trusted_locations'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*rundll32.exe" AND process.command_line : "*.dll*" \| STATS COUNT() BY source.ip, source.geo.location, host.name, process.executable HAVING COUNT() > 5`. |
| 6. Rundll32 Execution in Cloud Environments | Rundll32 execution in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe") AND CommandLine IN ("*.dll*")] \| stats count by src_ip, dest_host, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceProcessEvents \| where ProcessName has "rundll32.exe" and ProcessCommandLine has ".dll") on DeviceName \| summarize count() by RemoteIP, DeviceName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*rundll32.exe" AND process.command_line : "*.dll*" \| STATS COUNT() BY source.ip, host.name, event.action HAVING COUNT() > 5`. |
| 7. Rundll32 Execution with Suspicious User Agents | Rundll32 execution with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe") AND CommandLine IN ("*.dll*")] \| stats count by src_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| join kind=inner (DeviceProcessEvents \| where ProcessName has "rundll32.exe" and ProcessCommandLine has ".dll") on DeviceName \| summarize count() by RemoteIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*rundll32.exe" AND process.command_line : "*.dll*" \| STATS COUNT() BY source.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Rundll32 Execution Followed by File Creation | Rundll32 execution leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe") AND CommandLine IN ("*.dll*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by dest_host, FileName, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "rundll32.exe" and ProcessCommandLine has ".dll" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by DeviceName, FileName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*rundll32.exe" AND process.command_line : "*.dll*" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY host.name, file.name, process.executable HAVING COUNT() > 5`. |
| 9. Rundll32 Execution with Anomalous Parent Processes | Rundll32 execution spawned by unusual parent processes, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe") AND CommandLine IN ("*.dll*") AND ParentImage NOT IN ("*explorer.exe", "*cmd.exe") \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "rundll32.exe" and ProcessCommandLine has ".dll" and ParentProcessName !has_any ("explorer.exe", "cmd.exe") \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*rundll32.exe" AND process.command_line : "*.dll*" AND process.parent.executable NOT IN ["*explorer.exe", "*cmd.exe"] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |
| 10. Rundll32 Execution via Known Vulnerable Applications | Rundll32 execution via known vulnerable applications, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe") AND CommandLine IN ("*.dll*") AND ParentImage IN (known_vuln_apps) \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "rundll32.exe" and ProcessCommandLine has ".dll" and ParentProcessName in (knownVulnApps) \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*rundll32.exe" AND process.command_line : "*.dll*" AND process.parent.executable IN ['known_vuln_apps'] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |

### T1218.012: Verclsid

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Verclsid Execution from Malicious IPs | Adversaries execute Verclsid from known malicious IPs, as in APT41. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*verclsid.exe")] \| stats count by src_ip, dest_ip, dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "verclsid.exe") on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*verclsid.exe" \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 2. High-Frequency Verclsid Execution | High-frequency execution of Verclsid, indicating potential abuse, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*verclsid.exe") \| timechart span=1h count by dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "verclsid.exe" \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*verclsid.exe" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Verclsid Execution Outside Business Hours | Verclsid execution outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*verclsid.exe") AND (_time < "08:00" OR _time > "18:00") \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "verclsid.exe" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*verclsid.exe" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 4. Verclsid Execution Spawning Suspicious Processes | Verclsid execution followed by suspicious process execution, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*verclsid.exe") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "verclsid.exe" \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*verclsid.exe" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 5. Verclsid Execution from Anomalous Locations | Verclsid execution from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn src_geo NOT IN (trusted_locations) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*verclsid.exe")] \| stats count by src_ip, src_geo, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where GeoLocation !in (trustedLocations) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "verclsid.exe") on DeviceName \| summarize count() by RemoteIP, GeoLocation, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.geo.location NOT IN ['trusted_locations'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*verclsid.exe" \| STATS COUNT() BY source.ip, source.geo.location, host.name, process.executable HAVING COUNT() > 5`. |
| 6. Verclsid Execution in Cloud Environments | Verclsid execution in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*verclsid.exe")] \| stats count by src_ip, dest_host, eventName \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceProcessEvents \| where ProcessName has "verclsid.exe") on DeviceName \| summarize count() by RemoteIP, DeviceName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*verclsid.exe" \| STATS COUNT() BY source.ip, host.name, event.action HAVING COUNT() > 5`. |
| 7. Verclsid Execution with Suspicious User Agents | Verclsid execution with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*verclsid.exe")] \| stats count by src_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| join kind=inner (DeviceProcessEvents \| where ProcessName has "verclsid.exe") on DeviceName \| summarize count() by RemoteIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*verclsid.exe" \| STATS COUNT() BY source.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Verclsid Execution Followed by File Creation | Verclsid execution leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*verclsid.exe") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by dest_host, FileName, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "verclsid.exe" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by DeviceName, FileName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*verclsid.exe" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY host.name, file.name, process.executable HAVING COUNT() > 5`. |
| 9. Verclsid Execution with Anomalous Parent Processes | Verclsid execution spawned by unusual parent processes, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*verclsid.exe") AND ParentImage NOT IN ("*explorer.exe", "*cmd.exe") \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "verclsid.exe" and ParentProcessName !has_any ("explorer.exe", "cmd.exe") \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*verclsid.exe" AND process.parent.executable NOT IN ["*explorer.exe", "*cmd.exe"] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |
| 10. Verclsid Execution via Known Vulnerable Applications | Verclsid execution via known vulnerable applications, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*verclsid.exe") AND ParentImage IN (known_vuln_apps) \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "verclsid.exe" and ParentProcessName in (knownVulnApps) \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*verclsid.exe" AND process.parent.executable IN ['known_vuln_apps'] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |

### T1218.013: Mavinject

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Mavinject Execution from Malicious IPs | Adversaries execute Mavinject from known malicious IPs, as in APT41. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mavinject.exe") AND CommandLine IN ("*/INJECTRUNNING*")] \| stats count by src_ip, dest_ip, dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "mavinject.exe" and ProcessCommandLine has "/INJECTRUNNING") on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*mavinject.exe" AND process.command_line : "*/INJECTRUNNING*" \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 2. High-Frequency Mavinject Execution | High-frequency execution of Mavinject, indicating potential abuse, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mavinject.exe") AND CommandLine IN ("*/INJECTRUNNING*") \| timechart span=1h count by dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "mavinject.exe" and ProcessCommandLine has "/INJECTRUNNING" \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*mavinject.exe" AND process.command_line : "*/INJECTRUNNING*" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Mavinject Execution Outside Business Hours | Mavinject execution outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mavinject.exe") AND CommandLine IN ("*/INJECTRUNNING*") AND (_time < "08:00" OR _time > "18:00") \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "mavinject.exe" and ProcessCommandLine has "/INJECTRUNNING" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*mavinject.exe" AND process.command_line : "*/INJECTRUNNING*" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 4. Mavinject Execution Spawning Suspicious Processes | Mavinject execution followed by suspicious process execution, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mavinject.exe") AND CommandLine IN ("*/INJECTRUNNING*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "mavinject.exe" and ProcessCommandLine has "/INJECTRUNNING" \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*mavinject.exe" AND process.command_line : "*/INJECTRUNNING*" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 5. Mavinject Execution from Anomalous Locations | Mavinject execution from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn src_geo NOT IN (trusted_locations) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mavinject.exe") AND CommandLine IN ("*/INJECTRUNNING*")] \| stats count by src_ip, src_geo, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where GeoLocation !in (trustedLocations) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "mavinject.exe" and ProcessCommandLine has "/INJECTRUNNING") on DeviceName \| summarize count() by RemoteIP, GeoLocation, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.geo.location NOT IN ['trusted_locations'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*mavinject.exe" AND process.command_line : "*/INJECTRUNNING*" \| STATS COUNT() BY source.ip, source.geo.location, host.name, process.executable HAVING COUNT() > 5`. |
| 6. Mavinject Execution in Cloud Environments | Mavinject execution in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mavinject.exe") AND CommandLine IN ("*/INJECTRUNNING*")] \| stats count by src_ip, dest_host, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceProcessEvents \| where ProcessName has "mavinject.exe" and ProcessCommandLine has "/INJECTRUNNING") on DeviceName \| summarize count() by RemoteIP, DeviceName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*mavinject.exe" AND process.command_line : "*/INJECTRUNNING*" \| STATS COUNT() BY source.ip, host.name, event.action HAVING COUNT() > 5`. |
| 7. Mavinject Execution with Suspicious User Agents | Mavinject execution with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mavinject.exe") AND CommandLine IN ("*/INJECTRUNNING*")] \| stats count by src_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| join kind=inner (DeviceProcessEvents \| where ProcessName has "mavinject.exe" and ProcessCommandLine has "/INJECTRUNNING") on DeviceName \| summarize count() by RemoteIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*mavinject.exe" AND process.command_line : "*/INJECTRUNNING*" \| STATS COUNT() BY source.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Mavinject Execution Followed by File Creation | Mavinject execution leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mavinject.exe") AND CommandLine IN ("*/INJECTRUNNING*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by dest_host, FileName, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "mavinject.exe" and ProcessCommandLine has "/INJECTRUNNING" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by DeviceName, FileName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*mavinject.exe" AND process.command_line : "*/INJECTRUNNING*" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY host.name, file.name, process.executable HAVING COUNT() > 5`. |
| 9. Mavinject Execution with Anomalous Parent Processes | Mavinject execution spawned by unusual parent processes, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mavinject.exe") AND CommandLine IN ("*/INJECTRUNNING*") AND ParentImage NOT IN ("*explorer.exe", "*cmd.exe") \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "mavinject.exe" and ProcessCommandLine has "/INJECTRUNNING" and ParentProcessName !has_any ("explorer.exe", "cmd.exe") \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*mavinject.exe" AND process.command_line : "*/INJECTRUNNING*" AND process.parent.executable NOT IN ["*explorer.exe", "*cmd.exe"] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |
| 10. Mavinject Execution via Known Vulnerable Applications | Mavinject execution via known vulnerable applications, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mavinject.exe") AND CommandLine IN ("*/INJECTRUNNING*") AND ParentImage IN (known_vuln_apps) \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "mavinject.exe" and ProcessCommandLine has "/INJECTRUNNING" and ParentProcessName in (knownVulnApps) \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*mavinject.exe" AND process.command_line : "*/INJECTRUNNING*" AND process.parent.executable IN ['known_vuln_apps'] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |


### T1218.014: MMC

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious MMC Execution from Malicious IPs | Adversaries execute MMC from known malicious IPs, as in APT41. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mmc.exe") AND CommandLine IN ("*.msc*")] \| stats count by src_ip, dest_ip, dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "mmc.exe" and ProcessCommandLine has ".msc") on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*mmc.exe" AND process.command_line : "*.msc*" \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 2. High-Frequency MMC Execution | High-frequency execution of MMC, indicating potential abuse, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mmc.exe") AND CommandLine IN ("*.msc*") \| timechart span=1h count by dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "mmc.exe" and ProcessCommandLine has ".msc" \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*mmc.exe" AND process.command_line : "*.msc*" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. MMC Execution Outside Business Hours | MMC execution outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mmc.exe") AND CommandLine IN ("*.msc*") AND (_time < "08:00" OR _time > "18:00") \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "mmc.exe" and ProcessCommandLine has ".msc" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*mmc.exe" AND process.command_line : "*.msc*" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 4. MMC Execution Spawning Suspicious Processes | MMC execution followed by suspicious process execution, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mmc.exe") AND CommandLine IN ("*.msc*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "mmc.exe" and ProcessCommandLine has ".msc" \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*mmc.exe" AND process.command_line : "*.msc*" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 5. MMC Execution from Anomalous Locations | MMC execution from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn src_geo NOT IN (trusted_locations) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mmc.exe") AND CommandLine IN ("*.msc*")] \| stats count by src_ip, src_geo, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where GeoLocation !in (trustedLocations) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "mmc.exe" and ProcessCommandLine has ".msc") on DeviceName \| summarize count() by RemoteIP, GeoLocation, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.geo.location NOT IN ['trusted_locations'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*mmc.exe" AND process.command_line : "*.msc*" \| STATS COUNT() BY source.ip, source.geo.location, host.name, process.executable HAVING COUNT() > 5`. |
| 6. MMC Execution in Cloud Environments | MMC execution in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mmc.exe") AND CommandLine IN ("*.msc*")] \| stats count by src_ip, dest_host, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceProcessEvents \| where ProcessName has "mmc.exe" and ProcessCommandLine has ".msc") on DeviceName \| summarize count() by RemoteIP, DeviceName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*mmc.exe" AND process.command_line : "*.msc*" \| STATS COUNT() BY source.ip, host.name, event.action HAVING COUNT() > 5`. |
| 7. MMC Execution with Suspicious User Agents | MMC execution with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mmc.exe") AND CommandLine IN ("*.msc*")] \| stats count by src_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| join kind=inner (DeviceProcessEvents \| where ProcessName has "mmc.exe" and ProcessCommandLine has ".msc") on DeviceName \| summarize count() by RemoteIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*mmc.exe" AND process.command_line : "*.msc*" \| STATS COUNT() BY source.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. MMC Execution Followed by File Creation | MMC execution leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mmc.exe") AND CommandLine IN ("*.msc*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by dest_host, FileName, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "mmc.exe" and ProcessCommandLine has ".msc" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by DeviceName, FileName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*mmc.exe" AND process.command_line : "*.msc*" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY host.name, file.name, process.executable HAVING COUNT() > 5`. |
| 9. MMC Execution with Anomalous Parent Processes | MMC execution spawned by unusual parent processes, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mmc.exe") AND CommandLine IN ("*.msc*") AND ParentImage NOT IN ("*explorer.exe", "*cmd.exe") \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "mmc.exe" and ProcessCommandLine has ".msc" and ParentProcessName !has_any ("explorer.exe", "cmd.exe") \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*mmc.exe" AND process.command_line : "*.msc*" AND process.parent.executable NOT IN ["*explorer.exe", "*cmd.exe"] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |
| 10. MMC Execution via Known Vulnerable Applications | MMC execution via known vulnerable applications, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*mmc.exe") AND CommandLine IN ("*.msc*") AND ParentImage IN (known_vuln_apps) \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "mmc.exe" and ProcessCommandLine has ".msc" and ParentProcessName in (knownVulnApps) \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*mmc.exe" AND process.command_line : "*.msc*" AND process.parent.executable IN ['known_vuln_apps'] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |

### T1218.015: Msiexec

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Msiexec Execution from Malicious IPs | Adversaries execute Msiexec from known malicious IPs, as in APT41. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*msiexec.exe") AND CommandLine IN ("*/i*","*.msi*")] \| stats count by src_ip, dest_ip, dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "msiexec.exe" and ProcessCommandLine has_any ("/i",".msi")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*msiexec.exe" AND process.command_line : ("*/i*" OR "*.msi*") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 2. High-Frequency Msiexec Execution | High-frequency execution of Msiexec, indicating potential abuse, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*msiexec.exe") AND CommandLine IN ("*/i*","*.msi*") \| timechart span=1h count by dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "msiexec.exe" and ProcessCommandLine has_any ("/i",".msi") \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*msiexec.exe" AND process.command_line : ("*/i*" OR "*.msi*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Msiexec Execution Outside Business Hours | Msiexec execution outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*msiexec.exe") AND CommandLine IN ("*/i*","*.msi*") AND (_time < "08:00" OR _time > "18:00") \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "msiexec.exe" and ProcessCommandLine has_any ("/i",".msi") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*msiexec.exe" AND process.command_line : ("*/i*" OR "*.msi*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 4. Msiexec Execution Spawning Suspicious Processes | Msiexec execution followed by suspicious process execution, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*msiexec.exe") AND CommandLine IN ("*/i*","*.msi*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "msiexec.exe" and ProcessCommandLine has_any ("/i",".msi") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*msiexec.exe" AND process.command_line : ("*/i*" OR "*.msi*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 5. Msiexec Execution from Anomalous Locations | Msiexec execution from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn src_geo NOT IN (trusted_locations) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*msiexec.exe") AND CommandLine IN ("*/i*","*.msi*")] \| stats count by src_ip, src_geo, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where GeoLocation !in (trustedLocations) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "msiexec.exe" and ProcessCommandLine has_any ("/i",".msi")) on DeviceName \| summarize count() by RemoteIP, GeoLocation, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.geo.location NOT IN ['trusted_locations'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*msiexec.exe" AND process.command_line : ("*/i*" OR "*.msi*") \| STATS COUNT() BY source.ip, source.geo.location, host.name, process.executable HAVING COUNT() > 5`. |
| 6. Msiexec Execution in Cloud Environments | Msiexec execution in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*msiexec.exe") AND CommandLine IN ("*/i*","*.msi*")] \| stats count by src_ip, dest_host, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceProcessEvents \| where ProcessName has "msiexec.exe" and ProcessCommandLine has_any ("/i",".msi")) on DeviceName \| summarize count() by RemoteIP, DeviceName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*msiexec.exe" AND process.command_line : ("*/i*" OR "*.msi*") \| STATS COUNT() BY source.ip, host.name, event.action HAVING COUNT() > 5`. |
| 7. Msiexec Execution with Suspicious User Agents | Msiexec execution with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*msiexec.exe") AND CommandLine IN ("*/i*","*.msi*")] \| stats count by src_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| join kind=inner (DeviceProcessEvents \| where ProcessName has "msiexec.exe" and ProcessCommandLine has_any ("/i",".msi")) on DeviceName \| summarize count() by RemoteIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*msiexec.exe" AND process.command_line : ("*/i*" OR "*.msi*") \| STATS COUNT() BY source.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Msiexec Execution Followed by File Creation | Msiexec execution leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*msiexec.exe") AND CommandLine IN ("*/i*","*.msi*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by dest_host, FileName, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "msiexec.exe" and ProcessCommandLine has_any ("/i",".msi") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by DeviceName, FileName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*msiexec.exe" AND process.command_line : ("*/i*" OR "*.msi*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY host.name, file.name, process.executable HAVING COUNT() > 5`. |
| 9. Msiexec Execution with Anomalous Parent Processes | Msiexec execution spawned by unusual parent processes, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*msiexec.exe") AND CommandLine IN ("*/i*","*.msi*") AND ParentImage NOT IN ("*explorer.exe", "*cmd.exe") \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "msiexec.exe" and ProcessCommandLine has_any ("/i",".msi") and ParentProcessName !has_any ("explorer.exe", "cmd.exe") \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*msiexec.exe" AND process.command_line : ("*/i*" OR "*.msi*") AND process.parent.executable NOT IN ["*explorer.exe", "*cmd.exe"] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |
| 10. Msiexec Execution via Known Vulnerable Applications | Msiexec execution via known vulnerable applications, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*msiexec.exe") AND CommandLine IN ("*/i*","*.msi*") AND ParentImage IN (known_vuln_apps) \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "msiexec.exe" and ProcessCommandLine has_any ("/i",".msi") and ParentProcessName in (knownVulnApps) \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*msiexec.exe" AND process.command_line : ("*/i*" OR "*.msi*") AND process.parent.executable IN ['known_vuln_apps'] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |

### T1218.016: Msbuild with Inline Tasks

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious MSBuild with Inline Tasks Execution from Malicious IPs | Adversaries execute MSBuild with inline tasks from known malicious IPs, as in APT41. | - Network Traffic (DS0029)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_conn src_ip IN (threat_intel_ips) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*MSBuild.exe") AND CommandLine IN ("*.proj*","*.csproj*","*.vbproj*","*InlineTask*")] \| stats count by src_ip, dest_ip, dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteIP in (threatIntelIPs) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "MSBuild.exe" and ProcessCommandLine has_any (".proj",".csproj",".vbproj","InlineTask")) on DeviceName \| summarize count() by RemoteIP, LocalIP, DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.ip IN ['threat_intel_ips'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*MSBuild.exe" AND process.command_line : ("*.proj*" OR "*.csproj*" OR "*.vbproj*" OR "*InlineTask*") \| STATS COUNT() BY source.ip, destination.ip, host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 2. High-Frequency MSBuild with Inline Tasks Execution | High-frequency execution of MSBuild with inline tasks, indicating potential abuse, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*MSBuild.exe") AND CommandLine IN ("*.proj*","*.csproj*","*.vbproj*","*InlineTask*") \| timechart span=1h count by dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "MSBuild.exe" and ProcessCommandLine has_any (".proj",".csproj",".vbproj","InlineTask") \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*MSBuild.exe" AND process.command_line : ("*.proj*" OR "*.csproj*" OR "*.vbproj*" OR "*InlineTask*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. MSBuild with Inline Tasks Execution Outside Business Hours | MSBuild with inline tasks execution outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*MSBuild.exe") AND CommandLine IN ("*.proj*","*.csproj*","*.vbproj*","*InlineTask*") AND (_time < "08:00" OR _time > "18:00") \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "MSBuild.exe" and ProcessCommandLine has_any (".proj",".csproj",".vbproj","InlineTask") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*MSBuild.exe" AND process.command_line : ("*.proj*" OR "*.csproj*" OR "*.vbproj*" OR "*InlineTask*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 4. MSBuild with Inline Tasks Execution Spawning Suspicious Processes | MSBuild with inline tasks execution followed by suspicious process execution, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*MSBuild.exe") AND CommandLine IN ("*.proj*","*.csproj*","*.vbproj*","*InlineTask*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by dest_host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "MSBuild.exe" and ProcessCommandLine has_any (".proj",".csproj",".vbproj","InlineTask") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*MSBuild.exe" AND process.command_line : ("*.proj*" OR "*.csproj*" OR "*.vbproj*" OR "*InlineTask*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 5. MSBuild with Inline Tasks Execution from Anomalous Locations | MSBuild with inline tasks execution from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn src_geo NOT IN (trusted_locations) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*MSBuild.exe") AND CommandLine IN ("*.proj*","*.csproj*","*.vbproj*","*InlineTask*")] \| stats count by src_ip, src_geo, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where GeoLocation !in (trustedLocations) \| join kind=inner (DeviceProcessEvents \| where ProcessName has "MSBuild.exe" and ProcessCommandLine has_any (".proj",".csproj",".vbproj","InlineTask")) on DeviceName \| summarize count() by RemoteIP, GeoLocation, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.geo.location NOT IN ['trusted_locations'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*MSBuild.exe" AND process.command_line : ("*.proj*" OR "*.csproj*" OR "*.vbproj*" OR "*InlineTask*") \| STATS COUNT() BY source.ip, source.geo.location, host.name, process.executable HAVING COUNT() > 5`. |
| 6. MSBuild with Inline Tasks Execution in Cloud Environments | MSBuild with inline tasks execution in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*MSBuild.exe") AND CommandLine IN ("*.proj*","*.csproj*","*.vbproj*","*InlineTask*")] \| stats count by src_ip, dest_host, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceProcessEvents \| where ProcessName has "MSBuild.exe" and ProcessCommandLine has_any (".proj",".csproj",".vbproj","InlineTask")) on DeviceName \| summarize count() by RemoteIP, DeviceName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*MSBuild.exe" AND process.command_line : ("*.proj*" OR "*.csproj*" OR "*.vbproj*" OR "*InlineTask*") \| STATS COUNT() BY source.ip, host.name, event.action HAVING COUNT() > 5`. |
| 7. MSBuild with Inline Tasks Execution with Suspicious User Agents | MSBuild with inline tasks execution with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_conn \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*MSBuild.exe") AND CommandLine IN ("*.proj*","*.csproj*","*.vbproj*","*InlineTask*")] \| stats count by src_ip, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| join kind=inner (DeviceProcessEvents \| where ProcessName has "MSBuild.exe" and ProcessCommandLine has_any (".proj",".csproj",".vbproj","InlineTask")) on DeviceName \| summarize count() by RemoteIP, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : "*MSBuild.exe" AND process.command_line : ("*.proj*" OR "*.csproj*" OR "*.vbproj*" OR "*InlineTask*") \| STATS COUNT() BY source.ip, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. MSBuild with Inline Tasks Execution Followed by File Creation | MSBuild with inline tasks execution leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*MSBuild.exe") AND CommandLine IN ("*.proj*","*.csproj*","*.vbproj*","*InlineTask*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by dest_host, FileName, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "MSBuild.exe" and ProcessCommandLine has_any (".proj",".csproj",".vbproj","InlineTask") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by DeviceName, FileName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*MSBuild.exe" AND process.command_line : ("*.proj*" OR "*.csproj*" OR "*.vbproj*" OR "*InlineTask*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY host.name, file.name, process.executable HAVING COUNT() > 5`. |
| 9. MSBuild with Inline Tasks Execution with Anomalous Parent Processes | MSBuild with inline tasks execution spawned by unusual parent processes, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*MSBuild.exe") AND CommandLine IN ("*.proj*","*.csproj*","*.vbproj*","*InlineTask*") AND ParentImage NOT IN ("*explorer.exe", "*cmd.exe", "*devenv.exe") \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "MSBuild.exe" and ProcessCommandLine has_any (".proj",".csproj",".vbproj","InlineTask") and ParentProcessName !has_any ("explorer.exe", "cmd.exe", "devenv.exe") \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*MSBuild.exe" AND process.command_line : ("*.proj*" OR "*.csproj*" OR "*.vbproj*" OR "*InlineTask*") AND process.parent.executable NOT IN ["*explorer.exe", "*cmd.exe", "*devenv.exe"] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |
| 10. MSBuild with Inline Tasks Execution via Known Vulnerable Applications | MSBuild with inline tasks execution via known vulnerable applications, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*MSBuild.exe") AND CommandLine IN ("*.proj*","*.csproj*","*.vbproj*","*InlineTask*") AND ParentImage IN (known_vuln_apps) \| stats count by dest_host, Image, ParentImage \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has "MSBuild.exe" and ProcessCommandLine has_any (".proj",".csproj",".vbproj","InlineTask") and ParentProcessName in (knownVulnApps) \| summarize count() by DeviceName, ProcessName, ParentProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*MSBuild.exe" AND process.command_line : ("*.proj*" OR "*.csproj*" OR "*.vbproj*" OR "*InlineTask*") AND process.parent.executable IN ['known_vuln_apps'] \| STATS COUNT() BY host.name, process.executable, process.parent.executable HAVING COUNT() > 5`. |

### T1222: File and Directory Permissions Modification
### T1222.001: Windows File and Directory Permissions Modification

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Windows File Permission Changes by Non-Admin Users | Adversaries modify file or directory permissions using non-admin accounts, as seen in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Modification (DS0013: Sysmon ID 11)<br>- Windows Event Logs (DS0002: Event ID 4670) | - **Splunk**: `index=endpoint sourcetype=win:security EventCode=4670 Account_Name!=*Admin* AND Object_Type IN ("File","Directory") AND Permissions IN ("*FULL_CONTROL*","*WRITE*") \| join Object_Name [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe","*.dll","*.ps1")] \| stats count by Account_Name, Object_Name, Permissions \| where count > 5`.<br>- **KQL**: `SecurityEvent \| where EventID == 4670 and Account !contains "Admin" and ObjectType in ("File","Directory") and NewPermissions has_any ("FULL_CONTROL","WRITE") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe",".dll",".ps1")) on TargetObject=FileName \| summarize count() by Account, TargetObject, NewPermissions \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.security-* \| WHERE event.code : "4670" AND winlog.event_data.Account NOT LIKE "%Admin%" AND winlog.event_data.ObjectType IN ["File","Directory"] AND winlog.event_data.Permissions : ("*FULL_CONTROL*" OR "*WRITE*") \| JOIN logs-endpoint.file-* ON file.path WHERE file.extension IN ["exe","dll","ps1"] \| STATS COUNT() BY winlog.event_data.Account, file.path, winlog.event_data.Permissions HAVING COUNT() > 5`. |
| 2. High-Frequency Permission Changes on Sensitive Files | High-frequency permission changes on critical system files, as in FIN7. | - File Modification (DS0013: Sysmon ID 11)<br>- Windows Event Logs (DS0002: Event ID 4670) | - **Splunk**: `index=endpoint sourcetype=win:security EventCode=4670 Object_Name IN ("*system32*","*ProgramData*","*AppData*") \| timechart span=1h count by Object_Name \| where count > avg(count)*3`.<br>- **KQL**: `SecurityEvent \| where EventID == 4670 and TargetObject has_any ("system32","ProgramData","AppData") \| summarize HourlyCount=count() by bin(TimeGenerated, 1h), TargetObject \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.security-* \| WHERE event.code : "4670" AND winlog.event_data.ObjectName : ("*system32*" OR "*ProgramData*" OR "*AppData*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), winlog.event_data.ObjectName \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Permission Changes Outside Business Hours | Permission modifications on Windows files or directories outside business hours, as in APT29. | - Windows Event Logs (DS0002: Event ID 4670) | - **Splunk**: `index=endpoint sourcetype=win:security EventCode=4670 Object_Type IN ("File","Directory") AND (_time < "08:00" OR _time > "18:00") \| stats count by Account_Name, Object_Name, Permissions \| where count > 5`.<br>- **KQL**: `SecurityEvent \| where EventID == 4670 and ObjectType in ("File","Directory") and (hour(TimeGenerated) < 8 or hour(TimeGenerated) > 18) \| summarize count() by Account, TargetObject, NewPermissions \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.security-* \| WHERE event.code : "4670" AND winlog.event_data.ObjectType IN ["File","Directory"] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY winlog.event_data.Account, winlog.event_data.ObjectName, winlog.event_data.Permissions HAVING COUNT() > 5`. |
| 4. Permission Changes Followed by Suspicious Process Execution | Permission changes followed by execution of suspicious processes, as in Cobalt Strike. | - Windows Event Logs (DS0002: Event ID 4670)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=win:security EventCode=4670 Object_Type IN ("File","Directory") \| join Object_Name [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*","*powershell.exe*")] \| stats count by Account_Name, Object_Name, Image \| where count > 5`.<br>- **KQL**: `SecurityEvent \| where EventID == 4670 and ObjectType in ("File","Directory") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe","powershell.exe")) on TargetObject=FileName \| summarize count() by Account, TargetObject, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.security-* \| WHERE event.code : "4670" AND winlog.event_data.ObjectType IN ["File","Directory"] \| JOIN logs-endpoint.process-* ON file.path WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY winlog.event_data.Account, file.path, process.executable HAVING COUNT() > 5`. |
| 5. Permission Changes from Anomalous Locations | Permission changes initiated from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data<br>- Windows Event Logs (DS0002: Event ID 4670) | - **Splunk**: `index=network sourcetype=zeek_conn src_geo NOT IN (trusted_locations) \| join dest_host [search index=endpoint sourcetype=win:security EventCode=4670 Object_Type IN ("File","Directory")] \| stats count by src_ip, src_geo, Object_Name \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where GeoLocation !in (trustedLocations) \| join kind=inner (SecurityEvent \| where EventID == 4670 and ObjectType in ("File","Directory")) on DeviceName \| summarize count() by RemoteIP, GeoLocation, TargetObject \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.geo.location NOT IN ['trusted_locations'] \| JOIN logs-endpoint.security-* ON host.name WHERE event.code : "4670" AND winlog.event_data.ObjectType IN ["File","Directory"] \| STATS COUNT() BY source.ip, source.geo.location, winlog.event_data.ObjectName HAVING COUNT() > 5`. |
| 6. Permission Changes in Cloud Environments | Permission modifications in cloud-managed Windows endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Windows Event Logs (DS0002: Event ID 4670) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand","Invoke-Script") \| join dest_host [search index=endpoint sourcetype=win:security EventCode=4670 Object_Type IN ("File","Directory")] \| stats count by src_ip, dest_host, Object_Name \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand","Invoke-Script") \| join kind=inner (SecurityEvent \| where EventID == 4670 and ObjectType in ("File","Directory")) on DeviceName \| summarize count() by RemoteIP, DeviceName, TargetObject \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand','Invoke-Script'] \| JOIN logs-endpoint.security-* ON host.name WHERE event.code : "4670" AND winlog.event_data.ObjectType IN ["File","Directory"] \| STATS COUNT() BY source.ip, host.name, winlog.event_data.ObjectName HAVING COUNT() > 5`. |
| 7. Permission Changes with Suspicious User Agents | Permission changes associated with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Windows Event Logs (DS0002: Event ID 4670) | - **Splunk**: `index=network sourcetype=zeek_conn \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| join dest_host [search index=endpoint sourcetype=win:security EventCode=4670 Object_Type IN ("File","Directory")] \| stats count by src_ip, user_agent, Object_Name \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| join kind=inner (SecurityEvent \| where EventID == 4670 and ObjectType in ("File","Directory")) on DeviceName \| summarize count() by RemoteIP, AdditionalFields.UserAgent, TargetObject \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| JOIN logs-endpoint.security-* ON host.name WHERE event.code : "4670" AND winlog.event_data.ObjectType IN ["File","Directory"] \| STATS COUNT() BY source.ip, http.user_agent, winlog.event_data.ObjectName HAVING COUNT() > 5`. |
| 8. Permission Changes on Recently Created Files | Permission changes on recently created files, indicating potential abuse, as in APT41. | - File Creation (DS0013: Sysmon ID 11)<br>- Windows Event Logs (DS0002: Event ID 4670) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe","*.dll","*.ps1") \| join FileName [search index=endpoint sourcetype=win:security EventCode=4670 Object_Type IN ("File","Directory")] \| stats count by FileName, Object_Name, Permissions \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".exe",".dll",".ps1") \| join kind=inner (SecurityEvent \| where EventID == 4670 and ObjectType in ("File","Directory")) on FileName=TargetObject \| summarize count() by FileName, TargetObject, NewPermissions \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.extension IN ["exe","dll","ps1"] \| JOIN logs-endpoint.security-* ON file.path WHERE event.code : "4670" AND winlog.event_data.ObjectType IN ["File","Directory"] \| STATS COUNT() BY file.path, winlog.event_data.ObjectName, winlog.event_data.Permissions HAVING COUNT() > 5`. |
| 9. Permission Changes by Unusual Processes | Permission changes initiated by unusual processes, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Windows Event Logs (DS0002: Event ID 4670) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image NOT IN ("*explorer.exe","*cmd.exe") \| join dest_host [search index=endpoint sourcetype=win:security EventCode=4670 Object_Type IN ("File","Directory")] \| stats count by Image, Object_Name, Permissions \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName !has_any ("explorer.exe","cmd.exe") \| join kind=inner (SecurityEvent \| where EventID == 4670 and ObjectType in ("File","Directory")) on DeviceName \| summarize count() by ProcessName, TargetObject, NewPermissions \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable NOT IN ["*explorer.exe","*cmd.exe"] \| JOIN logs-endpoint.security-* ON host.name WHERE event.code : "4670" AND winlog.event_data.ObjectType IN ["File","Directory"] \| STATS COUNT() BY process.executable, winlog.event_data.ObjectName, winlog.event_data.Permissions HAVING COUNT() > 5`. |
| 10. Permission Changes via Known Vulnerable Applications | Permission changes via known vulnerable applications, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Windows Event Logs (DS0002: Event ID 4670)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN (known_vuln_apps) \| join dest_host [search index=endpoint sourcetype=win:security EventCode=4670 Object_Type IN ("File","Directory")] \| stats count by Image, Object_Name, Permissions \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName in (knownVulnApps) \| join kind=inner (SecurityEvent \| where EventID == 4670 and ObjectType in ("File","Directory")) on DeviceName \| summarize count() by ProcessName, TargetObject, NewPermissions \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable IN ['known_vuln_apps'] \| JOIN logs-endpoint.security-* ON host.name WHERE event.code : "4670" AND winlog.event_data.ObjectType IN ["File","Directory"] \| STATS COUNT() BY process.executable, winlog.event_data.ObjectName, winlog.event_data.Permissions HAVING COUNT() > 5`. |

### T1222.002: Linux and Mac File and Directory Permissions Modification

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Linux/Mac File Permission Changes by Non-Root Users | Adversaries modify file or directory permissions using non-root accounts, as seen in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Modification (DS0013: Sysmon ID 11)<br>- Audit Logs (auditd) | - **Splunk**: `index=linux sourcetype=auditd command IN ("chmod","chown") user!=root \| join path [search index=linux sourcetype=sysmon EventCode=11 FileName IN ("*.sh","*.bin","*.so")] \| stats count by user, path, command \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where event_category == "file" and audit_user != "root" and command in ("chmod","chown") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".sh",".bin",".so")) on FileName \| summarize count() by audit_user, FileName, command \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE event.category : "file" AND auditd.user.name != "root" AND auditd.data.command IN ["chmod","chown"] \| JOIN logs-endpoint.file-* ON file.path WHERE file.extension IN ["sh","bin","so"] \| STATS COUNT() BY auditd.user.name, file.path, auditd.data.command HAVING COUNT() > 5`. |
| 2. High-Frequency Permission Changes on Sensitive Files | High-frequency permission changes on critical Linux/Mac files, as in FIN7. | - File Modification (DS0013: Sysmon ID 11)<br>- Audit Logs (auditd) | - **Splunk**: `index=linux sourcetype=auditd command IN ("chmod","chown") path IN ("/etc/*","/bin/*","/usr/bin/*") \| timechart span=1h count by path \| where count > avg(count)*3`.<br>- **KQL**: `LinuxAuditd \| where command in ("chmod","chown") and FilePath has_any ("/etc/","/bin/","/usr/bin/") \| summarize HourlyCount=count() by bin(timestamp, 1h), FilePath \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE auditd.data.command IN ["chmod","chown"] AND file.path : ("/etc/*" OR "/bin/*" OR "/usr/bin/*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), file.path \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Permission Changes Outside Business Hours | Permission modifications on Linux/Mac files or directories outside business hours, as in APT29. | - Audit Logs (auditd) | - **Splunk**: `index=linux sourcetype=auditd command IN ("chmod","chown") AND (_time < "08:00" OR _time > "18:00") \| stats count by user, path, command \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where command in ("chmod","chown") and (hour(timestamp) < 8 or hour(timestamp) > 18) \| summarize count() by audit_user, FilePath, command \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE auditd.data.command IN ["chmod","chown"] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY auditd.user.name, file.path, auditd.data.command HAVING COUNT() > 5`. |
| 4. Permission Changes Followed by Suspicious Process Execution | Permission changes followed by execution of suspicious processes, as in Cobalt Strike. | - Audit Logs (auditd)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=linux sourcetype=auditd command IN ("chmod","chown") \| join path [search index=linux sourcetype=sysmon EventCode=1 Image IN ("/bin/bash","/bin/sh","/usr/bin/python*")] \| stats count by user, path, Image \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where command in ("chmod","chown") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("/bin/bash","/bin/sh","/usr/bin/python")) on FileName=FilePath \| summarize count() by audit_user, FilePath, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE auditd.data.command IN ["chmod","chown"] \| JOIN logs-endpoint.process-* ON file.path WHERE process.executable : ("/bin/bash" OR "/bin/sh" OR "/usr/bin/python*") \| STATS COUNT() BY auditd.user.name, file.path, process.executable HAVING COUNT() > 5`. |
| 5. Permission Changes from Anomalous Locations | Permission changes initiated from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029)<br>- GeoIP Data<br>- Audit Logs (auditd) | - **Splunk**: `index=network sourcetype=zeek_conn src_geo NOT IN (trusted_locations) \| join dest_host [search index=linux sourcetype=auditd command IN ("chmod","chown")] \| stats count by src_ip, src_geo, path \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where GeoLocation !in (trustedLocations) \| join kind=inner (LinuxAuditd \| where command in ("chmod","chown")) on DeviceName \| summarize count() by RemoteIP, GeoLocation, FilePath \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.geo.location NOT IN ['trusted_locations'] \| JOIN logs-auditd-* ON host.name WHERE auditd.data.command IN ["chmod","chown"] \| STATS COUNT() BY source.ip, source.geo.location, file.path HAVING COUNT() > 5`. |
| 6. Permission Changes in Cloud Environments | Permission modifications in cloud-managed Linux/Mac endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Audit Logs (auditd) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand","Invoke-Script") \| join dest_host [search index=linux sourcetype=auditd command IN ("chmod","chown")] \| stats count by src_ip, dest_host, path \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand","Invoke-Script") \| join kind=inner (LinuxAuditd \| where command in ("chmod","chown")) on DeviceName \| summarize count() by RemoteIP, DeviceName, FilePath \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand','Invoke-Script'] \| JOIN logs-auditd-* ON host.name WHERE auditd.data.command IN ["chmod","chown"] \| STATS COUNT() BY source.ip, host.name, file.path HAVING COUNT() > 5`. |
| 7. Permission Changes with Suspicious User Agents | Permission changes associated with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Audit Logs (auditd) | - **Splunk**: `index=network sourcetype=zeek_conn \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| join dest_host [search index=linux sourcetype=auditd command IN ("chmod","chown")] \| stats count by src_ip, user_agent, path \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| join kind=inner (LinuxAuditd \| where command in ("chmod","chown")) on DeviceName \| summarize count() by RemoteIP, AdditionalFields.UserAgent, FilePath \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| JOIN logs-auditd-* ON host.name WHERE auditd.data.command IN ["chmod","chown"] \| STATS COUNT() BY source.ip, http.user_agent, file.path HAVING COUNT() > 5`. |
| 8. Permission Changes on Recently Created Files | Permission changes on recently created Linux/Mac files, indicating potential abuse, as in APT41. | - File Creation (DS0013: Sysmon ID 11)<br>- Audit Logs (auditd) | - **Splunk**: `index=linux sourcetype=sysmon EventCode=11 FileName IN ("*.sh","*.bin","*.so") \| join FileName [search index=linux sourcetype=auditd command IN ("chmod","chown")] \| stats count by FileName, path, command \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".sh",".bin",".so") \| join kind=inner (LinuxAuditd \| where command in ("chmod","chown")) on FileName=FilePath \| summarize count() by FileName, FilePath, command \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.extension IN ["sh","bin","so"] \| JOIN logs-auditd-* ON file.path WHERE auditd.data.command IN ["chmod","chown"] \| STATS COUNT() BY file.path, file.path, auditd.data.command HAVING COUNT() > 5`. |
| 9. Permission Changes by Unusual Processes | Permission changes initiated by unusual processes, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Audit Logs (auditd) | - **Splunk**: `index=linux sourcetype=sysmon EventCode=1 Image NOT IN ("/bin/bash","/bin/sh") \| join dest_host [search index=linux sourcetype=auditd command IN ("chmod","chown")] \| stats count by Image, path, command \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName !has_any ("/bin/bash","/bin/sh") \| join kind=inner (LinuxAuditd \| where command in ("chmod","chown")) on DeviceName \| summarize count() by ProcessName, FilePath, command \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable NOT IN ["/bin/bash","/bin/sh"] \| JOIN logs-auditd-* ON host.name WHERE auditd.data.command IN ["chmod","chown"] \| STATS COUNT() BY process.executable, file.path, auditd.data.command HAVING COUNT() > 5`. |
| 10. Permission Changes via Known Vulnerable Applications | Permission changes via known vulnerable applications, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Audit Logs (auditd)<br>- Threat Intelligence | - **Splunk**: `index=linux sourcetype=sysmon EventCode=1 Image IN (known_vuln_apps) \| join dest_host [search index=linux sourcetype=auditd command IN ("chmod","chown")] \| stats count by Image, path, command \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName in (knownVulnApps) \| join kind=inner (LinuxAuditd \| where command in ("chmod","chown")) on DeviceName \| summarize count() by ProcessName, FilePath, command \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable IN ['known_vuln_apps'] \| JOIN logs-auditd-* ON host.name WHERE auditd.data.command IN ["chmod","chown"] \| STATS COUNT() BY process.executable, file.path, auditd.data.command HAVING COUNT() > 5`. |
