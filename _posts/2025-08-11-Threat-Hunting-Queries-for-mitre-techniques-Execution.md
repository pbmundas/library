---
layout: default
title:  Execution
category: Threat-Hunting-Queries  # This becomes a main topic in sidebar
---

## Execution

### T1059: Command and Scripting Interpreter
# Threat Hunting Hypotheses for MITRE ATT&CK T1059: Command and Scripting Interpreter

### T1059.001: PowerShell

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. PowerShell Executions from Suspicious IPs | Adversaries execute PowerShell from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency PowerShell Executions | High-frequency PowerShell executions, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. PowerShell Executions Outside Business Hours | PowerShell executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. PowerShell Executions Triggering Suspicious Processes | PowerShell spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*powershell.exe" Image IN ("*rundll32.exe*", "*regsvr32.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "powershell.exe" and ProcessName has_any ("rundll32.exe", "regsvr32.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*powershell.exe" AND process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. PowerShell Executions from Anomalous Locations | PowerShell executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. PowerShell Executions in Cloud Environments | PowerShell used in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*powershell.exe" AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "powershell.exe" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*powershell.exe" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. PowerShell Executions with Suspicious User Agents | PowerShell accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. PowerShell Executions Followed by File Creation | PowerShell executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.ps1")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".ps1")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.ps1") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. PowerShell Executions with Anomalous Protocols | PowerShell executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. PowerShell Executions via Known Vulnerable Services | PowerShell executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1059.002: AppleScript

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. AppleScript Executions from Suspicious IPs | Adversaries execute AppleScript from known malicious IPs, as in Lazarus Group. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency AppleScript Executions | High-frequency AppleScript executions, as in APT32. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. AppleScript Executions Outside Business Hours | AppleScript executions outside business hours, as in APT29 macOS variants. | - Process Creation (DS0009: Sysmon-like on macOS) | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. AppleScript Executions Triggering Suspicious Processes | AppleScript spawning suspicious child processes, as in Cobalt Strike macOS beacons. | - Process Creation (DS0009: Sysmon-like on macOS) | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" \| join dest_host [search index=endpoint sourcetype=macos:process EventCode=1 ParentImage="*osascript" Image IN ("*sh", "*bash")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "osascript" and ProcessName has_any ("sh", "bash")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*osascript" AND process.executable : ("*sh" OR "*bash") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. AppleScript Executions from Anomalous Locations | AppleScript executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. AppleScript Executions in Cloud Environments | AppleScript used in cloud-managed macOS endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*osascript" AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "osascript" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*osascript" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. AppleScript Executions with Suspicious User Agents | AppleScript accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. AppleScript Executions Followed by File Creation | AppleScript executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- File Creation (DS0013) | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" \| join dest_host [search index=endpoint sourcetype=macos:file EventCode=11 FileName IN ("*.sh", "*.app", "*.dmg")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".sh", ".app", ".dmg")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.sh" OR "*.app" OR "*.dmg") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. AppleScript Executions with Anomalous Protocols | AppleScript executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. AppleScript Executions via Known Vulnerable Services | AppleScript executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon-like on macOS)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=macos:process EventCode=1 Image="*osascript" AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "osascript" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*osascript" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1059.003: Windows Command Shell

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Windows Command Shell Executions from Suspicious IPs | Adversaries execute cmd.exe from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Windows Command Shell Executions | High-frequency cmd.exe executions, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Windows Command Shell Executions Outside Business Hours | cmd.exe executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Windows Command Shell Executions Triggering Suspicious Processes | cmd.exe spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*cmd.exe" Image IN ("*net.exe*", "*whoami.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "cmd.exe" and ProcessName has_any ("net.exe", "whoami.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*cmd.exe" AND process.executable : ("*net.exe*" OR "*whoami.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Windows Command Shell Executions from Anomalous Locations | cmd.exe executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Windows Command Shell Executions in Cloud Environments | cmd.exe used in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*cmd.exe" AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "cmd.exe" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*cmd.exe" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Windows Command Shell Executions with Suspicious User Agents | cmd.exe accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Windows Command Shell Executions Followed by File Creation | cmd.exe executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.bat", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".bat", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.bat" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Windows Command Shell Executions with Anomalous Protocols | cmd.exe executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Windows Command Shell Executions via Known Vulnerable Services | cmd.exe executed via vulnerable services, as in Patchwork APT. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe" AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "cmd.exe" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*cmd.exe" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1059.004: Unix Shell

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Unix Shell Executions from Suspicious IPs | Adversaries execute Unix shells from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Unix Shell Executions | High-frequency Unix shell executions, as in APT41. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Unix Shell Executions Outside Business Hours | Unix shell executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon-like on Linux) | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Unix Shell Executions Triggering Suspicious Processes | Unix shells spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon-like on Linux) | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") \| join dest_host [search index=endpoint sourcetype=linux:process EventCode=1 ParentImage IN ("*bash", "*sh") Image IN ("*curl*", "*wget*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("bash", "sh") and ProcessName has_any ("curl", "wget")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*bash" OR "*sh") AND process.executable : ("*curl*" OR "*wget*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Unix Shell Executions from Anomalous Locations | Unix shell executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Unix Shell Executions in Cloud Environments | Unix shells used in cloud-managed Linux endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*bash", "*sh") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("bash", "sh") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*bash" OR "*sh") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Unix Shell Executions with Suspicious User Agents | Unix shells accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Unix Shell Executions Followed by File Creation | Unix shell executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- File Creation (DS0013) | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") \| join dest_host [search index=endpoint sourcetype=linux:file EventCode=11 FileName IN ("*.elf", "*.sh", "*.so")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".elf", ".sh", ".so")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.elf" OR "*.sh" OR "*.so") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Unix Shell Executions with Anomalous Protocols | Unix shells executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Unix Shell Executions via Known Vulnerable Services | Unix shells executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon-like on Linux)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=linux:process EventCode=1 Image IN ("*bash", "*sh") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("bash", "sh") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*bash" OR "*sh") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1059.005: Visual Basic

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Visual Basic Executions from Suspicious IPs | Adversaries execute Visual Basic scripts from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Visual Basic Executions | High-frequency Visual Basic script executions, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Visual Basic Executions Outside Business Hours | Visual Basic script executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Visual Basic Executions Triggering Suspicious Processes | Visual Basic scripts spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*wscript.exe", "*cscript.exe") Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("wscript.exe", "cscript.exe") and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*wscript.exe" OR "*cscript.exe") AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Visual Basic Executions from Anomalous Locations | Visual Basic script executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Visual Basic Executions in Cloud Environments | Visual Basic scripts used in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*wscript.exe", "*cscript.exe") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("wscript.exe", "cscript.exe") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*wscript.exe" OR "*cscript.exe") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Visual Basic Executions with Suspicious User Agents | Visual Basic scripts accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Visual Basic Executions Followed by File Creation | Visual Basic script executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.vbs", "*.dll")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".vbs", ".dll")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.vbs" OR "*.dll") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Visual Basic Executions with Anomalous Protocols | Visual Basic scripts executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Visual Basic Executions via Known Vulnerable Services | Visual Basic scripts executed via vulnerable services, as in APT28. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wscript.exe", "*cscript.exe") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wscript.exe", "cscript.exe") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wscript.exe" OR "*cscript.exe") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`.


### T1059.006: Python

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Python Executions from Suspicious IPs | Adversaries execute Python scripts from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Python Executions | High-frequency Python script executions, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Python Executions Outside Business Hours | Python executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Python Executions Triggering Suspicious Processes | Python spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*python.exe" Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "python.exe" and ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*python.exe" AND process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Python Executions from Anomalous Locations | Python executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Python Executions in Cloud Environments | Python used in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*python.exe" AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "python.exe" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*python.exe" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Python Executions with Suspicious User Agents | Python accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Python Executions Followed by File Creation | Python executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.py", "*.dll")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".py", ".dll")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.py" OR "*.dll") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Python Executions with Anomalous Protocols | Python executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Python Executions via Known Vulnerable Services | Python executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python.exe" AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "python.exe" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*python.exe" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1059.007: JavaScript

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. JavaScript Executions from Suspicious IPs | Adversaries execute JavaScript from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency JavaScript Executions | High-frequency JavaScript executions, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. JavaScript Executions Outside Business Hours | JavaScript executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. JavaScript Executions Triggering Suspicious Processes | JavaScript spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*node.exe", "*wscript.exe", "*cscript.exe") Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. JavaScript Executions from Anomalous Locations | JavaScript executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. JavaScript Executions in Cloud Environments | JavaScript used in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. JavaScript Executions with Suspicious User Agents | JavaScript accessed with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. JavaScript Executions Followed by File Creation | JavaScript executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.js", "*.dll")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".js", ".dll")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.js" OR "*.dll") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. JavaScript Executions with Anomalous Protocols | JavaScript executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. JavaScript Executions via Known Vulnerable Services | JavaScript executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*node.exe", "*wscript.exe", "*cscript.exe") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("node.exe", "wscript.exe", "cscript.exe") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*node.exe" OR "*wscript.exe" OR "*cscript.exe") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1059.008: Network Device CLI

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Network Device CLI Commands from Suspicious IPs | Adversaries execute CLI commands on network devices from known malicious IPs, as in Volt Typhoon. | - Network Device Logs (DS0003: Syslog)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") AND src_ip IN (threat_intel_ips) \| stats count by src_ip, dest_host, command \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") and RemoteIP in (threatIntelIPs) \| summarize count() by RemoteIP, DeviceName, AdditionalFields.Command \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY source.ip, host.name, event.command HAVING COUNT() > 5`. |
| 2. High-Frequency Network Device CLI Commands | High-frequency CLI command executions, as in APT41. | - Network Device Logs (DS0003: Syslog)<br>- Metrics | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") \| timechart span=1h count by dest_host, command \| where count > avg(count)*3`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName, AdditionalFields.Command \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name, event.command \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Network Device CLI Commands Outside Business Hours | CLI commands executed outside business hours, as in APT29. | - Network Device Logs (DS0003: Syslog) | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") AND (_time < "08:00" OR _time > "18:00") \| stats count by src_ip, dest_host, command \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by RemoteIP, DeviceName, AdditionalFields.Command \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY source.ip, host.name, event.command HAVING COUNT() > 5`. |
| 4. Network Device CLI Commands Triggering Suspicious Actions | CLI commands triggering suspicious configuration changes, as in Cobalt Strike. | - Network Device Logs (DS0003: Syslog) | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") command IN ("*config t*", "*set policy*") \| stats count by src_ip, dest_host, command \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") and AdditionalFields.Command has_any ("config t", "set policy") \| summarize count() by RemoteIP, DeviceName, AdditionalFields.Command \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] AND event.command : ("*config t*" OR "*set policy*") \| STATS COUNT() BY source.ip, host.name, event.command HAVING COUNT() > 5`. |
| 5. Network Device CLI Commands from Anomalous Locations | CLI commands from unexpected geographic locations, as in FIN7. | - Network Device Logs (DS0003: Syslog)<br>- GeoIP Data | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") AND src_geo NOT IN (trusted_locations) \| stats count by src_geo, dest_host, command \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") and GeoLocation !in (trustedLocations) \| summarize count() by GeoLocation, DeviceName, AdditionalFields.Command \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY source.geo.location, host.name, event.command HAVING COUNT() > 5`. |
| 6. Network Device CLI Commands in Cloud Environments | CLI commands executed on cloud-managed network devices, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Device Logs (DS0003) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("ExecuteCommand", "ModifyConfig") AND device_type IN ("cisco", "juniper") AND src_ip NOT IN (trusted_ips) \| stats count by src_ip, device_name, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ExecuteCommand", "ModifyConfig") and DeviceType has_any ("cisco", "juniper") and ClientIP !in (trustedIPs) \| summarize count() by ClientIP, DeviceName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['ExecuteCommand', 'ModifyConfig'] AND event.device IN ['cisco', 'juniper'] AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, event.device, event.action HAVING COUNT() > 5`. |
| 7. Network Device CLI Commands with Suspicious User Agents | CLI commands accessed with non-standard user agents, as in Volt Typhoon. | - Network Device Logs (DS0003: Syslog)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by dest_host, command, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by DeviceName, AdditionalFields.Command, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY host.name, event.command, http.user_agent HAVING COUNT() > 5`. |
| 8. Network Device CLI Commands Followed by Config Changes | CLI commands leading to suspicious configuration changes, as in APT41. | - Network Device Logs (DS0003: Syslog) | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") command IN ("*write memory*", "*commit*") \| stats count by src_ip, dest_host, command \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") and AdditionalFields.Command has_any ("write memory", "commit") \| summarize count() by RemoteIP, DeviceName, AdditionalFields.Command \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] AND event.command : ("*write memory*" OR "*commit*") \| STATS COUNT() BY source.ip, host.name, event.command HAVING COUNT() > 5`. |
| 9. Network Device CLI Commands with Anomalous Protocols | CLI commands executed via non-standard protocols, as in 2025 trends. | - Network Device Logs (DS0003: Syslog)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("ssh", "telnet")] \| stats count by dest_host, command, service \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("ssh", "telnet")) on DeviceName \| summarize count() by DeviceName, AdditionalFields.Command, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['ssh', 'telnet'] \| STATS COUNT() BY host.name, event.command, network.protocol HAVING COUNT() > 5`. |
| 10. Network Device CLI Commands via Known Vulnerable Services | CLI commands executed via vulnerable services, as in FIN7. | - Network Device Logs (DS0003: Syslog)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=syslog source IN ("*cisco:ios", "*juniper:syslog") AND service IN (known_vuln_services) \| stats count by src_ip, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceType has_any ("cisco", "juniper") and AdditionalFields.Service in (knownVulnServices) \| summarize count() by RemoteIP, DeviceName, AdditionalFields.Service \| where count_ > 5`.<br>- **ELK**: `FROM logs-network.syslog-* \| WHERE event.module IN ['cisco', 'juniper'] AND event.service IN ['known_vuln_services'] \| STATS COUNT() BY source.ip, host.name, event.service HAVING COUNT() > 5`. |

### T1059.009: Cloud API

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Cloud API Calls from Suspicious IPs | Adversaries execute Cloud API calls from known malicious IPs, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances", "CreateUser") AND src_ip IN (threat_intel_ips) \| stats count by user, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances", "CreateUser") and ClientIP in (threatIntelIPs) \| summarize count() by Account, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances', 'CreateUser'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY user.name, source.ip, event.action HAVING COUNT() > 5`. |
| 2. High-Frequency Cloud API Calls | High-frequency Cloud API calls, as in APT41. | - Cloud Audit Logs (AWS IAM, Azure AD) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances", "CreateUser") \| timechart span=1h count by user, eventName \| where count > avg(count)*3`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances", "CreateUser") \| summarize HourlyCount=count() by bin(Timestamp, 1h), Account, ActionType \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances', 'CreateUser'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), user.name, event.action \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Cloud API Calls Outside Business Hours | Cloud API calls executed outside business hours, as in APT29. | - Cloud Audit Logs (AWS IAM, Azure AD) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances", "CreateUser") AND (_time < "08:00" OR _time > "18:00") \| stats count by user, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances", "CreateUser") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by Account, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances', 'CreateUser'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY user.name, source.ip, event.action HAVING COUNT() > 5`. |
| 4. Cloud API Calls Triggering Suspicious Actions | Cloud API calls triggering suspicious actions, as in Cobalt Strike. | - Cloud Audit Logs (AWS IAM, Azure AD) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("DeleteUser", "ModifyInstance", "AttachPolicy") \| stats count by user, eventName, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("DeleteUser", "ModifyInstance", "AttachPolicy") \| summarize count() by Account, ActionType, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['DeleteUser', 'ModifyInstance', 'AttachPolicy'] \| STATS COUNT() BY user.name, event.action, source.ip HAVING COUNT() > 5`. |
| 5. Cloud API Calls from Anomalous Locations | Cloud API calls from unexpected geographic locations, as in FIN7. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- GeoIP Data | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances", "CreateUser") AND src_geo NOT IN (trusted_locations) \| stats count by user, src_geo, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances", "CreateUser") and GeoLocation !in (trustedLocations) \| summarize count() by Account, GeoLocation, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances', 'CreateUser'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY user.name, source.geo.location, event.action HAVING COUNT() > 5`. |
| 6. Cloud API Calls with Suspicious User Agents | Cloud API calls with non-standard user agents, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances", "CreateUser") \| join src_ip [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by user, src_ip, user_agent \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances", "CreateUser") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on ClientIP \| summarize count() by Account, ClientIP, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances', 'CreateUser'] \| JOIN logs-zeek.http-* ON source.ip WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY user.name, source.ip, http.user_agent HAVING COUNT() > 5`. |
| 7. Cloud API Calls Followed by File Creation | Cloud API calls leading to suspicious file creation, as in APT41. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances") \| join user [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.zip", "*.scr")] \| stats count by user, FileName, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".zip", ".scr")) on Account \| summarize count() by Account, FileName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances'] \| JOIN logs-endpoint.file-* ON user.name WHERE file.name : ("*.exe" OR "*.zip" OR "*.scr") \| STATS COUNT() BY user.name, file.name, event.action HAVING COUNT() > 5`. |
| 8. Cloud API Calls with High Rate Limits | Cloud API calls exceeding rate limits, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("APICall") \| timechart span=1m count by user \| where count > rate_limit_threshold`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("APICall") \| summarize MinuteCount=count() by bin(Timestamp, 1m), Account \| where MinuteCount > rateLimitThreshold`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['APICall'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), user.name \| WHERE COUNT() > rate_limit_threshold`. |
| 9. Cloud API Calls with Anomalous Patterns | Cloud API calls with repetitive or scripted patterns, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances", "CreateUser") \| timechart span=1s count by user \| where count > avg(count)*5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances", "CreateUser") \| summarize SecondCount=count() by bin(Timestamp, 1s), Account \| where SecondCount > avg(SecondCount) * 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances', 'CreateUser'] \| STATS COUNT() BY date_histogram(@timestamp, '1s'), user.name \| WHERE COUNT() > AVG(COUNT()) * 5`. |
| 10. Cloud API Calls via Known Vulnerable Services | Cloud API calls via vulnerable services, as in FIN7. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("CreateInstance", "RunInstances", "CreateUser") AND service IN (known_vuln_services) \| stats count by user, service, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateInstance", "RunInstances", "CreateUser") and ServiceName in (knownVulnServices) \| summarize count() by Account, ServiceName, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['CreateInstance', 'RunInstances', 'CreateUser'] AND event.service IN ['known_vuln_services'] \| STATS COUNT() BY user.name, event.service, source.ip HAVING COUNT() > 5`. |


### T1106: Native API

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Native API Calls from Suspicious IPs | Adversaries use Native API calls from malicious IPs, as seen in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Native API Calls | High-frequency Native API calls, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Native API Calls Outside Business Hours | Native API executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Native API Calls Triggering Suspicious Processes | Native API calls spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*rundll32.exe*", "*regsvr32.exe*") Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Native API Calls from Anomalous Locations | Native API calls from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Native API Calls in Cloud Environments | Native API calls in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*rundll32.exe*", "*regsvr32.exe*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("rundll32.exe", "regsvr32.exe") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Native API Calls with Suspicious User Agents | Native API calls with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Native API Calls Followed by File Creation | Native API calls leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Native API Calls with Anomalous Protocols | Native API calls executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Native API Calls via Known Vulnerable Services | Native API calls executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe*", "*regsvr32.exe*") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe*" OR "*regsvr32.exe*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1204: User Execution
### T1204.001: Malicious Link

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Malicious Link Access from Suspicious IPs | Users access malicious links from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0029: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) AND src_ip IN (threat_intel_ips) \| stats count by src_ip, uri, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) and RemoteIP in (threatIntelIPs) \| summarize count() by RemoteIP, AdditionalFields.Uri, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY source.ip, http.uri, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Malicious Link Access | High-frequency access to malicious links, as in APT41. | - Network Traffic (DS0029: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) \| timechart span=1h count by uri, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) \| summarize HourlyCount=count() by bin(Timestamp, 1h), AdditionalFields.Uri, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), http.uri, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Malicious Link Access Outside Business Hours | Malicious link access outside business hours, as in APT29. | - Network Traffic (DS0029: Zeek HTTP) | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) AND (_time < "08:00" OR _time > "18:00") \| stats count by src_ip, uri, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by RemoteIP, AdditionalFields.Uri, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY source.ip, http.uri, host.name HAVING COUNT() > 5`. |
| 4. Malicious Link Access Triggering Suspicious Processes | Malicious link access followed by suspicious process execution, as in Cobalt Strike. | - Network Traffic (DS0029: Zeek HTTP)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by src_ip, uri, Image \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by RemoteIP, AdditionalFields.Uri, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY source.ip, http.uri, process.executable HAVING COUNT() > 5`. |
| 5. Malicious Link Access from Anomalous Locations | Malicious link access from unexpected geographic locations, as in FIN7. | - Network Traffic (DS0029: Zeek HTTP)<br>- GeoIP Data | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) AND src_geo NOT IN (trusted_locations) \| stats count by src_geo, uri, dest_host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) and GeoLocation !in (trustedLocations) \| summarize count() by GeoLocation, AdditionalFields.Uri, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY source.geo.location, http.uri, host.name HAVING COUNT() > 5`. |
| 6. Malicious Link Access in Cloud Environments | Malicious link access in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0029: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("AccessResource") AND uri IN (threat_intel_urls) AND src_ip NOT IN (trusted_ips) \| stats count by src_ip, uri, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("AccessResource") and AdditionalFields.Uri in (threatIntelUrls) and ClientIP !in (trustedIPs) \| summarize count() by ClientIP, AdditionalFields.Uri, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['AccessResource'] AND http.uri IN ['threat_intel_urls'] AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, http.uri, event.action HAVING COUNT() > 5`. |
| 7. Malicious Link Access with Suspicious User Agents | Malicious link access with non-standard user agents, as in Volt Typhoon. | - Network Traffic (DS0029: Zeek HTTP) | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) AND user_agent NOT IN (known_agents) \| stats count by src_ip, uri, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) and AdditionalFields.UserAgent !in (knownAgents) \| summarize count() by RemoteIP, AdditionalFields.Uri, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] AND http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY source.ip, http.uri, http.user_agent HAVING COUNT() > 5`. |
| 8. Malicious Link Access Followed by File Creation | Malicious link access leading to suspicious file creation, as in APT41. | - Network Traffic (DS0029: Zeek HTTP)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.zip")] \| stats count by src_ip, uri, FileName \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".zip")) on DeviceName \| summarize count() by RemoteIP, AdditionalFields.Uri, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.zip") \| STATS COUNT() BY source.ip, http.uri, file.name HAVING COUNT() > 5`. |
| 9. Malicious Link Access with Anomalous Protocols | Malicious link access via non-standard protocols, as in 2025 trends. | - Network Traffic (DS0029: Zeek Conn) | - **Splunk**: `index=network sourcetype=zeek_conn uri IN (threat_intel_urls) AND service NOT IN ("http", "https") \| stats count by src_ip, uri, service \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) and Protocol !in ("http", "https") \| summarize count() by RemoteIP, AdditionalFields.Uri, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE http.uri IN ['threat_intel_urls'] AND network.protocol NOT IN ['http', 'https'] \| STATS COUNT() BY source.ip, http.uri, network.protocol HAVING COUNT() > 5`. |
| 10. Malicious Link Access via Known Vulnerable Services | Malicious link access via vulnerable services, as in FIN7. | - Network Traffic (DS0029: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http uri IN (threat_intel_urls) AND service IN (known_vuln_services) \| stats count by src_ip, uri, service \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Uri in (threatIntelUrls) and AdditionalFields.Service in (knownVulnServices) \| summarize count() by RemoteIP, AdditionalFields.Uri, AdditionalFields.Service \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri IN ['threat_intel_urls'] AND event.service IN ['known_vuln_services'] \| STATS COUNT() BY source.ip, http.uri, event.service HAVING COUNT() > 5`. |

### T1204.002: Malicious File

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Malicious File Execution from Suspicious IPs | Malicious files executed from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Malicious File Execution | High-frequency execution of malicious files, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Malicious File Execution Outside Business Hours | Malicious file executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Malicious File Execution Triggering Suspicious Processes | Malicious file executions spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*.exe", "*.dll", "*.scr") Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any (".exe", ".dll", ".scr") and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*.exe" OR "*.dll" OR "*.scr") AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Malicious File Execution from Anomalous Locations | Malicious file executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Malicious File Execution in Cloud Environments | Malicious file executions in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*.exe", "*.dll", "*.scr") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any (".exe", ".dll", ".scr") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*.exe" OR "*.dll" OR "*.scr") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Malicious File Execution with Suspicious User Agents | Malicious file executions with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Malicious File Execution Followed by File Creation | Malicious file executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.zip")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".zip")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.zip") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Malicious File Execution with Anomalous Protocols | Malicious file executions via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Malicious File Execution via Known Vulnerable Services | Malicious file executions via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll", "*.scr") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll", ".scr") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll" OR "*.scr") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1204.003: Malicious Image

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Malicious Image Execution from Suspicious IPs | Malicious images executed from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Malicious Image Execution | High-frequency execution of malicious images, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Malicious Image Execution Outside Business Hours | Malicious image executions outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Malicious Image Execution Triggering Suspicious Processes | Malicious image executions spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*.exe", "*.dll") Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any (".exe", ".dll") and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*.exe" OR "*.dll") AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Malicious Image Execution from Anomalous Locations | Malicious image executions from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Malicious Image Execution in Cloud Environments | Malicious image executions in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Malicious Image Execution with Suspicious User Agents | Malicious image executions with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Malicious Image Execution Followed by File Creation | Malicious image executions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.zip")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".zip")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.zip") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Malicious Image Execution with Anomalous Protocols | Malicious image executions via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Malicious Image Execution via Known Vulnerable Services | Malicious image executions via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe", "*.dll") AND CommandLine IN ("*.png", "*.jpg", "*.jpeg") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any (".exe", ".dll") and ProcessCommandLine has_any (".png", ".jpg", ".jpeg") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*.exe" OR "*.dll") AND process.command_line : ("*.png" OR "*.jpg" OR "*.jpeg") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1053: Scheduled Task/Job

### T1053.002: At

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious 'at' Task Creation from Malicious IPs | Adversaries create 'at' tasks from known malicious IPs, as seen in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency 'at' Task Creation | High-frequency 'at' task creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. 'at' Task Creation Outside Business Hours | 'at' tasks created outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. 'at' Tasks Triggering Suspicious Processes | 'at' tasks spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*at.exe" Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "at.exe" and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*at.exe" AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. 'at' Tasks from Anomalous Locations | 'at' tasks created from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. 'at' Tasks in Cloud Environments | 'at' tasks in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*at.exe" AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "at.exe" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*at.exe" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. 'at' Tasks with Suspicious User Agents | 'at' tasks with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. 'at' Tasks Followed by File Creation | 'at' tasks leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. 'at' Tasks with Anomalous Protocols | 'at' tasks executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. 'at' Tasks via Known Vulnerable Services | 'at' tasks executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*at.exe" AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "at.exe" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*at.exe" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1053.003: Cron

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Cron Job Creation from Malicious IPs | Adversaries create cron jobs from known malicious IPs, as in Volt Typhoon. | - File Creation (DS0013: Sysmon ID 11)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") AND src_ip IN (threat_intel_ips) \| stats count by FileName, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by FileName, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY file.name, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Cron Job Modifications | High-frequency cron job modifications, as in APT41. | - File Creation (DS0013: Sysmon ID 11)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") \| timechart span=1h count by FileName, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") \| summarize HourlyCount=count() by bin(Timestamp, 1h), FileName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), file.name, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Cron Job Creation Outside Business Hours | Cron jobs created outside business hours, as in APT29. | - File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") AND (_time < "08:00" OR _time > "18:00") \| stats count by FileName, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by FileName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY file.name, host.name HAVING COUNT() > 5`. |
| 4. Cron Jobs Triggering Suspicious Processes | Cron jobs spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*powershell.exe*", "*cmd.exe*", "*sh*")] \| stats count by FileName, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("powershell.exe", "cmd.exe", "sh")) on DeviceName \| summarize count() by FileName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*powershell.exe*" OR "*cmd.exe*" OR "*sh*") \| STATS COUNT() BY file.name, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Cron Jobs from Anomalous Locations | Cron jobs created from unexpected geographic locations, as in FIN7. | - File Creation (DS0013: Sysmon ID 11)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") AND src_geo NOT IN (trusted_locations) \| stats count by FileName, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") and GeoLocation !in (trustedLocations) \| summarize count() by FileName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY file.name, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Cron Jobs in Cloud Environments | Cron jobs in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- File Creation (DS0013) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("ModifyFile", "CreateFile") AND FileName IN ("*crontab*", "*cron.d/*") AND src_ip NOT IN (trusted_ips) \| stats count by FileName, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyFile", "CreateFile") and FileName has_any ("crontab", "cron.d/") and ClientIP !in (trustedIPs) \| summarize count() by FileName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['ModifyFile', 'CreateFile'] AND file.name : ("*crontab*" OR "*cron.d/*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY file.name, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Cron Jobs with Suspicious User Agents | Cron jobs with non-standard user agents, as in Volt Typhoon. | - File Creation (DS0013: Sysmon ID 11)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by FileName, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by FileName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY file.name, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Cron Jobs Followed by File Creation | Cron jobs leading to suspicious file creation, as in APT41. | - File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.sh", "*.py")] \| stats count by FileName, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".sh", ".py")) on DeviceName \| summarize count() by FileName, DeviceName, FileName1 \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.sh" OR "*.py") \| STATS COUNT() BY file.name, host.name, file.name HAVING COUNT() > 5`. |
| 9. Cron Jobs with Anomalous Protocols | Cron jobs executed via non-standard protocols, as in 2025 trends. | - File Creation (DS0013: Sysmon ID 11)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by FileName, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by FileName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY file.name, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Cron Jobs via Known Vulnerable Services | Cron jobs executed via vulnerable services, as in FIN7. | - File Creation (DS0013: Sysmon ID 11)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*crontab*", "*cron.d/*") AND ParentImage IN (known_vuln_services) \| stats count by FileName, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("crontab", "cron.d/") and InitiatingProcessName in (knownVulnServices) \| summarize count() by FileName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*crontab*" OR "*cron.d/*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY file.name, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1053.005: Scheduled Task

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Scheduled Task Creation from Malicious IPs | Adversaries create scheduled tasks from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Scheduled Task Creation | High-frequency scheduled task creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Scheduled Task Creation Outside Business Hours | Scheduled tasks created outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Scheduled Tasks Triggering Suspicious Processes | Scheduled tasks spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*schtasks.exe" Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "schtasks.exe" and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*schtasks.exe" AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Scheduled Tasks from Anomalous Locations | Scheduled tasks created from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Scheduled Tasks in Cloud Environments | Scheduled tasks in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*schtasks.exe" AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "schtasks.exe" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*schtasks.exe" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Scheduled Tasks with Suspicious User Agents | Scheduled tasks with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Scheduled Tasks Followed by File Creation | Scheduled tasks leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Scheduled Tasks with Anomalous Protocols | Scheduled tasks executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Scheduled Tasks via Known Vulnerable Services | Scheduled tasks executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*schtasks.exe" AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "schtasks.exe" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*schtasks.exe" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1053.006: Systemd Timers

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Systemd Timer Creation from Malicious IPs | Adversaries create systemd timers from known malicious IPs, as in Volt Typhoon. | - File Creation (DS0013: Sysmon ID 11)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") AND src_ip IN (threat_intel_ips) \| stats count by FileName, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by FileName, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY file.name, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Systemd Timer Modifications | High-frequency systemd timer modifications, as in APT41. | - File Creation (DS0013: Sysmon ID 11)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") \| timechart span=1h count by FileName, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") \| summarize HourlyCount=count() by bin(Timestamp, 1h), FileName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), file.name, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Systemd Timer Creation Outside Business Hours | Systemd timers created outside business hours, as in APT29. | - File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") AND (_time < "08:00" OR _time > "18:00") \| stats count by FileName, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by FileName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY file.name, host.name HAVING COUNT() > 5`. |
| 4. Systemd Timers Triggering Suspicious Processes | Systemd timers spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*powershell.exe*", "*cmd.exe*", "*sh*")] \| stats count by FileName, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("powershell.exe", "cmd.exe", "sh")) on DeviceName \| summarize count() by FileName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*powershell.exe*" OR "*cmd.exe*" OR "*sh*") \| STATS COUNT() BY file.name, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Systemd Timers from Anomalous Locations | Systemd timers created from unexpected geographic locations, as in FIN7. | - File Creation (DS0013: Sysmon ID 11)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") AND src_geo NOT IN (trusted_locations) \| stats count by FileName, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") and GeoLocation !in (trustedLocations) \| summarize count() by FileName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY file.name, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Systemd Timers in Cloud Environments | Systemd timers in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- File Creation (DS0013) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("ModifyFile", "CreateFile") AND FileName IN ("*.timer", "*systemd/*") AND src_ip NOT IN (trusted_ips) \| stats count by FileName, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyFile", "CreateFile") and FileName has_any (".timer", "systemd/") and ClientIP !in (trustedIPs) \| summarize count() by FileName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['ModifyFile', 'CreateFile'] AND file.name : ("*.timer" OR "*systemd/*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY file.name, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Systemd Timers with Suspicious User Agents | Systemd timers with non-standard user agents, as in Volt Typhoon. | - File Creation (DS0013: Sysmon ID 11)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by FileName, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by FileName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY file.name, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Systemd Timers Followed by File Creation | Systemd timers leading to suspicious file creation, as in APT41. | - File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.sh", "*.py")] \| stats count by FileName, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".sh", ".py")) on DeviceName \| summarize count() by FileName, DeviceName, FileName1 \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.sh" OR "*.py") \| STATS COUNT() BY file.name, host.name, file.name HAVING COUNT() > 5`. |
| 9. Systemd Timers with Anomalous Protocols | Systemd timers executed via non-standard protocols, as in 2025 trends. | - File Creation (DS0013: Sysmon ID 11)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by FileName, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by FileName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY file.name, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Systemd Timers via Known Vulnerable Services | Systemd timers executed via vulnerable services, as in FIN7. | - File Creation (DS0013: Sysmon ID 11)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.timer", "*systemd/*") AND ParentImage IN (known_vuln_services) \| stats count by FileName, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".timer", "systemd/") and InitiatingProcessName in (knownVulnServices) \| summarize count() by FileName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.timer" OR "*systemd/*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY file.name, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1053.007: Container Orchestration Job

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Container Orchestration Job Creation from Malicious IPs | Adversaries create container orchestration jobs from known malicious IPs, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") AND src_ip IN (threat_intel_ips) \| stats count by user, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") and ClientIP in (threatIntelIPs) \| summarize count() by Account, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY user.name, source.ip, event.action HAVING COUNT() > 5`. |
| 2. High-Frequency Container Orchestration Job Creation | High-frequency container orchestration job creation, as in APT41. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes)<br>- Metrics | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") \| timechart span=1h count by user, eventName \| where count > avg(count)*3`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") \| summarize HourlyCount=count() by bin(Timestamp, 1h), Account, ActionType \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), user.name, event.action \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Container Orchestration Job Creation Outside Business Hours | Container orchestration jobs created outside business hours, as in APT29. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes) | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") AND (_time < "08:00" OR _time > "18:00") \| stats count by user, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by Account, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY user.name, source.ip, event.action HAVING COUNT() > 5`. |
| 4. Container Orchestration Jobs Triggering Suspicious Processes | Container orchestration jobs spawning suspicious processes, as in Cobalt Strike. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") \| join user [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*powershell.exe*", "*cmd.exe*", "*sh*")] \| stats count by user, Image, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("powershell.exe", "cmd.exe", "sh")) on Account \| summarize count() by Account, ProcessName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] \| JOIN logs-endpoint.process-* ON user.name WHERE process.executable : ("*powershell.exe*" OR "*cmd.exe*" OR "*sh*") \| STATS COUNT() BY user.name, process.executable, event.action HAVING COUNT() > 5`. |
| 5. Container Orchestration Jobs from Anomalous Locations | Container orchestration jobs created from unexpected geographic locations, as in FIN7. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes)<br>- GeoIP Data | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") AND src_geo NOT IN (trusted_locations) \| stats count by user, src_geo, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") and GeoLocation !in (trustedLocations) \| summarize count() by Account, GeoLocation, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY user.name, source.geo.location, event.action HAVING COUNT() > 5`. |
| 6. Container Orchestration Jobs with Suspicious User Agents | Container orchestration jobs with non-standard user agents, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") \| join src_ip [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by user, src_ip, user_agent \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on ClientIP \| summarize count() by Account, ClientIP, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] \| JOIN logs-zeek.http-* ON source.ip WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY user.name, source.ip, http.user_agent HAVING COUNT() > 5`. |
| 7. Container Orchestration Jobs Followed by File Creation | Container orchestration jobs leading to suspicious file creation, as in APT41. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") \| join user [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.sh", "*.py")] \| stats count by user, FileName, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".sh", ".py")) on Account \| summarize count() by Account, FileName, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] \| JOIN logs-endpoint.file-* ON user.name WHERE file.name : ("*.exe" OR "*.sh" OR "*.py") \| STATS COUNT() BY user.name, file.name, event.action HAVING COUNT() > 5`. |
| 8. Container Orchestration Jobs with High Rate Limits | Container orchestration jobs exceeding rate limits, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes) | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") \| timechart span=1m count by user \| where count > rate_limit_threshold`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") \| summarize MinuteCount=count() by bin(Timestamp, 1m), Account \| where MinuteCount > rateLimitThreshold`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), user.name \| WHERE COUNT() > rate_limit_threshold`. |
| 9. Container Orchestration Jobs with Anomalous Patterns | Container orchestration jobs with repetitive or scripted patterns, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes) | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") \| timechart span=1s count by user \| where count > avg(count)*5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") \| summarize SecondCount=count() by bin(Timestamp, 1s), Account \| where SecondCount > avg(SecondCount) * 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] \| STATS COUNT() BY date_histogram(@timestamp, '1s'), user.name \| WHERE COUNT() > AVG(COUNT()) * 5`. |
| 10. Container Orchestration Jobs via Known Vulnerable Services | Container orchestration jobs via vulnerable services, as in FIN7. | - Cloud Audit Logs (AWS IAM, Azure AD, Kubernetes)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=kubernetes:api OR sourcetype=aws:eks eventName IN ("CreateJob", "CreateCronJob") AND service IN (known_vuln_services) \| stats count by user, service, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("CreateJob", "CreateCronJob") and ServiceName in (knownVulnServices) \| summarize count() by Account, ServiceName, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-kubernetes.api-* OR logs-aws.eks-* \| WHERE event.action IN ['CreateJob', 'CreateCronJob'] AND event.service IN ['known_vuln_services'] \| STATS COUNT() BY user.name, event.service, source.ip HAVING COUNT() > 5`. |

### T1569: System Services

### T1569.001: Launchctl

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Launchctl Execution from Malicious IPs | Adversaries execute launchctl commands from known malicious IPs, as seen in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*launchctl" AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "launchctl" and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*launchctl" AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Launchctl Execution | High-frequency launchctl command execution, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*launchctl" \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "launchctl" \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*launchctl" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Launchctl Execution Outside Business Hours | Launchctl commands executed outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*launchctl" AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "launchctl" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*launchctl" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Launchctl Triggering Suspicious Processes | Launchctl commands spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*launchctl" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*launchctl" Image IN ("*bash*", "*sh*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "launchctl" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "launchctl" and ProcessName has_any ("bash", "sh")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*launchctl" \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*launchctl" AND process.executable : ("*bash*" OR "*sh*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Launchctl Execution from Anomalous Locations | Launchctl commands executed from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*launchctl" AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "launchctl" and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*launchctl" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Launchctl in Cloud Environments | Launchctl commands in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*launchctl" AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "launchctl" and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*launchctl" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Launchctl with Suspicious User Agents | Launchctl commands with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*launchctl" \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "launchctl" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*launchctl" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Launchctl Followed by File Creation | Launchctl commands leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*launchctl" \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.sh", "*.py", "*.bin")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "launchctl" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".sh", ".py", ".bin")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*launchctl" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.sh" OR "*.py" OR "*.bin") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Launchctl with Anomalous Protocols | Launchctl commands executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*launchctl" \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "launchctl" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*launchctl" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Launchctl via Known Vulnerable Services | Launchctl commands executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*launchctl" AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "launchctl" and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*launchctl" AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1569.002: Service

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Service Creation from Malicious IPs | Adversaries create services from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*sc.exe", "*systemctl") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("sc.exe", "systemctl") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*sc.exe" OR "*systemctl") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Service Creation | High-frequency service creation or modification, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*sc.exe", "*systemctl") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("sc.exe", "systemctl") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*sc.exe" OR "*systemctl") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Service Creation Outside Business Hours | Service creation outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*sc.exe", "*systemctl") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("sc.exe", "systemctl") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*sc.exe" OR "*systemctl") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Services Triggering Suspicious Processes | Services spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*sc.exe", "*systemctl") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*sc.exe", "*systemctl") Image IN ("*powershell.exe*", "*cmd.exe*", "*sh*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("sc.exe", "systemctl") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("sc.exe", "systemctl") and ProcessName has_any ("powershell.exe", "cmd.exe", "sh")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*sc.exe" OR "*systemctl") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*sc.exe" OR "*systemctl") AND process.executable : ("*powershell.exe*" OR "*cmd.exe*" OR "*sh*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Service Creation from Anomalous Locations | Services created from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*sc.exe", "*systemctl") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("sc.exe", "systemctl") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*sc.exe" OR "*systemctl") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Service Creation in Cloud Environments | Service creation in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*sc.exe", "*systemctl") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("sc.exe", "systemctl") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*sc.exe" OR "*systemctl") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Services with Suspicious User Agents | Services created with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*sc.exe", "*systemctl") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("sc.exe", "systemctl") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*sc.exe" OR "*systemctl") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Service Creation Followed by File Creation | Service creation leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*sc.exe", "*systemctl") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.sh")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("sc.exe", "systemctl") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".sh")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*sc.exe" OR "*systemctl") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.sh") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Services with Anomalous Protocols | Services executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*sc.exe", "*systemctl") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "ssh")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("sc.exe", "systemctl") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "ssh")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*sc.exe" OR "*systemctl") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'ssh'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Services via Known Vulnerable Services | Services executed via known vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*sc.exe", "*systemctl") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("sc.exe", "systemctl") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*sc.exe" OR "*systemctl") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1569.003: Windows Service

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Windows Service Creation from Malicious IPs | Adversaries create Windows services from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*sc.exe" AND CommandLine IN ("*create*", "*config*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "sc.exe" and ProcessCommandLine has_any ("create", "config") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*sc.exe" AND process.command_line : ("*create*" OR "*config*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Windows Service Creation | High-frequency Windows service creation or modification, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*sc.exe" AND CommandLine IN ("*create*", "*config*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "sc.exe" and ProcessCommandLine has_any ("create", "config") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*sc.exe" AND process.command_line : ("*create*" OR "*config*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Windows Service Creation Outside Business Hours | Windows service creation outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*sc.exe" AND CommandLine IN ("*create*", "*config*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "sc.exe" and ProcessCommandLine has_any ("create", "config") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*sc.exe" AND process.command_line : ("*create*" OR "*config*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. Windows Services Triggering Suspicious Processes | Windows services spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*sc.exe" AND CommandLine IN ("*create*", "*config*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*sc.exe" Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "sc.exe" and ProcessCommandLine has_any ("create", "config") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "sc.exe" and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*sc.exe" AND process.command_line : ("*create*" OR "*config*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*sc.exe" AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. Windows Service Creation from Anomalous Locations | Windows services created from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*sc.exe" AND CommandLine IN ("*create*", "*config*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "sc.exe" and ProcessCommandLine has_any ("create", "config") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*sc.exe" AND process.command_line : ("*create*" OR "*config*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Windows Service Creation in Cloud Environments | Windows service creation in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*sc.exe" AND CommandLine IN ("*create*", "*config*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "sc.exe" and ProcessCommandLine has_any ("create", "config") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*sc.exe" AND process.command_line : ("*create*" OR "*config*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Windows Services with Suspicious User Agents | Windows services created with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*sc.exe" AND CommandLine IN ("*create*", "*config*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "sc.exe" and ProcessCommandLine has_any ("create", "config") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*sc.exe" AND process.command_line : ("*create*" OR "*config*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Windows Service Creation Followed by File Creation | Windows service creation leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*sc.exe" AND CommandLine IN ("*create*", "*config*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "sc.exe" and ProcessCommandLine has_any ("create", "config") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*sc.exe" AND process.command_line : ("*create*" OR "*config*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. Windows Services with Anomalous Protocols | Windows services executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*sc.exe" AND CommandLine IN ("*create*", "*config*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "sc.exe" and ProcessCommandLine has_any ("create", "config") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*sc.exe" AND process.command_line : ("*create*" OR "*config*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Windows Services via Known Vulnerable Services | Windows services executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*sc.exe" AND CommandLine IN ("*create*", "*config*") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "sc.exe" and ProcessCommandLine has_any ("create", "config") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*sc.exe" AND process.command_line : ("*create*" OR "*config*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1569.004: Remote Services

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Remote Service Execution from Malicious IPs | Adversaries execute remote services from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0029)<br>- Cloud Audit Logs (AWS IAM, Azure AD)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("StartService", "InvokeService") AND src_ip IN (threat_intel_ips) \| stats count by eventName, src_ip, user \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("StartService", "InvokeService") and ClientIP in (threatIntelIPs) \| summarize count() by ActionType, ClientIP, Account \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['StartService', 'InvokeService'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY event.action, source.ip, user.name HAVING COUNT() > 5`. |
| 2. High-Frequency Remote Service Execution | High-frequency remote service execution, as in APT41. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Metrics | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("StartService", "InvokeService") \| timechart span=1h count by eventName, user \| where count > avg(count)*3`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("StartService", "InvokeService") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ActionType, Account \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['StartService', 'InvokeService'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), event.action, user.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Remote Service Execution Outside Business Hours | Remote service execution outside business hours, as in APT29. | - Cloud Audit Logs (AWS IAM, Azure AD) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("StartService", "InvokeService") AND (_time < "08:00" OR _time > "18:00") \| stats count by eventName, src_ip, user \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("StartService", "InvokeService") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ActionType, ClientIP, Account \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['StartService', 'InvokeService'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY event.action, source.ip, user.name HAVING COUNT() > 5`. |
| 4. Remote Services Triggering Suspicious Processes | Remote services spawning suspicious processes, as in Cobalt Strike. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("StartService", "InvokeService") \| join user [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*powershell.exe*", "*cmd.exe*", "*sh*")] \| stats count by eventName, user, Image \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("StartService", "InvokeService") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("powershell.exe", "cmd.exe", "sh")) on Account \| summarize count() by ActionType, Account, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['StartService', 'InvokeService'] \| JOIN logs-endpoint.process-* ON user.name WHERE process.executable : ("*powershell.exe*" OR "*cmd.exe*" OR "*sh*") \| STATS COUNT() BY event.action, user.name, process.executable HAVING COUNT() > 5`. |
| 5. Remote Service Execution from Anomalous Locations | Remote services executed from unexpected geographic locations, as in FIN7. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- GeoIP Data | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("StartService", "InvokeService") AND src_geo NOT IN (trusted_locations) \| stats count by eventName, src_geo, user \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("StartService", "InvokeService") and GeoLocation !in (trustedLocations) \| summarize count() by ActionType, GeoLocation, Account \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['StartService', 'InvokeService'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY event.action, source.geo.location, user.name HAVING COUNT() > 5`. |
| 6. Remote Services with Suspicious User Agents | Remote services executed with non-standard user agents, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("StartService", "InvokeService") \| join src_ip [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by eventName, src_ip, user_agent \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("StartService", "InvokeService") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on ClientIP \| summarize count() by ActionType, ClientIP, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['StartService', 'InvokeService'] \| JOIN logs-zeek.http-* ON source.ip WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY event.action, source.ip, http.user_agent HAVING COUNT() > 5`. |
| 7. Remote Services Followed by File Creation | Remote services leading to suspicious file creation, as in APT41. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("StartService", "InvokeService") \| join user [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.sh")] \| stats count by eventName, user, FileName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("StartService", "InvokeService") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".sh")) on Account \| summarize count() by ActionType, Account, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['StartService', 'InvokeService'] \| JOIN logs-endpoint.file-* ON user.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.sh") \| STATS COUNT() BY event.action, user.name, file.name HAVING COUNT() > 5`. |
| 8. Remote Services with High Rate Limits | Remote services exceeding rate limits, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("StartService", "InvokeService") \| timechart span=1m count by user \| where count > rate_limit_threshold`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("StartService", "InvokeService") \| summarize MinuteCount=count() by bin(Timestamp, 1m), Account \| where MinuteCount > rateLimitThreshold`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['StartService', 'InvokeService'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), user.name \| WHERE COUNT() > rate_limit_threshold`. |
| 9. Remote Services with Anomalous Patterns | Remote services with repetitive or scripted patterns, as in Volt Typhoon. | - Cloud Audit Logs (AWS IAM, Azure AD) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("StartService", "InvokeService") \| timechart span=1s count by user \| where count > avg(count)*5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("StartService", "InvokeService") \| summarize SecondCount=count() by bin(Timestamp, 1s), Account \| where SecondCount > avg(SecondCount) * 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['StartService', 'InvokeService'] \| STATS COUNT() BY date_histogram(@timestamp, '1s'), user.name \| WHERE COUNT() > AVG(COUNT()) * 5`. |
| 10. Remote Services via Known Vulnerable Services | Remote services executed via vulnerable services, as in FIN7. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("StartService", "InvokeService") AND service IN (known_vuln_services) \| stats count by eventName, service, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("StartService", "InvokeService") and ServiceName in (knownVulnServices) \| summarize count() by ActionType, ServiceName, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['StartService', 'InvokeService'] AND event.service IN ['known_vuln_services'] \| STATS COUNT() BY event.action, event.service, source.ip HAVING COUNT() > 5`. |

### T1047: Windows Management Instrumentation

### T1047.001: WMI Event Subscription

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious WMI Event Subscription from Malicious IPs | Adversaries create WMI event subscriptions from known malicious IPs, as seen in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*wmiprvse.exe" AND CommandLine IN ("*eventfilter*", "*eventsubscription*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "wmiprvse.exe" and ProcessCommandLine has_any ("eventfilter", "eventsubscription") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*wmiprvse.exe" AND process.command_line : ("*eventfilter*" OR "*eventsubscription*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency WMI Event Subscription Creation | High-frequency WMI event subscription creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*wmiprvse.exe" AND CommandLine IN ("*eventfilter*", "*eventsubscription*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "wmiprvse.exe" and ProcessCommandLine has_any ("eventfilter", "eventsubscription") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*wmiprvse.exe" AND process.command_line : ("*eventfilter*" OR "*eventsubscription*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. WMI Event Subscription Outside Business Hours | WMI event subscriptions created outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*wmiprvse.exe" AND CommandLine IN ("*eventfilter*", "*eventsubscription*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "wmiprvse.exe" and ProcessCommandLine has_any ("eventfilter", "eventsubscription") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*wmiprvse.exe" AND process.command_line : ("*eventfilter*" OR "*eventsubscription*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. WMI Event Subscriptions Triggering Suspicious Processes | WMI event subscriptions spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*wmiprvse.exe" AND CommandLine IN ("*eventfilter*", "*eventsubscription*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*wmiprvse.exe" Image IN ("*powershell.exe*", "*cmd.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "wmiprvse.exe" and ProcessCommandLine has_any ("eventfilter", "eventsubscription") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "wmiprvse.exe" and ProcessName has_any ("powershell.exe", "cmd.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*wmiprvse.exe" AND process.command_line : ("*eventfilter*" OR "*eventsubscription*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*wmiprvse.exe" AND process.executable : ("*powershell.exe*" OR "*cmd.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. WMI Event Subscriptions from Anomalous Locations | WMI event subscriptions created from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*wmiprvse.exe" AND CommandLine IN ("*eventfilter*", "*eventsubscription*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "wmiprvse.exe" and ProcessCommandLine has_any ("eventfilter", "eventsubscription") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*wmiprvse.exe" AND process.command_line : ("*eventfilter*" OR "*eventsubscription*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. WMI Event Subscriptions in Cloud Environments | WMI event subscriptions in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*wmiprvse.exe" AND CommandLine IN ("*eventfilter*", "*eventsubscription*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "wmiprvse.exe" and ProcessCommandLine has_any ("eventfilter", "eventsubscription") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*wmiprvse.exe" AND process.command_line : ("*eventfilter*" OR "*eventsubscription*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. WMI Event Subscriptions with Suspicious User Agents | WMI event subscriptions with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*wmiprvse.exe" AND CommandLine IN ("*eventfilter*", "*eventsubscription*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "wmiprvse.exe" and ProcessCommandLine has_any ("eventfilter", "eventsubscription") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*wmiprvse.exe" AND process.command_line : ("*eventfilter*" OR "*eventsubscription*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. WMI Event Subscriptions Followed by File Creation | WMI event subscriptions leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*wmiprvse.exe" AND CommandLine IN ("*eventfilter*", "*eventsubscription*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "wmiprvse.exe" and ProcessCommandLine has_any ("eventfilter", "eventsubscription") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*wmiprvse.exe" AND process.command_line : ("*eventfilter*" OR "*eventsubscription*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. WMI Event Subscriptions with Anomalous Protocols | WMI event subscriptions executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*wmiprvse.exe" AND CommandLine IN ("*eventfilter*", "*eventsubscription*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "wmiprvse.exe" and ProcessCommandLine has_any ("eventfilter", "eventsubscription") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*wmiprvse.exe" AND process.command_line : ("*eventfilter*" OR "*eventsubscription*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. WMI Event Subscriptions via Known Vulnerable Services | WMI event subscriptions executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*wmiprvse.exe" AND CommandLine IN ("*eventfilter*", "*eventsubscription*") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "wmiprvse.exe" and ProcessCommandLine has_any ("eventfilter", "eventsubscription") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*wmiprvse.exe" AND process.command_line : ("*eventfilter*" OR "*eventsubscription*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1047.002: PowerShell DDA

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious PowerShell DDA Execution from Malicious IPs | Adversaries execute PowerShell DDA (Dynamic Data Access) via WMI from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND CommandLine IN ("*wmic*", "*Invoke-WmiMethod*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and ProcessCommandLine has_any ("wmic", "Invoke-WmiMethod") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND process.command_line : ("*wmic*" OR "*Invoke-WmiMethod*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency PowerShell DDA Execution | High-frequency PowerShell DDA execution via WMI, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND CommandLine IN ("*wmic*", "*Invoke-WmiMethod*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and ProcessCommandLine has_any ("wmic", "Invoke-WmiMethod") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND process.command_line : ("*wmic*" OR "*Invoke-WmiMethod*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. PowerShell DDA Execution Outside Business Hours | PowerShell DDA execution via WMI outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND CommandLine IN ("*wmic*", "*Invoke-WmiMethod*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and ProcessCommandLine has_any ("wmic", "Invoke-WmiMethod") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND process.command_line : ("*wmic*" OR "*Invoke-WmiMethod*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. PowerShell DDA Triggering Suspicious Processes | PowerShell DDA via WMI spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND CommandLine IN ("*wmic*", "*Invoke-WmiMethod*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*powershell.exe" Image IN ("*cmd.exe*", "*mshta.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and ProcessCommandLine has_any ("wmic", "Invoke-WmiMethod") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName == "powershell.exe" and ProcessName has_any ("cmd.exe", "mshta.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND process.command_line : ("*wmic*" OR "*Invoke-WmiMethod*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : "*powershell.exe" AND process.executable : ("*cmd.exe*" OR "*mshta.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. PowerShell DDA from Anomalous Locations | PowerShell DDA via WMI executed from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND CommandLine IN ("*wmic*", "*Invoke-WmiMethod*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and ProcessCommandLine has_any ("wmic", "Invoke-WmiMethod") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND process.command_line : ("*wmic*" OR "*Invoke-WmiMethod*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. PowerShell DDA in Cloud Environments | PowerShell DDA via WMI in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image="*powershell.exe" AND CommandLine IN ("*wmic*", "*Invoke-WmiMethod*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName == "powershell.exe" and ProcessCommandLine has_any ("wmic", "Invoke-WmiMethod") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : "*powershell.exe" AND process.command_line : ("*wmic*" OR "*Invoke-WmiMethod*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. PowerShell DDA with Suspicious User Agents | PowerShell DDA via WMI with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND CommandLine IN ("*wmic*", "*Invoke-WmiMethod*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and ProcessCommandLine has_any ("wmic", "Invoke-WmiMethod") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND process.command_line : ("*wmic*" OR "*Invoke-WmiMethod*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. PowerShell DDA Followed by File Creation | PowerShell DDA via WMI leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND CommandLine IN ("*wmic*", "*Invoke-WmiMethod*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and ProcessCommandLine has_any ("wmic", "Invoke-WmiMethod") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND process.command_line : ("*wmic*" OR "*Invoke-WmiMethod*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. PowerShell DDA with Anomalous Protocols | PowerShell DDA via WMI executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND CommandLine IN ("*wmic*", "*Invoke-WmiMethod*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and ProcessCommandLine has_any ("wmic", "Invoke-WmiMethod") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND process.command_line : ("*wmic*" OR "*Invoke-WmiMethod*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. PowerShell DDA via Known Vulnerable Services | PowerShell DDA via WMI executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" AND CommandLine IN ("*wmic*", "*Invoke-WmiMethod*") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName == "powershell.exe" and ProcessCommandLine has_any ("wmic", "Invoke-WmiMethod") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*powershell.exe" AND process.command_line : ("*wmic*" OR "*Invoke-WmiMethod*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1047.003: WMI Query

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious WMI Query Execution from Malicious IPs | Adversaries execute WMI queries from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*wmic*query*", "*Get-WmiObject*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("wmic query", "Get-WmiObject") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*wmic*query*" OR "*Get-WmiObject*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency WMI Query Execution | High-frequency WMI query execution, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*wmic*query*", "*Get-WmiObject*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("wmic query", "Get-WmiObject") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*wmic*query*" OR "*Get-WmiObject*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. WMI Query Execution Outside Business Hours | WMI queries executed outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*wmic*query*", "*Get-WmiObject*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("wmic query", "Get-WmiObject") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*wmic*query*" OR "*Get-WmiObject*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. WMI Queries Triggering Suspicious Processes | WMI queries spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*wmic*query*", "*Get-WmiObject*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*wmic.exe", "*powershell.exe") Image IN ("*cmd.exe*", "*mshta.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("wmic query", "Get-WmiObject") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("wmic.exe", "powershell.exe") and ProcessName has_any ("cmd.exe", "mshta.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*wmic*query*" OR "*Get-WmiObject*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*wmic.exe" OR "*powershell.exe") AND process.executable : ("*cmd.exe*" OR "*mshta.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. WMI Queries from Anomalous Locations | WMI queries executed from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*wmic*query*", "*Get-WmiObject*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("wmic query", "Get-WmiObject") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*wmic*query*" OR "*Get-WmiObject*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. WMI Queries in Cloud Environments | WMI queries in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*wmic*query*", "*Get-WmiObject*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("wmic query", "Get-WmiObject") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*wmic*query*" OR "*Get-WmiObject*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. WMI Queries with Suspicious User Agents | WMI queries with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*wmic*query*", "*Get-WmiObject*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("wmic query", "Get-WmiObject") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*wmic*query*" OR "*Get-WmiObject*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. WMI Queries Followed by File Creation | WMI queries leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*wmic*query*", "*Get-WmiObject*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("wmic query", "Get-WmiObject") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*wmic*query*" OR "*Get-WmiObject*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. WMI Queries with Anomalous Protocols | WMI queries executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*wmic*query*", "*Get-WmiObject*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("wmic query", "Get-WmiObject") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*wmic*query*" OR "*Get-WmiObject*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. WMI Queries via Known Vulnerable Services | WMI queries executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*wmic*query*", "*Get-WmiObject*") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("wmic query", "Get-WmiObject") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*wmic*query*" OR "*Get-WmiObject*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1047.004: WQL

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious WQL Query Execution from Malicious IPs | Adversaries execute WQL queries via WMI from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*SELECT*FROM*", "*WQL*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("SELECT FROM", "WQL") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*SELECT*FROM*" OR "*WQL*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency WQL Query Execution | High-frequency WQL query execution, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*SELECT*FROM*", "*WQL*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("SELECT FROM", "WQL") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*SELECT*FROM*" OR "*WQL*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. WQL Query Execution Outside Business Hours | WQL queries executed outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*SELECT*FROM*", "*WQL*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("SELECT FROM", "WQL") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*SELECT*FROM*" OR "*WQL*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. WQL Queries Triggering Suspicious Processes | WQL queries spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*SELECT*FROM*", "*WQL*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*wmic.exe", "*powershell.exe") Image IN ("*cmd.exe*", "*mshta.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("SELECT FROM", "WQL") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("wmic.exe", "powershell.exe") and ProcessName has_any ("cmd.exe", "mshta.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*SELECT*FROM*" OR "*WQL*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*wmic.exe" OR "*powershell.exe") AND process.executable : ("*cmd.exe*" OR "*mshta.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. WQL Queries from Anomalous Locations | WQL queries executed from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*SELECT*FROM*", "*WQL*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("SELECT FROM", "WQL") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*SELECT*FROM*" OR "*WQL*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. WQL Queries in Cloud Environments | WQL queries in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*SELECT*FROM*", "*WQL*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("SELECT FROM", "WQL") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*SELECT*FROM*" OR "*WQL*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. WQL Queries with Suspicious User Agents | WQL queries with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*SELECT*FROM*", "*WQL*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("SELECT FROM", "WQL") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*SELECT*FROM*" OR "*WQL*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. WQL Queries Followed by File Creation | WQL queries leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*SELECT*FROM*", "*WQL*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("SELECT FROM", "WQL") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*SELECT*FROM*" OR "*WQL*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. WQL Queries with Anomalous Protocols | WQL queries executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*SELECT*FROM*", "*WQL*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("SELECT FROM", "WQL") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*SELECT*FROM*" OR "*WQL*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. WQL Queries via Known Vulnerable Services | WQL queries executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*SELECT*FROM*", "*WQL*") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("SELECT FROM", "WQL") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*SELECT*FROM*" OR "*WQL*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1047.005: CIM/WMI Queries

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious CIM/WMI Query Execution from Malicious IPs | Adversaries execute CIM/WMI queries from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*Win32_*", "*CIM_*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("Win32_", "CIM_") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*Win32_*" OR "*CIM_*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency CIM/WMI Query Execution | High-frequency CIM/WMI query execution, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*Win32_*", "*CIM_*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("Win32_", "CIM_") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*Win32_*" OR "*CIM_*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. CIM/WMI Query Execution Outside Business Hours | CIM/WMI queries executed outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*Win32_*", "*CIM_*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("Win32_", "CIM_") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*Win32_*" OR "*CIM_*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. CIM/WMI Queries Triggering Suspicious Processes | CIM/WMI queries spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*Win32_*", "*CIM_*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*wmic.exe", "*powershell.exe") Image IN ("*cmd.exe*", "*mshta.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("Win32_", "CIM_") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("wmic.exe", "powershell.exe") and ProcessName has_any ("cmd.exe", "mshta.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*Win32_*" OR "*CIM_*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*wmic.exe" OR "*powershell.exe") AND process.executable : ("*cmd.exe*" OR "*mshta.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. CIM/WMI Queries from Anomalous Locations | CIM/WMI queries executed from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*Win32_*", "*CIM_*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("Win32_", "CIM_") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*Win32_*" OR "*CIM_*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. CIM/WMI Queries in Cloud Environments | CIM/WMI queries in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*Win32_*", "*CIM_*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("Win32_", "CIM_") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*Win32_*" OR "*CIM_*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. CIM/WMI Queries with Suspicious User Agents | CIM/WMI queries with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*Win32_*", "*CIM_*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("Win32_", "CIM_") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*Win32_*" OR "*CIM_*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. CIM/WMI Queries Followed by File Creation | CIM/WMI queries leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*Win32_*", "*CIM_*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("Win32_", "CIM_") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*Win32_*" OR "*CIM_*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. CIM/WMI Queries with Anomalous Protocols | CIM/WMI queries executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*Win32_*", "*CIM_*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("Win32_", "CIM_") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*Win32_*" OR "*CIM_*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. CIM/WMI Queries via Known Vulnerable Services | CIM/WMI queries executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*Win32_*", "*CIM_*") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("Win32_", "CIM_") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*Win32_*" OR "*CIM_*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |


### T1047.006: WCF Enumeration

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious WCF Enumeration from Malicious IPs | Adversaries perform WCF (Windows Communication Foundation) enumeration via WMI from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*WCF*", "*Win32_Service*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("WCF", "Win32_Service") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*WCF*" OR "*Win32_Service*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency WCF Enumeration | High-frequency WCF enumeration via WMI, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*WCF*", "*Win32_Service*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("WCF", "Win32_Service") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*WCF*" OR "*Win32_Service*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. WCF Enumeration Outside Business Hours | WCF enumeration via WMI outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*WCF*", "*Win32_Service*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("WCF", "Win32_Service") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*WCF*" OR "*Win32_Service*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. WCF Enumeration Triggering Suspicious Processes | WCF enumeration spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*WCF*", "*Win32_Service*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*wmic.exe", "*powershell.exe") Image IN ("*cmd.exe*", "*mshta.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("WCF", "Win32_Service") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("wmic.exe", "powershell.exe") and ProcessName has_any ("cmd.exe", "mshta.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*WCF*" OR "*Win32_Service*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*wmic.exe" OR "*powershell.exe") AND process.executable : ("*cmd.exe*" OR "*mshta.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. WCF Enumeration from Anomalous Locations | WCF enumeration executed from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*WCF*", "*Win32_Service*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("WCF", "Win32_Service") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*WCF*" OR "*Win32_Service*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. WCF Enumeration in Cloud Environments | WCF enumeration in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*WCF*", "*Win32_Service*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("WCF", "Win32_Service") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*WCF*" OR "*Win32_Service*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. WCF Enumeration with Suspicious User Agents | WCF enumeration with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*WCF*", "*Win32_Service*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("WCF", "Win32_Service") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*WCF*" OR "*Win32_Service*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. WCF Enumeration Followed by File Creation | WCF enumeration leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*WCF*", "*Win32_Service*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("WCF", "Win32_Service") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*WCF*" OR "*Win32_Service*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. WCF Enumeration with Anomalous Protocols | WCF enumeration executed via non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*WCF*", "*Win32_Service*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("WCF", "Win32_Service") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*WCF*" OR "*Win32_Service*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. WCF Enumeration via Known Vulnerable Services | WCF enumeration executed via vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*wmic.exe", "*powershell.exe") AND CommandLine IN ("*WCF*", "*Win32_Service*") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("wmic.exe", "powershell.exe") and ProcessCommandLine has_any ("WCF", "Win32_Service") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*wmic.exe" OR "*powershell.exe") AND process.command_line : ("*WCF*" OR "*Win32_Service*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1610: Deploy Container
### T1610.001: Malicious Image

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Malicious Image Deployment from Malicious IPs | Adversaries deploy malicious container images from known malicious IPs, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("RunContainer", "PullImage") AND src_ip IN (threat_intel_ips) \| stats count by eventName, src_ip, image_name \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunContainer", "PullImage") and ClientIP in (threatIntelIPs) \| summarize count() by ActionType, ClientIP, ImageName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['RunContainer', 'PullImage'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY event.action, source.ip, container.image.name HAVING COUNT() > 5`. |
| 2. High-Frequency Malicious Image Pulls | High-frequency pulling or deployment of container images, as in APT41. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Metrics | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("RunContainer", "PullImage") \| timechart span=1h count by eventName, image_name \| where count > avg(count)*3`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunContainer", "PullImage") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ActionType, ImageName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['RunContainer', 'PullImage'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), event.action, container.image.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Malicious Image Deployment Outside Business Hours | Malicious image deployment outside business hours, as in APT29. | - Cloud Audit Logs (AWS ECS, Azure AKS) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("RunContainer", "PullImage") AND (_time < "08:00" OR _time > "18:00") \| stats count by eventName, image_name, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunContainer", "PullImage") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ActionType, ImageName, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['RunContainer', 'PullImage'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY event.action, container.image.name, source.ip HAVING COUNT() > 5`. |
| 4. Malicious Image Triggering Suspicious Processes | Malicious images spawning suspicious processes, as in Cobalt Strike. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("RunContainer", "PullImage") \| join image_name [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*bash*", "*sh*", "*powershell.exe*")] \| stats count by eventName, image_name, Image \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunContainer", "PullImage") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("bash", "sh", "powershell.exe")) on ImageName \| summarize count() by ActionType, ImageName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['RunContainer', 'PullImage'] \| JOIN logs-endpoint.process-* ON container.image.name WHERE process.executable : ("*bash*" OR "*sh*" OR "*powershell.exe*") \| STATS COUNT() BY event.action, container.image.name, process.executable HAVING COUNT() > 5`. |
| 5. Malicious Image Deployment from Anomalous Locations | Malicious images deployed from unexpected geographic locations, as in FIN7. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- GeoIP Data | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("RunContainer", "PullImage") AND src_geo NOT IN (trusted_locations) \| stats count by eventName, src_geo, image_name \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunContainer", "PullImage") and GeoLocation !in (trustedLocations) \| summarize count() by ActionType, GeoLocation, ImageName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['RunContainer', 'PullImage'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY event.action, source.geo.location, container.image.name HAVING COUNT() > 5`. |
| 6. Malicious Image Deployment with Suspicious User Agents | Malicious images deployed with non-standard user agents, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("RunContainer", "PullImage") \| join src_ip [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by eventName, src_ip, user_agent \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunContainer", "PullImage") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on ClientIP \| summarize count() by ActionType, ClientIP, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['RunContainer', 'PullImage'] \| JOIN logs-zeek.http-* ON source.ip WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY event.action, source.ip, http.user_agent HAVING COUNT() > 5`. |
| 7. Malicious Image Deployment Followed by File Creation | Malicious image deployment leading to suspicious file creation, as in APT41. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("RunContainer", "PullImage") \| join image_name [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.sh", "*.py", "*.bin")] \| stats count by eventName, image_name, FileName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunContainer", "PullImage") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".sh", ".py", ".bin")) on ImageName \| summarize count() by ActionType, ImageName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['RunContainer', 'PullImage'] \| JOIN logs-endpoint.file-* ON container.image.name WHERE file.name : ("*.sh" OR "*.py" OR "*.bin") \| STATS COUNT() BY event.action, container.image.name, file.name HAVING COUNT() > 5`. |
| 8. Malicious Image with High Resource Usage | Malicious images causing high CPU/memory usage, as in 2025 trends. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Metrics (CPU, Memory) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("RunContainer", "PullImage") \| join image_name [search index=metrics sourcetype=cloudwatch_metrics cpu_usage > 80 OR memory_usage > 80] \| stats count by eventName, image_name, metric_name \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunContainer", "PullImage") \| join kind=inner (Perf \| where CounterName in ("cpu_usage", "memory_usage") and CounterValue > 80) on ImageName \| summarize count() by ActionType, ImageName, CounterName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['RunContainer', 'PullImage'] \| JOIN logs-metrics-* ON container.image.name WHERE metric.name IN ['cpu_usage', 'memory_usage'] AND metric.value > 80 \| STATS COUNT() BY event.action, container.image.name, metric.name HAVING COUNT() > 5`. |
| 9. Malicious Image with Anomalous Network Patterns | Malicious images initiating anomalous network traffic, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("RunContainer", "PullImage") \| join image_name [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "dns")] \| stats count by eventName, image_name, service \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunContainer", "PullImage") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "dns")) on ImageName \| summarize count() by ActionType, ImageName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['RunContainer', 'PullImage'] \| JOIN logs-zeek.conn-* ON container.image.name WHERE network.protocol NOT IN ['http', 'https', 'dns'] \| STATS COUNT() BY event.action, container.image.name, network.protocol HAVING COUNT() > 5`. |
| 10. Malicious Image via Known Vulnerable Registries | Malicious images pulled from known vulnerable registries, as in FIN7. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("RunContainer", "PullImage") AND image_registry IN (known_vuln_registries) \| stats count by eventName, image_registry, image_name \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunContainer", "PullImage") and ImageRegistry in (knownVulnRegistries) \| summarize count() by ActionType, ImageRegistry, ImageName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['RunContainer', 'PullImage'] AND container.image.registry IN ['known_vuln_registries'] \| STATS COUNT() BY event.action, container.image.registry, container.image.name HAVING COUNT() > 5`. |

### T1609: Container Administration
### T1609.001: Manipulate Container Configuration

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Container Configuration Changes from Malicious IPs | Adversaries manipulate container configurations from known malicious IPs, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("UpdateContainerConfig", "ModifyContainer") AND src_ip IN (threat_intel_ips) \| stats count by eventName, src_ip, container_id \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("UpdateContainerConfig", "ModifyContainer") and ClientIP in (threatIntelIPs) \| summarize count() by ActionType, ClientIP, ContainerID \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['UpdateContainerConfig', 'ModifyContainer'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY event.action, source.ip, container.id HAVING COUNT() > 5`. |
| 2. High-Frequency Container Configuration Changes | High-frequency container configuration changes, as in APT41. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Metrics | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("UpdateContainerConfig", "ModifyContainer") \| timechart span=1h count by eventName, container_id \| where count > avg(count)*3`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("UpdateContainerConfig", "ModifyContainer") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ActionType, ContainerID \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['UpdateContainerConfig', 'ModifyContainer'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), event.action, container.id \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Container Configuration Changes Outside Business Hours | Container configuration changes outside business hours, as in APT29. | - Cloud Audit Logs (AWS ECS, Azure AKS) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("UpdateContainerConfig", "ModifyContainer") AND (_time < "08:00" OR _time > "18:00") \| stats count by eventName, container_id, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("UpdateContainerConfig", "ModifyContainer") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ActionType, ContainerID, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['UpdateContainerConfig', 'ModifyContainer'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY event.action, container.id, source.ip HAVING COUNT() > 5`. |
| 4. Container Configuration Changes Triggering Suspicious Processes | Container configuration changes leading to suspicious process execution, as in Cobalt Strike. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("UpdateContainerConfig", "ModifyContainer") \| join container_id [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*bash*", "*sh*", "*powershell.exe*")] \| stats count by eventName, container_id, Image \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("UpdateContainerConfig", "ModifyContainer") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("bash", "sh", "powershell.exe")) on ContainerID \| summarize count() by ActionType, ContainerID, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['UpdateContainerConfig', 'ModifyContainer'] \| JOIN logs-endpoint.process-* ON container.id WHERE process.executable : ("*bash*" OR "*sh*" OR "*powershell.exe*") \| STATS COUNT() BY event.action, container.id, process.executable HAVING COUNT() > 5`. |
| 5. Container Configuration Changes from Anomalous Locations | Container configuration changes from unexpected geographic locations, as in FIN7. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- GeoIP Data | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("UpdateContainerConfig", "ModifyContainer") AND src_geo NOT IN (trusted_locations) \| stats count by eventName, src_geo, container_id \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("UpdateContainerConfig", "ModifyContainer") and GeoLocation !in (trustedLocations) \| summarize count() by ActionType, GeoLocation, ContainerID \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['UpdateContainerConfig', 'ModifyContainer'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY event.action, source.geo.location, container.id HAVING COUNT() > 5`. |
| 6. Container Configuration Changes with Suspicious User Agents | Container configuration changes with non-standard user agents, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("UpdateContainerConfig", "ModifyContainer") \| join src_ip [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by eventName, src_ip, user_agent \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("UpdateContainerConfig", "ModifyContainer") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on ClientIP \| summarize count() by ActionType, ClientIP, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['UpdateContainerConfig', 'ModifyContainer'] \| JOIN logs-zeek.http-* ON source.ip WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY event.action, source.ip, http.user_agent HAVING COUNT() > 5`. |
| 7. Container Configuration Changes Followed by File Creation | Container configuration changes leading to suspicious file creation, as in APT41. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("UpdateContainerConfig", "ModifyContainer") \| join container_id [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.sh", "*.py", "*.bin")] \| stats count by eventName, container_id, FileName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("UpdateContainerConfig", "ModifyContainer") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".sh", ".py", ".bin")) on ContainerID \| summarize count() by ActionType, ContainerID, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['UpdateContainerConfig', 'ModifyContainer'] \| JOIN logs-endpoint.file-* ON container.id WHERE file.name : ("*.sh" OR "*.py" OR "*.bin") \| STATS COUNT() BY event.action, container.id, file.name HAVING COUNT() > 5`. |
| 8. Container Configuration Changes with High Resource Usage | Container configuration changes causing high CPU/memory usage, as in 2025 trends. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Metrics (CPU, Memory) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("UpdateContainerConfig", "ModifyContainer") \| join container_id [search index=metrics sourcetype=cloudwatch_metrics cpu_usage > 80 OR memory_usage > 80] \| stats count by eventName, container_id, metric_name \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("UpdateContainerConfig", "ModifyContainer") \| join kind=inner (Perf \| where CounterName in ("cpu_usage", "memory_usage") and CounterValue > 80) on ContainerID \| summarize count() by ActionType, ContainerID, CounterName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['UpdateContainerConfig', 'ModifyContainer'] \| JOIN logs-metrics-* ON container.id WHERE metric.name IN ['cpu_usage', 'memory_usage'] AND metric.value > 80 \| STATS COUNT() BY event.action, container.id, metric.name HAVING COUNT() > 5`. |
| 9. Container Configuration Changes with Anomalous Network Patterns | Container configuration changes initiating anomalous network traffic, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("UpdateContainerConfig", "ModifyContainer") \| join container_id [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "dns")] \| stats count by eventName, container_id, service \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("UpdateContainerConfig", "ModifyContainer") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "dns")) on ContainerID \| summarize count() by ActionType, ContainerID, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['UpdateContainerConfig', 'ModifyContainer'] \| JOIN logs-zeek.conn-* ON container.id WHERE network.protocol NOT IN ['http', 'https', 'dns'] \| STATS COUNT() BY event.action, container.id, network.protocol HAVING COUNT() > 5`. |
| 10. Container Configuration Changes via Known Vulnerable Services | Container configuration changes via known vulnerable services, as in FIN7. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("UpdateContainerConfig", "ModifyContainer") AND service IN (known_vuln_services) \| stats count by eventName, service, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("UpdateContainerConfig", "ModifyContainer") and ServiceName in (knownVulnServices) \| summarize count() by ActionType, ServiceName, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['UpdateContainerConfig', 'ModifyContainer'] AND event.service IN ['known_vuln_services'] \| STATS COUNT() BY event.action, event.service, source.ip HAVING COUNT() > 5`. |

### T1609.002: Manipulate Container Image

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Container Image Manipulation from Malicious IPs | Adversaries manipulate container images from known malicious IPs, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("BuildImage", "PushImage") AND src_ip IN (threat_intel_ips) \| stats count by eventName, src_ip, image_name \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("BuildImage", "PushImage") and ClientIP in (threatIntelIPs) \| summarize count() by ActionType, ClientIP, ImageName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['BuildImage', 'PushImage'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY event.action, source.ip, container.image.name HAVING COUNT() > 5`. |
| 2. High-Frequency Container Image Manipulation | High-frequency container image manipulation, as in APT41. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Metrics | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("BuildImage", "PushImage") \| timechart span=1h count by eventName, image_name \| where count > avg(count)*3`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("BuildImage", "PushImage") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ActionType, ImageName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['BuildImage', 'PushImage'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), event.action, container.image.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Container Image Manipulation Outside Business Hours | Container image manipulation outside business hours, as in APT29. | - Cloud Audit Logs (AWS ECS, Azure AKS) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("BuildImage", "PushImage") AND (_time < "08:00" OR _time > "18:00") \| stats count by eventName, image_name, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("BuildImage", "PushImage") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ActionType, ImageName, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['BuildImage', 'PushImage'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY event.action, container.image.name, source.ip HAVING COUNT() > 5`. |
| 4. Container Image Manipulation Triggering Suspicious Processes | Container image manipulation leading to suspicious process execution, as in Cobalt Strike. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("BuildImage", "PushImage") \| join image_name [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*bash*", "*sh*", "*powershell.exe*")] \| stats count by eventName, image_name, Image \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("BuildImage", "PushImage") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("bash", "sh", "powershell.exe")) on ImageName \| summarize count() by ActionType, ImageName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['BuildImage', 'PushImage'] \| JOIN logs-endpoint.process-* ON container.image.name WHERE process.executable : ("*bash*" OR "*sh*" OR "*powershell.exe*") \| STATS COUNT() BY event.action, container.image.name, process.executable HAVING COUNT() > 5`. |
| 5. Container Image Manipulation from Anomalous Locations | Container image manipulation from unexpected geographic locations, as in FIN7. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- GeoIP Data | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("BuildImage", "PushImage") AND src_geo NOT IN (trusted_locations) \| stats count by eventName, src_geo, image_name \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("BuildImage", "PushImage") and GeoLocation !in (trustedLocations) \| summarize count() by ActionType, GeoLocation, ImageName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['BuildImage', 'PushImage'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY event.action, source.geo.location, container.image.name HAVING COUNT() > 5`. |
| 6. Container Image Manipulation with Suspicious User Agents | Container image manipulation with non-standard user agents, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("BuildImage", "PushImage") \| join src_ip [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by eventName, src_ip, user_agent \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("BuildImage", "PushImage") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on ClientIP \| summarize count() by ActionType, ClientIP, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['BuildImage', 'PushImage'] \| JOIN logs-zeek.http-* ON source.ip WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY event.action, source.ip, http.user_agent HAVING COUNT() > 5`. |
| 7. Container Image Manipulation Followed by File Creation | Container image manipulation leading to suspicious file creation, as in APT41. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("BuildImage", "PushImage") \| join image_name [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.sh", "*.py", "*.bin")] \| stats count by eventName, image_name, FileName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("BuildImage", "PushImage") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".sh", ".py", ".bin")) on ImageName \| summarize count() by ActionType, ImageName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['BuildImage', 'PushImage'] \| JOIN logs-endpoint.file-* ON container.image.name WHERE file.name : ("*.sh" OR "*.py" OR "*.bin") \| STATS COUNT() BY event.action, container.image.name, file.name HAVING COUNT() > 5`. |
| 8. Container Image Manipulation with High Resource Usage | Container image manipulation causing high CPU/memory usage, as in 2025 trends. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Metrics (CPU, Memory) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("BuildImage", "PushImage") \| join image_name [search index=metrics sourcetype=cloudwatch_metrics cpu_usage > 80 OR memory_usage > 80] \| stats count by eventName, image_name, metric_name \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("BuildImage", "PushImage") \| join kind=inner (Perf \| where CounterName in ("cpu_usage", "memory_usage") and CounterValue > 80) on ImageName \| summarize count() by ActionType, ImageName, CounterName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['BuildImage', 'PushImage'] \| JOIN logs-metrics-* ON container.image.name WHERE metric.name IN ['cpu_usage', 'memory_usage'] AND metric.value > 80 \| STATS COUNT() BY event.action, container.image.name, metric.name HAVING COUNT() > 5`. |
| 9. Container Image Manipulation with Anomalous Network Patterns | Container image manipulation initiating anomalous network traffic, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("BuildImage", "PushImage") \| join image_name [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "dns")] \| stats count by eventName, image_name, service \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("BuildImage", "PushImage") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "dns")) on ImageName \| summarize count() by ActionType, ImageName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['BuildImage', 'PushImage'] \| JOIN logs-zeek.conn-* ON container.image.name WHERE network.protocol NOT IN ['http', 'https', 'dns'] \| STATS COUNT() BY event.action, container.image.name, network.protocol HAVING COUNT() > 5`. |
| 10. Container Image Manipulation via Known Vulnerable Registries | Container images manipulated via known vulnerable registries, as in FIN7. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("BuildImage", "PushImage") AND image_registry IN (known_vuln_registries) \| stats count by eventName, image_registry, image_name \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("BuildImage", "PushImage") and ImageRegistry in (knownVulnRegistries) \| summarize count() by ActionType, ImageRegistry, ImageName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['BuildImage', 'PushImage'] AND container.image.registry IN ['known_vuln_registries'] \| STATS COUNT() BY event.action, container.image.registry, container.image.name HAVING COUNT() > 5`. |

### T1609.003: Manipulate Container Runtime

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Container Runtime Manipulation from Malicious IPs | Adversaries manipulate container runtimes from known malicious IPs, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("ModifyRuntime", "UpdateRuntimeConfig") AND src_ip IN (threat_intel_ips) \| stats count by eventName, src_ip, container_id \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyRuntime", "UpdateRuntimeConfig") and ClientIP in (threatIntelIPs) \| summarize count() by ActionType, ClientIP, ContainerID \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['ModifyRuntime', 'UpdateRuntimeConfig'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY event.action, source.ip, container.id HAVING COUNT() > 5`. |
| 2. High-Frequency Container Runtime Manipulation | High-frequency container runtime manipulation, as in APT41. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Metrics | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("ModifyRuntime", "UpdateRuntimeConfig") \| timechart span=1h count by eventName, container_id \| where count > avg(count)*3`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyRuntime", "UpdateRuntimeConfig") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ActionType, ContainerID \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['ModifyRuntime', 'UpdateRuntimeConfig'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), event.action, container.id \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Container Runtime Manipulation Outside Business Hours | Container runtime manipulation outside business hours, as in APT29. | - Cloud Audit Logs (AWS ECS, Azure AKS) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("ModifyRuntime", "UpdateRuntimeConfig") AND (_time < "08:00" OR _time > "18:00") \| stats count by eventName, container_id, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyRuntime", "UpdateRuntimeConfig") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ActionType, ContainerID, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['ModifyRuntime', 'UpdateRuntimeConfig'] AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY event.action, container.id, source.ip HAVING COUNT() > 5`. |
| 4. Container Runtime Manipulation Triggering Suspicious Processes | Container runtime manipulation leading to suspicious process execution, as in Cobalt Strike. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("ModifyRuntime", "UpdateRuntimeConfig") \| join container_id [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*bash*", "*sh*", "*powershell.exe*")] \| stats count by eventName, container_id, Image \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyRuntime", "UpdateRuntimeConfig") \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("bash", "sh", "powershell.exe")) on ContainerID \| summarize count() by ActionType, ContainerID, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['ModifyRuntime', 'UpdateRuntimeConfig'] \| JOIN logs-endpoint.process-* ON container.id WHERE process.executable : ("*bash*" OR "*sh*" OR "*powershell.exe*") \| STATS COUNT() BY event.action, container.id, process.executable HAVING COUNT() > 5`. |
| 5. Container Runtime Manipulation from Anomalous Locations | Container runtime manipulation from unexpected geographic locations, as in FIN7. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- GeoIP Data | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("ModifyRuntime", "UpdateRuntimeConfig") AND src_geo NOT IN (trusted_locations) \| stats count by eventName, src_geo, container_id \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyRuntime", "UpdateRuntimeConfig") and GeoLocation !in (trustedLocations) \| summarize count() by ActionType, GeoLocation, ContainerID \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['ModifyRuntime', 'UpdateRuntimeConfig'] AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY event.action, source.geo.location, container.id HAVING COUNT() > 5`. |
| 6. Container Runtime Manipulation with Suspicious User Agents | Container runtime manipulation with non-standard user agents, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("ModifyRuntime", "UpdateRuntimeConfig") \| join src_ip [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by eventName, src_ip, user_agent \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyRuntime", "UpdateRuntimeConfig") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on ClientIP \| summarize count() by ActionType, ClientIP, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['ModifyRuntime', 'UpdateRuntimeConfig'] \| JOIN logs-zeek.http-* ON source.ip WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY event.action, source.ip, http.user_agent HAVING COUNT() > 5`. |
| 7. Container Runtime Manipulation Followed by File Creation | Container runtime manipulation leading to suspicious file creation, as in APT41. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("ModifyRuntime", "UpdateRuntimeConfig") \| join container_id [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.sh", "*.py", "*.bin")] \| stats count by eventName, container_id, FileName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyRuntime", "UpdateRuntimeConfig") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".sh", ".py", ".bin")) on ContainerID \| summarize count() by ActionType, ContainerID, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['ModifyRuntime', 'UpdateRuntimeConfig'] \| JOIN logs-endpoint.file-* ON container.id WHERE file.name : ("*.sh" OR "*.py" OR "*.bin") \| STATS COUNT() BY event.action, container.id, file.name HAVING COUNT() > 5`. |
| 8. Container Runtime Manipulation with High Resource Usage | Container runtime manipulation causing high CPU/memory usage, as in 2025 trends. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Metrics (CPU, Memory) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("ModifyRuntime", "UpdateRuntimeConfig") \| join container_id [search index=metrics sourcetype=cloudwatch_metrics cpu_usage > 80 OR memory_usage > 80] \| stats count by eventName, container_id, metric_name \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyRuntime", "UpdateRuntimeConfig") \| join kind=inner (Perf \| where CounterName in ("cpu_usage", "memory_usage") and CounterValue > 80) on ContainerID \| summarize count() by ActionType, ContainerID, CounterName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['ModifyRuntime', 'UpdateRuntimeConfig'] \| JOIN logs-metrics-* ON container.id WHERE metric.name IN ['cpu_usage', 'memory_usage'] AND metric.value > 80 \| STATS COUNT() BY event.action, container.id, metric.name HAVING COUNT() > 5`. |
| 9. Container Runtime Manipulation with Anomalous Network Patterns | Container runtime manipulation initiating anomalous network traffic, as in Volt Typhoon. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("ModifyRuntime", "UpdateRuntimeConfig") \| join container_id [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "dns")] \| stats count by eventName, container_id, service \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyRuntime", "UpdateRuntimeConfig") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "dns")) on ContainerID \| summarize count() by ActionType, ContainerID, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['ModifyRuntime', 'UpdateRuntimeConfig'] \| JOIN logs-zeek.conn-* ON container.id WHERE network.protocol NOT IN ['http', 'https', 'dns'] \| STATS COUNT() BY event.action, container.id, network.protocol HAVING COUNT() > 5`. |
| 10. Container Runtime Manipulation via Known Vulnerable Services | Container runtime manipulation via known vulnerable services, as in FIN7. | - Cloud Audit Logs (AWS ECS, Azure AKS)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:ecs OR sourcetype=azure:aks eventName IN ("ModifyRuntime", "UpdateRuntimeConfig") AND service IN (known_vuln_services) \| stats count by eventName, service, src_ip \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("ModifyRuntime", "UpdateRuntimeConfig") and ServiceName in (knownVulnServices) \| summarize count() by ActionType, ServiceName, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.ecs-* OR logs-azure.aks-* \| WHERE event.action IN ['ModifyRuntime', 'UpdateRuntimeConfig'] AND event.service IN ['known_vuln_services'] \| STATS COUNT() BY event.action, event.service, source.ip HAVING COUNT() > 5`. |

### T1559: Inter-Process Communication

### T1559.001: Component Object Model

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious COM Object Execution from Malicious IPs | Adversaries leverage COM objects for malicious execution from known malicious IPs, as seen in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe", "*regsvr32.exe") AND CommandLine IN ("*ole32.dll*", "*combase.dll*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessCommandLine has_any ("ole32.dll", "combase.dll") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe" OR "*regsvr32.exe") AND process.command_line : ("*ole32.dll*" OR "*combase.dll*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency COM Object Execution | High-frequency COM object execution indicating potential abuse, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe", "*regsvr32.exe") AND CommandLine IN ("*ole32.dll*", "*combase.dll*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessCommandLine has_any ("ole32.dll", "combase.dll") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe" OR "*regsvr32.exe") AND process.command_line : ("*ole32.dll*" OR "*combase.dll*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. COM Object Execution Outside Business Hours | COM object execution outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe", "*regsvr32.exe") AND CommandLine IN ("*ole32.dll*", "*combase.dll*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessCommandLine has_any ("ole32.dll", "combase.dll") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe" OR "*regsvr32.exe") AND process.command_line : ("*ole32.dll*" OR "*combase.dll*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. COM Object Execution Spawning Suspicious Processes | COM object execution spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe", "*regsvr32.exe") AND CommandLine IN ("*ole32.dll*", "*combase.dll*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*rundll32.exe", "*regsvr32.exe") Image IN ("*cmd.exe*", "*mshta.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessCommandLine has_any ("ole32.dll", "combase.dll") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessName has_any ("cmd.exe", "mshta.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe" OR "*regsvr32.exe") AND process.command_line : ("*ole32.dll*" OR "*combase.dll*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*rundll32.exe" OR "*regsvr32.exe") AND process.executable : ("*cmd.exe*" OR "*mshta.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. COM Object Execution from Anomalous Locations | COM object execution from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe", "*regsvr32.exe") AND CommandLine IN ("*ole32.dll*", "*combase.dll*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessCommandLine has_any ("ole32.dll", "combase.dll") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe" OR "*regsvr32.exe") AND process.command_line : ("*ole32.dll*" OR "*combase.dll*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. COM Object Execution in Cloud Environments | COM object execution in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*rundll32.exe", "*regsvr32.exe") AND CommandLine IN ("*ole32.dll*", "*combase.dll*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessCommandLine has_any ("ole32.dll", "combase.dll") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*rundll32.exe" OR "*regsvr32.exe") AND process.command_line : ("*ole32.dll*" OR "*combase.dll*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. COM Object Execution with Suspicious User Agents | COM object execution with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe", "*regsvr32.exe") AND CommandLine IN ("*ole32.dll*", "*combase.dll*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessCommandLine has_any ("ole32.dll", "combase.dll") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe" OR "*regsvr32.exe") AND process.command_line : ("*ole32.dll*" OR "*combase.dll*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. COM Object Execution Followed by File Creation | COM object execution leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe", "*regsvr32.exe") AND CommandLine IN ("*ole32.dll*", "*combase.dll*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessCommandLine has_any ("ole32.dll", "combase.dll") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe" OR "*regsvr32.exe") AND process.command_line : ("*ole32.dll*" OR "*combase.dll*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. COM Object Execution with Anomalous Protocols | COM object execution using non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe", "*regsvr32.exe") AND CommandLine IN ("*ole32.dll*", "*combase.dll*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessCommandLine has_any ("ole32.dll", "combase.dll") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe" OR "*regsvr32.exe") AND process.command_line : ("*ole32.dll*" OR "*combase.dll*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. COM Object Execution via Known Vulnerable Services | COM object execution via known vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rundll32.exe", "*regsvr32.exe") AND CommandLine IN ("*ole32.dll*", "*combase.dll*") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("rundll32.exe", "regsvr32.exe") and ProcessCommandLine has_any ("ole32.dll", "combase.dll") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*rundll32.exe" OR "*regsvr32.exe") AND process.command_line : ("*ole32.dll*" OR "*combase.dll*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1559.002: Dynamic Data Exchange

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious DDE Execution from Malicious IPs | Adversaries use DDE for malicious execution from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe", "*word.exe", "*msra.exe") AND CommandLine IN ("*ddeexec*", "*dde*") AND src_ip IN (threat_intel_ips) \| stats count by Image, CommandLine, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("excel.exe", "word.exe", "msra.exe") and ProcessCommandLine has_any ("ddeexec", "dde") and InitiatingProcessRemoteIP in (threatIntelIPs) \| summarize count() by ProcessName, ProcessCommandLine, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*excel.exe" OR "*word.exe" OR "*msra.exe") AND process.command_line : ("*ddeexec*" OR "*dde*") AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY process.executable, process.command_line, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency DDE Execution | High-frequency DDE execution indicating potential abuse, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe", "*word.exe", "*msra.exe") AND CommandLine IN ("*ddeexec*", "*dde*") \| timechart span=1h count by Image, dest_host \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("excel.exe", "word.exe", "msra.exe") and ProcessCommandLine has_any ("ddeexec", "dde") \| summarize HourlyCount=count() by bin(Timestamp, 1h), ProcessName, DeviceName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*excel.exe" OR "*word.exe" OR "*msra.exe") AND process.command_line : ("*ddeexec*" OR "*dde*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), process.executable, host.name \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. DDE Execution Outside Business Hours | DDE execution outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe", "*word.exe", "*msra.exe") AND CommandLine IN ("*ddeexec*", "*dde*") AND (_time < "08:00" OR _time > "18:00") \| stats count by Image, CommandLine, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("excel.exe", "word.exe", "msra.exe") and ProcessCommandLine has_any ("ddeexec", "dde") and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by ProcessName, ProcessCommandLine, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*excel.exe" OR "*word.exe" OR "*msra.exe") AND process.command_line : ("*ddeexec*" OR "*dde*") AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 5`. |
| 4. DDE Execution Spawning Suspicious Processes | DDE execution spawning suspicious child processes, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe", "*word.exe", "*msra.exe") AND CommandLine IN ("*ddeexec*", "*dde*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 ParentImage IN ("*excel.exe", "*word.exe", "*msra.exe") Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by ParentImage, dest_host, Image \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("excel.exe", "word.exe", "msra.exe") and ProcessCommandLine has_any ("ddeexec", "dde") \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessName has_any ("excel.exe", "word.exe", "msra.exe") and ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by InitiatingProcessName, DeviceName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*excel.exe" OR "*word.exe" OR "*msra.exe") AND process.command_line : ("*ddeexec*" OR "*dde*") \| JOIN logs-endpoint.process-* ON host.name WHERE process.parent.executable : ("*excel.exe" OR "*word.exe" OR "*msra.exe") AND process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY process.parent.executable, host.name, process.executable HAVING COUNT() > 5`. |
| 5. DDE Execution from Anomalous Locations | DDE execution from unexpected geographic locations, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe", "*word.exe", "*msra.exe") AND CommandLine IN ("*ddeexec*", "*dde*") AND src_geo NOT IN (trusted_locations) \| stats count by Image, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("excel.exe", "word.exe", "msra.exe") and ProcessCommandLine has_any ("ddeexec", "dde") and GeoLocation !in (trustedLocations) \| summarize count() by ProcessName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*excel.exe" OR "*word.exe" OR "*msra.exe") AND process.command_line : ("*ddeexec*" OR "*dde*") AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY process.executable, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. DDE Execution in Cloud Environments | DDE execution in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Process Creation (DS0009) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") AND Image IN ("*excel.exe", "*word.exe", "*msra.exe") AND CommandLine IN ("*ddeexec*", "*dde*") AND src_ip NOT IN (trusted_ips) \| stats count by Image, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") and ProcessName has_any ("excel.exe", "word.exe", "msra.exe") and ProcessCommandLine has_any ("ddeexec", "dde") and ClientIP !in (trustedIPs) \| summarize count() by ProcessName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] AND process.executable : ("*excel.exe" OR "*word.exe" OR "*msra.exe") AND process.command_line : ("*ddeexec*" OR "*dde*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY process.executable, source.ip, event.action HAVING COUNT() > 5`. |
| 7. DDE Execution with Suspicious User Agents | DDE execution with non-standard user agents, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe", "*word.exe", "*msra.exe") AND CommandLine IN ("*ddeexec*", "*dde*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by Image, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("excel.exe", "word.exe", "msra.exe") and ProcessCommandLine has_any ("ddeexec", "dde") \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by ProcessName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*excel.exe" OR "*word.exe" OR "*msra.exe") AND process.command_line : ("*ddeexec*" OR "*dde*") \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY process.executable, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. DDE Execution Followed by File Creation | DDE execution leading to suspicious file creation, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe", "*word.exe", "*msra.exe") AND CommandLine IN ("*ddeexec*", "*dde*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by Image, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("excel.exe", "word.exe", "msra.exe") and ProcessCommandLine has_any ("ddeexec", "dde") \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by ProcessName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*excel.exe" OR "*word.exe" OR "*msra.exe") AND process.command_line : ("*ddeexec*" OR "*dde*") \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY process.executable, host.name, file.name HAVING COUNT() > 5`. |
| 9. DDE Execution with Anomalous Protocols | DDE execution using non-standard protocols, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe", "*word.exe", "*msra.exe") AND CommandLine IN ("*ddeexec*", "*dde*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by Image, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("excel.exe", "word.exe", "msra.exe") and ProcessCommandLine has_any ("ddeexec", "dde") \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by ProcessName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*excel.exe" OR "*word.exe" OR "*msra.exe") AND process.command_line : ("*ddeexec*" OR "*dde*") \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY process.executable, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. DDE Execution via Known Vulnerable Services | DDE execution via known vulnerable services, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*excel.exe", "*word.exe", "*msra.exe") AND CommandLine IN ("*ddeexec*", "*dde*") AND ParentImage IN (known_vuln_services) \| stats count by Image, ParentImage, dest_host \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("excel.exe", "word.exe", "msra.exe") and ProcessCommandLine has_any ("ddeexec", "dde") and InitiatingProcessName in (knownVulnServices) \| summarize count() by ProcessName, InitiatingProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*excel.exe" OR "*word.exe" OR "*msra.exe") AND process.command_line : ("*ddeexec*" OR "*dde*") AND process.parent.executable IN ['known_vuln_services'] \| STATS COUNT() BY process.executable, process.parent.executable, host.name HAVING COUNT() > 5`. |

### T1559.003: Named Pipe

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Named Pipe Creation from Malicious IPs | Adversaries create named pipes for inter-process communication from known malicious IPs, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- Named Pipe Creation (DS0023: Sysmon ID 17)<br>- Network Traffic (DS0029)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=17 PipeName IN ("*\\\\.\\pipe\\*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 AND src_ip IN (threat_intel_ips)] \| stats count by PipeName, Image, src_ip, dest_host \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "NamedPipeCreated" and AdditionalFields.PipeName has "\\\\.\\pipe\\" \| join kind=inner (DeviceProcessEvents \| where InitiatingProcessRemoteIP in (threatIntelIPs)) on DeviceName \| summarize count() by AdditionalFields.PipeName, ProcessName, InitiatingProcessRemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "17" AND winlog.event_data.PipeName : "*\\\\.\\pipe\\*" \| JOIN logs-endpoint.process-* ON host.name WHERE source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY winlog.event_data.PipeName, process.executable, source.ip, host.name HAVING COUNT() > 5`. |
| 2. High-Frequency Named Pipe Creation | High-frequency named pipe creation indicating potential abuse, as in APT41. | - Named Pipe Creation (DS0023: Sysmon ID 17)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=17 PipeName IN ("*\\\\.\\pipe\\*") \| timechart span=1h count by PipeName, Image \| where count > avg(count)*3`.<br>- **KQL**: `DeviceEvents \| where ActionType == "NamedPipeCreated" and AdditionalFields.PipeName has "\\\\.\\pipe\\" \| summarize HourlyCount=count() by bin(Timestamp, 1h), AdditionalFields.PipeName, ProcessName \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "17" AND winlog.event_data.PipeName : "*\\\\.\\pipe\\*" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), winlog.event_data.PipeName, process.executable \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 3. Named Pipe Creation Outside Business Hours | Named pipe creation outside business hours, as in APT29. | - Named Pipe Creation (DS0023: Sysmon ID 17) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=17 PipeName IN ("*\\\\.\\pipe\\*") AND (_time < "08:00" OR _time > "18:00") \| stats count by PipeName, Image, dest_host \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "NamedPipeCreated" and AdditionalFields.PipeName has "\\\\.\\pipe\\" and (hour(Timestamp) < 8 or hour(Timestamp) > 18) \| summarize count() by AdditionalFields.PipeName, ProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "17" AND winlog.event_data.PipeName : "*\\\\.\\pipe\\*" AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18) \| STATS COUNT() BY winlog.event_data.PipeName, process.executable, host.name HAVING COUNT() > 5`. |
| 4. Named Pipe Creation Spawning Suspicious Processes | Named pipe creation followed by suspicious process execution, as in Cobalt Strike. | - Named Pipe Creation (DS0023: Sysmon ID 17)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=17 PipeName IN ("*\\\\.\\pipe\\*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*")] \| stats count by PipeName, Image, dest_host \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "NamedPipeCreated" and AdditionalFields.PipeName has "\\\\.\\pipe\\" \| join kind=inner (DeviceProcessEvents \| where ProcessName has_any ("cmd.exe", "powershell.exe")) on DeviceName \| summarize count() by AdditionalFields.PipeName, ProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "17" AND winlog.event_data.PipeName : "*\\\\.\\pipe\\*" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable : ("*cmd.exe*" OR "*powershell.exe*") \| STATS COUNT() BY winlog.event_data.PipeName, process.executable, host.name HAVING COUNT() > 5`. |
| 5. Named Pipe Creation from Anomalous Locations | Named pipe creation from unexpected geographic locations, as in FIN7. | - Named Pipe Creation (DS0023: Sysmon ID 17)<br>- GeoIP Data | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=17 PipeName IN ("*\\\\.\\pipe\\*") AND src_geo NOT IN (trusted_locations) \| stats count by PipeName, src_geo, dest_host \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "NamedPipeCreated" and AdditionalFields.PipeName has "\\\\.\\pipe\\" and GeoLocation !in (trustedLocations) \| summarize count() by AdditionalFields.PipeName, GeoLocation, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "17" AND winlog.event_data.PipeName : "*\\\\.\\pipe\\*" AND source.geo.location NOT IN ['trusted_locations'] \| STATS COUNT() BY winlog.event_data.PipeName, source.geo.location, host.name HAVING COUNT() > 5`. |
| 6. Named Pipe Creation in Cloud Environments | Named pipe creation in cloud-managed endpoints, as in 2025 trends. | - Cloud Audit Logs (AWS IAM, Azure AD)<br>- Named Pipe Creation (DS0023: Sysmon ID 17) | - **Splunk**: `index=cloud sourcetype=aws:iam OR sourcetype=azure:ad eventName IN ("RunCommand", "Invoke-Script") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=17 PipeName IN ("*\\\\.\\pipe\\*") AND src_ip NOT IN (trusted_ips)] \| stats count by PipeName, src_ip, eventName \| where count > 5`.<br>- **KQL**: `CloudAppEvents \| where ActionType in ("RunCommand", "Invoke-Script") \| join kind=inner (DeviceEvents \| where ActionType == "NamedPipeCreated" and AdditionalFields.PipeName has "\\\\.\\pipe\\" and ClientIP !in (trustedIPs)) on DeviceName \| summarize count() by AdditionalFields.PipeName, ClientIP, ActionType \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.iam-* OR logs-azure.ad-* \| WHERE event.action IN ['RunCommand', 'Invoke-Script'] \| JOIN logs-endpoint.events-* ON host.name WHERE event.code : "17" AND winlog.event_data.PipeName : "*\\\\.\\pipe\\*" AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY winlog.event_data.PipeName, source.ip, event.action HAVING COUNT() > 5`. |
| 7. Named Pipe Creation with Suspicious User Agents | Named pipe creation with non-standard user agents, as in Volt Typhoon. | - Named Pipe Creation (DS0023: Sysmon ID 17)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=17 PipeName IN ("*\\\\.\\pipe\\*") \| join dest_host [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by PipeName, dest_host, user_agent \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "NamedPipeCreated" and AdditionalFields.PipeName has "\\\\.\\pipe\\" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.UserAgent !in (knownAgents)) on DeviceName \| summarize count() by AdditionalFields.PipeName, DeviceName, AdditionalFields.UserAgent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "17" AND winlog.event_data.PipeName : "*\\\\.\\pipe\\*" \| JOIN logs-zeek.http-* ON host.name WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY winlog.event_data.PipeName, host.name, http.user_agent HAVING COUNT() > 5`. |
| 8. Named Pipe Creation Followed by File Creation | Named pipe creation leading to suspicious file creation, as in APT41. | - Named Pipe Creation (DS0023: Sysmon ID 17)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=17 PipeName IN ("*\\\\.\\pipe\\*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll", "*.scr")] \| stats count by PipeName, dest_host, FileName \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "NamedPipeCreated" and AdditionalFields.PipeName has "\\\\.\\pipe\\" \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll", ".scr")) on DeviceName \| summarize count() by AdditionalFields.PipeName, DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "17" AND winlog.event_data.PipeName : "*\\\\.\\pipe\\*" \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY winlog.event_data.PipeName, host.name, file.name HAVING COUNT() > 5`. |
| 9. Named Pipe Creation with Anomalous Protocols | Named pipe creation using non-standard protocols, as in 2025 trends. | - Named Pipe Creation (DS0023: Sysmon ID 17)<br>- Network Traffic (DS0003: Zeek Conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=17 PipeName IN ("*\\\\.\\pipe\\*") \| join dest_host [search index=network sourcetype=zeek_conn service NOT IN ("http", "https", "smb")] \| stats count by PipeName, dest_host, service \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "NamedPipeCreated" and AdditionalFields.PipeName has "\\\\.\\pipe\\" \| join kind=inner (DeviceNetworkEvents \| where Protocol !in ("http", "https", "smb")) on DeviceName \| summarize count() by AdditionalFields.PipeName, DeviceName, Protocol \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "17" AND winlog.event_data.PipeName : "*\\\\.\\pipe\\*" \| JOIN logs-zeek.conn-* ON host.name WHERE network.protocol NOT IN ['http', 'https', 'smb'] \| STATS COUNT() BY winlog.event_data.PipeName, host.name, network.protocol HAVING COUNT() > 5`. |
| 10. Named Pipe Creation via Known Vulnerable Services | Named pipe creation via known vulnerable services, as in FIN7. | - Named Pipe Creation (DS0023: Sysmon ID 17)<br>- Process Creation (DS0009: Sysmon ID 1)<br>- Threat Intelligence | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=17 PipeName IN ("*\\\\.\\pipe\\*") \| join dest_host [search index=endpoint sourcetype=sysmon EventCode=1 Image IN (known_vuln_services)] \| stats count by PipeName, Image, dest_host \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "NamedPipeCreated" and AdditionalFields.PipeName has "\\\\.\\pipe\\" \| join kind=inner (DeviceProcessEvents \| where ProcessName in (knownVulnServices)) on DeviceName \| summarize count() by AdditionalFields.PipeName, ProcessName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code : "17" AND winlog.event_data.PipeName : "*\\\\.\\pipe\\*" \| JOIN logs-endpoint.process-* ON host.name WHERE process.executable IN ['known_vuln_services'] \| STATS COUNT() BY winlog.event_data.PipeName, process.executable, host.name HAVING COUNT() > 5`. |
