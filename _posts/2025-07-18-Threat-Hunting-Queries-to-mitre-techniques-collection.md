---
layout: default
title: Collection
category: Hunting-Queries  # This becomes a main topic in sidebar
---

## Collection
### ARP Cache Poisoning (MITRE ATT&CK T1557.002)

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Gratuitous ARP Replies from Unauthorized Hosts | Adversaries may send unsolicited (gratuitous) ARP replies to poison caches without prior requests, targeting high-traffic segments in Windows/Linux LANs to intercept traffic. High risk in flat networks with no ARP inspection. | - Network Traffic Content (e.g., Zeek ARP logs, PCAP from Wireshark/Snort)<br>- Network Traffic Flow (e.g., NetFlow, switch logs) | - **Splunk**: `index=network sourcetype=zeek_arp \| where opcode="reply" AND request_ip IS NULL \| stats count by src_mac, dst_ip \| where count > 5` (Looks for replies without matching requests; threshold for anomalies).<br>- **KQL (Sentinel/XDR)**: `DeviceNetworkEvents \| where ActionType == "ArpReply" and AdditionalFields.requestIp == "" \| summarize count() by InitiatingProcessSHA256, RemoteIP \| where count_ > 5`.<br>- **ELK/SQL-like**: `FROM logs-zeek.arp-* \| WHERE opcode = 'reply' AND request.ip IS NULL \| STATS COUNT() BY source.mac GROUP BY destination.ip HAVING COUNT() > 5`. |
| 2. Multiple IPs Mapping to Single MAC in ARP Caches | Adversaries poison endpoint ARP caches, causing duplicate MAC associations (e.g., attacker claims multiple IPs). Common in Windows environments; hunt via periodic cache audits. | - Endpoint ARP Cache Changes (e.g., Windows Event Logs ID 2003/2004 via Sysmon, Linux /proc/net/arp via auditd)<br>- Network Traffic Content | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=10 \| search "arp.exe" OR "Get-NetNeighbor" \| rex field=Message "IP=(?<ip>\S+) MAC=(?<mac>\S+)" \| stats dc(ip) by mac \| where dc_ip > 1` (Detects duplicates).<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "arp -a" \| extend IP = extract("IP: (\\S+)", 1, ProcessCommandLine), MAC = extract("MAC: (\\S+)", 1, ProcessCommandLine) \| summarize UniqueIPs = dcount(IP) by MAC \| where UniqueIPs > 1`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code = "10" AND process.args : "arp*" \| STATS DISTINCT_COUNT(ip_address) BY mac_address HAVING DISTINCT_COUNT(ip_address) > 1`. |
| 3. ARP Replies Faster Than Legitimate Responses | Adversaries race to reply to ARP requests before legitimate hosts, poisoning caches in real-time. Detect via timing anomalies in high-visibility networks (e.g., with packet timestamps). | - Network Traffic Content (e.g., Suricata ARP alerts, Zeek with timestamps)<br>- Packet Captures | - **Splunk**: `index=network sourcetype=suricata protocol=arp \| eval response_time = mvindex(timestamp,1) - mvindex(timestamp,0) \| where opcode="reply" AND response_time < 0.01 \| stats count by src_mac` (Flags sub-10ms replies as suspicious).<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "ARP" and ActionType == "Reply" \| extend ResponseDelta = datetime_diff('millisecond', Timestamp, PreviousEvent.Timestamp) \| where ResponseDelta < 10 \| summarize by DeviceId, RemoteIP`.<br>- **ELK**: `FROM logs-suricata-* \| WHERE event.module = 'arp' AND event.kind = 'reply' \| EVAL delta = @timestamp - lag(@timestamp, 1) OVER (PARTITION BY source.mac) \| WHERE delta < 10ms \| STATS COUNT() BY source.mac`. |
| 4. Unknown/Unexpected Hardware Devices via ARP | Adversaries introduce rogue devices (e.g., Raspberry Pi) that send ARP to poison caches. Hunt in environments with DHCP integration for MAC mismatches. | - Network Traffic Flow (e.g., DHCP logs, switch port security)<br>- Device Inventory (e.g., asset management tools) | - **Splunk**: `index=network sourcetype=dhcp \| join src_mac [search sourcetype=arp] \| where NOT src_mac IN (known_macs_list) \| stats values(ip) by src_mac` (Correlates unknown MACs from ARP with DHCP).<br>- **KQL**: `DeviceNetworkEvents \| where ActionType == "DhcpLease" or ActionType == "ArpRequest" \| where not( InitiatingProcessSHA256 in~ (knownDevices) ) \| summarize IPs = make_set(RemoteIP) by DeviceId`.<br>- **ELK**: `FROM logs-dhcp-* \| JOIN logs-arp-* ON source.mac \| WHERE source.mac NOT IN ["known_mac1", "known_mac2"] \| STATS VALUES(ip) BY source.mac`. |
| 5. ARP Poisoning Tool Artifacts on Endpoints | Adversaries use tools like arpspoof, Ettercap, or Scapy for poisoning. Detect process creation or command-line in Windows/Linux endpoints. | - Process Creation (e.g., Sysmon Event ID 1, auditd execve)<br>- Command Execution Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search Image="*ettercap*" OR Image="*arpspoof*" OR CommandLine="*scapy*" \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("ettercap", "arpspoof", "scapy.all") or ProcessCommandLine contains "arp spoof" \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.events.process-* \| WHERE event.category = 'process' AND (process.name : "ettercap*" OR process.args : "*arp*spoof*") \| TABLE @timestamp, host.name, process.command_line`. |
| 6. Anomalous ARP Traffic Volume Spikes | Adversaries flood with ARP replies during poisoning campaigns, causing volume spikes in Linux-heavy environments. | - Network Traffic Content (e.g., Zeek/Snort aggregate stats)<br>- Flow Metrics | - **Splunk**: `index=network sourcetype=zeek_arp \| timechart span=1h count by opcode \| where opcode="reply" AND count > avg(count)*3` (Baselines and alerts on 3x spikes).<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "ARP" \| summarize HourlyCount = count() by bin(Timestamp, 1h), ActionType \| where ActionType == "Reply" and HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-zeek.arp-* \| STATS COUNT() BY date_histogram(field='@timestamp', interval='1h'), opcode \| WHERE opcode = 'reply' AND COUNT() > AVG(COUNT()) * 3`. |
| 7. ARP Cache Changes Correlated with MitM Indicators | Post-poisoning, adversaries manipulate traffic; hunt cache changes followed by unexpected redirects (e.g., in cloud-hybrid setups with VPNs). | - Endpoint Logs (e.g., Windows NetNeighbor changes)<br>- Network Traffic Flow | - **Splunk**: `index=endpoint sourcetype=win_event \| search EventID=2003 \| join host [search sourcetype=network "unexpected_redirect"] \| stats count by mac, ip`.<br>- **KQL**: `DeviceNetworkEvents \| where ActionType == "ArpCacheUpdate" \| join kind=inner (DeviceNetworkEvents \| where ActionType == "ConnectionRedirected") on DeviceId \| summarize by Timestamp, RemoteIP`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 2003 \| JOIN logs-network-* ON host.id WHERE event.action = 'redirect' \| STATS COUNT() BY mac, ip`. |
| 8. Gratuitous ARP from Non-Gateway Devices | Adversaries mimic gateways with gratuitous ARP to poison multiple hosts; detect in segmented networks. | - Network Traffic Content<br>- Device Logs | - **Splunk**: `index=network sourcetype=arp \| where opcode="reply" AND src_ip != gateway_ip \| stats count by src_mac \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where ActionType == "GratuitousArp" and RemoteIP != "gateway_ip" \| summarize SuspiciousCount = count() by DeviceId \| where SuspiciousCount > 10`.<br>- **ELK**: `FROM logs-arp-* \| WHERE opcode = 'reply' AND source.ip != '192.168.1.1' \| STATS COUNT() BY source.mac HAVING COUNT() > 10`. |
| 9. ARP Poisoning in Conjunction with Credential Harvesting | Adversaries combine poisoning with tools like Responder for LLMNR poisoning; hunt in Windows domains. | - Network Traffic Content (ARP + LLMNR)<br>- Service Creation Logs | - **Splunk**: `index=network (sourcetype=arp opcode="reply") OR (sourcetype=llmnr "responder") \| transaction src_mac maxspan=1m \| where eventcount > 1 \| table src_mac, _time`.<br>- **KQL**: `DeviceNetworkEvents \| where (Protocol == "ARP" and ActionType == "Reply") or (Protocol == "LLMNR" and ActionType == "Query") \| summarize Events = make_set(ActionType) by bin(Timestamp, 1m), DeviceId \| where array_length(Events) > 1`.<br>- **ELK**: `FROM logs-network-* \| WHERE (event.module = 'arp' AND event.kind = 'reply') OR (event.module = 'llmnr' AND event.kind = 'query') \| STATS SET(events) BY date_histogram(@timestamp, '1m'), host.id \| WHERE CARDINALITY(events) > 1`. |
| 10. Dynamic ARP Inspection (DAI) Violations | Adversaries trigger DAI errors on switches during poisoning attempts; hunt in Cisco-managed networks. | - Switch Logs (e.g., Cisco syslog for DAI)<br>- Network Alerts | - **Splunk**: `index=network sourcetype=cisco:ios "DAI" "invalid ARP" \| stats count by src_mac, interface \| where count > 1` (From Splunk Security Content).<br>- **KQL**: `DeviceAlertEvents \| where AlertTitle contains "DAI Violation" or Description contains "ARP Inspection" \| summarize by Timestamp, RemoteIP`.<br>- **ELK**: `FROM logs-cisco-* \| WHERE message : "*DAI*invalid*ARP*" \| STATS COUNT() BY source.mac, interface HAVING COUNT() > 1`.


### Adversary-in-the-Middle

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. LLMNR/NBT-NS Poisoning via Unsolicited Responses | Adversaries respond to LLMNR/NBT-NS queries with falsified information to redirect traffic, common in Windows environments for credential relay attacks. High risk in domains without mDNS disabled. | - Network Traffic Content (e.g., Zeek DNS/LLMNR logs, PCAP)<br>- Network Traffic Flow (e.g., NetFlow with protocol metadata) | - **Splunk**: `index=network sourcetype=zeek_llmnr \| where opcode="response" AND query_type="A" AND src_ip NOT IN (known_dns_servers) \| stats count by src_ip, queried_name \| where count > 5` (Detects unsolicited responses from non-DNS servers).<br>- **KQL (Sentinel/XDR)**: `DeviceNetworkEvents \| where Protocol == "LLMNR" and ActionType == "Response" and RemoteIP !in~ (knownDNSServers) \| summarize count() by RemoteIP, AdditionalFields.queriedName \| where count_ > 5`.<br>- **ELK/SQL-like**: `FROM logs-zeek.llmnr-* \| WHERE event.kind = 'response' AND source.ip NOT IN ['dns1', 'dns2'] \| STATS COUNT() BY source.ip, query.name HAVING COUNT() > 5`. |
| 2. Relay Attacks Following LLMNR Poisoning | Adversaries use tools like Responder to relay captured NTLM hashes after poisoning. Hunt in Windows-heavy networks for relay indicators post-poisoning. | - Network Traffic Content (e.g., Suricata NTLM rules)<br>- Endpoint Process Creation (e.g., Sysmon ID 1 for Responder.exe) | - **Splunk**: `index=network sourcetype=suricata "NTLM relay" OR index=endpoint sourcetype=sysmon EventCode=1 Image="*responder.exe*" \| transaction src_ip maxspan=5m \| where eventcount > 1 \| table _time, src_ip`.<br>- **KQL**: `DeviceNetworkEvents \| where ActionType == "NtlmRelay" or (DeviceProcessEvents \| where ProcessName == "Responder.exe") \| join kind=inner on DeviceId \| project Timestamp, RemoteIP`.<br>- **ELK**: `FROM logs-suricata-* \| WHERE message : "*NTLM*relay*" \| JOIN logs-endpoint.events.process-* ON host.id WHERE process.name = 'responder.exe' \| STATS COUNT() BY @timestamp, source.ip`. |
| 3. DHCP Spoofing via Rogue Servers | Adversaries set up rogue DHCP servers to assign malicious gateways/DNS, enabling AiTM. Common in wireless or unsecured LANs (Windows/Linux/cloud edge). | - Network Traffic Content (e.g., Zeek DHCP logs)<br>- Switch Logs (e.g., DHCP snooping violations) | - **Splunk**: `index=network sourcetype=zeek_dhcp \| where type="offer" AND server_ip NOT IN (authorized_dhcp_servers) \| stats values(assigned_ip) by server_ip \| where count > 3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DHCP" and ActionType == "Offer" and RemoteIP !in~ (authorizedServers) \| summarize AssignedIPs = make_set(AdditionalFields.assignedIp) by RemoteIP \| where array_length(AssignedIPs) > 3`.<br>- **ELK**: `FROM logs-zeek.dhcp-* \| WHERE event.kind = 'offer' AND server.ip NOT IN ['dhcp1'] \| STATS SET(assigned.ip) BY server.ip HAVING CARDINALITY(assigned.ip) > 3`. |
| 4. Anomalous DHCP Lease Assignments | Adversaries issue short-lived leases or unusual options (e.g., WPAD) via spoofed DHCP for AiTM persistence. Hunt in dynamic IP environments. | - Network Traffic Flow (e.g., DHCP option fields in PCAP)<br>- Endpoint Logs (e.g., Windows Event ID 169 for DHCP) | - **Splunk**: `index=network sourcetype=dhcp \| where option_code=252 OR lease_time < 300 \| stats count by client_mac, option_value \| where count > 10` (Flags WPAD or short leases).<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.optionCode == 252 or AdditionalFields.leaseTime < 300 \| summarize count() by DeviceId, AdditionalFields.optionValue \| where count_ > 10`.<br>- **ELK**: `FROM logs-dhcp-* \| WHERE dhcp.option.code = 252 OR dhcp.lease.time < 300 \| STATS COUNT() BY client.mac, dhcp.option.value HAVING COUNT() > 10`. |
| 5. ARP Cache Poisoning (Expanded from Sub-Technique) | Building on T1557.002, adversaries poison ARP for local MitM; detect via cache mismatches in mixed OS environments. | - Endpoint ARP Cache (e.g., Sysmon, auditd)<br>- Network Traffic Content | - **Splunk**: `index=endpoint sourcetype=sysmon "arp cache" \| rex "IP=(?<ip>\S+) MAC=(?<mac>\S+)" \| stats values(mac) by ip \| where mvcount(mac) > 1` (Multiple MACs per IP).<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "arp" \| extend IP=extract("IP:(\\S+)",1,ProcessCommandLine), MAC=extract("MAC:(\\S+)",1,ProcessCommandLine) \| summarize MACs=make_set(MAC) by IP \| where array_length(MACs) > 1`.<br>- **ELK**: `FROM logs-endpoint-* \| WHERE message : "*arp*cache*" \| STATS SET(mac) BY ip HAVING CARDINALITY(mac) > 1`. |
| 6. SSL/TLS Downgrade or Stripping Attacks | Adversaries perform SSL stripping (HSTS bypass) in AiTM to intercept HTTPS traffic. High risk in public Wi-Fi or cloud proxies. | - Network Traffic Content (e.g., Zeek HTTP/SSL logs)<br>- Proxy Logs (e.g., Squid, Zscaler) | - **Splunk**: `index=network sourcetype=zeek_http \| where status=301 AND uri="*http://" AND referer="*https://" \| stats count by src_ip, host \| where count > 5` (HTTPS to HTTP redirects).<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.status == 301 and AdditionalFields.uri startswith "http://" and AdditionalFields.referer startswith "https://" \| summarize count() by RemoteIP, AdditionalFields.host \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.status = 301 AND http.uri : "http://*" AND http.referer : "https://*" \| STATS COUNT() BY source.ip, http.host HAVING COUNT() > 5`. |
| 7. Rogue Access Point Detection | Adversaries deploy evil twin APs for wireless AiTM, spoofing SSIDs. Hunt in enterprise Wi-Fi environments (Linux/AP hardware). | - Wireless Logs (e.g., Cisco WLC, Aruba)<br>- Endpoint Connection Events (e.g., Windows WLAN-AutoConfig) | - **Splunk**: `index=wireless sourcetype=cisco:wlc "rogue AP" OR EventID=110002 \| stats count by ssid, mac \| where count > 1 AND ssid IN (corporate_ssids)`.<br>- **KQL**: `DeviceNetworkEvents \| where ActionType == "WlanConnection" and AdditionalFields.ssid in~ (corporateSSIDs) \| summarize count() by AdditionalFields.mac \| where count_ > 1`.<br>- **ELK**: `FROM logs-wireless-* \| WHERE message : "*rogue*AP*" OR winlog.event_id = 110002 \| STATS COUNT() BY ssid, mac HAVING COUNT() > 1 AND ssid IN ['corp1']`. |
| 8. Unexpected Proxy or Tunnel Usage in AiTM | Adversaries force traffic through malicious proxies (e.g., via WPAD) for interception. Common in cloud-hybrid setups. | - Proxy Logs (e.g., web gateway events)<br>- Browser Extension Logs | - **Splunk**: `index=proxy sourcetype=bluecoat \| where proxy_url NOT IN (approved_proxies) OR action="denied" "suspicious tunnel" \| stats values(user) by proxy_url \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteUrl !in~ (approvedProxies) or ActionType == "ProxyDenied" \| summarize Users=make_set(InitiatingProcessAccountName) by RemoteUrl \| where array_length(Users) > 10`.<br>- **ELK**: `FROM logs-proxy-* \| WHERE url : NOT IN ['proxy1'] OR event.action = 'denied' \| STATS SET(user) BY url HAVING CARDINALITY(user) > 10`. |
| 9. Credential Harvesting via AiTM Pharming | Adversaries redirect to fake login pages post-AiTM (e.g., via DNS poisoning). Hunt for pharming indicators in web traffic. | - Network Traffic Content (e.g., Suricata HTTP rules for phishing)<br>- DNS Logs | - **Splunk**: `index=network (sourcetype=dns "unexpected resolution") OR sourcetype=http "login phishing" \| transaction domain maxspan=1m \| where eventcount > 1 \| table domain, src_ip`.<br>- **KQL**: `DeviceNetworkEvents \| where (Protocol == "DNS" and ActionType == "UnexpectedResolution") or (Protocol == "HTTP" and AdditionalFields contains "login") \| join kind=inner on RemoteUrl \| project RemoteUrl, InitiatingProcessAccountSid`.<br>- **ELK**: `FROM logs-dns-* \| WHERE event.action = 'unexpected' \| JOIN logs-http-* ON domain WHERE message : '*login*phishing*' \| STATS COUNT() BY domain, source.ip`. |
| 10. AiTM Tool Execution on Compromised Hosts | Adversaries run tools like Bettercap, Mitmproxy for AiTM. Detect in Linux/Windows endpoints with deep visibility. | - Process Creation (e.g., Sysmon ID 1, auditd)<br>- Command-Line Auditing | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search Image IN ("*bettercap*", "*mitmproxy*", "*sslsplit*") \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("bettercap", "mitmproxy", "sslsplit") \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.events.process-* \| WHERE process.name IN ['bettercap', 'mitmproxy'] \| TABLE @timestamp, host.name, process.command_line`. |
| 11. Traffic Redirection Anomalies in Cloud Environments | In cloud (AWS/Azure), adversaries use VPC peering or route table hijacks for AiTM. Hunt via cloud logs. | - Cloud Audit Logs (e.g., AWS CloudTrail, Azure Activity Logs)<br>- Network Flow Logs (VPC Flow) | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="ModifyRouteTable" OR "Unauthorized peering" \| stats count by userIdentity, resource \| where count > 1`.<br>- **KQL**: `AzureActivity \| where OperationNameValue == "Microsoft.Network/routeTables/routes/write" \| summarize count() by Caller, ResourceId \| where count_ > 1`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'ModifyRouteTable' \| STATS COUNT() BY user.identity, resource HAVING COUNT() > 1`. |
| 12. NBT-NS Query Flooding for DoS/AiTM Setup | Adversaries flood NBT-NS queries to exhaust resources before poisoning. Detect spikes in Windows networks. | - Network Traffic Flow (e.g., NetFlow volume)<br>- DNS Logs | - **Splunk**: `index=network sourcetype=nbtns \| timechart span=5m count by src_ip \| where count > avg(count)*5` (5x baseline spikes).<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "NBTNS" \| summarize MinCount=count() by bin(Timestamp, 5m), RemoteIP \| where MinCount > avg(MinCount) * 5`.<br>- **ELK**: `FROM logs-nbtns-* \| STATS COUNT() BY date_histogram(@timestamp, '5m'), source.ip \| WHERE COUNT() > AVG(COUNT()) * 5`. |
| 13. Combined AiTM with Lateral Movement | Adversaries use AiTM to capture creds for lateral movement; correlate poisoning with auth events. | - Authentication Logs (e.g., Windows 4624)<br>- Network Traffic Content | - **Splunk**: `index=security EventID=4624 \| join src_ip [search sourcetype=arp "poison"] \| where LogonType=3 \| stats values(target_user) by src_ip`.<br>- **KQL**: `SecurityEvent \| where EventID == 4624 and LogonType == 3 \| join kind=inner (DeviceNetworkEvents \| where ActionType == "ArpPoison") on RemoteIP \| summarize Users=make_set(AccountName) by RemoteIP`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 4624 \| JOIN logs-arp-* ON source.ip WHERE event.action = 'poison' \| STATS SET(user) BY source.ip`. |
| 14. HSTS Bypass Attempts in AiTM | Adversaries attempt to bypass HSTS preloads during SSL stripping. Hunt in browser/telemetry-rich environments. | - Browser Logs (e.g., Chrome/Edge telemetry)<br>- HTTP Traffic | - **Splunk**: `index=browser sourcetype=chrome "HSTS bypass" OR sourcetype=http "preload ignore" \| stats count by domain, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields contains "HSTS Bypass" or ActionType == "PreloadIgnore" \| summarize count() by AdditionalFields.domain, InitiatingProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-browser-* \| WHERE message : "*HSTS*bypass*" \| STATS COUNT() BY domain, user.agent HAVING COUNT() > 5`. |
| 15. Persistent AiTM via Modified Network Configurations | Adversaries alter host configs (e.g., /etc/hosts, Windows hosts file) for long-term redirection. Hunt in Linux/Windows endpoints. | - File Modification Logs (e.g., Sysmon ID 11 for hosts file)<br>- Configuration Change Audits | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename="*hosts" \| table _time, host, ProcessGuid, TargetFilename`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileModified" and FolderPath endswith "hosts" \| project Timestamp, DeviceName, SHA256`.<br>- **ELK**: `FROM logs-endpoint.events.file-* \| WHERE event.action = 'modification' AND file.path : '*hosts' \| TABLE @timestamp, host.name, process.id, file.path`.


### Archive Collected Data

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Use of Built-in Archiving Utilities on Sensitive Data | Adversaries use native tools like Compress-Archive (PowerShell) or tar/gzip to archive collected data in staging directories, common in Windows/Linux environments for compression before exfil. High risk in environments with unmonitored temp folders. | - Command Execution (e.g., Sysmon Event ID 1, auditd execve)<br>- File Creation/Modification (e.g., Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search CommandLine="*Compress-Archive*" OR CommandLine="*tar -czf*" OR CommandLine="*gzip*" \| where Path="*temp*" OR Path="*staging*" \| stats count by host, CommandLine \| where count > 5` (Detects archiving in suspicious paths).<br>- **KQL (Sentinel/XDR)**: `DeviceProcessEvents \| where ProcessCommandLine contains "Compress-Archive" or ProcessCommandLine contains "tar -czf" or ProcessCommandLine contains "gzip" and FolderPath has_any ("temp", "staging") \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK/SQL-like**: `FROM logs-endpoint.events.process-* \| WHERE event.category = "process" AND (process.args : "*Compress-Archive*" OR process.args : "*tar*czf*" OR process.args : "*gzip*") AND file.path : ("*temp*" OR "*staging*") \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 5`. |
| 2. Third-Party Archiving Tool Execution | Adversaries deploy tools like 7-Zip, WinRAR, or zip for high-compression archiving, often in Windows environments. Hunt for process creation anomalies in non-standard installs. | - Process Creation (e.g., Sysmon ID 1)<br>- Module Load (e.g., Sysmon ID 7 for DLLs) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search Image IN ("*7z.exe*", "*rar.exe*", "*zip.exe*") AND NOT Image IN (approved_paths) \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("7z.exe", "rar.exe", "zip.exe") and not(FolderPath in~ (approvedPaths)) \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.events.process-* \| WHERE process.name IN ['7z.exe', 'rar.exe', 'zip.exe'] AND process.executable NOT IN ['C:\\Program Files\\*'] \| TABLE @timestamp, host.name, process.command_line`. |
| 3. Archive File Creation in Unusual Locations | Adversaries create .zip/.tar.gz files in user profiles or system dirs for staging. Common in Linux/cloud for data aggregation. | - File Creation (e.g., Sysmon ID 11, auditd create)<br>- Endpoint File System Changes | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 \| search TargetFilename=(*.zip OR *.tar.gz OR *.rar) AND (TargetFilename="*AppData*" OR TargetFilename="*tmp*") \| stats values(TargetFilename) by host \| where mvcount(TargetFilename) > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FileName endswith_any (".zip", ".tar.gz", ".rar") and FolderPath has_any ("AppData", "tmp") \| summarize Files=make_set(FileName) by DeviceName \| where array_length(Files) > 3`.<br>- **ELK**: `FROM logs-endpoint.events.file-* \| WHERE event.action = 'creation' AND file.extension IN ['zip', 'tar.gz', 'rar'] AND file.path : ("*AppData*" OR "*tmp*") \| STATS SET(file.name) BY host.name HAVING CARDINALITY(file.name) > 3`. |
| 4. High-Entropy File Creations Indicating Custom Archiving | Adversaries use custom methods (e.g., scripts) creating high-entropy archived files. Hunt in environments with deep file telemetry for obfuscated data. | - File Metadata (e.g., custom entropy scanners via EDR)<br>- File Creation Logs | - **Splunk**: `index=endpoint sourcetype=edr_file \| where entropy > 7.0 AND file_extension IN ("bin", "dat", "archive") \| stats count by file_path, host \| where count > 1` (Assumes entropy field; threshold for compressed data).<br>- **KQL**: `DeviceFileEvents \| where AdditionalFields.entropy > 7.0 and FileName endswith_any ("bin", "dat") \| summarize count() by FolderPath, DeviceName \| where count_ > 1`.<br>- **ELK**: `FROM logs-edr.file-* \| WHERE file.entropy > 7.0 AND file.extension : ('bin' OR 'dat') \| STATS COUNT() BY file.path, host.name HAVING COUNT() > 1`. |
| 5. Archiving Followed by Network Exfiltration | Correlate archiving commands with subsequent outbound connections, common in cloud environments for data staging before upload. | - Process Network (e.g., Sysmon ID 3)<br>- Cloud Access Logs (e.g., AWS S3 PutObject) | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=1 CommandLine="*zip*") OR (EventCode=3 DestinationPort=443) \| transaction ProcessGuid maxspan=5m \| where mvcount(EventCode)=2 \| table _time, host, DestinationIp`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "zip" \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 443) on ProcessId \| project Timestamp, DeviceName, RemoteIP`.<br>- **ELK**: `FROM logs-endpoint.events.process-* \| WHERE process.args : "*zip*" \| JOIN logs-endpoint.events.network-* ON process.pid WHERE destination.port = 443 \| TABLE @timestamp, host.name, destination.ip`. |
| 6. Library-Based Archiving via API Calls | Adversaries use libraries like zlib or SharpCompress in custom malware for in-memory archiving. Hunt via module loads in Windows/Linux. | - Module Load (e.g., Sysmon ID 7 for zlib.dll)<br>- Process Memory Dumps (if available) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 \| search ImageLoaded IN ("*zlib*", "*libzip*", "*compression.dll*") AND ParentImage NOT IN (legit_apps) \| stats count by host, ImageLoaded`.<br>- **KQL**: `DeviceImageLoadEvents \| where FolderPath has_any ("zlib", "libzip") and not(InitiatingProcessFolderPath in~ (legitApps)) \| summarize count() by DeviceName, FolderPath`.<br>- **ELK**: `FROM logs-endpoint.events.library-* \| WHERE dll.name : ("*zlib*" OR "*libzip*") AND process.parent.name NOT IN ['chrome.exe'] \| STATS COUNT() BY host.name, dll.path`. |
| 7. Password-Protected Archive Creation | Adversaries add passwords to archives (e.g., zip -P) for evasion. Detect in high-risk environments with command-line auditing. | - Command Execution (e.g., Sysmon ID 1 with password flags) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search CommandLine=("*zip -P*" OR "*7z a -p*" OR "*rar a -hp*") \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains_any ("zip -P", "7z a -p", "rar a -hp") \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.events.process-* \| WHERE process.args : ("*zip*-P*" OR "*7z*a*-p*" OR "*rar*a*-hp*") \| TABLE @timestamp, host.name, process.command_line`. |
| 8. Archiving in Cloud Storage Buckets | In cloud (AWS/Azure), adversaries archive data via CLI/tools before syncing to buckets. Hunt via cloud audit logs. | - Cloud API Calls (e.g., AWS CloudTrail for s3:PutObject with .zip)<br>- Storage Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="PutObject" AND object_key=*.zip \| stats count by userIdentity, bucketName \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "PutObject" and AdditionalFields.objectKey endswith ".zip" \| summarize count() by Caller, ResourceId \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'PutObject' AND s3.object.key : '*.zip' \| STATS COUNT() BY user.identity, s3.bucket HAVING COUNT() > 10`. |
| 9. Anomalous File Size Changes Post-Archiving | Detect files shrinking significantly after archiving commands, indicating compression of large datasets in Linux servers. | - File Modification (e.g., auditd, Sysmon ID 2/11)<br>- Size Metrics | - **Splunk**: `index=endpoint sourcetype=auditd "type=SYSCALL" exe="*tar*" \| join path [search sourcetype=sysmon EventCode=11] \| eval size_change = new_size - old_size \| where size_change < -1000000 \| stats values(path) by host` (Flags >1MB reduction).<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileModified" and PreviousFileSize - FileSize > 1000000 \| join kind=inner (DeviceProcessEvents \| where ProcessCommandLine contains "tar") on FolderPath \| summarize Paths=make_set(FolderPath) by DeviceName`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE event.module = 'syscall' AND process.exe : '*tar*' \| JOIN logs-endpoint.file-* ON file.path \| EVAL change = file.size.before - file.size.after \| WHERE change > 1000000 \| STATS SET(path) BY host.name`. |
| 10. Scripting for Batch Archiving Operations | Adversaries use scripts (e.g., bash/PowerShell) to archive multiple files. Hunt for script executions targeting data dirs in mixed environments. | - Script Execution (e.g., Sysmon ID 1 for powershell.exe)<br>- File Access Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe*" CommandLine="*Archive*" OR Image="*bash*" CommandLine="*tar*" \| stats count by host, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where (FolderPath endswith "powershell.exe" and ProcessCommandLine contains "Archive") or (FolderPath endswith "bash" and ProcessCommandLine contains "tar") \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE (process.name = 'powershell.exe' AND process.args : '*Archive*') OR (process.name = 'bash' AND process.args : '*tar*') \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 5`. |
| 11. Archive via Custom Encryption/Compression Methods | Adversaries implement custom archiving with encryption (e.g., via Python zipfile with AES). Detect via unusual module loads or process behaviors. | - Module Load (e.g., Sysmon ID 7)<br>- Process Creation | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=7 ImageLoaded="*pycryptodome*") OR (EventCode=1 Image="*python*" CommandLine="*zipfile*") \| transaction ProcessGuid maxspan=1m \| where eventcount > 1`.<br>- **KQL**: `DeviceImageLoadEvents \| where FolderPath contains "pycryptodome" \| join kind=inner (DeviceProcessEvents \| where FolderPath contains "python" and ProcessCommandLine contains "zipfile") on ProcessId`.<br>- **ELK**: `FROM logs-endpoint.library-* \| WHERE dll.name : '*pycryptodome*' \| JOIN logs-endpoint.process-* ON process.pid WHERE process.name = 'python' AND process.args : '*zipfile*' \| STATS COUNT() BY @timestamp`. |
| 12. Volume Spikes in File Archiving Activity | Detect sudden increases in archiving-related events, indicating bulk data collection in high-visibility cloud setups. | - Aggregate Metrics (e.g., SIEM volume stats)<br>- Process Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*archive*" \| timechart span=1h count \| where count > avg(count)*4` (4x baseline).<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "archive" \| summarize HourlyCount=count() by bin(Timestamp, 1h) \| where HourlyCount > avg(HourlyCount) * 4`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : '*archive*' \| STATS COUNT() BY date_histogram(@timestamp, '1h') \| WHERE COUNT() > AVG(COUNT()) * 4`. |
| 13. Archiving Correlated with Data Collection Techniques | Link archiving to prior collection (e.g., after screenshot capture or clipboard access) for chained behaviors. | - Multi-Event Correlation (e.g., Sysmon IDs 1, 11, 13) | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=13 "clipboard") OR (EventCode=1 "*zip*") \| transaction host maxspan=10m \| where mvcount(EventCode)>1 \| table host, _time`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "zip" \| join kind=inner (DeviceRegistryEvents \| where RegistryKey contains "clipboard") on DeviceName \| project DeviceName, Timestamp`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : '*zip*' \| JOIN logs-endpoint.registry-* ON host.name WHERE registry.key : '*clipboard*' \| TABLE host.name, @timestamp`. |
| 14. Archive Files with Embedded Exfil Indicators | Detect archives named suspiciously or with metadata hinting at exfil (e.g., timestamps near network events). | - File Metadata (e.g., EDR file details)<br>- Network Correlation | - **Splunk**: `index=endpoint sourcetype=edr_file file_name=(*exfil*.zip) OR metadata="*staged*" \| join file_path [search sourcetype=network "outbound"] \| stats values(file_name) by host`.<br>- **KQL**: `DeviceFileEvents \| where FileName contains "exfil" and FileName endswith ".zip" \| join kind=inner (DeviceNetworkEvents \| where ActionType == "Outbound") on FolderPath \| summarize Files=make_set(FileName) by DeviceName`.<br>- **ELK**: `FROM logs-edr.file-* \| WHERE file.name : '*exfil*.zip' \| JOIN logs-network-* ON file.path WHERE event.action = 'outbound' \| STATS SET(file.name) BY host.name`. |
| 15. Archiving in Containerized or Virtual Environments | In cloud/Kubernetes, adversaries archive data within pods/VMs. Hunt via container logs for tar/zip usage. | - Container Logs (e.g., Docker/K8s audit)<br>- Cloud Instance Metadata | - **Splunk**: `index=container sourcetype=k8s:events "exec" Command="*tar czf*" OR "*zip*" \| stats count by pod_name, namespace \| where count > 3`.<br>- **KQL**: `KubeEvents \| where Verb == "exec" and ObjectRef.subresource == "command" and Message contains_any ("tar czf", "zip") \| summarize count() by ObjectRef.name, ObjectRef.namespace \| where count_ > 3`.<br>- **ELK**: `FROM logs-kubernetes.events-* \| WHERE kubernetes.event.verb = 'exec' AND message : ('*tar*czf*' OR '*zip*') \| STATS COUNT() BY kubernetes.pod.name, kubernetes.namespace HAVING COUNT() > 3`.


### Archive via Custom Method

### Threat Hunting Hypotheses for Archive via Custom Method (MITRE ATT&CK T1560.003)

Archive via Custom Method involves adversaries using bespoke techniques, such as XOR encryption or stream ciphers without external libraries, to compress or encrypt collected data before exfiltration. This sub-technique is prevalent in advanced persistent threats (APTs) like those observed in groups such as Hromcova or CopyKittens, where custom implementation evades standard utility detection. Hypotheses are tailored to environments with deep endpoint visibility (e.g., EDR), assuming moderate log sources; in low-visibility setups, focus on behavioral anomalies. I've generated 15 high-quality hypotheses, emphasizing custom scripting, in-memory operations, and post-archival indicators across Windows, Linux, and cloud.

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Custom XOR Encryption in PowerShell Scripts | Adversaries embed XOR operations in PowerShell for simple encryption of staged data, common in Windows environments to avoid utility footprints. High risk in script-heavy admin workflows. | - Script Execution (e.g., Sysmon Event ID 1 for powershell.exe)<br>- Command-Line Auditing | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe*" \| search CommandLine="*XOR*" OR CommandLine="*[char]0x*" \| where ScriptBlockText="*byte[]*" \| stats count by host, CommandLine \| where count > 3` (Flags XOR byte arrays).<br>- **KQL (Sentinel/XDR)**: `DeviceProcessEvents \| where FolderPath endswith "powershell.exe" and ProcessCommandLine contains "XOR" or ProcessCommandLine contains "[char]0x" and AdditionalFields.ScriptBlockText contains "byte[]" \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 3`.<br>- **ELK/SQL-like**: `FROM logs-endpoint.events.process-* \| WHERE process.name = "powershell.exe" AND (process.args : "*XOR*" OR process.args : "*[char]0x*") AND event.script : "*byte*[]" \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 3`. |
| 2. Stream Cipher Implementation via Python | Adversaries use Python with built-in modules (e.g., random for RC4-like streams) for custom archiving without crypto libs. Hunt in Linux/cloud dev environments. | - Process Creation (e.g., auditd execve for python)<br>- Script Logs | - **Splunk**: `index=endpoint sourcetype=auditd exe="*python*" \| search cmdline="*stream*" OR cmdline="*rc4*" OR cmdline="*keystream*" \| stats values(file) by host \| where mvcount(file) > 2`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath contains "python" and ProcessCommandLine has_any ("stream", "rc4", "keystream") \| summarize Files=make_set(FileName) by DeviceName \| where array_length(Files) > 2`.<br>- **ELK**: `FROM logs-auditd.events-* \| WHERE process.exe : "*python*" AND process.args : ("*stream*" OR "*rc4*" OR "*keystream*") \| STATS SET(file.path) BY host.name HAVING CARDINALITY(file.path) > 2`. |
| 3. In-Memory Custom Compression via .NET | Adversaries implement custom compression (e.g., LZ-like in C#) in memory to avoid disk writes. Detect via .NET runtime anomalies in Windows. | - .NET Runtime Events (e.g., Sysmon ID 7 for mscorlib.dll loads)<br>- Memory Forensics (if EDR-integrated) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded="*mscorlib*" \| join ProcessGuid [search EventCode=1 CommandLine="*DeflateStream*" OR CommandLine="*custom compress*"] \| stats count by host, ImageLoaded`.<br>- **KQL**: `DeviceImageLoadEvents \| where FolderPath contains "mscorlib" \| join kind=inner (DeviceProcessEvents \| where ProcessCommandLine contains "DeflateStream" or ProcessCommandLine contains "custom compress") on ProcessId \| summarize count() by DeviceName, FolderPath`.<br>- **ELK**: `FROM logs-sysmon.library-* \| WHERE dll.name : "*mscorlib*" \| JOIN logs-sysmon.process-* ON process.guid WHERE process.args : ("*DeflateStream*" OR "*custom*compress*") \| STATS COUNT() BY host.name, dll.path`. |
| 4. Anomalous High-Entropy Output Files from Scripts | Custom methods produce files with entropy >7.5 (indicative of encryption/compression). Hunt in mixed OS with file metadata visibility. | - File Creation (e.g., Sysmon ID 11)<br>- EDR File Entropy | - **Splunk**: `index=endpoint sourcetype=edr_file \| where entropy > 7.5 AND (parent_process="*powershell*" OR parent_process="*python*") AND file_extension IN ("dat", "bin") \| stats count by file_path, host \| where count > 1`.<br>- **KQL**: `DeviceFileEvents \| where AdditionalFields.entropy > 7.5 and InitiatingProcessFolderPath has_any ("powershell", "python") and FileName endswith_any (".dat", ".bin") \| summarize count() by FolderPath, DeviceName \| where count_ > 1`.<br>- **ELK**: `FROM logs-edr.file-* \| WHERE file.entropy > 7.5 AND process.parent.name : ("powershell" OR "python") AND file.extension : ("dat" OR "bin") \| STATS COUNT() BY file.path, host.name HAVING COUNT() > 1`. |
| 5. Custom Archiving Followed by Exfiltration Staging | Correlate custom script execution with file moves to staging dirs, common in APT data prep. | - File Modification (e.g., Sysmon ID 2)<br>- Network Staging (e.g., outbound prep) | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=1 CommandLine="*custom archive*" OR CommandLine="*encrypt xor*") \| transaction host maxspan=2m [search EventCode=2 TargetFilename="*staging*"] \| where eventcount > 1 \| table _time, host`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains_any ("custom archive", "encrypt xor") \| join kind=inner (DeviceFileEvents \| where ActionType == "FileRenamed" and FolderPath contains "staging") on DeviceName \| project Timestamp, DeviceName`.<br>- **ELK**: `FROM logs-sysmon.process-* \| WHERE process.args : ("*custom*archive*" OR "*encrypt*xor*") \| JOIN logs-sysmon.file-* ON host.name WHERE event.action = 'rename' AND file.path : "*staging*" \| TABLE @timestamp, host.name`. |
| 6. Embedded Custom Encryption in Executables | Adversaries inject custom XOR/stream code into PE/ELF binaries for self-archiving. Detect via binary modifications. | - File Changes (e.g., Sysmon ID 11 for exe changes)<br>- PE/ELF Parsing (EDR) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename=(*.exe OR *.elf) \| search Hashes="*modified*" OR "section entropy high" \| stats values(TargetFilename) by host`.<br>- **KQL**: `DeviceFileEvents \| where FileName endswith_any (".exe", ".elf") and AdditionalFields.Modified == true or AdditionalFields.SectionEntropy > 7 \| summarize Files=make_set(FileName) by DeviceName`.<br>- **ELK**: `FROM logs-sysmon.file-* \| WHERE file.name : ("*.exe" OR "*.elf") AND (file.hash : "*modified*" OR file.section.entropy > 7) \| STATS SET(file.name) BY host.name`. |
| 7. PowerShell Obfuscation with Custom Byte Encoding | Adversaries use base64 or custom byte flips for encoding archived data in scripts. High risk in Windows with AMSI bypass attempts. | - Script Block Logging (e.g., PowerShell logs)<br>- AMSI Events | - **Splunk**: `index=endpoint sourcetype=powershell \| search ScriptBlockText=(*[Convert]::ToBase64String* OR *byte flip*) AND OpCode="*Invoke-Expression*" \| stats count by host`.<br>- **KQL**: `DeviceEvents \| where AdditionalFields.ScriptBlockText contains "[Convert]::ToBase64String" or AdditionalFields.ScriptBlockText contains "byte flip" and AdditionalFields.OpCode == "Invoke-Expression" \| summarize count() by DeviceName`.<br>- **ELK**: `FROM logs-powershell-* \| WHERE event.script : ("*[Convert]::ToBase64String*" OR "*byte*flip*") AND event.opcode = "Invoke-Expression" \| STATS COUNT() BY host.name`. |
| 8. Custom Method Usage in Cloud Functions | In cloud (AWS Lambda/Azure Functions), adversaries implement custom encryption in serverless code. Hunt via function logs. | - Cloud Logs (e.g., AWS CloudWatch, Azure Monitor)<br>- Code Execution Logs | - **Splunk**: `index=cloud sourcetype=aws:lambda \| search log="*XOR encrypt*" OR log="*custom compress*" \| stats count by function_name, runtime \| where count > 5`.<br>- **KQL**: `AzureActivity \| where ResourceProvider == "Microsoft.Web/sites" and Message contains_any ("XOR encrypt", "custom compress") \| summarize count() by ResourceId, Runtime \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.lambda-* \| WHERE message : ("*XOR*encrypt*" OR "*custom*compress*") \| STATS COUNT() BY function.name, runtime HAVING COUNT() > 5`. |
| 9. Anomalous CPU/Memory Spikes During Custom Archiving | Custom computations (e.g., stream generation) cause resource spikes on endpoints. Detect in Linux servers with process metrics. | - Process Metrics (e.g., Perfmon, auditd)<br>- Resource Usage Logs | - **Splunk**: `index=endpoint sourcetype=perfmon CounterName="Processor\% Time" \| join host [search sourcetype=auditd exe="*python*" cmdline="*cipher*"] \| where Value > 80 \| stats avg(Value) by host`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "cipher" \| join kind=inner (PerfMetrics \| where CounterName == "Processor % Time" and Value > 80) on DeviceName \| summarize AvgCPU = avg(Value) by DeviceName`.<br>- **ELK**: `FROM logs-perfmon-* \| WHERE counter.name = "Processor% Time" \| JOIN logs-auditd-* ON host.name WHERE process.args : "*cipher*" \| WHERE value > 80 \| STATS AVG(value) BY host.name`. |
| 10. Custom Archiving Artifacts in Malware Samples | Adversaries leave strings like "custom_xor_key" in binaries. Hunt via string extraction in EDR scans. | - File Scans (e.g., Sysmon ID 11 with content)<br>- YARA Matches | - **Splunk**: `index=endpoint sourcetype=edr_scan \| search Strings="*custom_xor*" OR Strings="*stream_cipher*" \| stats values(file_hash) by host \| where mvcount(file_hash) > 1`.<br>- **KQL**: `DeviceFileEvents \| where AdditionalFields.ExtractedStrings contains_any ("custom_xor", "stream_cipher") \| summarize Hashes=make_set(SHA256) by DeviceName \| where array_length(Hashes) > 1`.<br>- **ELK**: `FROM logs-edr.scan-* \| WHERE file.strings : ("*custom_xor*" OR "*stream_cipher*") \| STATS SET(file.hash.sha256) BY host.name HAVING CARDINALITY(file.hash.sha256) > 1`. |
| 11. Chained Custom Archiving with Collection | Link custom methods to prior collection (e.g., keylogging output encrypted via XOR). | - Event Correlation (e.g., Sysmon multi-ID)<br>- Behavioral Chains | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=13 "keylog") \| transaction host maxspan=5m [search EventCode=1 "*XOR*"] \| where eventcount > 1`.<br>- **KQL**: `DeviceRegistryEvents \| where RegistryKey contains "keylog" \| join kind=inner (DeviceProcessEvents \| where ProcessCommandLine contains "XOR") on DeviceName \| project DeviceName, Timestamp`.<br>- **ELK**: `FROM logs-sysmon.registry-* \| WHERE registry.key : "*keylog*" \| JOIN logs-sysmon.process-* ON host.name WHERE process.args : "*XOR*" \| TABLE host.name, @timestamp`. |
| 12. Custom Encryption Without Crypto APIs | Adversaries avoid Windows CryptoAPI, using raw math libs for ciphers. Detect module absences. | - Module Load (e.g., Sysmon ID 7)<br>- API Calls (ETW) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 \| search NOT ImageLoaded IN ("*crypt32.dll*", "*bcrypt.dll*") AND ProcessImage="*script*" \| stats count by ProcessImage`.<br>- **KQL**: `DeviceImageLoadEvents \| where not(FolderPath in~ ("crypt32.dll", "bcrypt.dll")) and InitiatingProcessFolderPath contains "script" \| summarize count() by InitiatingProcessFolderPath`.<br>- **ELK**: `FROM logs-sysmon.library-* \| WHERE NOT dll.name IN ['crypt32.dll', 'bcrypt.dll'] AND process.name : "*script*" \| STATS COUNT() BY process.image.path`. |
| 13. Volume of Custom Script Executions | Spikes in ad-hoc script runs for archiving, indicating campaign activity in cloud. | - Aggregate Process Logs<br>- Execution Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*custom encrypt*" \| timechart span=1h count \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "custom encrypt" \| summarize HourlyCount=count() by bin(Timestamp, 1h) \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-sysmon.process-* \| WHERE process.args : "*custom*encrypt*" \| STATS COUNT() BY date_histogram(@timestamp, '1h') \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 14. Custom Method in Bash with Base64/XOR | Linux adversaries combine base64 with XOR in bash for quick archiving. Hunt in server farms. | - Command Execution (e.g., auditd)<br>- Shell History | - **Splunk**: `index=endpoint sourcetype=auditd exe="*bash*" \| search cmdline=(*base64* OR *xxd*) AND cmdline="*XOR*" \| table _time, host, cmdline`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "bash" and ProcessCommandLine has_any ("base64", "xxd") and ProcessCommandLine contains "XOR" \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-auditd.process-* \| WHERE process.exe : "*bash*" AND process.args : ("*base64*" OR "*xxd*") AND process.args : "*XOR*" \| TABLE @timestamp, host.name, process.command_line`. |
| 15. Post-Custom Archive Network Anomalies | Encrypted blobs trigger unusual outbound patterns (e.g., small, frequent sends). Correlate in hybrid environments. | - Network Flow (e.g., Zeek connections)<br>- File-Network Joins | - **Splunk**: `index=network sourcetype=zeek_conn \| join src_ip [search sourcetype=edr_file entropy>7.5] \| where bytes > 10000 AND duration < 10 \| stats count by src_ip`.<br>- **KQL**: `DeviceNetworkEvents \| where TotalBytes > 10000 and Duration < 10 \| join kind=inner (DeviceFileEvents \| where AdditionalFields.entropy > 7.5) on RemoteIP \| summarize count() by RemoteIP`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE bytes > 10000 AND duration < 10 \| JOIN logs-edr.file-* ON source.ip WHERE file.entropy > 7.5 \| STATS COUNT() BY source.ip`.


### Archive via Library

### Threat Hunting Hypotheses for Archive Collected Data: Archive via Library (MITRE ATT&CK T1560.002)

Adversaries may compress or encrypt collected data using third-party libraries like zlib, libzip, or aPLib before exfiltration, often to obfuscate content and evade detection. This technique is observed across platforms (Windows, Linux, macOS) and in malware such as InvisiMole (using zlib for compression), FoggyWeb (invoking GZipStream), and Lazarus Group tools (zlib compression for victim data). Detections can focus on library loads, API calls, and correlated file behaviors; in low-visibility environments, prioritize endpoint telemetry for anomalies like high-entropy outputs.

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Suspicious Loading of Compression Libraries in Non-Standard Processes | Adversaries load libraries like zlib.dll or libzip.so in processes not typically associated with archiving (e.g., web browsers or custom malware), as seen in BBSRAT and InvisiMole. High risk in Windows/Linux environments with dynamic linking. | - Module Load Events (e.g., Sysmon Event ID 7)<br>- Process Creation (e.g., Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 \| search ImageLoaded IN ("*zlib*", "*libzip*", "*aplib*") AND NOT ParentImage IN (legit_apps_like_7zip) \| stats count by ProcessImage, ImageLoaded \| where count > 3`.<br>- **KQL**: `DeviceImageLoadEvents \| where FolderPath has_any ("zlib", "libzip", "aplib") and not(InitiatingProcessFolderPath in~ (legitApps)) \| summarize count() by InitiatingProcessFolderPath, FolderPath \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.events.library-* \| WHERE dll.name : ("*zlib*" OR "*libzip*" OR "*aplib*") AND process.parent.name NOT IN ['7z.exe', 'archive_app'] \| STATS COUNT() BY process.image.path, dll.path HAVING COUNT() > 3`. |
| 2. API Calls to Compression Functions Without Utility Execution | Adversaries invoke functions like deflateInit (from zlib) directly via custom code, bypassing tools like zip.exe, as in Cardinal RAT's ZLIB usage. Hunt in high-visibility EDR environments. | - API Monitoring (e.g., ETW traces, Sysmon ID 10 for calls)<br>- Process Memory Events | - **Splunk**: `index=endpoint sourcetype=etw \| search CallTrace="*deflateInit*" OR CallTrace="*gzcompress*" AND NOT Image="*zip.exe*" \| stats values(CallTrace) by ProcessGuid \| where mvcount(CallTrace) > 2`.<br>- **KQL**: `DeviceEvents \| where ActionType == "ApiCall" and AdditionalFields.CallName has_any ("deflateInit", "gzcompress") and not(FolderPath endswith "zip.exe") \| summarize Traces=make_set(AdditionalFields.CallName) by ProcessId \| where array_length(Traces) > 2`.<br>- **ELK**: `FROM logs-etw-* \| WHERE event.action = 'apicall' AND trace.call : ("*deflateInit*" OR "*gzcompress*") AND process.name != 'zip.exe' \| STATS SET(trace.call) BY process.guid HAVING CARDINALITY(trace.call) > 2`. |
| 3. High-Entropy File Creation After Library Loads | Custom library usage produces compressed/encrypted files with entropy >7.0, correlated with loads like zlib, as in FunnyDream's zLib compression. Common in Linux servers for staging. | - File Creation (e.g., Sysmon ID 11)<br>- File Metadata (EDR entropy scans) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 \| join ProcessGuid [search EventCode=7 ImageLoaded="*zlib*"] \| where entropy > 7.0 AND TargetFilename=(*.bin OR *.dat) \| stats count by TargetFilename, host \| where count > 1`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and AdditionalFields.entropy > 7.0 and FileName endswith_any (".bin", ".dat") \| join kind=inner (DeviceImageLoadEvents \| where FolderPath contains "zlib") on ProcessId \| summarize count() by FileName, DeviceName \| where count_ > 1`.<br>- **ELK**: `FROM logs-endpoint.events.file-* \| WHERE event.action = 'creation' AND file.entropy > 7.0 AND file.extension : ('bin' OR 'dat') \| JOIN logs-endpoint.library-* ON process.pid WHERE dll.name : '*zlib*' \| STATS COUNT() BY file.name, host.name HAVING COUNT() > 1`. |
| 4. Compression Library Usage in Malware Known for T1560.002 | Detect loads of libraries in processes matching known malware like FoggyWeb (GZipStream) or LunarWeb (zlib), often in Windows/cloud hybrid setups. | - Process Creation (e.g., Sysmon ID 1)<br>- Module Loads (Sysmon ID 7) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded IN ("*gzip*", "*zlib*") AND Image IN ("*foggyweb*", "*lunarweb*") \| table _time, host, ImageLoaded`.<br>- **KQL**: `DeviceImageLoadEvents \| where FolderPath has_any ("gzip", "zlib") and InitiatingProcessFolderPath has_any ("foggyweb", "lunarweb") \| project Timestamp, DeviceName, FolderPath`.<br>- **ELK**: `FROM logs-endpoint.library-* \| WHERE dll.name : ("*gzip*" OR "*zlib*") AND process.name : ("*foggyweb*" OR "*lunarweb*") \| TABLE @timestamp, host.name, dll.path`. |
| 5. Archiving via Preinstalled Libraries in macOS/Linux | Adversaries use built-in bzip2 or zlib on macOS/Linux without spawning utilities, as in Epic's bzip2 compression. Hunt for library calls in non-archive processes. | - System Calls (e.g., auditd syscall for dlopen)<br>- Library Loads | - **Splunk**: `index=endpoint sourcetype=auditd "syscall=dlopen" \| search argument="*bzip2.so*" OR argument="*zlib.so*" AND NOT exe="*tar*" \| stats count by exe, argument \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "dlopen" and AdditionalFields.argument has_any ("bzip2.so", "zlib.so") and not(FolderPath endswith "tar") \| summarize count() by FolderPath, AdditionalFields.argument \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE syscall.name = 'dlopen' AND syscall.args : ("*bzip2.so*" OR "*zlib.so*") AND process.exe != '*tar*' \| STATS COUNT() BY process.exe, syscall.args HAVING COUNT() > 5`. |
| 6. .NET GZipStream Invocation in Custom Assemblies | In Windows, adversaries use C# GZipStream for compression, as in FoggyWeb. Detect via .NET ETW or assembly loads. | - .NET Events (e.g., ETW MethodLoad)<br>- Assembly Loads | - **Splunk**: `index=endpoint sourcetype=etw_net \| search MethodName="GZipStream*" AND AssemblyName NOT IN (legit_assemblies) \| stats count by AssemblyName \| where count > 2`.<br>- **KQL**: `DeviceEvents \| where ActionType == "MethodLoad" and AdditionalFields.MethodName contains "GZipStream" and not(AdditionalFields.AssemblyName in~ (legitAssemblies)) \| summarize count() by AdditionalFields.AssemblyName \| where count_ > 2`.<br>- **ELK**: `FROM logs-etw.net-* \| WHERE event.method = 'GZipStream*' AND assembly.name NOT IN ['system.dll'] \| STATS COUNT() BY assembly.name HAVING COUNT() > 2`. |
| 7. Custom Library Deployment and Loading | Adversaries bring in custom libs (e.g., aPLib in BADFLICK) and load them dynamically. Hunt for unknown DLL/so file creations followed by loads. | - File Creation (Sysmon ID 11)<br>- Module Loads (Sysmon ID 7) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename=(*.dll OR *.so) AND Hashes="unknown" \| join TargetFilename [search EventCode=7] \| stats values(TargetFilename) by host \| where mvcount(TargetFilename) > 1`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FileName endswith_any (".dll", ".so") and SHA256 == "unknown" \| join kind=inner (DeviceImageLoadEvents) on FileName \| summarize Files=make_set(FileName) by DeviceName \| where array_length(Files) > 1`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'creation' AND file.extension : ('dll' OR 'so') AND file.hash = 'unknown' \| JOIN logs-endpoint.library-* ON file.name \| STATS SET(file.name) BY host.name HAVING CARDINALITY(file.name) > 1`. |
| 8. Library-Based Archiving in Cloud Environments | In AWS/Azure, adversaries use libraries like boto3 with zlib for S3 uploads. Detect API calls with compressed payloads. | - Cloud Audit Logs (e.g., CloudTrail PutObject)<br>- Object Metadata | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="PutObject" AND object_key=*.gz \| join userIdentity [search "zlib compress"] \| stats count by bucketName \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "PutObject" and AdditionalFields.objectKey endswith ".gz" \| join kind=inner (AzureActivity \| where Message contains "zlib compress") on ResourceId \| summarize count() by ResourceId \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'PutObject' AND s3.object.key : '*.gz' \| JOIN logs-azure.activity-* ON resource.id WHERE message : '*zlib*compress*' \| STATS COUNT() BY s3.bucket HAVING COUNT() > 10`. |
| 9. Correlated Library Loads with Data Collection Indicators | Link library loads (e.g., zlib) to prior collection events like screenshot captures, as in OSX_OCEANLOTUS.D's AES encryption post-collection. | - Multi-Event Correlation (Sysmon IDs 7, 13)<br>- Behavioral Analytics | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=7 ImageLoaded="*zlib*") \| transaction ProcessGuid maxspan=5m [search EventCode=13 "screenshot"] \| where eventcount > 1 \| table _time, host`.<br>- **KQL**: `DeviceImageLoadEvents \| where FolderPath contains "zlib" \| join kind=inner (DeviceRegistryEvents \| where RegistryKey contains "screenshot") on ProcessId \| project Timestamp, DeviceName`.<br>- **ELK**: `FROM logs-endpoint.library-* \| WHERE dll.name : '*zlib*' \| JOIN logs-endpoint.registry-* ON process.pid WHERE registry.key : '*screenshot*' \| TABLE @timestamp, host.name`. |
| 10. Anomalous Resource Usage During Library Compression | High CPU/memory spikes from compression calls (e.g., zlib in Denis malware), indicating bulk archiving in servers. | - Performance Metrics (e.g., Perfmon CPU)<br>- Library Events | - **Splunk**: `index=endpoint sourcetype=perfmon "Processor Time" > 80 \| join host [search sourcetype=sysmon EventCode=7 "*zlib*"] \| stats avg(Value) by host \| where avg_Value > 80`.<br>- **KQL**: `PerfMetrics \| where CounterName == "Processor Time" and Value > 80 \| join kind=inner (DeviceImageLoadEvents \| where FolderPath contains "zlib") on DeviceName \| summarize AvgCPU=avg(Value) by DeviceName \| where AvgCPU > 80`.<br>- **ELK**: `FROM logs-perfmon-* \| WHERE counter.name = 'Processor Time' AND value > 80 \| JOIN logs-endpoint.library-* ON host.name WHERE dll.name : '*zlib*' \| STATS AVG(value) BY host.name HAVING AVG(value) > 80`. |
| 11. Encryption/Compression in Python Scripts via Libraries | Adversaries use Python's zlib module in scripts for archiving, as potentially in custom APT tools. Hunt in dev-heavy Linux/cloud. | - Script Execution (Sysmon ID 1 for python.exe)<br>- Module Imports | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python*" CommandLine="*import zlib*" \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath contains "python" and ProcessCommandLine contains "import zlib" \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : 'python*' AND process.args : '*import*zlib*' \| TABLE @timestamp, host.name, process.command_line`. |
| 12. Volume Spikes in Library Load Events | Sudden increases in zlib/libzip loads, signaling campaigns like Lazarus Group's data compression before C2 upload. | - Aggregate Metrics (SIEM stats)<br>- Load Events | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded="*zlib*" \| timechart span=1h count \| where count > avg(count)*4`.<br>- **KQL**: `DeviceImageLoadEvents \| where FolderPath contains "zlib" \| summarize HourlyCount=count() by bin(Timestamp, 1h) \| where HourlyCount > avg(HourlyCount) * 4`.<br>- **ELK**: `FROM logs-endpoint.library-* \| WHERE dll.name : '*zlib*' \| STATS COUNT() BY date_histogram(@timestamp, '1h') \| WHERE COUNT() > AVG(COUNT()) * 4`. |
| 13. Library Usage Followed by Network Exfiltration | Correlate loads (e.g., zlib in BBSRAT) with outbound traffic to C2, common in Windows for compressed data sends. | - Network Connections (Sysmon ID 3)<br>- Library Loads (ID 7) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded="*zlib*" \| transaction ProcessGuid maxspan=2m [search EventCode=3 DestinationPort=443] \| where eventcount > 1 \| table _time, DestinationIp`.<br>- **KQL**: `DeviceImageLoadEvents \| where FolderPath contains "zlib" \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 443) on ProcessId \| project Timestamp, RemoteIP`.<br>- **ELK**: `FROM logs-endpoint.library-* \| WHERE dll.name : '*zlib*' \| JOIN logs-endpoint.network-* ON process.pid WHERE destination.port = 443 \| TABLE @timestamp, destination.ip`. |
| 14. Custom aPLib or Rare Library Loads | Detect niche libs like aPLib in BADFLICK, indicating targeted APTs in mixed environments. | - Module Loads (Sysmon ID 7)<br>- File Hashes | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded="*aplib*" \| stats count by ImageLoaded, Hashes \| where count > 1`.<br>- **KQL**: `DeviceImageLoadEvents \| where FolderPath contains "aplib" \| summarize count() by FolderPath, SHA256 \| where count_ > 1`.<br>- **ELK**: `FROM logs-endpoint.library-* \| WHERE dll.name : '*aplib*' \| STATS COUNT() BY dll.path, file.hash HAVING COUNT() > 1`. |
| 15. Archiving Libraries in Containerized Environments | In Kubernetes/Docker, adversaries load zlib in pods for data prep, as potentially in cloud-based APTs. Hunt via container audits. | - Container Logs (e.g., K8s events)<br>- Library Loads in Pods | - **Splunk**: `index=container sourcetype=k8s:events "dlopen" argument="*zlib.so*" \| stats count by pod_name \| where count > 3`.<br>- **KQL**: `KubeEvents \| where Verb == "exec" and Message contains "dlopen" and AdditionalFields.argument contains "zlib.so" \| summarize count() by ObjectRef.name \| where count_ > 3`.<br>- **ELK**: `FROM logs-kubernetes.events-* \| WHERE kubernetes.event.verb = 'exec' AND message : '*dlopen*' AND args : '*zlib.so*' \| STATS COUNT() BY kubernetes.pod.name HAVING COUNT() > 3`.


### Archive via Utility

### Threat Hunting Hypotheses for Archive Collected Data: Archive via Utility (MITRE ATT&CK T1560.001)

Adversaries may use utilities to compress and/or encrypt collected data prior to exfiltration, often abusing pre-installed tools like `tar` on Linux/macOS, `zip` on Windows, or third-party utilities such as 7-Zip, WinRAR, and WinZip. This technique has been observed in various threat actors, including Agrius using 7-Zip, Akira employing WinRAR, APT1 with RAR, and APT28 using password-protected WinRAR archives. Detection focuses on command-line executions, file creations, and behavioral correlations across Windows, Linux, and cloud environments, assuming moderate telemetry like EDR/Sysmon.

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Execution of Third-Party Archiving Utilities | Adversaries execute tools like WinRAR or 7-Zip to archive data, as seen in groups like HAFNIUM and Ke3chang. High risk in Windows environments with unmonitored user installs. | - Process Creation (e.g., Sysmon Event ID 1)<br>- Command Execution Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search Image IN ("*rar.exe*", "*7z.exe*", "*winzip.exe*") AND CommandLine="*a *" \| stats count by host, CommandLine \| where count > 3` (Detects archive creation commands).<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("rar.exe", "7z.exe", "winzip.exe") and ProcessCommandLine contains "a " \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.events.process-* \| WHERE process.name : ("rar.exe" OR "7z.exe" OR "winzip.exe") AND process.args : "*a*" \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 3`. |
| 2. Use of Built-in Compression Utilities | Adversaries leverage native tools like `tar`, `gzip`, or `Compress-Archive` for archiving, common in Linux/Windows as in APT28's Nearest Neighbor Campaign. | - Command Execution (e.g., auditd execve, Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search CommandLine IN ("*tar czf*", "*gzip -c*", "*Compress-Archive*") \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("tar czf", "gzip -c", "Compress-Archive") \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : ("*tar*czf*" OR "*gzip*-c*" OR "*Compress-Archive*") \| TABLE @timestamp, host.name, process.command_line`. |
| 3. Creation of Password-Protected Archives | Adversaries add passwords via utilities (e.g., RAR -p, 7z -p), as in BRONZE BUTLER and Mustang Panda operations. Hunt in environments with sensitive data staging. | - Process Creation (Sysmon ID 1 with flags) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search CommandLine=("* -p*" OR "* -hp*" OR "*password*") AND Image IN ("*rar.exe*", "*7z.exe*") \| stats count by host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains_any (" -p", " -hp", "password") and FolderPath has_any ("rar.exe", "7z.exe") \| summarize count() by DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : ("*-p*" OR "*-hp*" OR "*password*") AND process.name : ("rar.exe" OR "7z.exe") \| STATS COUNT() BY host.name, process.command_line`. |
| 4. Archiving in Suspicious Directories | Utilities create archives in temp or user dirs for staging, as in InvisiMole and Daserf hiding in .rar files. | - File Creation (Sysmon ID 11)<br>- Endpoint File Changes | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 \| search TargetFilename=(*.rar OR *.7z OR *.zip) AND TargetFilename IN ("*temp*", "*AppData*", "*staging*") \| stats values(TargetFilename) by host \| where mvcount(TargetFilename) > 2`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FileName endswith_any (".rar", ".7z", ".zip") and FolderPath has_any ("temp", "AppData", "staging") \| summarize Files=make_set(FileName) by DeviceName \| where array_length(Files) > 2`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'creation' AND file.extension : ('rar' OR '7z' OR 'zip') AND file.path : ("*temp*" OR "*AppData*" OR "*staging*") \| STATS SET(file.name) BY host.name HAVING CARDINALITY(file.name) > 2`. |
| 5. Utility Execution Followed by Exfiltration | Correlate archiving (e.g., WinRAR in Earth Lusca) with network outbound, common in APT41. | - Process Network (Sysmon ID 3)<br>- File Creation (ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=1 CommandLine="*rar a*") OR (EventCode=3 DestinationPort IN (80,443)) \| transaction ProcessGuid maxspan=5m \| where eventcount > 1 \| table _time, host, DestinationIp`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "rar a" \| join kind=inner (DeviceNetworkEvents \| where RemotePort in (80,443)) on ProcessId \| project Timestamp, DeviceName, RemoteIP`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : "*rar*a*" \| JOIN logs-endpoint.network-* ON process.pid WHERE destination.port IN [80,443] \| TABLE @timestamp, host.name, destination.ip`. |
| 6. Use of Cab or Makecab for Packaging | Adversaries use Windows-native `makecab.exe` for compression, as in MuddyWater and APT41. | - Process Creation (Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*makecab.exe*" CommandLine="* /D *" \| stats count by host, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "makecab.exe" and ProcessCommandLine contains " /D " \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name = 'makecab.exe' AND process.args : '*/D*' \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 5`. |
| 7. Base64 Encoding via Certutil for Archiving | Use of `certutil -encode` to prepare data, correlated with archiving as in certutil examples. | - Command Execution (Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*certutil.exe*" CommandLine="* -encode *" \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "certutil.exe" and ProcessCommandLine contains " -encode " \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name = 'certutil.exe' AND process.args : '*-encode*' \| TABLE @timestamp, host.name, process.command_line`. |
| 8. Archiving in Cloud via CLI Utilities | In cloud, use of `zip` or `7z` in instances before S3 upload, as potentially in HAFNIUM. | - Cloud Audit Logs (e.g., AWS CloudTrail)<br>- Instance Process Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="RunInstances" \| join instanceId [search "zip " OR "7z "] \| stats count by userIdentity, eventName \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "RunInstances" \| join kind=inner (AzureActivity \| where Message has_any ("zip", "7z")) on ResourceId \| summarize count() by Caller, OperationName \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'RunInstances' \| JOIN logs-azure.activity-* ON resource.id WHERE message : ('*zip*' OR '*7z*') \| STATS COUNT() BY user.identity, event.action HAVING COUNT() > 10`. |
| 9. High Volume of Archive File Creations | Spikes in .rar/.zip creations indicating bulk archiving, as in FIN13 using 7zip. | - File Metrics (EDR aggregate)<br>- File Creation Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename=*.rar \| timechart span=1h count \| where count > avg(count)*3`.<br>- **KQL**: `DeviceFileEvents \| where FileName endswith ".rar" \| summarize HourlyCount=count() by bin(Timestamp, 1h) \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : '*.rar' \| STATS COUNT() BY date_histogram(@timestamp, '1h') \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 10. Utility Usage Correlated with Data Collection | Link utilities (e.g., RAR in Lotus Blossom) to collection events like file access. | - Multi-Event (Sysmon IDs 1, 11) | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=1 "*rar.exe*") \| transaction host maxspan=10m [search EventCode=11 "*sensitive*"] \| where eventcount > 1 \| table host, _time`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath contains "rar.exe" \| join kind=inner (DeviceFileEvents \| where FolderPath contains "sensitive") on DeviceName \| project DeviceName, Timestamp`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : 'rar.exe' \| JOIN logs-endpoint.file-* ON host.name WHERE file.path : '*sensitive*' \| TABLE host.name, @timestamp`. |
| 11. Scripting Wrappers for Utility Archiving | Scripts (e.g., PowerShell invoking Compress-Archive) for batch archiving, as in APT28. | - Script Execution (Sysmon ID 1 for powershell) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe*" CommandLine="*Compress-Archive*" \| stats count by host, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "powershell.exe" and ProcessCommandLine contains "Compress-Archive" \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name = 'powershell.exe' AND process.args : '*Compress-Archive*' \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 5`. |
| 12. Anomalous Resource Usage from Utilities | CPU spikes from compression (e.g., 7zr.exe in FunnyDream), indicating large datasets. | - Performance Logs (Perfmon)<br>- Process Metrics | - **Splunk**: `index=endpoint sourcetype=perfmon "Processor Time" > 70 \| join host [search sourcetype=sysmon "*7z.exe*"] \| stats avg(Value) by host`.<br>- **KQL**: `PerfMetrics \| where CounterName == "Processor Time" and Value > 70 \| join kind=inner (DeviceProcessEvents \| where FolderPath contains "7z.exe") on DeviceName \| summarize AvgCPU=avg(Value) by DeviceName`.<br>- **ELK**: `FROM logs-perfmon-* \| WHERE counter.name = 'Processor Time' AND value > 70 \| JOIN logs-endpoint.process-* ON host.name WHERE process.name : '*7z.exe*' \| STATS AVG(value) BY host.name`. |
| 13. Archiving with Modified or Custom Utilities | Use of altered RAR (e.g., in Chimera), detected via hash mismatches. | - File Hashes (Sysmon ID 11)<br>- Process Integrity | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*rar.exe*" AND Hashes != known_rar_hash \| stats count by Image, Hashes`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "rar.exe" and SHA256 != "known_rar_hash" \| summarize count() by FolderPath, SHA256`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name = 'rar.exe' AND process.hash != 'known_hash' \| STATS COUNT() BY process.executable, process.hash`. |
| 14. Utility Archiving in Linux Containers | In Docker/K8s, use of `tar` for archiving (e.g., in Cutting Edge), hunt via pod logs. | - Container Events (K8s audits) | - **Splunk**: `index=container sourcetype=k8s:events "exec" Command="*tar czf*" \| stats count by pod_name \| where count > 3`.<br>- **KQL**: `KubeEvents \| where Verb == "exec" and Message contains "tar czf" \| summarize count() by ObjectRef.name \| where count_ > 3`.<br>- **ELK**: `FROM logs-kubernetes.events-* \| WHERE kubernetes.event.verb = 'exec' AND message : '*tar*czf*' \| STATS COUNT() BY kubernetes.pod.name HAVING COUNT() > 3`. |
| 15. Combined Utility with Encryption Tools | Archiving followed by encryption (e.g., gzip in Magic Hound), correlated events. | - Process Chains (Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 (CommandLine="*gzip*" OR CommandLine="*encrypt*") \| transaction host maxspan=2m \| where eventcount > 1 \| table _time, host`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("gzip", "encrypt") \| summarize Events=make_set(ProcessCommandLine) by bin(Timestamp, 2m), DeviceName \| where array_length(Events) > 1`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : ("*gzip*" OR "*encrypt*") \| STATS SET(process.command_line) BY date_histogram(@timestamp, '2m'), host.name HAVING CARDINALITY(process.command_line) > 1`.


### Audio Capture

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Unauthorized Access to Audio Devices via API Calls | Adversaries use APIs like WaveInOpen (Windows) or ALSA/PulseAudio (Linux) to capture audio without user consent, common in spyware like FinSpy. High risk in Windows endpoints with microphones. | - API Monitoring (e.g., ETW traces, Sysmon ID 10 for calls)<br>- Process Memory Events | - **Splunk**: `index=endpoint sourcetype=etw \| search CallTrace="*waveInOpen*" OR CallTrace="*audioRecord*" AND NOT ProcessName IN (legit_apps_like_zoom) \| stats count by ProcessName \| where count > 5` (Flags suspicious API calls).<br>- **KQL**: `DeviceEvents \| where ActionType == "ApiCall" and AdditionalFields.CallName has_any ("waveInOpen", "audioRecord") and not(InitiatingProcessName in~ (legitApps)) \| summarize count() by InitiatingProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-etw-* \| WHERE event.action = 'apicall' AND trace.call : ("*waveInOpen*" OR "*audioRecord*") AND process.name NOT IN ['zoom.exe'] \| STATS COUNT() BY process.name HAVING COUNT() > 5`. |
| 2. Execution of Known Audio Capture Tools | Adversaries deploy tools like SoundRecorder.exe (Windows) or arecord (Linux) for capturing, as seen in APT campaigns. Hunt in mixed OS environments. | - Process Creation (e.g., Sysmon ID 1)<br>- Command Execution Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search Image IN ("*SoundRecorder.exe*", "*arecord*", "*sox*") AND CommandLine="*record*" \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("SoundRecorder.exe", "arecord", "sox") and ProcessCommandLine contains "record" \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("SoundRecorder.exe" OR "arecord" OR "sox") AND process.args : "*record*" \| TABLE @timestamp, host.name, process.command_line`. |
| 3. Anomalous Microphone Device File Access | In Linux, adversaries access /dev/snd or /dev/audio for capture. Detect unusual opens in server environments. | - File Access Logs (e.g., auditd openat)<br>- System Calls | - **Splunk**: `index=endpoint sourcetype=auditd syscall="openat" \| search path IN ("/dev/snd/*", "/dev/audio") AND NOT exe IN (legit_audio_apps) \| stats count by exe, path \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileOpened" and FolderPath has_any ("/dev/snd", "/dev/audio") and not(InitiatingProcessFolderPath in~ (legitApps)) \| summarize count() by InitiatingProcessFolderPath, FolderPath \| where count_ > 3`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE syscall.name = 'openat' AND file.path : ("/dev/snd/*" OR "/dev/audio") AND process.exe NOT IN ['pulseaudio'] \| STATS COUNT() BY process.exe, file.path HAVING COUNT() > 3`. |
| 4. Audio Capture Followed by Data Staging | Correlate capture commands with file writes to staging dirs, common in espionage for audio exfil. | - Process Creation (Sysmon ID 1)<br>- File Creation (ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=1 CommandLine="*record audio*") \| transaction ProcessGuid maxspan=5m [search EventCode=11 TargetFilename="*wav" OR "*mp3"] \| where eventcount > 1 \| table _time, host, TargetFilename`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "record audio" \| join kind=inner (DeviceFileEvents \| where FileName endswith_any (".wav", ".mp3")) on ProcessId \| project Timestamp, DeviceName, FileName`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : "*record*audio*" \| JOIN logs-endpoint.file-* ON process.pid WHERE file.name : ("*.wav" OR "*.mp3") \| TABLE @timestamp, host.name, file.name`. |
| 5. PowerShell or Scripting for Audio Capture | Adversaries use scripts (e.g., PowerShell with Media.Recorder) for stealthy capture in Windows. | - Script Execution (Sysmon ID 1 for powershell.exe)<br>- Module Loads | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe*" CommandLine="*Media.Recorder*" OR CommandLine="*audio capture*" \| stats count by host, CommandLine \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "powershell.exe" and ProcessCommandLine has_any ("Media.Recorder", "audio capture") \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name = 'powershell.exe' AND process.args : ("*Media.Recorder*" OR "*audio*capture*") \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 2`. |
| 6. Driver or Kernel Module Loads for Audio Interception | Adversaries load malicious drivers (e.g., via LoadLibrary) to hook audio streams, as in advanced rootkits. Hunt in high-visibility Windows/Linux. | - Driver Loads (Sysmon ID 6)<br>- Module Loads (ID 7) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=6 \| search ImageLoaded="*audio.sys*" OR Hashes="unknown" \| stats values(ImageLoaded) by host \| where mvcount(ImageLoaded) > 1`.<br>- **KQL**: `DeviceDriverEvents \| where ActionType == "DriverLoaded" and FolderPath contains "audio.sys" or SHA256 == "unknown" \| summarize Drivers=make_set(FolderPath) by DeviceName \| where array_length(Drivers) > 1`.<br>- **ELK**: `FROM logs-endpoint.driver-* \| WHERE event.action = 'load' AND (driver.name : "*audio.sys*" OR driver.hash = 'unknown') \| STATS SET(driver.name) BY host.name HAVING CARDINALITY(driver.name) > 1`. |
| 7. Audio Capture in Browser or Web Apps | Adversaries exploit getUserMedia API in browsers for web-based capture. Detect in endpoint with browser telemetry. | - Browser Events (e.g., Chrome/Edge logs)<br>- Network Content | - **Splunk**: `index=endpoint sourcetype=browser_log \| search event="getUserMedia" AND mediaType="audio" AND NOT domain IN (trusted_domains) \| stats count by domain, host \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "BrowserEvent" and AdditionalFields.event == "getUserMedia" and AdditionalFields.mediaType == "audio" and not(AdditionalFields.domain in~ (trustedDomains)) \| summarize count() by AdditionalFields.domain, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-browser-* \| WHERE event.name = 'getUserMedia' AND media.type = 'audio' AND url.domain NOT IN ['zoom.us'] \| STATS COUNT() BY url.domain, host.name HAVING COUNT() > 5`. |
| 8. Cloud Instance Audio Capture Attempts | In cloud VMs (AWS/Azure), adversaries run capture tools on instances with attached mics (rare but possible in VDI). | - Cloud Logs (e.g., AWS CloudTrail for instance actions)<br>- Instance Process Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="RunInstances" \| join instanceId [search "arecord" OR "SoundRecorder"] \| stats count by userIdentity \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "RunInstances" \| join kind=inner (AzureActivity \| where Message has_any ("arecord", "SoundRecorder")) on ResourceId \| summarize count() by Caller \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'RunInstances' \| JOIN logs-azure.activity-* ON resource.id WHERE message : ('*arecord*' OR '*SoundRecorder*') \| STATS COUNT() BY user.identity HAVING COUNT() > 10`. |
| 9. Anomalous Audio File Creations | Detect creation of .wav/.mp3 files in unusual locations or volumes, indicating capture staging. | - File Creation (Sysmon ID 11)<br>- File Metadata | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename=(*.wav OR *.mp3) AND TargetFilename IN ("*temp*", "*hidden*") \| stats count by TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FileName endswith_any (".wav", ".mp3") and FolderPath has_any ("temp", "hidden") \| summarize count() by FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'creation' AND file.extension : ('wav' OR 'mp3') AND file.path : ("*temp*" OR "*hidden*") \| STATS COUNT() BY file.name, host.name HAVING COUNT() > 3`. |
| 10. Resource Spikes During Audio Capture | High CPU/disk from encoding during capture, correlated with audio processes. | - Performance Metrics (Perfmon CPU/Disk)<br>- Process Logs | - **Splunk**: `index=endpoint sourcetype=perfmon "Processor Time" > 50 \| join host [search sourcetype=sysmon "*audio capture*"] \| stats avg(Value) by host \| where avg_Value > 50`.<br>- **KQL**: `PerfMetrics \| where CounterName == "Processor Time" and Value > 50 \| join kind=inner (DeviceProcessEvents \| where ProcessCommandLine contains "audio capture") on DeviceName \| summarize AvgCPU=avg(Value) by DeviceName \| where AvgCPU > 50`.<br>- **ELK**: `FROM logs-perfmon-* \| WHERE counter.name = 'Processor Time' AND value > 50 \| JOIN logs-endpoint.process-* ON host.name WHERE process.args : '*audio*capture*' \| STATS AVG(value) BY host.name HAVING AVG(value) > 50`. |
| 11. Audio Capture Malware Indicators | Detect known malware like FinFisher via hashes or strings in processes. | - File Scans (EDR YARA)<br>- Process Creation | - **Splunk**: `index=endpoint sourcetype=edr_scan \| search Strings="*audio spy*" OR Hashes="known_malware_hash" \| stats values(file_name) by host \| where mvcount(file_name) > 1`.<br>- **KQL**: `DeviceFileEvents \| where AdditionalFields.Strings contains "audio spy" or SHA256 == "known_malware_hash" \| summarize Files=make_set(FileName) by DeviceName \| where array_length(Files) > 1`.<br>- **ELK**: `FROM logs-edr.scan-* \| WHERE file.strings : "*audio*spy*" OR file.hash = 'known_hash' \| STATS SET(file.name) BY host.name HAVING CARDINALITY(file.name) > 1`. |
| 12. Volume Spikes in Audio-Related Events | Sudden increases in audio API calls, signaling campaigns. | - Aggregate Metrics (SIEM stats)<br>- API Events | - **Splunk**: `index=endpoint sourcetype=etw CallTrace="*waveIn*" \| timechart span=1h count \| where count > avg(count)*4`.<br>- **KQL**: `DeviceEvents \| where AdditionalFields.CallName contains "waveIn" \| summarize HourlyCount=count() by bin(Timestamp, 1h) \| where HourlyCount > avg(HourlyCount) * 4`.<br>- **ELK**: `FROM logs-etw-* \| WHERE trace.call : '*waveIn*' \| STATS COUNT() BY date_histogram(@timestamp, '1h') \| WHERE COUNT() > AVG(COUNT()) * 4`. |
| 13. Audio Capture Correlated with Exfiltration | Link capture to outbound traffic (e.g., to C2). | - Network Connections (Sysmon ID 3)<br>- Process Events (ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*record*" \| transaction ProcessGuid maxspan=2m [search EventCode=3 DestinationPort=443] \| where eventcount > 1 \| table _time, DestinationIp`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "record" \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 443) on ProcessId \| project Timestamp, RemoteIP`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : '*record*' \| JOIN logs-endpoint.network-* ON process.pid WHERE destination.port = 443 \| TABLE @timestamp, destination.ip`. |
| 14. Persistent Audio Capture via Services | Adversaries install services (e.g., via sc.exe) for ongoing capture. | - Service Creation (Sysmon ID 1 for sc.exe)<br>- Registry Changes (ID 13) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*sc.exe*" CommandLine="*create*" AND Description="*audio*" \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "sc.exe" and ProcessCommandLine contains "create" and AdditionalFields.Description contains "audio" \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name = 'sc.exe' AND process.args : '*create*' AND service.description : '*audio*' \| TABLE @timestamp, host.name, process.command_line`. |
| 15. Audio Capture in Virtual Environments | In VDI/cloud desktops, detect capture attempts via virtual audio devices. | - Virtualization Logs (e.g., VMware/Hyper-V events)<br>- Device Access | - **Splunk**: `index=virtual sourcetype=vmware_log \| search event="audio access" AND guest_os="windows" AND NOT user IN (authorized) \| stats count by guest_ip \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "VirtualDeviceAccess" and AdditionalFields.device == "audio" and not(InitiatingProcessAccountName in~ (authorizedUsers)) \| summarize count() by RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-vmware-* \| WHERE event.name = 'audio access' AND guest.os = 'windows' AND user.name NOT IN ['admin'] \| STATS COUNT() BY guest.ip HAVING COUNT() > 5`.


### Automated Collection


### Browser Session Hijacking


### Clipboard Data


### Code Repositories


### Confluence


### Credential API Hooking


### Customer Relationship Management Software


### DHCP Spoofing


### Data Staged
