---
layout: default
title: Collection
category: Hunting-Queries  # This becomes a main topic in sidebar
---

## Collection
### ARP Cache Poisoning (MITRE ATT&CK T1557.002)

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Gratuitous ARP Replies from Unauthorized Hosts | Adversaries may send unsolicited (gratuitous) ARP replies to poison caches without prior requests, targeting high-traffic segments in Windows/Linux LANs to intercept traffic. High risk in flat networks with no ARP inspection. | - Network Traffic Content (e.g., Zeek ARP logs, PCAP from Wireshark/Snort)<br>- Network Traffic Flow (e.g., NetFlow, switch logs) | - **Splunk**: `index=network sourcetype=zeek_arp \| where opcode="reply" AND request_ip IS NULL \| stats count by src_mac, dst_ip \| where count > 5` (Looks for replies without matching requests; threshold for anomalies).<br>- **KQL (Sentinel/XDR)**: `DeviceNetworkEvents \| where ActionType == "ArpReply" and AdditionalFields.requestIp == "" \| summarize count() by InitiatingProcessSHA256, RemoteIP \| where count_ > 5`.<br>- **ELK/SQL-like**: `FROM logs-zeek.arp-* \| WHERE opcode = 'reply' AND request.ip IS NULL \| STATS COUNT() BY source.mac GROUP BY destination.ip HAVING COUNT() > 5`. |
| 2. Multiple IPs Mapping to Single MAC in ARP Caches | Adversaries poison endpoint ARP caches, causing duplicate MAC associations (e.g., attacker claims multiple IPs). Common in Windows environments; hunt via periodic cache audits. | - Endpoint ARP Cache Changes (e.g., Windows Event Logs ID 2003/2004 via Sysmon, Linux /proc/net/arp via auditd)<br>- Network Traffic Content | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=10 \| search "arp.exe" OR "Get-NetNeighbor" \| rex field=Message "IP=(?<ip>\S+) MAC=(?<mac>\S+)" \| stats dc(ip) by mac \| where dc_ip > 1` (Detects duplicates).<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "arp -a" \| extend IP = extract("IP: (\\S+)", 1, ProcessCommandLine), MAC = extract("MAC: (\\S+)", 1, ProcessCommandLine) \| summarize UniqueIPs = dcount(IP) by MAC \| where UniqueIPs > 1`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code = "10" AND process.args : "arp*" \| STATS DISTINCT_COUNT(ip_address) BY mac_address HAVING DISTINCT_COUNT(ip_address) > 1`. |
| 3. ARP Replies Faster Than Legitimate Responses | Adversaries race to reply to ARP requests before legitimate hosts, poisoning caches in real-time. Detect via timing anomalies in high-visibility networks (e.g., with packet timestamps). | - Network Traffic Content (e.g., Suricata ARP alerts, Zeek with timestamps)<br>- Packet Captures | - **Splunk**: `index=network sourcetype=suricata protocol=arp \| eval response_time = mvindex(timestamp,1) - mvindex(timestamp,0) \| where opcode="reply" AND response_time < 0.01 \| stats count by src_mac` (Flags sub-10ms replies as suspicious).<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "ARP" and ActionType == "Reply" \| extend ResponseDelta = datetime_diff('millisecond', Timestamp, PreviousEvent.Timestamp) \| where ResponseDelta < 10 \| summarize by DeviceId, RemoteIP`.<br>- **ELK**: `FROM logs-suricata-* \| WHERE event.module = 'arp' AND event.kind = 'reply' \| EVAL delta = @timestamp - lag(@timestamp, 1) OVER (PARTITION BY source.mac) \| WHERE delta < 10ms \| STATS COUNT() BY source.mac`. |
| 4. Unknown/Unexpected Hardware Devices via ARP | Adversaries introduce rogue devices (e.g., Raspberry Pi) that send ARP to poison caches. Hunt in environments with DHCP integration for MAC mismatches. | - Network Traffic Flow (e.g., DHCP logs, switch port security)<br>- Device Inventory (e.g., asset management tools) | - **Splunk**: `index=network sourcetype=dhcp \| join src_mac [search sourcetype=arp] \| where NOT src_mac IN (known_macs_list) \| stats values(ip) by src_mac` (Correlates unknown MACs from ARP with DHCP).<br>- **KQL**: `DeviceNetworkEvents \| where ActionType == "DhcpLease" or ActionType == "ArpRequest" \| where not( InitiatingProcessSHA256 in~ (knownDevices) ) \| summarize IPs = make_set(RemoteIP) by DeviceId`.<br>- **ELK**: `FROM logs-dhcp-* \| JOIN logs-arp-* ON source.mac \| WHERE source.mac NOT IN ["known_mac1", "known_mac2"] \| STATS VALUES(ip) BY source.mac`. |
| 5. ARP Poisoning Tool Artifacts on Endpoints | Adversaries use tools like arpspoof, Ettercap, or Scapy for poisoning. Detect process creation or command-line in Windows/Linux endpoints. | - Process Creation (e.g., Sysmon Event ID 1, auditd execve)<br>- Command Execution Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search Image="*ettercap*" OR Image="*arpspoof*" OR CommandLine="*scapy*" \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("ettercap", "arpspoof", "scapy.all") or ProcessCommandLine contains "arp spoof" \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.events.process-* \| WHERE event.category = 'process' AND (process.name : "ettercap*" OR process.args : "*arp*spoof*") \| TABLE @timestamp, host.name, process.command_line`. |
| 6. Anomalous ARP Traffic Volume Spikes | Adversaries flood with ARP replies during poisoning campaigns, causing volume spikes in Linux-heavy environments. | - Network Traffic Content (e.g., Zeek/Snort aggregate stats)<br>- Flow Metrics | - **Splunk**: `index=network sourcetype=zeek_arp \| timechart span=1h count by opcode \| where opcode="reply" AND count > avg(count)*3` (Baselines and alerts on 3x spikes).<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "ARP" \| summarize HourlyCount = count() by bin(Timestamp, 1h), ActionType \| where ActionType == "Reply" and HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-zeek.arp-* \| STATS COUNT() BY date_histogram(field='@timestamp', interval='1h'), opcode \| WHERE opcode = 'reply' AND COUNT() > AVG(COUNT()) * 3`. |
| 7. ARP Cache Changes Correlated with MitM Indicators | Post-poisoning, adversaries manipulate traffic; hunt cache changes followed by unexpected redirects (e.g., in cloud-hybrid setups with VPNs). | - Endpoint Logs (e.g., Windows NetNeighbor changes)<br>- Network Traffic Flow | - **Splunk**: `index=endpoint sourcetype=win_event \| search EventID=2003 \| join host [search sourcetype=network "unexpected_redirect"] \| stats count by mac, ip`.<br>- **KQL**: `DeviceNetworkEvents \| where ActionType == "ArpCacheUpdate" \| join kind=inner (DeviceNetworkEvents \| where ActionType == "ConnectionRedirected") on DeviceId \| summarize by Timestamp, RemoteIP`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 2003 \| JOIN logs-network-* ON host.id WHERE event.action = 'redirect' \| STATS COUNT() BY mac, ip`. |
| 8. Gratuitous ARP from Non-Gateway Devices | Adversaries mimic gateways with gratuitous ARP to poison multiple hosts; detect in segmented networks. | - Network Traffic Content<br>- Device Logs | - **Splunk**: `index=network sourcetype=arp \| where opcode="reply" AND src_ip != gateway_ip \| stats count by src_mac \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where ActionType == "GratuitousArp" and RemoteIP != "gateway_ip" \| summarize SuspiciousCount = count() by DeviceId \| where SuspiciousCount > 10`.<br>- **ELK**: `FROM logs-arp-* \| WHERE opcode = 'reply' AND source.ip != '192.168.1.1' \| STATS COUNT() BY source.mac HAVING COUNT() > 10`. |
| 9. ARP Poisoning in Conjunction with Credential Harvesting | Adversaries combine poisoning with tools like Responder for LLMNR poisoning; hunt in Windows domains. | - Network Traffic Content (ARP + LLMNR)<br>- Service Creation Logs | - **Splunk**: `index=network (sourcetype=arp opcode="reply") OR (sourcetype=llmnr "responder") \| transaction src_mac maxspan=1m \| where eventcount > 1 \| table src_mac, _time`.<br>- **KQL**: `DeviceNetworkEvents \| where (Protocol == "ARP" and ActionType == "Reply") or (Protocol == "LLMNR" and ActionType == "Query") \| summarize Events = make_set(ActionType) by bin(Timestamp, 1m), DeviceId \| where array_length(Events) > 1`.<br>- **ELK**: `FROM logs-network-* \| WHERE (event.module = 'arp' AND event.kind = 'reply') OR (event.module = 'llmnr' AND event.kind = 'query') \| STATS SET(events) BY date_histogram(@timestamp, '1m'), host.id \| WHERE CARDINALITY(events) > 1`. |
| 10. Dynamic ARP Inspection (DAI) Violations | Adversaries trigger DAI errors on switches during poisoning attempts; hunt in Cisco-managed networks. | - Switch Logs (e.g., Cisco syslog for DAI)<br>- Network Alerts | - **Splunk**: `index=network sourcetype=cisco:ios "DAI" "invalid ARP" \| stats count by src_mac, interface \| where count > 1` (From Splunk Security Content).<br>- **KQL**: `DeviceAlertEvents \| where AlertTitle contains "DAI Violation" or Description contains "ARP Inspection" \| summarize by Timestamp, RemoteIP`.<br>- **ELK**: `FROM logs-cisco-* \| WHERE message : "*DAI*invalid*ARP*" \| STATS COUNT() BY source.mac, interface HAVING COUNT() > 1`.


### Adversary-in-the-Middle

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. LLMNR/NBT-NS Poisoning via Unsolicited Responses | Adversaries respond to LLMNR/NBT-NS queries with falsified information to redirect traffic, common in Windows environments for credential relay attacks. High risk in domains without mDNS disabled. | - Network Traffic Content (e.g., Zeek DNS/LLMNR logs, PCAP)<br>- Network Traffic Flow (e.g., NetFlow with protocol metadata) | - **Splunk**: `index=network sourcetype=zeek_llmnr \| where opcode="response" AND query_type="A" AND src_ip NOT IN (known_dns_servers) \| stats count by src_ip, queried_name \| where count > 5` (Detects unsolicited responses from non-DNS servers).<br>- **KQL (Sentinel/XDR)**: `DeviceNetworkEvents \| where Protocol == "LLMNR" and ActionType == "Response" and RemoteIP !in~ (knownDNSServers) \| summarize count() by RemoteIP, AdditionalFields.queriedName \| where count_ > 5`.<br>- **ELK/SQL-like**: `FROM logs-zeek.llmnr-* \| WHERE event.kind = 'response' AND source.ip NOT IN ['dns1', 'dns2'] \| STATS COUNT() BY source.ip, query.name HAVING COUNT() > 5`. |
| 2. Relay Attacks Following LLMNR Poisoning | Adversaries use tools like Responder to relay captured NTLM hashes after poisoning. Hunt in Windows-heavy networks for relay indicators post-poisoning. | - Network Traffic Content (e.g., Suricata NTLM rules)<br>- Endpoint Process Creation (e.g., Sysmon ID 1 for Responder.exe) | - **Splunk**: `index=network sourcetype=suricata "NTLM relay" OR index=endpoint sourcetype=sysmon EventCode=1 Image="*responder.exe*" \| transaction src_ip maxspan=5m \| where eventcount > 1 \| table _time, src_ip`.<br>- **KQL**: `DeviceNetworkEvents \| where ActionType == "NtlmRelay" or (DeviceProcessEvents \| where ProcessName == "Responder.exe") \| join kind=inner on DeviceId \| project Timestamp, RemoteIP`.<br>- **ELK**: `FROM logs-suricata-* \| WHERE message : "*NTLM*relay*" \| JOIN logs-endpoint.events.process-* ON host.id WHERE process.name = 'responder.exe' \| STATS COUNT() BY @timestamp, source.ip`. |
| 3. DHCP Spoofing via Rogue Servers | Adversaries set up rogue DHCP servers to assign malicious gateways/DNS, enabling AiTM. Common in wireless or unsecured LANs (Windows/Linux/cloud edge). | - Network Traffic Content (e.g., Zeek DHCP logs)<br>- Switch Logs (e.g., DHCP snooping violations) | - **Splunk**: `index=network sourcetype=zeek_dhcp \| where type="offer" AND server_ip NOT IN (authorized_dhcp_servers) \| stats values(assigned_ip) by server_ip \| where count > 3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DHCP" and ActionType == "Offer" and RemoteIP !in~ (authorizedServers) \| summarize AssignedIPs = make_set(AdditionalFields.assignedIp) by RemoteIP \| where array_length(AssignedIPs) > 3`.<br>- **ELK**: `FROM logs-zeek.dhcp-* \| WHERE event.kind = 'offer' AND server.ip NOT IN ['dhcp1'] \| STATS SET(assigned.ip) BY server.ip HAVING CARDINALITY(assigned.ip) > 3`. |
| 4. Anomalous DHCP Lease Assignments | Adversaries issue short-lived leases or unusual options (e.g., WPAD) via spoofed DHCP for AiTM persistence. Hunt in dynamic IP environments. | - Network Traffic Flow (e.g., DHCP option fields in PCAP)<br>- Endpoint Logs (e.g., Windows Event ID 169 for DHCP) | - **Splunk**: `index=network sourcetype=dhcp \| where option_code=252 OR lease_time < 300 \| stats count by client_mac, option_value \| where count > 10` (Flags WPAD or short leases).<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.optionCode == 252 or AdditionalFields.leaseTime < 300 \| summarize count() by DeviceId, AdditionalFields.optionValue \| where count_ > 10`.<br>- **ELK**: `FROM logs-dhcp-* \| WHERE dhcp.option.code = 252 OR dhcp.lease.time < 300 \| STATS COUNT() BY client.mac, dhcp.option.value HAVING COUNT() > 10`. |
| 5. ARP Cache Poisoning (Expanded from Sub-Technique) | Building on T1557.002, adversaries poison ARP for local MitM; detect via cache mismatches in mixed OS environments. | - Endpoint ARP Cache (e.g., Sysmon, auditd)<br>- Network Traffic Content | - **Splunk**: `index=endpoint sourcetype=sysmon "arp cache" \| rex "IP=(?<ip>\S+) MAC=(?<mac>\S+)" \| stats values(mac) by ip \| where mvcount(mac) > 1` (Multiple MACs per IP).<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "arp" \| extend IP=extract("IP:(\\S+)",1,ProcessCommandLine), MAC=extract("MAC:(\\S+)",1,ProcessCommandLine) \| summarize MACs=make_set(MAC) by IP \| where array_length(MACs) > 1`.<br>- **ELK**: `FROM logs-endpoint-* \| WHERE message : "*arp*cache*" \| STATS SET(mac) BY ip HAVING CARDINALITY(mac) > 1`. |
| 6. SSL/TLS Downgrade or Stripping Attacks | Adversaries perform SSL stripping (HSTS bypass) in AiTM to intercept HTTPS traffic. High risk in public Wi-Fi or cloud proxies. | - Network Traffic Content (e.g., Zeek HTTP/SSL logs)<br>- Proxy Logs (e.g., Squid, Zscaler) | - **Splunk**: `index=network sourcetype=zeek_http \| where status=301 AND uri="*http://" AND referer="*https://" \| stats count by src_ip, host \| where count > 5` (HTTPS to HTTP redirects).<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.status == 301 and AdditionalFields.uri startswith "http://" and AdditionalFields.referer startswith "https://" \| summarize count() by RemoteIP, AdditionalFields.host \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.status = 301 AND http.uri : "http://*" AND http.referer : "https://*" \| STATS COUNT() BY source.ip, http.host HAVING COUNT() > 5`. |
| 7. Rogue Access Point Detection | Adversaries deploy evil twin APs for wireless AiTM, spoofing SSIDs. Hunt in enterprise Wi-Fi environments (Linux/AP hardware). | - Wireless Logs (e.g., Cisco WLC, Aruba)<br>- Endpoint Connection Events (e.g., Windows WLAN-AutoConfig) | - **Splunk**: `index=wireless sourcetype=cisco:wlc "rogue AP" OR EventID=110002 \| stats count by ssid, mac \| where count > 1 AND ssid IN (corporate_ssids)`.<br>- **KQL**: `DeviceNetworkEvents \| where ActionType == "WlanConnection" and AdditionalFields.ssid in~ (corporateSSIDs) \| summarize count() by AdditionalFields.mac \| where count_ > 1`.<br>- **ELK**: `FROM logs-wireless-* \| WHERE message : "*rogue*AP*" OR winlog.event_id = 110002 \| STATS COUNT() BY ssid, mac HAVING COUNT() > 1 AND ssid IN ['corp1']`. |
| 8. Unexpected Proxy or Tunnel Usage in AiTM | Adversaries force traffic through malicious proxies (e.g., via WPAD) for interception. Common in cloud-hybrid setups. | - Proxy Logs (e.g., web gateway events)<br>- Browser Extension Logs | - **Splunk**: `index=proxy sourcetype=bluecoat \| where proxy_url NOT IN (approved_proxies) OR action="denied" "suspicious tunnel" \| stats values(user) by proxy_url \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteUrl !in~ (approvedProxies) or ActionType == "ProxyDenied" \| summarize Users=make_set(InitiatingProcessAccountName) by RemoteUrl \| where array_length(Users) > 10`.<br>- **ELK**: `FROM logs-proxy-* \| WHERE url : NOT IN ['proxy1'] OR event.action = 'denied' \| STATS SET(user) BY url HAVING CARDINALITY(user) > 10`. |
| 9. Credential Harvesting via AiTM Pharming | Adversaries redirect to fake login pages post-AiTM (e.g., via DNS poisoning). Hunt for pharming indicators in web traffic. | - Network Traffic Content (e.g., Suricata HTTP rules for phishing)<br>- DNS Logs | - **Splunk**: `index=network (sourcetype=dns "unexpected resolution") OR sourcetype=http "login phishing" \| transaction domain maxspan=1m \| where eventcount > 1 \| table domain, src_ip`.<br>- **KQL**: `DeviceNetworkEvents \| where (Protocol == "DNS" and ActionType == "UnexpectedResolution") or (Protocol == "HTTP" and AdditionalFields contains "login") \| join kind=inner on RemoteUrl \| project RemoteUrl, InitiatingProcessAccountSid`.<br>- **ELK**: `FROM logs-dns-* \| WHERE event.action = 'unexpected' \| JOIN logs-http-* ON domain WHERE message : '*login*phishing*' \| STATS COUNT() BY domain, source.ip`. |
| 10. AiTM Tool Execution on Compromised Hosts | Adversaries run tools like Bettercap, Mitmproxy for AiTM. Detect in Linux/Windows endpoints with deep visibility. | - Process Creation (e.g., Sysmon ID 1, auditd)<br>- Command-Line Auditing | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search Image IN ("*bettercap*", "*mitmproxy*", "*sslsplit*") \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("bettercap", "mitmproxy", "sslsplit") \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.events.process-* \| WHERE process.name IN ['bettercap', 'mitmproxy'] \| TABLE @timestamp, host.name, process.command_line`. |
| 11. Traffic Redirection Anomalies in Cloud Environments | In cloud (AWS/Azure), adversaries use VPC peering or route table hijacks for AiTM. Hunt via cloud logs. | - Cloud Audit Logs (e.g., AWS CloudTrail, Azure Activity Logs)<br>- Network Flow Logs (VPC Flow) | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="ModifyRouteTable" OR "Unauthorized peering" \| stats count by userIdentity, resource \| where count > 1`.<br>- **KQL**: `AzureActivity \| where OperationNameValue == "Microsoft.Network/routeTables/routes/write" \| summarize count() by Caller, ResourceId \| where count_ > 1`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'ModifyRouteTable' \| STATS COUNT() BY user.identity, resource HAVING COUNT() > 1`. |
| 12. NBT-NS Query Flooding for DoS/AiTM Setup | Adversaries flood NBT-NS queries to exhaust resources before poisoning. Detect spikes in Windows networks. | - Network Traffic Flow (e.g., NetFlow volume)<br>- DNS Logs | - **Splunk**: `index=network sourcetype=nbtns \| timechart span=5m count by src_ip \| where count > avg(count)*5` (5x baseline spikes).<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "NBTNS" \| summarize MinCount=count() by bin(Timestamp, 5m), RemoteIP \| where MinCount > avg(MinCount) * 5`.<br>- **ELK**: `FROM logs-nbtns-* \| STATS COUNT() BY date_histogram(@timestamp, '5m'), source.ip \| WHERE COUNT() > AVG(COUNT()) * 5`. |
| 13. Combined AiTM with Lateral Movement | Adversaries use AiTM to capture creds for lateral movement; correlate poisoning with auth events. | - Authentication Logs (e.g., Windows 4624)<br>- Network Traffic Content | - **Splunk**: `index=security EventID=4624 \| join src_ip [search sourcetype=arp "poison"] \| where LogonType=3 \| stats values(target_user) by src_ip`.<br>- **KQL**: `SecurityEvent \| where EventID == 4624 and LogonType == 3 \| join kind=inner (DeviceNetworkEvents \| where ActionType == "ArpPoison") on RemoteIP \| summarize Users=make_set(AccountName) by RemoteIP`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 4624 \| JOIN logs-arp-* ON source.ip WHERE event.action = 'poison' \| STATS SET(user) BY source.ip`. |
| 14. HSTS Bypass Attempts in AiTM | Adversaries attempt to bypass HSTS preloads during SSL stripping. Hunt in browser/telemetry-rich environments. | - Browser Logs (e.g., Chrome/Edge telemetry)<br>- HTTP Traffic | - **Splunk**: `index=browser sourcetype=chrome "HSTS bypass" OR sourcetype=http "preload ignore" \| stats count by domain, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields contains "HSTS Bypass" or ActionType == "PreloadIgnore" \| summarize count() by AdditionalFields.domain, InitiatingProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-browser-* \| WHERE message : "*HSTS*bypass*" \| STATS COUNT() BY domain, user.agent HAVING COUNT() > 5`. |
| 15. Persistent AiTM via Modified Network Configurations | Adversaries alter host configs (e.g., /etc/hosts, Windows hosts file) for long-term redirection. Hunt in Linux/Windows endpoints. | - File Modification Logs (e.g., Sysmon ID 11 for hosts file)<br>- Configuration Change Audits | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename="*hosts" \| table _time, host, ProcessGuid, TargetFilename`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileModified" and FolderPath endswith "hosts" \| project Timestamp, DeviceName, SHA256`.<br>- **ELK**: `FROM logs-endpoint.events.file-* \| WHERE event.action = 'modification' AND file.path : '*hosts' \| TABLE @timestamp, host.name, process.id, file.path`.


### Archive Collected Data

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Use of Built-in Archiving Utilities on Sensitive Data | Adversaries use native tools like Compress-Archive (PowerShell) or tar/gzip to archive collected data in staging directories, common in Windows/Linux environments for compression before exfil. High risk in environments with unmonitored temp folders. | - Command Execution (e.g., Sysmon Event ID 1, auditd execve)<br>- File Creation/Modification (e.g., Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search CommandLine="*Compress-Archive*" OR CommandLine="*tar -czf*" OR CommandLine="*gzip*" \| where Path="*temp*" OR Path="*staging*" \| stats count by host, CommandLine \| where count > 5` (Detects archiving in suspicious paths).<br>- **KQL (Sentinel/XDR)**: `DeviceProcessEvents \| where ProcessCommandLine contains "Compress-Archive" or ProcessCommandLine contains "tar -czf" or ProcessCommandLine contains "gzip" and FolderPath has_any ("temp", "staging") \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK/SQL-like**: `FROM logs-endpoint.events.process-* \| WHERE event.category = "process" AND (process.args : "*Compress-Archive*" OR process.args : "*tar*czf*" OR process.args : "*gzip*") AND file.path : ("*temp*" OR "*staging*") \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 5`. |
| 2. Third-Party Archiving Tool Execution | Adversaries deploy tools like 7-Zip, WinRAR, or zip for high-compression archiving, often in Windows environments. Hunt for process creation anomalies in non-standard installs. | - Process Creation (e.g., Sysmon ID 1)<br>- Module Load (e.g., Sysmon ID 7 for DLLs) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search Image IN ("*7z.exe*", "*rar.exe*", "*zip.exe*") AND NOT Image IN (approved_paths) \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("7z.exe", "rar.exe", "zip.exe") and not(FolderPath in~ (approvedPaths)) \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.events.process-* \| WHERE process.name IN ['7z.exe', 'rar.exe', 'zip.exe'] AND process.executable NOT IN ['C:\\Program Files\\*'] \| TABLE @timestamp, host.name, process.command_line`. |
| 3. Archive File Creation in Unusual Locations | Adversaries create .zip/.tar.gz files in user profiles or system dirs for staging. Common in Linux/cloud for data aggregation. | - File Creation (e.g., Sysmon ID 11, auditd create)<br>- Endpoint File System Changes | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 \| search TargetFilename=(*.zip OR *.tar.gz OR *.rar) AND (TargetFilename="*AppData*" OR TargetFilename="*tmp*") \| stats values(TargetFilename) by host \| where mvcount(TargetFilename) > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FileName endswith_any (".zip", ".tar.gz", ".rar") and FolderPath has_any ("AppData", "tmp") \| summarize Files=make_set(FileName) by DeviceName \| where array_length(Files) > 3`.<br>- **ELK**: `FROM logs-endpoint.events.file-* \| WHERE event.action = 'creation' AND file.extension IN ['zip', 'tar.gz', 'rar'] AND file.path : ("*AppData*" OR "*tmp*") \| STATS SET(file.name) BY host.name HAVING CARDINALITY(file.name) > 3`. |
| 4. High-Entropy File Creations Indicating Custom Archiving | Adversaries use custom methods (e.g., scripts) creating high-entropy archived files. Hunt in environments with deep file telemetry for obfuscated data. | - File Metadata (e.g., custom entropy scanners via EDR)<br>- File Creation Logs | - **Splunk**: `index=endpoint sourcetype=edr_file \| where entropy > 7.0 AND file_extension IN ("bin", "dat", "archive") \| stats count by file_path, host \| where count > 1` (Assumes entropy field; threshold for compressed data).<br>- **KQL**: `DeviceFileEvents \| where AdditionalFields.entropy > 7.0 and FileName endswith_any ("bin", "dat") \| summarize count() by FolderPath, DeviceName \| where count_ > 1`.<br>- **ELK**: `FROM logs-edr.file-* \| WHERE file.entropy > 7.0 AND file.extension : ('bin' OR 'dat') \| STATS COUNT() BY file.path, host.name HAVING COUNT() > 1`. |
| 5. Archiving Followed by Network Exfiltration | Correlate archiving commands with subsequent outbound connections, common in cloud environments for data staging before upload. | - Process Network (e.g., Sysmon ID 3)<br>- Cloud Access Logs (e.g., AWS S3 PutObject) | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=1 CommandLine="*zip*") OR (EventCode=3 DestinationPort=443) \| transaction ProcessGuid maxspan=5m \| where mvcount(EventCode)=2 \| table _time, host, DestinationIp`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "zip" \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 443) on ProcessId \| project Timestamp, DeviceName, RemoteIP`.<br>- **ELK**: `FROM logs-endpoint.events.process-* \| WHERE process.args : "*zip*" \| JOIN logs-endpoint.events.network-* ON process.pid WHERE destination.port = 443 \| TABLE @timestamp, host.name, destination.ip`. |
| 6. Library-Based Archiving via API Calls | Adversaries use libraries like zlib or SharpCompress in custom malware for in-memory archiving. Hunt via module loads in Windows/Linux. | - Module Load (e.g., Sysmon ID 7 for zlib.dll)<br>- Process Memory Dumps (if available) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 \| search ImageLoaded IN ("*zlib*", "*libzip*", "*compression.dll*") AND ParentImage NOT IN (legit_apps) \| stats count by host, ImageLoaded`.<br>- **KQL**: `DeviceImageLoadEvents \| where FolderPath has_any ("zlib", "libzip") and not(InitiatingProcessFolderPath in~ (legitApps)) \| summarize count() by DeviceName, FolderPath`.<br>- **ELK**: `FROM logs-endpoint.events.library-* \| WHERE dll.name : ("*zlib*" OR "*libzip*") AND process.parent.name NOT IN ['chrome.exe'] \| STATS COUNT() BY host.name, dll.path`. |
| 7. Password-Protected Archive Creation | Adversaries add passwords to archives (e.g., zip -P) for evasion. Detect in high-risk environments with command-line auditing. | - Command Execution (e.g., Sysmon ID 1 with password flags) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search CommandLine=("*zip -P*" OR "*7z a -p*" OR "*rar a -hp*") \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains_any ("zip -P", "7z a -p", "rar a -hp") \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.events.process-* \| WHERE process.args : ("*zip*-P*" OR "*7z*a*-p*" OR "*rar*a*-hp*") \| TABLE @timestamp, host.name, process.command_line`. |
| 8. Archiving in Cloud Storage Buckets | In cloud (AWS/Azure), adversaries archive data via CLI/tools before syncing to buckets. Hunt via cloud audit logs. | - Cloud API Calls (e.g., AWS CloudTrail for s3:PutObject with .zip)<br>- Storage Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="PutObject" AND object_key=*.zip \| stats count by userIdentity, bucketName \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "PutObject" and AdditionalFields.objectKey endswith ".zip" \| summarize count() by Caller, ResourceId \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'PutObject' AND s3.object.key : '*.zip' \| STATS COUNT() BY user.identity, s3.bucket HAVING COUNT() > 10`. |
| 9. Anomalous File Size Changes Post-Archiving | Detect files shrinking significantly after archiving commands, indicating compression of large datasets in Linux servers. | - File Modification (e.g., auditd, Sysmon ID 2/11)<br>- Size Metrics | - **Splunk**: `index=endpoint sourcetype=auditd "type=SYSCALL" exe="*tar*" \| join path [search sourcetype=sysmon EventCode=11] \| eval size_change = new_size - old_size \| where size_change < -1000000 \| stats values(path) by host` (Flags >1MB reduction).<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileModified" and PreviousFileSize - FileSize > 1000000 \| join kind=inner (DeviceProcessEvents \| where ProcessCommandLine contains "tar") on FolderPath \| summarize Paths=make_set(FolderPath) by DeviceName`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE event.module = 'syscall' AND process.exe : '*tar*' \| JOIN logs-endpoint.file-* ON file.path \| EVAL change = file.size.before - file.size.after \| WHERE change > 1000000 \| STATS SET(path) BY host.name`. |
| 10. Scripting for Batch Archiving Operations | Adversaries use scripts (e.g., bash/PowerShell) to archive multiple files. Hunt for script executions targeting data dirs in mixed environments. | - Script Execution (e.g., Sysmon ID 1 for powershell.exe)<br>- File Access Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe*" CommandLine="*Archive*" OR Image="*bash*" CommandLine="*tar*" \| stats count by host, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where (FolderPath endswith "powershell.exe" and ProcessCommandLine contains "Archive") or (FolderPath endswith "bash" and ProcessCommandLine contains "tar") \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE (process.name = 'powershell.exe' AND process.args : '*Archive*') OR (process.name = 'bash' AND process.args : '*tar*') \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 5`. |
| 11. Archive via Custom Encryption/Compression Methods | Adversaries implement custom archiving with encryption (e.g., via Python zipfile with AES). Detect via unusual module loads or process behaviors. | - Module Load (e.g., Sysmon ID 7)<br>- Process Creation | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=7 ImageLoaded="*pycryptodome*") OR (EventCode=1 Image="*python*" CommandLine="*zipfile*") \| transaction ProcessGuid maxspan=1m \| where eventcount > 1`.<br>- **KQL**: `DeviceImageLoadEvents \| where FolderPath contains "pycryptodome" \| join kind=inner (DeviceProcessEvents \| where FolderPath contains "python" and ProcessCommandLine contains "zipfile") on ProcessId`.<br>- **ELK**: `FROM logs-endpoint.library-* \| WHERE dll.name : '*pycryptodome*' \| JOIN logs-endpoint.process-* ON process.pid WHERE process.name = 'python' AND process.args : '*zipfile*' \| STATS COUNT() BY @timestamp`. |
| 12. Volume Spikes in File Archiving Activity | Detect sudden increases in archiving-related events, indicating bulk data collection in high-visibility cloud setups. | - Aggregate Metrics (e.g., SIEM volume stats)<br>- Process Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*archive*" \| timechart span=1h count \| where count > avg(count)*4` (4x baseline).<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "archive" \| summarize HourlyCount=count() by bin(Timestamp, 1h) \| where HourlyCount > avg(HourlyCount) * 4`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : '*archive*' \| STATS COUNT() BY date_histogram(@timestamp, '1h') \| WHERE COUNT() > AVG(COUNT()) * 4`. |
| 13. Archiving Correlated with Data Collection Techniques | Link archiving to prior collection (e.g., after screenshot capture or clipboard access) for chained behaviors. | - Multi-Event Correlation (e.g., Sysmon IDs 1, 11, 13) | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=13 "clipboard") OR (EventCode=1 "*zip*") \| transaction host maxspan=10m \| where mvcount(EventCode)>1 \| table host, _time`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "zip" \| join kind=inner (DeviceRegistryEvents \| where RegistryKey contains "clipboard") on DeviceName \| project DeviceName, Timestamp`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : '*zip*' \| JOIN logs-endpoint.registry-* ON host.name WHERE registry.key : '*clipboard*' \| TABLE host.name, @timestamp`. |
| 14. Archive Files with Embedded Exfil Indicators | Detect archives named suspiciously or with metadata hinting at exfil (e.g., timestamps near network events). | - File Metadata (e.g., EDR file details)<br>- Network Correlation | - **Splunk**: `index=endpoint sourcetype=edr_file file_name=(*exfil*.zip) OR metadata="*staged*" \| join file_path [search sourcetype=network "outbound"] \| stats values(file_name) by host`.<br>- **KQL**: `DeviceFileEvents \| where FileName contains "exfil" and FileName endswith ".zip" \| join kind=inner (DeviceNetworkEvents \| where ActionType == "Outbound") on FolderPath \| summarize Files=make_set(FileName) by DeviceName`.<br>- **ELK**: `FROM logs-edr.file-* \| WHERE file.name : '*exfil*.zip' \| JOIN logs-network-* ON file.path WHERE event.action = 'outbound' \| STATS SET(file.name) BY host.name`. |
| 15. Archiving in Containerized or Virtual Environments | In cloud/Kubernetes, adversaries archive data within pods/VMs. Hunt via container logs for tar/zip usage. | - Container Logs (e.g., Docker/K8s audit)<br>- Cloud Instance Metadata | - **Splunk**: `index=container sourcetype=k8s:events "exec" Command="*tar czf*" OR "*zip*" \| stats count by pod_name, namespace \| where count > 3`.<br>- **KQL**: `KubeEvents \| where Verb == "exec" and ObjectRef.subresource == "command" and Message contains_any ("tar czf", "zip") \| summarize count() by ObjectRef.name, ObjectRef.namespace \| where count_ > 3`.<br>- **ELK**: `FROM logs-kubernetes.events-* \| WHERE kubernetes.event.verb = 'exec' AND message : ('*tar*czf*' OR '*zip*') \| STATS COUNT() BY kubernetes.pod.name, kubernetes.namespace HAVING COUNT() > 3`.


### Archive via Custom Method

### Threat Hunting Hypotheses for Archive via Custom Method (MITRE ATT&CK T1560.003)

Archive via Custom Method involves adversaries using bespoke techniques, such as XOR encryption or stream ciphers without external libraries, to compress or encrypt collected data before exfiltration. This sub-technique is prevalent in advanced persistent threats (APTs) like those observed in groups such as Hromcova or CopyKittens, where custom implementation evades standard utility detection. Hypotheses are tailored to environments with deep endpoint visibility (e.g., EDR), assuming moderate log sources; in low-visibility setups, focus on behavioral anomalies. I've generated 15 high-quality hypotheses, emphasizing custom scripting, in-memory operations, and post-archival indicators across Windows, Linux, and cloud.

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Custom XOR Encryption in PowerShell Scripts | Adversaries embed XOR operations in PowerShell for simple encryption of staged data, common in Windows environments to avoid utility footprints. High risk in script-heavy admin workflows. | - Script Execution (e.g., Sysmon Event ID 1 for powershell.exe)<br>- Command-Line Auditing | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe*" \| search CommandLine="*XOR*" OR CommandLine="*[char]0x*" \| where ScriptBlockText="*byte[]*" \| stats count by host, CommandLine \| where count > 3` (Flags XOR byte arrays).<br>- **KQL (Sentinel/XDR)**: `DeviceProcessEvents \| where FolderPath endswith "powershell.exe" and ProcessCommandLine contains "XOR" or ProcessCommandLine contains "[char]0x" and AdditionalFields.ScriptBlockText contains "byte[]" \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 3`.<br>- **ELK/SQL-like**: `FROM logs-endpoint.events.process-* \| WHERE process.name = "powershell.exe" AND (process.args : "*XOR*" OR process.args : "*[char]0x*") AND event.script : "*byte*[]" \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 3`. |
| 2. Stream Cipher Implementation via Python | Adversaries use Python with built-in modules (e.g., random for RC4-like streams) for custom archiving without crypto libs. Hunt in Linux/cloud dev environments. | - Process Creation (e.g., auditd execve for python)<br>- Script Logs | - **Splunk**: `index=endpoint sourcetype=auditd exe="*python*" \| search cmdline="*stream*" OR cmdline="*rc4*" OR cmdline="*keystream*" \| stats values(file) by host \| where mvcount(file) > 2`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath contains "python" and ProcessCommandLine has_any ("stream", "rc4", "keystream") \| summarize Files=make_set(FileName) by DeviceName \| where array_length(Files) > 2`.<br>- **ELK**: `FROM logs-auditd.events-* \| WHERE process.exe : "*python*" AND process.args : ("*stream*" OR "*rc4*" OR "*keystream*") \| STATS SET(file.path) BY host.name HAVING CARDINALITY(file.path) > 2`. |
| 3. In-Memory Custom Compression via .NET | Adversaries implement custom compression (e.g., LZ-like in C#) in memory to avoid disk writes. Detect via .NET runtime anomalies in Windows. | - .NET Runtime Events (e.g., Sysmon ID 7 for mscorlib.dll loads)<br>- Memory Forensics (if EDR-integrated) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded="*mscorlib*" \| join ProcessGuid [search EventCode=1 CommandLine="*DeflateStream*" OR CommandLine="*custom compress*"] \| stats count by host, ImageLoaded`.<br>- **KQL**: `DeviceImageLoadEvents \| where FolderPath contains "mscorlib" \| join kind=inner (DeviceProcessEvents \| where ProcessCommandLine contains "DeflateStream" or ProcessCommandLine contains "custom compress") on ProcessId \| summarize count() by DeviceName, FolderPath`.<br>- **ELK**: `FROM logs-sysmon.library-* \| WHERE dll.name : "*mscorlib*" \| JOIN logs-sysmon.process-* ON process.guid WHERE process.args : ("*DeflateStream*" OR "*custom*compress*") \| STATS COUNT() BY host.name, dll.path`. |
| 4. Anomalous High-Entropy Output Files from Scripts | Custom methods produce files with entropy >7.5 (indicative of encryption/compression). Hunt in mixed OS with file metadata visibility. | - File Creation (e.g., Sysmon ID 11)<br>- EDR File Entropy | - **Splunk**: `index=endpoint sourcetype=edr_file \| where entropy > 7.5 AND (parent_process="*powershell*" OR parent_process="*python*") AND file_extension IN ("dat", "bin") \| stats count by file_path, host \| where count > 1`.<br>- **KQL**: `DeviceFileEvents \| where AdditionalFields.entropy > 7.5 and InitiatingProcessFolderPath has_any ("powershell", "python") and FileName endswith_any (".dat", ".bin") \| summarize count() by FolderPath, DeviceName \| where count_ > 1`.<br>- **ELK**: `FROM logs-edr.file-* \| WHERE file.entropy > 7.5 AND process.parent.name : ("powershell" OR "python") AND file.extension : ("dat" OR "bin") \| STATS COUNT() BY file.path, host.name HAVING COUNT() > 1`. |
| 5. Custom Archiving Followed by Exfiltration Staging | Correlate custom script execution with file moves to staging dirs, common in APT data prep. | - File Modification (e.g., Sysmon ID 2)<br>- Network Staging (e.g., outbound prep) | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=1 CommandLine="*custom archive*" OR CommandLine="*encrypt xor*") \| transaction host maxspan=2m [search EventCode=2 TargetFilename="*staging*"] \| where eventcount > 1 \| table _time, host`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains_any ("custom archive", "encrypt xor") \| join kind=inner (DeviceFileEvents \| where ActionType == "FileRenamed" and FolderPath contains "staging") on DeviceName \| project Timestamp, DeviceName`.<br>- **ELK**: `FROM logs-sysmon.process-* \| WHERE process.args : ("*custom*archive*" OR "*encrypt*xor*") \| JOIN logs-sysmon.file-* ON host.name WHERE event.action = 'rename' AND file.path : "*staging*" \| TABLE @timestamp, host.name`. |
| 6. Embedded Custom Encryption in Executables | Adversaries inject custom XOR/stream code into PE/ELF binaries for self-archiving. Detect via binary modifications. | - File Changes (e.g., Sysmon ID 11 for exe changes)<br>- PE/ELF Parsing (EDR) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename=(*.exe OR *.elf) \| search Hashes="*modified*" OR "section entropy high" \| stats values(TargetFilename) by host`.<br>- **KQL**: `DeviceFileEvents \| where FileName endswith_any (".exe", ".elf") and AdditionalFields.Modified == true or AdditionalFields.SectionEntropy > 7 \| summarize Files=make_set(FileName) by DeviceName`.<br>- **ELK**: `FROM logs-sysmon.file-* \| WHERE file.name : ("*.exe" OR "*.elf") AND (file.hash : "*modified*" OR file.section.entropy > 7) \| STATS SET(file.name) BY host.name`. |
| 7. PowerShell Obfuscation with Custom Byte Encoding | Adversaries use base64 or custom byte flips for encoding archived data in scripts. High risk in Windows with AMSI bypass attempts. | - Script Block Logging (e.g., PowerShell logs)<br>- AMSI Events | - **Splunk**: `index=endpoint sourcetype=powershell \| search ScriptBlockText=(*[Convert]::ToBase64String* OR *byte flip*) AND OpCode="*Invoke-Expression*" \| stats count by host`.<br>- **KQL**: `DeviceEvents \| where AdditionalFields.ScriptBlockText contains "[Convert]::ToBase64String" or AdditionalFields.ScriptBlockText contains "byte flip" and AdditionalFields.OpCode == "Invoke-Expression" \| summarize count() by DeviceName`.<br>- **ELK**: `FROM logs-powershell-* \| WHERE event.script : ("*[Convert]::ToBase64String*" OR "*byte*flip*") AND event.opcode = "Invoke-Expression" \| STATS COUNT() BY host.name`. |
| 8. Custom Method Usage in Cloud Functions | In cloud (AWS Lambda/Azure Functions), adversaries implement custom encryption in serverless code. Hunt via function logs. | - Cloud Logs (e.g., AWS CloudWatch, Azure Monitor)<br>- Code Execution Logs | - **Splunk**: `index=cloud sourcetype=aws:lambda \| search log="*XOR encrypt*" OR log="*custom compress*" \| stats count by function_name, runtime \| where count > 5`.<br>- **KQL**: `AzureActivity \| where ResourceProvider == "Microsoft.Web/sites" and Message contains_any ("XOR encrypt", "custom compress") \| summarize count() by ResourceId, Runtime \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.lambda-* \| WHERE message : ("*XOR*encrypt*" OR "*custom*compress*") \| STATS COUNT() BY function.name, runtime HAVING COUNT() > 5`. |
| 9. Anomalous CPU/Memory Spikes During Custom Archiving | Custom computations (e.g., stream generation) cause resource spikes on endpoints. Detect in Linux servers with process metrics. | - Process Metrics (e.g., Perfmon, auditd)<br>- Resource Usage Logs | - **Splunk**: `index=endpoint sourcetype=perfmon CounterName="Processor\% Time" \| join host [search sourcetype=auditd exe="*python*" cmdline="*cipher*"] \| where Value > 80 \| stats avg(Value) by host`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "cipher" \| join kind=inner (PerfMetrics \| where CounterName == "Processor % Time" and Value > 80) on DeviceName \| summarize AvgCPU = avg(Value) by DeviceName`.<br>- **ELK**: `FROM logs-perfmon-* \| WHERE counter.name = "Processor% Time" \| JOIN logs-auditd-* ON host.name WHERE process.args : "*cipher*" \| WHERE value > 80 \| STATS AVG(value) BY host.name`. |
| 10. Custom Archiving Artifacts in Malware Samples | Adversaries leave strings like "custom_xor_key" in binaries. Hunt via string extraction in EDR scans. | - File Scans (e.g., Sysmon ID 11 with content)<br>- YARA Matches | - **Splunk**: `index=endpoint sourcetype=edr_scan \| search Strings="*custom_xor*" OR Strings="*stream_cipher*" \| stats values(file_hash) by host \| where mvcount(file_hash) > 1`.<br>- **KQL**: `DeviceFileEvents \| where AdditionalFields.ExtractedStrings contains_any ("custom_xor", "stream_cipher") \| summarize Hashes=make_set(SHA256) by DeviceName \| where array_length(Hashes) > 1`.<br>- **ELK**: `FROM logs-edr.scan-* \| WHERE file.strings : ("*custom_xor*" OR "*stream_cipher*") \| STATS SET(file.hash.sha256) BY host.name HAVING CARDINALITY(file.hash.sha256) > 1`. |
| 11. Chained Custom Archiving with Collection | Link custom methods to prior collection (e.g., keylogging output encrypted via XOR). | - Event Correlation (e.g., Sysmon multi-ID)<br>- Behavioral Chains | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=13 "keylog") \| transaction host maxspan=5m [search EventCode=1 "*XOR*"] \| where eventcount > 1`.<br>- **KQL**: `DeviceRegistryEvents \| where RegistryKey contains "keylog" \| join kind=inner (DeviceProcessEvents \| where ProcessCommandLine contains "XOR") on DeviceName \| project DeviceName, Timestamp`.<br>- **ELK**: `FROM logs-sysmon.registry-* \| WHERE registry.key : "*keylog*" \| JOIN logs-sysmon.process-* ON host.name WHERE process.args : "*XOR*" \| TABLE host.name, @timestamp`. |
| 12. Custom Encryption Without Crypto APIs | Adversaries avoid Windows CryptoAPI, using raw math libs for ciphers. Detect module absences. | - Module Load (e.g., Sysmon ID 7)<br>- API Calls (ETW) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 \| search NOT ImageLoaded IN ("*crypt32.dll*", "*bcrypt.dll*") AND ProcessImage="*script*" \| stats count by ProcessImage`.<br>- **KQL**: `DeviceImageLoadEvents \| where not(FolderPath in~ ("crypt32.dll", "bcrypt.dll")) and InitiatingProcessFolderPath contains "script" \| summarize count() by InitiatingProcessFolderPath`.<br>- **ELK**: `FROM logs-sysmon.library-* \| WHERE NOT dll.name IN ['crypt32.dll', 'bcrypt.dll'] AND process.name : "*script*" \| STATS COUNT() BY process.image.path`. |
| 13. Volume of Custom Script Executions | Spikes in ad-hoc script runs for archiving, indicating campaign activity in cloud. | - Aggregate Process Logs<br>- Execution Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*custom encrypt*" \| timechart span=1h count \| where count > avg(count)*3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "custom encrypt" \| summarize HourlyCount=count() by bin(Timestamp, 1h) \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-sysmon.process-* \| WHERE process.args : "*custom*encrypt*" \| STATS COUNT() BY date_histogram(@timestamp, '1h') \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 14. Custom Method in Bash with Base64/XOR | Linux adversaries combine base64 with XOR in bash for quick archiving. Hunt in server farms. | - Command Execution (e.g., auditd)<br>- Shell History | - **Splunk**: `index=endpoint sourcetype=auditd exe="*bash*" \| search cmdline=(*base64* OR *xxd*) AND cmdline="*XOR*" \| table _time, host, cmdline`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "bash" and ProcessCommandLine has_any ("base64", "xxd") and ProcessCommandLine contains "XOR" \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-auditd.process-* \| WHERE process.exe : "*bash*" AND process.args : ("*base64*" OR "*xxd*") AND process.args : "*XOR*" \| TABLE @timestamp, host.name, process.command_line`. |
| 15. Post-Custom Archive Network Anomalies | Encrypted blobs trigger unusual outbound patterns (e.g., small, frequent sends). Correlate in hybrid environments. | - Network Flow (e.g., Zeek connections)<br>- File-Network Joins | - **Splunk**: `index=network sourcetype=zeek_conn \| join src_ip [search sourcetype=edr_file entropy>7.5] \| where bytes > 10000 AND duration < 10 \| stats count by src_ip`.<br>- **KQL**: `DeviceNetworkEvents \| where TotalBytes > 10000 and Duration < 10 \| join kind=inner (DeviceFileEvents \| where AdditionalFields.entropy > 7.5) on RemoteIP \| summarize count() by RemoteIP`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE bytes > 10000 AND duration < 10 \| JOIN logs-edr.file-* ON source.ip WHERE file.entropy > 7.5 \| STATS COUNT() BY source.ip`.


### Archive via Library

### Threat Hunting Hypotheses for Archive Collected Data: Archive via Library (MITRE ATT&CK T1560.002)

Adversaries may compress or encrypt collected data using third-party libraries like zlib, libzip, or aPLib before exfiltration, often to obfuscate content and evade detection. This technique is observed across platforms (Windows, Linux, macOS) and in malware such as InvisiMole (using zlib for compression), FoggyWeb (invoking GZipStream), and Lazarus Group tools (zlib compression for victim data). Detections can focus on library loads, API calls, and correlated file behaviors; in low-visibility environments, prioritize endpoint telemetry for anomalies like high-entropy outputs.

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Suspicious Loading of Compression Libraries in Non-Standard Processes | Adversaries load libraries like zlib.dll or libzip.so in processes not typically associated with archiving (e.g., web browsers or custom malware), as seen in BBSRAT and InvisiMole. High risk in Windows/Linux environments with dynamic linking. | - Module Load Events (e.g., Sysmon Event ID 7)<br>- Process Creation (e.g., Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 \| search ImageLoaded IN ("*zlib*", "*libzip*", "*aplib*") AND NOT ParentImage IN (legit_apps_like_7zip) \| stats count by ProcessImage, ImageLoaded \| where count > 3`.<br>- **KQL**: `DeviceImageLoadEvents \| where FolderPath has_any ("zlib", "libzip", "aplib") and not(InitiatingProcessFolderPath in~ (legitApps)) \| summarize count() by InitiatingProcessFolderPath, FolderPath \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.events.library-* \| WHERE dll.name : ("*zlib*" OR "*libzip*" OR "*aplib*") AND process.parent.name NOT IN ['7z.exe', 'archive_app'] \| STATS COUNT() BY process.image.path, dll.path HAVING COUNT() > 3`. |
| 2. API Calls to Compression Functions Without Utility Execution | Adversaries invoke functions like deflateInit (from zlib) directly via custom code, bypassing tools like zip.exe, as in Cardinal RAT's ZLIB usage. Hunt in high-visibility EDR environments. | - API Monitoring (e.g., ETW traces, Sysmon ID 10 for calls)<br>- Process Memory Events | - **Splunk**: `index=endpoint sourcetype=etw \| search CallTrace="*deflateInit*" OR CallTrace="*gzcompress*" AND NOT Image="*zip.exe*" \| stats values(CallTrace) by ProcessGuid \| where mvcount(CallTrace) > 2`.<br>- **KQL**: `DeviceEvents \| where ActionType == "ApiCall" and AdditionalFields.CallName has_any ("deflateInit", "gzcompress") and not(FolderPath endswith "zip.exe") \| summarize Traces=make_set(AdditionalFields.CallName) by ProcessId \| where array_length(Traces) > 2`.<br>- **ELK**: `FROM logs-etw-* \| WHERE event.action = 'apicall' AND trace.call : ("*deflateInit*" OR "*gzcompress*") AND process.name != 'zip.exe' \| STATS SET(trace.call) BY process.guid HAVING CARDINALITY(trace.call) > 2`. |
| 3. High-Entropy File Creation After Library Loads | Custom library usage produces compressed/encrypted files with entropy >7.0, correlated with loads like zlib, as in FunnyDream's zLib compression. Common in Linux servers for staging. | - File Creation (e.g., Sysmon ID 11)<br>- File Metadata (EDR entropy scans) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 \| join ProcessGuid [search EventCode=7 ImageLoaded="*zlib*"] \| where entropy > 7.0 AND TargetFilename=(*.bin OR *.dat) \| stats count by TargetFilename, host \| where count > 1`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and AdditionalFields.entropy > 7.0 and FileName endswith_any (".bin", ".dat") \| join kind=inner (DeviceImageLoadEvents \| where FolderPath contains "zlib") on ProcessId \| summarize count() by FileName, DeviceName \| where count_ > 1`.<br>- **ELK**: `FROM logs-endpoint.events.file-* \| WHERE event.action = 'creation' AND file.entropy > 7.0 AND file.extension : ('bin' OR 'dat') \| JOIN logs-endpoint.library-* ON process.pid WHERE dll.name : '*zlib*' \| STATS COUNT() BY file.name, host.name HAVING COUNT() > 1`. |
| 4. Compression Library Usage in Malware Known for T1560.002 | Detect loads of libraries in processes matching known malware like FoggyWeb (GZipStream) or LunarWeb (zlib), often in Windows/cloud hybrid setups. | - Process Creation (e.g., Sysmon ID 1)<br>- Module Loads (Sysmon ID 7) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded IN ("*gzip*", "*zlib*") AND Image IN ("*foggyweb*", "*lunarweb*") \| table _time, host, ImageLoaded`.<br>- **KQL**: `DeviceImageLoadEvents \| where FolderPath has_any ("gzip", "zlib") and InitiatingProcessFolderPath has_any ("foggyweb", "lunarweb") \| project Timestamp, DeviceName, FolderPath`.<br>- **ELK**: `FROM logs-endpoint.library-* \| WHERE dll.name : ("*gzip*" OR "*zlib*") AND process.name : ("*foggyweb*" OR "*lunarweb*") \| TABLE @timestamp, host.name, dll.path`. |
| 5. Archiving via Preinstalled Libraries in macOS/Linux | Adversaries use built-in bzip2 or zlib on macOS/Linux without spawning utilities, as in Epic's bzip2 compression. Hunt for library calls in non-archive processes. | - System Calls (e.g., auditd syscall for dlopen)<br>- Library Loads | - **Splunk**: `index=endpoint sourcetype=auditd "syscall=dlopen" \| search argument="*bzip2.so*" OR argument="*zlib.so*" AND NOT exe="*tar*" \| stats count by exe, argument \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "dlopen" and AdditionalFields.argument has_any ("bzip2.so", "zlib.so") and not(FolderPath endswith "tar") \| summarize count() by FolderPath, AdditionalFields.argument \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE syscall.name = 'dlopen' AND syscall.args : ("*bzip2.so*" OR "*zlib.so*") AND process.exe != '*tar*' \| STATS COUNT() BY process.exe, syscall.args HAVING COUNT() > 5`. |
| 6. .NET GZipStream Invocation in Custom Assemblies | In Windows, adversaries use C# GZipStream for compression, as in FoggyWeb. Detect via .NET ETW or assembly loads. | - .NET Events (e.g., ETW MethodLoad)<br>- Assembly Loads | - **Splunk**: `index=endpoint sourcetype=etw_net \| search MethodName="GZipStream*" AND AssemblyName NOT IN (legit_assemblies) \| stats count by AssemblyName \| where count > 2`.<br>- **KQL**: `DeviceEvents \| where ActionType == "MethodLoad" and AdditionalFields.MethodName contains "GZipStream" and not(AdditionalFields.AssemblyName in~ (legitAssemblies)) \| summarize count() by AdditionalFields.AssemblyName \| where count_ > 2`.<br>- **ELK**: `FROM logs-etw.net-* \| WHERE event.method = 'GZipStream*' AND assembly.name NOT IN ['system.dll'] \| STATS COUNT() BY assembly.name HAVING COUNT() > 2`. |
| 7. Custom Library Deployment and Loading | Adversaries bring in custom libs (e.g., aPLib in BADFLICK) and load them dynamically. Hunt for unknown DLL/so file creations followed by loads. | - File Creation (Sysmon ID 11)<br>- Module Loads (Sysmon ID 7) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename=(*.dll OR *.so) AND Hashes="unknown" \| join TargetFilename [search EventCode=7] \| stats values(TargetFilename) by host \| where mvcount(TargetFilename) > 1`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FileName endswith_any (".dll", ".so") and SHA256 == "unknown" \| join kind=inner (DeviceImageLoadEvents) on FileName \| summarize Files=make_set(FileName) by DeviceName \| where array_length(Files) > 1`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'creation' AND file.extension : ('dll' OR 'so') AND file.hash = 'unknown' \| JOIN logs-endpoint.library-* ON file.name \| STATS SET(file.name) BY host.name HAVING CARDINALITY(file.name) > 1`. |
| 8. Library-Based Archiving in Cloud Environments | In AWS/Azure, adversaries use libraries like boto3 with zlib for S3 uploads. Detect API calls with compressed payloads. | - Cloud Audit Logs (e.g., CloudTrail PutObject)<br>- Object Metadata | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="PutObject" AND object_key=*.gz \| join userIdentity [search "zlib compress"] \| stats count by bucketName \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "PutObject" and AdditionalFields.objectKey endswith ".gz" \| join kind=inner (AzureActivity \| where Message contains "zlib compress") on ResourceId \| summarize count() by ResourceId \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'PutObject' AND s3.object.key : '*.gz' \| JOIN logs-azure.activity-* ON resource.id WHERE message : '*zlib*compress*' \| STATS COUNT() BY s3.bucket HAVING COUNT() > 10`. |
| 9. Correlated Library Loads with Data Collection Indicators | Link library loads (e.g., zlib) to prior collection events like screenshot captures, as in OSX_OCEANLOTUS.D's AES encryption post-collection. | - Multi-Event Correlation (Sysmon IDs 7, 13)<br>- Behavioral Analytics | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=7 ImageLoaded="*zlib*") \| transaction ProcessGuid maxspan=5m [search EventCode=13 "screenshot"] \| where eventcount > 1 \| table _time, host`.<br>- **KQL**: `DeviceImageLoadEvents \| where FolderPath contains "zlib" \| join kind=inner (DeviceRegistryEvents \| where RegistryKey contains "screenshot") on ProcessId \| project Timestamp, DeviceName`.<br>- **ELK**: `FROM logs-endpoint.library-* \| WHERE dll.name : '*zlib*' \| JOIN logs-endpoint.registry-* ON process.pid WHERE registry.key : '*screenshot*' \| TABLE @timestamp, host.name`. |
| 10. Anomalous Resource Usage During Library Compression | High CPU/memory spikes from compression calls (e.g., zlib in Denis malware), indicating bulk archiving in servers. | - Performance Metrics (e.g., Perfmon CPU)<br>- Library Events | - **Splunk**: `index=endpoint sourcetype=perfmon "Processor Time" > 80 \| join host [search sourcetype=sysmon EventCode=7 "*zlib*"] \| stats avg(Value) by host \| where avg_Value > 80`.<br>- **KQL**: `PerfMetrics \| where CounterName == "Processor Time" and Value > 80 \| join kind=inner (DeviceImageLoadEvents \| where FolderPath contains "zlib") on DeviceName \| summarize AvgCPU=avg(Value) by DeviceName \| where AvgCPU > 80`.<br>- **ELK**: `FROM logs-perfmon-* \| WHERE counter.name = 'Processor Time' AND value > 80 \| JOIN logs-endpoint.library-* ON host.name WHERE dll.name : '*zlib*' \| STATS AVG(value) BY host.name HAVING AVG(value) > 80`. |
| 11. Encryption/Compression in Python Scripts via Libraries | Adversaries use Python's zlib module in scripts for archiving, as potentially in custom APT tools. Hunt in dev-heavy Linux/cloud. | - Script Execution (Sysmon ID 1 for python.exe)<br>- Module Imports | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python*" CommandLine="*import zlib*" \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath contains "python" and ProcessCommandLine contains "import zlib" \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : 'python*' AND process.args : '*import*zlib*' \| TABLE @timestamp, host.name, process.command_line`. |
| 12. Volume Spikes in Library Load Events | Sudden increases in zlib/libzip loads, signaling campaigns like Lazarus Group's data compression before C2 upload. | - Aggregate Metrics (SIEM stats)<br>- Load Events | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded="*zlib*" \| timechart span=1h count \| where count > avg(count)*4`.<br>- **KQL**: `DeviceImageLoadEvents \| where FolderPath contains "zlib" \| summarize HourlyCount=count() by bin(Timestamp, 1h) \| where HourlyCount > avg(HourlyCount) * 4`.<br>- **ELK**: `FROM logs-endpoint.library-* \| WHERE dll.name : '*zlib*' \| STATS COUNT() BY date_histogram(@timestamp, '1h') \| WHERE COUNT() > AVG(COUNT()) * 4`. |
| 13. Library Usage Followed by Network Exfiltration | Correlate loads (e.g., zlib in BBSRAT) with outbound traffic to C2, common in Windows for compressed data sends. | - Network Connections (Sysmon ID 3)<br>- Library Loads (ID 7) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded="*zlib*" \| transaction ProcessGuid maxspan=2m [search EventCode=3 DestinationPort=443] \| where eventcount > 1 \| table _time, DestinationIp`.<br>- **KQL**: `DeviceImageLoadEvents \| where FolderPath contains "zlib" \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 443) on ProcessId \| project Timestamp, RemoteIP`.<br>- **ELK**: `FROM logs-endpoint.library-* \| WHERE dll.name : '*zlib*' \| JOIN logs-endpoint.network-* ON process.pid WHERE destination.port = 443 \| TABLE @timestamp, destination.ip`. |
| 14. Custom aPLib or Rare Library Loads | Detect niche libs like aPLib in BADFLICK, indicating targeted APTs in mixed environments. | - Module Loads (Sysmon ID 7)<br>- File Hashes | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded="*aplib*" \| stats count by ImageLoaded, Hashes \| where count > 1`.<br>- **KQL**: `DeviceImageLoadEvents \| where FolderPath contains "aplib" \| summarize count() by FolderPath, SHA256 \| where count_ > 1`.<br>- **ELK**: `FROM logs-endpoint.library-* \| WHERE dll.name : '*aplib*' \| STATS COUNT() BY dll.path, file.hash HAVING COUNT() > 1`. |
| 15. Archiving Libraries in Containerized Environments | In Kubernetes/Docker, adversaries load zlib in pods for data prep, as potentially in cloud-based APTs. Hunt via container audits. | - Container Logs (e.g., K8s events)<br>- Library Loads in Pods | - **Splunk**: `index=container sourcetype=k8s:events "dlopen" argument="*zlib.so*" \| stats count by pod_name \| where count > 3`.<br>- **KQL**: `KubeEvents \| where Verb == "exec" and Message contains "dlopen" and AdditionalFields.argument contains "zlib.so" \| summarize count() by ObjectRef.name \| where count_ > 3`.<br>- **ELK**: `FROM logs-kubernetes.events-* \| WHERE kubernetes.event.verb = 'exec' AND message : '*dlopen*' AND args : '*zlib.so*' \| STATS COUNT() BY kubernetes.pod.name HAVING COUNT() > 3`.


### Archive via Utility

### Threat Hunting Hypotheses for Archive Collected Data: Archive via Utility (MITRE ATT&CK T1560.001)

Adversaries may use utilities to compress and/or encrypt collected data prior to exfiltration, often abusing pre-installed tools like `tar` on Linux/macOS, `zip` on Windows, or third-party utilities such as 7-Zip, WinRAR, and WinZip. This technique has been observed in various threat actors, including Agrius using 7-Zip, Akira employing WinRAR, APT1 with RAR, and APT28 using password-protected WinRAR archives. Detection focuses on command-line executions, file creations, and behavioral correlations across Windows, Linux, and cloud environments, assuming moderate telemetry like EDR/Sysmon.

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Execution of Third-Party Archiving Utilities | Adversaries execute tools like WinRAR or 7-Zip to archive data, as seen in groups like HAFNIUM and Ke3chang. High risk in Windows environments with unmonitored user installs. | - Process Creation (e.g., Sysmon Event ID 1)<br>- Command Execution Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search Image IN ("*rar.exe*", "*7z.exe*", "*winzip.exe*") AND CommandLine="*a *" \| stats count by host, CommandLine \| where count > 3` (Detects archive creation commands).<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("rar.exe", "7z.exe", "winzip.exe") and ProcessCommandLine contains "a " \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.events.process-* \| WHERE process.name : ("rar.exe" OR "7z.exe" OR "winzip.exe") AND process.args : "*a*" \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 3`. |
| 2. Use of Built-in Compression Utilities | Adversaries leverage native tools like `tar`, `gzip`, or `Compress-Archive` for archiving, common in Linux/Windows as in APT28's Nearest Neighbor Campaign. | - Command Execution (e.g., auditd execve, Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search CommandLine IN ("*tar czf*", "*gzip -c*", "*Compress-Archive*") \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("tar czf", "gzip -c", "Compress-Archive") \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : ("*tar*czf*" OR "*gzip*-c*" OR "*Compress-Archive*") \| TABLE @timestamp, host.name, process.command_line`. |
| 3. Creation of Password-Protected Archives | Adversaries add passwords via utilities (e.g., RAR -p, 7z -p), as in BRONZE BUTLER and Mustang Panda operations. Hunt in environments with sensitive data staging. | - Process Creation (Sysmon ID 1 with flags) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search CommandLine=("* -p*" OR "* -hp*" OR "*password*") AND Image IN ("*rar.exe*", "*7z.exe*") \| stats count by host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains_any (" -p", " -hp", "password") and FolderPath has_any ("rar.exe", "7z.exe") \| summarize count() by DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : ("*-p*" OR "*-hp*" OR "*password*") AND process.name : ("rar.exe" OR "7z.exe") \| STATS COUNT() BY host.name, process.command_line`. |
| 4. Archiving in Suspicious Directories | Utilities create archives in temp or user dirs for staging, as in InvisiMole and Daserf hiding in .rar files. | - File Creation (Sysmon ID 11)<br>- Endpoint File Changes | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 \| search TargetFilename=(*.rar OR *.7z OR *.zip) AND TargetFilename IN ("*temp*", "*AppData*", "*staging*") \| stats values(TargetFilename) by host \| where mvcount(TargetFilename) > 2`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FileName endswith_any (".rar", ".7z", ".zip") and FolderPath has_any ("temp", "AppData", "staging") \| summarize Files=make_set(FileName) by DeviceName \| where array_length(Files) > 2`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'creation' AND file.extension : ('rar' OR '7z' OR 'zip') AND file.path : ("*temp*" OR "*AppData*" OR "*staging*") \| STATS SET(file.name) BY host.name HAVING CARDINALITY(file.name) > 2`. |
| 5. Utility Execution Followed by Exfiltration | Correlate archiving (e.g., WinRAR in Earth Lusca) with network outbound, common in APT41. | - Process Network (Sysmon ID 3)<br>- File Creation (ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=1 CommandLine="*rar a*") OR (EventCode=3 DestinationPort IN (80,443)) \| transaction ProcessGuid maxspan=5m \| where eventcount > 1 \| table _time, host, DestinationIp`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "rar a" \| join kind=inner (DeviceNetworkEvents \| where RemotePort in (80,443)) on ProcessId \| project Timestamp, DeviceName, RemoteIP`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : "*rar*a*" \| JOIN logs-endpoint.network-* ON process.pid WHERE destination.port IN [80,443] \| TABLE @timestamp, host.name, destination.ip`. |
| 6. Use of Cab or Makecab for Packaging | Adversaries use Windows-native `makecab.exe` for compression, as in MuddyWater and APT41. | - Process Creation (Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*makecab.exe*" CommandLine="* /D *" \| stats count by host, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "makecab.exe" and ProcessCommandLine contains " /D " \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name = 'makecab.exe' AND process.args : '*/D*' \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 5`. |
| 7. Base64 Encoding via Certutil for Archiving | Use of `certutil -encode` to prepare data, correlated with archiving as in certutil examples. | - Command Execution (Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*certutil.exe*" CommandLine="* -encode *" \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "certutil.exe" and ProcessCommandLine contains " -encode " \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name = 'certutil.exe' AND process.args : '*-encode*' \| TABLE @timestamp, host.name, process.command_line`. |
| 8. Archiving in Cloud via CLI Utilities | In cloud, use of `zip` or `7z` in instances before S3 upload, as potentially in HAFNIUM. | - Cloud Audit Logs (e.g., AWS CloudTrail)<br>- Instance Process Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="RunInstances" \| join instanceId [search "zip " OR "7z "] \| stats count by userIdentity, eventName \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "RunInstances" \| join kind=inner (AzureActivity \| where Message has_any ("zip", "7z")) on ResourceId \| summarize count() by Caller, OperationName \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'RunInstances' \| JOIN logs-azure.activity-* ON resource.id WHERE message : ('*zip*' OR '*7z*') \| STATS COUNT() BY user.identity, event.action HAVING COUNT() > 10`. |
| 9. High Volume of Archive File Creations | Spikes in .rar/.zip creations indicating bulk archiving, as in FIN13 using 7zip. | - File Metrics (EDR aggregate)<br>- File Creation Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename=*.rar \| timechart span=1h count \| where count > avg(count)*3`.<br>- **KQL**: `DeviceFileEvents \| where FileName endswith ".rar" \| summarize HourlyCount=count() by bin(Timestamp, 1h) \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : '*.rar' \| STATS COUNT() BY date_histogram(@timestamp, '1h') \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 10. Utility Usage Correlated with Data Collection | Link utilities (e.g., RAR in Lotus Blossom) to collection events like file access. | - Multi-Event (Sysmon IDs 1, 11) | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=1 "*rar.exe*") \| transaction host maxspan=10m [search EventCode=11 "*sensitive*"] \| where eventcount > 1 \| table host, _time`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath contains "rar.exe" \| join kind=inner (DeviceFileEvents \| where FolderPath contains "sensitive") on DeviceName \| project DeviceName, Timestamp`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : 'rar.exe' \| JOIN logs-endpoint.file-* ON host.name WHERE file.path : '*sensitive*' \| TABLE host.name, @timestamp`. |
| 11. Scripting Wrappers for Utility Archiving | Scripts (e.g., PowerShell invoking Compress-Archive) for batch archiving, as in APT28. | - Script Execution (Sysmon ID 1 for powershell) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe*" CommandLine="*Compress-Archive*" \| stats count by host, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "powershell.exe" and ProcessCommandLine contains "Compress-Archive" \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name = 'powershell.exe' AND process.args : '*Compress-Archive*' \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 5`. |
| 12. Anomalous Resource Usage from Utilities | CPU spikes from compression (e.g., 7zr.exe in FunnyDream), indicating large datasets. | - Performance Logs (Perfmon)<br>- Process Metrics | - **Splunk**: `index=endpoint sourcetype=perfmon "Processor Time" > 70 \| join host [search sourcetype=sysmon "*7z.exe*"] \| stats avg(Value) by host`.<br>- **KQL**: `PerfMetrics \| where CounterName == "Processor Time" and Value > 70 \| join kind=inner (DeviceProcessEvents \| where FolderPath contains "7z.exe") on DeviceName \| summarize AvgCPU=avg(Value) by DeviceName`.<br>- **ELK**: `FROM logs-perfmon-* \| WHERE counter.name = 'Processor Time' AND value > 70 \| JOIN logs-endpoint.process-* ON host.name WHERE process.name : '*7z.exe*' \| STATS AVG(value) BY host.name`. |
| 13. Archiving with Modified or Custom Utilities | Use of altered RAR (e.g., in Chimera), detected via hash mismatches. | - File Hashes (Sysmon ID 11)<br>- Process Integrity | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*rar.exe*" AND Hashes != known_rar_hash \| stats count by Image, Hashes`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "rar.exe" and SHA256 != "known_rar_hash" \| summarize count() by FolderPath, SHA256`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name = 'rar.exe' AND process.hash != 'known_hash' \| STATS COUNT() BY process.executable, process.hash`. |
| 14. Utility Archiving in Linux Containers | In Docker/K8s, use of `tar` for archiving (e.g., in Cutting Edge), hunt via pod logs. | - Container Events (K8s audits) | - **Splunk**: `index=container sourcetype=k8s:events "exec" Command="*tar czf*" \| stats count by pod_name \| where count > 3`.<br>- **KQL**: `KubeEvents \| where Verb == "exec" and Message contains "tar czf" \| summarize count() by ObjectRef.name \| where count_ > 3`.<br>- **ELK**: `FROM logs-kubernetes.events-* \| WHERE kubernetes.event.verb = 'exec' AND message : '*tar*czf*' \| STATS COUNT() BY kubernetes.pod.name HAVING COUNT() > 3`. |
| 15. Combined Utility with Encryption Tools | Archiving followed by encryption (e.g., gzip in Magic Hound), correlated events. | - Process Chains (Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 (CommandLine="*gzip*" OR CommandLine="*encrypt*") \| transaction host maxspan=2m \| where eventcount > 1 \| table _time, host`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("gzip", "encrypt") \| summarize Events=make_set(ProcessCommandLine) by bin(Timestamp, 2m), DeviceName \| where array_length(Events) > 1`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : ("*gzip*" OR "*encrypt*") \| STATS SET(process.command_line) BY date_histogram(@timestamp, '2m'), host.name HAVING CARDINALITY(process.command_line) > 1`.


### Audio Capture

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Unauthorized Access to Audio Devices via API Calls | Adversaries use APIs like WaveInOpen (Windows) or ALSA/PulseAudio (Linux) to capture audio without user consent, common in spyware like FinSpy. High risk in Windows endpoints with microphones. | - API Monitoring (e.g., ETW traces, Sysmon ID 10 for calls)<br>- Process Memory Events | - **Splunk**: `index=endpoint sourcetype=etw \| search CallTrace="*waveInOpen*" OR CallTrace="*audioRecord*" AND NOT ProcessName IN (legit_apps_like_zoom) \| stats count by ProcessName \| where count > 5` (Flags suspicious API calls).<br>- **KQL**: `DeviceEvents \| where ActionType == "ApiCall" and AdditionalFields.CallName has_any ("waveInOpen", "audioRecord") and not(InitiatingProcessName in~ (legitApps)) \| summarize count() by InitiatingProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-etw-* \| WHERE event.action = 'apicall' AND trace.call : ("*waveInOpen*" OR "*audioRecord*") AND process.name NOT IN ['zoom.exe'] \| STATS COUNT() BY process.name HAVING COUNT() > 5`. |
| 2. Execution of Known Audio Capture Tools | Adversaries deploy tools like SoundRecorder.exe (Windows) or arecord (Linux) for capturing, as seen in APT campaigns. Hunt in mixed OS environments. | - Process Creation (e.g., Sysmon ID 1)<br>- Command Execution Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search Image IN ("*SoundRecorder.exe*", "*arecord*", "*sox*") AND CommandLine="*record*" \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("SoundRecorder.exe", "arecord", "sox") and ProcessCommandLine contains "record" \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("SoundRecorder.exe" OR "arecord" OR "sox") AND process.args : "*record*" \| TABLE @timestamp, host.name, process.command_line`. |
| 3. Anomalous Microphone Device File Access | In Linux, adversaries access /dev/snd or /dev/audio for capture. Detect unusual opens in server environments. | - File Access Logs (e.g., auditd openat)<br>- System Calls | - **Splunk**: `index=endpoint sourcetype=auditd syscall="openat" \| search path IN ("/dev/snd/*", "/dev/audio") AND NOT exe IN (legit_audio_apps) \| stats count by exe, path \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileOpened" and FolderPath has_any ("/dev/snd", "/dev/audio") and not(InitiatingProcessFolderPath in~ (legitApps)) \| summarize count() by InitiatingProcessFolderPath, FolderPath \| where count_ > 3`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE syscall.name = 'openat' AND file.path : ("/dev/snd/*" OR "/dev/audio") AND process.exe NOT IN ['pulseaudio'] \| STATS COUNT() BY process.exe, file.path HAVING COUNT() > 3`. |
| 4. Audio Capture Followed by Data Staging | Correlate capture commands with file writes to staging dirs, common in espionage for audio exfil. | - Process Creation (Sysmon ID 1)<br>- File Creation (ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=1 CommandLine="*record audio*") \| transaction ProcessGuid maxspan=5m [search EventCode=11 TargetFilename="*wav" OR "*mp3"] \| where eventcount > 1 \| table _time, host, TargetFilename`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "record audio" \| join kind=inner (DeviceFileEvents \| where FileName endswith_any (".wav", ".mp3")) on ProcessId \| project Timestamp, DeviceName, FileName`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : "*record*audio*" \| JOIN logs-endpoint.file-* ON process.pid WHERE file.name : ("*.wav" OR "*.mp3") \| TABLE @timestamp, host.name, file.name`. |
| 5. PowerShell or Scripting for Audio Capture | Adversaries use scripts (e.g., PowerShell with Media.Recorder) for stealthy capture in Windows. | - Script Execution (Sysmon ID 1 for powershell.exe)<br>- Module Loads | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe*" CommandLine="*Media.Recorder*" OR CommandLine="*audio capture*" \| stats count by host, CommandLine \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "powershell.exe" and ProcessCommandLine has_any ("Media.Recorder", "audio capture") \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name = 'powershell.exe' AND process.args : ("*Media.Recorder*" OR "*audio*capture*") \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 2`. |
| 6. Driver or Kernel Module Loads for Audio Interception | Adversaries load malicious drivers (e.g., via LoadLibrary) to hook audio streams, as in advanced rootkits. Hunt in high-visibility Windows/Linux. | - Driver Loads (Sysmon ID 6)<br>- Module Loads (ID 7) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=6 \| search ImageLoaded="*audio.sys*" OR Hashes="unknown" \| stats values(ImageLoaded) by host \| where mvcount(ImageLoaded) > 1`.<br>- **KQL**: `DeviceDriverEvents \| where ActionType == "DriverLoaded" and FolderPath contains "audio.sys" or SHA256 == "unknown" \| summarize Drivers=make_set(FolderPath) by DeviceName \| where array_length(Drivers) > 1`.<br>- **ELK**: `FROM logs-endpoint.driver-* \| WHERE event.action = 'load' AND (driver.name : "*audio.sys*" OR driver.hash = 'unknown') \| STATS SET(driver.name) BY host.name HAVING CARDINALITY(driver.name) > 1`. |
| 7. Audio Capture in Browser or Web Apps | Adversaries exploit getUserMedia API in browsers for web-based capture. Detect in endpoint with browser telemetry. | - Browser Events (e.g., Chrome/Edge logs)<br>- Network Content | - **Splunk**: `index=endpoint sourcetype=browser_log \| search event="getUserMedia" AND mediaType="audio" AND NOT domain IN (trusted_domains) \| stats count by domain, host \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "BrowserEvent" and AdditionalFields.event == "getUserMedia" and AdditionalFields.mediaType == "audio" and not(AdditionalFields.domain in~ (trustedDomains)) \| summarize count() by AdditionalFields.domain, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-browser-* \| WHERE event.name = 'getUserMedia' AND media.type = 'audio' AND url.domain NOT IN ['zoom.us'] \| STATS COUNT() BY url.domain, host.name HAVING COUNT() > 5`. |
| 8. Cloud Instance Audio Capture Attempts | In cloud VMs (AWS/Azure), adversaries run capture tools on instances with attached mics (rare but possible in VDI). | - Cloud Logs (e.g., AWS CloudTrail for instance actions)<br>- Instance Process Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="RunInstances" \| join instanceId [search "arecord" OR "SoundRecorder"] \| stats count by userIdentity \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "RunInstances" \| join kind=inner (AzureActivity \| where Message has_any ("arecord", "SoundRecorder")) on ResourceId \| summarize count() by Caller \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'RunInstances' \| JOIN logs-azure.activity-* ON resource.id WHERE message : ('*arecord*' OR '*SoundRecorder*') \| STATS COUNT() BY user.identity HAVING COUNT() > 10`. |
| 9. Anomalous Audio File Creations | Detect creation of .wav/.mp3 files in unusual locations or volumes, indicating capture staging. | - File Creation (Sysmon ID 11)<br>- File Metadata | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename=(*.wav OR *.mp3) AND TargetFilename IN ("*temp*", "*hidden*") \| stats count by TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FileName endswith_any (".wav", ".mp3") and FolderPath has_any ("temp", "hidden") \| summarize count() by FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'creation' AND file.extension : ('wav' OR 'mp3') AND file.path : ("*temp*" OR "*hidden*") \| STATS COUNT() BY file.name, host.name HAVING COUNT() > 3`. |
| 10. Resource Spikes During Audio Capture | High CPU/disk from encoding during capture, correlated with audio processes. | - Performance Metrics (Perfmon CPU/Disk)<br>- Process Logs | - **Splunk**: `index=endpoint sourcetype=perfmon "Processor Time" > 50 \| join host [search sourcetype=sysmon "*audio capture*"] \| stats avg(Value) by host \| where avg_Value > 50`.<br>- **KQL**: `PerfMetrics \| where CounterName == "Processor Time" and Value > 50 \| join kind=inner (DeviceProcessEvents \| where ProcessCommandLine contains "audio capture") on DeviceName \| summarize AvgCPU=avg(Value) by DeviceName \| where AvgCPU > 50`.<br>- **ELK**: `FROM logs-perfmon-* \| WHERE counter.name = 'Processor Time' AND value > 50 \| JOIN logs-endpoint.process-* ON host.name WHERE process.args : '*audio*capture*' \| STATS AVG(value) BY host.name HAVING AVG(value) > 50`. |
| 11. Audio Capture Malware Indicators | Detect known malware like FinFisher via hashes or strings in processes. | - File Scans (EDR YARA)<br>- Process Creation | - **Splunk**: `index=endpoint sourcetype=edr_scan \| search Strings="*audio spy*" OR Hashes="known_malware_hash" \| stats values(file_name) by host \| where mvcount(file_name) > 1`.<br>- **KQL**: `DeviceFileEvents \| where AdditionalFields.Strings contains "audio spy" or SHA256 == "known_malware_hash" \| summarize Files=make_set(FileName) by DeviceName \| where array_length(Files) > 1`.<br>- **ELK**: `FROM logs-edr.scan-* \| WHERE file.strings : "*audio*spy*" OR file.hash = 'known_hash' \| STATS SET(file.name) BY host.name HAVING CARDINALITY(file.name) > 1`. |
| 12. Volume Spikes in Audio-Related Events | Sudden increases in audio API calls, signaling campaigns. | - Aggregate Metrics (SIEM stats)<br>- API Events | - **Splunk**: `index=endpoint sourcetype=etw CallTrace="*waveIn*" \| timechart span=1h count \| where count > avg(count)*4`.<br>- **KQL**: `DeviceEvents \| where AdditionalFields.CallName contains "waveIn" \| summarize HourlyCount=count() by bin(Timestamp, 1h) \| where HourlyCount > avg(HourlyCount) * 4`.<br>- **ELK**: `FROM logs-etw-* \| WHERE trace.call : '*waveIn*' \| STATS COUNT() BY date_histogram(@timestamp, '1h') \| WHERE COUNT() > AVG(COUNT()) * 4`. |
| 13. Audio Capture Correlated with Exfiltration | Link capture to outbound traffic (e.g., to C2). | - Network Connections (Sysmon ID 3)<br>- Process Events (ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*record*" \| transaction ProcessGuid maxspan=2m [search EventCode=3 DestinationPort=443] \| where eventcount > 1 \| table _time, DestinationIp`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "record" \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 443) on ProcessId \| project Timestamp, RemoteIP`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : '*record*' \| JOIN logs-endpoint.network-* ON process.pid WHERE destination.port = 443 \| TABLE @timestamp, destination.ip`. |
| 14. Persistent Audio Capture via Services | Adversaries install services (e.g., via sc.exe) for ongoing capture. | - Service Creation (Sysmon ID 1 for sc.exe)<br>- Registry Changes (ID 13) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*sc.exe*" CommandLine="*create*" AND Description="*audio*" \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "sc.exe" and ProcessCommandLine contains "create" and AdditionalFields.Description contains "audio" \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name = 'sc.exe' AND process.args : '*create*' AND service.description : '*audio*' \| TABLE @timestamp, host.name, process.command_line`. |
| 15. Audio Capture in Virtual Environments | In VDI/cloud desktops, detect capture attempts via virtual audio devices. | - Virtualization Logs (e.g., VMware/Hyper-V events)<br>- Device Access | - **Splunk**: `index=virtual sourcetype=vmware_log \| search event="audio access" AND guest_os="windows" AND NOT user IN (authorized) \| stats count by guest_ip \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "VirtualDeviceAccess" and AdditionalFields.device == "audio" and not(InitiatingProcessAccountName in~ (authorizedUsers)) \| summarize count() by RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-vmware-* \| WHERE event.name = 'audio access' AND guest.os = 'windows' AND user.name NOT IN ['admin'] \| STATS COUNT() BY guest.ip HAVING COUNT() > 5`.


### Automated Collection

### Threat Hunting Hypotheses for Automated Collection (MITRE ATT&CK T1119)

Once established within a system or network, adversaries may use automated techniques for collecting internal data, such as scripts to search and copy files based on criteria like type or name, or cloud APIs and ETL services for data aggregation. This technique is used by groups like APT1 with batch scripts for discovery and collection, or Agrius querying SQL databases. Hypotheses are designed for environments with EDR/SIEM visibility, focusing on script executions, file patterns, and API anomalies across Windows, Linux, and cloud. Detections can leverage process monitoring, file events, and cloud audits; in low-visibility setups, prioritize behavioral baselines.

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Batch Script Execution for File Enumeration and Collection | Adversaries use cmd.exe or batch files to dir/find files (e.g., *.docx) and copy to staging, as in APT1 procedures. High risk in Windows with unmonitored scripts. | - Process Creation (e.g., Sysmon ID 1)<br>- Command Execution Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*cmd.exe*" CommandLine=("*dir /b /s*" OR "*findstr*") AND CommandLine="*copy*" \| stats count by host, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "cmd.exe" and ProcessCommandLine has_any ("dir /b /s", "findstr") and ProcessCommandLine contains "copy" \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name = "cmd.exe" AND process.args : ("*dir*/b*/s*" OR "*findstr*") AND process.args : "*copy*" \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 5`. |
| 2. PowerShell Scripts for Automated Data Gathering | Adversaries use PowerShell to Get-ChildItem and copy files recursively, common in Windows as in Comnie batch uploads. | - Script Execution (Sysmon ID 1 for powershell.exe)<br>- Module Loads | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe*" CommandLine=("*Get-ChildItem*" OR "*gci -Recurse*") AND CommandLine="*Copy-Item*" \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "powershell.exe" and ProcessCommandLine has_any ("Get-ChildItem", "gci -Recurse") and ProcessCommandLine contains "Copy-Item" \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name = "powershell.exe" AND process.args : ("*Get-ChildItem*" OR "*gci*-Recurse*") AND process.args : "*Copy-Item*" \| TABLE @timestamp, host.name, process.command_line`. |
| 3. Linux Shell Scripts Using Find/Grep for Collection | Adversaries automate with bash/find to locate and cp files, as potentially in Linux-targeted APTs like Chimera DLLs. Hunt in Linux servers. | - Command Execution (auditd execve)<br>- File Access Logs | - **Splunk**: `index=endpoint sourcetype=auditd exe="*bash*" \| search cmdline=("*find *" OR "*grep*") AND cmdline="*cp -r*" \| stats count by host, cmdline \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath contains "bash" and ProcessCommandLine has_any ("find ", "grep") and ProcessCommandLine contains "cp -r" \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 3`.<br>- **ELK**: `FROM logs-auditd.process-* \| WHERE process.exe : "*bash*" AND process.args : ("*find*" OR "*grep*") AND process.args : "*cp*-r*" \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 3`. |
| 4. Cloud API Calls for Automated Data Export | In IaaS/SaaS, adversaries use AWS CLI or Azure PowerShell to list and export data, as in cloud-focused groups like Chimera. | - Cloud Audit Logs (e.g., AWS CloudTrail, Azure Activity)<br>- API Call Events | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("ListObjects", "ExportJob") \| stats count by userIdentity, eventName \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("ListObjects", "ExportJob") \| summarize count() by Caller, EventName \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['ListObjects', 'ExportJob'] \| STATS COUNT() BY user.identity, event.action HAVING COUNT() > 10`. |
| 5. Remote Tool Transfer for Collection Scripts | Adversaries transfer and execute collection scripts via PsExec or SCP, correlating with Lateral Tool Transfer. | - File Transfer Logs (Sysmon ID 3 for network)<br>- Process Creation (ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=3 Protocol="smb" OR DestinationPort=22) \| join ProcessGuid [search EventCode=1 "*psexec*" OR "*scp*"] \| where eventcount > 1 \| table _time, host, DestinationIp`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "SMB" or RemotePort == 22 \| join kind=inner (DeviceProcessEvents \| where ProcessCommandLine has_any ("psexec", "scp")) on ProcessId \| project Timestamp, DeviceName, RemoteIP`.<br>- **ELK**: `FROM logs-endpoint.network-* \| WHERE protocol = 'SMB' OR destination.port = 22 \| JOIN logs-endpoint.process-* ON process.pid WHERE process.args : ('*psexec*' OR '*scp*') \| TABLE @timestamp, host.name, destination.ip`. |
| 6. ETL Service Misuse in Cloud for Data Aggregation | Adversaries abuse AWS Glue or Azure Data Factory for automated pipelines, high risk in SaaS. | - Cloud Service Logs (e.g., ETL job runs)<br>- API Audits | - **Splunk**: `index=cloud sourcetype=azure:activity OperationName="CreateOrUpdateJob" AND Caller NOT IN (authorized) \| stats count by ResourceId, Caller \| where count > 5`.<br>- **KQL**: `AzureActivity \| where OperationNameValue == "Microsoft.DataFactory/factories/jobs/write" and Caller !in~ (authorizedUsers) \| summarize count() by ResourceId, Caller \| where count_ > 5`.<br>- **ELK**: `FROM logs-azure.activity-* \| WHERE event.action = 'CreateOrUpdateJob' AND user.name NOT IN ['admin'] \| STATS COUNT() BY resource.id, user.name HAVING COUNT() > 5`. |
| 7. Anomalous File Staging After Automated Searches | Detect mass file copies to temp/staging dirs post-enumeration, as in BADNEWS USB monitoring. | - File Creation (Sysmon ID 11)<br>- Directory Changes | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename IN ("*temp*", "*staging*") AND mvcount(TargetFilename) > 10 \| stats values(TargetFilename) by host`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FolderPath has_any ("temp", "staging") \| summarize Files=make_set(FileName) by DeviceName \| where array_length(Files) > 10`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'creation' AND file.path : ("*temp*" OR "*staging*") \| STATS SET(file.name) BY host.name HAVING CARDINALITY(file.name) > 10`. |
| 8. Database Query Tools for Automated Extraction | Tools like sql.net4.exe or SQLULDR2 for dumping DB data, as in Agrius or APT41 DUST. | - Process Creation (Sysmon ID 1)<br>- Database Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*sqlnet4.exe*", "*sqluldr2*") CommandLine="*select*" \| stats count by host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("sqlnet4.exe", "sqluldr2") and ProcessCommandLine contains "select" \| summarize count() by DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("sqlnet4.exe" OR "sqluldr2") AND process.args : "*select*" \| STATS COUNT() BY host.name, process.command_line`. |
| 9. USB Device Monitoring and Auto-Collection | Scripts monitor and copy from USBs, as in BADNEWS or AppleSeed. Hunt in Windows with removable media. | - Device Attachment (Windows Event ID 2003)<br>- File Copies | - **Splunk**: `index=endpoint sourcetype=win_event EventID=2003 \| join host [search sourcetype=sysmon "*copy*" "*:\\*"] \| stats count by host, DriveLetter \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "UsbDriveMounted" \| join kind=inner (DeviceProcessEvents \| where ProcessCommandLine contains "copy" and ProcessCommandLine contains ":\\") on DeviceName \| summarize count() by DeviceName, AdditionalFields.DriveLetter \| where count_ > 5`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 2003 \| JOIN logs-endpoint.process-* ON host.name WHERE process.args : "*copy*" AND process.args : "*:\\*" \| STATS COUNT() BY host.name, drive.letter HAVING COUNT() > 5`. |
| 10. Continuous Data Retrieval via Custom DLLs | Custom DLLs for memory-based collection, as in Chimera. Detect in Windows with module loads. | - Module Loads (Sysmon ID 7)<br>- Memory Events | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded="*.dll" AND Hashes="unknown" AND ParentImage NOT IN (legit) \| stats count by ImageLoaded, host \| where count > 2`.<br>- **KQL**: `DeviceImageLoadEvents \| where FolderPath endswith ".dll" and SHA256 == "unknown" and not(InitiatingProcessFolderPath in~ (legitApps)) \| summarize count() by FolderPath, DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.library-* \| WHERE dll.name : "*.dll" AND dll.hash = "unknown" AND process.parent.name NOT IN ['explorer.exe'] \| STATS COUNT() BY dll.path, host.name HAVING COUNT() > 2`. |
| 11. Office Suite Macro-Enabled Collection | Macros in Office apps to collect and stage data, high risk in Office Suite platforms. | - Office Events (e.g., Macro execution logs)<br>- File Changes | - **Splunk**: `index=endpoint sourcetype=office_log Event="MacroEnabled" AND Action="FileSaveAs" \| stats count by host, FileName \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "OfficeMacroEnabled" and AdditionalFields.Action == "FileSaveAs" \| summarize count() by DeviceName, AdditionalFields.FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-office-* \| WHERE event.name = 'MacroEnabled' AND event.action = 'FileSaveAs' \| STATS COUNT() BY host.name, file.name HAVING COUNT() > 5`. |
| 12. Volume Spikes in File Enumeration Commands | Spikes in dir/ls/find executions indicating automated searches. | - Command Metrics (SIEM aggregates)<br>- Process Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*dir*", "*ls*", "*find*") \| timechart span=1h count \| where count > avg(count)*4`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("dir", "ls", "find") \| summarize HourlyCount=count() by bin(Timestamp, 1h) \| where HourlyCount > avg(HourlyCount) * 4`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : ("*dir*" OR "*ls*" OR "*find*") \| STATS COUNT() BY date_histogram(@timestamp, '1h') \| WHERE COUNT() > AVG(COUNT()) * 4`. |
| 13. Automated Collection Correlated with Discovery | Link enumeration (e.g., dir) to collection (copy), as in APT28 tool usage. | - Multi-Event Correlation (Sysmon IDs 1, 11) | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=1 "*dir*") \| transaction host maxspan=5m [search EventCode=11 "*copy*"] \| where eventcount > 1 \| table _time, host`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "dir" \| join kind=inner (DeviceFileEvents \| where ActionType contains "copy") on DeviceName \| project Timestamp, DeviceName`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : "*dir*" \| JOIN logs-endpoint.file-* ON host.name WHERE event.action : "*copy*" \| TABLE @timestamp, host.name`. |
| 14. Packet Capture and Config Collection via Tools | Tools like ArcaneDoor for pcap and config auto-collection. Hunt in network devices. | - Network Tool Execution (e.g., tcpdump logs)<br>- File Creation | - **Splunk**: `index=network sourcetype=packet_log Command="*tcpdump*" OR "*pcap*" \| stats count by host, Command \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("tcpdump", "pcap") \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 3`.<br>- **ELK**: `FROM logs-network.process-* \| WHERE process.args : ("*tcpdump*" OR "*pcap*") \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 3`. |
| 15. Recursive File Listing and Upload to C2 | Recursive listings (e.g., Bankshot) followed by exfil, as in Comnie. | - Process Network (Sysmon ID 3)<br>- File Enumeration | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*dir /s*" \| join ProcessGuid [search EventCode=3 DestinationPort=443] \| stats count by host, DestinationIp \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "dir /s" \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 443) on ProcessId \| summarize count() by DeviceName, RemoteIP \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : "*dir*/s*" \| JOIN logs-endpoint.network-* ON process.pid WHERE destination.port = 443 \| STATS COUNT() BY host.name, destination.ip HAVING COUNT() > 2`.


### Browser Session Hijacking

### Threat Hunting Hypotheses for Browser Session Hijacking (MITRE ATT&CK T1185)

Adversaries exploit browser vulnerabilities or functionality to intercept sessions, often by injecting code to steal cookies, tokens, or redirect traffic, enabling access to authenticated resources without credentials. This technique is commonly used in Windows environments by malware like Cobalt Strike for browser pivoting or Agent Tesla for form-grabbing. Hypotheses focus on injection indicators, anomalous browser behaviors, and session artifacts, assuming EDR/SIEM visibility (e.g., Sysmon, browser logs). In low-visibility setups, prioritize process and network monitoring; detections may overlap with techniques like Process Injection (T1055).

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Process Injection into Browser Processes | Adversaries inject code into browsers (e.g., chrome.exe, edge.exe) to inherit sessions, as in Cobalt Strike pivoting. High risk in Windows with high-integrity processes. | - Process Monitoring (e.g., Sysmon Event ID 10 for access)<br>- Module Loads (ID 7) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=10 \| search TargetImage IN ("*chrome.exe*", "*firefox.exe*", "*msedge.exe*") AND GrantedAccess="0x1fffff" \| stats count by SourceImage, TargetImage \| where count > 3` (Detects high-access grants indicative of injection).<br>- **KQL**: `DeviceProcessEvents \| where ActionType == "ProcessAccessed" and FolderPath has_any ("chrome.exe", "firefox.exe", "msedge.exe") and AdditionalFields.GrantedAccess == "0x1fffff" \| summarize count() by InitiatingProcessFolderPath, FolderPath \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.events.process-* \| WHERE event.code = "10" AND process.target.name : ("chrome.exe" OR "firefox.exe" OR "msedge.exe") AND process.access.granted = "0x1fffff" \| STATS COUNT() BY process.source.name, process.target.name HAVING COUNT() > 3`. |
| 2. Suspicious Module Loads in Browsers | Adversaries load malicious DLLs (e.g., for hooking) into browsers, as seen in Dridex web injects. Hunt for unknown modules in Windows browsers. | - Module Load Events (Sysmon ID 7)<br>- Process Integrity | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 \| search Image IN ("*chrome.exe*", "*firefox.exe*") AND ImageLoaded NOT IN (known_browser_dlls) \| stats values(ImageLoaded) by Image \| where mvcount(ImageLoaded) > 2`.<br>- **KQL**: `DeviceImageLoadEvents \| where InitiatingProcessFolderPath has_any ("chrome.exe", "firefox.exe") and not(FolderPath in~ (knownDLLs)) \| summarize DLLs=make_set(FolderPath) by InitiatingProcessFolderPath \| where array_length(DLLs) > 2`.<br>- **ELK**: `FROM logs-endpoint.events.library-* \| WHERE process.name : ("chrome.exe" OR "firefox.exe") AND dll.name NOT IN ['known.dll'] \| STATS SET(dll.name) BY process.name HAVING CARDINALITY(dll.name) > 2`. |
| 3. Anomalous Child Processes from Browsers | Browsers spawning suspicious processes (e.g., cmd.exe for data exfil post-hijack), indicative of session abuse. | - Process Creation (Sysmon ID 1)<br>- Parent-Child Relationships | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search ParentImage IN ("*chrome.exe*", "*msedge.exe*") AND Image IN ("*cmd.exe*", "*powershell.exe*") \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where InitiatingProcessFolderPath has_any ("chrome.exe", "msedge.exe") and FolderPath has_any ("cmd.exe", "powershell.exe") \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.parent.name : ("chrome.exe" OR "msedge.exe") AND process.name : ("cmd.exe" OR "powershell.exe") \| TABLE @timestamp, host.name, process.command_line`. |
| 4. Unauthorized Browser Extension Installations | Adversaries install malicious extensions for session interception, as in Chaes using Puppeteer. Detect in Windows/Chrome environments. | - Registry Changes (Sysmon ID 13 for extension keys)<br>- File Creation in Extension Dirs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=13 \| search RegistryKey IN ("*Chrome\\Extensions*", "*Firefox\\Extensions*") AND Details="added" \| stats count by RegistryKey, host \| where count > 1`.<br>- **KQL**: `DeviceRegistryEvents \| where RegistryKey has_any ("Chrome\\Extensions", "Firefox\\Extensions") and ActionType == "RegistryValueSet" \| summarize count() by RegistryKey, DeviceName \| where count_ > 1`.<br>- **ELK**: `FROM logs-endpoint.registry-* \| WHERE registry.key : ("*Chrome\\Extensions*" OR "*Firefox\\Extensions*") AND event.action = 'set' \| STATS COUNT() BY registry.key, host.name HAVING COUNT() > 1`. |
| 5. Access to Browser Cookie or Storage Files | Adversaries steal cookies from browser data dirs (e.g., %AppData%\Chrome\Cookies), as in Ursnif. | - File Access (Sysmon ID 11 for reads)<br>- Endpoint File Monitoring | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 \| search TargetFilename IN ("*Cookies", "*Local Storage*") AND ProcessImage NOT IN (browser_processes) \| stats values(TargetFilename) by ProcessImage \| where mvcount(TargetFilename) > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileAccessed" and FolderPath has_any ("Cookies", "Local Storage") and not(InitiatingProcessFolderPath in~ (browsers)) \| summarize Files=make_set(FolderPath) by InitiatingProcessFolderPath \| where array_length(Files) > 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'access' AND file.path : ("*Cookies" OR "*Local Storage*") AND process.name NOT IN ['chrome.exe'] \| STATS SET(file.path) BY process.name HAVING CARDINALITY(file.path) > 3`. |
| 6. Anomalous Network Traffic from Browsers | Post-hijack, browsers access internal resources unexpectedly, bypassing MFA. Hunt in enterprise networks. | - Network Traffic (e.g., Zeek HTTP logs)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http \| search user_agent="*Chrome*" AND uri="*intranet*" AND status=200 \| stats count by src_ip, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where InitiatingProcessName contains "Chrome" and RemoteUrl contains "intranet" and AdditionalFields.status == 200 \| summarize count() by RemoteIP, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent : "*Chrome*" AND http.uri : "*intranet*" AND http.status = 200 \| STATS COUNT() BY source.ip, http.uri HAVING COUNT() > 10`. |
| 7. Browser API Hooking or Injection Indicators | Adversaries hook functions (e.g., via ETW) for form-grabbing, as in Kimsuky. Detect in high-visibility EDR. | - API Calls (ETW traces)<br>- Process Memory | - **Splunk**: `index=endpoint sourcetype=etw \| search CallTrace="*SetWindowsHookEx*" AND ProcessName="*browser*" \| stats count by ProcessName \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "ApiCall" and AdditionalFields.CallName == "SetWindowsHookEx" and InitiatingProcessName contains "browser" \| summarize count() by InitiatingProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-etw-* \| WHERE event.action = 'apicall' AND trace.call = "*SetWindowsHookEx*" AND process.name : "*browser*" \| STATS COUNT() BY process.name HAVING COUNT() > 5`. |
| 8. Proxy Configuration Changes in Browsers | Adversaries set proxies to redirect traffic, assuming browser context. Hunt for registry mods in Windows. | - Registry Events (Sysmon ID 13 for proxy keys)<br>- Browser Config Files | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=13 \| search RegistryKey="*ProxySettings*" AND Details="modified" \| table _time, host, RegistryKey`.<br>- **KQL**: `DeviceRegistryEvents \| where RegistryKey contains "ProxySettings" and ActionType == "RegistryValueSet" \| project Timestamp, DeviceName, RegistryKey`.<br>- **ELK**: `FROM logs-endpoint.registry-* \| WHERE registry.key : "*ProxySettings*" AND event.action = 'set' \| TABLE @timestamp, host.name, registry.key`. |
| 9. Anomalous Web App Authentications | Successful logins to web apps (e.g., SharePoint) from unexpected IPs post-hijack. | - Authentication Logs (e.g., Azure AD Sign-ins)<br>- Web Access Logs | - **Splunk**: `index=security sourcetype=azure:ad:signin \| search AppDisplayName="*SharePoint*" AND IPAddress NOT IN (internal_ranges) \| stats count by UserPrincipalName, IPAddress \| where count > 5`.<br>- **KQL**: `SigninLogs \| where AppDisplayName contains "SharePoint" and IPAddress !in (internalRanges) \| summarize count() by UserPrincipalName, IPAddress \| where count_ > 5`.<br>- **ELK**: `FROM logs-azure.signin-* \| WHERE app.name : "*SharePoint*" AND source.ip NOT IN ['10.0.0.0/8'] \| STATS COUNT() BY user.name, source.ip HAVING COUNT() > 5`. |
| 10. Browser Crashes or Errors Post-Injection | Injection causes instability (e.g., crashes in Chrome), signaling hijack attempts. | - Application Logs (e.g., Windows Event ID 1000 for faults)<br>- Crash Reports | - **Splunk**: `index=endpoint sourcetype=win_event EventID=1000 \| search ApplicationName IN ("*chrome.exe*", "*firefox.exe*") \| stats count by host, FaultingModule \| where count > 3`.<br>- **KQL**: `DeviceEvents \| where ActionType == "AppCrash" and AdditionalFields.AppName has_any ("chrome.exe", "firefox.exe") \| summarize count() by DeviceName, AdditionalFields.FaultModule \| where count_ > 3`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 1000 AND winlog.application.name : ("chrome.exe" OR "firefox.exe") \| STATS COUNT() BY host.name, winlog.fault.module HAVING COUNT() > 3`. |
| 11. Access to Browser Local Storage or IndexedDB | Adversaries extract session tokens from storage, as in TRANSLATEXT form-grabbing. | - File Access (Sysmon ID 11)<br>- JavaScript Execution Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 \| search TargetFilename IN ("*LocalState", "*IndexedDB*") AND ProcessImage="*browser*" \| stats count by TargetFilename, host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FolderPath has_any ("LocalState", "IndexedDB") and InitiatingProcessFolderPath contains "browser" \| summarize count() by FolderPath, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.path : ("*LocalState" OR "*IndexedDB*") AND process.name : "*browser*" \| STATS COUNT() BY file.path, host.name HAVING COUNT() > 5`. |
| 12. Web Injects Detected via Page Modifications | Adversaries modify HTML (e.g., Grandoreiro overlays), detectable in proxy or EDR. | - Network Content (Suricata HTTP rules)<br>- Browser Telemetry | - **Splunk**: `index=network sourcetype=suricata "web inject" OR "html modify" \| stats count by src_ip, uri \| where count > 2`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields contains_any ("web inject", "html modify") \| summarize count() by RemoteIP, RemoteUrl \| where count_ > 2`.<br>- **ELK**: `FROM logs-suricata-* \| WHERE message : ("*web*inject*" OR "*html*modify*") \| STATS COUNT() BY source.ip, http.uri HAVING COUNT() > 2`. |
| 13. High-Integrity Browser Process Escalation | Browsers running with elevated privileges (e.g., for injection), requiring SeDebugPrivilege. | - Process Integrity Levels (Sysmon ID 1 with integrity)<br>- Privilege Events | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search Image="*browser.exe*" AND IntegrityLevel="High" \| stats count by Image, host \| where count > 1`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath contains "browser.exe" and AdditionalFields.IntegrityLevel == "High" \| summarize count() by FolderPath, DeviceName \| where count_ > 1`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : "*browser.exe*" AND process.integrity = "High" \| STATS COUNT() BY process.name, host.name HAVING COUNT() > 1`. |
| 14. Correlated Phishing and Session Hijack Indicators | Initial phishing leads to hijack (e.g., TrickBot redirects). Link email/phish events to browser anomalies. | - Email Logs (e.g., phishing attachments)<br>- Browser Events | - **Splunk**: `index=email sourcetype=phish_log "malicious attachment" \| join user [search sourcetype=sysmon EventCode=10 "*browser* injection"] \| stats count by user, host \| where count > 1`.<br>- **KQL**: `EmailEvents \| where ActionType == "PhishDetected" \| join kind=inner (DeviceProcessEvents \| where ActionType == "Injection" and FolderPath contains "browser") on AccountName \| summarize count() by AccountName, DeviceName \| where count_ > 1`.<br>- **ELK**: `FROM logs-email-* \| WHERE event.action = 'phish' \| JOIN logs-endpoint.process-* ON user.name WHERE event.code = '10' AND process.name : "*browser*" \| STATS COUNT() BY user.name, host.name HAVING COUNT() > 1`. |
| 15. Browser Session Hijacking Tool Artifacts | Detection of tools like Cobalt Strike or IcedID artifacts (e.g., beacons in browser memory). | - Process Creation (Sysmon ID 1)<br>- Memory Scans | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search CommandLine IN ("*cobaltstrike*", "*icedid*") AND ParentImage="*browser*" \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("cobaltstrike", "icedid") and InitiatingProcessFolderPath contains "browser" \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : ("*cobaltstrike*" OR "*icedid*") AND process.parent.name : "*browser*" \| TABLE @timestamp, host.name, process.command_line`.


### Clipboard Data

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Unauthorized Clipboard API Calls | Adversaries use APIs like `GetClipboardData` or `xclip` to access clipboard contents, as in NjRAT or PlugX. High risk in Windows with keylogging malware. | - API Monitoring (e.g., ETW traces, Sysmon ID 10)<br>- Process Memory Events | - **Splunk**: `index=endpoint sourcetype=etw \| search CallTrace="*GetClipboardData*" OR CallTrace="*Clipboard*" AND NOT ProcessName IN (legit_apps_like_office) \| stats count by ProcessName \| where count > 5` (Flags suspicious API calls).<br>- **KQL**: `DeviceEvents \| where ActionType == "ApiCall" and AdditionalFields.CallName has_any ("GetClipboardData", "Clipboard") and not(InitiatingProcessName in~ (legitApps)) \| summarize count() by InitiatingProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-etw-* \| WHERE event.action = 'apicall' AND trace.call : ("*GetClipboardData*" OR "*Clipboard*") AND process.name NOT IN ['winword.exe'] \| STATS COUNT() BY process.name HAVING COUNT() > 5`. |
| 2. Suspicious Process Accessing Clipboard Tools | Adversaries run tools like `xclip` (Linux) or custom scripts to extract clipboard data, as in APT campaigns. Hunt in mixed OS environments. | - Process Creation (e.g., Sysmon ID 1)<br>- Command Execution Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search Image IN ("*xclip*", "*pbcopy*") OR CommandLine="*clipboard*" \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("xclip", "pbcopy") or ProcessCommandLine contains "clipboard" \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("xclip" OR "pbcopy") OR process.args : "*clipboard*" \| TABLE @timestamp, host.name, process.command_line`. |
| 3. Clipboard Data Staging to Files | Adversaries save clipboard data to files (e.g., .txt in temp dirs) for exfiltration, common in Agent Tesla. | - File Creation (Sysmon ID 11)<br>- File Content Monitoring | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 \| search TargetFilename IN ("*temp*.txt", "*clip*.dat") AND ProcessImage NOT IN (legit_apps) \| stats count by TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FileName has_any ("temp.txt", "clip.dat") and not(InitiatingProcessFolderPath in~ (legitApps)) \| summarize count() by FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'creation' AND file.name : ("*temp*.txt" OR "*clip*.dat") AND process.name NOT IN ['notepad.exe'] \| STATS COUNT() BY file.name, host.name HAVING COUNT() > 3`. |
| 4. PowerShell Scripts Accessing Clipboard | Adversaries use PowerShell `[System.Windows.Forms.Clipboard]` for capture, as in malware like Hawkeye. | - Script Execution (Sysmon ID 1 for powershell.exe)<br>- Script Block Logging | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe*" CommandLine="*Clipboard*" \| stats count by host, CommandLine \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "powershell.exe" and ProcessCommandLine contains "Clipboard" \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name = "powershell.exe" AND process.args : "*Clipboard*" \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 2`. |
| 5. Clipboard Access Correlated with Keylogging | Clipboard capture paired with keylogging, as in Allakore RAT, indicating broader espionage.| - Process Creation (Sysmon ID 1)<br>- Registry Events (ID 13 for keylog keys) | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=1 "*Clipboard*") \| transaction ProcessGuid maxspan=5m [search EventCode=13 "*keylog*"] \| where eventcount > 1 \| table _time, host`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "Clipboard" \| join kind=inner (DeviceRegistryEvents \| where RegistryKey contains "keylog") on ProcessId \| project Timestamp, DeviceName`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : "*Clipboard*" \| JOIN logs-endpoint.registry-* ON process.pid WHERE registry.key : "*keylog*" \| TABLE @timestamp, host.name`. |
| 6. Anomalous Network Traffic Post-Clipboard Access | Clipboard data exfiltrated via HTTP/HTTPS, as in FormBook. Hunt in enterprise networks. | - Network Traffic (e.g., Zeek HTTP logs)<br>- Process Network (Sysmon ID 3) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*Clipboard*" \| join ProcessGuid [search EventCode=3 DestinationPort IN (80,443)] \| stats count by host, DestinationIp \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "Clipboard" \| join kind=inner (DeviceNetworkEvents \| where RemotePort in (80,443)) on ProcessId \| summarize count() by DeviceName, RemoteIP \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : "*Clipboard*" \| JOIN logs-endpoint.network-* ON process.pid WHERE destination.port IN [80,443] \| STATS COUNT() BY host.name, destination.ip HAVING COUNT() > 2`. |
| 7. Browser Clipboard API Misuse | Adversaries use JavaScript (e.g., `navigator.clipboard`) to steal data from web apps, as in web-based malware. | - Browser Events (e.g., Chrome/Edge logs)<br>- Network Content | - **Splunk**: `index=endpoint sourcetype=browser_log \| search event="clipboard" AND api="*navigator.clipboard*" AND NOT domain IN (trusted_domains) \| stats count by domain, host \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "BrowserEvent" and AdditionalFields.event == "clipboard" and AdditionalFields.api contains "navigator.clipboard" and not(AdditionalFields.domain in~ (trustedDomains)) \| summarize count() by AdditionalFields.domain, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-browser-* \| WHERE event.name = 'clipboard' AND api.name : "*navigator.clipboard*" AND url.domain NOT IN ['office.com'] \| STATS COUNT() BY url.domain, host.name HAVING COUNT() > 5`. |
| 8. Clipboard Access by Non-Standard Processes | Non-browser/non-office apps (e.g., cmd.exe) accessing clipboard, indicating potential malware like PlugX. | - Process Creation (Sysmon ID 1)<br>- API Calls | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search CommandLine="*Clipboard*" AND NOT Image IN ("*chrome.exe*", "*winword.exe*") \| table _time, host, Image`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "Clipboard" and not(FolderPath has_any ("chrome.exe", "winword.exe")) \| project Timestamp, DeviceName, FolderPath`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : "*Clipboard*" AND process.name NOT IN ['chrome.exe', 'winword.exe'] \| TABLE @timestamp, host.name, process.executable`. |
| 9. High-Frequency Clipboard Access | Rapid clipboard API calls suggesting automated scraping, as in espionage malware. | - API Call Metrics (ETW aggregates)<br>- Process Behavior | - **Splunk**: `index=endpoint sourcetype=etw CallTrace="*GetClipboardData*" \| timechart span=1m count \| where count > avg(count)*3`.<br>- **KQL**: `DeviceEvents \| where AdditionalFields.CallName contains "GetClipboardData" \| summarize MinutelyCount=count() by bin(Timestamp, 1m) \| where MinutelyCount > avg(MinutelyCount) * 3`.<br>- **ELK**: `FROM logs-etw-* \| WHERE trace.call : "*GetClipboardData*" \| STATS COUNT() BY date_histogram(@timestamp, '1m') \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 10. Clipboard Access in Cloud VDI Instances | Adversaries target clipboard in cloud desktops (e.g., Azure Virtual Desktop), as in remote espionage. | - Cloud Logs (e.g., Azure Activity)<br>- VDI Session Logs | - **Splunk**: `index=cloud sourcetype=azure:activity OperationName="ClipboardAccess" AND Caller NOT IN (authorized) \| stats count by ResourceId, Caller \| where count > 5`.<br>- **KQL**: `AzureActivity \| where OperationNameValue contains "ClipboardAccess" and Caller !in~ (authorizedUsers) \| summarize count() by ResourceId, Caller \| where count_ > 5`.<br>- **ELK**: `FROM logs-azure.activity-* \| WHERE event.action = 'ClipboardAccess' AND user.name NOT IN ['admin'] \| STATS COUNT() BY resource.id, user.name HAVING COUNT() > 5`. |
| 11. Clipboard Data Exfiltration via Email | Clipboard data sent via email protocols, as in some RATs. | - Email Logs (e.g., SMTP traffic)<br>- Network Monitoring | - **Splunk**: `index=network sourcetype=smtp_log \| search attachment="*clip*" OR subject="*data*" \| stats count by src_ip, recipient \| where count > 3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "SMTP" and AdditionalFields has_any ("clip", "data") \| summarize count() by RemoteIP, AdditionalFields.recipient \| where count_ > 3`.<br>- **ELK**: `FROM logs-network.smtp-* \| WHERE message : ("*clip*" OR "*data*") \| STATS COUNT() BY source.ip, email.recipient HAVING COUNT() > 3`. |
| 12. Malicious DLLs for Clipboard Hooking | Custom DLLs loaded for clipboard monitoring, as in Allakore. | - Module Loads (Sysmon ID 7)<br>- File Hashes | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded="*.dll" AND Hashes="unknown" AND ParentImage="*browser*" \| stats count by ImageLoaded, host \| where count > 2`.<br>- **KQL**: `DeviceImageLoadEvents \| where FolderPath endswith ".dll" and SHA256 == "unknown" and InitiatingProcessFolderPath contains "browser" \| summarize count() by FolderPath, DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.library-* \| WHERE dll.name : "*.dll" AND dll.hash = "unknown" AND process.parent.name : "*browser*" \| STATS COUNT() BY dll.path, host.name HAVING COUNT() > 2`. |
| 13. Clipboard Access Correlated with Screen Capture | Clipboard access paired with screenshots, as in espionage campaigns. | - Process Creation (Sysmon ID 1)<br>- File Creation (ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*Clipboard*" \| transaction ProcessGuid maxspan=5m [search EventCode=11 "*screenshot*.png"] \| where eventcount > 1 \| table _time, host`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "Clipboard" \| join kind=inner (DeviceFileEvents \| where FileName contains "screenshot.png") on ProcessId \| project Timestamp, DeviceName`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : "*Clipboard*" \| JOIN logs-endpoint.file-* ON process.pid WHERE file.name : "*screenshot*.png" \| TABLE @timestamp, host.name`. |
| 14. Clipboard Access via Python Scripts | Python scripts using `pyperclip` or `win32clipboard` for capture, common in custom malware. | - Process Creation (Sysmon ID 1 for python.exe)<br>- Module Imports | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*python*" CommandLine="*pyperclip*" OR "*win32clipboard*" \| stats count by host, CommandLine \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath contains "python" and ProcessCommandLine has_any ("pyperclip", "win32clipboard") \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : "python*" AND process.args : ("*pyperclip*" OR "*win32clipboard*") \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 2`. |
| 15. Clipboard Access in Containerized Environments | Adversaries target clipboard in Docker/K8s containers, rare but possible in VDI. | - Container Logs (e.g., K8s events)<br>- Process Execution | - **Splunk**: `index=container sourcetype=k8s:events "exec" Command="*xclip*" \| stats count by pod_name \| where count > 3`.<br>- **KQL**: `KubeEvents \| where Verb == "exec" and Message contains "xclip" \| summarize count() by ObjectRef.name \| where count_ > 3`.<br>- **ELK**: `FROM logs-kubernetes.events-* \| WHERE kubernetes.event.verb = 'exec' AND message : '*xclip*' \| STATS COUNT() BY kubernetes.pod.name HAVING COUNT() > 3`. |


### Code Repositories

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Unauthorized API Access to Code Repositories | Adversaries use stolen API tokens to access repos (e.g., GitHub API), as in LAPSUS$ attacks.<grok:render type="render_inline_citation"><argument name="citation_id">20</argument></grok:render> High risk in cloud-hosted repos with poor token hygiene. | - Cloud Audit Logs (e.g., GitHub Audit, AWS CloudTrail)<br>- API Request Logs | - **Splunk**: `index=cloud sourcetype=github:audit action IN ("repo.access", "repo.download") AND user NOT IN (authorized_users) \| stats count by user, repo \| where count > 5`.<br>- **KQL**: `GitHubAuditLogs \| where Action in ("repo.access", "repo.download") and Actor !in (authorizedUsers) \| summarize count() by Actor, Repository \| where count_ > 5`.<br>- **ELK**: `FROM logs-github.audit-* \| WHERE event.action IN ['repo.access', 'repo.download'] AND user.name NOT IN ['admin'] \| STATS COUNT() BY user.name, repository.name HAVING COUNT() > 5`. |
| 2. Anomalous Git Command Execution on Endpoints | Adversaries run `git clone` or `git pull` from unusual processes or locations, indicating repo data exfiltration.<grok:render type="render_inline_citation"><argument name="citation_id">20</argument></grok:render> Hunt in dev endpoints (Windows/Linux). | - Process Creation (e.g., Sysmon ID 1)<br>- Command Execution Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*git.exe*" CommandLine IN ("*clone*", "*pull*") AND NOT ParentImage IN (dev_tools) \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "git.exe" and ProcessCommandLine has_any ("clone", "pull") and not(InitiatingProcessFolderPath in~ (devTools)) \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name = "git.exe" AND process.args : ("*clone*" OR "*pull*") AND process.parent.name NOT IN ['code.exe'] \| TABLE @timestamp, host.name, process.command_line`. |
| 3. Large-Scale Repository Downloads | Adversaries mass-download repos via API or CLI, as in Scattered Spiders bulk exfil.<grok:render type="render_inline_citation"><argument name="citation_id">20</argument></grok:render> Detect high-volume transfers. | - Network Traffic (e.g., Zeek HTTP logs)<br>- Cloud Storage Logs | - **Splunk**: `index=network sourcetype=zeek_http uri="*github.com/*/archive*" OR uri="*gitlab.com/*/archive*" AND bytes_out > 1000000 \| stats count by src_ip, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteUrl has_any ("github.com/*/archive", "gitlab.com/*/archive") and TotalBytes > 1000000 \| summarize count() by RemoteIP, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri : ("*github.com/*/archive*" OR "*gitlab.com/*/archive*") AND http.bytes.out > 1000000 \| STATS COUNT() BY source.ip, http.uri HAVING COUNT() > 10`. |
| 4. Credential Dumping from Repo Config Files | Adversaries access `.gitconfig` or credential stores for tokens, as in TeamTNT attacks.<grok:render type="render_inline_citation"><argument name="citation_id">20</argument></grok:render> Hunt in endpoint file access logs. | - File Access (Sysmon ID 11)<br>- File Content Monitoring | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename IN ("*.gitconfig", "*credential*") AND ProcessImage NOT IN (legit_git_tools) \| stats count by TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileAccessed" and FileName has_any (".gitconfig", "credential") and not(InitiatingProcessFolderPath in~ (gitTools)) \| summarize count() by FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'access' AND file.name : ("*.gitconfig" OR "*credential*") AND process.name NOT IN ['git'] \| STATS COUNT() BY file.name, host.name HAVING COUNT() > 3`. |
| 5. Suspicious Authentication to Repo Platforms | Unusual logins to GitHub/GitLab from non-corporate IPs, indicating compromised accounts.<grok:render type="render_inline_citation"><argument name="citation_id">20</argument></grok:render> | - Authentication Logs (e.g., Azure AD Sign-ins, GitHub Audit)<br>- Identity Provider Logs | - **Splunk**: `index=security sourcetype=azure:ad:signin AppDisplayName IN ("GitHub", "GitLab") AND IPAddress NOT IN (corporate_ranges) \| stats count by UserPrincipalName, IPAddress \| where count > 5`.<br>- **KQL**: `SigninLogs \| where AppDisplayName in ("GitHub", "GitLab") and IPAddress !in (corporateRanges) \| summarize count() by UserPrincipalName, IPAddress \| where count_ > 5`.<br>- **ELK**: `FROM logs-azure.signin-* \| WHERE app.name IN ['GitHub', 'GitLab'] AND source.ip NOT IN ['10.0.0.0/8'] \| STATS COUNT() BY user.name, source.ip HAVING COUNT() > 5`. |
| 6. Repo Access Followed by Data Staging | Correlate repo access (e.g., `git clone`) with file writes to staging dirs, as in APT33 exfiltration prep.<grok:render type="render_inline_citation"><argument name="citation_id">20</argument></grok:render> | - Process Creation (Sysmon ID 1)<br>- File Creation (ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*git clone*" \| transaction ProcessGuid maxspan=5m [search EventCode=11 TargetFilename="*staging*"] \| where eventcount > 1 \| table _time, host, TargetFilename`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "git clone" \| join kind=inner (DeviceFileEvents \| where FileName contains "staging") on ProcessId \| project Timestamp, DeviceName, FileName`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : "*git*clone*" \| JOIN logs-endpoint.file-* ON process.pid WHERE file.name : "*staging*" \| TABLE @timestamp, host.name, file.name`. |
| 7. Anomalous Repo API Calls from Cloud Instances | Adversaries use cloud VMs to query repos via APIs, as in cloud-targeted APTs.<grok:render type="render_inline_citation"><argument name="citation_id">20</argument></grok:render> | - Cloud Audit Logs (e.g., AWS CloudTrail)<br>- Instance Process Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("ListRepositories", "GetRepository") AND userIdentity NOT IN (authorized) \| stats count by userIdentity, eventName \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("ListRepositories", "GetRepository") and Caller !in (authorizedUsers) \| summarize count() by Caller, EventName \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['ListRepositories', 'GetRepository'] AND user.identity NOT IN ['admin'] \| STATS COUNT() BY user.identity, event.action HAVING COUNT() > 10`. |
| 8. Malicious Scripts Accessing Repo Credentials | Scripts (e.g., PowerShell) accessing repo credentials via environment variables or config files.<grok:render type="render_inline_citation"><argument name="citation_id">20</argument></grok:render> | - Script Execution (Sysmon ID 1 for powershell.exe)<br>- Environment Variable Access | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe*" CommandLine IN ("*GITHUB_TOKEN*", "*GITLAB_TOKEN*") \| stats count by host, CommandLine \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "powershell.exe" and ProcessCommandLine has_any ("GITHUB_TOKEN", "GITLAB_TOKEN") \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name = "powershell.exe" AND process.args : ("*GITHUB_TOKEN*" OR "*GITLAB_TOKEN*") \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 2`. |
| 9. High-Volume Repo Access from Single User | Spikes in repo actions (e.g., pulls, clones) from one account, indicating automated exfiltration.<grok:render type="render_inline_citation"><argument name="citation_id">20</argument></grok:render> | - Audit Logs (e.g., GitHub/GitLab audit)<br>- User Activity Metrics | - **Splunk**: `index=cloud sourcetype=github:audit action IN ("repo.clone", "repo.pull") \| timechart span=1h count by user \| where count > avg(count)*4`.<br>- **KQL**: `GitHubAuditLogs \| where Action in ("repo.clone", "repo.pull") \| summarize HourlyCount=count() by bin(Timestamp, 1h), Actor \| where HourlyCount > avg(HourlyCount) * 4`.<br>- **ELK**: `FROM logs-github.audit-* \| WHERE event.action IN ['repo.clone', 'repo.pull'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), user.name \| WHERE COUNT() > AVG(COUNT()) * 4`. |
| 10. Unauthorized SSH Key Additions to Repos | Adversaries add SSH keys for persistent repo access, as in UNC2452.<grok:render type="render_inline_citation"><argument name="citation_id">20</argument></grok:render> | - Audit Logs (e.g., GitHub SSH key events)<br>- Identity Changes | - **Splunk**: `index=cloud sourcetype=github:audit action="ssh_key.add" AND user NOT IN (authorized_admins) \| stats count by user, key_fingerprint \| where count > 1`.<br>- **KQL**: `GitHubAuditLogs \| where Action == "ssh_key.add" and Actor !in (authorizedAdmins) \| summarize count() by Actor, AdditionalFields.keyFingerprint \| where count_ > 1`.<br>- **ELK**: `FROM logs-github.audit-* \| WHERE event.action = 'ssh_key.add' AND user.name NOT IN ['admin'] \| STATS COUNT() BY user.name, key.fingerprint HAVING COUNT() > 1`. |
| 11. Repo Access from Compromised Containers | Adversaries run `git` commands in Kubernetes/Docker pods, as in TeamTNT.<grok:render type="render_inline_citation"><argument name="citation_id">20</argument></grok:render> | - Container Logs (e.g., K8s events)<br>- Process Execution | - **Splunk**: `index=container sourcetype=k8s:events "exec" Command="*git clone*" \| stats count by pod_name \| where count > 3`.<br>- **KQL**: `KubeEvents \| where Verb == "exec" and Message contains "git clone" \| summarize count() by ObjectRef.name \| where count_ > 3`.<br>- **ELK**: `FROM logs-kubernetes.events-* \| WHERE kubernetes.event.verb = 'exec' AND message : '*git*clone*' \| STATS COUNT() BY kubernetes.pod.name HAVING COUNT() > 3`. |
| 12. Repo Data Exfiltration via Network | Cloned repo data sent to external IPs, as in APT41 campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">20</argument></grok:render> | - Network Traffic (Zeek file transfers)<br>- Process Network (Sysmon ID 3) | - **Splunk**: `index=network sourcetype=zeek_file mime_type="application/zip" AND url="*github*" \| stats count by src_ip, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.mimeType == "application/zip" and RemoteUrl contains "github" \| summarize count() by RemoteIP, InitiatingProcessIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.file-* \| WHERE file.mime_type = 'application/zip' AND http.url : "*github*" \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 5`. |
| 13. Suspicious Repo Configuration Changes | Adversaries modify repo settings (e.g., webhooks) to facilitate data access.<grok:render type="render_inline_citation"><argument name="citation_id">20</argument></grok:render> | - Audit Logs (GitHub/GitLab webhook events)<br>- Configuration Changes | - **Splunk**: `index=cloud sourcetype=github:audit action="repo.webhook.create" AND webhook_url NOT IN (trusted_urls) \| stats count by user, webhook_url \| where count > 1`.<br>- **KQL**: `GitHubAuditLogs \| where Action == "repo.webhook.create" and AdditionalFields.webhookUrl !in (trustedUrls) \| summarize count() by Actor, AdditionalFields.webhookUrl \| where count_ > 1`.<br>- **ELK**: `FROM logs-github.audit-* \| WHERE event.action = 'repo.webhook.create' AND webhook.url NOT IN ['trusted.com'] \| STATS COUNT() BY user.name, webhook.url HAVING COUNT() > 1`. |
| 14. Repo Access Correlated with Phishing | Phishing campaigns lead to repo access (e.g., stolen tokens), as in Scattered Spider.<grok:render type="render_inline_citation"><argument name="citation_id">20</argument></grok:render> | - Email Logs (phishing events)<br>- Audit Logs | - **Splunk**: `index=email sourcetype=phish_log "malicious link" \| join user [search sourcetype=github:audit "repo.access"] \| stats count by user, host \| where count > 1`.<br>- **KQL**: `EmailEvents \| where ActionType == "PhishDetected" \| join kind=inner (GitHubAuditLogs \| where Action == "repo.access") on Actor \| summarize count() by Actor, DeviceName \| where count_ > 1`.<br>- **ELK**: `FROM logs-email-* \| WHERE event.action = 'phish' \| JOIN logs-github.audit-* ON user.name WHERE event.action = 'repo.access' \| STATS COUNT() BY user.name, host.name HAVING COUNT() > 1`. |
| 15. Anomalous Repo Access Patterns in CI/CD | Adversaries abuse CI/CD pipelines (e.g., GitHub Actions) to access repos, as in UNC2452.<grok:render type="render_inline_citation"><argument name="citation_id">20</argument></grok:render> | - CI/CD Logs (e.g., GitHub Actions logs)<br>- Workflow Events | - **Splunk**: `index=cloud sourcetype=github:actions workflow_run AND actor NOT IN (trusted_runners) \| stats count by workflow_name, actor \| where count > 5`.<br>- **KQL**: `GitHubAuditLogs \| where Action == "workflow_run" and Actor !in (trustedRunners) \| summarize count() by WorkflowName, Actor \| where count_ > 5`.<br>- **ELK**: `FROM logs-github.actions-* \| WHERE event.action = 'workflow_run' AND user.name NOT IN ['runner1'] \| STATS COUNT() BY workflow.name, user.name HAVING COUNT() > 5`. |


### Confluence

# Threat Hunting Hypotheses for Confluence (T1213.001)

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Unauthorized Confluence API Access | Adversaries use stolen API tokens to access Confluence pages or attachments, as seen in LAPSUS$ attacks.<grok:render type="render_inline_citation"><argument name="citation_id">25</argument></grok:render> High risk in cloud-hosted Confluence instances. | - Confluence Audit Logs (e.g., Atlassian Cloud Audit)<br>- API Request Logs | - **Splunk**: `index=cloud sourcetype=atlassian:audit action IN ("page.viewed", "attachment.downloaded") AND user NOT IN (authorized_users) \| stats count by user, object \| where count > 5`.<br>- **KQL**: `AtlassianAuditLogs \| where Action in ("page.viewed", "attachment.downloaded") and User !in (authorizedUsers) \| summarize count() by User, ObjectName \| where count_ > 5`.<br>- **ELK**: `FROM logs-atlassian.audit-* \| WHERE event.action IN ['page.viewed', 'attachment.downloaded'] AND user.name NOT IN ['admin'] \| STATS COUNT() BY user.name, object.name HAVING COUNT() > 5`. |
| 2. Suspicious Page or Attachment Exports | Adversaries export Confluence pages or spaces as PDF/ZIP, indicating bulk data theft.<grok:render type="render_inline_citation"><argument name="citation_id">25</argument></grok:render> Hunt in Confluence Cloud/Server environments. | - Confluence Audit Logs<br>- File Download Events | - **Splunk**: `index=cloud sourcetype=atlassian:audit action="export" AND object_type IN ("page", "space") \| stats count by user, object \| where count > 3`.<br>- **KQL**: `AtlassianAuditLogs \| where Action == "export" and ObjectType in ("page", "space") \| summarize count() by User, ObjectName \| where count_ > 3`.<br>- **ELK**: `FROM logs-atlassian.audit-* \| WHERE event.action = 'export' AND object.type IN ['page', 'space'] \| STATS COUNT() BY user.name, object.name HAVING COUNT() > 3`. |
| 3. Anomalous Authentication to Confluence | Unusual logins from non-corporate IPs, indicating compromised accounts, as in Scattered Spider attacks.<grok:render type="render_inline_citation"><argument name="citation_id">25</argument></grok:render> | - Authentication Logs (e.g., Azure AD Sign-ins, Confluence Logs)<br>- Identity Provider Logs | - **Splunk**: `index=security sourcetype=azure:ad:signin AppDisplayName="Confluence" AND IPAddress NOT IN (corporate_ranges) \| stats count by UserPrincipalName, IPAddress \| where count > 5`.<br>- **KQL**: `SigninLogs \| where AppDisplayName == "Confluence" and IPAddress !in (corporateRanges) \| summarize count() by UserPrincipalName, IPAddress \| where count_ > 5`.<br>- **ELK**: `FROM logs-azure.signin-* \| WHERE app.name = 'Confluence' AND source.ip NOT IN ['10.0.0.0/8'] \| STATS COUNT() BY user.name, source.ip HAVING COUNT() > 5`. |
| 4. Suspicious Confluence Page Access Patterns | High-frequency page views or downloads by a single user, suggesting automated scraping.<grok:render type="render_inline_citation"><argument name="citation_id">25</argument></grok:render> | - Confluence Audit Logs<br>- User Activity Metrics | - **Splunk**: `index=cloud sourcetype=atlassian:audit action="page.viewed" \| timechart span=1h count by user \| where count > avg(count)*4`.<br>- **KQL**: `AtlassianAuditLogs \| where Action == "page.viewed" \| summarize HourlyCount=count() by bin(Timestamp, 1h), User \| where HourlyCount > avg(HourlyCount) * 4`.<br>- **ELK**: `FROM logs-atlassian.audit-* \| WHERE event.action = 'page.viewed' \| STATS COUNT() BY date_histogram(@timestamp, '1h'), user.name \| WHERE COUNT() > AVG(COUNT()) * 4`. |
| 5. Unauthorized Script or Tool Access to Confluence | Adversaries use tools like `curl` or `wget` to scrape Confluence, as in APT33 campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">25</argument></grok:render> Hunt in endpoint logs. | - Process Creation (e.g., Sysmon ID 1)<br>- Network Traffic (Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*curl.exe*", "*wget*") AND CommandLine="*confluence*" \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("curl.exe", "wget") and ProcessCommandLine contains "confluence" \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("curl.exe" OR "wget") AND process.args : "*confluence*" \| TABLE @timestamp, host.name, process.command_line`. |
| 6. Confluence Data Staging Post-Access | Correlate Confluence access with file writes to staging directories, indicating exfiltration prep.<grok:render type="render_inline_citation"><argument name="citation_id">25</argument></grok:render> | - Confluence Audit Logs<br>- File Creation (Sysmon ID 11) | - **Splunk**: `index=cloud sourcetype=atlassian:audit action="attachment.downloaded" \| join user [search index=endpoint sourcetype=sysmon EventCode=11 TargetFilename="*staging*"] \| stats count by user, host \| where count > 1`.<br>- **KQL**: `AtlassianAuditLogs \| where Action == "attachment.downloaded" \| join kind=inner (DeviceFileEvents \| where FileName contains "staging") on User \| summarize count() by User, DeviceName \| where count_ > 1`.<br>- **ELK**: `FROM logs-atlassian.audit-* \| WHERE event.action = 'attachment.downloaded' \| JOIN logs-endpoint.file-* ON user.name WHERE file.name : "*staging*" \| STATS COUNT() BY user.name, host.name HAVING COUNT() > 1`. |
| 7. Exploitation of Known Confluence Vulnerabilities | Adversaries exploit CVEs (e.g., CVE-2022-26134) for unauthorized access, as in Volt Typhoon.<grok:render type="render_inline_citation"><argument name="citation_id">25</argument></grok:render> | - Web Server Logs (e.g., Apache/Nginx)<br>- IDS/IPS Alerts | - **Splunk**: `index=web sourcetype=apache:access uri="*rest/api*" AND status=200 AND method="POST" AND NOT user_agent IN (known_bots) \| stats count by src_ip, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteUrl contains "rest/api" and AdditionalFields.status == 200 and AdditionalFields.method == "POST" and not(AdditionalFields.userAgent in~ (knownBots)) \| summarize count() by RemoteIP, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-apache.access-* \| WHERE http.uri : "*rest/api*" AND http.status = 200 AND http.method = 'POST' AND http.user_agent NOT IN ['GoogleBot'] \| STATS COUNT() BY source.ip, http.uri HAVING COUNT() > 10`. |
| 8. Unauthorized Confluence Plugin Installation | Adversaries install malicious plugins to extract data, as in targeted Confluence attacks.<grok:render type="render_inline_citation"><argument name="citation_id">25</argument></grok:render> | - Confluence Audit Logs<br>- Plugin Installation Events | - **Splunk**: `index=cloud sourcetype=atlassian:audit action="plugin.installed" AND plugin_key NOT IN (trusted_plugins) \| stats count by user, plugin_key \| where count > 1`.<br>- **KQL**: `AtlassianAuditLogs \| where Action == "plugin.installed" and AdditionalFields.pluginKey !in (trustedPlugins) \| summarize count() by User, AdditionalFields.pluginKey \| where count_ > 1`.<br>- **ELK**: `FROM logs-atlassian.audit-* \| WHERE event.action = 'plugin.installed' AND plugin.key NOT IN ['trusted.plugin'] \| STATS COUNT() BY user.name, plugin.key HAVING COUNT() > 1`. |
| 9. Confluence Access via Compromised SSO | Adversaries use stolen SSO credentials to access Confluence, as in Okta breaches.<grok:render type="render_inline_citation"><argument name="citation_id">25</argument></grok:render> | - SSO Logs (e.g., Okta, Azure AD)<br>- Authentication Events | - **Splunk**: `index=security sourcetype=okta:log eventType="user.session.start" AND app="Confluence" AND client_ip NOT IN (corporate_ranges) \| stats count by user, client_ip \| where count > 5`.<br>- **KQL**: `OktaLogs \| where eventType == "user.session.start" and app == "Confluence" and clientIP !in (corporateRanges) \| summarize count() by user, clientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-okta-* \| WHERE event.type = 'user.session.start' AND app.name = 'Confluence' AND client.ip NOT IN ['10.0.0.0/8'] \| STATS COUNT() BY user.name, client.ip HAVING COUNT() > 5`. |
| 10. Confluence Data Exfiltration via Network | Downloaded Confluence data (e.g., attachments) sent to external IPs.<grok:render type="render_inline_citation"><argument name="citation_id">25</argument></grok:render> | - Network Traffic (Zeek file transfers)<br>- Confluence Audit Logs | - **Splunk**: `index=network sourcetype=zeek_file mime_type IN ("application/pdf", "application/zip") AND url="*confluence*" \| stats count by src_ip, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.mimeType in ("application/pdf", "application/zip") and RemoteUrl contains "confluence" \| summarize count() by RemoteIP, InitiatingProcessIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.file-* \| WHERE file.mime_type IN ['application/pdf', 'application/zip'] AND http.url : "*confluence*" \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 5`. |
| 11. Suspicious Confluence Macro Execution | Adversaries use malicious macros (e.g., ScriptRunner) to extract data.<grok:render type="render_inline_citation"><argument name="citation_id">25</argument></grok:render> | - Confluence Audit Logs<br>- Macro Execution Events | - **Splunk**: `index=cloud sourcetype=atlassian:audit action="macro.executed" AND macro_name NOT IN (trusted_macros) \| stats count by user, macro_name \| where count > 2`.<br>- **KQL**: `AtlassianAuditLogs \| where Action == "macro.executed" and AdditionalFields.macroName !in (trustedMacros) \| summarize count() by User, AdditionalFields.macroName \| where count_ > 2`.<br>- **ELK**: `FROM logs-atlassian.audit-* \| WHERE event.action = 'macro.executed' AND macro.name NOT IN ['trusted.macro'] \| STATS COUNT() BY user.name, macro.name HAVING COUNT() > 2`. |
| 12. Confluence Access from Compromised Containers | Adversaries run scripts in Kubernetes/Docker pods to access Confluence APIs.<grok:render type="render_inline_citation"><argument name="citation_id">25</argument></grok:render> | - Container Logs (e.g., K8s events)<br>- Process Execution | - **Splunk**: `index=container sourcetype=k8s:events "exec" Command="*curl*confluence*" \| stats count by pod_name \| where count > 3`.<br>- **KQL**: `KubeEvents \| where Verb == "exec" and Message contains "curl" and Message contains "confluence" \| summarize count() by ObjectRef.name \| where count_ > 3`.<br>- **ELK**: `FROM logs-kubernetes.events-* \| WHERE kubernetes.event.verb = 'exec' AND message : ('*curl*' AND '*confluence*') \| STATS COUNT() BY kubernetes.pod.name HAVING COUNT() > 3`. |
| 13. Correlated Phishing and Confluence Access | Phishing campaigns lead to Confluence access via stolen credentials.<grok:render type="render_inline_citation"><argument name="citation_id">25</argument></grok:render> | - Email Logs (phishing events)<br>- Confluence Audit Logs | - **Splunk**: `index=email sourcetype=phish_log "malicious link" \| join user [search sourcetype=atlassian:audit "page.viewed"] \| stats count by user, host \| where count > 1`.<br>- **KQL**: `EmailEvents \| where ActionType == "PhishDetected" \| join kind=inner (AtlassianAuditLogs \| where Action == "page.viewed") on User \| summarize count() by User, DeviceName \| where count_ > 1`.<br>- **ELK**: `FROM logs-email-* \| WHERE event.action = 'phish' \| JOIN logs-atlassian.audit-* ON user.name WHERE event.action = 'page.viewed' \| STATS COUNT() BY user.name, host.name HAVING COUNT() > 1`. |
| 14. Confluence Credential Dumping from Configs | Adversaries access Confluence config files (e.g., `confluence.cfg.xml`) for creds.<grok:render type="render_inline_citation"><argument name="citation_id">25</argument></grok:render> | - File Access (Sysmon ID 11)<br>- Server Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename="*confluence.cfg.xml" AND ProcessImage NOT IN (confluence_processes) \| stats count by TargetFilename, host \| where count > 2`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileAccessed" and FileName contains "confluence.cfg.xml" and not(InitiatingProcessFolderPath in~ (confluenceProcs)) \| summarize count() by FileName, DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'access' AND file.name : "*confluence.cfg.xml" AND process.name NOT IN ['confluence'] \| STATS COUNT() BY file.name, host.name HAVING COUNT() > 2`. |
| 15. Anomalous Confluence Search Queries | Adversaries use Confluence search to locate sensitive data, as in espionage campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">25</argument></grok:render> | - Confluence Audit Logs<br>- Search Query Logs | - **Splunk**: `index=cloud sourcetype=atlassian:audit action="search.executed" AND query="*credential*" OR query="*secret*" \| stats count by user, query \| where count > 5`.<br>- **KQL**: `AtlassianAuditLogs \| where Action == "search.executed" and AdditionalFields.query has_any ("credential", "secret") \| summarize count() by User, AdditionalFields.query \| where count_ > 5`.<br>- **ELK**: `FROM logs-atlassian.audit-* \| WHERE event.action = 'search.executed' AND search.query : ("*credential*" OR "*secret*") \| STATS COUNT() BY user.name, search.query HAVING COUNT() > 5`. |


### Credential API Hooking


| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Suspicious API Hooking via SetWindowsHookEx | Adversaries use `SetWindowsHookEx` to intercept credential APIs, as seen in TrickBot.<grok:render type="render_inline_citation"><argument name="citation_id">30</argument></grok:render> High risk in Windows with unmonitored processes. | - API Monitoring (e.g., ETW traces, Sysmon ID 10)<br>- Process Memory Events | - **Splunk**: `index=endpoint sourcetype=etw \| search CallTrace="*SetWindowsHookEx*" AND ProcessName NOT IN (legit_apps) \| stats count by ProcessName \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "ApiCall" and AdditionalFields.CallName == "SetWindowsHookEx" and not(InitiatingProcessName in~ (legitApps)) \| summarize count() by InitiatingProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-etw-* \| WHERE event.action = 'apicall' AND trace.call = "*SetWindowsHookEx*" AND process.name NOT IN ['explorer.exe'] \| STATS COUNT() BY process.name HAVING COUNT() > 5`. |
| 2. Unauthorized LSASS Memory Access | Adversaries inject into `lsass.exe` to hook credential APIs, as in Mimikatz.<grok:render type="render_inline_citation"><argument name="citation_id">30</argument></grok:render> Critical in Windows environments. | - Process Access (Sysmon ID 10)<br>- Memory Access Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=10 TargetImage="*lsass.exe*" AND GrantedAccess="0x1fffff" AND SourceImage NOT IN (legit_processes) \| stats count by SourceImage, TargetImage \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where ActionType == "ProcessAccessed" and FolderPath endswith "lsass.exe" and AdditionalFields.GrantedAccess == "0x1fffff" and not(InitiatingProcessFolderPath in~ (legitProcs)) \| summarize count() by InitiatingProcessFolderPath, FolderPath \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.events.process-* \| WHERE event.code = "10" AND process.target.name = "lsass.exe" AND process.access.granted = "0x1fffff" AND process.source.name NOT IN ['svchost.exe'] \| STATS COUNT() BY process.source.name, process.target.name HAVING COUNT() > 3`. |
| 3. Suspicious Module Loads for Credential Hooking | Malicious DLLs loaded to hook APIs like `WNetEnumResource`, as in banking trojans.<grok:render type="render_inline_citation"><argument name="citation_id">30</argument></grok:render> Hunt in Windows endpoints. | - Module Loads (Sysmon ID 7)<br>- File Hashes | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 ImageLoaded="*.dll" AND Hashes="unknown" AND Image NOT IN (known_apps) \| stats count by ImageLoaded, Image \| where count > 2`.<br>- **KQL**: `DeviceImageLoadEvents \| where FolderPath endswith ".dll" and SHA256 == "unknown" and not(InitiatingProcessFolderPath in~ (knownApps)) \| summarize count() by FolderPath, InitiatingProcessFolderPath \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.library-* \| WHERE dll.name : "*.dll" AND dll.hash = "unknown" AND process.name NOT IN ['chrome.exe'] \| STATS COUNT() BY dll.path, process.name HAVING COUNT() > 2`. |
| 4. Anomalous Credential API Calls | Processes calling `LsaRetrievePrivateData` or similar APIs unexpectedly, indicating hooking attempts.<grok:render type="render_inline_citation"><argument name="citation_id">30</argument></grok:render> | - API Call Monitoring (ETW traces)<br>- Process Behavior | - **Splunk**: `index=endpoint sourcetype=etw CallTrace IN ("*LsaRetrievePrivateData*", "*CredEnumerate*") AND ProcessName NOT IN (legit_services) \| stats count by ProcessName \| where count > 5`.<br>- **KQL**: `DeviceEvents \| where ActionType == "ApiCall" and AdditionalFields.CallName in ("LsaRetrievePrivateData", "CredEnumerate") and not(InitiatingProcessName in~ (legitServices)) \| summarize count() by InitiatingProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-etw-* \| WHERE trace.call IN ['*LsaRetrievePrivateData*', '*CredEnumerate*'] AND process.name NOT IN ['svchost.exe'] \| STATS COUNT() BY process.name HAVING COUNT() > 5`. |
| 5. Credential Hooking Followed by Data Staging | Correlate API hooking with file writes to staging directories, as in TrickBot exfiltration.<grok:render type="render_inline_citation"><argument name="citation_id">30</argument></grok:render> | - Process Creation (Sysmon ID 1)<br>- File Creation (ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*Lsa*" \| transaction ProcessGuid maxspan=5m [search EventCode=11 TargetFilename="*staging*"] \| where eventcount > 1 \| table _time, host, TargetFilename`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "Lsa" \| join kind=inner (DeviceFileEvents \| where FileName contains "staging") on ProcessId \| project Timestamp, DeviceName, FileName`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : "*Lsa*" \| JOIN logs-endpoint.file-* ON process.pid WHERE file.name : "*staging*" \| TABLE @timestamp, host.name, file.name`. |
| 6. Suspicious Child Processes from Hooked Processes | Hooked processes (e.g., `lsass.exe`) spawning unusual child processes like `cmd.exe`.<grok:render type="render_inline_citation"><argument name="citation_id">30</argument></grok:render> | - Process Creation (Sysmon ID 1)<br>- Parent-Child Relationships | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 ParentImage="*lsass.exe*" AND Image IN ("*cmd.exe*", "*powershell.exe*") \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where InitiatingProcessFolderPath endswith "lsass.exe" and FolderPath has_any ("cmd.exe", "powershell.exe") \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.parent.name = "lsass.exe" AND process.name : ("cmd.exe" OR "powershell.exe") \| TABLE @timestamp, host.name, process.command_line`. |
| 7. Linux PAM Module Manipulation | Adversaries modify PAM modules to hook authentication APIs, as in Linux-targeted APTs.<grok:render type="render_inline_citation"><argument name="citation_id">30</argument></grok:render> Hunt in Linux servers. | - File Modifications (auditd file events)<br>- System Call Logs | - **Splunk**: `index=endpoint sourcetype=auditd syscall="openat" path="/etc/pam.d/*" AND NOT exe IN (legit_admin_tools) \| stats count by exe, path \| where count > 2`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileModified" and FolderPath has "/etc/pam.d/" and not(InitiatingProcessFolderPath in~ (adminTools)) \| summarize count() by InitiatingProcessFolderPath, FolderPath \| where count_ > 2`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE syscall.name = 'openat' AND file.path : "/etc/pam.d/*" AND process.exe NOT IN ['sudo'] \| STATS COUNT() BY process.exe, file.path HAVING COUNT() > 2`. |
| 8. Credential API Hooking via Custom Drivers | Adversaries load malicious drivers to intercept credential APIs, as in rootkits.<grok:render type="render_inline_citation"><argument name="citation_id">30</argument></grok:render> | - Driver Loads (Sysmon ID 6)<br>- Module Loads (ID 7) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=6 ImageLoaded="*sys" AND Hashes="unknown" \| stats count by ImageLoaded, host \| where count > 1`.<br>- **KQL**: `DeviceDriverEvents \| where ActionType == "DriverLoaded" and FolderPath endswith ".sys" and SHA256 == "unknown" \| summarize count() by FolderPath, DeviceName \| where count_ > 1`.<br>- **ELK**: `FROM logs-endpoint.driver-* \| WHERE event.action = 'load' AND driver.name : "*.sys" AND driver.hash = "unknown" \| STATS COUNT() BY driver.path, host.name HAVING COUNT() > 1`. |
| 9. Network Traffic Post-Credential Hooking | Hooked credentials exfiltrated via HTTP/HTTPS, as in Mimikatz campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">30</argument></grok:render> | - Network Traffic (Zeek HTTP logs)<br>- Process Network (Sysmon ID 3) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*Lsa*" \| join ProcessGuid [search EventCode=3 DestinationPort IN (80,443)] \| stats count by host, DestinationIp \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "Lsa" \| join kind=inner (DeviceNetworkEvents \| where RemotePort in (80,443)) on ProcessId \| summarize count() by DeviceName, RemoteIP \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : "*Lsa*" \| JOIN logs-endpoint.network-* ON process.pid WHERE destination.port IN [80,443] \| STATS COUNT() BY host.name, destination.ip HAVING COUNT() > 2`. |
| 10. PowerShell Scripts for Credential API Access | PowerShell scripts calling credential APIs (e.g., `Get-Credential`), as in custom malware.<grok:render type="render_inline_citation"><argument name="citation_id">30</argument></grok:render> | - Script Execution (Sysmon ID 1 for powershell.exe)<br>- Script Block Logging | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe*" CommandLine="*Get-Credential*" \| stats count by host, CommandLine \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "powershell.exe" and ProcessCommandLine contains "Get-Credential" \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name = "powershell.exe" AND process.args : "*Get-Credential*" \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 2`. |
| 11. Credential Hooking in Cloud VDI Instances | Adversaries target credential APIs in cloud desktops (e.g., Azure Virtual Desktop), rare but possible.<grok:render type="render_inline_citation"><argument name="citation_id">30</argument></grok:render> | - Cloud Logs (e.g., Azure Activity)<br>- VDI Session Logs | - **Splunk**: `index=cloud sourcetype=azure:activity OperationName="ProcessAccess" AND Target="*lsass*" AND Caller NOT IN (authorized) \| stats count by ResourceId, Caller \| where count > 5`.<br>- **KQL**: `AzureActivity \| where OperationNameValue contains "ProcessAccess" and TargetResource contains "lsass" and Caller !in (authorizedUsers) \| summarize count() by ResourceId, Caller \| where count_ > 5`.<br>- **ELK**: `FROM logs-azure.activity-* \| WHERE event.action = 'ProcessAccess' AND target.resource : "*lsass*" AND user.name NOT IN ['admin'] \| STATS COUNT() BY resource.id, user.name HAVING COUNT() > 5`. |
| 12. High-Frequency Credential API Calls | Rapid calls to credential APIs, indicating automated harvesting.<grok:render type="render_inline_citation"><argument name="citation_id">30</argument></grok:render> | - API Call Metrics (ETW aggregates)<br>- Process Behavior | - **Splunk**: `index=endpoint sourcetype=etw CallTrace="*LsaRetrievePrivateData*" \| timechart span=1m count \| where count > avg(count)*3`.<br>- **KQL**: `DeviceEvents \| where AdditionalFields.CallName contains "LsaRetrievePrivateData" \| summarize MinutelyCount=count() by bin(Timestamp, 1m) \| where MinutelyCount > avg(MinutelyCount) * 3`.<br>- **ELK**: `FROM logs-etw-* \| WHERE trace.call : "*LsaRetrievePrivateData*" \| STATS COUNT() BY date_histogram(@timestamp, '1m') \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 13. Credential Hooking via Browser Process Injection | Adversaries inject into browsers to hook credential APIs, as in Dridex.<grok:render type="render_inline_citation"><argument name="citation_id">30</argument></grok:render> | - Process Access (Sysmon ID 10)<br>- Browser Events | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=10 TargetImage IN ("*chrome.exe*", "*firefox.exe*") AND GrantedAccess="0x1fffff" \| stats count by SourceImage, TargetImage \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where ActionType == "ProcessAccessed" and FolderPath has_any ("chrome.exe", "firefox.exe") and AdditionalFields.GrantedAccess == "0x1fffff" \| summarize count() by InitiatingProcessFolderPath, FolderPath \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.events.process-* \| WHERE event.code = "10" AND process.target.name : ("chrome.exe" OR "firefox.exe") AND process.access.granted = "0x1fffff" \| STATS COUNT() BY process.source.name, process.target.name HAVING COUNT() > 3`. |
| 14. Credential Hooking Correlated with Network Exfiltration | Hooked credentials sent to C2 servers, as in Emotet.<grok:render type="render_inline_citation"><argument name="citation_id">30</argument></grok:render> | - Network Traffic (Zeek HTTP logs)<br>- Process Events (Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*CredEnumerate*" \| join ProcessGuid [search EventCode=3 DestinationPort=443] \| stats count by host, DestinationIp \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "CredEnumerate" \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 443) on ProcessId \| summarize count() by DeviceName, RemoteIP \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : "*CredEnumerate*" \| JOIN logs-endpoint.network-* ON process.pid WHERE destination.port = 443 \| STATS COUNT() BY host.name, destination.ip HAVING COUNT() > 2`. |
| 15. Suspicious PAM Module Loads in Linux | Adversaries load custom PAM modules to hook authentication, as in advanced Linux attacks.<grok:render type="render_inline_citation"><argument name="citation_id">30</argument></grok:render> | - Module Loads (auditd module events)<br>- File Changes | - **Splunk**: `index=endpoint sourcetype=auditd type="SYSCALL" syscall="init_module" AND path="/lib/security/pam*" AND NOT exe IN (legit_tools) \| stats count by path, exe \| where count > 1`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "ModuleLoaded" and FolderPath has "/lib/security/pam" and not(InitiatingProcessFolderPath in~ (legitTools)) \| summarize count() by FolderPath, InitiatingProcessFolderPath \| where count_ > 1`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE event.type = 'syscall' AND syscall.name = 'init_module' AND file.path : "/lib/security/pam*" AND process.exe NOT IN ['systemd'] \| STATS COUNT() BY file.path, process.exe HAVING COUNT() > 1`. |


### Customer Relationship Management Software

Adversaries may target CRM systems like Salesforce, Microsoft Dynamics 365, or HubSpot to steal customer data, credentials, and business intelligence, often via API abuse, OAuth token theft, or third-party integrations. This sub-technique under Data from Information Repositories (T1213) has been prominent in 2025 campaigns, with groups like UNC3944 (Scattered Spider) and UNC6040 (ShinyHunters) using vishing and malicious "Data Loader" apps for bulk exfiltration of records from Salesforce instances. Hypotheses focus on cloud audit logs, API patterns, and authentication anomalies, assuming visibility via Salesforce Event Monitoring or Azure Sentinel. In low-visibility environments, prioritize network and identity logs.

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Unauthorized API Access via Stolen OAuth Tokens | Adversaries use compromised OAuth tokens (e.g., via vishing) for unauthorized CRM API calls, as in ShinyHunters' Salesforce attacks. High risk in Salesforce/Dynamics with weak MFA. | - Cloud Audit Logs (e.g., Salesforce Event Monitoring, Azure Activity)<br>- API Request Logs | - **Splunk**: `index=cloud sourcetype=salesforce:api action IN ("query", "queryAll") AND client_id NOT IN (trusted_apps) \| stats count by client_id, user \| where count > 10`.<br>- **KQL**: `SalesforceAuditLogs \| where Action in ("query", "queryAll") and ClientId !in (trustedApps) \| summarize count() by ClientId, User \| where count_ > 10`.<br>- **ELK**: `FROM logs-salesforce.api-* \| WHERE event.action IN ['query', 'queryAll'] AND client.id NOT IN ['trusted_app'] \| STATS COUNT() BY client.id, user.name HAVING COUNT() > 10`. |
| 2. Bulk Data Exports via Legitimate Tools | Adversaries abuse tools like Salesforce Data Loader for large-scale exports, as observed in UNC6040 campaigns. Detect spikes in export volumes. | - CRM Export Logs (Salesforce Bulk API)<br>- File Download Events | - **Splunk**: `index=cloud sourcetype=salesforce:bulk export_job AND records_extracted > 10000 AND user NOT IN (authorized) \| stats count by user, object_type \| where count > 5`.<br>- **KQL**: `SalesforceBulkLogs \| where Action == "export_job" and RecordsExtracted > 10000 and User !in (authorizedUsers) \| summarize count() by User, ObjectType \| where count_ > 5`.<br>- **ELK**: `FROM logs-salesforce.bulk-* \| WHERE event.action = 'export_job' AND records.extracted > 10000 AND user.name NOT IN ['admin'] \| STATS COUNT() BY user.name, object.type HAVING COUNT() > 5`. |
| 3. Anomalous Authentication to CRM Platforms | Unusual logins to Salesforce/Dynamics from external IPs, often post-vishing, as in Scattered Spider tactics. | - Authentication Logs (Azure AD Sign-ins, Salesforce Login History)<br>- Identity Provider Logs | - **Splunk**: `index=security sourcetype=azure:ad:signin AppDisplayName IN ("Salesforce", "Dynamics 365") AND IPAddress NOT IN (corporate_ranges) \| stats count by UserPrincipalName, IPAddress \| where count > 5`.<br>- **KQL**: `SigninLogs \| where AppDisplayName in ("Salesforce", "Dynamics 365") and IPAddress !in (corporateRanges) \| summarize count() by UserPrincipalName, IPAddress \| where count_ > 5`.<br>- **ELK**: `FROM logs-azure.signin-* \| WHERE app.name IN ['Salesforce', 'Dynamics 365'] AND source.ip NOT IN ['10.0.0.0/8'] \| STATS COUNT() BY user.name, source.ip HAVING COUNT() > 5`. |
| 4. Malicious Connected App Authorizations | Adversaries register rogue "Connected Apps" (e.g., trojanized Data Loader) for OAuth access, as in 2025 Salesforce breaches. Hunt for new/unknown app grants. | - CRM Integration Logs (Salesforce Connected App Audit)<br>- OAuth Grant Events | - **Splunk**: `index=cloud sourcetype=salesforce:oauth grant_type="authorization_code" AND client_id NOT IN (approved_apps) \| stats count by client_id, user \| where count > 3`.<br>- **KQL**: `SalesforceOAuthLogs \| where GrantType == "authorization_code" and ClientId !in (approvedApps) \| summarize count() by ClientId, User \| where count_ > 3`.<br>- **ELK**: `FROM logs-salesforce.oauth-* \| WHERE grant.type = 'authorization_code' AND client.id NOT IN ['approved_app'] \| STATS COUNT() BY client.id, user.name HAVING COUNT() > 3`. |
| 5. High-Volume Query Patterns Indicating Exfiltration | Spikes in SOQL queries extracting sensitive objects (e.g., Account, Contact), as in UNC3944 operations. | - API Query Logs (Salesforce REST API)<br>- Usage Metrics | - **Splunk**: `index=cloud sourcetype=salesforce:rest query_object IN ("Account", "Contact", "Opportunity") \| timechart span=1h count by user \| where count > avg(count)*4`.<br>- **KQL**: `SalesforceRestLogs \| where QueryObject in ("Account", "Contact", "Opportunity") \| summarize HourlyCount=count() by bin(Timestamp, 1h), User \| where HourlyCount > avg(HourlyCount) * 4`.<br>- **ELK**: `FROM logs-salesforce.rest-* \| WHERE query.object IN ['Account', 'Contact', 'Opportunity'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), user.name \| WHERE COUNT() > AVG(COUNT()) * 4`. |
| 6. Third-Party Integration Abuse (e.g., Salesloft Drift) | Adversaries exploit integrations like Salesloft for data access, as in the 2025 Drift compromise. Detect anomalous integration activity. | - Integration Logs (Salesforce Connected Apps, Third-Party Audits)<br>- API Calls from Integrations | - **Splunk**: `index=cloud sourcetype=salesforce:integration app_name IN ("Salesloft", "Drift") AND action="data_export" AND user NOT IN (integration_users) \| stats count by app_name, user \| where count > 2`.<br>- **KQL**: `SalesforceIntegrationLogs \| where AppName in ("Salesloft", "Drift") and Action == "data_export" and User !in (integrationUsers) \| summarize count() by AppName, User \| where count_ > 2`.<br>- **ELK**: `FROM logs-salesforce.integration-* \| WHERE app.name IN ['Salesloft', 'Drift'] AND event.action = 'data_export' AND user.name NOT IN ['integration_svc'] \| STATS COUNT() BY app.name, user.name HAVING COUNT() > 2`. |
| 7. AI Agent Prompt Injection for Data Theft | Adversaries use indirect prompt injection in Agentforce AI to exfiltrate CRM data, as in the ForcedLeak vulnerability. Hunt for anomalous AI interactions. | - CRM AI Logs (Salesforce Agentforce Events)<br>- Prompt/Response Monitoring | - **Splunk**: `index=cloud sourcetype=salesforce:agentforce prompt_contains="*exfil*" OR response_contains="sensitive_data" \| stats count by user, prompt \| where count > 1`.<br>- **KQL**: `SalesforceAgentLogs \| where Prompt contains "exfil" or Response contains "sensitive_data" \| summarize count() by User, Prompt \| where count_ > 1`.<br>- **ELK**: `FROM logs-salesforce.agentforce-* \| WHERE prompt.text : "*exfil*" OR response.text : "*sensitive_data*" \| STATS COUNT() BY user.name, prompt.text HAVING COUNT() > 1`. |
| 8. Credential Scanning in Exfiltrated Data | Post-exfil, adversaries scan dumped CRM data for embedded credentials, as in Salesloft incidents. Correlate exports with suspicious processes. | - File Creation (Sysmon ID 11 for dumps)<br>- Process Execution (ID 1 for grep-like tools) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename="*.csv" AND size > 1000000 \| join host [search EventCode=1 CommandLine="*grep*password*"] \| stats count by host \| where count > 1`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FileName endswith ".csv" and FileSize > 1000000 \| join kind=inner (DeviceProcessEvents \| where ProcessCommandLine contains "grep password") on DeviceName \| summarize count() by DeviceName \| where count_ > 1`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'creation' AND file.name : "*.csv" AND file.size > 1000000 \| JOIN logs-endpoint.process-* ON host.name WHERE process.args : "*grep*password*" \| STATS COUNT() BY host.name HAVING COUNT() > 1`. |
| 9. Vishing Indicators Correlated with CRM Access | Vishing (e.g., fake IT calls) leads to OAuth grants and access spikes, as in UNC6040 tactics. | - Email/Voice Logs (Phishing Detections)<br>- CRM Auth Logs | - **Splunk**: `index=security sourcetype=phish_log "vishing" OR "IT support" \| join user [search sourcetype=salesforce:oauth "grant"] \| stats count by user, timestamp \| where count > 1`.<br>- **KQL**: `PhishLogs \| where Description contains_any ("vishing", "IT support") \| join kind=inner (SalesforceOAuthLogs \| where Action == "grant") on User \| summarize count() by User, Timestamp \| where count_ > 1`.<br>- **ELK**: `FROM logs-phish-* \| WHERE message : ("*vishing*" OR "*IT*support*") \| JOIN logs-salesforce.oauth-* ON user.name WHERE event.action = 'grant' \| STATS COUNT() BY user.name, @timestamp HAVING COUNT() > 1`. |
| 10. External Domain Whitelisting for Exfil | Adversaries register expired whitelisted domains (e.g., my-salesforce-cms.com) for data leaks, as in Agentforce vulns. | - CRM Config Logs (Trusted URL Changes)<br>- DNS/Network Logs | - **Splunk**: `index=cloud sourcetype=salesforce:config trusted_url_added AND url NOT IN (corporate_domains) \| stats count by url, user \| where count > 1`.<br>- **KQL**: `SalesforceConfigLogs \| where Action == "trusted_url_added" and Url !in (corporateDomains) \| summarize count() by Url, User \| where count_ > 1`.<br>- **ELK**: `FROM logs-salesforce.config-* \| WHERE event.action = 'trusted_url_added' AND url NOT IN ['corp.com'] \| STATS COUNT() BY url, user.name HAVING COUNT() > 1`. |
| 11. Data Exfiltration via Web-to-Lead Forms | Malicious submissions to Web-to-Lead forms inject prompts for AI exfil, as in ForcedLeak. | - CRM Form Submission Logs<br>- Lead Creation Events | - **Splunk**: `index=cloud sourcetype=salesforce:lead created_via="web" AND description_contains="*command*" OR "*exfil*" \| stats count by lead_source, user \| where count > 2`.<br>- **KQL**: `SalesforceLeadLogs \| where CreatedVia == "web" and Description contains_any ("command", "exfil") \| summarize count() by LeadSource, User \| where count_ > 2`.<br>- **ELK**: `FROM logs-salesforce.lead-* \| WHERE created.via = 'web' AND description : ("*command*" OR "*exfil*") \| STATS COUNT() BY lead.source, user.name HAVING COUNT() > 2`. |
| 12. Integration Credential Harvesting | Adversaries scan exfiltrated CRM data for integration creds (e.g., API keys), as post-Salesloft breach. | - File Content Scans (EDR)<br>- Process Execution for Parsing | - **Splunk**: `index=endpoint sourcetype=edr_scan strings="*api_key*" AND file_path="*.csv" AND parent_process="*salesforce*" \| stats count by file_path, host \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where AdditionalFields.ExtractedStrings contains "api_key" and FileName endswith ".csv" and InitiatingProcessName contains "salesforce" \| summarize count() by FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-edr.scan-* \| WHERE file.strings : "*api_key*" AND file.name : "*.csv" AND process.name : "*salesforce*" \| STATS COUNT() BY file.path, host.name HAVING COUNT() > 3`. |
| 13. Spikes in CRM Object Access | Unusual access to sensitive objects (e.g., Opportunities) indicating targeted exfil. | - CRM Access Logs (Salesforce Setup Audit Trail)<br>- Object-Level Metrics | - **Splunk**: `index=cloud sourcetype=salesforce:access object_type="Opportunity" \| timechart span=1h count \| where count > avg(count)*3`.<br>- **KQL**: `SalesforceAccessLogs \| where ObjectType == "Opportunity" \| summarize HourlyCount=count() by bin(Timestamp, 1h) \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-salesforce.access-* \| WHERE object.type = 'Opportunity' \| STATS COUNT() BY date_histogram(@timestamp, '1h') \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 14. Compromised Accounts in Multi-Tenant CRM | Cross-tenant access via shared creds, as in 2025 multi-company breaches. | - Login History (Salesforce Login Events)<br>- Account Sharing Logs | - **Splunk**: `index=cloud sourcetype=salesforce:login login_type="OAuth" AND org_id != user_org_id \| stats count by user, org_id \| where count > 5`.<br>- **KQL**: `SalesforceLoginLogs \| where LoginType == "OAuth" and OrgId != UserOrgId \| summarize count() by User, OrgId \| where count_ > 5`.<br>- **ELK**: `FROM logs-salesforce.login-* \| WHERE login.type = 'OAuth' AND org.id != user.org.id \| STATS COUNT() BY user.name, org.id HAVING COUNT() > 5`. |
| 15. Post-Breach Credential Rotation Gaps | Failure to rotate creds after detected exfil, leading to re-access; hunt for repeat patterns. | - Credential Management Logs<br>- Re-Auth Events | - **Splunk**: `index=cloud sourcetype=salesforce:oauth revoked=false AND timestamp > breach_time \| stats count by client_id \| where count > 2`.<br>- **KQL**: `SalesforceOAuthLogs \| where Revoked == false and Timestamp > datetime(2025-08-08) \| summarize count() by ClientId \| where count_ > 2`.<br>- **ELK**: `FROM logs-salesforce.oauth-* \| WHERE revoked = false AND @timestamp > "2025-08-08T00:00:00Z" \| STATS COUNT() BY client.id HAVING COUNT() > 2`.


### DHCP Spoofing

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Rogue DHCP Server Responses | Adversaries deploy rogue DHCP servers sending unauthorized `DHCPOFFER` or `DHCPACK` packets, as seen in APT28 campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">35</argument></grok:render> High risk in unsecured networks. | - Network Traffic (e.g., Zeek DHCP logs, packet captures)<br>- IDS/IPS Alerts | - **Splunk**: `index=network sourcetype=zeek_dhcp type IN ("DHCPOFFER", "DHCPACK") AND src_ip NOT IN (legit_dhcp_servers) \| stats count by src_ip, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DHCP" and AdditionalFields.Type in ("DHCPOFFER", "DHCPACK") and RemoteIP !in (legitDhcpServers) \| summarize count() by RemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.dhcp-* \| WHERE dhcp.type IN ['DHCPOFFER', 'DHCPACK'] AND source.ip NOT IN ['192.168.1.10'] \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 5`. |
| 2. Anomalous DHCP Lease Assignments | Clients receive IP leases from unexpected DHCP servers, indicating spoofing.<grok:render type="render_inline_citation"><argument name="citation_id">35</argument></grok:render> Hunt in DHCP server logs. | - DHCP Server Logs (e.g., Windows DHCP, ISC DHCP)<br>- Client Network Configs | - **Splunk**: `index=dhcp sourcetype=dhcp:server lease_assigned AND server_ip NOT IN (known_dhcp_servers) \| stats count by server_ip, client_mac \| where count > 3`.<br>- **KQL**: `DhcpLogs \| where Action == "lease_assigned" and ServerIP !in (knownDhcpServers) \| summarize count() by ServerIP, ClientMac \| where count_ > 3`.<br>- **ELK**: `FROM logs-dhcp.server-* \| WHERE event.action = 'lease_assigned' AND server.ip NOT IN ['192.168.1.10'] \| STATS COUNT() BY server.ip, client.mac HAVING COUNT() > 3`. |
| 3. Suspicious DNS Server Assignments via DHCP | Adversaries push malicious DNS servers via DHCP to redirect traffic, as in IoT attacks.<grok:render type="render_inline_citation"><argument name="citation_id">35</argument></grok:render> | - DHCP Packet Data (Zeek DHCP logs)<br>- Client DNS Configs | - **Splunk**: `index=network sourcetype=zeek_dhcp dns_server NOT IN (corporate_dns) AND type="DHCPACK" \| stats count by src_ip, dns_server \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DHCP" and AdditionalFields.Type == "DHCPACK" and AdditionalFields.DnsServer !in (corporateDns) \| summarize count() by RemoteIP, AdditionalFields.DnsServer \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.dhcp-* \| WHERE dhcp.type = 'DHCPACK' AND dhcp.dns_server NOT IN ['8.8.8.8'] \| STATS COUNT() BY source.ip, dhcp.dns_server HAVING COUNT() > 5`. |
| 4. Rapid DHCP Request Floods | Adversaries flood DHCP requests to exhaust IP pools or cover spoofing, as in denial-of-service precursors.<grok:render type="render_inline_citation"><argument name="citation_id">35</argument></grok:render> | - DHCP Traffic (Zeek DHCP logs)<br>- Network Flow Metrics | - **Splunk**: `index=network sourcetype=zeek_dhcp type="DHCPREQUEST" \| timechart span=1m count by src_mac \| where count > avg(count)*4`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DHCP" and AdditionalFields.Type == "DHCPREQUEST" \| summarize MinutelyCount=count() by bin(Timestamp, 1m), DeviceMac \| where MinutelyCount > avg(MinutelyCount) * 4`.<br>- **ELK**: `FROM logs-zeek.dhcp-* \| WHERE dhcp.type = 'DHCPREQUEST' \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.mac \| WHERE COUNT() > AVG(COUNT()) * 4`. |
| 5. DHCP Spoofing Tool Execution | Adversaries run tools like `dhcpstarv` or `Yersinia` for spoofing, detectable on endpoints.<grok:render type="render_inline_citation"><argument name="citation_id">35</argument></grok:render> Hunt in Linux/Windows endpoints. | - Process Creation (Sysmon ID 1)<br>- Command Execution Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*dhcpstarv*", "*yersinia*") OR CommandLine="*dhcp*" \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("dhcpstarv", "yersinia") or ProcessCommandLine contains "dhcp" \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("dhcpstarv" OR "yersinia") OR process.args : "*dhcp*" \| TABLE @timestamp, host.name, process.command_line`. |
| 6. Traffic Redirection Post-DHCP Spoofing | Post-spoofing, traffic is redirected to malicious gateways, indicating MitM setup.<grok:render type="render_inline_citation"><argument name="citation_id">35</argument></grok:render> | - Network Traffic (Zeek conn logs)<br>- Gateway Configs | - **Splunk**: `index=network sourcetype=zeek_conn dest_ip NOT IN (known_gateways) AND proto="udp" AND service="dhcp" \| stats count by src_ip, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteIP !in (knownGateways) and Protocol == "udp" and Service == "dhcp" \| summarize count() by DeviceIP, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE destination.ip NOT IN ['192.168.1.1'] AND protocol = 'udp' AND service = 'dhcp' \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 10`. |
| 7. DHCP Spoofing Correlated with ARP Poisoning | Spoofed DHCP paired with ARP poisoning for MitM, as in advanced APT attacks.<grok:render type="render_inline_citation"><argument name="citation_id">35</argument></grok:render> | - ARP Traffic (Zeek ARP logs)<br>- DHCP Logs | - **Splunk**: `index=network sourcetype=zeek_dhcp type="DHCPACK" \| join src_ip [search sourcetype=zeek_arp "spoof"] \| stats count by src_ip \| where count > 3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DHCP" and AdditionalFields.Type == "DHCPACK" \| join kind=inner (DeviceNetworkEvents \| where Protocol == "ARP" and AdditionalFields.Action == "spoof") on RemoteIP \| summarize count() by RemoteIP \| where count_ > 3`.<br>- **ELK**: `FROM logs-zeek.dhcp-* \| WHERE dhcp.type = 'DHCPACK' \| JOIN logs-zeek.arp-* ON source.ip WHERE arp.action = 'spoof' \| STATS COUNT() BY source.ip HAVING COUNT() > 3`. |
| 8. Unauthorized DHCP Server Configuration Changes | Adversaries modify DHCP server configs to serve malicious IPs, as in network compromises.<grok:render type="render_inline_citation"><argument name="citation_id">35</argument></grok:render> | - File Modifications (Sysmon ID 11 for DHCP configs)<br>- Server Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename IN ("*dhcpd.conf", "*dhcp-config*") AND ProcessImage NOT IN (admin_tools) \| stats count by TargetFilename, host \| where count > 2`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileModified" and FileName has_any ("dhcpd.conf", "dhcp-config") and not(InitiatingProcessFolderPath in~ (adminTools)) \| summarize count() by FileName, DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'modification' AND file.name : ("*dhcpd.conf" OR "*dhcp-config*") AND process.name NOT IN ['dhcpd'] \| STATS COUNT() BY file.name, host.name HAVING COUNT() > 2`. |
| 9. DHCP Spoofing in IoT Devices | Rogue DHCP responses from compromised IoT devices, common in Mirai-like attacks.<grok:render type="render_inline_citation"><argument name="citation_id">35</argument></grok:render> | - Device Logs (IoT telemetry)<br>- Network Traffic (Zeek DHCP) | - **Splunk**: `index=iot sourcetype=zeek_dhcp type="DHCPOFFER" AND src_ip IN (iot_device_ips) \| stats count by src_ip, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DHCP" and AdditionalFields.Type == "DHCPOFFER" and RemoteIP in (iotDeviceIps) \| summarize count() by RemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.dhcp-* \| WHERE dhcp.type = 'DHCPOFFER' AND source.ip IN ['iot_ips'] \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 5`. |
| 10. DNS Query Anomalies Post-DHCP Spoofing | Clients query malicious DNS servers assigned via spoofed DHCP, indicating redirection.<grok:render type="render_inline_citation"><argument name="citation_id">35</argument></grok:render> | - DNS Logs (Zeek DNS logs)<br>- DHCP Lease Data | - **Splunk**: `index=network sourcetype=zeek_dns query NOT IN (corporate_domains) AND src_ip IN (dhcp_assigned_ips) \| stats count by src_ip, query \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and AdditionalFields.Query !in (corporateDomains) and DeviceIP in (dhcpAssignedIps) \| summarize count() by DeviceIP, AdditionalFields.Query \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE dns.query NOT IN ['corp.com'] AND source.ip IN ['dhcp_ips'] \| STATS COUNT() BY source.ip, dns.query HAVING COUNT() > 10`. |
| 11. DHCP Spoofing from Compromised Containers | Adversaries run DHCP spoofing tools in Kubernetes/Docker pods.<grok:render type="render_inline_citation"><argument name="citation_id">35</argument></grok:render> | - Container Logs (K8s events)<br>- Process Execution | - **Splunk**: `index=container sourcetype=k8s:events "exec" Command="*dhcp*" \| stats count by pod_name \| where count > 3`.<br>- **KQL**: `KubeEvents \| where Verb == "exec" and Message contains "dhcp" \| summarize count() by ObjectRef.name \| where count_ > 3`.<br>- **ELK**: `FROM logs-kubernetes.events-* \| WHERE kubernetes.event.verb = 'exec' AND message : '*dhcp*' \| STATS COUNT() BY kubernetes.pod.name HAVING COUNT() > 3`. |
| 12. High DHCP Lease Renewal Rates | Clients rapidly renewing leases, indicating spoofed server interference.<grok:render type="render_inline_citation"><argument name="citation_id">35</argument></grok:render> | - DHCP Server Logs<br>- Client Lease Events | - **Splunk**: `index=dhcp sourcetype=dhcp:server lease_renewed \| timechart span=1m count by client_mac \| where count > avg(count)*3`.<br>- **KQL**: `DhcpLogs \| where Action == "lease_renewed" \| summarize MinutelyCount=count() by bin(Timestamp, 1m), ClientMac \| where MinutelyCount > avg(MinutelyCount) * 3`.<br>- **ELK**: `FROM logs-dhcp.server-* \| WHERE event.action = 'lease_renewed' \| STATS COUNT() BY date_histogram(@timestamp, '1m'), client.mac \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 13. DHCP Spoofing with Malicious Gateway Configs | Spoofed DHCP assigns malicious gateways, enabling MitM.<grok:render type="render_inline_citation"><argument name="citation_id">35</argument></grok:render> | - DHCP Packet Data (Zeek DHCP logs)<br>- Network Configs | - **Splunk**: `index=network sourcetype=zeek_dhcp type="DHCPACK" AND gateway NOT IN (known_gateways) \| stats count by src_ip, gateway \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DHCP" and AdditionalFields.Type == "DHCPACK" and AdditionalFields.Gateway !in (knownGateways) \| summarize count() by RemoteIP, AdditionalFields.Gateway \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.dhcp-* \| WHERE dhcp.type = 'DHCPACK' AND dhcp.gateway NOT IN ['192.168.1.1'] \| STATS COUNT() BY source.ip, dhcp.gateway HAVING COUNT() > 5`. |
| 14. DHCP Spoofing Correlated with Network Scanning | DHCP spoofing paired with scanning tools (e.g., nmap) for network recon.<grok:render type="render_inline_citation"><argument name="citation_id">35</argument></grok:render> | - Network Traffic (Zeek conn logs)<br>- Process Execution (Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_dhcp type="DHCPOFFER" \| join src_ip [search sourcetype=sysmon EventCode=1 "*nmap*"] \| stats count by src_ip \| where count > 2`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DHCP" and AdditionalFields.Type == "DHCPOFFER" \| join kind=inner (DeviceProcessEvents \| where ProcessCommandLine contains "nmap") on RemoteIP \| summarize count() by RemoteIP \| where count_ > 2`.<br>- **ELK**: `FROM logs-zeek.dhcp-* \| WHERE dhcp.type = 'DHCPOFFER' \| JOIN logs-endpoint.process-* ON source.ip WHERE process.args : '*nmap*' \| STATS COUNT() BY source.ip HAVING COUNT() > 2`. |
| 15. DHCP Spoofing in Cloud Network Environments | Adversaries spoof DHCP in cloud VPCs to redirect traffic, rare but possible in misconfigured AWS/Azure.<grok:render type="render_inline_citation"><argument name="citation_id">35</argument></grok:render> | - Cloud Network Logs (AWS VPC Flow Logs)<br>- DHCP Traffic | - **Splunk**: `index=cloud sourcetype=aws:flowlogs protocol=17 AND src_ip NOT IN (dhcp_servers) AND port=67 \| stats count by src_ip, dst_ip \| where count > 10`.<br>- **KQL**: `AWSFlowLogs \| where Protocol == 17 and SourceIP !in (dhcpServers) and DestinationPort == 67 \| summarize count() by SourceIP, DestinationIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.flowlogs-* \| WHERE protocol = 17 AND source.ip NOT IN ['dhcp_server'] AND destination.port = 67 \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 10`. |


### Data Staged

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Staging in Temporary Directories | Adversaries stage collected data in temporary directories like %TEMP% or /tmp before exfiltration, as observed in campaigns using WinRAR for compression. High risk in Windows/Linux endpoints with unmonitored temp folders. | - File Creation/Modification (e.g., Sysmon Event ID 11)<br>- Endpoint File System Changes | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 \| search TargetFilename IN ("*\\Temp\\*", "*/tmp/*") AND (file_extension IN (".zip", ".rar", ".tar") OR size > 1000000) \| stats count by TargetFilename, host \| where count > 5` (Detects large or archived files in temp dirs).<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FolderPath has_any ("Temp", "tmp") and (FileName endswith_any (".zip", ".rar", ".tar") or FileSize > 1000000) \| summarize count() by FileName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events.file-* \| WHERE event.action = "creation" AND file.path : ("*Temp*" OR "*tmp*") AND (file.extension IN ['zip', 'rar', 'tar'] OR file.size > 1000000) \| STATS COUNT() BY file.name, host.name HAVING COUNT() > 5`. |
| 2. Use of Archiving Tools for Staging | Adversaries use tools like WinRAR or PowerShell Compress-Archive to stage data, as in CISA-reported incidents. Common in Windows for combining files. | - Process Creation (e.g., Sysmon ID 1)<br>- Command Execution Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search Image IN ("*rar.exe*", "*7z.exe*") OR CommandLine="*Compress-Archive*" \| stats count by host, CommandLine \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("rar.exe", "7z.exe") or ProcessCommandLine contains "Compress-Archive" \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("rar.exe" OR "7z.exe") OR process.args : "*Compress-Archive*" \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 3`. |
| 3. Staging in User Profile Directories | Data staged in user profiles (e.g., AppData, .local) for evasion, as per MITRE ATT&CK descriptions. | - File Creation (Sysmon ID 11)<br>- Directory Changes | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename IN ("*AppData\\*", "*.local/*") AND mvcount(TargetFilename) > 10 \| stats values(TargetFilename) by host`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FolderPath has_any ("AppData", ".local") \| summarize Files=make_set(FileName) by DeviceName \| where array_length(Files) > 10`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'creation' AND file.path : ("*AppData*" OR "*.local*") \| STATS SET(file.name) BY host.name HAVING CARDINALITY(file.name) > 10`. |
| 4. Remote Staging in Cloud Storage | Adversaries stage data in cloud buckets (e.g., S3, Azure Blob) before exfil, as in remote data staging sub-technique. | - Cloud Audit Logs (AWS CloudTrail, Azure Activity)<br>- Storage Access Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="PutObject" AND bucket_name NOT IN (approved_buckets) \| stats count by userIdentity, bucket_name \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "PutObject" and ResourceId !in (approvedBuckets) \| summarize count() by Caller, ResourceId \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'PutObject' AND s3.bucket NOT IN ['approved_bucket'] \| STATS COUNT() BY user.identity, s3.bucket HAVING COUNT() > 10`. |
| 5. Staging Followed by Exfiltration Indicators | Staging commands correlated with outbound network traffic, as in exfiltration prep. | - Process Network (Sysmon ID 3)<br>- File Creation (ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename="*staging*" \| transaction ProcessGuid maxspan=5m [search EventCode=3 DestinationPort=443] \| where eventcount > 1 \| table _time, DestinationIp`.<br>- **KQL**: `DeviceFileEvents \| where FileName contains "staging" \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 443) on ProcessId \| project Timestamp, RemoteIP`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : "*staging*" \| JOIN logs-endpoint.network-* ON process.pid WHERE destination.port = 443 \| TABLE @timestamp, destination.ip`. |
| 6. Multiple Files Combined into Archives | Adversaries combine files into archives for staging, as described in MITRE ATT&CK. | - Process Creation (Sysmon ID 1 for archiving tools)<br>- File Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*rar a*" OR "*zip*" AND Path="*staging*" \| stats count by host, CommandLine \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("rar a", "zip") and FolderPath contains "staging" \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : ("*rar*a*" OR "*zip*") AND file.path : "*staging*" \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 3`. |
| 7. Staging in Recycle Bin or Hidden Folders | Data staged in hidden locations like Recycle Bin for evasion, as per ATT&CK examples. | - File Creation (Sysmon ID 11)<br>- Attribute Changes | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename IN ("*\\Recycle.Bin\\*", "*.hidden*") \| stats count by TargetFilename, host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FolderPath has_any ("Recycle.Bin", ".hidden") \| summarize count() by FileName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'creation' AND file.path : ("*Recycle.Bin*" OR "*.hidden*") \| STATS COUNT() BY file.name, host.name HAVING COUNT() > 5`. |
| 8. Remote Staging via SMB Shares | Data staged on remote shares before exfil, as in T1074.002. | - Network File Access (Sysmon ID 3 for SMB)<br>- Share Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=3 Protocol="smb" AND DestinationHostname NOT IN (known_servers) \| stats count by host, DestinationHostname \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "SMB" and RemoteDeviceName !in (knownServers) \| summarize count() by DeviceName, RemoteDeviceName \| where count_ > 10`.<br>- **ELK**: `FROM logs-endpoint.network-* \| WHERE protocol = 'SMB' AND destination.hostname NOT IN ['known_server'] \| STATS COUNT() BY host.name, destination.hostname HAVING COUNT() > 10`. |
| 9. Staging Volume Spikes | Sudden increase in files or data size in staging locations, indicating bulk collection. | - File Metrics (EDR aggregate)<br>- Directory Stats | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 Path="*staging*" \| timechart span=1h count \| where count > avg(count)*3`.<br>- **KQL**: `DeviceFileEvents \| where FolderPath contains "staging" \| summarize HourlyCount=count() by bin(Timestamp, 1h) \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.path : "*staging*" \| STATS COUNT() BY date_histogram(@timestamp, '1h') \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 10. Staging in Cloud Databases | Data staged in cloud DBs (e.g., Azure Cosmos DB) before exfil, as in remote staging. | - Cloud DB Logs (Azure Cosmos DB diagnostics)<br>- Insert Operations | - **Splunk**: `index=cloud sourcetype=azure:cosmosdb operation="insert" AND collection NOT IN (approved) \| stats count by user, collection \| where count > 20`.<br>- **KQL**: `AzureDiagnostics \| where OperationName == "insert" and Collection !in (approvedCollections) \| summarize count() by Caller, Collection \| where count_ > 20`.<br>- **ELK**: `FROM logs-azure.cosmosdb-* \| WHERE event.operation = 'insert' AND collection.name NOT IN ['approved'] \| STATS COUNT() BY user.name, collection.name HAVING COUNT() > 20`. |
| 11. Encryption of Staged Data | Adversaries encrypt staged data for evasion, correlated with staging. | - Process Creation (Sysmon ID 1 for encrypt tools)<br>- File Changes | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*encrypt*" AND Path="*staging*" \| stats count by host, CommandLine \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "encrypt" and FolderPath contains "staging" \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : "*encrypt*" AND file.path : "*staging*" \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 2`. |
| 12. Staging from Multiple Systems | Data from multiple hosts staged on one system, as in T1074.002. | - Network File Transfers (Sysmon ID 3)<br>- File Origins | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=3 Protocol="smb" AND DestinationPort=445 AND mvcount(SourceHostname) > 5 \| stats values(SourceHostname) by host`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "SMB" and RemotePort == 445 \| summarize Sources=make_set(DeviceName) by DeviceName \| where array_length(Sources) > 5`.<br>- **ELK**: `FROM logs-endpoint.network-* \| WHERE protocol = 'SMB' AND destination.port = 445 \| STATS SET(source.hostname) BY host.name HAVING CARDINALITY(source.hostname) > 5`. |
| 13. Staging Correlated with Collection Techniques | Staging after data collection (e.g., from clipboard), as in chained behaviors. | - Multi-Event Correlation (Sysmon IDs 1, 11) | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=1 "*clipboard*") \| transaction host maxspan=10m [search EventCode=11 "*staging*"] \| where eventcount > 1 \| table _time, host`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "clipboard" \| join kind=inner (DeviceFileEvents \| where FolderPath contains "staging") on DeviceName \| project Timestamp, DeviceName`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : "*clipboard*" \| JOIN logs-endpoint.file-* ON host.name WHERE file.path : "*staging*" \| TABLE @timestamp, host.name`. |
| 14. Staging in Linux /proc or /dev | Data staged in volatile memory locations like /proc for evasion on Linux. | - File Access (auditd openat)<br>- System Calls | - **Splunk**: `index=endpoint sourcetype=auditd syscall="openat" path IN ("/proc/*", "/dev/shm/*") AND NOT exe IN (legit_tools) \| stats count by exe, path \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileOpened" and FolderPath has_any ("/proc", "/dev/shm") and not(InitiatingProcessFolderPath in~ (legitTools)) \| summarize count() by InitiatingProcessFolderPath, FolderPath \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE syscall.name = 'openat' AND file.path : ("/proc/*" OR "/dev/shm/*") AND process.exe NOT IN ['systemd'] \| STATS COUNT() BY process.exe, file.path HAVING COUNT() > 5`. |
| 15. Post-Staging Cleanup Attempts | Adversaries delete staged files after exfil, leaving traces in logs. | - File Deletion (Sysmon ID 23)<br>- Command Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=23 TargetFilename="*staging*" \| stats count by host, TargetFilename \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileDeleted" and FolderPath contains "staging" \| summarize count() by DeviceName, FileName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'deletion' AND file.path : "*staging*" \| STATS COUNT() BY host.name, file.name HAVING COUNT() > 3`.


### Data from Cloud Storage

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Unauthorized Access to Cloud Storage Buckets | Adversaries access S3/Azure Blob buckets using stolen credentials or misconfigured IAM roles, as in TeamTNT campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">40</argument></grok:render> High risk in public or overly permissive buckets. | - Cloud Audit Logs (e.g., AWS CloudTrail, Azure Activity)<br>- IAM Authentication Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("GetObject", "ListObjects") AND userIdentity NOT IN (authorized_users) \| stats count by userIdentity, bucketName \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("GetObject", "ListObjects") and Caller !in (authorizedUsers) \| summarize count() by Caller, ResourceId \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['GetObject', 'ListObjects'] AND user.identity NOT IN ['admin'] \| STATS COUNT() BY user.identity, s3.bucket HAVING COUNT() > 10`. |
| 2. Bulk Data Downloads from Cloud Storage | Adversaries perform large-scale downloads from buckets, indicating data exfiltration, as in UNC2452 attacks.<grok:render type="render_inline_citation"><argument name="citation_id">40</argument></grok:render> | - Cloud Storage Logs (e.g., S3 Access Logs, Azure Blob Logs)<br>- Network Traffic (Zeek) | - **Splunk**: `index=cloud sourcetype=aws:s3:access requestType="GET" AND bytes > 1000000 \| stats sum(bytes) by src_ip, bucketName \| where sum_bytes > 10000000`.<br>- **KQL**: `S3AccessLogs \| where RequestType == "GET" and Bytes > 1000000 \| summarize TotalBytes=sum(Bytes) by SourceIP, BucketName \| where TotalBytes > 10000000`.<br>- **ELK**: `FROM logs-aws.s3.access-* \| WHERE http.method = 'GET' AND bytes > 1000000 \| STATS SUM(bytes) BY source.ip, s3.bucket HAVING SUM(bytes) > 10000000`. |
| 3. Anomalous Authentication to Cloud Storage APIs | Unauthorized logins to cloud storage APIs from non-corporate IPs, as in credential stuffing attacks.<grok:render type="render_inline_citation"><argument name="citation_id">40</argument></grok:render> | - Authentication Logs (e.g., Azure AD Sign-ins, AWS IAM)<br>- Identity Provider Logs | - **Splunk**: `index=security sourcetype=azure:ad:signin AppDisplayName IN ("AWS S3", "Azure Blob Storage") AND IPAddress NOT IN (corporate_ranges) \| stats count by UserPrincipalName, IPAddress \| where count > 5`.<br>- **KQL**: `SigninLogs \| where AppDisplayName in ("AWS S3", "Azure Blob Storage") and IPAddress !in (corporateRanges) \| summarize count() by UserPrincipalName, IPAddress \| where count_ > 5`.<br>- **ELK**: `FROM logs-azure.signin-* \| WHERE app.name IN ['AWS S3', 'Azure Blob Storage'] AND source.ip NOT IN ['10.0.0.0/8'] \| STATS COUNT() BY user.name, source.ip HAVING COUNT() > 5`. |
| 4. Suspicious API Calls from Compromised Instances | Adversaries use compromised cloud instances (e.g., EC2, Azure VMs) to query storage APIs, as in TeamTNT.<grok:render type="render_inline_citation"><argument name="citation_id">40</argument></grok:render> | - Cloud Audit Logs (AWS CloudTrail, Azure Activity)<br>- Instance Metadata | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("GetObject", "ListObjects") AND sourceIPAddress IN (ec2_instances) AND userAgent NOT IN (known_tools) \| stats count by sourceIPAddress, bucketName \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("GetObject", "ListObjects") and SourceIPAddress in (ec2Instances) and UserAgent !in (knownTools) \| summarize count() by SourceIPAddress, ResourceId \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['GetObject', 'ListObjects'] AND source.ip IN ['ec2_ips'] AND user.agent NOT IN ['aws-cli'] \| STATS COUNT() BY source.ip, s3.bucket HAVING COUNT() > 10`. |
| 5. Data Staging in Cloud Storage Before Exfiltration | Adversaries stage stolen data in intermediate buckets before exfil, as in remote staging.<grok:render type="render_inline_citation"><argument name="citation_id">40</argument></grok:render> | - Cloud Storage Logs (S3 PutObject, Azure Blob Writes)<br>- File Creation Events | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="PutObject" AND bucketName IN ("*staging*", "*temp*") \| stats count by userIdentity, bucketName \| where count > 15`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "PutObject" and ResourceId has_any ("staging", "temp") \| summarize count() by Caller, ResourceId \| where count_ > 15`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'PutObject' AND s3.bucket : ("*staging*" OR "*temp*") \| STATS COUNT() BY user.identity, s3.bucket HAVING COUNT() > 15`. |
| 6. Misconfigured Bucket Access by External Entities | Public or overly permissive buckets accessed by unknown IPs, as in misconfiguration exploits.<grok:render type="render_inline_citation"><argument name="citation_id">40</argument></grok:render> | - Cloud Storage Access Logs<br>- Bucket Policy Changes | - **Splunk**: `index=cloud sourcetype=aws:s3:access requestType="GET" AND src_ip NOT IN (corporate_ips) AND bucket_policy="public" \| stats count by src_ip, bucketName \| where count > 10`.<br>- **KQL**: `S3AccessLogs \| where RequestType == "GET" and SourceIP !in (corporateIps) and BucketPolicy == "public" \| summarize count() by SourceIP, BucketName \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.s3.access-* \| WHERE http.method = 'GET' AND source.ip NOT IN ['corporate_ips'] AND s3.bucket.policy = 'public' \| STATS COUNT() BY source.ip, s3.bucket HAVING COUNT() > 10`. |
| 7. Cloud Storage Access via Stolen API Keys | Adversaries use stolen API keys for unauthorized access, as in UNC2452.<grok:render type="render_inline_citation"><argument name="citation_id">40</argument></grok:render> | - Cloud Audit Logs (AWS IAM, Azure Activity)<br>- API Key Usage | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("GetObject", "ListObjects") AND accessKeyId NOT IN (known_keys) \| stats count by accessKeyId, bucketName \| where count > 5`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("GetObject", "ListObjects") and AccessKeyId !in (knownKeys) \| summarize count() by AccessKeyId, ResourceId \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['GetObject', 'ListObjects'] AND aws.access_key NOT IN ['known_key'] \| STATS COUNT() BY aws.access_key, s3.bucket HAVING COUNT() > 5`. |
| 8. Correlated Phishing and Cloud Storage Access | Phishing campaigns lead to cloud storage access via stolen credentials, as in Scattered Spider.<grok:render type="render_inline_citation"><argument name="citation_id">40</argument></grok:render> | - Email Logs (Phishing Detections)<br>- Cloud Audit Logs | - **Splunk**: `index=email sourcetype=phish_log "malicious link" \| join user [search sourcetype=aws:cloudtrail eventName="GetObject"] \| stats count by user, bucketName \| where count > 1`.<br>- **KQL**: `PhishLogs \| where Description contains "malicious link" \| join kind=inner (AWSCloudTrail \| where EventName == "GetObject") on Caller \| summarize count() by Caller, ResourceId \| where count_ > 1`.<br>- **ELK**: `FROM logs-phish-* \| WHERE message : "*malicious*link*" \| JOIN logs-aws.cloudtrail-* ON user.identity WHERE event.action = 'GetObject' \| STATS COUNT() BY user.identity, s3.bucket HAVING COUNT() > 1`. |
| 9. High-Frequency Storage API Calls | Spikes in API calls (e.g., GetObject) indicating automated exfiltration.<grok:render type="render_inline_citation"><argument name="citation_id">40</argument></grok:render> | - Cloud Audit Logs (CloudTrail, Azure Activity)<br>- API Metrics | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="GetObject" \| timechart span=1h count by userIdentity \| where count > avg(count)*4`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "GetObject" \| summarize HourlyCount=count() by bin(Timestamp, 1h), Caller \| where HourlyCount > avg(HourlyCount) * 4`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'GetObject' \| STATS COUNT() BY date_histogram(@timestamp, '1h'), user.identity \| WHERE COUNT() > AVG(COUNT()) * 4`. |
| 10. Data Access from Compromised Containers | Adversaries run storage access commands from Kubernetes/Docker pods, as in TeamTNT.<grok:render type="render_inline_citation"><argument name="citation_id">40</argument></grok:render> | - Container Logs (K8s events)<br>- Cloud Audit Logs | - **Splunk**: `index=container sourcetype=k8s:events "exec" Command="*aws s3*" OR "*az storage*" \| stats count by pod_name \| where count > 3`.<br>- **KQL**: `KubeEvents \| where Verb == "exec" and Message has_any ("aws s3", "az storage") \| summarize count() by ObjectRef.name \| where count_ > 3`.<br>- **ELK**: `FROM logs-kubernetes.events-* \| WHERE kubernetes.event.verb = 'exec' AND message : ('*aws*s3*' OR '*az*storage*') \| STATS COUNT() BY kubernetes.pod.name HAVING COUNT() > 3`. |
| 11. Suspicious Bucket Policy Modifications | Adversaries modify bucket policies to enable public access, as in misconfiguration attacks.<grok:render type="render_inline_citation"><argument name="citation_id">40</argument></grok:render> | - Cloud Audit Logs (CloudTrail PutBucketPolicy)<br>- Policy Change Events | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="PutBucketPolicy" AND policy="*Effect:Allow,Principal:*" \| stats count by userIdentity, bucketName \| where count > 1`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "PutBucketPolicy" and AdditionalFields.Policy contains "Effect:Allow,Principal:*" \| summarize count() by Caller, ResourceId \| where count_ > 1`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'PutBucketPolicy' AND policy.text : "*Effect:Allow,Principal:*" \| STATS COUNT() BY user.identity, s3.bucket HAVING COUNT() > 1`. |
| 12. Data Exfiltration via External IPs | Data from cloud storage sent to external IPs, indicating exfil.<grok:render type="render_inline_citation"><argument name="citation_id">40</argument></grok:render> | - Network Traffic (Zeek file transfers)<br>- Cloud Storage Logs | - **Splunk**: `index=network sourcetype=zeek_file mime_type IN ("application/octet-stream") AND url="*s3.amazonaws.com*" AND dest_ip NOT IN (corporate_ips) \| stats count by src_ip, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.MimeType == "application/octet-stream" and RemoteUrl contains "s3.amazonaws.com" and RemoteIP !in (corporateIps) \| summarize count() by DeviceIP, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.file-* \| WHERE file.mime_type = 'application/octet-stream' AND http.url : "*s3.amazonaws.com*" AND destination.ip NOT IN ['corporate_ips'] \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 5`. |
| 13. Unauthorized Access to Encrypted Buckets | Adversaries access encrypted buckets using stolen KMS keys, as in advanced APTs.<grok:render type="render_inline_citation"><argument name="citation_id">40</argument></grok:render> | - KMS Audit Logs (AWS CloudTrail KMS)<br>- Storage Access Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("Decrypt", "GetObject") AND kms_key_id NOT IN (approved_keys) \| stats count by userIdentity, bucketName \| where count > 5`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("Decrypt", "GetObject") and KmsKeyId !in (approvedKeys) \| summarize count() by Caller, ResourceId \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['Decrypt', 'GetObject'] AND kms.key.id NOT IN ['approved_key'] \| STATS COUNT() BY user.identity, s3.bucket HAVING COUNT() > 5`. |
| 14. Suspicious Storage Access from Non-Standard Tools | Adversaries use non-standard tools (e.g., curl, custom scripts) to access cloud storage.<grok:render type="render_inline_citation"><argument name="citation_id">40</argument></grok:render> | - Process Creation (Sysmon ID 1)<br>- Network Traffic (Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*curl.exe*", "*wget*") AND CommandLine="*s3.amazonaws.com*" \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("curl.exe", "wget") and ProcessCommandLine contains "s3.amazonaws.com" \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("curl.exe" OR "wget") AND process.args : "*s3.amazonaws.com*" \| TABLE @timestamp, host.name, process.command_line`. |
| 15. Data Access Correlated with Phishing | Phishing campaigns lead to cloud storage access via stolen creds, as in Scattered Spider.<grok:render type="render_inline_citation"><argument name="citation_id">40</argument></grok:render> | - Email Logs (Phishing Detections)<br>- Cloud Audit Logs | - **Splunk**: `index=email sourcetype=phish_log "malicious link" \| join user [search sourcetype=azure:activity OperationName="BlobRead"] \| stats count by user, blobName \| where count > 1`.<br>- **KQL**: `PhishLogs \| where Description contains "malicious link" \| join kind=inner (AzureActivity \| where OperationNameValue == "BlobRead") on Caller \| summarize count() by Caller, ResourceId \| where count_ > 1`.<br>- **ELK**: `FROM logs-phish-* \| WHERE message : "*malicious*link*" \| JOIN logs-azure.activity-* ON user.name WHERE event.action = 'BlobRead' \| STATS COUNT() BY user.name, blob.name HAVING COUNT() > 1`. |


### Data from Configuration Repository

Adversaries may collect data related to managed devices from configuration repositories, such as those used by management systems like SCCM, Puppet, Ansible, or cloud services like AWS SSM, to obtain information on network infrastructure, credentials, or device configurations. This technique has been observed in attacks like those by APT41 (using custom tools to dump data from Tanium servers) and in cloud misconfigurations exploited by groups like TeamTNT. Hypotheses are tailored for environments with endpoint logging, cloud audits, and network monitoring, focusing on unauthorized access, data dumps, and anomalous queries. In low-visibility setups, prioritize file access and process monitoring.

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Unauthorized Access to Configuration Repository APIs | Adversaries query config repo APIs (e.g., Puppet master, Ansible Tower) using stolen creds, as in APT41's Tanium dumps. High risk in hybrid cloud setups. | - API Access Logs (e.g., Puppet/Ansible audits)<br>- Cloud Audit Logs (AWS CloudTrail for SSM) | - **Splunk**: `index=config_repo sourcetype=puppet:audit action IN ("node_query", "fact_query") AND user NOT IN (authorized_users) \| stats count by user, node \| where count > 5`.<br>- **KQL**: `PuppetAuditLogs \| where Action in ("node_query", "fact_query") and User !in (authorizedUsers) \| summarize count() by User, Node \| where count_ > 5`.<br>- **ELK**: `FROM logs-puppet.audit-* \| WHERE event.action IN ['node_query', 'fact_query'] AND user.name NOT IN ['admin'] \| STATS COUNT() BY user.name, node.name HAVING COUNT() > 5`. |
| 2. Anomalous Configuration File Access | Adversaries access config files (e.g., /etc/puppetlabs, Ansible playbooks) from unexpected processes. Hunt in Linux servers. | - File Access Logs (auditd openat)<br>- Sysmon ID 11 | - **Splunk**: `index=endpoint sourcetype=auditd syscall="openat" path IN ("/etc/puppetlabs/*", "/etc/ansible/*") AND NOT exe IN (puppet_tools) \| stats count by exe, path \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileOpened" and FolderPath has_any ("/etc/puppetlabs", "/etc/ansible") and not(InitiatingProcessFolderPath in~ (puppetTools)) \| summarize count() by InitiatingProcessFolderPath, FolderPath \| where count_ > 3`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE syscall.name = 'openat' AND file.path : ("/etc/puppetlabs/*" OR "/etc/ansible/*") AND process.exe NOT IN ['puppet'] \| STATS COUNT() BY process.exe, file.path HAVING COUNT() > 3`. |
| 3. Bulk Data Dumps from Config Repos | Adversaries dump large volumes of config data (e.g., via custom tools), as in APT41. | - Process Execution (Sysmon ID 1 for dump tools)<br>- File Creation (ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*dump config*", "*export repo*") \| stats count by host, CommandLine \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("dump config", "export repo") \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : ("*dump*config*" OR "*export*repo*") \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 3`. |
| 4. Cloud Config Service Misuse | Adversaries query cloud config services like AWS SSM or Azure App Configuration with stolen roles. | - Cloud Audit Logs (AWS CloudTrail, Azure Activity)<br>- Parameter Store Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("GetParameter", "GetParameters") AND userIdentity NOT IN (authorized) \| stats count by userIdentity, parameterName \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("GetParameter", "GetParameters") and Caller !in (authorizedUsers) \| summarize count() by Caller, ParameterName \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['GetParameter', 'GetParameters'] AND user.identity NOT IN ['admin'] \| STATS COUNT() BY user.identity, parameter.name HAVING COUNT() > 10`. |
| 5. Config Repo Access from Compromised Endpoints | Adversaries access repos from unusual endpoints, indicating lateral movement. | - Network Traffic (Zeek HTTP for repo URLs)<br>- Endpoint Process Logs | - **Splunk**: `index=network sourcetype=zeek_http uri IN ("*puppetmaster*", "*ansible-tower*") AND src_ip NOT IN (known_endpoints) \| stats count by src_ip, uri \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteUrl has_any ("puppetmaster", "ansible-tower") and RemoteIP !in (knownEndpoints) \| summarize count() by RemoteIP, RemoteUrl \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri : ("*puppetmaster*" OR "*ansible-tower*") AND source.ip NOT IN ['known_ips'] \| STATS COUNT() BY source.ip, http.uri HAVING COUNT() > 5`. |
| 6. Anomalous Config Query Patterns | High-frequency queries to config repos, suggesting automated dumping. | - API Logs (Puppet/Ansible query logs)<br>- Usage Metrics | - **Splunk**: `index=config_repo sourcetype=ansible:audit action="query" \| timechart span=1h count by user \| where count > avg(count)*4`.<br>- **KQL**: `AnsibleAuditLogs \| where Action == "query" \| summarize HourlyCount=count() by bin(Timestamp, 1h), User \| where HourlyCount > avg(HourlyCount) * 4`.<br>- **ELK**: `FROM logs-ansible.audit-* \| WHERE event.action = 'query' \| STATS COUNT() BY date_histogram(@timestamp, '1h'), user.name \| WHERE COUNT() > AVG(COUNT()) * 4`. |
| 7. Credential Extraction from Config Files | Adversaries extract creds from config files (e.g., ansible-vault), as in post-compromise. | - File Access (Sysmon ID 11)<br>- Command Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename="*ansible-vault*" OR "*puppet-vars*" \| stats count by TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileAccessed" and FileName has_any ("ansible-vault", "puppet-vars") \| summarize count() by FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'access' AND file.name : ("*ansible-vault*" OR "*puppet-vars*") \| STATS COUNT() BY file.name, host.name HAVING COUNT() > 3`. |
| 8. Config Repo Access Correlated with Lateral Movement | Config access after lateral movement (e.g., PsExec), indicating reconnaissance. | - Process Creation (Sysmon ID 1 for PsExec)<br>- Repo Access Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 "*psexec*" \| transaction host maxspan=5m [search sourcetype=puppet:audit "query"] \| where eventcount > 1 \| table _time, host`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "psexec" \| join kind=inner (PuppetAuditLogs \| where Action == "query") on DeviceName \| project Timestamp, DeviceName`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : "*psexec*" \| JOIN logs-puppet.audit-* ON host.name WHERE event.action = 'query' \| TABLE @timestamp, host.name`. |
| 9. Unauthorized Config Repo Backups or Exports | Adversaries export full configs (e.g., Puppet DB dumps), as in data theft. | - Export Logs (Puppet/Ansible backups)<br>- File Creation | - **Splunk**: `index=config_repo sourcetype=puppet:audit action="export" AND user NOT IN (authorized) \| stats count by user, export_type \| where count > 2`.<br>- **KQL**: `PuppetAuditLogs \| where Action == "export" and User !in (authorizedUsers) \| summarize count() by User, ExportType \| where count_ > 2`.<br>- **ELK**: `FROM logs-puppet.audit-* \| WHERE event.action = 'export' AND user.name NOT IN ['admin'] \| STATS COUNT() BY user.name, export.type HAVING COUNT() > 2`. |
| 10. Config Repo Access from Cloud Instances | Adversaries use cloud VMs to access on-prem repos, as in hybrid attacks. | - Cloud Audit Logs (AWS CloudTrail)<br>- Network Traffic | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="AssumeRole" \| join userIdentity [search sourcetype=ansible:audit "query"] \| stats count by userIdentity \| where count > 5`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "AssumeRole" \| join kind=inner (AnsibleAuditLogs \| where Action == "query") on Caller \| summarize count() by Caller \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'AssumeRole' \| JOIN logs-ansible.audit-* ON user.identity WHERE event.action = 'query' \| STATS COUNT() BY user.identity HAVING COUNT() > 5`. |
| 11. Sensitive Data in Config Repos | Scanning for creds in configs, but hunt for access to sensitive vars. | - File Content Access (EDR scans)<br>- Query Logs | - **Splunk**: `index=endpoint sourcetype=edr_scan strings IN ("*password*", "*key*") AND path="*ansible*" \| stats count by path, host \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where AdditionalFields.Strings has_any ("password", "key") and FolderPath contains "ansible" \| summarize count() by FolderPath, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-edr.scan-* \| WHERE file.strings : ("*password*" OR "*key*") AND file.path : "*ansible*" \| STATS COUNT() BY file.path, host.name HAVING COUNT() > 3`. |
| 12. Config Repo Access Spikes | Sudden increases in queries to repos, indicating scanning. | - Audit Logs (Puppet/Ansible)<br>- Metrics | - **Splunk**: `index=config_repo sourcetype=ansible:audit action="query" \| timechart span=1h count \| where count > avg(count)*3`.<br>- **KQL**: `AnsibleAuditLogs \| where Action == "query" \| summarize HourlyCount=count() by bin(Timestamp, 1h) \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-ansible.audit-* \| WHERE event.action = 'query' \| STATS COUNT() BY date_histogram(@timestamp, '1h') \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 13. Unauthorized Module or Plugin Access | Adversaries access sensitive modules in Puppet/Chef for configs. | - Module Load Logs<br>- Access Events | - **Splunk**: `index=config_repo sourcetype=puppet:audit action="module_load" AND module NOT IN (approved) \| stats count by module, user \| where count > 2`.<br>- **KQL**: `PuppetAuditLogs \| where Action == "module_load" and Module !in (approvedModules) \| summarize count() by Module, User \| where count_ > 2`.<br>- **ELK**: `FROM logs-puppet.audit-* \| WHERE event.action = 'module_load' AND module.name NOT IN ['approved'] \| STATS COUNT() BY module.name, user.name HAVING COUNT() > 2`. |
| 14. Config Repo Access from Compromised Containers | Adversaries run queries from K8s pods, as in cloud-native attacks. | - Container Logs (K8s events)<br>- Process Execution | - **Splunk**: `index=container sourcetype=k8s:events "exec" Command="*ansible-playbook*" \| stats count by pod_name \| where count > 3`.<br>- **KQL**: `KubeEvents \| where Verb == "exec" and Message contains "ansible-playbook" \| summarize count() by ObjectRef.name \| where count_ > 3`.<br>- **ELK**: `FROM logs-kubernetes.events-* \| WHERE kubernetes.event.verb = 'exec' AND message : '*ansible-playbook*' \| STATS COUNT() BY kubernetes.pod.name HAVING COUNT() > 3`. |
| 15. Config Repo Credential Theft Indicators | Access to credential-storing configs, correlated with exfil. | - File Access (Sysmon ID 11)<br>- Network Exfil (ID 3) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename="*secrets.yaml*" \| join ProcessGuid [search EventCode=3 DestinationPort=443] \| stats count by host \| where count > 2`.<br>- **KQL**: `DeviceFileEvents \| where FileName contains "secrets.yaml" \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 443) on ProcessId \| summarize count() by DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : "*secrets.yaml*" \| JOIN logs-endpoint.network-* ON process.pid WHERE destination.port = 443 \| STATS COUNT() BY host.name HAVING COUNT() > 2`.


### Data from Information Repositories

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Unauthorized Access to SharePoint Sites | Adversaries access SharePoint to mine sensitive documents like policies or credentials, as seen in APT28 collecting files from information repositories. High risk in Microsoft 365 environments with misconfigured permissions. | - SharePoint Audit Logs (e.g., Office 365 Audit Logs)<br>- Authentication Logs | - **Splunk**: `index=o365 sourcetype=office365:audit Operation IN ("FileAccessed", "FileDownloaded") AND SiteUrl="*sharepoint.com*" AND UserId NOT IN (authorized_users) \| stats count by UserId, SiteUrl \| where count > 10`.<br>- **KQL**: `OfficeActivity \| where Operation in ("FileAccessed", "FileDownloaded") and Site_Url contains "sharepoint.com" and UserId !in (authorizedUsers) \| summarize count() by UserId, Site_Url \| where count_ > 10`.<br>- **ELK**: `FROM logs-office365.audit-* \| WHERE event.operation IN ['FileAccessed', 'FileDownloaded'] AND site.url : "*sharepoint.com*" AND user.id NOT IN ['admin'] \| STATS COUNT() BY user.id, site.url HAVING COUNT() > 10`. |
| 2. Anomalous Downloads from Confluence | Adversaries download pages or attachments from Confluence, as in Leviathan intrusions gathering from BMS servers. | - Confluence Audit Logs (Atlassian Cloud Audit)<br>- File Download Events | - **Splunk**: `index=cloud sourcetype=atlassian:audit action IN ("attachment.downloaded", "page.exported") AND user NOT IN (authorized) \| stats count by user, object \| where count > 5`.<br>- **KQL**: `AtlassianAuditLogs \| where Action in ("attachment.downloaded", "page.exported") and User !in (authorizedUsers) \| summarize count() by User, ObjectName \| where count_ > 5`.<br>- **ELK**: `FROM logs-atlassian.audit-* \| WHERE event.action IN ['attachment.downloaded', 'page.exported'] AND user.name NOT IN ['admin'] \| STATS COUNT() BY user.name, object.name HAVING COUNT() > 5`. |
| 3. Code Repository Data Exfiltration | Adversaries exfiltrate source code or credentials from GitHub/GitLab, as in Sandworm Team exfiltrating from enterprise databases. | - GitHub/GitLab Audit Logs<br>- Network Traffic | - **Splunk**: `index=cloud sourcetype=github:audit action IN ("repo.clone", "repo.download") AND user NOT IN (authorized) \| stats count by user, repo \| where count > 5`.<br>- **KQL**: `GitHubAuditLogs \| where Action in ("repo.clone", "repo.download") and Actor !in (authorizedUsers) \| summarize count() by Actor, Repository \| where count_ > 5`.<br>- **ELK**: `FROM logs-github.audit-* \| WHERE event.action IN ['repo.clone', 'repo.download'] AND user.name NOT IN ['admin'] \| STATS COUNT() BY user.name, repository.name HAVING COUNT() > 5`. |
| 4. Database Query for Sensitive Data | Adversaries query SQL/Oracle databases for schemas or user accounts, as in FIN6 collecting from SQL Server. | - Database Query Logs (e.g., SQL Server Audit)<br>- Process Execution | - **Splunk**: `index=database sourcetype=sql:audit query IN ("*SELECT * FROM sys.*", "*schema*") AND user NOT IN (authorized) \| stats count by user, query \| where count > 5`.<br>- **KQL**: `SqlAuditLogs \| where Query has_any ("SELECT * FROM sys.", "schema") and User !in (authorizedUsers) \| summarize count() by User, Query \| where count_ > 5`.<br>- **ELK**: `FROM logs-sql.audit-* \| WHERE query.text : ("*SELECT * FROM sys.*" OR "*schema*") AND user.name NOT IN ['admin'] \| STATS COUNT() BY user.name, query.text HAVING COUNT() > 5`. |
| 5. Messaging Platform Data Access | Adversaries access Slack/Teams for sensitive messages, as in MgBot stealing from Tencent QQ databases. | - Messaging Audit Logs (Slack/Teams Audit)<br>- API Access Logs | - **Splunk**: `index=cloud sourcetype=slack:audit action IN ("message.read", "file.download") AND user NOT IN (authorized) \| stats count by user, channel \| where count > 10`.<br>- **KQL**: `SlackAuditLogs \| where Action in ("message.read", "file.download") and User !in (authorizedUsers) \| summarize count() by User, Channel \| where count_ > 10`.<br>- **ELK**: `FROM logs-slack.audit-* \| WHERE event.action IN ['message.read', 'file.download'] AND user.name NOT IN ['admin'] \| STATS COUNT() BY user.name, channel.name HAVING COUNT() > 10`. |
| 6. Bulk Export from Information Repositories | Adversaries export large volumes of data from repos, as in SolarWinds Compromise where APT29 accessed internal wikis. | - Export Logs (SharePoint/Confluence exports)<br>- Network Traffic | - **Splunk**: `index=cloud sourcetype=office365:audit Operation="FileDownloaded" AND FileSize > 1000000 \| stats sum(FileSize) by UserId, SiteUrl \| where sum_FileSize > 10000000`.<br>- **KQL**: `OfficeActivity \| where Operation == "FileDownloaded" and FileSize > 1000000 \| summarize TotalSize=sum(FileSize) by UserId, Site_Url \| where TotalSize > 10000000`.<br>- **ELK**: `FROM logs-office365.audit-* \| WHERE event.operation = 'FileDownloaded' AND file.size > 1000000 \| STATS SUM(file.size) BY user.id, site.url HAVING SUM(file.size) > 10000000`. |
| 7. Anomalous Privileged User Access to Repos | Privileged users (e.g., admins) access repos unusually, as detection guidance suggests monitoring admins. | - Audit Logs (SharePoint/Confluence)<br>- User Behavior Analytics | - **Splunk**: `index=cloud sourcetype=office365:audit UserType="Admin" AND Operation IN ("FileAccessed", "PageViewed") \| stats count by UserId, SiteUrl \| where count > avg(count)*3`.<br>- **KQL**: `OfficeActivity \| where UserType == "Admin" and Operation in ("FileAccessed", "PageViewed") \| summarize count() by UserId, Site_Url \| where count_ > avg(count_) * 3`.<br>- **ELK**: `FROM logs-office365.audit-* \| WHERE user.type = 'Admin' AND event.operation IN ['FileAccessed', 'PageViewed'] \| STATS COUNT() BY user.id, site.url \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 8. Information Repo Access from Compromised Hosts | Access from unusual hosts or IPs, indicating lateral movement to repos. | - Network Traffic (Zeek HTTP to repo URLs)<br>- Endpoint Logs | - **Splunk**: `index=network sourcetype=zeek_http uri IN ("*sharepoint.com*", "*confluence*") AND src_ip NOT IN (corporate_ips) \| stats count by src_ip, uri \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteUrl has_any ("sharepoint.com", "confluence") and RemoteIP !in (corporateIps) \| summarize count() by RemoteIP, RemoteUrl \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri : ("*sharepoint.com*" OR "*confluence*") AND source.ip NOT IN ['10.0.0.0/8'] \| STATS COUNT() BY source.ip, http.uri HAVING COUNT() > 5`. |
| 9. Database Access via Adminer or Similar Tools | Adversaries use tools like Adminer to access databases, as in Sandworm Team and Sea Turtle. | - Process Creation (Sysmon ID 1)<br>- Network Traffic | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*adminer.php*", "*dbtool*") OR CommandLine="*sql*access*" \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("adminer.php", "dbtool") or ProcessCommandLine contains "sql access" \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("adminer.php" OR "dbtool") OR process.args : "*sql*access*" \| TABLE @timestamp, host.name, process.command_line`. |
| 10. Messaging App Data Theft | Stealing data from messaging apps like QQ or Telegram, as in MgBot and Troll Stealer. | - App Logs (Telegram/Slack access logs)<br>- File Access | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename IN ("*Telegram\\*", "*Slack\\cache*") \| stats count by TargetFilename, host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileAccessed" and FolderPath has_any ("Telegram", "Slack/cache") \| summarize count() by FileName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'access' AND file.path : ("*Telegram*" OR "*Slack/cache*") \| STATS COUNT() BY file.name, host.name HAVING COUNT() > 5`. |
| 11. Access to Public Key Infrastructure Folders | Adversaries target PKI folders for certs or keys, as in Troll Stealer. | - File Access (Sysmon ID 11)<br>- Directory Changes | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename="*pki*" OR "*certificates*" \| stats count by TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileAccessed" and FileName has_any ("pki", "certificates") \| summarize count() by FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'access' AND file.name : ("*pki*" OR "*certificates*") \| STATS COUNT() BY file.name, host.name HAVING COUNT() > 3`. |
| 12. Insider Threat Access to Repositories | Insiders access repos for personal/financial interest, as in MITRE insider threat mappings. | - UBA Logs<br>- Audit Logs | - **Splunk**: `index=security sourcetype=uba:anomaly user_type="insider" AND repo_access="true" \| stats count by user \| where count > 2`.<br>- **KQL**: `UbaAnomalies \| where UserType == "insider" and RepoAccess == true \| summarize count() by User \| where count_ > 2`.<br>- **ELK**: `FROM logs-uba.anomaly-* \| WHERE user.type = 'insider' AND repo.access = true \| STATS COUNT() BY user.name HAVING COUNT() > 2`. |
| 13. Lateral Movement to Repo Servers | Adversaries move laterally to repo servers (e.g., SQL servers) for data theft, as in Leviathan. | - Authentication Logs (Windows 4624)<br>- Network Connections (Sysmon ID 3) | - **Splunk**: `index=security EventID=4624 LogonType=3 AND TargetServerName="*repo_server*" \| join host [search sourcetype=sysmon EventCode=3 DestinationPort=1433] \| stats count by host \| where count > 2`.<br>- **KQL**: `SecurityEvent \| where EventID == 4624 and LogonType == 3 and TargetServerName contains "repo_server" \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 1433) on DeviceName \| summarize count() by DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 4624 AND winlog.logon.type = 3 AND winlog.target.server : "*repo_server*" \| JOIN logs-endpoint.network-* ON host.name WHERE destination.port = 1433 \| STATS COUNT() BY host.name HAVING COUNT() > 2`. |
| 14. Config Repo Access in AI Contexts | Access to repos in AI classification scenarios, as in 2025 MITRE AI updates. | - AI Tool Logs<br>- Audit Logs | - **Splunk**: `index=ai sourcetype=mitre:ai operation="classify" AND repo_access="true" \| stats count by user \| where count > 5`.<br>- **KQL**: `MitreAiLogs \| where Operation == "classify" and RepoAccess == true \| summarize count() by User \| where count_ > 5`.<br>- **ELK**: `FROM logs-mitre.ai-* \| WHERE event.operation = 'classify' AND repo.access = true \| STATS COUNT() BY user.name HAVING COUNT() > 5`. |
| 15. Repo Access in Lateral Movement Attacks | Repo access during lateral movement in 2023-2024 cyberattacks, as in top incidents. | - Security Logs (e.g., EDR lateral movement alerts)<br>- Audit Logs | - **Splunk**: `index=security sourcetype=edr:lateral_movement \| join host [search sourcetype=office365:audit "FileAccessed"] \| stats count by host \| where count > 2`.<br>- **KQL**: `EdrLateralLogs \| join kind=inner (OfficeActivity \| where Operation == "FileAccessed") on DeviceName \| summarize count() by DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-edr.lateral-* \| JOIN logs-office365.audit-* ON host.name WHERE event.operation = 'FileAccessed' \| STATS COUNT() BY host.name HAVING COUNT() > 2`.


### Data from Local System

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Unauthorized Access to Sensitive Local Files | Adversaries search and collect sensitive files from local directories, such as credentials or configuration files, as observed in APT1 campaigns where files were collected from victim systems. High risk in Windows environments with unmonitored file access. | - File Access Logs (e.g., Sysmon Event ID 11)<br>- Process Monitoring | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 \| search TargetFilename IN ("*\\Windows\\System32\\config\\SAM", "*\\Temp\\*") AND ProcessImage NOT IN (legit_processes) \| stats count by ProcessImage, TargetFilename \| where count > 5` (Detects access to sensitive files like SAM or temp dumps).<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileAccessed" and FolderPath has_any ("Windows\\System32\\config\\SAM", "Temp") and not(InitiatingProcessFolderPath in~ (legitProcs)) \| summarize count() by InitiatingProcessFolderPath, FolderPath \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events.file-* \| WHERE event.action = "access" AND file.path : ("*Windows/System32/config/SAM*" OR "*Temp*") AND process.name NOT IN ['explorer.exe'] \| STATS COUNT() BY process.name, file.path HAVING COUNT() > 5`. |
| 2. Execution of File Enumeration Tools | Adversaries use tools like `dir` or `find` to enumerate local files for collection, as in the Picus Security analysis of T1005 where attackers extract data using file search utilities. | - Process Creation (e.g., Sysmon ID 1)<br>- Command Execution Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search CommandLine IN ("*dir /s /b*", "*find / *") AND NOT ParentImage IN (legit_apps) \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("dir /s /b", "find / ") and not(InitiatingProcessFolderPath in~ (legitApps)) \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : ("*dir*/s*/b*" OR "*find*/ *") AND process.parent.name NOT IN ['cmd.exe'] \| TABLE @timestamp, host.name, process.command_line`. |
| 3. Data Collection from Local Databases | Adversaries query local databases (e.g., SQLite in browsers) to collect data, as noted in MITRE ATT&CK where local databases are targeted. | - Database Query Logs (e.g., SQLite access)<br>- File Access (Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename IN ("*\\AppData\\*\\*.sqlite", "*\\Temp\\*.db") \| stats count by TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileAccessed" and FileName has_any (".sqlite", ".db") and FolderPath has_any ("AppData", "Temp") \| summarize count() by FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'access' AND file.name : ("*.sqlite" OR "*.db") AND file.path : ("*AppData*" OR "*Temp*") \| STATS COUNT() BY file.name, host.name HAVING COUNT() > 3`. |
| 4. Virtual Machine File Collection | Adversaries collect data from VM files (e.g., .vmdk), as described in MITRE ATT&CK where virtual machine files are searched. Hunt in virtualized environments. | - File Access (Sysmon ID 11 for VM files)<br>- Hypervisor Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename="*.vmdk" OR "*.vmx" AND ProcessImage NOT IN (vm_tools) \| stats count by ProcessImage, TargetFilename \| where count > 2`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileAccessed" and FileName has_any (".vmdk", ".vmx") and not(InitiatingProcessFolderPath in~ (vmTools)) \| summarize count() by InitiatingProcessFolderPath, FileName \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'access' AND file.name : ("*.vmdk" OR "*.vmx") AND process.name NOT IN ['vmware'] \| STATS COUNT() BY process.name, file.name HAVING COUNT() > 2`. |
| 5. Data Collection Using Scripting Interpreters | Adversaries use cmd or PowerShell to gather data, as in Recorded Future's H1 2025 report on persistent data theft. | - Process Creation (Sysmon ID 1)<br>- Script Execution | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*cmd.exe*", "*powershell.exe*") CommandLine="*dir*" OR "*Get-ChildItem*" \| stats count by host, CommandLine \| where count > 10`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("cmd.exe", "powershell.exe") and ProcessCommandLine has_any ("dir", "Get-ChildItem") \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 10`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("cmd.exe" OR "powershell.exe") AND process.args : ("*dir*" OR "*Get-ChildItem*") \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 10`. |
| 6. Collection from Network Device CLI | Adversaries use CLI on network devices to collect configs, as in MITRE ATT&CK for network platforms. | - Network Device Logs (e.g., Cisco CLI audits)<br>- Command History | - **Splunk**: `index=network sourcetype=cisco:ios "show running-config" OR "show startup-config" AND user NOT IN (authorized) \| stats count by user, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("show running-config", "show startup-config") and InitiatingProcessAccountName !in (authorizedUsers) \| summarize count() by InitiatingProcessAccountName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-cisco.ios-* \| WHERE message : ("*show*running-config*" OR "*show*startup-config*") AND user.name NOT IN ['admin'] \| STATS COUNT() BY user.name, host.name HAVING COUNT() > 3`. |
| 7. Automated Collection from Local System | Adversaries automate data gathering with scripts, as in 2025 malware trends from Recorded Future. | - Script Execution Logs<br>- Process Behavior | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*forfiles*" OR "*robocopy*" AND Path="*staging*" \| stats count by host, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("forfiles", "robocopy") and FolderPath contains "staging" \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : ("*forfiles*" OR "*robocopy*") AND file.path : "*staging*" \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 5`. |
| 8. Data Collection in macOS Environments | Adversaries target macOS local files (e.g., Keychain), as per MITRE platforms. | - File Access Logs (macOS Unified Logs)<br>- Process Monitoring | - **Splunk**: `index=macos sourcetype=macos:unified event_type="file_access" path="*Keychain*" AND process NOT IN (legit_apps) \| stats count by process, path \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileAccessed" and FolderPath contains "Keychain" and not(InitiatingProcessName in~ (legitApps)) \| summarize count() by InitiatingProcessName, FolderPath \| where count_ > 3`.<br>- **ELK**: `FROM logs-macos.unified-* \| WHERE event.type = 'file_access' AND file.path : "*Keychain*" AND process.name NOT IN ['Safari'] \| STATS COUNT() BY process.name, file.path HAVING COUNT() > 3`. |
| 9. ESXi Local Data Collection | Adversaries collect data from ESXi hosts (e.g., VM configs), as in MITRE platforms. | - ESXi Logs (vSphere audits)<br>- File Access | - **Splunk**: `index=esxi sourcetype=esxi:audit action="file_access" path="*vmx*" AND user NOT IN (authorized) \| stats count by user, path \| where count > 2`.<br>- **KQL**: `EsxiAuditLogs \| where Action == "file_access" and Path contains "vmx" and User !in (authorizedUsers) \| summarize count() by User, Path \| where count_ > 2`.<br>- **ELK**: `FROM logs-esxi.audit-* \| WHERE event.action = 'file_access' AND file.path : "*vmx*" AND user.name NOT IN ['root'] \| STATS COUNT() BY user.name, file.path HAVING COUNT() > 2`. |
| 10. Data Collection Volume Spikes | Sudden increases in file access or enumeration, indicating bulk collection, as in 2025 malware trends. | - File Metrics (EDR aggregate)<br>- Process Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 \| timechart span=1h count \| where count > avg(count)*3`.<br>- **KQL**: `DeviceFileEvents \| summarize HourlyCount=count() by bin(Timestamp, 1h) \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| STATS COUNT() BY date_histogram(@timestamp, '1h') \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 11. Collection Using Forfiles Utility | Adversaries use Forfiles to stage documents, as in APT28. | - Process Creation (Sysmon ID 1)<br>- Command Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*forfiles.exe*" CommandLine="* /C cmd /c copy*" \| stats count by host, CommandLine \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "forfiles.exe" and ProcessCommandLine contains "/C cmd /c copy" \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name = "forfiles.exe" AND process.args : "* /C cmd /c copy*" \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 2`. |
| 12. Local Data Collection in Cloud VMs | Adversaries collect data from cloud VMs (e.g., Azure VM local files), as in hybrid attacks. | - Cloud Instance Logs (Azure Activity)<br>- File Access | - **Splunk**: `index=cloud sourcetype=azure:activity OperationName="VMFileAccess" AND Path="*sensitive*" AND Caller NOT IN (authorized) \| stats count by Caller, Path \| where count > 5`.<br>- **KQL**: `AzureActivity \| where OperationNameValue == "VMFileAccess" and Path contains "sensitive" and Caller !in (authorizedUsers) \| summarize count() by Caller, Path \| where count_ > 5`.<br>- **ELK**: `FROM logs-azure.activity-* \| WHERE event.action = 'VMFileAccess' AND path : "*sensitive*" AND user.name NOT IN ['admin'] \| STATS COUNT() BY user.name, path HAVING COUNT() > 5`. |
| 13. Data Collection Correlated with Exfiltration | Local data collection followed by network exfil, as in malware like Stealer. | - File Events (Sysmon ID 11)<br>- Network Events (ID 3) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename="*sensitive*" \| transaction ProcessGuid maxspan=5m [search EventCode=3 DestinationPort=443] \| where eventcount > 1 \| table _time, DestinationIp`.<br>- **KQL**: `DeviceFileEvents \| where FileName contains "sensitive" \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 443) on ProcessId \| project Timestamp, RemoteIP`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : "*sensitive*" \| JOIN logs-endpoint.network-* ON process.pid WHERE destination.port = 443 \| TABLE @timestamp, destination.ip`. |
| 14. Collection from Browser Local Storage | Adversaries collect data from browser storage (e.g., localStorage), as in web-focused malware. | - Browser Logs (Chrome/Firefox extensions)<br>- File Access | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename IN ("*Chrome\\User Data\\Local Storage*", "*Firefox\\storage*") \| stats count by TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileAccessed" and FolderPath has_any ("Chrome\\User Data\\Local Storage", "Firefox\\storage") \| summarize count() by FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'access' AND file.path : ("*Chrome/User Data/Local Storage*" OR "*Firefox/storage*") \| STATS COUNT() BY file.name, host.name HAVING COUNT() > 3`. |
| 15. Data Collection in Network Devices | Adversaries collect configs from network devices using CLI, as per MITRE. | - Device CLI Logs (Cisco/Juniper audits)<br>- Command History | - **Splunk**: `index=network sourcetype=cisco:ios "show tech-support" OR "show config" AND user NOT IN (authorized) \| stats count by user, host \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("show tech-support", "show config") and InitiatingProcessAccountName !in (authorizedUsers) \| summarize count() by InitiatingProcessAccountName, DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-cisco.ios-* \| WHERE message : ("*show*tech-support*" OR "*show*config*") AND user.name NOT IN ['admin'] \| STATS COUNT() BY user.name, host.name HAVING COUNT() > 2`.


### Data from Network Shared Drive

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. IPC$ Share Enumeration for Discovery | Adversaries leverage the IPC$ administrative share to enumerate shares and collect data, using named pipes over SMB for stealthy reconnaissance and potential exfiltration, as seen in campaigns abusing MSRPC services. High risk in Windows networks with default share configurations. | - Windows Event Logs (Event IDs 5140, 5145 for share access)<br>- Network Traffic (SMB protocol monitoring) | - **Splunk**: `index=windows EventCode IN (5140, 5145) Share_Name="\\\\*\\IPC$" AND Access_Mask="0x2" \| stats count by Source_Address, Account_Name \| where count > 10` (Detects multiple accesses to IPC$ share).<br>- **KQL**: `SecurityEvent \| where EventID in (5140, 5145) and ShareName == "\\\\*\\IPC$" and AccessMask == "0x2" \| summarize count() by SourceAddress, AccountName \| where count_ > 10`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id IN [5140, 5145] AND winlog.share.name = "\\\\*\\IPC$" AND winlog.access.mask = "0x2" \| STATS COUNT() BY source.ip, user.name HAVING COUNT() > 10`. |
| 2. SYSVOL Share Abuse for Staging and Collection | Adversaries abuse SYSVOL shares to stage malicious tools or collect Group Policy data, enabling data gathering from network shares, as in BitPaymer ransomware staging executables in SYSVOL. | - Windows Event Logs (Event IDs 5145 for write access, 5143 for modifications)<br>- File Monitoring (GPO folders) | - **Splunk**: `index=windows EventCode IN (5143, 5145) Share_Name="\\\\*\\SYSVOL" AND Accesses="*WriteData*" \| stats count by Account_Name, Source_IP, Share_Name \| where count > 5`.<br>- **KQL**: `SecurityEvent \| where EventID in (5143, 5145) and ShareName == "\\\\*\\SYSVOL" and Accesses contains "WriteData" \| summarize count() by AccountName, SourceIP, ShareName \| where count_ > 5`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id IN [5143, 5145] AND winlog.share.name = "\\\\*\\SYSVOL" AND winlog.accesses : "*WriteData*" \| STATS COUNT() BY user.name, source.ip, winlog.share.name HAVING COUNT() > 5`. |
| 3. Special Privilege Logons for Share Access | Multiple special privilege logons (Event ID 4672) across hosts indicate adversaries using elevated privileges to access and collect data from network shares. | - Windows Event Logs (Event ID 4672 for special logons)<br>- Authentication Monitoring | - **Splunk**: `index=windows EventCode=4672 Privileges="*SeDebugPrivilege*" OR "*SeBackupPrivilege*" \| stats count by Account_Name, Source_IP \| where count > 10`.<br>- **KQL**: `SecurityEvent \| where EventID == 4672 and Privileges has_any ("SeDebugPrivilege", "SeBackupPrivilege") \| summarize count() by AccountName, SourceIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 4672 AND winlog.privileges : ("*SeDebugPrivilege*" OR "*SeBackupPrivilege*") \| STATS COUNT() BY user.name, source.ip HAVING COUNT() > 10`. |
| 4. External IP Access to Network Shares | Unauthorized external IPs accessing shares indicate potential data exfiltration, focusing on Event ID 5140 for share access. | - Windows Event Logs (Event ID 5140)<br>- Network Traffic (SMB connections) | - **Splunk**: `index=windows EventCode=5140 Source_IP!="10.*" AND Source_IP!="192.168.*" AND Share_Name IN ("C$", "SYSVOL") \| stats count by Account_Name, Source_IP, Share_Name \| where count > 5` (From ).<br>- **KQL**: `SecurityEvent \| where EventID == 5140 and SourceIP !startswith_any ("10.", "192.168.") and ShareName in ("C$", "SYSVOL") \| summarize count() by AccountName, SourceIP, ShareName \| where count_ > 5`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 5140 AND NOT source.ip : ("10.*" OR "192.168.*") AND winlog.share.name IN ["C$", "SYSVOL"] \| STATS COUNT() BY user.name, source.ip, winlog.share.name HAVING COUNT() > 5`. |
| 5. Unusual Write Access to Shares | Anomalous write access (Event ID 5140 with WriteData) by accounts that normally only read, indicating data staging or collection on shares. | - Windows Event Logs (Event ID 5140)<br>- User Behavior Baselines | - **Splunk**: `index=windows EventCode=5140 Accesses="*WriteData*" \| join type=left Account_Name [search index=windows EventCode=5140 Accesses="*ReadData*" \| stats dc(Accesses) as normal_reads by Account_Name] \| where normal_reads > 10 AND isnull(normal_reads) \| table Account_Name, Source_IP, Share_Name, Accesses` (From ).<br>- **KQL**: `SecurityEvent \| where EventID == 5140 and Accesses contains "WriteData" \| join kind=leftouter (SecurityEvent \| where EventID == 5140 and Accesses contains "ReadData" \| summarize NormalReads=dcount(Accesses) by AccountName) on AccountName \| where NormalReads > 10 and isnull(NormalReads) \| project AccountName, SourceIP, ShareName, Accesses`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 5140 AND winlog.accesses : "*WriteData*" \| JOIN [FROM logs-windows-* \| WHERE winlog.event_id = 5140 AND winlog.accesses : "*ReadData*" \| STATS DISTINCT_COUNT(winlog.accesses) AS normal_reads BY user.name] ON user.name \| WHERE normal_reads > 10 AND normal_reads IS NULL \| TABLE user.name, source.ip, winlog.share.name, winlog.accesses`. |
| 6. New Files Created in Sensitive Shares | Detection of new files added to sensitive directories via shares (Event ID 5142), such as executables in System32 or web roots, indicating staging for collection. | - Windows Event Logs (Event ID 5142)<br>- File Monitoring | - **Splunk**: `index=windows EventCode=5142 Relative_Target_Name IN ("*System32*", "*inetpub*") \| stats count by Account_Name, Source_IP, Share_Name, Relative_Target_Name \| where count > 1` (From ).<br>- **KQL**: `SecurityEvent \| where EventID == 5142 and RelativeTargetName has_any ("System32", "inetpub") \| summarize count() by AccountName, SourceIP, ShareName, RelativeTargetName \| where count_ > 1`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 5142 AND winlog.relative.target.name : ("*System32*" OR "*inetpub*") \| STATS COUNT() BY user.name, source.ip, winlog.share.name, winlog.relative.target.name HAVING COUNT() > 1`. |
| 7. Mass Deletions on Network Shares | High volume of deletions (Event ID 5144) on shares, potentially to cover tracks after data collection. | - Windows Event Logs (Event ID 5144)<br>- Deletion Patterns | - **Splunk**: `index=windows EventCode=5144 \| bin _time span=5m \| stats count by _time, Account_Name, Source_IP, Share_Name \| where count > 10 \| table _time, Account_Name, Source_IP, Share_Name, count` (From ).<br>- **KQL**: `SecurityEvent \| where EventID == 5144 \| summarize Count=count() by bin(TimeGenerated, 5m), AccountName, SourceIP, ShareName \| where Count > 10 \| project TimeGenerated, AccountName, SourceIP, ShareName, Count`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 5144 \| STATS COUNT() BY date_histogram(@timestamp, '5m'), user.name, source.ip, winlog.share.name \| WHERE COUNT() > 10 \| TABLE @timestamp, user.name, source.ip, winlog.share.name, COUNT()`. |
| 8. SPN Check Failures Indicating Enumeration | High volume of SPN check failures (Event ID 5168) from a host, suggesting brute-force share enumeration for data collection. | - Windows Event Logs (Event ID 5168)<br>- Error Code Analysis | - **Splunk**: `index=windows EventCode=5168 \| stats count by Source_IP, Account_Name, Error_Code \| where count > 50 \| table Source_IP, Account_Name, Error_Code, count` (From ).<br>- **KQL**: `SecurityEvent \| where EventID == 5168 \| summarize count() by SourceIP, AccountName, ErrorCode \| where count_ > 50 \| project SourceIP, AccountName, ErrorCode, count_`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 5168 \| STATS COUNT() BY source.ip, user.name, winlog.error.code HAVING COUNT() > 50 \| TABLE source.ip, user.name, winlog.error.code, COUNT()`. |
| 9. Process Execution from Admin Shares | Processes executing from ADMIN$, IPC$, or C$ shares, indicating data staging or collection via shares. | - Process Monitoring (Sysmon ID 1)<br>- Command Line Auditing | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 command_includes ("ADMIN$" OR "IPC$" OR "C$") \| stats count by ProcessGuid, CommandLine \| where count > 1` (Adapted from ).<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("ADMIN$", "IPC$", "C$") \| summarize count() by ProcessId, ProcessCommandLine \| where count_ > 1`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*ADMIN$*" OR "*IPC$*" OR "*C$*") \| STATS COUNT() BY process.id, process.command_line HAVING COUNT() > 1`. |
| 10. File Writes Within Admin Shares | Suspicious file creations or modifications in Admin Shares, potentially for staging collected data. | - File Monitoring (Sysmon ID 11)<br>- Share Access Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 file_name IN (".exe",".dll",".bat") AND file_path IN ("ADMIN$","C$","IPC$") \| stats count by FileName, Host \| where count > 1` (From ).<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".exe",".dll",".bat") and FolderPath has_any ("ADMIN$","C$","IPC$") \| summarize count() by FileName, DeviceName \| where count_ > 1`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : (".exe" OR ".dll" OR ".bat") AND file.path : ("*ADMIN$*" OR "*C$*" OR "*IPC$*") \| STATS COUNT() BY file.name, host.name HAVING COUNT() > 1`. |
| 11. Impacket Service Creation via Registry | Detection of default Impacket service "BTOBTO" in registry, used for remote data extraction from shares. | - Registry Monitoring (Sysmon ID 13)<br>- Service Creation Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=13 Registry_Key="HKLM\\System\\CurrentControlSet\\Services\\BTOBTO" \| stats count by Host, Registry_Key \| where count > 1` (From ).<br>- **KQL**: `DeviceRegistryEvents \| where RegistryKey contains "HKLM\\System\\CurrentControlSet\\Services\\BTOBTO" \| summarize count() by DeviceName, RegistryKey \| where count_ > 1`.<br>- **ELK**: `FROM logs-endpoint.registry-* \| WHERE registry.key : "*HKLM/System/CurrentControlSet/Services/BTOBTO*" \| STATS COUNT() BY host.name, registry.key HAVING COUNT() > 1`. |
| 12. Multiple SMB Connections from Single Host | A single host making multiple SMB connections to many hosts in a short time, indicating share enumeration for data collection. | - Network Traffic (Zeek conn logs for SMB)<br>- Connection Metrics | - **Splunk**: `index=network sourcetype=zeek_smb \| timechart span=5m dc(dst_ip) by src_ip \| where dc_dst_ip > 10` (Adapted from  for multiple connections).<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "SMB" \| summarize DstCount=dcount(RemoteIP) by bin(Timestamp, 5m), DeviceIP \| where DstCount > 10`.<br>- **ELK**: `FROM logs-zeek.smb-* \| STATS DISTINCT_COUNT(destination.ip) BY date_histogram(@timestamp, '5m'), source.ip \| WHERE DISTINCT_COUNT(destination.ip) > 10`. |
| 13. Anomalous Inbound SMB Connections | Unusual inbound SMB connections on ports 445 or 139, potentially for unauthorized data access from shares. | - Network Traffic (Sysmon ID 3 for inbound)<br>- Firewall Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=3 DestinationPort IN (445, 139) AND Direction="Inbound" AND Source_IP NOT IN (internal_ranges) \| stats count by Source_IP, DestinationPort \| where count > 5` (Adapted from ).<br>- **KQL**: `DeviceNetworkEvents \| where RemotePort in (445, 139) and Direction == "Inbound" and RemoteIP !in (internalRanges) \| summarize count() by RemoteIP, RemotePort \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.network-* \| WHERE destination.port IN [445, 139] AND direction = 'inbound' AND source.ip NOT IN ['internal_ranges'] \| STATS COUNT() BY source.ip, destination.port HAVING COUNT() > 5`. |
| 14. Network Share Discovery Using Net Commands | Adversaries use `net view` or `net share` to discover and collect from shares, as in share discovery hunts. | - Process Creation (Sysmon ID 1)<br>- Command Auditing | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*net view*", "*net share*") AND NOT ParentImage IN (legit_apps) \| stats count by host, CommandLine \| where count > 5` (Adapted from ).<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("net view", "net share") and not(InitiatingProcessFolderPath in~ (legitApps)) \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*net view*" OR "*net share*") AND process.parent.name NOT IN ['cmd.exe'] \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 5`. |
| 15. Rapid Connections and Authentications to Multiple Endpoints | A source computer rapidly connecting and authenticating to multiple endpoints, indicating network share enumeration for data collection. | - Windows Event Logs (Event IDs 5140, 5145)<br>- Network Session Logs | - **Splunk**: `index=windows EventCode IN (5140, 5145) \| timechart span=5m dc(ComputerName) by Source_IP \| where dc_ComputerName > 10` (From ).<br>- **KQL**: `SecurityEvent \| where EventID in (5140, 5145) \| summarize DstCount=dcount(ComputerName) by bin(TimeGenerated, 5m), SourceIP \| where DstCount > 10`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id IN [5140, 5145] \| STATS DISTINCT_COUNT(host.name) BY date_histogram(@timestamp, '5m'), source.ip \| WHERE DISTINCT_COUNT(host.name) > 10`.


### Data from Removable Media

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Unauthorized Data Copy from Removable Media | Adversaries copy sensitive files from USB or optical drives to the local system for staging, as observed in APT28 campaigns where files were collected from USB devices. High risk in Windows environments with automatic media mounting. | - File Copy Events (e.g., Sysmon Event ID 11 for copies from removable paths)<br>- Removable Media Insertion (Windows Event ID 2003) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 \| search TargetFilename="*staging*" AND SourceFilename IN ("D:\\*", "E:\\*") \| stats count by SourceFilename, TargetFilename \| where count > 5` (Detects copies from removable drives to staging locations).<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCopied" and PreviousFolderPath has_any ("D:\\", "E:\\") and FolderPath contains "staging" \| summarize count() by PreviousFolderPath, FolderPath \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events.file-* \| WHERE event.action = "copy" AND file.source.path : ("D:\\*" OR "E:\\*") AND file.target.path : "*staging*" \| STATS COUNT() BY file.source.path, file.target.path HAVING COUNT() > 5`. |
| 2. Removable Media Insertion Followed by File Enumeration | Adversaries insert removable media and enumerate files (e.g., using dir/find), as in FIN10 deploying tools to gather data from USB devices. | - Device Insertion Events (Windows Event ID 2003)<br>- Process Creation (Sysmon ID 1 for dir/find) | - **Splunk**: `index=windows EventID=2003 DriveType="Removable" \| transaction host maxspan=5m [search sourcetype=sysmon EventCode=1 CommandLine IN ("*dir /s*", "*find *")] \| where eventcount > 1 \| table _time, host, DriveLetter`.<br>- **KQL**: `DeviceEvents \| where ActionType == "UsbDriveMounted" and AdditionalFields.DriveType == "Removable" \| join kind=inner (DeviceProcessEvents \| where ProcessCommandLine has_any ("dir /s", "find ")) on DeviceName \| project Timestamp, DeviceName, AdditionalFields.DriveLetter`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 2003 AND drive.type = "Removable" \| JOIN logs-endpoint.process-* ON host.name WHERE process.args : ("*dir*/s*" OR "*find *") \| TABLE @timestamp, host.name, drive.letter`. |
| 3. Automated Data Collection from USB Drives | Adversaries use scripts or tools to automatically collect data upon USB insertion, as in Leviathan collecting from removable media. | - Process Creation (Sysmon ID 1 for scripting interpreters)<br>- USB Events (Event ID 2003) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*powershell.exe*", "*cmd.exe*") CommandLine="*copy*USB*" \| join host [search EventID=2003] \| stats count by host, CommandLine \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("powershell.exe", "cmd.exe") and ProcessCommandLine contains "copy USB" \| join kind=inner (DeviceEvents \| where ActionType == "UsbDriveMounted") on DeviceName \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("powershell.exe" OR "cmd.exe") AND process.args : "*copy*USB*" \| JOIN logs-windows-* ON host.name WHERE winlog.event_id = 2003 \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 3`. |
| 4. Exfiltration from Removable Media via Network | Data from removable media exfiltrated over network, as in MuddyWater collecting from removable drives. | - Network Traffic (Zeek file transfers from removable paths)<br>- USB Insertion Events | - **Splunk**: `index=network sourcetype=zeek_file file_path IN ("D:\\*", "E:\\*") AND dest_port=443 \| stats count by src_ip, file_path \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.FilePath has_any ("D:\\", "E:\\") and RemotePort == 443 \| summarize count() by DeviceIP, AdditionalFields.FilePath \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.file-* \| WHERE file.path : ("D:\\*" OR "E:\\*") AND destination.port = 443 \| STATS COUNT() BY source.ip, file.path HAVING COUNT() > 5`. |
| 5. Removable Media Access in Cloud VMs | Adversaries access removable media in cloud VMs (e.g., attached EBS volumes), as in virtualized attacks. | - Cloud Instance Logs (AWS EC2 volume attachments)<br>- File Access in VMs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="AttachVolume" \| join instanceId [search sourcetype=sysmon EventCode=11 "*removable*"] \| stats count by instanceId \| where count > 3`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "AttachVolume" \| join kind=inner (DeviceFileEvents \| where FolderPath contains "removable") on DeviceName \| summarize count() by DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'AttachVolume' \| JOIN logs-endpoint.file-* ON host.id WHERE file.path : "*removable*" \| STATS COUNT() BY host.id HAVING COUNT() > 3`. |
| 6. Tools for USB Data Theft | Adversaries use tools like USBStealer or custom scripts to steal data from USB, as in Stealth Falcon malware. | - Process Creation (Sysmon ID 1 for known theft tools)<br>- USB Events | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*usbstealer.exe*", "*copy_usb*") \| join host [search EventID=2003] \| stats count by host, Image \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("usbstealer.exe", "copy_usb") \| join kind=inner (DeviceEvents \| where ActionType == "UsbDriveMounted") on DeviceName \| summarize count() by DeviceName, FolderPath \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("usbstealer.exe" OR "copy_usb") \| JOIN logs-windows-* ON host.name WHERE winlog.event_id = 2003 \| STATS COUNT() BY host.name, process.executable HAVING COUNT() > 2`. |
| 7. Anomalous File Access on Removable Media | Unusual file reads/writes on removable media, as in FIN7 retrieving captured data. | - File Events (Sysmon ID 11 on removable paths)<br>- Device Events | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename IN ("D:\\*", "E:\\*") AND mvcount(TargetFilename) > 20 \| stats values(TargetFilename) by host`.<br>- **KQL**: `DeviceFileEvents \| where FolderPath has_any ("D:\\", "E:\\") \| summarize Files=make_set(FileName) by DeviceName \| where array_length(Files) > 20`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.path : ("D:\\*" OR "E:\\*") \| STATS SET(file.name) BY host.name HAVING CARDINALITY(file.name) > 20`. |
| 8. Removable Media in Linux Environments | Adversaries collect data from removable media on Linux (e.g., /media/*), as in general ATT&CK coverage. | - Mount Events (auditd mount syscall)<br>- File Access | - **Splunk**: `index=linux sourcetype=auditd syscall="mount" path="/media/*" \| stats count by exe, path \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "DeviceMounted" and FolderPath contains "/media/" \| summarize count() by InitiatingProcessFolderPath, FolderPath \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE syscall.name = 'mount' AND file.path : "/media/*" \| STATS COUNT() BY process.exe, file.path HAVING COUNT() > 5`. |
| 9. Data Compression on Removable Media | Adversaries compress data on removable media for exfiltration, as in BRONZE BUTLER. | - Process Creation (Sysmon ID 1 for zip/rar)<br>- Removable Path Files | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*zip*" AND Path IN ("D:\\*", "E:\\*") \| stats count by host, CommandLine \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "zip" and FolderPath has_any ("D:\\", "E:\\") \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : "*zip*" AND file.path : ("D:\\*" OR "E:\\*") \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 3`. |
| 10. Removable Media in IoT/Embedded Systems | Adversaries collect data from removable media in IoT devices, as in emerging 2025 threats. | - IoT Device Logs<br>- USB Events | - **Splunk**: `index=iot sourcetype=iot:log event="usb_insert" \| join device_id [search "*data_copy*"] \| stats count by device_id \| where count > 2`.<br>- **KQL**: `IoTLogs \| where Event == "usb_insert" \| join kind=inner (IoTLogs \| where Message contains "data_copy") on DeviceId \| summarize count() by DeviceId \| where count_ > 2`.<br>- **ELK**: `FROM logs-iot-* \| WHERE event.name = 'usb_insert' \| JOIN logs-iot-* ON device.id WHERE message : "*data_copy*" \| STATS COUNT() BY device.id HAVING COUNT() > 2`. |
| 11. Encrypted Data on Removable Media | Adversaries encrypt collected data on removable media, as in stealthy exfil. | - Process Creation (Sysmon ID 1 for encrypt tools)<br>- Removable Files | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*encrypt*" AND Path IN ("D:\\*", "E:\\*") \| stats count by host, CommandLine \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "encrypt" and FolderPath has_any ("D:\\", "E:\\") \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : "*encrypt*" AND file.path : ("D:\\*" OR "E:\\*") \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 2`. |
| 12. Volume Spikes on Removable Media Access | Sudden increase in file operations on removable media, indicating bulk collection. | - File Events (Sysmon ID 11 on removable paths)<br>- Timechart Analysis | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename IN ("D:\\*", "E:\\*") \| timechart span=1h count \| where count > avg(count)*3`.<br>- **KQL**: `DeviceFileEvents \| where FolderPath has_any ("D:\\", "E:\\") \| summarize HourlyCount=count() by bin(Timestamp, 1h) \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.path : ("D:\\*" OR "E:\\*") \| STATS COUNT() BY date_histogram(@timestamp, '1h') \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 13. Removable Media Access Correlated with Exfiltration | Removable media access followed by network exfil, as in Patchwork exfiltration. | - USB Events (Event ID 2003)<br>- Network Events (Sysmon ID 3) | - **Splunk**: `index=windows EventID=2003 \| transaction host maxspan=5m [search sourcetype=sysmon EventCode=3 DestinationPort=443] \| where eventcount > 1 \| table _time, host`.<br>- **KQL**: `DeviceEvents \| where ActionType == "UsbDriveMounted" \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 443) on DeviceName \| project Timestamp, DeviceName`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 2003 \| JOIN logs-endpoint.network-* ON host.name WHERE destination.port = 443 \| TABLE @timestamp, host.name`. |
| 14. Optical Drive Data Collection | Adversaries collect from CD/DVD drives, as in general removable media threats. | - Device Insertion (Event ID 2003 for optical)<br>- File Copy from Optical | - **Splunk**: `index=windows EventID=2003 DriveType="CD-ROM" \| join host [search sourcetype=sysmon EventCode=11 "*copy*CD*"] \| stats count by host \| where count > 2`.<br>- **KQL**: `DeviceEvents \| where ActionType == "OpticalDriveMounted" \| join kind=inner (DeviceFileEvents \| where ProcessCommandLine contains "copy CD") on DeviceName \| summarize count() by DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 2003 AND drive.type = "CD-ROM" \| JOIN logs-endpoint.file-* ON host.name WHERE process.args : "*copy*CD*" \| STATS COUNT() BY host.name HAVING COUNT() > 2`. |
| 15. Removable Media in 2025 IoT Threats | Emerging threats in 2025 involving data from removable media in IoT, as per predictions. | - IoT Logs<br>- USB Events in IoT | - **Splunk**: `index=iot sourcetype=iot:log event="media_insert" \| join device_id [search "*data_exfil*"] \| stats count by device_id \| where count > 2`.<br>- **KQL**: `IoTLogs \| where Event == "media_insert" \| join kind=inner (IoTLogs \| where Message contains "data_exfil") on DeviceId \| summarize count() by DeviceId \| where count_ > 2`.<br>- **ELK**: `FROM logs-iot-* \| WHERE event.name = 'media_insert' \| JOIN logs-iot-* ON device.id WHERE message : "*data_exfil*" \| STATS COUNT() BY device.id HAVING COUNT() > 2`.


### Email Collection


| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Unauthorized Access to Local Email Stores | Adversaries access local email stores (e.g., Outlook PST/OST files) on endpoints, as in APT28 collecting from Outlook clients.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> High risk in Windows environments with unmonitored file access. | - File Access Logs (Sysmon Event ID 11)<br>- Endpoint Process Monitoring | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename IN ("*\\Outlook\\*.pst", "*\\Outlook\\*.ost") AND ProcessImage NOT IN (legit_processes) \| stats count by ProcessImage, TargetFilename, host \| where count > 5` (Detects access to Outlook email files).<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileAccessed" and FileName has_any (".pst", ".ost") and FolderPath contains "Outlook" and not(InitiatingProcessFolderPath in~ (legitProcs)) \| summarize count() by InitiatingProcessFolderPath, FileName, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events.file-* \| WHERE event.action = "access" AND file.name : ("*.pst" OR "*.ost") AND file.path : "*Outlook*" AND process.name NOT IN ['outlook.exe'] \| STATS COUNT() BY process.name, file.name, host.name HAVING COUNT() > 5`. |
| 2. Suspicious MAPI Profile Access | Adversaries use Messaging Application Programming Interface (MAPI) to collect emails, as in FIN7 attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> Common in Windows with Outlook. | - Process Creation (Sysmon ID 1 for MAPI tools)<br>- Registry Access (Sysmon ID 13 for MAPI profiles) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*mapi*" OR Image="*mapi*.exe" \| stats count by host, CommandLine \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "mapi" or FolderPath has "mapi" \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : "*mapi*" OR process.name : "*mapi*.exe" \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 3`. |
| 3. Unauthorized Access to Email Servers | Adversaries access Exchange or IMAP/POP3 servers to collect emails, as in Turla compromising Exchange.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> High risk in on-premises email servers. | - Email Server Logs (Exchange Audit Logs)<br>- Network Traffic (IMAP/POP3) | - **Splunk**: `index=email sourcetype=exchange:audit Operation IN ("MailboxLogin", "MailItemsAccessed") AND UserId NOT IN (authorized_users) \| stats count by UserId, ClientIPAddress \| where count > 10`.<br>- **KQL**: `ExchangeAuditLogs \| where Operation in ("MailboxLogin", "MailItemsAccessed") and UserId !in (authorizedUsers) \| summarize count() by UserId, ClientIPAddress \| where count_ > 10`.<br>- **ELK**: `FROM logs-exchange.audit-* \| WHERE event.operation IN ['MailboxLogin', 'MailItemsAccessed'] AND user.id NOT IN ['admin'] \| STATS COUNT() BY user.id, client.ip HAVING COUNT() > 10`. |
| 4. Email Collection via Cloud APIs | Adversaries use stolen OAuth tokens to collect emails from cloud services like Office 365 or Gmail, as in Nobelium attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Cloud Audit Logs (Office 365 Audit, Google Workspace Logs)<br>- Authentication Logs | - **Splunk**: `index=cloud sourcetype=o365:audit Operation IN ("MailItemsAccessed", "Search-Mailbox") AND UserId NOT IN (approved_users) \| stats count by UserId, ClientIP \| where count > 10`.<br>- **KQL**: `OfficeActivity \| where Operation in ("MailItemsAccessed", "Search-Mailbox") and UserId !in (approvedUsers) \| summarize count() by UserId, ClientIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-o365.audit-* \| WHERE event.operation IN ['MailItemsAccessed', 'Search-Mailbox'] AND user.id NOT IN ['approved'] \| STATS COUNT() BY user.id, client.ip HAVING COUNT() > 10`. |
| 5. Creation of Email Forwarding Rules | Adversaries create forwarding rules to collect emails remotely, as in T1114.003 and Volt Typhoon incidents.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Email Rule Logs (Exchange/Office 365 Audit)<br>- Rule Creation Events | - **Splunk**: `index=email sourcetype=o365:audit Operation="New-InboxRule" AND Parameters="*ForwardTo*" \| stats count by UserId, Parameters \| where count > 1`.<br>- **KQL**: `OfficeActivity \| where Operation == "New-InboxRule" and Parameters contains "ForwardTo" \| summarize count() by UserId, Parameters \| where count_ > 1`.<br>- **ELK**: `FROM logs-o365.audit-* \| WHERE event.operation = 'New-InboxRule' AND event.parameters : "*ForwardTo*" \| STATS COUNT() BY user.id, event.parameters HAVING COUNT() > 1`. |
| 6. Bulk Email Downloads via IMAP/POP3 | Adversaries download large volumes of emails via IMAP/POP3, as in MuddyWater campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Network Traffic (Zeek IMAP/POP3 logs)<br>- Email Server Logs | - **Splunk**: `index=network sourcetype=zeek_imap OR sourcetype=zeek_pop3 bytes>1000000 \| stats sum(bytes) by src_ip, dest_ip \| where sum_bytes > 10000000`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol in ("IMAP", "POP3") and AdditionalFields.Bytes > 1000000 \| summarize TotalBytes=sum(AdditionalFields.Bytes) by DeviceIP, RemoteIP \| where TotalBytes > 10000000`.<br>- **ELK**: `FROM logs-zeek.imap-* OR logs-zeek.pop3-* \| WHERE bytes > 1000000 \| STATS SUM(bytes) BY source.ip, destination.ip HAVING SUM(bytes) > 10000000`. |
| 7. Suspicious Email Access from Non-Corporate IPs | Unauthorized email access from external IPs, indicating compromised accounts, as in Scattered Spider.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Authentication Logs (Azure AD Sign-ins)<br>- Email Audit Logs | - **Splunk**: `index=security sourcetype=azure:ad:signin AppDisplayName="Microsoft Exchange Online" AND IPAddress NOT IN (corporate_ranges) \| stats count by UserPrincipalName, IPAddress \| where count > 5`.<br>- **KQL**: `SigninLogs \| where AppDisplayName == "Microsoft Exchange Online" and IPAddress !in (corporateRanges) \| summarize count() by UserPrincipalName, IPAddress \| where count_ > 5`.<br>- **ELK**: `FROM logs-azure.signin-* \| WHERE app.name = 'Microsoft Exchange Online' AND source.ip NOT IN ['10.0.0.0/8'] \| STATS COUNT() BY user.name, source.ip HAVING COUNT() > 5`. |
| 8. Email Collection Correlated with Phishing | Phishing campaigns lead to email collection via stolen credentials, as in Nobelium.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Phishing Logs (Email Gateway)<br>- Email Audit Logs | - **Splunk**: `index=email sourcetype=phish_log "malicious link" \| join user [search sourcetype=o365:audit "MailItemsAccessed"] \| stats count by user, Operation \| where count > 1`.<br>- **KQL**: `PhishLogs \| where Description contains "malicious link" \| join kind=inner (OfficeActivity \| where Operation == "MailItemsAccessed") on UserId \| summarize count() by UserId, Operation \| where count_ > 1`.<br>- **ELK**: `FROM logs-phish-* \| WHERE message : "*malicious*link*" \| JOIN logs-o365.audit-* ON user.id WHERE event.operation = 'MailItemsAccessed' \| STATS COUNT() BY user.id, event.operation HAVING COUNT() > 1`. |
| 9. High-Frequency Email Access Spikes | Sudden spikes in email access operations, indicating automated collection, as in Recorded Future's 2025 trends.<grok:render type="render_inline_citation"><argument name="citation_id">5</argument></grok:render> | - Email Audit Logs (Office 365/Exchange)<br>- Usage Metrics | - **Splunk**: `index=email sourcetype=o365:audit Operation="MailItemsAccessed" \| timechart span=1h count by UserId \| where count > avg(count)*4`.<br>- **KQL**: `OfficeActivity \| where Operation == "MailItemsAccessed" \| summarize HourlyCount=count() by bin(TimeGenerated, 1h), UserId \| where HourlyCount > avg(HourlyCount) * 4`.<br>- **ELK**: `FROM logs-o365.audit-* \| WHERE event.operation = 'MailItemsAccessed' \| STATS COUNT() BY date_histogram(@timestamp, '1h'), user.id \| WHERE COUNT() > AVG(COUNT()) * 4`. |
| 10. Email Collection from Compromised Endpoints | Adversaries collect emails from compromised endpoints using tools like PowerShell, as in FIN7.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (Sysmon ID 1 for PowerShell)<br>- Email File Access | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" CommandLine="*mapi*" \| join host [search EventCode=11 "*Outlook*"] \| stats count by host \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "powershell.exe" and ProcessCommandLine contains "mapi" \| join kind=inner (DeviceFileEvents \| where FolderPath contains "Outlook") on DeviceName \| summarize count() by DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name = "powershell.exe" AND process.args : "*mapi*" \| JOIN logs-endpoint.file-* ON host.name WHERE file.path : "*Outlook*" \| STATS COUNT() BY host.name HAVING COUNT() > 2`. |
| 11. Email Forwarding to External Domains | Forwarding rules set to external domains for email collection, as in T1114.003.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Email Rule Logs (Office 365 Audit)<br>- Rule Parameters | - **Splunk**: `index=email sourcetype=o365:audit Operation="New-InboxRule" AND Parameters="*ForwardTo*external.com" \| stats count by UserId, Parameters \| where count > 1`.<br>- **KQL**: `OfficeActivity \| where Operation == "New-InboxRule" and Parameters contains "ForwardTo" and Parameters contains "external.com" \| summarize count() by UserId, Parameters \| where count_ > 1`.<br>- **ELK**: `FROM logs-o365.audit-* \| WHERE event.operation = 'New-InboxRule' AND event.parameters : ("*ForwardTo*external.com*") \| STATS COUNT() BY user.id, event.parameters HAVING COUNT() > 1`. |
| 12. Email Access via Non-Standard Clients | Adversaries use non-standard email clients (e.g., Thunderbird) or scripts to collect emails, as in general T1114.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (Sysmon ID 1 for clients)<br>- Network Traffic (IMAP/POP3) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*thunderbird.exe*", "*custom_email*") AND CommandLine="*imap*" \| stats count by host, CommandLine \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("thunderbird.exe", "custom_email") and ProcessCommandLine contains "imap" \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("thunderbird.exe" OR "custom_email") AND process.args : "*imap*" \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 3`. |
| 13. Email Collection in Linux Environments | Adversaries access email stores (e.g., Thunderbird profiles) on Linux, as in general T1114 coverage.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - File Access (auditd openat)<br>- Process Monitoring | - **Splunk**: `index=linux sourcetype=auditd syscall="openat" path IN ("*/.thunderbird/*", "*/mail/*") AND NOT exe IN (legit_apps) \| stats count by exe, path \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileOpened" and FolderPath has_any (".thunderbird", "mail") and not(InitiatingProcessFolderPath in~ (legitApps)) \| summarize count() by InitiatingProcessFolderPath, FolderPath \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE syscall.name = "openat" AND file.path : ("*/.thunderbird/*" OR "*/mail/*") AND process.exe NOT IN ['thunderbird'] \| STATS COUNT() BY process.exe, file.path HAVING COUNT() > 5`. |
| 14. Email Collection via Compromised Cloud Accounts | Adversaries use compromised cloud accounts to collect emails, as in Nobelium.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Cloud Audit Logs (Azure AD, Google Workspace)<br>- Sign-in Logs | - **Splunk**: `index=cloud sourcetype=azure:ad:signin AppDisplayName="Microsoft Exchange Online" AND Status="success" AND Location NOT IN (known_locations) \| stats count by UserPrincipalName, Location \| where count > 5`.<br>- **KQL**: `SigninLogs \| where AppDisplayName == "Microsoft Exchange Online" and Status == "success" and Location !in (knownLocations) \| summarize count() by UserPrincipalName, Location \| where count_ > 5`.<br>- **ELK**: `FROM logs-azure.signin-* \| WHERE app.name = 'Microsoft Exchange Online' AND event.outcome = 'success' AND source.location NOT IN ['known_locations'] \| STATS COUNT() BY user.name, source.location HAVING COUNT() > 5`. |
| 15. Email Collection Followed by Exfiltration | Email collection followed by outbound network traffic, as in Turla exfiltration.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Email Audit Logs<br>- Network Events (Sysmon ID 3) | - **Splunk**: `index=email sourcetype=o365:audit Operation="MailItemsAccessed" \| transaction UserId maxspan=5m [search index=endpoint sourcetype=sysmon EventCode=3 DestinationPort=443] \| where eventcount > 1 \| table _time, UserId, DestinationIp`.<br>- **KQL**: `OfficeActivity \| where Operation == "MailItemsAccessed" \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 443) on DeviceName \| project TimeGenerated, UserId, RemoteIP`.<br>- **ELK**: `FROM logs-o365.audit-* \| WHERE event.operation = 'MailItemsAccessed' \| JOIN logs-endpoint.network-* ON host.name WHERE destination.port = 443 \| TABLE @timestamp, user.id, destination.ip`. |


### Email Forwarding Rule


| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Creation of Unauthorized Email Forwarding Rules | Adversaries create new inbox rules to forward emails to external domains, as in Nobelium attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> High risk in Office 365 environments with weak rule auditing. | - Email Audit Logs (Office 365 Audit, Exchange Audit)<br>- Rule Creation Events | - **Splunk**: `index=email sourcetype=o365:audit Operation="New-InboxRule" AND Parameters="*ForwardTo*" AND Parameters="*external.com" \| stats count by UserId, Parameters \| where count > 1` (Detects new forwarding rules to external domains).<br>- **KQL**: `OfficeActivity \| where Operation == "New-InboxRule" and Parameters contains "ForwardTo" and Parameters contains "external.com" \| summarize count() by UserId, Parameters \| where count_ > 1`.<br>- **ELK**: `FROM logs-o365.audit-* \| WHERE event.operation = 'New-InboxRule' AND event.parameters : ("*ForwardTo*external.com*") \| STATS COUNT() BY user.id, event.parameters HAVING COUNT() > 1`. |
| 2. Modification of Existing Email Rules | Adversaries modify existing rules to redirect emails, as in Volt Typhoon campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> Common in compromised Exchange accounts. | - Email Audit Logs (Operation: Set-InboxRule)<br>- Rule Modification Events | - **Splunk**: `index=email sourcetype=o365:audit Operation="Set-InboxRule" AND Parameters="*ForwardTo*" \| stats count by UserId, Parameters, RuleName \| where count > 1`.<br>- **KQL**: `OfficeActivity \| where Operation == "Set-InboxRule" and Parameters contains "ForwardTo" \| summarize count() by UserId, Parameters, RuleName \| where count_ > 1`.<br>- **ELK**: `FROM logs-o365.audit-* \| WHERE event.operation = 'Set-InboxRule' AND event.parameters : "*ForwardTo*" \| STATS COUNT() BY user.id, event.parameters, rule.name HAVING COUNT() > 1`. |
| 3. Forwarding Rules Created by Compromised Accounts | Rules created after suspicious logins from non-corporate IPs, indicating compromised accounts, as in Scattered Spider attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Authentication Logs (Azure AD Sign-ins)<br>- Email Audit Logs | - **Splunk**: `index=security sourcetype=azure:ad:signin Status="success" AND IPAddress NOT IN (corporate_ranges) \| join UserPrincipalName [search sourcetype=o365:audit Operation="New-InboxRule"] \| stats count by UserPrincipalName, IPAddress \| where count > 1`.<br>- **KQL**: `SigninLogs \| where Status == "success" and IPAddress !in (corporateRanges) \| join kind=inner (OfficeActivity \| where Operation == "New-InboxRule") on UserId \| summarize count() by UserId, IPAddress \| where count_ > 1`.<br>- **ELK**: `FROM logs-azure.signin-* \| WHERE event.outcome = 'success' AND source.ip NOT IN ['10.0.0.0/8'] \| JOIN logs-o365.audit-* ON user.id WHERE event.operation = 'New-InboxRule' \| STATS COUNT() BY user.id, source.ip HAVING COUNT() > 1`. |
| 4. Forwarding Rules with Suspicious Recipients | Rules forwarding to uncommon or external email addresses, as in Turla email collection.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Email Audit Logs (Office 365/Exchange)<br>- Rule Parameters | - **Splunk**: `index=email sourcetype=o365:audit Operation IN ("New-InboxRule", "Set-InboxRule") AND Parameters="*ForwardTo*" AND NOT Parameters IN (known_domains) \| stats count by UserId, Parameters \| where count > 1`.<br>- **KQL**: `OfficeActivity \| where Operation in ("New-InboxRule", "Set-InboxRule") and Parameters contains "ForwardTo" and not(Parameters has_any (knownDomains)) \| summarize count() by UserId, Parameters \| where count_ > 1`.<br>- **ELK**: `FROM logs-o365.audit-* \| WHERE event.operation IN ['New-InboxRule', 'Set-InboxRule'] AND event.parameters : "*ForwardTo*" AND NOT event.parameters : ('known_domains') \| STATS COUNT() BY user.id, event.parameters HAVING COUNT() > 1`. |
| 5. Email Forwarding Correlated with Phishing | Forwarding rules created after phishing detections, indicating compromise, as in Nobelium campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Phishing Logs (Email Gateway)<br>- Email Audit Logs | - **Splunk**: `index=email sourcetype=phish_log "malicious link" \| join user [search sourcetype=o365:audit Operation="New-InboxRule" Parameters="*ForwardTo*"] \| stats count by user, Parameters \| where count > 1`.<br>- **KQL**: `PhishLogs \| where Description contains "malicious link" \| join kind=inner (OfficeActivity \| where Operation == "New-InboxRule" and Parameters contains "ForwardTo") on UserId \| summarize count() by UserId, Parameters \| where count_ > 1`.<br>- **ELK**: `FROM logs-phish-* \| WHERE message : "*malicious*link*" \| JOIN logs-o365.audit-* ON user.id WHERE event.operation = 'New-InboxRule' AND event.parameters : "*ForwardTo*" \| STATS COUNT() BY user.id, event.parameters HAVING COUNT() > 1`. |
| 6. High-Frequency Rule Creation or Modification | Sudden spikes in rule creation/modification, indicating automated attacks, as in 2025 malware trends.<grok:render type="render_inline_citation"><argument name="citation_id">5</argument></grok:render> | - Email Audit Logs (Office 365/Exchange)<br>- Usage Metrics | - **Splunk**: `index=email sourcetype=o365:audit Operation IN ("New-InboxRule", "Set-InboxRule") \| timechart span=1h count by UserId \| where count > avg(count)*4`.<br>- **KQL**: `OfficeActivity \| where Operation in ("New-InboxRule", "Set-InboxRule") \| summarize HourlyCount=count() by bin(TimeGenerated, 1h), UserId \| where HourlyCount > avg(HourlyCount) * 4`.<br>- **ELK**: `FROM logs-o365.audit-* \| WHERE event.operation IN ['New-InboxRule', 'Set-InboxRule'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), user.id \| WHERE COUNT() > AVG(COUNT()) * 4`. |
| 7. Forwarding Rules from Compromised Endpoints | Rules created from endpoints with suspicious processes, as in FIN7 leveraging compromised hosts.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (Sysmon ID 1)<br>- Email Audit Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*powershell.exe*", "*cmd.exe*") CommandLine="*mapi*" \| join host [search sourcetype=o365:audit Operation="New-InboxRule"] \| stats count by host, UserId \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("powershell.exe", "cmd.exe") and ProcessCommandLine contains "mapi" \| join kind=inner (OfficeActivity \| where Operation == "New-InboxRule") on DeviceName \| summarize count() by DeviceName, UserId \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("powershell.exe" OR "cmd.exe") AND process.args : "*mapi*" \| JOIN logs-o365.audit-* ON host.name WHERE event.operation = 'New-InboxRule' \| STATS COUNT() BY host.name, user.id HAVING COUNT() > 2`. |
| 8. Forwarding Rules with Hidden or Suspicious Names | Rules with unusual names (e.g., random strings) to hide malicious intent, as in Turla attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Email Audit Logs<br>- Rule Metadata | - **Splunk**: `index=email sourcetype=o365:audit Operation="New-InboxRule" AND RuleName IN ("*[0-9a-f]{8}*", "*temp*") \| stats count by UserId, RuleName \| where count > 1`.<br>- **KQL**: `OfficeActivity \| where Operation == "New-InboxRule" and RuleName matches regex "[0-9a-f]{8}" or RuleName contains "temp" \| summarize count() by UserId, RuleName \| where count_ > 1`.<br>- **ELK**: `FROM logs-o365.audit-* \| WHERE event.operation = 'New-InboxRule' AND rule.name : ("*[0-9a-f]{8}*" OR "*temp*") \| STATS COUNT() BY user.id, rule.name HAVING COUNT() > 1`. |
| 9. Email Forwarding to Internal Shadow Accounts | Rules forwarding to internal accounts created by adversaries, as in Volt Typhoon.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Email Audit Logs<br>- User Account Creation Logs | - **Splunk**: `index=email sourcetype=o365:audit Operation="New-InboxRule" AND Parameters="*ForwardTo*@tenant.com" \| join UserId [search sourcetype=azure:ad:audit Operation="Add user"] \| stats count by UserId, Parameters \| where count > 1`.<br>- **KQL**: `OfficeActivity \| where Operation == "New-InboxRule" and Parameters contains "ForwardTo" and Parameters contains "@tenant.com" \| join kind=inner (AADAudit \| where Operation == "Add user") on UserId \| summarize count() by UserId, Parameters \| where count_ > 1`.<br>- **ELK**: `FROM logs-o365.audit-* \| WHERE event.operation = 'New-InboxRule' AND event.parameters : "*ForwardTo*@tenant.com" \| JOIN logs-azure.audit-* ON user.id WHERE event.operation = 'Add user' \| STATS COUNT() BY user.id, event.parameters HAVING COUNT() > 1`. |
| 10. Forwarding Rules via PowerShell or EWS | Adversaries use PowerShell or Exchange Web Services (EWS) to create forwarding rules, as in FIN7.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (Sysmon ID 1 for PowerShell)<br>- Email Audit Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe" CommandLine="*New-InboxRule*" \| join host [search sourcetype=o365:audit Operation="New-InboxRule"] \| stats count by host, UserId \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "powershell.exe" and ProcessCommandLine contains "New-InboxRule" \| join kind=inner (OfficeActivity \| where Operation == "New-InboxRule") on DeviceName \| summarize count() by DeviceName, UserId \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name = "powershell.exe" AND process.args : "*New-InboxRule*" \| JOIN logs-o365.audit-* ON host.name WHERE event.operation = 'New-InboxRule' \| STATS COUNT() BY host.name, user.id HAVING COUNT() > 2`. |
| 11. Forwarding Rules with Suspicious Timing | Rules created outside normal business hours, indicating compromise, as in 2025 trends.<grok:render type="render_inline_citation"><argument name="citation_id">5</argument></grok:render> | - Email Audit Logs<br>- Timestamp Analysis | - **Splunk**: `index=email sourcetype=o365:audit Operation="New-InboxRule" AND _time<strptime("08:00", "%H:%M") OR _time>strptime("18:00", "%H:%M") \| stats count by UserId, _time \| where count > 1`.<br>- **KQL**: `OfficeActivity \| where Operation == "New-InboxRule" and (hourofday(TimeGenerated) < 8 or hourofday(TimeGenerated) > 18) \| summarize count() by UserId, TimeGenerated \| where count_ > 1`.<br>- **ELK**: `FROM logs-o365.audit-* \| WHERE event.operation = 'New-InboxRule' AND (HOUR_OF_DAY(@timestamp) < 8 OR HOUR_OF_DAY(@timestamp) > 18) \| STATS COUNT() BY user.id, @timestamp HAVING COUNT() > 1`. |
| 12. Forwarding Rules with High Email Volume | Rules triggering high volumes of forwarded emails, indicating bulk collection.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Email Audit Logs<br>- Message Trace Logs | - **Splunk**: `index=email sourcetype=o365:audit Operation="MailItemsAccessed" AND RuleName="*Forward*" \| stats count by UserId, RuleName \| where count > 100`.<br>- **KQL**: `OfficeActivity \| where Operation == "MailItemsAccessed" and RuleName contains "Forward" \| summarize count() by UserId, RuleName \| where count_ > 100`.<br>- **ELK**: `FROM logs-o365.audit-* \| WHERE event.operation = 'MailItemsAccessed' AND rule.name : "*Forward*" \| STATS COUNT() BY user.id, rule.name HAVING COUNT() > 100`. |
| 13. Forwarding Rules in Linux Email Clients | Adversaries create forwarding rules in Linux email clients (e.g., Thunderbird), as in general T1114.003.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - File Access (auditd for .thunderbird configs)<br>- Process Monitoring | - **Splunk**: `index=linux sourcetype=auditd syscall="openat" path="*/.thunderbird/*.ini" AND contents="*forward*" \| stats count by exe, path \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileModified" and FolderPath contains ".thunderbird" and AdditionalFields.Contents contains "forward" \| summarize count() by InitiatingProcessFolderPath, FolderPath \| where count_ > 3`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE syscall.name = "openat" AND file.path : "*/.thunderbird/*.ini" AND file.contents : "*forward*" \| STATS COUNT() BY process.exe, file.path HAVING COUNT() > 3`. |
| 14. Forwarding Rules via Compromised Cloud Apps | Rules created via compromised cloud app integrations, as in Nobelium OAuth abuse.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Cloud App Logs (Azure AD App Activity)<br>- Email Audit Logs | - **Splunk**: `index=cloud sourcetype=azure:ad:appactivity AppId NOT IN (known_apps) \| join UserId [search sourcetype=o365:audit Operation="New-InboxRule"] \| stats count by UserId, AppId \| where count > 1`.<br>- **KQL**: `AADAppActivity \| where AppId !in (knownApps) \| join kind=inner (OfficeActivity \| where Operation == "New-InboxRule") on UserId \| summarize count() by UserId, AppId \| where count_ > 1`.<br>- **ELK**: `FROM logs-azure.appactivity-* \| WHERE app.id NOT IN ['known_apps'] \| JOIN logs-o365.audit-* ON user.id WHERE event.operation = 'New-InboxRule' \| STATS COUNT() BY user.id, app.id HAVING COUNT() > 1`. |
| 15. Forwarding Rules with Suspicious Conditions | Rules with conditions targeting sensitive email content (e.g., keywords like "confidential"), as in Turla.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Email Audit Logs<br>- Rule Parameters | - **Splunk**: `index=email sourcetype=o365:audit Operation="New-InboxRule" AND Parameters IN ("*Subject:confidential*", "*From:executive*") \| stats count by UserId, Parameters \| where count > 1`.<br>- **KQL**: `OfficeActivity \| where Operation == "New-InboxRule" and Parameters has_any ("Subject:confidential", "From:executive") \| summarize count() by UserId, Parameters \| where count_ > 1`.<br>- **ELK**: `FROM logs-o365.audit-* \| WHERE event.operation = 'New-InboxRule' AND event.parameters : ("*Subject:confidential*" OR "*From:executive*") \| STATS COUNT() BY user.id, event.parameters HAVING COUNT() > 1`. |


### Evil Twin


| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Rogue Access Point with Similar SSID | Adversaries deploy rogue APs with SSIDs mimicking legitimate ones, as in APT28 Wi-Fi attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> High risk in enterprise Wi-Fi environments. | - Wireless Controller Logs (e.g., Cisco WLC, Aruba)<br>- Network Traffic (802.11 frames) | - **Splunk**: `index=wireless sourcetype=cisco:wlc event_type="rogue_detected" \| search SSID IN ("*corp_wifi*", "*guest_wifi*") AND BSSID NOT IN (known_bssids) \| stats count by SSID, BSSID \| where count > 5` (Detects rogue APs with similar SSIDs).<br>- **KQL**: `WirelessLogs \| where EventType == "rogue_detected" and SSID has_any ("corp_wifi", "guest_wifi") and BSSID !in (knownBSSIDs) \| summarize count() by SSID, BSSID \| where count_ > 5`.<br>- **ELK**: `FROM logs-wireless.wlc-* \| WHERE event.type = 'rogue_detected' AND wifi.ssid : ('*corp_wifi*' OR '*guest_wifi*') AND wifi.bssid NOT IN ['known_bssids'] \| STATS COUNT() BY wifi.ssid, wifi.bssid HAVING COUNT() > 5`. |
| 2. Anomalous Client Connections to Rogue APs | Endpoints connect to rogue APs with unexpected BSSIDs, indicating Evil Twin attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> Common in public Wi-Fi or enterprise networks. | - Wireless Client Logs (WLC association logs)<br>- Endpoint Network Events | - **Splunk**: `index=wireless sourcetype=cisco:wlc event_type="client_association" AND BSSID NOT IN (known_bssids) \| stats count by Client_MAC, BSSID, SSID \| where count > 3`.<br>- **KQL**: `WirelessLogs \| where EventType == "client_association" and BSSID !in (knownBSSIDs) \| summarize count() by ClientMAC, BSSID, SSID \| where count_ > 3`.<br>- **ELK**: `FROM logs-wireless.wlc-* \| WHERE event.type = 'client_association' AND wifi.bssid NOT IN ['known_bssids'] \| STATS COUNT() BY client.mac, wifi.bssid, wifi.ssid HAVING COUNT() > 3`. |
| 3. Credential Theft via Rogue AP | Adversaries capture credentials through rogue APs using fake captive portals, as in Wi-Fi phishing attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Network Traffic (Zeek HTTP for captive portal)<br>- Authentication Logs | - **Splunk**: `index=network sourcetype=zeek_http uri="*login*" AND host NOT IN (known_domains) AND src_ip IN (rogue_bssid_ips) \| stats count by src_ip, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteUrl contains "login" and RemoteUrl !has_any (knownDomains) and DeviceIP in (rogueBSSIDIPs) \| summarize count() by DeviceIP, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri : "*login*" AND http.host NOT IN ['known_domains'] AND source.ip IN ['rogue_bssid_ips'] \| STATS COUNT() BY source.ip, http.uri HAVING COUNT() > 10`. |
| 4. Rogue AP with Weak Encryption | Rogue APs use weak or no encryption (e.g., WEP, open Wi-Fi) to facilitate MITM, as in general T1557.002.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Wireless Controller Logs<br>- 802.11 Frame Analysis | - **Splunk**: `index=wireless sourcetype=cisco:wlc event_type="rogue_detected" encryption IN ("WEP", "none") \| stats count by SSID, BSSID, encryption \| where count > 2`.<br>- **KQL**: `WirelessLogs \| where EventType == "rogue_detected" and Encryption in ("WEP", "none") \| summarize count() by SSID, BSSID, Encryption \| where count_ > 2`.<br>- **ELK**: `FROM logs-wireless.wlc-* \| WHERE event.type = 'rogue_detected' AND wifi.encryption IN ['WEP', 'none'] \| STATS COUNT() BY wifi.ssid, wifi.bssid, wifi.encryption HAVING COUNT() > 2`. |
| 5. Rogue AP with High Signal Strength | Rogue APs broadcast with high signal strength to override legitimate APs, as in Evil Twin tactics.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Wireless Controller Logs (RSSI metrics)<br>- Rogue AP Detection | - **Splunk**: `index=wireless sourcetype=cisco:wlc event_type="rogue_detected" RSSI>-50 AND BSSID NOT IN (known_bssids) \| stats count by SSID, BSSID, RSSI \| where count > 3`.<br>- **KQL**: `WirelessLogs \| where EventType == "rogue_detected" and RSSI > -50 and BSSID !in (knownBSSIDs) \| summarize count() by SSID, BSSID, RSSI \| where count_ > 3`.<br>- **ELK**: `FROM logs-wireless.wlc-* \| WHERE event.type = 'rogue_detected' AND wifi.rssi > -50 AND wifi.bssid NOT IN ['known_bssids'] \| STATS COUNT() BY wifi.ssid, wifi.bssid, wifi.rssi HAVING COUNT() > 3`. |
| 6. Suspicious DNS Queries via Rogue AP | Devices connected to rogue APs send DNS queries to malicious or unknown resolvers, as in MITM attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - DNS Logs (Zeek DNS)<br>- Wireless Client Logs | - **Splunk**: `index=network sourcetype=zeek_dns query NOT IN (known_domains) AND src_ip IN (rogue_bssid_ips) \| stats count by src_ip, query \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and AdditionalFields.Query !in (knownDomains) and DeviceIP in (rogueBSSIDIPs) \| summarize count() by DeviceIP, AdditionalFields.Query \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE dns.query NOT IN ['known_domains'] AND source.ip IN ['rogue_bssid_ips'] \| STATS COUNT() BY source.ip, dns.query HAVING COUNT() > 10`. |
| 7. Rogue AP Connections from Compromised Endpoints | Endpoints with suspicious processes connect to rogue APs, indicating compromise, as in 2025 Wi-Fi attack trends.<grok:render type="render_inline_citation"><argument name="citation_id">5</argument></grok:render> | - Process Creation (Sysmon ID 1)<br>- Wireless Client Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*wifi*" OR Image="*netsh.exe" \| join host [search sourcetype=cisco:wlc event_type="client_association" BSSID NOT IN (known_bssids)] \| stats count by host, BSSID \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "wifi" or FolderPath endswith "netsh.exe" \| join kind=inner (WirelessLogs \| where EventType == "client_association" and BSSID !in (knownBSSIDs)) on DeviceName \| summarize count() by DeviceName, BSSID \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : "*wifi*" OR process.name = "netsh.exe" \| JOIN logs-wireless.wlc-* ON host.name WHERE event.type = 'client_association' AND wifi.bssid NOT IN ['known_bssids'] \| STATS COUNT() BY host.name, wifi.bssid HAVING COUNT() > 2`. |
| 8. Rogue AP Broadcasting Known SSID with Different Channel | Rogue APs mimic legitimate SSIDs but use different channels, as in Evil Twin setups.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Wireless Controller Logs<br>- Channel Metrics | - **Splunk**: `index=wireless sourcetype=cisco:wlc event_type="rogue_detected" SSID IN (known_ssids) AND Channel NOT IN (known_channels) \| stats count by SSID, Channel, BSSID \| where count > 3`.<br>- **KQL**: `WirelessLogs \| where EventType == "rogue_detected" and SSID in (knownSSIDs) and Channel !in (knownChannels) \| summarize count() by SSID, Channel, BSSID \| where count_ > 3`.<br>- **ELK**: `FROM logs-wireless.wlc-* \| WHERE event.type = 'rogue_detected' AND wifi.ssid IN ['known_ssids'] AND wifi.channel NOT IN ['known_channels'] \| STATS COUNT() BY wifi.ssid, wifi.channel, wifi.bssid HAVING COUNT() > 3`. |
| 9. Anomalous Traffic Patterns from Rogue APs | Rogue APs generate high volumes of traffic or unusual protocols, indicating data interception.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Network Traffic (Zeek conn logs)<br>- Wireless Traffic Metrics | - **Splunk**: `index=network sourcetype=zeek_conn src_ip IN (rogue_bssid_ips) bytes>1000000 \| stats sum(bytes) by src_ip, dest_ip \| where sum_bytes > 10000000`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceIP in (rogueBSSIDIPs) and AdditionalFields.Bytes > 1000000 \| summarize TotalBytes=sum(AdditionalFields.Bytes) by DeviceIP, RemoteIP \| where TotalBytes > 10000000`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE source.ip IN ['rogue_bssid_ips'] AND bytes > 1000000 \| STATS SUM(bytes) BY source.ip, destination.ip HAVING SUM(bytes) > 10000000`. |
| 10. Rogue AP in Cloud-Managed Wi-Fi | Adversaries deploy rogue APs in cloud-managed Wi-Fi environments (e.g., Meraki, Aruba Central), as in modern enterprise attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Cloud Wi-Fi Logs (Meraki/Aruba Central)<br>- Rogue AP Alerts | - **Splunk**: `index=cloud sourcetype=meraki:alert event_type="rogue_ap" AND SSID IN (known_ssids) \| stats count by SSID, BSSID \| where count > 2`.<br>- **KQL**: `MerakiLogs \| where EventType == "rogue_ap" and SSID in (knownSSIDs) \| summarize count() by SSID, BSSID \| where count_ > 2`.<br>- **ELK**: `FROM logs-meraki.alert-* \| WHERE event.type = 'rogue_ap' AND wifi.ssid IN ['known_ssids'] \| STATS COUNT() BY wifi.ssid, wifi.bssid HAVING COUNT() > 2`. |
| 11. Rogue AP with Spoofed MAC Address | Rogue APs use spoofed MAC addresses to mimic legitimate APs, as in advanced Evil Twin attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Wireless Controller Logs<br>- MAC Address Analysis | - **Splunk**: `index=wireless sourcetype=cisco:wlc event_type="rogue_detected" AND MAC_Address IN (known_bssids) AND SSID NOT IN (known_ssids) \| stats count by MAC_Address, SSID \| where count > 3`.<br>- **KQL**: `WirelessLogs \| where EventType == "rogue_detected" and MACAddress in (knownBSSIDs) and SSID !in (knownSSIDs) \| summarize count() by MACAddress, SSID \| where count_ > 3`.<br>- **ELK**: `FROM logs-wireless.wlc-* \| WHERE event.type = 'rogue_detected' AND wifi.mac IN ['known_bssids'] AND wifi.ssid NOT IN ['known_ssids'] \| STATS COUNT() BY wifi.mac, wifi.ssid HAVING COUNT() > 3`. |
| 12. Rogue AP Targeting IoT Devices | Rogue APs target IoT devices to intercept data, as in 2025 IoT attack trends.<grok:render type="render_inline_citation"><argument name="citation_id">5</argument></grok:render> | - IoT Device Logs<br>- Wireless Client Logs | - **Splunk**: `index=iot sourcetype=iot:log event="wifi_connect" AND BSSID NOT IN (known_bssids) \| stats count by device_id, BSSID \| where count > 2`.<br>- **KQL**: `IoTLogs \| where Event == "wifi_connect" and BSSID !in (knownBSSIDs) \| summarize count() by DeviceId, BSSID \| where count_ > 2`.<br>- **ELK**: `FROM logs-iot-* \| WHERE event.name = 'wifi_connect' AND wifi.bssid NOT IN ['known_bssids'] \| STATS COUNT() BY device.id, wifi.bssid HAVING COUNT() > 2`. |
| 13. Rogue AP with Suspicious Beacon Frames | Rogue APs broadcast excessive or malformed beacon frames, indicating malicious intent.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - 802.11 Frame Logs (Wireshark/PCAP)<br>- Wireless Controller Logs | - **Splunk**: `index=wireless sourcetype=pcap frame_type="beacon" AND BSSID NOT IN (known_bssids) \| timechart span=1m count by BSSID \| where count > 100`.<br>- **KQL**: `WirelessFrameLogs \| where FrameType == "beacon" and BSSID !in (knownBSSIDs) \| summarize BeaconCount=count() by bin(Timestamp, 1m), BSSID \| where BeaconCount > 100`.<br>- **ELK**: `FROM logs-wireless.pcap-* \| WHERE frame.type = 'beacon' AND wifi.bssid NOT IN ['known_bssids'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), wifi.bssid \| WHERE COUNT() > 100`. |
| 14. Rogue AP Correlated with Phishing Pages | Rogue APs host phishing pages to steal credentials, as in Wi-Fi phishing campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Network Traffic (Zeek HTTP)<br>- Wireless Client Logs | - **Splunk**: `index=network sourcetype=zeek_http uri="*login*" AND src_ip IN (rogue_bssid_ips) \| join src_ip [search sourcetype=cisco:wlc event_type="client_association"] \| stats count by src_ip, uri \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteUrl contains "login" and DeviceIP in (rogueBSSIDIPs) \| join kind=inner (WirelessLogs \| where EventType == "client_association") on DeviceIP \| summarize count() by DeviceIP, RemoteUrl \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri : "*login*" AND source.ip IN ['rogue_bssid_ips'] \| JOIN logs-wireless.wlc-* ON source.ip WHERE event.type = 'client_association' \| STATS COUNT() BY source.ip, http.uri HAVING COUNT() > 5`. |
| 15. Rogue AP in Cloud Environments | Rogue APs in cloud-managed environments (e.g., AWS EC2-hosted Wi-Fi), as in hybrid attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Cloud Audit Logs (AWS CloudTrail)<br>- Wireless Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="RunInstances" AND networkInterfaces="*wireless*" \| join instanceId [search sourcetype=cisco:wlc event_type="rogue_detected"] \| stats count by instanceId, BSSID \| where count > 2`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "RunInstances" and NetworkInterfaces contains "wireless" \| join kind=inner (WirelessLogs \| where EventType == "rogue_detected") on DeviceName \| summarize count() by DeviceName, BSSID \| where count_ > 2`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'RunInstances' AND network.interfaces : "*wireless*" \| JOIN logs-wireless.wlc-* ON host.id WHERE event.type = 'rogue_detected' \| STATS COUNT() BY host.id, wifi.bssid HAVING COUNT() > 2`. |


### GUI Input Capture


| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Suspicious GUI Process Capturing Keystrokes | Adversaries deploy keyloggers disguised as legitimate GUI applications to capture keystrokes, as in Carbanak attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> High risk in Windows environments with unmonitored applications. | - Process Creation (Sysmon Event ID 1)<br>- Keyboard Hook Events (Sysmon ID 13) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image NOT IN ("*\\Windows\\*", "*\\Program Files\\*") AND CommandLine="*keylog*" OR CommandLine="*SetWindowsHookEx*" \| stats count by Image, CommandLine, host \| where count > 3` (Detects non-system processes using keylogging APIs).<br>- **KQL**: `DeviceProcessEvents \| where FolderPath !has_any ("Windows", "Program Files") and ProcessCommandLine has_any ("keylog", "SetWindowsHookEx") \| summarize count() by FolderPath, ProcessCommandLine, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE NOT process.executable : ("*Windows*" OR "*Program Files*") AND process.command_line : ("*keylog*" OR "*SetWindowsHookEx*") \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 3`. |
| 2. Fake Login Prompts for Credential Theft | Adversaries display fake GUI login prompts to capture credentials, as in FIN7 phishing campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> Common in Windows and Linux desktops. | - Process Creation (Sysmon ID 1 for GUI apps)<br>- Window Title Logs (Sysmon ID 13) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe") AND CommandLine="*login*" OR WindowTitle IN ("*Login*", "*Sign In*") AND Image NOT IN (known_apps) \| stats count by Image, WindowTitle, host \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith ".exe" and (ProcessCommandLine contains "login" or AdditionalFields.WindowTitle has_any ("Login", "Sign In")) and FolderPath !in (knownApps) \| summarize count() by FolderPath, AdditionalFields.WindowTitle, DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*.exe" AND (process.command_line : "*login*" OR window.title : ("*Login*" OR "*Sign In*")) AND process.executable NOT IN ['known_apps'] \| STATS COUNT() BY process.executable, window.title, host.name HAVING COUNT() > 2`. |
| 3. GUI Input Capture via Remote Desktop Tools | Adversaries use remote desktop tools (e.g., AnyDesk) to capture GUI input, as in Turla campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (Sysmon ID 1 for RDP tools)<br>- Network Traffic (Zeek conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*anydesk.exe*", "*teamviewer.exe*") \| join host [search index=network sourcetype=zeek_conn dest_port IN (3389, 5938)] \| stats count by Image, dest_ip, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("anydesk.exe", "teamviewer.exe") \| join kind=inner (DeviceNetworkEvents \| where RemotePort in (3389, 5938)) on DeviceName \| summarize count() by FolderPath, RemoteIP, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("anydesk.exe" OR "teamviewer.exe") \| JOIN logs-zeek.conn-* ON host.name WHERE destination.port IN [3389, 5938] \| STATS COUNT() BY process.name, destination.ip, host.name HAVING COUNT() > 3`. |
| 4. GUI Input Capture in Linux Environments | Adversaries deploy keyloggers or GUI tools on Linux to capture input, as in general T1056.002.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Execution (auditd execve)<br>- X11 Event Logs | - **Splunk**: `index=linux sourcetype=auditd syscall="execve" AND exe IN ("*xinput*", "*xev*") AND NOT exe IN (legit_apps) \| stats count by exe, a0, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where ActionType == "ProcessCreated" and InitiatingProcessFolderPath has_any ("xinput", "xev") and InitiatingProcessFolderPath !in (legitApps) \| summarize count() by InitiatingProcessFolderPath, ProcessCommandLine, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE syscall.name = "execve" AND process.exe : ("*xinput*" OR "*xev*") AND process.exe NOT IN ['legit_apps'] \| STATS COUNT() BY process.exe, process.args[0], host.name HAVING COUNT() > 3`. |
| 5. GUI Input Capture via Browser Extensions | Adversaries use malicious browser extensions to capture form inputs, as in 2025 malware trends.<grok:render type="render_inline_citation"><argument name="citation_id">5</argument></grok:render> | - Browser Extension Logs<br>- Process Creation (Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*chrome.exe*", "*firefox.exe*") AND CommandLine="*extension*" AND CommandLine="*keylog*" \| stats count by Image, CommandLine, host \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("chrome.exe", "firefox.exe") and ProcessCommandLine has_any ("extension", "keylog") \| summarize count() by FolderPath, ProcessCommandLine, DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("chrome.exe" OR "firefox.exe") AND process.command_line : ("*extension*" AND "*keylog*") \| STATS COUNT() BY process.name, process.command_line, host.name HAVING COUNT() > 2`. |
| 6. Suspicious GUI Processes with Network Activity | GUI processes capturing input and sending data over the network, indicating exfiltration, as in FIN7.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (Sysmon ID 1)<br>- Network Traffic (Sysmon ID 3) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*SetWindowsHookEx*" \| join ProcessGuid [search EventCode=3 DestinationPort=443] \| stats count by ProcessGuid, DestinationIp, host \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "SetWindowsHookEx" \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 443) on ProcessId \| summarize count() by ProcessId, RemoteIP, DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : "*SetWindowsHookEx*" \| JOIN logs-endpoint.network-* ON process.pid WHERE destination.port = 443 \| STATS COUNT() BY process.pid, destination.ip, host.name HAVING COUNT() > 2`. |
| 7. GUI Input Capture via Cloud-Based Applications | Adversaries use cloud-based GUI apps (e.g., compromised SaaS) to capture input, as in Nobelium attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Cloud Audit Logs (Azure AD App Activity)<br>- Network Traffic | - **Splunk**: `index=cloud sourcetype=azure:ad:appactivity AppId NOT IN (known_apps) AND Operation="*input*" \| join UserId [search index=network sourcetype=zeek_http uri="*form*"] \| stats count by UserId, AppId \| where count > 2`.<br>- **KQL**: `AADAppActivity \| where AppId !in (knownApps) and Operation contains "input" \| join kind=inner (DeviceNetworkEvents \| where RemoteUrl contains "form") on UserId \| summarize count() by UserId, AppId \| where count_ > 2`.<br>- **ELK**: `FROM logs-azure.appactivity-* \| WHERE app.id NOT IN ['known_apps'] AND event.operation : "*input*" \| JOIN logs-zeek.http-* ON user.id WHERE http.uri : "*form*" \| STATS COUNT() BY user.id, app.id HAVING COUNT() > 2`. |
| 8. GUI Input Capture with Anomalous Window Titles | Suspicious processes displaying windows with titles mimicking legitimate apps, as in phishing campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Window Title Logs (Sysmon ID 13)<br>- Process Creation | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=13 WindowTitle IN ("*Login*", "*Password*") AND Image NOT IN ("*outlook.exe*", "*chrome.exe*") \| stats count by Image, WindowTitle, host \| where count > 3`.<br>- **KQL**: `DeviceRegistryEvents \| where AdditionalFields.WindowTitle has_any ("Login", "Password") and FolderPath !has_any ("outlook.exe", "chrome.exe") \| summarize count() by FolderPath, AdditionalFields.WindowTitle, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.registry-* \| WHERE window.title : ("*Login*" OR "*Password*") AND process.executable NOT IN ['outlook.exe', 'chrome.exe'] \| STATS COUNT() BY process.executable, window.title, host.name HAVING COUNT() > 3`. |
| 9. GUI Input Capture in macOS Environments | Adversaries deploy keyloggers or fake prompts on macOS, as in general T1056.002.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Unified Logs (macOS)<br>- Process Monitoring | - **Splunk**: `index=macos sourcetype=macos:unified event_type="exec" AND process IN ("*keylog*", "*prompt*") AND NOT process IN (legit_apps) \| stats count by process, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where ActionType == "ProcessCreated" and InitiatingProcessName has_any ("keylog", "prompt") and InitiatingProcessName !in (legitApps) \| summarize count() by InitiatingProcessName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-macos.unified-* \| WHERE event.type = 'exec' AND process.name : ("*keylog*" OR "*prompt*") AND process.name NOT IN ['legit_apps'] \| STATS COUNT() BY process.name, host.name HAVING COUNT() > 3`. |
| 10. GUI Input Capture with High CPU Usage | Processes capturing GUI input consume high CPU, indicating keylogging or screen scraping.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Performance Metrics (Windows/Linux)<br>- Process Creation | - **Splunk**: `index=endpoint sourcetype=perfmon CPU>80 AND Image NOT IN (known_apps) \| join Image [search sourcetype=sysmon EventCode=1 CommandLine="*keylog*"] \| stats count by Image, host \| where count > 2`.<br>- **KQL**: `DevicePerformanceEvents \| where CPUUsage > 80 and FolderPath !in (knownApps) \| join kind=inner (DeviceProcessEvents \| where ProcessCommandLine contains "keylog") on FolderPath \| summarize count() by FolderPath, DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.performance-* \| WHERE cpu.usage > 80 AND process.executable NOT IN ['known_apps'] \| JOIN logs-endpoint.process-* ON process.executable WHERE process.command_line : "*keylog*" \| STATS COUNT() BY process.executable, host.name HAVING COUNT() > 2`. |
| 11. GUI Input Capture via Scripting Languages | Adversaries use Python or PowerShell scripts to capture GUI input, as in 2025 malware trends.<grok:render type="render_inline_citation"><argument name="citation_id">5</argument></grok:render> | - Process Creation (Sysmon ID 1 for scripts)<br>- Script Execution Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*python.exe*", "*powershell.exe*") AND CommandLine="*keyboard*" OR CommandLine="*mouse*" \| stats count by Image, CommandLine, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("python.exe", "powershell.exe") and ProcessCommandLine has_any ("keyboard", "mouse") \| summarize count() by FolderPath, ProcessCommandLine, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("python.exe" OR "powershell.exe") AND process.command_line : ("*keyboard*" OR "*mouse*") \| STATS COUNT() BY process.name, process.command_line, host.name HAVING COUNT() > 3`. |
| 12. GUI Input Capture in Cloud VMs | Adversaries deploy GUI capture tools in cloud VMs (e.g., AWS EC2), as in hybrid attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Cloud Audit Logs (AWS CloudTrail)<br>- Endpoint Process Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="RunInstances" AND userAgent="*gui*" \| join instanceId [search sourcetype=sysmon EventCode=1 CommandLine="*keylog*"] \| stats count by instanceId, CommandLine \| where count > 2`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "RunInstances" and UserAgent contains "gui" \| join kind=inner (DeviceProcessEvents \| where ProcessCommandLine contains "keylog") on DeviceName \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 2`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'RunInstances' AND user_agent : "*gui*" \| JOIN logs-endpoint.process-* ON host.id WHERE process.command_line : "*keylog*" \| STATS COUNT() BY host.id, process.command_line HAVING COUNT() > 2`. |
| 13. GUI Input Capture with Anomalous User Behavior | Users exhibit unusual input patterns (e.g., rapid typing) linked to keyloggers, as in behavioral analytics.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - User Behavior Analytics (UBA)<br>- Endpoint Logs | - **Splunk**: `index=security sourcetype=uba:anomaly event_type="input_anomaly" AND user NOT IN (known_users) \| join user [search sourcetype=sysmon EventCode=1 "*keylog*"] \| stats count by user, host \| where count > 2`.<br>- **KQL**: `UbaAnomalies \| where EventType == "input_anomaly" and User !in (knownUsers) \| join kind=inner (DeviceProcessEvents \| where ProcessCommandLine contains "keylog") on UserId \| summarize count() by UserId, DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-uba.anomaly-* \| WHERE event.type = 'input_anomaly' AND user.name NOT IN ['known_users'] \| JOIN logs-endpoint.process-* ON user.id WHERE process.command_line : "*keylog*" \| STATS COUNT() BY user.id, host.name HAVING COUNT() > 2`. |
| 14. GUI Input Capture via Malicious Dialog Boxes | Adversaries use dialog boxes to capture input, as in phishing campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (Sysmon ID 1)<br>- Window Event Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*MessageBox*" OR CommandLine="*dialog*" AND Image NOT IN (known_apps) \| stats count by Image, CommandLine, host \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("MessageBox", "dialog") and FolderPath !in (knownApps) \| summarize count() by FolderPath, ProcessCommandLine, DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*MessageBox*" OR "*dialog*") AND process.executable NOT IN ['known_apps'] \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 2`. |
| 15. GUI Input Capture with File Exfiltration | GUI capture tools save input to files followed by network exfiltration, as in FIN7.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - File Creation (Sysmon ID 11)<br>- Network Traffic (Sysmon ID 3) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename="*keylog*.txt" \| join ProcessGuid [search EventCode=3 DestinationPort=443] \| stats count by TargetFilename, DestinationIp, host \| where count > 2`.<br>- **KQL**: `DeviceFileEvents \| where FileName contains "keylog" and FileName endswith ".txt" \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 443) on ProcessId \| summarize count() by FileName, RemoteIP, DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : "*keylog*.txt" \| JOIN logs-endpoint.network-* ON process.pid WHERE destination.port = 443 \| STATS COUNT() BY file.name, destination.ip, host.name HAVING COUNT() > 2`. |


### Input Capture


| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Suspicious GUI Process Capturing Keystrokes | Adversaries deploy keyloggers disguised as legitimate GUI applications to capture keystrokes, as in Carbanak attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> High risk in Windows environments with unmonitored applications. | - Process Creation (Sysmon Event ID 1)<br>- Keyboard Hook Events (Sysmon ID 13) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image NOT IN ("*\\Windows\\*", "*\\Program Files\\*") AND CommandLine="*keylog*" OR CommandLine="*SetWindowsHookEx*" \| stats count by Image, CommandLine, host \| where count > 3` (Detects non-system processes using keylogging APIs).<br>- **KQL**: `DeviceProcessEvents \| where FolderPath !has_any ("Windows", "Program Files") and ProcessCommandLine has_any ("keylog", "SetWindowsHookEx") \| summarize count() by FolderPath, ProcessCommandLine, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE NOT process.executable : ("*Windows*" OR "*Program Files*") AND process.command_line : ("*keylog*" OR "*SetWindowsHookEx*") \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 3`. |
| 2. Fake Login Prompts for Credential Theft | Adversaries display fake GUI login prompts to capture credentials, as in FIN7 phishing campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> Common in Windows and Linux desktops. | - Process Creation (Sysmon ID 1 for GUI apps)<br>- Window Title Logs (Sysmon ID 13) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*.exe") AND CommandLine="*login*" OR WindowTitle IN ("*Login*", "*Sign In*") AND Image NOT IN (known_apps) \| stats count by Image, WindowTitle, host \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith ".exe" and (ProcessCommandLine contains "login" or AdditionalFields.WindowTitle has_any ("Login", "Sign In")) and FolderPath !in (knownApps) \| summarize count() by FolderPath, AdditionalFields.WindowTitle, DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : "*.exe" AND (process.command_line : "*login*" OR window.title : ("*Login*" OR "*Sign In*")) AND process.executable NOT IN ['known_apps'] \| STATS COUNT() BY process.executable, window.title, host.name HAVING COUNT() > 2`. |
| 3. GUI Input Capture via Remote Desktop Tools | Adversaries use remote desktop tools (e.g., AnyDesk) to capture GUI input, as in Turla campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (Sysmon ID 1 for RDP tools)<br>- Network Traffic (Zeek conn) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*anydesk.exe*", "*teamviewer.exe*") \| join host [search index=network sourcetype=zeek_conn dest_port IN (3389, 5938)] \| stats count by Image, dest_ip, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("anydesk.exe", "teamviewer.exe") \| join kind=inner (DeviceNetworkEvents \| where RemotePort in (3389, 5938)) on DeviceName \| summarize count() by FolderPath, RemoteIP, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("anydesk.exe" OR "teamviewer.exe") \| JOIN logs-zeek.conn-* ON host.name WHERE destination.port IN [3389, 5938] \| STATS COUNT() BY process.name, destination.ip, host.name HAVING COUNT() > 3`. |
| 4. GUI Input Capture in Linux Environments | Adversaries deploy keyloggers or GUI tools on Linux to capture input, as in general T1056.002.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Execution (auditd execve)<br>- X11 Event Logs | - **Splunk**: `index=linux sourcetype=auditd syscall="execve" AND exe IN ("*xinput*", "*xev*") AND NOT exe IN (legit_apps) \| stats count by exe, a0, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where ActionType == "ProcessCreated" and InitiatingProcessFolderPath has_any ("xinput", "xev") and InitiatingProcessFolderPath !in (legitApps) \| summarize count() by InitiatingProcessFolderPath, ProcessCommandLine, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE syscall.name = "execve" AND process.exe : ("*xinput*" OR "*xev*") AND process.exe NOT IN ['legit_apps'] \| STATS COUNT() BY process.exe, process.args[0], host.name HAVING COUNT() > 3`. |
| 5. GUI Input Capture via Browser Extensions | Adversaries use malicious browser extensions to capture form inputs, as in 2025 malware trends.<grok:render type="render_inline_citation"><argument name="citation_id">5</argument></grok:render> | - Browser Extension Logs<br>- Process Creation (Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*chrome.exe*", "*firefox.exe*") AND CommandLine="*extension*" AND CommandLine="*keylog*" \| stats count by Image, CommandLine, host \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("chrome.exe", "firefox.exe") and ProcessCommandLine has_any ("extension", "keylog") \| summarize count() by FolderPath, ProcessCommandLine, DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("chrome.exe" OR "firefox.exe") AND process.command_line : ("*extension*" AND "*keylog*") \| STATS COUNT() BY process.name, process.command_line, host.name HAVING COUNT() > 2`. |
| 6. Suspicious GUI Processes with Network Activity | GUI processes capturing input and sending data over the network, indicating exfiltration, as in FIN7.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (Sysmon ID 1)<br>- Network Traffic (Sysmon ID 3) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*SetWindowsHookEx*" \| join ProcessGuid [search EventCode=3 DestinationPort=443] \| stats count by ProcessGuid, DestinationIp, host \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "SetWindowsHookEx" \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 443) on ProcessId \| summarize count() by ProcessId, RemoteIP, DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : "*SetWindowsHookEx*" \| JOIN logs-endpoint.network-* ON process.pid WHERE destination.port = 443 \| STATS COUNT() BY process.pid, destination.ip, host.name HAVING COUNT() > 2`. |
| 7. GUI Input Capture via Cloud-Based Applications | Adversaries use cloud-based GUI apps (e.g., compromised SaaS) to capture input, as in Nobelium attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Cloud Audit Logs (Azure AD App Activity)<br>- Network Traffic | - **Splunk**: `index=cloud sourcetype=azure:ad:appactivity AppId NOT IN (known_apps) AND Operation="*input*" \| join UserId [search index=network sourcetype=zeek_http uri="*form*"] \| stats count by UserId, AppId \| where count > 2`.<br>- **KQL**: `AADAppActivity \| where AppId !in (knownApps) and Operation contains "input" \| join kind=inner (DeviceNetworkEvents \| where RemoteUrl contains "form") on UserId \| summarize count() by UserId, AppId \| where count_ > 2`.<br>- **ELK**: `FROM logs-azure.appactivity-* \| WHERE app.id NOT IN ['known_apps'] AND event.operation : "*input*" \| JOIN logs-zeek.http-* ON user.id WHERE http.uri : "*form*" \| STATS COUNT() BY user.id, app.id HAVING COUNT() > 2`. |
| 8. GUI Input Capture with Anomalous Window Titles | Suspicious processes displaying windows with titles mimicking legitimate apps, as in phishing campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Window Title Logs (Sysmon ID 13)<br>- Process Creation | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=13 WindowTitle IN ("*Login*", "*Password*") AND Image NOT IN ("*outlook.exe*", "*chrome.exe*") \| stats count by Image, WindowTitle, host \| where count > 3`.<br>- **KQL**: `DeviceRegistryEvents \| where AdditionalFields.WindowTitle has_any ("Login", "Password") and FolderPath !has_any ("outlook.exe", "chrome.exe") \| summarize count() by FolderPath, AdditionalFields.WindowTitle, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.registry-* \| WHERE window.title : ("*Login*" OR "*Password*") AND process.executable NOT IN ['outlook.exe', 'chrome.exe'] \| STATS COUNT() BY process.executable, window.title, host.name HAVING COUNT() > 3`. |
| 9. GUI Input Capture in macOS Environments | Adversaries deploy keyloggers or fake prompts on macOS, as in general T1056.002.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Unified Logs (macOS)<br>- Process Monitoring | - **Splunk**: `index=macos sourcetype=macos:unified event_type="exec" AND process IN ("*keylog*", "*prompt*") AND NOT process IN (legit_apps) \| stats count by process, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where ActionType == "ProcessCreated" and InitiatingProcessName has_any ("keylog", "prompt") and InitiatingProcessName !in (legitApps) \| summarize count() by InitiatingProcessName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-macos.unified-* \| WHERE event.type = 'exec' AND process.name : ("*keylog*" OR "*prompt*") AND process.name NOT IN ['legit_apps'] \| STATS COUNT() BY process.name, host.name HAVING COUNT() > 3`. |
| 10. GUI Input Capture with High CPU Usage | Processes capturing GUI input consume high CPU, indicating keylogging or screen scraping.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Performance Metrics (Windows/Linux)<br>- Process Creation | - **Splunk**: `index=endpoint sourcetype=perfmon CPU>80 AND Image NOT IN (known_apps) \| join Image [search sourcetype=sysmon EventCode=1 CommandLine="*keylog*"] \| stats count by Image, host \| where count > 2`.<br>- **KQL**: `DevicePerformanceEvents \| where CPUUsage > 80 and FolderPath !in (knownApps) \| join kind=inner (DeviceProcessEvents \| where ProcessCommandLine contains "keylog") on FolderPath \| summarize count() by FolderPath, DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.performance-* \| WHERE cpu.usage > 80 AND process.executable NOT IN ['known_apps'] \| JOIN logs-endpoint.process-* ON process.executable WHERE process.command_line : "*keylog*" \| STATS COUNT() BY process.executable, host.name HAVING COUNT() > 2`. |
| 11. GUI Input Capture via Scripting Languages | Adversaries use Python or PowerShell scripts to capture GUI input, as in 2025 malware trends.<grok:render type="render_inline_citation"><argument name="citation_id">5</argument></grok:render> | - Process Creation (Sysmon ID 1 for scripts)<br>- Script Execution Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*python.exe*", "*powershell.exe*") AND CommandLine="*keyboard*" OR CommandLine="*mouse*" \| stats count by Image, CommandLine, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("python.exe", "powershell.exe") and ProcessCommandLine has_any ("keyboard", "mouse") \| summarize count() by FolderPath, ProcessCommandLine, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("python.exe" OR "powershell.exe") AND process.command_line : ("*keyboard*" OR "*mouse*") \| STATS COUNT() BY process.name, process.command_line, host.name HAVING COUNT() > 3`. |
| 12. GUI Input Capture in Cloud VMs | Adversaries deploy GUI capture tools in cloud VMs (e.g., AWS EC2), as in hybrid attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Cloud Audit Logs (AWS CloudTrail)<br>- Endpoint Process Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="RunInstances" AND userAgent="*gui*" \| join instanceId [search sourcetype=sysmon EventCode=1 CommandLine="*keylog*"] \| stats count by instanceId, CommandLine \| where count > 2`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "RunInstances" and UserAgent contains "gui" \| join kind=inner (DeviceProcessEvents \| where ProcessCommandLine contains "keylog") on DeviceName \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 2`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'RunInstances' AND user_agent : "*gui*" \| JOIN logs-endpoint.process-* ON host.id WHERE process.command_line : "*keylog*" \| STATS COUNT() BY host.id, process.command_line HAVING COUNT() > 2`. |
| 13. GUI Input Capture with Anomalous User Behavior | Users exhibit unusual input patterns (e.g., rapid typing) linked to keyloggers, as in behavioral analytics.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - User Behavior Analytics (UBA)<br>- Endpoint Logs | - **Splunk**: `index=security sourcetype=uba:anomaly event_type="input_anomaly" AND user NOT IN (known_users) \| join user [search sourcetype=sysmon EventCode=1 "*keylog*"] \| stats count by user, host \| where count > 2`.<br>- **KQL**: `UbaAnomalies \| where EventType == "input_anomaly" and User !in (knownUsers) \| join kind=inner (DeviceProcessEvents \| where ProcessCommandLine contains "keylog") on UserId \| summarize count() by UserId, DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-uba.anomaly-* \| WHERE event.type = 'input_anomaly' AND user.name NOT IN ['known_users'] \| JOIN logs-endpoint.process-* ON user.id WHERE process.command_line : "*keylog*" \| STATS COUNT() BY user.id, host.name HAVING COUNT() > 2`. |
| 14. GUI Input Capture via Malicious Dialog Boxes | Adversaries use dialog boxes to capture input, as in phishing campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (Sysmon ID 1)<br>- Window Event Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*MessageBox*" OR CommandLine="*dialog*" AND Image NOT IN (known_apps) \| stats count by Image, CommandLine, host \| where count > 2`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("MessageBox", "dialog") and FolderPath !in (knownApps) \| summarize count() by FolderPath, ProcessCommandLine, DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*MessageBox*" OR "*dialog*") AND process.executable NOT IN ['known_apps'] \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 2`. |
| 15. GUI Input Capture with File Exfiltration | GUI capture tools save input to files followed by network exfiltration, as in FIN7.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - File Creation (Sysmon ID 11)<br>- Network Traffic (Sysmon ID 3) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename="*keylog*.txt" \| join ProcessGuid [search EventCode=3 DestinationPort=443] \| stats count by TargetFilename, DestinationIp, host \| where count > 2`.<br>- **KQL**: `DeviceFileEvents \| where FileName contains "keylog" and FileName endswith ".txt" \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 443) on ProcessId \| summarize count() by FileName, RemoteIP, DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : "*keylog*.txt" \| JOIN logs-endpoint.network-* ON process.pid WHERE destination.port = 443 \| STATS COUNT() BY file.name, destination.ip, host.name HAVING COUNT() > 2`. |


### Keylogging

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. API Hooking for Keystroke Capture | Adversaries hook APIs like SetWindowsHookEx to intercept keystrokes, as in APT28 campaigns. High risk in Windows with unmonitored API calls. | - Process Monitoring (DS0009: OS API Execution)<br>- API Call Logs (ETW Traces) | - **Splunk**: `index=endpoint sourcetype=etw \| search CallTrace="*SetWindowsHookEx*" AND ProcessName NOT IN (legit_apps) \| stats count by ProcessName \| where count > 5` (Detects suspicious API hooking for keylogging).<br>- **KQL**: `DeviceEvents \| where ActionType == "ApiCall" and AdditionalFields.CallName == "SetWindowsHookEx" and not(InitiatingProcessName in~ (legitApps)) \| summarize count() by InitiatingProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-etw-* \| WHERE event.action = 'apicall' AND trace.call = "*SetWindowsHookEx*" AND process.name NOT IN ['explorer.exe'] \| STATS COUNT() BY process.name HAVING COUNT() > 5`. |
| 2. Registry Modifications for Keylogger Persistence | Adversaries modify registry keys to load keyloggers at startup, as seen in HEXANE malware. Common in Windows for persistence. | - Windows Registry (DS0024: Windows Registry Key Modification)<br>- Registry Access Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=13 RegistryKey IN ("*Run*", "*RunOnce*") AND Details="*keylog*" \| stats count by RegistryKey, Details, host \| where count > 3`.<br>- **KQL**: `DeviceRegistryEvents \| where RegistryKey has_any ("Run", "RunOnce") and RegistryValueData contains "keylog" \| summarize count() by RegistryKey, RegistryValueData, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.events.registry-* \| WHERE registry.key : ("*Run*" OR "*RunOnce*") AND registry.data : "*keylog*" \| STATS COUNT() BY registry.key, registry.data, host.name HAVING COUNT() > 3`. |
| 3. Custom Driver Loads for Hardware Keylogging | Adversaries load custom drivers to capture raw keystrokes, as in KGH_SPY malware. | - Driver Load (DS0027: Driver Load)<br>- Sysmon Event ID 6 | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=6 ImageLoaded="*.sys" AND Hashes="unknown" \| stats count by ImageLoaded, host \| where count > 2`.<br>- **KQL**: `DeviceDriverEvents \| where ActionType == "DriverLoaded" and FolderPath endswith ".sys" and SHA256 == "unknown" \| summarize count() by FolderPath, DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.events.driver-* \| WHERE event.action = 'load' AND driver.name : "*.sys" AND driver.hash = "unknown" \| STATS COUNT() BY driver.name, host.name HAVING COUNT() > 2`. |
| 4. PowerShell-Based Keyloggers | Adversaries use PowerShell scripts for keylogging, as in BabyShark malware. High risk in Windows with script execution. | - Process Monitoring (DS0009: Command Execution)<br>- Script Block Logging | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe*" CommandLine IN ("*GetKeyState*", "*SetWindowsHookEx*") \| stats count by host, CommandLine \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath endswith "powershell.exe" and ProcessCommandLine has_any ("GetKeyState", "SetWindowsHookEx") \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name = "powershell.exe" AND process.command_line : ("*GetKeyState*" OR "*SetWindowsHookEx*") \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 3`. |
| 5. Keylogging After Browser Cookie Clearing | Adversaries clear cookies to force re-authentication and capture keystrokes, as in Kimsuky malware. | - File Modification (DS0022: File Deletion)<br>- Process Monitoring | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=23 TargetFilename="*cookies*" \| transaction ProcessGuid maxspan=5m [search EventCode=1 "*keylog*"] \| where eventcount > 1 \| table _time, host, TargetFilename`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileDeleted" and FolderPath contains "cookies" \| join kind=inner (DeviceProcessEvents \| where ProcessCommandLine contains "keylog") on ProcessId \| project Timestamp, DeviceName, FileName`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'deletion' AND file.path : "*cookies*" \| JOIN logs-endpoint.process-* ON process.pid WHERE process.command_line : "*keylog*" \| TABLE @timestamp, host.name, file.name`. |
| 6. Keylogging on Network Devices | Adversaries use keylogging on network devices to capture login sessions, as in Modify System Image (T1601) techniques. | - Network Device Logs (CLI commands)<br>- Device Configuration Changes | - **Splunk**: `index=network sourcetype=cisco:ios "login" OR "keylog" \| stats count by user, host \| where count > 3`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Command has_any ("login", "keylog") \| summarize count() by InitiatingProcessAccountName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-cisco.ios-* \| WHERE message : ("*login*" OR "*keylog*") \| STATS COUNT() BY user.name, host.name HAVING COUNT() > 3`. |
| 3. Bulk Data Dumps from Config Repos | Adversaries dump large volumes of config data (e.g., via custom tools), as in APT41. | - Process Execution (Sysmon ID 1 for dump tools)<br>- File Creation (ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*dump config*", "*export repo*") \| stats count by host, CommandLine \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("dump config", "export repo") \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : ("*dump*config*" OR "*export*repo*") \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 3`. |
| 4. Cloud Config Service Misuse | Adversaries query cloud config services like AWS SSM or Azure App Configuration with stolen roles. | - Cloud Audit Logs (AWS CloudTrail, Azure Activity)<br>- Parameter Store Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("GetParameter", "GetParameters") AND userIdentity NOT IN (authorized) \| stats count by userIdentity, parameterName \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("GetParameter", "GetParameters") and Caller !in (authorizedUsers) \| summarize count() by Caller, ParameterName \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['GetParameter', 'GetParameters'] AND user.identity NOT IN ['admin'] \| STATS COUNT() BY user.identity, parameter.name HAVING COUNT() > 10`. |
| 5. Config Repo Access from Compromised Endpoints | Adversaries access repos from unusual endpoints, indicating lateral movement. | - Network Traffic (Zeek HTTP for repo URLs)<br>- Endpoint Logs | - **Splunk**: `index=network sourcetype=zeek_http uri IN ("*puppetmaster*", "*ansible-tower*") AND src_ip NOT IN (known_endpoints) \| stats count by src_ip, uri \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteUrl has_any ("puppetmaster", "ansible-tower") and RemoteIP !in (knownEndpoints) \| summarize count() by RemoteIP, RemoteUrl \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri : ("*puppetmaster*" OR "*ansible-tower*") AND source.ip NOT IN ['known_ips'] \| STATS COUNT() BY source.ip, http.uri HAVING COUNT() > 5`. |
| 6. Anomalous Config Query Patterns | High-frequency queries to config repos, suggesting automated dumping. | - API Logs (Puppet/Ansible query logs)<br>- Usage Metrics | - **Splunk**: `index=config_repo sourcetype=ansible:audit "query" \| timechart span=1h count \| where count > avg(count)*4`.<br>- **KQL**: `AnsibleAuditLogs \| where Action == "query" \| summarize HourlyCount=count() by bin(Timestamp, 1h) \| where HourlyCount > avg(HourlyCount) * 4`.<br>- **ELK**: `FROM logs-ansible.audit-* \| WHERE event.action = 'query' \| STATS COUNT() BY date_histogram(@timestamp, '1h') \| WHERE COUNT() > AVG(COUNT()) * 4`. |
| 7. Credential Extraction from Config Files | Adversaries extract creds from config files (e.g., ansible-vault), as in post-compromise. | - File Access (Sysmon ID 11)<br>- Command Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename="*ansible-vault*" OR "*puppet-vars*" \| stats count by TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileAccessed" and FileName has_any ("ansible-vault", "puppet-vars") \| summarize count() by FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = 'access' AND file.name : ("*ansible-vault*" OR "*puppet-vars*") \| STATS COUNT() BY file.name, host.name HAVING COUNT() > 3`. |
| 8. Config Repo Access Correlated with Lateral Movement | Config access after lateral movement (e.g., PsExec), indicating reconnaissance. | - Process Creation (Sysmon ID 1 for PsExec)<br>- Repo Access Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 "*psexec*" \| transaction host maxspan=5m [search sourcetype=puppet:audit "query"] \| where eventcount > 1 \| table _time, host`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "psexec" \| join kind=inner (PuppetAuditLogs \| where Action == "query") on DeviceName \| project Timestamp, DeviceName`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : "*psexec*" \| JOIN logs-puppet.audit-* ON host.name WHERE event.action = 'query' \| TABLE @timestamp, host.name`. |
| 9. Unauthorized Config Repo Backups or Exports | Adversaries export full configs (e.g., Puppet DB dumps), as in data theft. | - Export Logs (Puppet/Ansible backups)<br>- File Creation | - **Splunk**: `index=config_repo sourcetype=puppet:audit action="export" AND user NOT IN (authorized) \| stats count by user, export_type \| where count > 2`.<br>- **KQL**: `PuppetAuditLogs \| where Action == "export" and User !in (authorizedUsers) \| summarize count() by User, ExportType \| where count_ > 2`.<br>- **ELK**: `FROM logs-puppet.audit-* \| WHERE event.action = 'export' AND user.name NOT IN ['admin'] \| STATS COUNT() BY user.name, export.type HAVING COUNT() > 2`. |
| 10. Config Repo Access from Cloud Instances | Adversaries use cloud VMs to access on-prem repos, as in hybrid attacks. | - Cloud Audit Logs (AWS CloudTrail)<br>- Network Traffic | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="AssumeRole" \| join userIdentity [search sourcetype=ansible:audit "query"] \| stats count by userIdentity \| where count > 5`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "AssumeRole" \| join kind=inner (AnsibleAuditLogs \| where Action == "query") on Caller \| summarize count() by Caller \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'AssumeRole' \| JOIN logs-ansible.audit-* ON user.identity WHERE event.action = 'query' \| STATS COUNT() BY user.identity HAVING COUNT() > 5`. |
| 11. Sensitive Data in Config Repos | Scanning for creds in configs, but hunt for access to sensitive vars. | - File Content Access (EDR scans)<br>- Query Logs | - **Splunk**: `index=endpoint sourcetype=edr_scan strings IN ("*password*", "*key*") AND path="*ansible*" \| stats count by path, host \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where AdditionalFields.Strings has_any ("password", "key") and FolderPath contains "ansible" \| summarize count() by FolderPath, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-edr.scan-* \| WHERE file.strings : ("*password*" OR "*key*") AND file.path : "*ansible*" \| STATS COUNT() BY file.path, host.name HAVING COUNT() > 3`. |
| 12. Config Repo Access Spikes | Sudden increases in queries to repos, indicating scanning. | - Audit Logs (Puppet/Ansible)<br>- Metrics | - **Splunk**: `index=config_repo sourcetype=ansible:audit action="query" \| timechart span=1h count \| where count > avg(count)*3`.<br>- **KQL**: `AnsibleAuditLogs \| where Action == "query" \| summarize HourlyCount=count() by bin(Timestamp, 1h) \| where HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-ansible.audit-* \| WHERE event.action = 'query' \| STATS COUNT() BY date_histogram(@timestamp, '1h') \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 13. Unauthorized Module or Plugin Access | Adversaries access sensitive modules in Puppet/Chef for configs. | - Module Load Logs<br>- Access Events | - **Splunk**: `index=config_repo sourcetype=puppet:audit action="module_load" AND module NOT IN (approved) \| stats count by module, user \| where count > 2`.<br>- **KQL**: `PuppetAuditLogs \| where Action == "module_load" and Module !in (approvedModules) \| summarize count() by Module, User \| where count_ > 2`.<br>- **ELK**: `FROM logs-puppet.audit-* \| WHERE event.action = 'module_load' AND module.name NOT IN ['approved'] \| STATS COUNT() BY module.name, user.name HAVING COUNT() > 2`. |
| 14. Config Repo Access in Compromised Containers | Adversaries run queries from K8s pods, as in cloud-native attacks. | - Container Logs (K8s events)<br>- Process Execution | - **Splunk**: `index=container sourcetype=k8s:events "exec" Command="*ansible-playbook*" \| stats count by pod_name \| where count > 3`.<br>- **KQL**: `KubeEvents \| where Verb == "exec" and Message contains "ansible-playbook" \| summarize count() by ObjectRef.name \| where count_ > 3`.<br>- **ELK**: `FROM logs-kubernetes.events-* \| WHERE kubernetes.event.verb = 'exec' AND message : '*ansible-playbook*' \| STATS COUNT() BY kubernetes.pod.name HAVING COUNT() > 3`. |
| 15. Config Repo Credential Theft Indicators | Access to credential-storing configs, correlated with exfil. | - File Access (Sysmon ID 11)<br>- Network Exfil (ID 3) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename="*secrets.yaml*" \| join ProcessGuid [search EventCode=3 DestinationPort=443] \| stats count by host \| where count > 2`.<br>- **KQL**: `DeviceFileEvents \| where FileName contains "secrets.yaml" \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 443) on ProcessId \| summarize count() by FileName, RemoteIP, DeviceName \| where count_ > 2`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : "*secrets.yaml*" \| JOIN logs-endpoint.network-* ON process.pid WHERE destination.port = 443 \| STATS COUNT() BY file.name, destination.ip, host.name HAVING COUNT() > 2`.


### LLMNR/NBT-NS Poisoning and SMB Relay

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. LLMNR/NBT-NS Poisoning with Suspicious Responses | Adversaries send poisoned LLMNR/NBT-NS responses to redirect clients, as in Responder-based attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> High risk in Windows networks with LLMNR enabled. | - Network Traffic (DS0003: Network Traffic Content, Zeek DNS/LLMNR)<br>- Packet Capture | - **Splunk**: `index=network sourcetype=zeek_dns protocol IN ("llmnr", "nbt-ns") AND answer NOT IN (known_hosts) \| stats count by src_ip, answer \| where count > 10` (Detects unexpected LLMNR/NBT-NS responses).<br>- **KQL**: `DeviceNetworkEvents \| where Protocol in ("LLMNR", "NBT-NS") and AdditionalFields.Answer !in (knownHosts) \| summarize count() by DeviceIP, AdditionalFields.Answer \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE network.protocol IN ['llmnr', 'nbt-ns'] AND dns.answer NOT IN ['known_hosts'] \| STATS COUNT() BY source.ip, dns.answer HAVING COUNT() > 10`. |
| 2. Unauthorized SMB Connections from Poisoned Hosts | Hosts receiving poisoned responses initiate SMB connections to rogue servers, as in FIN7 attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Network Traffic (DS0003: SMB Flow)<br>- Authentication Logs | - **Splunk**: `index=network sourcetype=zeek_smb dest_ip NOT IN (known_servers) \| join src_ip [search sourcetype=zeek_dns protocol="llmnr" answer="*rogue*"] \| stats count by src_ip, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "SMB" and RemoteIP !in (knownServers) \| join kind=inner (DeviceNetworkEvents \| where Protocol == "LLMNR" and AdditionalFields.Answer contains "rogue") on DeviceIP \| summarize count() by DeviceIP, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.smb-* \| WHERE destination.ip NOT IN ['known_servers'] \| JOIN logs-zeek.dns-* ON source.ip WHERE network.protocol = 'llmnr' AND dns.answer : '*rogue*' \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 5`. |
| 3. SMB Relay to Unauthorized Hosts | Adversaries relay captured SMB credentials to unauthorized hosts, as in Responder relay attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Authentication Logs (DS0002: User Account Authentication)<br>- SMB Traffic | - **Splunk**: `index=windows EventCode=4624 LogonType=3 AND ComputerName NOT IN (known_servers) AND IpAddress NOT IN (internal_ips) \| stats count by AccountName, IpAddress \| where count > 5`.<br>- **KQL**: `SecurityEvent \| where EventID == 4624 and LogonType == 3 and ComputerName !in (knownServers) and IpAddress !in (internalIPs) \| summarize count() by AccountName, IpAddress \| where count_ > 5`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 4624 AND winlog.logon.type = '3' AND winlog.computer_name NOT IN ['known_servers'] AND source.ip NOT IN ['internal_ips'] \| STATS COUNT() BY user.name, source.ip HAVING COUNT() > 5`. |
| 4. Suspicious Process Initiating LLMNR Queries | Malicious processes (e.g., Responder) initiate excessive LLMNR queries, indicating poisoning attempts.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (DS0009: Process Creation, Sysmon ID 1)<br>- Network Traffic | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*responder*" OR Image="*responder.exe" \| join host [search index=network sourcetype=zeek_dns protocol="llmnr"] \| stats count by Image, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "responder" or FolderPath endswith "responder.exe" \| join kind=inner (DeviceNetworkEvents \| where Protocol == "LLMNR") on DeviceName \| summarize count() by FolderPath, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : "*responder*" OR process.name = "responder.exe" \| JOIN logs-zeek.dns-* ON host.name WHERE network.protocol = 'llmnr' \| STATS COUNT() BY process.name, host.name HAVING COUNT() > 3`. |
| 5. Anomalous LLMNR/NBT-NS Query Volume | High volume of LLMNR/NBT-NS queries from a single host, suggesting poisoning setup.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Network Traffic (DS0003: DNS Flow)<br>- Query Metrics | - **Splunk**: `index=network sourcetype=zeek_dns protocol IN ("llmnr", "nbt-ns") \| timechart span=5m count by src_ip \| where count > avg(count)*4`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol in ("LLMNR", "NBT-NS") \| summarize QueryCount=count() by bin(Timestamp, 5m), DeviceIP \| where QueryCount > avg(QueryCount) * 4`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE network.protocol IN ['llmnr', 'nbt-ns'] \| STATS COUNT() BY date_histogram(@timestamp, '5m'), source.ip \| WHERE COUNT() > AVG(COUNT()) * 4`. |
| 6. SMB Relay with NTLM Hash Capture | Adversaries capture NTLM hashes via poisoned LLMNR responses for relay, as in APT33 attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Authentication Logs (DS0002: Failed Logon)<br>- SMB Traffic | - **Splunk**: `index=windows EventCode=4625 LogonType=3 AND IpAddress NOT IN (known_servers) \| join IpAddress [search sourcetype=zeek_smb "NTLM"] \| stats count by AccountName, IpAddress \| where count > 5`.<br>- **KQL**: `SecurityEvent \| where EventID == 4625 and LogonType == 3 and IpAddress !in (knownServers) \| join kind=inner (DeviceNetworkEvents \| where Protocol == "SMB" and AdditionalFields.Auth == "NTLM") on IpAddress \| summarize count() by AccountName, IpAddress \| where count_ > 5`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 4625 AND winlog.logon.type = '3' AND source.ip NOT IN ['known_servers'] \| JOIN logs-zeek.smb-* ON source.ip WHERE smb.auth = 'NTLM' \| STATS COUNT() BY user.name, source.ip HAVING COUNT() > 5`. |
| 7. LLMNR Poisoning from Compromised Endpoints | Compromised endpoints run tools like Responder to poison LLMNR, as in FIN7.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (Sysmon ID 1)<br>- Network Traffic | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*responder*" \| join host [search index=network sourcetype=zeek_dns protocol="llmnr" answer="*rogue*"] \| stats count by host, CommandLine \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "responder" \| join kind=inner (DeviceNetworkEvents \| where Protocol == "LLMNR" and AdditionalFields.Answer contains "rogue") on DeviceName \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : "*responder*" \| JOIN logs-zeek.dns-* ON host.name WHERE network.protocol = 'llmnr' AND dns.answer : '*rogue*' \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 3`. |
| 8. SMB Relay to Administrative Shares | Relayed credentials access administrative shares (e.g., C$, ADMIN$), as in Responder attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Windows Event Logs (DS0002: Event ID 5145)<br>- SMB Traffic | - **Splunk**: `index=windows EventCode=5145 ShareName IN ("C$", "ADMIN$") AND IpAddress NOT IN (internal_ips) \| stats count by AccountName, IpAddress, ShareName \| where count > 5`.<br>- **KQL**: `SecurityEvent \| where EventID == 5145 and ShareName in ("C$", "ADMIN$") and IpAddress !in (internalIPs) \| summarize count() by AccountName, IpAddress, ShareName \| where count_ > 5`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 5145 AND winlog.share.name IN ['C$', 'ADMIN$'] AND source.ip NOT IN ['internal_ips'] \| STATS COUNT() BY user.name, source.ip, winlog.share.name HAVING COUNT() > 5`. |
| 9. LLMNR/NBT-NS Poisoning with Anomalous DNS Traffic | Poisoned responses lead to anomalous DNS-like traffic patterns, indicating spoofing.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Network Traffic (DS0003: DNS Flow)<br>- Zeek DNS Logs | - **Splunk**: `index=network sourcetype=zeek_dns protocol IN ("llmnr", "nbt-ns") AND query NOT IN (known_queries) \| stats count by src_ip, query \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol in ("LLMNR", "NBT-NS") and AdditionalFields.Query !in (knownQueries) \| summarize count() by DeviceIP, AdditionalFields.Query \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE network.protocol IN ['llmnr', 'nbt-ns'] AND dns.query NOT IN ['known_queries'] \| STATS COUNT() BY source.ip, dns.query HAVING COUNT() > 10`. |
| 10. SMB Relay in Cloud-Hybrid Environments | Adversaries relay SMB credentials to cloud-hosted Windows instances, as in hybrid attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Cloud Audit Logs (AWS CloudTrail)<br>- Authentication Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="ConsoleLogin" AND userIdentity NOT IN (authorized) \| join instanceId [search index=windows EventCode=4624 LogonType=3] \| stats count by userIdentity, instanceId \| where count > 5`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "ConsoleLogin" and Caller !in (authorizedUsers) \| join kind=inner (SecurityEvent \| where EventID == 4624 and LogonType == 3) on DeviceName \| summarize count() by Caller, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'ConsoleLogin' AND user.identity NOT IN ['authorized'] \| JOIN logs-windows-* ON host.id WHERE winlog.event_id = 4624 AND winlog.logon.type = '3' \| STATS COUNT() BY user.identity, host.id HAVING COUNT() > 5`. |
| 11. LLMNR Poisoning with Suspicious ARP Activity | Poisoning attempts correlate with ARP spoofing to facilitate MITM, as in Turla attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Network Traffic (DS0003: ARP Traffic)<br>- LLMNR Traffic | - **Splunk**: `index=network sourcetype=zeek_arp operation="reply" AND src_mac NOT IN (known_macs) \| join src_ip [search sourcetype=zeek_dns protocol="llmnr"] \| stats count by src_ip, src_mac \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "ARP" and AdditionalFields.Operation == "reply" and SourceMAC !in (knownMACs) \| join kind=inner (DeviceNetworkEvents \| where Protocol == "LLMNR") on DeviceIP \| summarize count() by DeviceIP, SourceMAC \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.arp-* \| WHERE arp.operation = 'reply' AND source.mac NOT IN ['known_macs'] \| JOIN logs-zeek.dns-* ON source.ip WHERE network.protocol = 'llmnr' \| STATS COUNT() BY source.ip, source.mac HAVING COUNT() > 5`. |
| 12. SMB Relay with Rapid Authentication Attempts | Rapid NTLM authentication attempts to multiple hosts, indicating relay attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Authentication Logs (DS0002: Event ID 4624)<br>- SMB Traffic | - **Splunk**: `index=windows EventCode=4624 LogonType=3 \| timechart span=5m dc(ComputerName) by IpAddress \| where dc_ComputerName > 10`.<br>- **KQL**: `SecurityEvent \| where EventID == 4624 and LogonType == 3 \| summarize HostCount=dcount(ComputerName) by bin(TimeGenerated, 5m), IpAddress \| where HostCount > 10`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 4624 AND winlog.logon.type = '3' \| STATS DISTINCT_COUNT(winlog.computer_name) BY date_histogram(@timestamp, '5m'), source.ip \| WHERE DISTINCT_COUNT(winlog.computer_name) > 10`. |
| 13. LLMNR Poisoning in Linux Environments | Adversaries use Linux hosts to poison LLMNR/NBT-NS, as in cross-platform attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Execution (DS0009: auditd execve)<br>- Network Traffic | - **Splunk**: `index=linux sourcetype=auditd syscall="execve" exe="*responder*" \| join host [search index=network sourcetype=zeek_dns protocol="llmnr"] \| stats count by exe, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where ActionType == "ProcessCreated" and InitiatingProcessFolderPath contains "responder" \| join kind=inner (DeviceNetworkEvents \| where Protocol == "LLMNR") on DeviceName \| summarize count() by InitiatingProcessFolderPath, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE syscall.name = 'execve' AND process.exe : '*responder*' \| JOIN logs-zeek.dns-* ON host.name WHERE network.protocol = 'llmnr' \| STATS COUNT() BY process.exe, host.name HAVING COUNT() > 3`. |
| 14. SMB Relay with Lateral Movement Indicators | SMB relay followed by lateral movement (e.g., PsExec), as in APT33.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (Sysmon ID 1 for PsExec)<br>- Authentication Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*psexec*" \| transaction host maxspan=5m [search index=windows EventCode=4624 LogonType=3] \| where eventcount > 1 \| table _time, host, AccountName`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "psexec" \| join kind=inner (SecurityEvent \| where EventID == 4624 and LogonType == 3) on DeviceName \| project TimeGenerated, DeviceName, AccountName`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : '*psexec*' \| JOIN logs-windows-* ON host.name WHERE winlog.event_id = 4624 AND winlog.logon.type = '3' \| TABLE @timestamp, host.name, user.name`. |
| 15. LLMNR Poisoning with Suspicious Multicast Traffic | Excessive multicast traffic for LLMNR/NBT-NS, indicating poisoning attempts.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Network Traffic (DS0003: Multicast Traffic)<br>- Zeek DNS Logs | - **Splunk**: `index=network sourcetype=zeek_conn dest_ip IN ("224.0.0.252", "255.255.255.255") AND protocol IN ("llmnr", "nbt-ns") \| stats count by src_ip, dest_ip \| where count > 20`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteIP in ("224.0.0.252", "255.255.255.255") and Protocol in ("LLMNR", "NBT-NS") \| summarize count() by DeviceIP, RemoteIP \| where count_ > 20`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE destination.ip IN ['224.0.0.252', '255.255.255.255'] AND network.protocol IN ['llmnr', 'nbt-ns'] \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 20`. |


### Local Data Staging


| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Suspicious File Creation in Staging Directories | Adversaries create files in temporary or unusual directories for staging, as in APT41 attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> High risk in Windows and Linux environments with unmonitored directories. | - File Creation (DS0022: File Creation, Sysmon Event ID 11)<br>- File System Monitoring | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename IN ("*\\Temp\\*", "*\\tmp\\*", "*\\staging*") AND NOT ProcessImage IN (legit_processes) \| stats count by TargetFilename, ProcessImage, host \| where count > 5` (Detects file creation in staging directories).<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FolderPath has_any ("Temp", "tmp", "staging") and not(InitiatingProcessFolderPath in~ (legitProcesses)) \| summarize count() by FileName, InitiatingProcessFolderPath, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.events.file-* \| WHERE event.action = "creation" AND file.path : ("*Temp*" OR "*tmp*" OR "*staging*") AND process.executable NOT IN ['legit_processes'] \| STATS COUNT() BY file.name, process.executable, host.name HAVING COUNT() > 5`. |
| 2. Data Aggregation via Compression Tools | Adversaries use tools like WinRAR or tar to compress staged data, as in FIN7 campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> Common in Windows and Linux environments. | - Process Creation (DS0009: Process Creation, Sysmon ID 1)<br>- File Creation | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rar.exe", "*zip.exe", "*tar*") AND CommandLine="*compress*" \| join ProcessGuid [search EventCode=11 TargetFilename="*staging*"] \| stats count by Image, TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("rar.exe", "zip.exe", "tar") and ProcessCommandLine contains "compress" \| join kind=inner (DeviceFileEvents \| where FolderPath contains "staging") on ProcessId \| summarize count() by FolderPath, FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("rar.exe" OR "zip.exe" OR "tar") AND process.command_line : "*compress*" \| JOIN logs-endpoint.file-* ON process.pid WHERE file.path : "*staging*" \| STATS COUNT() BY process.name, file.name, host.name HAVING COUNT() > 3`. |
| 3. Staging in Hidden or System Directories | Adversaries stage data in hidden or system directories (e.g., %AppData%), as in Turla attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - File Creation (Sysmon ID 11)<br>- File Attribute Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename IN ("*\\AppData\\*", "*\\ProgramData\\*") AND FileAttributes="*hidden*" \| stats count by TargetFilename, ProcessImage, host \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FolderPath has_any ("AppData", "ProgramData") and AdditionalFields.FileAttributes contains "hidden" \| summarize count() by FileName, InitiatingProcessFolderPath, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.events.file-* \| WHERE event.action = "creation" AND file.path : ("*AppData*" OR "*ProgramData*") AND file.attributes : "*hidden*" \| STATS COUNT() BY file.name, process.executable, host.name HAVING COUNT() > 3`. |
| 4. Data Staging Followed by Network Exfiltration | Staged files are followed by outbound network traffic, indicating exfiltration, as in APT41.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - File Creation (Sysmon ID 11)<br>- Network Traffic (Sysmon ID 3) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename="*staging*" \| transaction ProcessGuid maxspan=5m [search EventCode=3 DestinationPort=443] \| where eventcount > 1 \| table _time, TargetFilename, DestinationIp, host`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FolderPath contains "staging" \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 443) on ProcessId \| project Timestamp, FileName, RemoteIP, DeviceName`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = "creation" AND file.path : "*staging*" \| JOIN logs-endpoint.network-* ON process.pid WHERE destination.port = 443 \| TABLE @timestamp, file.name, destination.ip, host.name`. |
| 5. Suspicious File Creation by Non-Standard Processes | Non-standard processes create files in staging locations, as in FIN7 attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (Sysmon ID 1)<br>- File Creation (Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image NOT IN ("*\\Windows\\*", "*\\Program Files\\*") \| join ProcessGuid [search EventCode=11 TargetFilename="*staging*"] \| stats count by Image, TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where not(FolderPath has_any ("Windows", "Program Files")) \| join kind=inner (DeviceFileEvents \| where FolderPath contains "staging") on ProcessId \| summarize count() by FolderPath, FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE NOT process.executable : ("*Windows*" OR "*Program Files*") \| JOIN logs-endpoint.file-* ON process.pid WHERE file.path : "*staging*" \| STATS COUNT() BY process.executable, file.name, host.name HAVING COUNT() > 3`. |
| 6. Data Staging in Linux Temporary Directories | Adversaries stage data in Linux /tmp or /var/tmp directories, as in general T1074.001.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - File Access (DS0022: auditd openat)<br>- Process Monitoring | - **Splunk**: `index=linux sourcetype=auditd syscall="openat" path IN ("*/tmp/*", "*/var/tmp/*") AND NOT exe IN (legit_apps) \| stats count by path, exe, host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FolderPath has_any ("tmp", "var/tmp") and not(InitiatingProcessFolderPath in~ (legitApps)) \| summarize count() by FileName, InitiatingProcessFolderPath, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE syscall.name = "openat" AND file.path : ("*/tmp/*" OR "*/var/tmp/*") AND process.exe NOT IN ['legit_apps'] \| STATS COUNT() BY file.path, process.exe, host.name HAVING COUNT() > 5`. |
| 7. Data Staging with High File Write Volume | High volume of file writes to staging directories, indicating bulk data collection.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - File Creation (Sysmon ID 11)<br>- File System Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename="*staging*" \| timechart span=1h count by host \| where count > avg(count)*4`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FolderPath contains "staging" \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 4`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = "creation" AND file.path : "*staging*" \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 4`. |
| 8. Staging in Cloud Storage Mounts | Adversaries stage data in cloud storage mounts (e.g., EBS volumes), as in hybrid attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Cloud Audit Logs (AWS CloudTrail)<br>- File Creation Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="CreateVolume" AND userIdentity NOT IN (authorized) \| join instanceId [search index=endpoint sourcetype=sysmon EventCode=11 "*staging*"] \| stats count by instanceId, TargetFilename \| where count > 3`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "CreateVolume" and Caller !in (authorizedUsers) \| join kind=inner (DeviceFileEvents \| where FolderPath contains "staging") on DeviceName \| summarize count() by DeviceName, FileName \| where count_ > 3`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'CreateVolume' AND user.identity NOT IN ['authorized'] \| JOIN logs-endpoint.file-* ON host.id WHERE file.path : "*staging*" \| STATS COUNT() BY host.id, file.name HAVING COUNT() > 3`. |
| 9. Staging with Suspicious File Extensions | Files with unusual extensions (e.g., .dat, .bin) in staging directories, as in Turla.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - File Creation (Sysmon ID 11)<br>- File Metadata | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename IN ("*.dat", "*.bin") AND TargetFilename="*staging*" \| stats count by TargetFilename, ProcessImage, host \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FileName has_any (".dat", ".bin") and FolderPath contains "staging" \| summarize count() by FileName, InitiatingProcessFolderPath, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = "creation" AND file.name : ("*.dat" OR "*.bin") AND file.path : "*staging*" \| STATS COUNT() BY file.name, process.executable, host.name HAVING COUNT() > 3`. |
| 10. Data Staging by Compromised Accounts | Staging activities by accounts with recent suspicious logins, as in Nobelium.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Authentication Logs (DS0002: Azure AD Sign-ins)<br>- File Creation | - **Splunk**: `index=security sourcetype=azure:ad:signin Status="success" AND IPAddress NOT IN (corporate_ranges) \| join UserPrincipalName [search sourcetype=sysmon EventCode=11 "*staging*"] \| stats count by UserPrincipalName, TargetFilename \| where count > 3`.<br>- **KQL**: `SigninLogs \| where Status == "success" and IPAddress !in (corporateRanges) \| join kind=inner (DeviceFileEvents \| where FolderPath contains "staging") on UserId \| summarize count() by UserId, FileName \| where count_ > 3`.<br>- **ELK**: `FROM logs-azure.signin-* \| WHERE event.outcome = 'success' AND source.ip NOT IN ['corporate_ranges'] \| JOIN logs-endpoint.file-* ON user.id WHERE file.path : "*staging*" \| STATS COUNT() BY user.id, file.name HAVING COUNT() > 3`. |
| 11. Data Staging with Encryption Tools | Adversaries encrypt staged data to evade detection, as in 2025 malware trends.<grok:render type="render_inline_citation"><argument name="citation_id">5</argument></grok:render> | - Process Creation (Sysmon ID 1 for encryption tools)<br>- File Creation | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*gpg.exe", "*openssl.exe") AND CommandLine="*encrypt*" \| join ProcessGuid [search EventCode=11 "*staging*"] \| stats count by Image, TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("gpg.exe", "openssl.exe") and ProcessCommandLine contains "encrypt" \| join kind=inner (DeviceFileEvents \| where FolderPath contains "staging") on ProcessId \| summarize count() by FolderPath, FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("gpg.exe" OR "openssl.exe") AND process.command_line : "*encrypt*" \| JOIN logs-endpoint.file-* ON process.pid WHERE file.path : "*staging*" \| STATS COUNT() BY process.name, file.name, host.name HAVING COUNT() > 3`. |
| 12. Data Staging in macOS Environments | Adversaries stage data in macOS temporary directories (e.g., ~/Library/Caches), as in general T1074.001.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Unified Logs (DS0022: macOS Unified Logs)<br>- File Creation | - **Splunk**: `index=macos sourcetype=macos:unified event_type="file_create" AND file_path IN ("*/Library/Caches/*", "*/tmp/*") AND NOT process IN (legit_apps) \| stats count by file_path, process, host \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FolderPath has_any ("Library/Caches", "tmp") and not(InitiatingProcessName in~ (legitApps)) \| summarize count() by FileName, InitiatingProcessName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-macos.unified-* \| WHERE event.type = "file_create" AND file.path : ("*/Library/Caches/*" OR "*/tmp/*") AND process.name NOT IN ['legit_apps'] \| STATS COUNT() BY file.path, process.name, host.name HAVING COUNT() > 3`. |
| 13. Data Staging with Suspicious File Sizes | Large files created in staging directories, indicating bulk data collection.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - File Creation (Sysmon ID 11)<br>- File Metadata | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename="*staging*" AND FileSize>1000000 \| stats count by TargetFilename, FileSize, host \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FolderPath contains "staging" and AdditionalFields.FileSize > 1000000 \| summarize count() by FileName, AdditionalFields.FileSize, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = "creation" AND file.path : "*staging*" AND file.size > 1000000 \| STATS COUNT() BY file.name, file.size, host.name HAVING COUNT() > 3`. |
| 14. Data Staging with Command Line Tools | Adversaries use tools like xcopy or rsync to stage data, as in APT41.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (Sysmon ID 1)<br>- File Creation | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*xcopy.exe", "*rsync*") AND CommandLine="*staging*" \| join ProcessGuid [search EventCode=11 "*staging*"] \| stats count by Image, TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("xcopy.exe", "rsync") and ProcessCommandLine contains "staging" \| join kind=inner (DeviceFileEvents \| where FolderPath contains "staging") on ProcessId \| summarize count() by FolderPath, FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("xcopy.exe" OR "rsync") AND process.command_line : "*staging*" \| JOIN logs-endpoint.file-* ON process.pid WHERE file.path : "*staging*" \| STATS COUNT() BY process.name, file.name, host.name HAVING COUNT() > 3`. |
| 15. Data Staging with Anomalous User Behavior | Staging activities by users with unusual behavior patterns, as in 2025 trends.<grok:render type="render_inline_citation"><argument name="citation_id">5</argument></grok:render> | - User Behavior Analytics (UBA)<br>- File Creation | - **Splunk**: `index=security sourcetype=uba:anomaly event_type="file_activity" AND user NOT IN (known_users) \| join user [search sourcetype=sysmon EventCode=11 "*staging*"] \| stats count by user, TargetFilename, host \| where count > 3`.<br>- **KQL**: `UbaAnomalies \| where EventType == "file_activity" and User !in (knownUsers) \| join kind=inner (DeviceFileEvents \| where FolderPath contains "staging") on UserId \| summarize count() by UserId, FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-uba.anomaly-* \| WHERE event.type = "file_activity" AND user.name NOT IN ['known_users'] \| JOIN logs-endpoint.file-* ON user.id WHERE file.path : "*staging*" \| STATS COUNT() BY user.id, file.name, host.name HAVING COUNT() > 3`. |


### Local Email Collection


| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Unauthorized Access to Email Storage Files | Adversaries access email storage files (e.g., .pst, .ost) on local systems, as in APT28 campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> High risk in Windows environments with Outlook. | - File Access (DS0022: File Access, Sysmon Event ID 11)<br>- Process Monitoring | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename IN ("*.pst", "*.ost") AND NOT ProcessImage IN ("*outlook.exe", "*explorer.exe") \| stats count by TargetFilename, ProcessImage, host \| where count > 3` (Detects non-Outlook processes accessing email files).<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileAccessed" and FileName has_any (".pst", ".ost") and not(InitiatingProcessFolderPath has_any ("outlook.exe", "explorer.exe")) \| summarize count() by FileName, InitiatingProcessFolderPath, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = "access" AND file.name : ("*.pst" OR "*.ost") AND NOT process.executable : ("*outlook.exe" OR "*explorer.exe") \| STATS COUNT() BY file.name, process.executable, host.name HAVING COUNT() > 3`. |
| 2. Suspicious Process Interaction with Email Clients | Adversaries launch processes to scrape email data from clients like Outlook or Thunderbird, as in FIN7 attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (DS0009: Process Creation, Sysmon ID 1)<br>- File Access | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*mapi*", "*thunderbird*") AND NOT Image IN (known_apps) \| join ProcessGuid [search EventCode=11 TargetFilename="*email*"] \| stats count by Image, TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("mapi", "thunderbird") and not(FolderPath in~ (knownApps)) \| join kind=inner (DeviceFileEvents \| where FileName contains "email") on ProcessId \| summarize count() by FolderPath, FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*mapi*" OR "*thunderbird*") AND NOT process.executable IN ['known_apps'] \| JOIN logs-endpoint.file-* ON process.pid WHERE file.name : "*email*" \| STATS COUNT() BY process.executable, file.name, host.name HAVING COUNT() > 3`. |
| 3. Email Data Staging for Exfiltration | Adversaries copy email files to staging directories before exfiltration, as in Turla campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - File Creation (Sysmon ID 11)<br>- Network Traffic (Sysmon ID 3) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename IN ("*.pst", "*.ost", "*email*") AND TargetFilename="*staging*" \| transaction ProcessGuid maxspan=5m [search EventCode=3 DestinationPort=443] \| where eventcount > 1 \| table _time, TargetFilename, DestinationIp, host`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FileName has_any (".pst", ".ost", "email") and FolderPath contains "staging" \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 443) on ProcessId \| project Timestamp, FileName, RemoteIP, DeviceName`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = "creation" AND file.name : ("*.pst" OR "*.ost" OR "*email*") AND file.path : "*staging*" \| JOIN logs-endpoint.network-* ON process.pid WHERE destination.port = 443 \| TABLE @timestamp, file.name, destination.ip, host.name`. |
| 4. Email Collection via Scripting Tools | Adversaries use PowerShell or Python to extract email data, as in 2025 malware trends.<grok:render type="render_inline_citation"><argument name="citation_id">5</argument></grok:render> | - Process Creation (Sysmon ID 1 for scripts)<br>- File Access | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*powershell.exe", "*python.exe") AND CommandLine IN ("*mapi*", "*email*") \| join ProcessGuid [search EventCode=11 TargetFilename="*email*"] \| stats count by Image, TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("powershell.exe", "python.exe") and ProcessCommandLine has_any ("mapi", "email") \| join kind=inner (DeviceFileEvents \| where FileName contains "email") on ProcessId \| summarize count() by FolderPath, FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("powershell.exe" OR "python.exe") AND process.command_line : ("*mapi*" OR "*email*") \| JOIN logs-endpoint.file-* ON process.pid WHERE file.name : "*email*" \| STATS COUNT() BY process.name, file.name, host.name HAVING COUNT() > 3`. |
| 5. Email Collection in Linux Email Clients | Adversaries target Linux email clients (e.g., Thunderbird) for local data, as in general T1114.001.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - File Access (DS0022: auditd openat)<br>- Process Monitoring | - **Splunk**: `index=linux sourcetype=auditd syscall="openat" path="*/.thunderbird/*" AND NOT exe IN (legit_apps) \| stats count by path, exe, host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileAccessed" and FolderPath contains ".thunderbird" and not(InitiatingProcessFolderPath in~ (legitApps)) \| summarize count() by FileName, InitiatingProcessFolderPath, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE syscall.name = "openat" AND file.path : "*/.thunderbird/*" AND NOT process.exe IN ['legit_apps'] \| STATS COUNT() BY file.path, process.exe, host.name HAVING COUNT() > 5`. |
| 6. Email Collection by Compromised Accounts | Email collection activities by accounts with suspicious logins, as in Nobelium attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Authentication Logs (DS0002: Azure AD Sign-ins)<br>- File Access | - **Splunk**: `index=security sourcetype=azure:ad:signin Status="success" AND IPAddress NOT IN (corporate_ranges) \| join UserPrincipalName [search sourcetype=sysmon EventCode=11 TargetFilename="*.pst"] \| stats count by UserPrincipalName, TargetFilename, host \| where count > 3`.<br>- **KQL**: `SigninLogs \| where Status == "success" and IPAddress !in (corporateRanges) \| join kind=inner (DeviceFileEvents \| where FileName contains ".pst") on UserId \| summarize count() by UserId, FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-azure.signin-* \| WHERE event.outcome = "success" AND source.ip NOT IN ['corporate_ranges'] \| JOIN logs-endpoint.file-* ON user.id WHERE file.name : "*.pst" \| STATS COUNT() BY user.id, file.name, host.name HAVING COUNT() > 3`. |
| 7. Email Collection with High File Access Volume | High volume of accesses to email files, indicating bulk collection, as in APT41.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - File Access (Sysmon ID 11)<br>- File System Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename IN ("*.pst", "*.ost") \| timechart span=1h count by host \| where count > avg(count)*4`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileAccessed" and FileName has_any (".pst", ".ost") \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 4`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = "access" AND file.name : ("*.pst" OR "*.ost") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 4`. |
| 8. Email Collection via Browser-Based Clients | Adversaries access email data through browser local storage, as in 2025 trends.<grok:render type="render_inline_citation"><argument name="citation_id">5</argument></grok:render> | - Browser Process Logs (Sysmon ID 1)<br>- File Access | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*chrome.exe", "*firefox.exe") AND CommandLine="*email*" \| join ProcessGuid [search EventCode=11 TargetFilename="*Local Storage*"] \| stats count by Image, TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("chrome.exe", "firefox.exe") and ProcessCommandLine contains "email" \| join kind=inner (DeviceFileEvents \| where FolderPath contains "Local Storage") on ProcessId \| summarize count() by FolderPath, FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("chrome.exe" OR "firefox.exe") AND process.command_line : "*email*" \| JOIN logs-endpoint.file-* ON process.pid WHERE file.path : "*Local Storage*" \| STATS COUNT() BY process.name, file.name, host.name HAVING COUNT() > 3`. |
| 9. Email Collection in macOS Mail Clients | Adversaries target macOS Mail.app data (e.g., ~/Library/Mail), as in general T1114.001.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Unified Logs (DS0022: macOS Unified Logs)<br>- File Access | - **Splunk**: `index=macos sourcetype=macos:unified event_type="file_access" AND file_path="*/Library/Mail/*" AND NOT process IN (legit_apps) \| stats count by file_path, process, host \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileAccessed" and FolderPath contains "Library/Mail" and not(InitiatingProcessName in~ (legitApps)) \| summarize count() by FileName, InitiatingProcessName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-macos.unified-* \| WHERE event.type = "file_access" AND file.path : "*/Library/Mail/*" AND NOT process.name IN ['legit_apps'] \| STATS COUNT() BY file.path, process.name, host.name HAVING COUNT() > 3`. |
| 10. Email Collection with Compression for Exfiltration | Adversaries compress email files for exfiltration, as in FIN7 attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (Sysmon ID 1 for compression tools)<br>- File Creation | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rar.exe", "*zip.exe") AND CommandLine="*email*" \| join ProcessGuid [search EventCode=11 TargetFilename="*.pst"] \| stats count by Image, TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("rar.exe", "zip.exe") and ProcessCommandLine contains "email" \| join kind=inner (DeviceFileEvents \| where FileName contains ".pst") on ProcessId \| summarize count() by FolderPath, FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("rar.exe" OR "zip.exe") AND process.command_line : "*email*" \| JOIN logs-endpoint.file-* ON process.pid WHERE file.name : "*.pst" \| STATS COUNT() BY process.name, file.name, host.name HAVING COUNT() > 3`. |
| 11. Email Collection with Suspicious MAPI Usage | Adversaries use MAPI to extract email data, as in APT28 campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (Sysmon ID 1)<br>- Network Traffic | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*mapi*" AND NOT Image IN ("*outlook.exe") \| join ProcessGuid [search EventCode=3 DestinationPort=135] \| stats count by Image, DestinationIp, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "mapi" and not(FolderPath has "outlook.exe") \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 135) on ProcessId \| summarize count() by FolderPath, RemoteIP, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : "*mapi*" AND NOT process.executable : "*outlook.exe" \| JOIN logs-endpoint.network-* ON process.pid WHERE destination.port = 135 \| STATS COUNT() BY process.executable, destination.ip, host.name HAVING COUNT() > 3`. |
| 12. Email Collection in Cloud-Hybrid Environments | Adversaries access email data from cloud-synced local storage, as in hybrid attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Cloud Audit Logs (AWS CloudTrail)<br>- File Access | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="GetObject" AND bucket="*email*" \| join instanceId [search sourcetype=sysmon EventCode=11 "*email*"] \| stats count by instanceId, TargetFilename \| where count > 3`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "GetObject" and BucketName contains "email" \| join kind=inner (DeviceFileEvents \| where FileName contains "email") on DeviceName \| summarize count() by DeviceName, FileName \| where count_ > 3`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = "GetObject" AND s3.bucket : "*email*" \| JOIN logs-endpoint.file-* ON host.id WHERE file.name : "*email*" \| STATS COUNT() BY host.id, file.name HAVING COUNT() > 3`. |
| 13. Email Collection with Anomalous User Behavior | Email collection by users with unusual behavior patterns, as in 2025 trends.<grok:render type="render_inline_citation"><argument name="citation_id">5</argument></grok:render> | - User Behavior Analytics (UBA)<br>- File Access | - **Splunk**: `index=security sourcetype=uba:anomaly event_type="file_activity" AND user NOT IN (known_users) \| join user [search sourcetype=sysmon EventCode=11 TargetFilename="*.pst"] \| stats count by user, TargetFilename, host \| where count > 3`.<br>- **KQL**: `UbaAnomalies \| where EventType == "file_activity" and User !in (knownUsers) \| join kind=inner (DeviceFileEvents \| where FileName contains ".pst") on UserId \| summarize count() by UserId, FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-uba.anomaly-* \| WHERE event.type = "file_activity" AND user.name NOT IN ['known_users'] \| JOIN logs-endpoint.file-* ON user.id WHERE file.name : "*.pst" \| STATS COUNT() BY user.id, file.name, host.name HAVING COUNT() > 3`. |
| 14. Email Collection with Suspicious File Copies | Adversaries copy email files to alternate locations, as in FIN7 attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (Sysmon ID 1 for copy tools)<br>- File Creation | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*xcopy.exe", "*robocopy.exe") AND CommandLine="*email*" \| join ProcessGuid [search EventCode=11 TargetFilename="*.pst"] \| stats count by Image, TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("xcopy.exe", "robocopy.exe") and ProcessCommandLine contains "email" \| join kind=inner (DeviceFileEvents \| where FileName contains ".pst") on ProcessId \| summarize count() by FolderPath, FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("xcopy.exe" OR "robocopy.exe") AND process.command_line : "*email*" \| JOIN logs-endpoint.file-* ON process.pid WHERE file.name : "*.pst" \| STATS COUNT() BY process.name, file.name, host.name HAVING COUNT() > 3`. |
| 15. Email Collection with High CPU Usage | Processes accessing email files consume high CPU, indicating bulk collection.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Performance Metrics (DS0023: Windows/Linux)<br>- File Access | - **Splunk**: `index=endpoint sourcetype=perfmon CPU>80 AND ProcessImage NOT IN (known_apps) \| join ProcessImage [search sourcetype=sysmon EventCode=11 TargetFilename="*.pst"] \| stats count by ProcessImage, TargetFilename, host \| where count > 3`.<br>- **KQL**: `DevicePerformanceEvents \| where CPUUsage > 80 and FolderPath !in (knownApps) \| join kind=inner (DeviceFileEvents \| where FileName contains ".pst") on FolderPath \| summarize count() by FolderPath, FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.performance-* \| WHERE cpu.usage > 80 AND process.executable NOT IN ['known_apps'] \| JOIN logs-endpoint.file-* ON process.executable WHERE file.name : "*.pst" \| STATS COUNT() BY process.executable, file.name, host.name HAVING COUNT() > 3`. |


### Messaging Applications


| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Unauthorized Access to Messaging App Data Files | Adversaries access messaging app storage files (e.g., Teams cache, Slack logs) on local systems, as in APT29 campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> High risk in Windows and macOS environments with collaboration tools. | - File Access (DS0022: File Access, Sysmon Event ID 11)<br>- Process Monitoring | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename IN ("*\\Microsoft\\Teams\\*", "*\\Slack\\*", "*\\WhatsApp\\*") AND NOT ProcessImage IN ("*teams.exe", "*slack.exe", "*whatsapp.exe") \| stats count by TargetFilename, ProcessImage, host \| where count > 3` (Detects non-legitimate processes accessing messaging app files).<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileAccessed" and FolderPath has_any ("Microsoft\\Teams", "Slack", "WhatsApp") and not(InitiatingProcessFolderPath has_any ("teams.exe", "slack.exe", "whatsapp.exe")) \| summarize count() by FileName, InitiatingProcessFolderPath, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = "access" AND file.path : ("*Microsoft\\Teams*" OR "*Slack*" OR "*WhatsApp*") AND NOT process.executable : ("*teams.exe" OR "*slack.exe" OR "*whatsapp.exe") \| STATS COUNT() BY file.name, process.executable, host.name HAVING COUNT() > 3`. |
| 2. Suspicious Process Interaction with Messaging Apps | Adversaries launch processes to scrape data from messaging apps, as in FIN7 attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> Common in Windows and Linux environments. | - Process Creation (DS0009: Process Creation, Sysmon ID 1)<br>- File Access | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*teams*", "*slack*", "*whatsapp*") AND NOT Image IN (known_apps) \| join ProcessGuid [search EventCode=11 TargetFilename="*messaging*"] \| stats count by Image, TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("teams", "slack", "whatsapp") and not(FolderPath in~ (knownApps)) \| join kind=inner (DeviceFileEvents \| where FileName contains "messaging") on ProcessId \| summarize count() by FolderPath, FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*teams*" OR "*slack*" OR "*whatsapp*") AND NOT process.executable IN ['known_apps'] \| JOIN logs-endpoint.file-* ON process.pid WHERE file.name : "*messaging*" \| STATS COUNT() BY process.executable, file.name, host.name HAVING COUNT() > 3`. |
| 3. Messaging App Data Staging for Exfiltration | Adversaries copy messaging app data to staging directories before exfiltration, as in Turla campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - File Creation (Sysmon ID 11)<br>- Network Traffic (Sysmon ID 3) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename IN ("*teams*", "*slack*", "*whatsapp*") AND TargetFilename="*staging*" \| transaction ProcessGuid maxspan=5m [search EventCode=3 DestinationPort=443] \| where eventcount > 1 \| table _time, TargetFilename, DestinationIp, host`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FileName has_any ("teams", "slack", "whatsapp") and FolderPath contains "staging" \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 443) on ProcessId \| project Timestamp, FileName, RemoteIP, DeviceName`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = "creation" AND file.name : ("*teams*" OR "*slack*" OR "*whatsapp*") AND file.path : "*staging*" \| JOIN logs-endpoint.network-* ON process.pid WHERE destination.port = 443 \| TABLE @timestamp, file.name, destination.ip, host.name`. |
| 4. Messaging App Collection via Scripting Tools | Adversaries use PowerShell or Python to extract messaging app data, as in 2025 malware trends.<grok:render type="render_inline_citation"><argument name="citation_id">5</argument></grok:render> | - Process Creation (Sysmon ID 1 for scripts)<br>- File Access | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*powershell.exe", "*python.exe") AND CommandLine IN ("*teams*", "*slack*") \| join ProcessGuid [search EventCode=11 TargetFilename="*messaging*"] \| stats count by Image, TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("powershell.exe", "python.exe") and ProcessCommandLine has_any ("teams", "slack") \| join kind=inner (DeviceFileEvents \| where FileName contains "messaging") on ProcessId \| summarize count() by FolderPath, FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("powershell.exe" OR "python.exe") AND process.command_line : ("*teams*" OR "*slack*") \| JOIN logs-endpoint.file-* ON process.pid WHERE file.name : "*messaging*" \| STATS COUNT() BY process.name, file.name, host.name HAVING COUNT() > 3`. |
| 5. Messaging App Collection in Linux Environments | Adversaries target Linux messaging app data (e.g., Slack, Discord), as in general T1114.003.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - File Access (DS0022: auditd openat)<br>- Process Monitoring | - **Splunk**: `index=linux sourcetype=auditd syscall="openat" path IN ("*/.config/Slack/*", "*/.config/discord/*") AND NOT exe IN (legit_apps) \| stats count by path, exe, host \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileAccessed" and FolderPath has_any (".config/Slack", ".config/discord") and not(InitiatingProcessFolderPath in~ (legitApps)) \| summarize count() by FileName, InitiatingProcessFolderPath, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE syscall.name = "openat" AND file.path : ("*/.config/Slack/*" OR "*/.config/discord/*") AND NOT process.exe IN ['legit_apps'] \| STATS COUNT() BY file.path, process.exe, host.name HAVING COUNT() > 5`. |
| 6. Messaging App Collection by Compromised Accounts | Messaging app data accessed by accounts with suspicious logins, as in Nobelium attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Authentication Logs (DS0002: Azure AD Sign-ins)<br>- File Access | - **Splunk**: `index=security sourcetype=azure:ad:signin Status="success" AND IPAddress NOT IN (corporate_ranges) \| join UserPrincipalName [search sourcetype=sysmon EventCode=11 TargetFilename="*teams*"] \| stats count by UserPrincipalName, TargetFilename, host \| where count > 3`.<br>- **KQL**: `SigninLogs \| where Status == "success" and IPAddress !in (corporateRanges) \| join kind=inner (DeviceFileEvents \| where FileName contains "teams") on UserId \| summarize count() by UserId, FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-azure.signin-* \| WHERE event.outcome = "success" AND source.ip NOT IN ['corporate_ranges'] \| JOIN logs-endpoint.file-* ON user.id WHERE file.name : "*teams*" \| STATS COUNT() BY user.id, file.name, host.name HAVING COUNT() > 3`. |
| 7. Messaging App Collection with High File Access Volume | High volume of accesses to messaging app files, indicating bulk collection, as in APT41.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - File Access (Sysmon ID 11)<br>- File System Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename IN ("*teams*", "*slack*") \| timechart span=1h count by host \| where count > avg(count)*4`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileAccessed" and FileName has_any ("teams", "slack") \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 4`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = "access" AND file.name : ("*teams*" OR "*slack*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 4`. |
| 8. Messaging App Collection via Browser-Based Apps | Adversaries access messaging app data through browser local storage, as in 2025 trends.<grok:render type="render_inline_citation"><argument name="citation_id">5</argument></grok:render> | - Browser Process Logs (Sysmon ID 1)<br>- File Access | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*chrome.exe", "*firefox.exe") AND CommandLine IN ("*teams*", "*slack*") \| join ProcessGuid [search EventCode=11 TargetFilename="*Local Storage*"] \| stats count by Image, TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("chrome.exe", "firefox.exe") and ProcessCommandLine has_any ("teams", "slack") \| join kind=inner (DeviceFileEvents \| where FolderPath contains "Local Storage") on ProcessId \| summarize count() by FolderPath, FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("chrome.exe" OR "firefox.exe") AND process.command_line : ("*teams*" OR "*slack*") \| JOIN logs-endpoint.file-* ON process.pid WHERE file.path : "*Local Storage*" \| STATS COUNT() BY process.name, file.name, host.name HAVING COUNT() > 3`. |
| 9. Messaging App Collection in macOS Environments | Adversaries target macOS messaging app data (e.g., ~/Library/Application Support/Slack), as in general T1114.003.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Unified Logs (DS0022: macOS Unified Logs)<br>- File Access | - **Splunk**: `index=macos sourcetype=macos:unified event_type="file_access" AND file_path IN ("*/Library/Application Support/Slack/*", "*/Library/Application Support/Teams/*") AND NOT process IN (legit_apps) \| stats count by file_path, process, host \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileAccessed" and FolderPath has_any ("Library/Application Support/Slack", "Library/Application Support/Teams") and not(InitiatingProcessName in~ (legitApps)) \| summarize count() by FileName, InitiatingProcessName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-macos.unified-* \| WHERE event.type = "file_access" AND file.path : ("*/Library/Application Support/Slack/*" OR "*/Library/Application Support/Teams/*") AND NOT process.name IN ['legit_apps'] \| STATS COUNT() BY file.path, process.name, host.name HAVING COUNT() > 3`. |
| 10. Messaging App Collection with Compression for Exfiltration | Adversaries compress messaging app data for exfiltration, as in FIN7 attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (Sysmon ID 1 for compression tools)<br>- File Creation | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rar.exe", "*zip.exe") AND CommandLine IN ("*teams*", "*slack*") \| join ProcessGuid [search EventCode=11 TargetFilename="*messaging*"] \| stats count by Image, TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("rar.exe", "zip.exe") and ProcessCommandLine has_any ("teams", "slack") \| join kind=inner (DeviceFileEvents \| where FileName contains "messaging") on ProcessId \| summarize count() by FolderPath, FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("rar.exe" OR "zip.exe") AND process.command_line : ("*teams*" OR "*slack*") \| JOIN logs-endpoint.file-* ON process.pid WHERE file.name : "*messaging*" \| STATS COUNT() BY process.name, file.name, host.name HAVING COUNT() > 3`. |
| 11. Messaging App Collection via API Access | Adversaries use unauthorized API calls to collect messaging app data, as in APT29 campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Cloud Audit Logs (Azure AD App Activity)<br>- Network Traffic | - **Splunk**: `index=cloud sourcetype=azure:ad:appactivity AppId NOT IN (known_apps) AND Operation IN ("*messages*", "*chat*") \| join UserId [search index=network sourcetype=zeek_http uri="*teams*"] \| stats count by UserId, AppId \| where count > 3`.<br>- **KQL**: `AADAppActivity \| where AppId !in (knownApps) and Operation has_any ("messages", "chat") \| join kind=inner (DeviceNetworkEvents \| where RemoteUrl contains "teams") on UserId \| summarize count() by UserId, AppId \| where count_ > 3`.<br>- **ELK**: `FROM logs-azure.appactivity-* \| WHERE app.id NOT IN ['known_apps'] AND event.operation : ("*messages*" OR "*chat*") \| JOIN logs-zeek.http-* ON user.id WHERE http.uri : "*teams*" \| STATS COUNT() BY user.id, app.id HAVING COUNT() > 3`. |
| 12. Messaging App Collection in Cloud-Hybrid Environments | Adversaries access messaging app data from cloud-synced storage, as in hybrid attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Cloud Audit Logs (AWS CloudTrail)<br>- File Access | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="GetObject" AND bucket="*messaging*" \| join instanceId [search sourcetype=sysmon EventCode=11 "*teams*"] \| stats count by instanceId, TargetFilename \| where count > 3`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "GetObject" and BucketName contains "messaging" \| join kind=inner (DeviceFileEvents \| where FileName contains "teams") on DeviceName \| summarize count() by DeviceName, FileName \| where count_ > 3`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = "GetObject" AND s3.bucket : "*messaging*" \| JOIN logs-endpoint.file-* ON host.id WHERE file.name : "*teams*" \| STATS COUNT() BY host.id, file.name HAVING COUNT() > 3`. |
| 13. Messaging App Collection with Anomalous User Behavior | Messaging app data accessed by users with unusual behavior patterns, as in 2025 trends.<grok:render type="render_inline_citation"><argument name="citation_id">5</argument></grok:render> | - User Behavior Analytics (UBA)<br>- File Access | - **Splunk**: `index=security sourcetype=uba:anomaly event_type="file_activity" AND user NOT IN (known_users) \| join user [search sourcetype=sysmon EventCode=11 TargetFilename="*teams*"] \| stats count by user, TargetFilename, host \| where count > 3`.<br>- **KQL**: `UbaAnomalies \| where EventType == "file_activity" and User !in (knownUsers) \| join kind=inner (DeviceFileEvents \| where FileName contains "teams") on UserId \| summarize count() by UserId, FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-uba.anomaly-* \| WHERE event.type = "file_activity" AND user.name NOT IN ['known_users'] \| JOIN logs-endpoint.file-* ON user.id WHERE file.name : "*teams*" \| STATS COUNT() BY user.id, file.name, host.name HAVING COUNT() > 3`. |
| 14. Messaging App Collection with Suspicious File Copies | Adversaries copy messaging app data to alternate locations, as in FIN7 attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (Sysmon ID 1 for copy tools)<br>- File Creation | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*xcopy.exe", "*robocopy.exe") AND CommandLine IN ("*teams*", "*slack*") \| join ProcessGuid [search EventCode=11 TargetFilename="*messaging*"] \| stats count by Image, TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("xcopy.exe", "robocopy.exe") and ProcessCommandLine has_any ("teams", "slack") \| join kind=inner (DeviceFileEvents \| where FileName contains "messaging") on ProcessId \| summarize count() by FolderPath, FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("xcopy.exe" OR "robocopy.exe") AND process.command_line : ("*teams*" OR "*slack*") \| JOIN logs-endpoint.file-* ON process.pid WHERE file.name : "*messaging*" \| STATS COUNT() BY process.name, file.name, host.name HAVING COUNT() > 3`. |
| 15. Messaging App Collection with High CPU Usage | Processes accessing messaging app files consume high CPU, indicating bulk collection.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Performance Metrics (DS0023: Windows/Linux)<br>- File Access | - **Splunk**: `index=endpoint sourcetype=perfmon CPU>80 AND ProcessImage NOT IN (known_apps) \| join ProcessImage [search sourcetype=sysmon EventCode=11 TargetFilename="*teams*"] \| stats count by ProcessImage, TargetFilename, host \| where count > 3`.<br>- **KQL**: `DevicePerformanceEvents \| where CPUUsage > 80 and FolderPath !in (knownApps) \| join kind=inner (DeviceFileEvents \| where FileName contains "teams") on FolderPath \| summarize count() by FolderPath, FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.performance-* \| WHERE cpu.usage > 80 AND process.executable NOT IN ['known_apps'] \| JOIN logs-endpoint.file-* ON process.executable WHERE file.name : "*teams*" \| STATS COUNT() BY process.executable, file.name, host.name HAVING COUNT() > 3`. |


### Network Device Configuration Dump


| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Unauthorized Configuration Export Commands | Adversaries execute commands like `show running-config` or `export config` to dump configurations, as in APT28 attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> High risk in Cisco/Juniper environments. | - Network Device Logs (DS0026: Command Execution)<br>- Syslog (Cisco IOS, Juniper) | - **Splunk**: `index=network sourcetype=cisco:ios "show running-config" OR "export config" AND user NOT IN (authorized_admins) \| stats count by user, host, command \| where count > 3` (Detects unauthorized config export commands).<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Command has_any ("show running-config", "export config") and InitiatingProcessAccountName !in (authorizedAdmins) \| summarize count() by InitiatingProcessAccountName, DeviceName, AdditionalFields.Command \| where count_ > 3`.<br>- **ELK**: `FROM logs-cisco.ios-* \| WHERE message : ("*show running-config*" OR "*export config*") AND user.name NOT IN ['authorized_admins'] \| STATS COUNT() BY user.name, host.name, message HAVING COUNT() > 3`. |
| 2. Configuration Dump via SNMP | Adversaries use SNMP queries to extract device configurations, as in Snake malware campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> Common in environments with SNMP enabled. | - Network Traffic (DS0003: SNMP Traffic)<br>- Device Audit Logs | - **Splunk**: `index=network sourcetype=zeek_snmp oid IN ("*sysConfig*", "*runningConfig*") AND src_ip NOT IN (known_managers) \| stats count by src_ip, oid, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "SNMP" and AdditionalFields.OID has_any ("sysConfig", "runningConfig") and DeviceIP !in (knownManagers) \| summarize count() by DeviceIP, AdditionalFields.OID, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.snmp-* \| WHERE snmp.oid : ("*sysConfig*" OR "*runningConfig*") AND source.ip NOT IN ['known_managers'] \| STATS COUNT() BY source.ip, snmp.oid, destination.ip HAVING COUNT() > 5`. |
| 3. Configuration Dump Followed by Exfiltration | Dumped configurations are exfiltrated over protocols like TFTP or HTTP, as in APT28.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Network Traffic (DS0003: TFTP/HTTP Flow)<br>- Device Command Logs | - **Splunk**: `index=network sourcetype=zeek_tftp OR sourcetype=zeek_http uri="*config*" \| join src_ip [search sourcetype=cisco:ios "show running-config"] \| stats count by src_ip, uri, host \| where count > 3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol in ("TFTP", "HTTP") and RemoteUrl contains "config" \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.Command == "show running-config") on DeviceIP \| summarize count() by DeviceIP, RemoteUrl, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-zeek.tftp-* OR logs-zeek.http-* \| WHERE http.uri : "*config*" OR tftp.file : "*config*" \| JOIN logs-cisco.ios-* ON source.ip WHERE message : "*show running-config*" \| STATS COUNT() BY source.ip, http.uri, host.name HAVING COUNT() > 3`. |
| 4. Suspicious SSH/Telnet Sessions for Config Dumps | Adversaries use unauthorized SSH/Telnet sessions to dump configurations, as in Turla attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Authentication Logs (DS0002: Device Auth)<br>- Command Logs | - **Splunk**: `index=network sourcetype=cisco:ios "login" AND user NOT IN (authorized_admins) \| join host [search "show running-config"] \| stats count by user, host \| where count > 3`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Event == "login" and InitiatingProcessAccountName !in (authorizedAdmins) \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.Command == "show running-config") on DeviceName \| summarize count() by InitiatingProcessAccountName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-cisco.ios-* \| WHERE event.type = "login" AND user.name NOT IN ['authorized_admins'] \| JOIN logs-cisco.ios-* ON host.name WHERE message : "*show running-config*" \| STATS COUNT() BY user.name, host.name HAVING COUNT() > 3`. |
| 5. Configuration Dump from Compromised Endpoints | Adversaries use compromised endpoints to run config dump tools, as in FIN7 campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*scp *config*", "*tftp *config*") AND Image NOT IN (known_apps) \| join host [search index=network sourcetype=zeek_tftp "*config*"] \| stats count by Image, CommandLine, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("scp config", "tftp config") and not(FolderPath in~ (knownApps)) \| join kind=inner (DeviceNetworkEvents \| where RemoteUrl contains "config") on DeviceName \| summarize count() by FolderPath, ProcessCommandLine, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*scp*config*" OR "*tftp*config*") AND NOT process.executable IN ['known_apps'] \| JOIN logs-zeek.tftp-* ON host.name WHERE tftp.file : "*config*" \| STATS COUNT() BY process.executable, process.command_line, host.name HAVING COUNT() > 3`. |
| 6. Configuration Dump via Management Interfaces | Adversaries access web-based management interfaces (e.g., Cisco ASDM) to dump configs, as in 2025 trends.<grok:render type="render_inline_citation"><argument name="citation_id">5</argument></grok:render> | - Network Traffic (DS0003: HTTP Logs)<br>- Device Audit Logs | - **Splunk**: `index=network sourcetype=zeek_http uri IN ("*config*", "*download*") AND dest_port IN (443, 8443) AND src_ip NOT IN (known_managers) \| stats count by src_ip, uri, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any ("config", "download") and RemotePort in (443, 8443) and DeviceIP !in (knownManagers) \| summarize count() by DeviceIP, RemoteUrl, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri : ("*config*" OR "*download*") AND destination.port IN [443, 8443] AND source.ip NOT IN ['known_managers'] \| STATS COUNT() BY source.ip, http.uri, destination.ip HAVING COUNT() > 5`. |
| 7. Configuration Dump in Cloud-Managed Devices | Adversaries target cloud-managed network devices (e.g., Meraki) for config dumps, as in hybrid attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Cloud Audit Logs (AWS CloudTrail, Meraki Dashboard)<br>- Device Logs | - **Splunk**: `index=cloud sourcetype=meraki:audit action="config_download" AND user NOT IN (authorized_admins) \| join device_id [search sourcetype=cisco:ios "export config"] \| stats count by user, device_id \| where count > 3`.<br>- **KQL**: `MerakiAuditLogs \| where Action == "config_download" and User !in (authorizedAdmins) \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.Command == "export config") on DeviceName \| summarize count() by User, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-meraki.audit-* \| WHERE event.action = "config_download" AND user.name NOT IN ['authorized_admins'] \| JOIN logs-cisco.ios-* ON device.id WHERE message : "*export config*" \| STATS COUNT() BY user.name, device.id HAVING COUNT() > 3`. |
| 8. Configuration Dump with Anomalous Login Patterns | Config dumps following unusual login patterns to devices, as in APT41.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Authentication Logs (DS0002: Device Auth)<br>- Command Logs | - **Splunk**: `index=network sourcetype=cisco:ios "login" AND src_ip NOT IN (corporate_ranges) \| join host [search "show running-config"] \| stats count by src_ip, host \| where count > 3`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.Event == "login" and DeviceIP !in (corporateRanges) \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.Command == "show running-config") on DeviceName \| summarize count() by DeviceIP, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-cisco.ios-* \| WHERE event.type = "login" AND source.ip NOT IN ['corporate_ranges'] \| JOIN logs-cisco.ios-* ON host.name WHERE message : "*show running-config*" \| STATS COUNT() BY source.ip, host.name HAVING COUNT() > 3`. |
| 9. Configuration Dump with File Creation | Config dumps saved to local files on compromised endpoints, as in FIN7.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - File Creation (DS0022: Sysmon ID 11)<br>- Process Creation | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename IN ("*config.txt", "*running-config*") AND NOT ProcessImage IN (known_apps) \| stats count by TargetFilename, ProcessImage, host \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FileName has_any ("config.txt", "running-config") and not(InitiatingProcessFolderPath in~ (knownApps)) \| summarize count() by FileName, InitiatingProcessFolderPath, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = "creation" AND file.name : ("*config.txt" OR "*running-config*") AND NOT process.executable IN ['known_apps'] \| STATS COUNT() BY file.name, process.executable, host.name HAVING COUNT() > 3`. |
| 10. Configuration Dump with High Network Activity | High network activity following config dumps, indicating exfiltration.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Network Traffic (DS0003: Flow Data)<br>- Device Command Logs | - **Splunk**: `index=network sourcetype=zeek_conn bytes_out>1000000 AND src_ip IN (device_ips) \| join src_ip [search sourcetype=cisco:ios "show running-config"] \| stats count by src_ip, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where OutboundBytes > 1000000 and DeviceIP in (deviceIPs) \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.Command == "show running-config") on DeviceIP \| summarize count() by DeviceIP, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.bytes_out > 1000000 AND source.ip IN ['device_ips'] \| JOIN logs-cisco.ios-* ON source.ip WHERE message : "*show running-config*" \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 5`. |
| 11. Configuration Dump via Scripting Tools | Adversaries use scripts (e.g., Python, PowerShell) to automate config dumps, as in 2025 trends.<grok:render type="render_inline_citation"><argument name="citation_id">5</argument></grok:render> | - Process Creation (Sysmon ID 1 for scripts)<br>- Network Traffic | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*python.exe", "*powershell.exe") AND CommandLine IN ("*telnet*", "*ssh*", "*config*") \| join host [search index=network sourcetype=zeek_conn dest_port IN (23, 22)] \| stats count by Image, CommandLine, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("python.exe", "powershell.exe") and ProcessCommandLine has_any ("telnet", "ssh", "config") \| join kind=inner (DeviceNetworkEvents \| where RemotePort in (23, 22)) on DeviceName \| summarize count() by FolderPath, ProcessCommandLine, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("python.exe" OR "powershell.exe") AND process.command_line : ("*telnet*" OR "*ssh*" OR "*config*") \| JOIN logs-zeek.conn-* ON host.name WHERE destination.port IN [23, 22] \| STATS COUNT() BY process.name, process.command_line, host.name HAVING COUNT() > 3`. |
| 12. Configuration Dump from Unusual Source IPs | Config dumps initiated from non-standard management IPs, as in APT41.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Network Traffic (DS0003: Flow Data)<br>- Device Logs | - **Splunk**: `index=network sourcetype=zeek_conn dest_port IN (22, 23, 443) AND src_ip NOT IN (known_managers) \| join dest_ip [search sourcetype=cisco:ios "show running-config"] \| stats count by src_ip, dest_ip \| where count > 3`.<br>- **KQL**: `DeviceNetworkEvents \| where RemotePort in (22, 23, 443) and DeviceIP !in (knownManagers) \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.Command == "show running-config") on RemoteIP \| summarize count() by DeviceIP, RemoteIP \| where count_ > 3`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE destination.port IN [22, 23, 443] AND source.ip NOT IN ['known_managers'] \| JOIN logs-cisco.ios-* ON destination.ip WHERE message : "*show running-config*" \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 3`. |
| 13. Configuration Dump with Anomalous User Behavior | Config dumps by users with unusual behavior patterns, as in 2025 trends.<grok:render type="render_inline_citation"><argument name="citation_id">5</argument></grok:render> | - User Behavior Analytics (UBA)<br>- Device Command Logs | - **Splunk**: `index=security sourcetype=uba:anomaly event_type="device_access" AND user NOT IN (known_admins) \| join user [search sourcetype=cisco:ios "show running-config"] \| stats count by user, host \| where count > 3`.<br>- **KQL**: `UbaAnomalies \| where EventType == "device_access" and User !in (knownAdmins) \| join kind=inner (DeviceNetworkEvents \| where AdditionalFields.Command == "show running-config") on UserId \| summarize count() by UserId, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-uba.anomaly-* \| WHERE event.type = "device_access" AND user.name NOT IN ['known_admins'] \| JOIN logs-cisco.ios-* ON user.id WHERE message : "*show running-config*" \| STATS COUNT() BY user.id, host.name HAVING COUNT() > 3`. |
| 14. Configuration Dump via Backup Tools | Adversaries use backup tools (e.g., CiscoWorks) to extract configs, as in general T1601.002.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (Sysmon ID 1 for backup tools)<br>- File Creation | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*backup.exe", "*ciscoworks*") AND CommandLine="*config*" \| join ProcessGuid [search EventCode=11 TargetFilename="*config*"] \| stats count by Image, TargetFilename, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("backup.exe", "ciscoworks") and ProcessCommandLine contains "config" \| join kind=inner (DeviceFileEvents \| where FileName contains "config") on ProcessId \| summarize count() by FolderPath, FileName, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("backup.exe" OR "ciscoworks") AND process.command_line : "*config*" \| JOIN logs-endpoint.file-* ON process.pid WHERE file.name : "*config*" \| STATS COUNT() BY process.name, file.name, host.name HAVING COUNT() > 3`. |
| 15. Configuration Dump with High File Size | Large configuration files created locally, indicating bulk dumps.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - File Creation (Sysmon ID 11)<br>- File Metadata | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename IN ("*config.txt", "*running-config*") AND FileSize>1000000 \| stats count by TargetFilename, FileSize, host \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FileName has_any ("config.txt", "running-config") and AdditionalFields.FileSize > 1000000 \| summarize count() by FileName, AdditionalFields.FileSize, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = "creation" AND file.name : ("*config.txt" OR "*running-config*") AND file.size > 1000000 \| STATS COUNT() BY file.name, file.size, host.name HAVING COUNT() > 3`. |


### Remote Data Staging


| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Unauthorized Data Upload to Network Shares | Adversaries stage data on compromised network shares, as in APT41 campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> High risk in Windows environments with SMB shares. | - File Access (DS0022: Windows Event ID 5145)<br>- Network Traffic (SMB) | - **Splunk**: `index=windows EventCode=5145 ShareName IN ("*\\*", "*staging*") AND AccountName NOT IN (authorized_users) \| stats count by AccountName, ShareName, IpAddress \| where count > 5` (Detects unauthorized SMB share access).<br>- **KQL**: `SecurityEvent \| where EventID == 5145 and ShareName has_any ("*", "staging") and AccountName !in (authorizedUsers) \| summarize count() by AccountName, ShareName, IpAddress \| where count_ > 5`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 5145 AND winlog.share.name : ("**" OR "*staging*") AND winlog.user.name NOT IN ['authorized_users'] \| STATS COUNT() BY winlog.user.name, winlog.share.name, source.ip HAVING COUNT() > 5`. |
| 2. Data Staging in Cloud Storage | Adversaries upload data to cloud storage (e.g., AWS S3, Azure Blob), as in Nobelium attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> Common in cloud environments. | - Cloud Audit Logs (DS0028: AWS CloudTrail, Azure Activity)<br>- Network Traffic | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("PutObject", "UploadPart") AND userIdentity NOT IN (authorized_users) AND bucketName="*staging*" \| stats count by userIdentity, bucketName, src_ip \| where count > 5`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("PutObject", "UploadPart") and Caller !in (authorizedUsers) and BucketName contains "staging" \| summarize count() by Caller, BucketName, SourceIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['PutObject', 'UploadPart'] AND user.identity NOT IN ['authorized_users'] AND s3.bucket : '*staging*' \| STATS COUNT() BY user.identity, s3.bucket, source.ip HAVING COUNT() > 5`. |
| 3. Data Staging via FTP/SFTP Servers | Adversaries use FTP/SFTP to stage data on remote servers, as in FIN7 campaigns.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Network Traffic (DS0003: FTP/SFTP Flow)<br>- Process Creation (Sysmon ID 1) | - **Splunk**: `index=network sourcetype=zeek_ftp command IN ("STOR", "PUT") AND dest_ip NOT IN (known_servers) \| join src_ip [search index=endpoint sourcetype=sysmon EventCode=1 "*ftp*"] \| stats count by src_ip, dest_ip, command \| where count > 3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol in ("FTP", "SFTP") and AdditionalFields.Command in ("STOR", "PUT") and RemoteIP !in (knownServers) \| join kind=inner (DeviceProcessEvents \| where ProcessCommandLine contains "ftp") on DeviceIP \| summarize count() by DeviceIP, RemoteIP, AdditionalFields.Command \| where count_ > 3`.<br>- **ELK**: `FROM logs-zeek.ftp-* \| WHERE ftp.command IN ['STOR', 'PUT'] AND destination.ip NOT IN ['known_servers'] \| JOIN logs-endpoint.process-* ON source.ip WHERE process.command_line : '*ftp*' \| STATS COUNT() BY source.ip, destination.ip, ftp.command HAVING COUNT() > 3`. |
| 4. Data Staging with Compression on Remote Systems | Adversaries compress data before staging on remote systems, as in Turla attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Process Creation (Sysmon ID 1 for compression tools)<br>- Network Traffic | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*rar.exe", "*zip.exe", "*tar*") AND CommandLine="*staging*" \| join host [search index=network sourcetype=zeek_conn dest_port IN (445, 21, 22)] \| stats count by Image, dest_ip, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("rar.exe", "zip.exe", "tar") and ProcessCommandLine contains "staging" \| join kind=inner (DeviceNetworkEvents \| where RemotePort in (445, 21, 22)) on DeviceName \| summarize count() by FolderPath, RemoteIP, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("rar.exe" OR "zip.exe" OR "tar") AND process.command_line : "*staging*" \| JOIN logs-zeek.conn-* ON host.name WHERE destination.port IN [445, 21, 22] \| STATS COUNT() BY process.name, destination.ip, host.name HAVING COUNT() > 3`. |
| 5. Data Staging by Compromised Accounts | Staging activities by accounts with suspicious logins, as in Nobelium attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Authentication Logs (DS0002: Azure AD Sign-ins)<br>- Cloud Audit Logs | - **Splunk**: `index=security sourcetype=azure:ad:signin Status="success" AND IPAddress NOT IN (corporate_ranges) \| join UserPrincipalName [search index=cloud sourcetype=aws:cloudtrail eventName="PutObject" bucketName="*staging*"] \| stats count by UserPrincipalName, bucketName \| where count > 3`.<br>- **KQL**: `SigninLogs \| where Status == "success" and IPAddress !in (corporateRanges) \| join kind=inner (AWSCloudTrail \| where EventName == "PutObject" and BucketName contains "staging") on UserId \| summarize count() by UserId, BucketName \| where count_ > 3`.<br>- **ELK**: `FROM logs-azure.signin-* \| WHERE event.outcome = "success" AND source.ip NOT IN ['corporate_ranges'] \| JOIN logs-aws.cloudtrail-* ON user.id WHERE event.action = "PutObject" AND s3.bucket : "*staging*" \| STATS COUNT() BY user.id, s3.bucket HAVING COUNT() > 3`. |
| 6. Data Staging in Linux Remote Servers | Adversaries stage data on Linux servers via SCP or rsync, as in general T1074.002.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - File Access (DS0022: auditd openat)<br>- Network Traffic | - **Splunk**: `index=linux sourcetype=auditd syscall="openat" path="*staging*" AND exe IN ("*scp*", "*rsync*") \| join host [search index=network sourcetype=zeek_conn dest_port=22] \| stats count by path, exe, dest_ip \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileAccessed" and FolderPath contains "staging" and InitiatingProcessFolderPath has_any ("scp", "rsync") \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 22) on DeviceName \| summarize count() by FileName, InitiatingProcessFolderPath, RemoteIP \| where count_ > 3`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE syscall.name = "openat" AND file.path : "*staging*" AND process.exe : ("*scp*" OR "*rsync*") \| JOIN logs-zeek.conn-* ON host.name WHERE destination.port = 22 \| STATS COUNT() BY file.path, process.exe, destination.ip HAVING COUNT() > 3`. |
| 7. Data Staging with High Network Transfer Volume | High volume of data transferred to remote systems, indicating staging, as in APT41.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Network Traffic (DS0003: Flow Data)<br>- File Creation | - **Splunk**: `index=network sourcetype=zeek_conn bytes_out>1000000 AND dest_ip NOT IN (known_servers) \| join src_ip [search index=endpoint sourcetype=sysmon EventCode=11 "*staging*"] \| stats count by src_ip, dest_ip, host \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where OutboundBytes > 1000000 and RemoteIP !in (knownServers) \| join kind=inner (DeviceFileEvents \| where FolderPath contains "staging") on DeviceIP \| summarize count() by DeviceIP, RemoteIP, DeviceName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE network.bytes_out > 1000000 AND destination.ip NOT IN ['known_servers'] \| JOIN logs-endpoint.file-* ON source.ip WHERE file.path : "*staging*" \| STATS COUNT() BY source.ip, destination.ip, host.name HAVING COUNT() > 5`. |
| 8. Data Staging in Cloud-Managed Shares | Adversaries stage data in cloud-managed file shares (e.g., OneDrive, SharePoint), as in 2025 trends.<grok:render type="render_inline_citation"><argument name="citation_id">5</argument></grok:render> | - Cloud Audit Logs (Microsoft 365 Audit)<br>- File Access | - **Splunk**: `index=cloud sourcetype=o365:audit Operation IN ("FileUploaded", "FileModified") AND Target="*staging*" AND UserId NOT IN (authorized_users) \| stats count by UserId, Target, src_ip \| where count > 5`.<br>- **KQL**: `OfficeActivity \| where Operation in ("FileUploaded", "FileModified") and Target contains "staging" and UserId !in (authorizedUsers) \| summarize count() by UserId, Target, ClientIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-o365.audit-* \| WHERE event.action IN ['FileUploaded', 'FileModified'] AND file.name : "*staging*" AND user.id NOT IN ['authorized_users'] \| STATS COUNT() BY user.id, file.name, source.ip HAVING COUNT() > 5`. |
| 9. Data Staging with Suspicious File Extensions | Files with unusual extensions (e.g., .dat, .bin) staged on remote systems, as in Turla.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - File Creation (Sysmon ID 11)<br>- Network Traffic | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename IN ("*.dat", "*.bin") AND TargetFilename="*staging*" \| join host [search index=network sourcetype=zeek_conn dest_port IN (445, 21)] \| stats count by TargetFilename, dest_ip, host \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FileName has_any (".dat", ".bin") and FolderPath contains "staging" \| join kind=inner (DeviceNetworkEvents \| where RemotePort in (445, 21)) on DeviceName \| summarize count() by FileName, RemoteIP, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = "creation" AND file.name : ("*.dat" OR "*.bin") AND file.path : "*staging*" \| JOIN logs-zeek.conn-* ON host.name WHERE destination.port IN [445, 21] \| STATS COUNT() BY file.name, destination.ip, host.name HAVING COUNT() > 3`. |
| 10. Data Staging via WebDAV or HTTP Uploads | Adversaries use WebDAV or HTTP to stage data on remote web servers, as in FIN7.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Network Traffic (DS0003: HTTP/WebDAV)<br>- Process Creation | - **Splunk**: `index=network sourcetype=zeek_http method IN ("PUT", "PROPFIND") AND uri="*staging*" AND src_ip NOT IN (known_clients) \| join src_ip [search index=endpoint sourcetype=sysmon EventCode=1 "*http*"] \| stats count by src_ip, uri, host \| where count > 3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.Method in ("PUT", "PROPFIND") and RemoteUrl contains "staging" and DeviceIP !in (knownClients) \| join kind=inner (DeviceProcessEvents \| where ProcessCommandLine contains "http") on DeviceIP \| summarize count() by DeviceIP, RemoteUrl, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.method IN ['PUT', 'PROPFIND'] AND http.uri : "*staging*" AND source.ip NOT IN ['known_clients'] \| JOIN logs-endpoint.process-* ON source.ip WHERE process.command_line : "*http*" \| STATS COUNT() BY source.ip, http.uri, host.name HAVING COUNT() > 3`. |
| 11. Data Staging with Encryption Tools | Adversaries encrypt data before staging on remote systems, as in 2025 trends.<grok:render type="render_inline_citation"><argument name="citation_id">5</argument></grok:render> | - Process Creation (Sysmon ID 1 for encryption tools)<br>- Network Traffic | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*gpg.exe", "*openssl.exe") AND CommandLine="*encrypt*" \| join host [search index=network sourcetype=zeek_conn dest_port IN (445, 21, 22)] \| stats count by Image, dest_ip, host \| where count > 3`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("gpg.exe", "openssl.exe") and ProcessCommandLine contains "encrypt" \| join kind=inner (DeviceNetworkEvents \| where RemotePort in (445, 21, 22)) on DeviceName \| summarize count() by FolderPath, RemoteIP, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.name : ("gpg.exe" OR "openssl.exe") AND process.command_line : "*encrypt*" \| JOIN logs-zeek.conn-* ON host.name WHERE destination.port IN [445, 21, 22] \| STATS COUNT() BY process.name, destination.ip, host.name HAVING COUNT() > 3`. |
| 12. Data Staging in Kubernetes Pods | Adversaries stage data in compromised Kubernetes pods, as in cloud-native attacks.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Container Logs (DS0029: Kubernetes Events)<br>- Network Traffic | - **Splunk**: `index=container sourcetype=k8s:events "exec" AND message="*staging*" \| join pod_name [search index=network sourcetype=zeek_conn dest_port IN (445, 21)] \| stats count by pod_name, dest_ip \| where count > 3`.<br>- **KQL**: `KubeEvents \| where Verb == "exec" and Message contains "staging" \| join kind=inner (DeviceNetworkEvents \| where RemotePort in (445, 21)) on ObjectRef.name \| summarize count() by ObjectRef.name, RemoteIP \| where count_ > 3`.<br>- **ELK**: `FROM logs-kubernetes.events-* \| WHERE kubernetes.event.verb = "exec" AND message : "*staging*" \| JOIN logs-zeek.conn-* ON kubernetes.pod.name WHERE destination.port IN [445, 21] \| STATS COUNT() BY kubernetes.pod.name, destination.ip HAVING COUNT() > 3`. |
| 13. Data Staging with Anomalous User Behavior | Staging activities by users with unusual behavior patterns, as in 2025 trends.<grok:render type="render_inline_citation"><argument name="citation_id">5</argument></grok:render> | - User Behavior Analytics (UBA)<br>- File Access | - **Splunk**: `index=security sourcetype=uba:anomaly event_type="file_activity" AND user NOT IN (known_users) \| join user [search index=cloud sourcetype=aws:cloudtrail eventName="PutObject" bucketName="*staging*"] \| stats count by user, bucketName \| where count > 3`.<br>- **KQL**: `UbaAnomalies \| where EventType == "file_activity" and User !in (knownUsers) \| join kind=inner (AWSCloudTrail \| where EventName == "PutObject" and BucketName contains "staging") on UserId \| summarize count() by UserId, BucketName \| where count_ > 3`.<br>- **ELK**: `FROM logs-uba.anomaly-* \| WHERE event.type = "file_activity" AND user.name NOT IN ['known_users'] \| JOIN logs-aws.cloudtrail-* ON user.id WHERE event.action = "PutObject" AND s3.bucket : "*staging*" \| STATS COUNT() BY user.id, s3.bucket HAVING COUNT() > 3`. |
| 14. Data Staging with Suspicious File Sizes | Large files staged on remote systems, indicating bulk data collection.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - File Creation (Sysmon ID 11)<br>- Network Traffic | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename="*staging*" AND FileSize>1000000 \| join host [search index=network sourcetype=zeek_conn bytes_out>1000000] \| stats count by TargetFilename, dest_ip, host \| where count > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FolderPath contains "staging" and AdditionalFields.FileSize > 1000000 \| join kind=inner (DeviceNetworkEvents \| where OutboundBytes > 1000000) on DeviceName \| summarize count() by FileName, RemoteIP, DeviceName \| where count_ > 3`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE event.action = "creation" AND file.path : "*staging*" AND file.size > 1000000 \| JOIN logs-zeek.conn-* ON host.name WHERE network.bytes_out > 1000000 \| STATS COUNT() BY file.name, destination.ip, host.name HAVING COUNT() > 3`. |
| 15. Data Staging via Remote Desktop Protocols | Adversaries use RDP to stage data on remote systems, as in APT41.<grok:render type="render_inline_citation"><argument name="citation_id">0</argument></grok:render> | - Authentication Logs (DS0002: Event ID 4624)<br>- File Creation | - **Splunk**: `index=windows EventCode=4624 LogonType=10 AND AccountName NOT IN (authorized_users) \| join ComputerName [search index=endpoint sourcetype=sysmon EventCode=11 "*staging*"] \| stats count by AccountName, TargetFilename, ComputerName \| where count > 3`.<br>- **KQL**: `SecurityEvent \| where EventID == 4624 and LogonType == 10 and AccountName !in (authorizedUsers) \| join kind=inner (DeviceFileEvents \| where FolderPath contains "staging") on ComputerName \| summarize count() by AccountName, FileName, ComputerName \| where count_ > 3`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 4624 AND winlog.logon.type = '10' AND winlog.user.name NOT IN ['authorized_users'] \| JOIN logs-endpoint.file-* ON winlog.computer_name WHERE file.path : "*staging*" \| STATS COUNT() BY winlog.user.name, file.name, winlog.computer_name HAVING COUNT() > 3`. |


### Remote Email Collection



### SNMP (MIB Dump)



### Screen Capture



### Sharepoint



### Video Capture



### Web Portal Capture




