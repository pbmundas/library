---
layout: default
title:  Resource Development
category: Threat-Hunting-Queries  # This becomes a main topic in sidebar
---

## Resource Development
### T1583: Acquire Infrastructure

### T1583.001: Domains

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Domain Registrations | Adversaries register domains mimicking legitimate ones for phishing, as in Volt Typhoon. | - DNS Logs (DS0001)<br>- Threat Intelligence | - **Splunk**: `index=dns sourcetype=zeek_dns query IN ("*login*", "*secure*") AND domain_age < 30 days AND src_ip NOT IN (trusted_ips) \| stats count by src_ip, query \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and DnsQueryName has_any ("login", "secure") and DomainAge < 30 and DeviceIP !in (trustedIPs) \| summarize count() by DeviceIP, DnsQueryName \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE dns.query : ("*login*" OR "*secure*") AND dns.domain_age < 30 AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, dns.query HAVING COUNT() > 10`. |
| 2. DNS Queries to Newly Registered Domains | Adversaries query newly registered domains for C2, as in APT41. | - DNS Logs (DS0001)<br>- Threat Intelligence | - **Splunk**: `index=dns sourcetype=zeek_dns domain_age < 7 days AND src_ip NOT IN (trusted_ips) \| stats count by src_ip, query \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and DomainAge < 7 and DeviceIP !in (trustedIPs) \| summarize count() by DeviceIP, DnsQueryName \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE dns.domain_age < 7 AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, dns.query HAVING COUNT() > 10`. |
| 3. Domains Used in Phishing Campaigns | Adversaries use domains for phishing emails, as in 2025 trends. | - Email Logs (DS0004)<br>- DNS Logs (DS0001) | - **Splunk**: `index=email sourcetype=zeek_smtp src_domain IN (new_domains) AND src_ip NOT IN (trusted_ips) \| stats count by src_ip, src_domain \| where count > 10`.<br>- **KQL**: `EmailEvents \| where SenderDomain in (newDomains) and SenderIP !in (trustedIPs) \| summarize count() by SenderIP, SenderDomain \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.smtp-* \| WHERE email.from_domain IN ['new_domains'] AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, email.from_domain HAVING COUNT() > 10`. |
| 4. Anomalous DNS Queries to Suspicious Domains | High-frequency DNS queries to suspicious domains, as in APT29. | - DNS Logs (DS0001)<br>- Metrics | - **Splunk**: `index=dns sourcetype=zeek_dns query NOT IN (known_domains) \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and DnsQueryName !in (knownDomains) \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE dns.query NOT IN ['known_domains'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 5. Domain Access from Compromised Endpoints | Compromised endpoints query malicious domains, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- DNS Logs (DS0001) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*curl*", "*wget*") \| join host [search index=dns sourcetype=zeek_dns query IN (suspicious_domains)] \| stats count by host, CommandLine, query \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("curl", "wget") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "DNS" and DnsQueryName in (suspiciousDomains)) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, DnsQueryName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*curl*" OR "*wget*") \| JOIN logs-zeek.dns-* ON host.name WHERE dns.query IN ['suspicious_domains'] \| STATS COUNT() BY host.name, process.command_line, dns.query HAVING COUNT() > 5`. |
| 6. Domain Access via Browser Automation | Adversaries use browser automation to access malicious domains, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- DNS Logs (DS0001) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*selenium*", "*puppeteer*") \| join host [search index=dns sourcetype=zeek_dns query IN (suspicious_domains)] \| stats count by host, CommandLine, query \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("selenium", "puppeteer") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "DNS" and DnsQueryName in (suspiciousDomains)) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, DnsQueryName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*selenium*" OR "*puppeteer*") \| JOIN logs-zeek.dns-* ON host.name WHERE dns.query IN ['suspicious_domains'] \| STATS COUNT() BY host.name, process.command_line, dns.query HAVING COUNT() > 5`. |
| 7. Domain Access in Linux Environments | Adversaries use Linux tools to query malicious domains, as in Turla. | - Process Creation (Linux Auditd)<br>- DNS Logs (DS0001) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*curl*", "*wget*") AND args IN (suspicious_domains) \| stats count by host, exe \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("curl", "wget") and CommandLine has_any (suspiciousDomains) \| summarize count() by HostName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*curl*" OR "*wget*") AND process.args IN ['suspicious_domains'] \| STATS COUNT() BY host.name, process.exe HAVING COUNT() > 5`. |
| 8. Suspicious Domain Access with Non-Standard User Agents | Adversaries use non-standard user agents to access domains, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- DNS Logs (DS0001) | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND uri IN (suspicious_domains) \| stats count by src_ip, user_agent, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and RemoteUrl in (suspiciousDomains) \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND http.uri IN ['suspicious_domains'] \| STATS COUNT() BY source.ip, http.user_agent, http.uri HAVING COUNT() > 10`. |
| 9. High-Frequency Domain Queries | High-frequency DNS queries to suspicious domains, as in APT41. | - DNS Logs (DS0001)<br>- Metrics | - **Splunk**: `index=dns sourcetype=zeek_dns query IN (suspicious_domains) \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and DnsQueryName in (suspiciousDomains) \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE dns.query IN ['suspicious_domains'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 10. Domain Access via Known Malicious IPs | Access to suspicious domains from known malicious IPs, as in Volt Typhoon. | - DNS Logs (DS0001)<br>- Threat Intelligence | - **Splunk**: `index=dns sourcetype=zeek_dns src_ip IN (threat_intel_ips) AND query IN (suspicious_domains) \| stats count by src_ip, query \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceIP in (threatIntelIPs) and DnsQueryName in (suspiciousDomains) \| summarize count() by DeviceIP, DnsQueryName \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE source.ip IN ['threat_intel_ips'] AND dns.query IN ['suspicious_domains'] \| STATS COUNT() BY source.ip, dns.query HAVING COUNT() > 10`. |

### T1583.002: Server

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Suspicious Server Connections | Adversaries use compromised servers for C2 communication, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Firewall Logs | - **Splunk**: `index=network sourcetype=zeek_http dest_ip NOT IN (trusted_ips) AND response_status_code IN ("200", "404") \| stats count by src_ip, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP !in (trustedIPs) and ResponseStatusCode in ("200", "404") \| summarize count() by DeviceIP, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE destination.ip NOT IN ['trusted_ips'] AND http.response.status_code IN ['200', '404'] \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 10`. |
| 2. Anomalous Server Traffic Patterns | High-frequency connections to unknown servers, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http dest_ip NOT IN (known_servers) \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP !in (knownServers) \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE destination.ip NOT IN ['known_servers'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 3. Server Access via Cloud APIs | Adversaries access cloud-hosted servers via APIs, as in 2025 trends. | - Cloud Audit Logs (AWS CloudTrail)<br>- Authentication Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("RunInstances", "DescribeInstances") AND userIdentity NOT IN (authorized_users) \| stats count by src_ip, eventName \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("RunInstances", "DescribeInstances") and Caller !in (authorizedUsers) \| summarize count() by SourceIP, EventName \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['RunInstances', 'DescribeInstances'] AND user.identity NOT IN ['authorized_users'] \| STATS COUNT() BY source.ip, event.action HAVING COUNT() > 10`. |
| 4. Server Connections from Compromised Endpoints | Compromised endpoints connect to malicious servers, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*curl*", "*wget*") \| join host [search index=network sourcetype=zeek_http dest_ip NOT IN (trusted_ips)] \| stats count by host, CommandLine, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("curl", "wget") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP !in (trustedIPs)) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*curl*" OR "*wget*") \| JOIN logs-zeek.http-* ON host.name WHERE destination.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY host.name, process.command_line, destination.ip HAVING COUNT() > 5`. |
| 5. Server Access via Browser Automation | Adversaries use browser automation to access servers, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*selenium*", "*puppeteer*") \| join host [search index=network sourcetype=zeek_http dest_ip NOT IN (trusted_ips)] \| stats count by host, CommandLine, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("selenium", "puppeteer") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP !in (trustedIPs)) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*selenium*" OR "*puppeteer*") \| JOIN logs-zeek.http-* ON host.name WHERE destination.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY host.name, process.command_line, destination.ip HAVING COUNT() > 5`. |
| 6. Server Connections in Linux Environments | Adversaries use Linux tools to connect to malicious servers, as in Turla. | - Process Creation (Linux Auditd)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*curl*", "*wget*") AND args NOT IN (trusted_ips) \| stats count by host, exe \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("curl", "wget") and CommandLine !has_any (trustedIPs) \| summarize count() by HostName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*curl*" OR "*wget*") AND process.args NOT IN ['trusted_ips'] \| STATS COUNT() BY host.name, process.exe HAVING COUNT() > 5`. |
| 7. Server Access with Suspicious User Agents | Adversaries use non-standard user agents to access servers, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND dest_ip NOT IN (trusted_ips) \| stats count by src_ip, user_agent, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and RemoteIP !in (trustedIPs) \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND destination.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, http.user_agent, destination.ip HAVING COUNT() > 10`. |
| 8. High-Frequency Server Connections | High-frequency connections to unknown servers, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http dest_ip NOT IN (trusted_ips) \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP !in (trustedIPs) \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE destination.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 9. Server Connections via Known Malicious IPs | Connections to servers from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http src_ip IN (threat_intel_ips) AND dest_ip NOT IN (trusted_ips) \| stats count by src_ip, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceIP in (threatIntelIPs) and RemoteIP !in (trustedIPs) \| summarize count() by DeviceIP, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE source.ip IN ['threat_intel_ips'] AND destination.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 10`. |
| 10. Server Access with Anomalous Ports | Adversaries use non-standard ports to access servers, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn)<br>- Firewall Logs | - **Splunk**: `index=network sourcetype=zeek_conn dest_port NOT IN (80, 443) AND dest_ip NOT IN (trusted_ips) \| stats count by src_ip, dest_ip, dest_port \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where RemotePort !in (80, 443) and RemoteIP !in (trustedIPs) \| summarize count() by DeviceIP, RemoteIP, RemotePort \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE destination.port NOT IN [80, 443] AND destination.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, destination.ip, destination.port HAVING COUNT() > 10`. |

### T1583.003: Virtual Private Server (VPS)

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. VPS Connections for C2 | Adversaries use VPS for C2 communication, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Firewall Logs | - **Splunk**: `index=network sourcetype=zeek_http dest_ip IN (vps_providers) AND response_status_code IN ("200", "404") \| stats count by src_ip, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (vpsProviders) and ResponseStatusCode in ("200", "404") \| summarize count() by DeviceIP, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE destination.ip IN ['vps_providers'] AND http.response.status_code IN ['200', '404'] \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 10`. |
| 2. Anomalous VPS Traffic Patterns | High-frequency connections to VPS providers, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http dest_ip IN (vps_providers) \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (vpsProviders) \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE destination.ip IN ['vps_providers'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 3. VPS Access via Cloud APIs | Adversaries access VPS via cloud APIs, as in 2025 trends. | - Cloud Audit Logs (AWS CloudTrail)<br>- Authentication Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("RunInstances", "DescribeInstances") AND requestParameters IN ("*vps*") AND userIdentity NOT IN (authorized_users) \| stats count by src_ip, eventName \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("RunInstances", "DescribeInstances") and RequestParameters has_any ("vps") and Caller !in (authorizedUsers) \| summarize count() by SourceIP, EventName \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['RunInstances', 'DescribeInstances'] AND event.request_parameters : ("*vps*") AND user.identity NOT IN ['authorized_users'] \| STATS COUNT() BY source.ip, event.action HAVING COUNT() > 10`. |
| 4. VPS Connections from Compromised Endpoints | Compromised endpoints connect to VPS, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*curl*", "*wget*") \| join host [search index=network sourcetype=zeek_http dest_ip IN (vps_providers)] \| stats count by host, CommandLine, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("curl", "wget") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (vpsProviders)) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*curl*" OR "*wget*") \| JOIN logs-zeek.http-* ON host.name WHERE destination.ip IN ['vps_providers'] \| STATS COUNT() BY host.name, process.command_line, destination.ip HAVING COUNT() > 5`. |
| 5. VPS Access via Browser Automation | Adversaries use browser automation to access VPS, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*selenium*", "*puppeteer*") \| join host [search index=network sourcetype=zeek_http dest_ip IN (vps_providers)] \| stats count by host, CommandLine, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("selenium", "puppeteer") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (vpsProviders)) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*selenium*" OR "*puppeteer*") \| JOIN logs-zeek.http-* ON host.name WHERE destination.ip IN ['vps_providers'] \| STATS COUNT() BY host.name, process.command_line, destination.ip HAVING COUNT() > 5`. |
| 6. VPS Connections in Linux Environments | Adversaries use Linux tools to connect to VPS, as in Turla. | - Process Creation (Linux Auditd)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*curl*", "*wget*") AND args IN (vps_providers) \| stats count by host, exe \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("curl", "wget") and CommandLine has_any (vpsProviders) \| summarize count() by HostName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*curl*" OR "*wget*") AND process.args IN ['vps_providers'] \| STATS COUNT() BY host.name, process.exe HAVING COUNT() > 5`. |
| 7. VPS Access with Suspicious User Agents | Adversaries use non-standard user agents to access VPS, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND dest_ip IN (vps_providers) \| stats count by src_ip, user_agent, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and RemoteIP in (vpsProviders) \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND destination.ip IN ['vps_providers'] \| STATS COUNT() BY source.ip, http.user_agent, destination.ip HAVING COUNT() > 10`. |
| 8. High-Frequency VPS Connections | High-frequency connections to VPS providers, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http dest_ip IN (vps_providers) \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (vpsProviders) \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE destination.ip IN ['vps_providers'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 9. VPS Connections via Known Malicious IPs | Connections to VPS from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http src_ip IN (threat_intel_ips) AND dest_ip IN (vps_providers) \| stats count by src_ip, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceIP in (threatIntelIPs) and RemoteIP in (vpsProviders) \| summarize count() by DeviceIP, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE source.ip IN ['threat_intel_ips'] AND destination.ip IN ['vps_providers'] \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 10`. |
| 10. VPS Access with Anomalous Ports | Adversaries use non-standard ports to access VPS, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn)<br>- Firewall Logs | - **Splunk**: `index=network sourcetype=zeek_conn dest_port NOT IN (80, 443) AND dest_ip IN (vps_providers) \| stats count by src_ip, dest_ip, dest_port \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where RemotePort !in (80, 443) and RemoteIP in (vpsProviders) \| summarize count() by DeviceIP, RemoteIP, RemotePort \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE destination.port NOT IN [80, 443] AND destination.ip IN ['vps_providers'] \| STATS COUNT() BY source.ip, destination.ip, destination.port HAVING COUNT() > 10`. |

### T1583.004: Serverless

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Serverless Function Abuse for C2 | Adversaries use serverless functions (e.g., AWS Lambda) for C2, as in Volt Typhoon. | - Cloud Audit Logs (AWS CloudTrail)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("Invoke", "CreateFunction") AND userIdentity NOT IN (authorized_users) \| stats count by src_ip, eventName \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("Invoke", "CreateFunction") and Caller !in (authorizedUsers) \| summarize count() by SourceIP, EventName \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['Invoke', 'CreateFunction'] AND user.identity NOT IN ['authorized_users'] \| STATS COUNT() BY source.ip, event.action HAVING COUNT() > 10`. |
| 2. Anomalous Serverless Function Invocations | High-frequency serverless function invocations, as in APT41. | - Cloud Audit Logs (AWS CloudTrail)<br>- Metrics | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="Invoke" \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "Invoke" \| summarize MinuteCount=count() by bin(Timestamp, 1m), SourceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action == 'Invoke' \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 3. Serverless Access from Compromised Endpoints | Compromised endpoints invoke serverless functions, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Cloud Audit Logs (AWS CloudTrail) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*aws cli*", "*boto3*") \| join host [search index=cloud sourcetype=aws:cloudtrail eventName="Invoke"] \| stats count by host, CommandLine, eventName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("aws cli", "boto3") \| join kind=inner (AWSCloudTrail \| where EventName == "Invoke") on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, EventName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*aws cli*" OR "*boto3*") \| JOIN logs-aws.cloudtrail-* ON host.name WHERE event.action == 'Invoke' \| STATS COUNT() BY host.name, process.command_line, event.action HAVING COUNT() > 5`. |
| 4. Serverless Function Creation by Unauthorized Users | Unauthorized users create serverless functions, as in 2025 trends. | - Cloud Audit Logs (AWS CloudTrail)<br>- Authentication Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="CreateFunction" AND userIdentity NOT IN (authorized_users) \| stats count by src_ip, userIdentity \| where count > 5`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "CreateFunction" and Caller !in (authorizedUsers) \| summarize count() by SourceIP, Caller \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action == 'CreateFunction' AND user.identity NOT IN ['authorized_users'] \| STATS COUNT() BY source.ip, user.identity HAVING COUNT() > 5`. |
| 5. Serverless Access via Browser Automation | Adversaries use browser automation to invoke serverless functions, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- Cloud Audit Logs (AWS CloudTrail) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*selenium*", "*puppeteer*") \| join host [search index=cloud sourcetype=aws:cloudtrail eventName="Invoke"] \| stats count by host, CommandLine, eventName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("selenium", "puppeteer") \| join kind=inner (AWSCloudTrail \| where EventName == "Invoke") on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, EventName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*selenium*" OR "*puppeteer*") \| JOIN logs-aws.cloudtrail-* ON host.name WHERE event.action == 'Invoke' \| STATS COUNT() BY host.name, process.command_line, event.action HAVING COUNT() > 5`. |
| 6. Serverless Access in Linux Environments | Adversaries use Linux tools to invoke serverless functions, as in Turla. | - Process Creation (Linux Auditd)<br>- Cloud Audit Logs (AWS CloudTrail) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*aws*", "*boto3*") AND args IN ("*lambda*") \| stats count by host, exe \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("aws", "boto3") and CommandLine has_any ("lambda") \| summarize count() by HostName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*aws*" OR "*boto3*") AND process.args : ("*lambda*") \| STATS COUNT() BY host.name, process.exe HAVING COUNT() > 5`. |
| 7. Serverless Access with Suspicious User Agents | Adversaries use non-standard user agents to invoke serverless functions, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Cloud Audit Logs (AWS CloudTrail) | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND uri IN ("*lambda*") \| join src_ip [search index=cloud sourcetype=aws:cloudtrail eventName="Invoke"] \| stats count by src_ip, user_agent, eventName \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and RemoteUrl has_any ("lambda") \| join kind=inner (AWSCloudTrail \| where EventName == "Invoke") on SourceIP \| summarize count() by SourceIP, AdditionalFields.UserAgent, EventName \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND http.uri : ("*lambda*") \| JOIN logs-aws.cloudtrail-* ON source.ip WHERE event.action == 'Invoke' \| STATS COUNT() BY source.ip, http.user_agent, event.action HAVING COUNT() > 10`. |
| 8. High-Frequency Serverless Invocations | High-frequency serverless function invocations, as in APT41. | - Cloud Audit Logs (AWS CloudTrail)<br>- Metrics | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="Invoke" \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "Invoke" \| summarize MinuteCount=count() by bin(Timestamp, 1m), SourceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action == 'Invoke' \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 9. Serverless Access via Known Malicious IPs | Serverless function invocations from known malicious IPs, as in Volt Typhoon. | - Cloud Audit Logs (AWS CloudTrail)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="Invoke" AND src_ip IN (threat_intel_ips) \| stats count by src_ip, eventName \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "Invoke" and SourceIP in (threatIntelIPs) \| summarize count() by SourceIP, EventName \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action == 'Invoke' AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY source.ip, event.action HAVING COUNT() > 10`. |
| 10. Serverless Access with Anomalous Timing | Serverless function invocations outside business hours, as in APT29. | - Cloud Audit Logs (AWS CloudTrail)<br>- Metrics | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="Invoke" \| timechart span=1h count by src_ip \| where count > avg(count)*3 AND (_time < "08:00" OR _time > "18:00")`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "Invoke" \| summarize HourlyCount=count() by bin(Timestamp, 1h), SourceIP \| where HourlyCount > avg(HourlyCount) * 3 and (hour(Timestamp) < 8 or hour(Timestamp) > 18)`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action == 'Invoke' \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip \| WHERE COUNT() > AVG(COUNT()) * 3 AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18)`. |

### T1583.005: Botnet

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Botnet C2 Communication | Adversaries use botnets for C2 communication, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- DNS Logs (DS0001) | - **Splunk**: `index=network sourcetype=zeek_http dest_ip IN (botnet_ips) AND response_status_code IN ("200", "404") \| stats count by src_ip, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (botnetIPs) and ResponseStatusCode in ("200", "404") \| summarize count() by DeviceIP, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE destination.ip IN ['botnet_ips'] AND http.response.status_code IN ['200', '404'] \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 10`. |
| 2. Botnet DNS Queries | High-frequency DNS queries to botnet C2 domains, as in APT41. | - DNS Logs (DS0001)<br>- Metrics | - **Splunk**: `index=dns sourcetype=zeek_dns query IN (botnet_domains) \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and DnsQueryName in (botnetDomains) \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE dns.query IN ['botnet_domains'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 3. Botnet Activity from Compromised Endpoints | Compromised endpoints participate in botnet activity, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*curl*", "*wget*") \| join host [search index=network sourcetype=zeek_http dest_ip IN (botnet_ips)] \| stats count by host, CommandLine, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("curl", "wget") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (botnetIPs)) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*curl*" OR "*wget*") \| JOIN logs-zeek.http-* ON host.name WHERE destination.ip IN ['botnet_ips'] \| STATS COUNT() BY host.name, process.command_line, destination.ip HAVING COUNT() > 5`. |
| 4. Botnet Activity via Browser Automation | Adversaries use browser automation for botnet C2, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*selenium*", "*puppeteer*") \| join host [search index=network sourcetype=zeek_http dest_ip IN (botnet_ips)] \| stats count by host, CommandLine, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("selenium", "puppeteer") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (botnetIPs)) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*selenium*" OR "*puppeteer*") \| JOIN logs-zeek.http-* ON host.name WHERE destination.ip IN ['botnet_ips'] \| STATS COUNT() BY host.name, process.command_line, destination.ip HAVING COUNT() > 5`. |
| 5. Botnet Activity in Linux Environments | Adversaries use Linux tools for botnet activity, as in Turla. | - Process Creation (Linux Auditd)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*curl*", "*wget*") AND args IN (botnet_ips) \| stats count by host, exe \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("curl", "wget") and CommandLine has_any (botnetIPs) \| summarize count() by HostName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*curl*" OR "*wget*") AND process.args IN ['botnet_ips'] \| STATS COUNT() BY host.name, process.exe HAVING COUNT() > 5`. |
| 6. Botnet Activity with Suspicious User Agents | Adversaries use non-standard user agents for botnet activity, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND dest_ip IN (botnet_ips) \| stats count by src_ip, user_agent, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and RemoteIP in (botnetIPs) \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND destination.ip IN ['botnet_ips'] \| STATS COUNT() BY source.ip, http.user_agent, destination.ip HAVING COUNT() > 10`. |
| 7. High-Frequency Botnet Connections | High-frequency connections to botnet IPs, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http dest_ip IN (botnet_ips) \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (botnetIPs) \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE destination.ip IN ['botnet_ips'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 8. Botnet Connections via Known Malicious IPs | Connections to botnet IPs from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http src_ip IN (threat_intel_ips) AND dest_ip IN (botnet_ips) \| stats count by src_ip, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceIP in (threatIntelIPs) and RemoteIP in (botnetIPs) \| summarize count() by DeviceIP, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE source.ip IN ['threat_intel_ips'] AND destination.ip IN ['botnet_ips'] \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 10`. |
| 9. Botnet DNS Queries to Suspicious Domains | Botnet-related DNS queries to suspicious domains, as in 2025 trends. | - DNS Logs (DS0001)<br>- Threat Intelligence | - **Splunk**: `index=dns sourcetype=zeek_dns query IN (botnet_domains) AND src_ip IN (threat_intel_ips) \| stats count by src_ip, query \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and DnsQueryName in (botnetDomains) and DeviceIP in (threatIntelIPs) \| summarize count() by DeviceIP, DnsQueryName \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE dns.query IN ['botnet_domains'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY source.ip, dns.query HAVING COUNT() > 10`. |
| 10. Botnet Activity with Anomalous Ports | Botnet activity using non-standard ports, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn)<br>- Firewall Logs | - **Splunk**: `index=network sourcetype=zeek_conn dest_port NOT IN (80, 443) AND dest_ip IN (botnet_ips) \| stats count by src_ip, dest_ip, dest_port \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where RemotePort !in (80, 443) and RemoteIP in (botnetIPs) \| summarize count() by DeviceIP, RemoteIP, RemotePort \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE destination.port NOT IN [80, 443] AND destination.ip IN ['botnet_ips'] \| STATS COUNT() BY source.ip, destination.ip, destination.port HAVING COUNT() > 10`. |

### T1583.006: DNS Server

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. DNS Server Queries for C2 | Adversaries use compromised DNS servers for C2, as in Volt Typhoon. | - DNS Logs (DS0001)<br>- Network Traffic (DS0003: Zeek DNS) | - **Splunk**: `index=dns sourcetype=zeek_dns dest_ip IN (dns_servers) AND query IN (suspicious_domains) \| stats count by src_ip, dest_ip, query \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and RemoteIP in (dnsServers) and DnsQueryName in (suspiciousDomains) \| summarize count() by DeviceIP, RemoteIP, DnsQueryName \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE destination.ip IN ['dns_servers'] AND dns.query IN ['suspicious_domains'] \| STATS COUNT() BY source.ip, destination.ip, dns.query HAVING COUNT() > 10`. |
| 2. Anomalous DNS Server Queries | High-frequency queries to compromised DNS servers, as in APT41. | - DNS Logs (DS0001)<br>- Metrics | - **Splunk**: `index=dns sourcetype=zeek_dns dest_ip IN (dns_servers) \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and RemoteIP in (dnsServers) \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE destination.ip IN ['dns_servers'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 3. DNS Server Queries from Compromised Endpoints | Compromised endpoints query malicious DNS servers, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- DNS Logs (DS0001) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*nslookup*", "*dig*") \| join host [search index=dns sourcetype=zeek_dns dest_ip IN (dns_servers)] \| stats count by host, CommandLine, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("nslookup", "dig") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "DNS" and RemoteIP in (dnsServers)) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*nslookup*" OR "*dig*") \| JOIN logs-zeek.dns-* ON host.name WHERE destination.ip IN ['dns_servers'] \| STATS COUNT() BY host.name, process.command_line, destination.ip HAVING COUNT() > 5`. |
| 4. DNS Server Queries via Browser Automation | Adversaries use browser automation to query DNS servers, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- DNS Logs (DS0001) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*selenium*", "*puppeteer*") \| join host [search index=dns sourcetype=zeek_dns dest_ip IN (dns_servers)] \| stats count by host, CommandLine, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("selenium", "puppeteer") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "DNS" and RemoteIP in (dnsServers)) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*selenium*" OR "*puppeteer*") \| JOIN logs-zeek.dns-* ON host.name WHERE destination.ip IN ['dns_servers'] \| STATS COUNT() BY host.name, process.command_line, destination.ip HAVING COUNT() > 5`. |
| 5. DNS Server Queries in Linux Environments | Adversaries use Linux tools to query malicious DNS servers, as in Turla. | - Process Creation (Linux Auditd)<br>- DNS Logs (DS0001) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*dig*", "*nslookup*") AND args IN (dns_servers) \| stats count by host, exe \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("dig", "nslookup") and CommandLine has_any (dnsServers) \| summarize count() by HostName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*dig*" OR "*nslookup*") AND process.args IN ['dns_servers'] \| STATS COUNT() BY host.name, process.exe HAVING COUNT() > 5`. |
| 6. DNS Server Queries with Suspicious User Agents | Adversaries use non-standard user agents to query DNS servers, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- DNS Logs (DS0001) | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND uri IN (dns_servers) \| join src_ip [search index=dns sourcetype=zeek_dns dest_ip IN (dns_servers)] \| stats count by src_ip, user_agent, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and RemoteUrl in (dnsServers) \| join kind=inner (DeviceNetworkEvents \| where Protocol == "DNS" and RemoteIP in (dnsServers)) on DeviceIP \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND http.uri IN ['dns_servers'] \| JOIN logs-zeek.dns-* ON source.ip WHERE destination.ip IN ['dns_servers'] \| STATS COUNT() BY source.ip, http.user_agent, destination.ip HAVING COUNT() > 10`. |
| 7. High-Frequency DNS Server Queries | High-frequency queries to compromised DNS servers, as in APT41. | - DNS Logs (DS0001)<br>- Metrics | - **Splunk**: `index=dns sourcetype=zeek_dns dest_ip IN (dns_servers) \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and RemoteIP in (dnsServers) \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE destination.ip IN ['dns_servers'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 8. DNS Server Queries via Known Malicious IPs | Queries to DNS servers from known malicious IPs, as in Volt Typhoon. | - DNS Logs (DS0001)<br>- Threat Intelligence | - **Splunk**: `index=dns sourcetype=zeek_dns src_ip IN (threat_intel_ips) AND dest_ip IN (dns_servers) \| stats count by src_ip, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceIP in (threatIntelIPs) and RemoteIP in (dnsServers) \| summarize count() by DeviceIP, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE source.ip IN ['threat_intel_ips'] AND destination.ip IN ['dns_servers'] \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 10`. |
| 9. DNS Server Queries with Suspicious Domains | DNS server queries for suspicious domains, as in 2025 trends. | - DNS Logs (DS0001)<br>- Threat Intelligence | - **Splunk**: `index=dns sourcetype=zeek_dns query IN (suspicious_domains) AND dest_ip IN (dns_servers) \| stats count by src_ip, query, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and DnsQueryName in (suspiciousDomains) and RemoteIP in (dnsServers) \| summarize count() by DeviceIP, DnsQueryName, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE dns.query IN ['suspicious_domains'] AND destination.ip IN ['dns_servers'] \| STATS COUNT() BY source.ip, dns.query, destination.ip HAVING COUNT() > 10`. |
| 10. DNS Server Queries with Anomalous Ports | DNS queries using non-standard ports, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn)<br>- DNS Logs (DS0001) | - **Splunk**: `index=network sourcetype=zeek_conn dest_port NOT IN (53) AND dest_ip IN (dns_servers) \| stats count by src_ip, dest_ip, dest_port \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where RemotePort !in (53) and RemoteIP in (dnsServers) \| summarize count() by DeviceIP, RemoteIP, RemotePort \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE destination.port NOT IN [53] AND destination.ip IN ['dns_servers'] \| STATS COUNT() BY source.ip, destination.ip, destination.port HAVING COUNT() > 10`. |

### T1583.007: Email Account

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Compromised Email Accounts for Phishing | Adversaries use compromised email accounts for phishing, as in Volt Typhoon. | - Email Logs (DS0004)<br>- Authentication Logs (DS0029) | - **Splunk**: `index=email sourcetype=zeek_smtp src_ip NOT IN (trusted_ips) AND user NOT IN (known_users) \| stats count by src_ip, user \| where count > 10`.<br>- **KQL**: `EmailEvents \| where SenderIP !in (trustedIPs) and UserId !in (knownUsers) \| summarize count() by SenderIP, UserId \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.smtp-* \| WHERE source.ip NOT IN ['trusted_ips'] AND user.name NOT IN ['known_users'] \| STATS COUNT() BY source.ip, user.name HAVING COUNT() > 10`. |
| 2. Email Account Access via Webmail | Adversaries access email accounts via webmail for phishing, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http uri IN ("*mail.google.com*", "*outlook.office365.com*") AND user_agent NOT IN (known_agents) \| stats count by src_ip, uri, user_agent \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any ("mail.google.com", "outlook.office365.com") and AdditionalFields.UserAgent !in (knownAgents) \| summarize count() by DeviceIP, RemoteUrl, AdditionalFields.UserAgent \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri : ("*mail.google.com*" OR "*outlook.office365.com*") AND http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY source.ip, http.uri, http.user_agent HAVING COUNT() > 10`. |
| 3. Email Account Access via Cloud APIs | Adversaries access email accounts via cloud APIs, as in 2025 trends. | - Cloud Audit Logs (AWS CloudTrail, Azure AD)<br>- Authentication Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("ListMessages", "GetEmail") AND userIdentity NOT IN (authorized_users) \| stats count by src_ip, eventName \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("ListMessages", "GetEmail") and Caller !in (authorizedUsers) \| summarize count() by SourceIP, EventName \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['ListMessages', 'GetEmail'] AND user.identity NOT IN ['authorized_users'] \| STATS COUNT() BY source.ip, event.action HAVING COUNT() > 10`. |
| 4. Email Account Access with Anomalous Timing | Email account access outside business hours, as in APT29. | - Email Logs (DS0004)<br>- Metrics | - **Splunk**: `index=email sourcetype=zeek_smtp user NOT IN (known_users) \| timechart span=1h count by src_ip \| where count > avg(count)*3 AND (_time < "08:00" OR _time > "18:00")`.<br>- **KQL**: `EmailEvents \| where UserId !in (knownUsers) \| summarize HourlyCount=count() by bin(Timestamp, 1h), SenderIP \| where HourlyCount > avg(HourlyCount) * 3 and (hour(Timestamp) < 8 or hour(Timestamp) > 18)`.<br>- **ELK**: `FROM logs-zeek.smtp-* \| WHERE user.name NOT IN ['known_users'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip \| WHERE COUNT() > AVG(COUNT()) * 3 AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18)`. |
| 5. Email Account Access from Compromised Endpoints | Compromised endpoints access email accounts, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Email Logs (DS0004) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*outlook.exe*", "*thunderbird*") \| join host [search index=email sourcetype=zeek_smtp user NOT IN (known_users)] \| stats count by host, CommandLine, user \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("outlook.exe", "thunderbird") \| join kind=inner (EmailEvents \| where UserId !in (knownUsers)) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, UserId \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*outlook.exe*" OR "*thunderbird*") \| JOIN logs-zeek.smtp-* ON host.name WHERE user.name NOT IN ['known_users'] \| STATS COUNT() BY host.name, process.command_line, user.name HAVING COUNT() > 5`. |
| 6. Email Account Access via Browser Automation | Adversaries use browser automation to access email accounts, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*selenium*", "*puppeteer*") \| join host [search index=network sourcetype=zeek_http uri IN ("*mail.google.com*", "*outlook.office365.com*")] \| stats count by host, CommandLine, uri \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("selenium", "puppeteer") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any ("mail.google.com", "outlook.office365.com")) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, RemoteUrl \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*selenium*" OR "*puppeteer*") \| JOIN logs-zeek.http-* ON host.name WHERE http.uri : ("*mail.google.com*" OR "*outlook.office365.com*") \| STATS COUNT() BY host.name, process.command_line, http.uri HAVING COUNT() > 5`. |
| 7. Email Account Access in Linux Environments | Adversaries use Linux tools to access email accounts, as in Turla. | - Process Creation (Linux Auditd)<br>- Email Logs (DS0004) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*mutt*", "*thunderbird*") AND args IN ("*imap*", "*smtp*") \| stats count by host, exe \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("mutt", "thunderbird") and CommandLine has_any ("imap", "smtp") \| summarize count() by HostName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*mutt*" OR "*thunderbird*") AND process.args : ("*imap*" OR "*smtp*") \| STATS COUNT() BY host.name, process.exe HAVING COUNT() > 5`. |
| 8. Email Account Access with Suspicious User Agents | Adversaries use non-standard user agents to access email accounts, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND uri IN ("*mail.google.com*", "*outlook.office365.com*") \| stats count by src_ip, user_agent, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and RemoteUrl has_any ("mail.google.com", "outlook.office365.com") \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND http.uri : ("*mail.google.com*" OR "*outlook.office365.com*") \| STATS COUNT() BY source.ip, http.user_agent, http.uri HAVING COUNT() > 10`. |
| 9. High-Frequency Email Account Access | High-frequency email account access, as in APT41. | - Email Logs (DS0004)<br>- Metrics | - **Splunk**: `index=email sourcetype=zeek_smtp user NOT IN (known_users) \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `EmailEvents \| where UserId !in (knownUsers) \| summarize MinuteCount=count() by bin(Timestamp, 1m), SenderIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.smtp-* \| WHERE user.name NOT IN ['known_users'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 10. Email Account Access via Known Malicious IPs | Email account access from known malicious IPs, as in Volt Typhoon. | - Email Logs (DS0004)<br>- Threat Intelligence | - **Splunk**: `index=email sourcetype=zeek_smtp src_ip IN (threat_intel_ips) \| stats count by src_ip, user \| where count > 10`.<br>- **KQL**: `EmailEvents \| where SenderIP in (threatIntelIPs) \| summarize count() by SenderIP, UserId \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.smtp-* \| WHERE source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY source.ip, user.name HAVING COUNT() > 10`. |


### T1583.008: Malware

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Malware Distribution via Phishing Emails | Adversaries distribute malware via phishing emails, as in Volt Typhoon. | - Email Logs (DS0004)<br>- Email Attachments (DS0004) | - **Splunk**: `index=email sourcetype=zeek_smtp attachment IN ("*.exe", "*.zip", "*.scr") AND src_ip NOT IN (trusted_ips) \| stats count by src_ip, recipient, attachment \| where count > 5`.<br>- **KQL**: `EmailEvents \| where AttachmentName has_any (".exe", ".zip", ".scr") and SenderIP !in (trustedIPs) \| summarize count() by SenderIP, RecipientEmailAddress, AttachmentName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.smtp-* \| WHERE email.attachment : ("*.exe" OR "*.zip" OR "*.scr") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, email.recipient, email.attachment HAVING COUNT() > 5`. |
| 2. Malware C2 Communication | Adversaries use malware to establish C2 communication, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- DNS Logs (DS0001) | - **Splunk**: `index=network sourcetype=zeek_http dest_ip IN (malware_c2_ips) AND response_status_code IN ("200", "404") \| stats count by src_ip, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (malwareC2IPs) and ResponseStatusCode in ("200", "404") \| summarize count() by DeviceIP, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE destination.ip IN ['malware_c2_ips'] AND http.response.status_code IN ['200', '404'] \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 10`. |
| 3. Malware Execution on Compromised Endpoints | Compromised endpoints execute malware, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*powershell.exe*", "*cmd.exe*") AND Image NOT IN (trusted_paths) \| join host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll")] \| stats count by host, Image, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("powershell.exe", "cmd.exe") and ProcessName !in (trustedPaths) \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll")) on DeviceName \| summarize count() by DeviceName, ProcessName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*powershell.exe*" OR "*cmd.exe*") AND process.executable NOT IN ['trusted_paths'] \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll") \| STATS COUNT() BY host.name, process.executable, file.name HAVING COUNT() > 5`. |
| 4. Malware Execution via Browser Automation | Adversaries use browser automation tools to execute malware, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*selenium*", "*puppeteer*") \| join host [search index=network sourcetype=zeek_http dest_ip IN (malware_c2_ips)] \| stats count by host, CommandLine, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("selenium", "puppeteer") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (malwareC2IPs)) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*selenium*" OR "*puppeteer*") \| JOIN logs-zeek.http-* ON host.name WHERE destination.ip IN ['malware_c2_ips'] \| STATS COUNT() BY host.name, process.command_line, destination.ip HAVING COUNT() > 5`. |
| 5. Malware Execution in Linux Environments | Adversaries deploy malware using Linux tools, as in Turla. | - Process Creation (Linux Auditd)<br>- File Creation (Linux Auditd) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*bash*", "*sh*") AND args IN ("*.sh", "*.elf") \| stats count by host, exe, args \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("bash", "sh") and CommandLine has_any (".sh", ".elf") \| summarize count() by HostName, ProcessName, CommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*bash*" OR "*sh*") AND process.args : ("*.sh" OR "*.elf") \| STATS COUNT() BY host.name, process.exe, process.args HAVING COUNT() > 5`. |
| 6. Malware Communication with Suspicious User Agents | Malware uses non-standard user agents for C2 communication, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND dest_ip IN (malware_c2_ips) \| stats count by src_ip, user_agent, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and RemoteIP in (malwareC2IPs) \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND destination.ip IN ['malware_c2_ips'] \| STATS COUNT() BY source.ip, http.user_agent, destination.ip HAVING COUNT() > 10`. |
| 7. High-Frequency Malware C2 Connections | High-frequency connections to malware C2 servers, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http dest_ip IN (malware_c2_ips) \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (malwareC2IPs) \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE destination.ip IN ['malware_c2_ips'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 8. Malware Communication via Known Malicious IPs | Malware communicates with known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http src_ip IN (threat_intel_ips) AND dest_ip IN (malware_c2_ips) \| stats count by src_ip, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceIP in (threatIntelIPs) and RemoteIP in (malwareC2IPs) \| summarize count() by DeviceIP, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE source.ip IN ['threat_intel_ips'] AND destination.ip IN ['malware_c2_ips'] \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 10`. |
| 9. Malware DNS Queries to Suspicious Domains | Malware queries suspicious domains for C2, as in 2025 trends. | - DNS Logs (DS0001)<br>- Threat Intelligence | - **Splunk**: `index=dns sourcetype=zeek_dns query IN (malware_c2_domains) AND src_ip IN (threat_intel_ips) \| stats count by src_ip, query \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and DnsQueryName in (malwareC2Domains) and DeviceIP in (threatIntelIPs) \| summarize count() by DeviceIP, DnsQueryName \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE dns.query IN ['malware_c2_domains'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY source.ip, dns.query HAVING COUNT() > 10`. |
| 10. Malware Communication with Anomalous Ports | Malware uses non-standard ports for C2 communication, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn)<br>- Firewall Logs | - **Splunk**: `index=network sourcetype=zeek_conn dest_port NOT IN (80, 443) AND dest_ip IN (malware_c2_ips) \| stats count by src_ip, dest_ip, dest_port \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where RemotePort !in (80, 443) and RemoteIP in (malwareC2IPs) \| summarize count() by DeviceIP, RemoteIP, RemotePort \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE destination.port NOT IN [80, 443] AND destination.ip IN ['malware_c2_ips'] \| STATS COUNT() BY source.ip, destination.ip, destination.port HAVING COUNT() > 10`. |

### T1586: Compromise Accounts

### T1586.001: Social Media Accounts

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Unauthorized Social Media Account Access | Adversaries access employee social media accounts for reconnaissance, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Authentication Logs (DS0029) | - **Splunk**: `index=network sourcetype=zeek_http uri IN ("*linkedin.com*", "*x.com*") AND user NOT IN (known_users) \| stats count by src_ip, user, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any ("linkedin.com", "x.com") and UserId !in (knownUsers) \| summarize count() by DeviceIP, UserId, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri : ("*linkedin.com*" OR "*x.com*") AND user.name NOT IN ['known_users'] \| STATS COUNT() BY source.ip, user.name, http.uri HAVING COUNT() > 10`. |
| 2. Social Media Account Scraping | Adversaries scrape social media profiles using automated tools, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http user_agent IN ("*Scrapy*", "*BeautifulSoup*") AND uri IN ("*linkedin.com/in/*", "*x.com/*") \| stats count by src_ip, user_agent, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent has_any ("Scrapy", "BeautifulSoup") and RemoteUrl has_any ("linkedin.com/in/", "x.com/") \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent : ("*Scrapy*" OR "*BeautifulSoup*") AND http.uri : ("*linkedin.com/in/*" OR "*x.com/*") \| STATS COUNT() BY source.ip, http.user_agent, http.uri HAVING COUNT() > 10`. |
| 3. Social Media Access via Cloud APIs | Adversaries access social media accounts via cloud APIs, as in 2025 trends. | - Cloud Audit Logs (AWS CloudTrail, Azure AD)<br>- Authentication Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("ListUsers", "GetUser") AND requestParameters IN ("*social*") AND userIdentity NOT IN (authorized_users) \| stats count by src_ip, eventName \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("ListUsers", "GetUser") and RequestParameters has_any ("social") and Caller !in (authorizedUsers) \| summarize count() by SourceIP, EventName \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['ListUsers', 'GetUser'] AND event.request_parameters : ("*social*") AND user.identity NOT IN ['authorized_users'] \| STATS COUNT() BY source.ip, event.action HAVING COUNT() > 10`. |
| 4. Social Media Access Outside Business Hours | Social media account access outside business hours, indicating compromise, as in APT29. | - Network Traffic (DS0003: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http uri IN ("*linkedin.com*", "*x.com*") \| timechart span=1h count by src_ip \| where count > avg(count)*3 AND (_time < "08:00" OR _time > "18:00")`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any ("linkedin.com", "x.com") \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceIP \| where HourlyCount > avg(HourlyCount) * 3 and (hour(Timestamp) < 8 or hour(Timestamp) > 18)`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri : ("*linkedin.com*" OR "*x.com*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip \| WHERE COUNT() > AVG(COUNT()) * 3 AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18)`. |
| 5. Social Media Access from Compromised Endpoints | Compromised endpoints access social media accounts, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*chrome.exe*", "*firefox.exe*") \| join host [search index=network sourcetype=zeek_http uri IN ("*linkedin.com*", "*x.com*")] \| stats count by host, CommandLine, uri \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("chrome.exe", "firefox.exe") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any ("linkedin.com", "x.com")) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, RemoteUrl \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*chrome.exe*" OR "*firefox.exe*") \| JOIN logs-zeek.http-* ON host.name WHERE http.uri : ("*linkedin.com*" OR "*x.com*") \| STATS COUNT() BY host.name, process.command_line, http.uri HAVING COUNT() > 5`. |
| 6. Social Media Access via Browser Automation | Adversaries use browser automation tools to access social media accounts, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*selenium*", "*puppeteer*") \| join host [search index=network sourcetype=zeek_http uri IN ("*linkedin.com*", "*x.com*")] \| stats count by host, CommandLine, uri \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("selenium", "puppeteer") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any ("linkedin.com", "x.com")) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, RemoteUrl \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*selenium*" OR "*puppeteer*") \| JOIN logs-zeek.http-* ON host.name WHERE http.uri : ("*linkedin.com*" OR "*x.com*") \| STATS COUNT() BY host.name, process.command_line, http.uri HAVING COUNT() > 5`. |
| 7. Social Media Access in Linux Environments | Adversaries use Linux tools to access social media accounts, as in Turla. | - Process Creation (Linux Auditd)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*curl*", "*wget*") AND args IN ("*linkedin.com*", "*x.com*") \| stats count by host, exe \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("curl", "wget") and CommandLine has_any ("linkedin.com", "x.com") \| summarize count() by HostName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*curl*" OR "*wget*") AND process.args : ("*linkedin.com*" OR "*x.com*") \| STATS COUNT() BY host.name, process.exe HAVING COUNT() > 5`. |
| 8. Social Media Access with Suspicious User Agents | Adversaries use non-standard user agents to access social media accounts, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND uri IN ("*linkedin.com*", "*x.com*") \| stats count by src_ip, user_agent, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and RemoteUrl has_any ("linkedin.com", "x.com") \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND http.uri : ("*linkedin.com*" OR "*x.com*") \| STATS COUNT() BY source.ip, http.user_agent, http.uri HAVING COUNT() > 10`. |
| 9. High-Frequency Social Media Access | High-frequency access to social media accounts, indicating automated compromise, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http uri IN ("*linkedin.com*", "*x.com*") \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any ("linkedin.com", "x.com") \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri : ("*linkedin.com*" OR "*x.com*") \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 10. Social Media Access via Known Malicious IPs | Social media account access from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http src_ip IN (threat_intel_ips) AND uri IN ("*linkedin.com*", "*x.com*") \| stats count by src_ip, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceIP in (threatIntelIPs) and RemoteUrl has_any ("linkedin.com", "x.com") \| summarize count() by DeviceIP, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE source.ip IN ['threat_intel_ips'] AND http.uri : ("*linkedin.com*" OR "*x.com*") \| STATS COUNT() BY source.ip, http.uri HAVING COUNT() > 10`. |

### T1586.002: Email Accounts

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Unauthorized Email Account Access | Adversaries access email accounts for phishing or data theft, as in Volt Typhoon. | - Email Logs (DS0004)<br>- Authentication Logs (DS0029) | - **Splunk**: `index=email sourcetype=zeek_smtp src_ip NOT IN (trusted_ips) AND user NOT IN (known_users) \| stats count by src_ip, user \| where count > 10`.<br>- **KQL**: `EmailEvents \| where SenderIP !in (trustedIPs) and UserId !in (knownUsers) \| summarize count() by SenderIP, UserId \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.smtp-* \| WHERE source.ip NOT IN ['trusted_ips'] AND user.name NOT IN ['known_users'] \| STATS COUNT() BY source.ip, user.name HAVING COUNT() > 10`. |
| 2. Email Account Access via Webmail | Adversaries access email accounts via webmail interfaces, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http uri IN ("*mail.google.com*", "*outlook.office365.com*") AND user_agent NOT IN (known_agents) \| stats count by src_ip, uri, user_agent \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any ("mail.google.com", "outlook.office365.com") and AdditionalFields.UserAgent !in (knownAgents) \| summarize count() by DeviceIP, RemoteUrl, AdditionalFields.UserAgent \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri : ("*mail.google.com*" OR "*outlook.office365.com*") AND http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY source.ip, http.uri, http.user_agent HAVING COUNT() > 10`. |
| 3. Email Account Access via Cloud APIs | Adversaries access email accounts via cloud APIs, as in 2025 trends. | - Cloud Audit Logs (AWS CloudTrail, Azure AD)<br>- Authentication Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("ListMessages", "GetEmail") AND userIdentity NOT IN (authorized_users) \| stats count by src_ip, eventName \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("ListMessages", "GetEmail") and Caller !in (authorizedUsers) \| summarize count() by SourceIP, EventName \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['ListMessages', 'GetEmail'] AND user.identity NOT IN ['authorized_users'] \| STATS COUNT() BY source.ip, event.action HAVING COUNT() > 10`. |
| 4. Email Account Access Outside Business Hours | Email account access outside business hours, indicating compromise, as in APT29. | - Email Logs (DS0004)<br>- Metrics | - **Splunk**: `index=email sourcetype=zeek_smtp user NOT IN (known_users) \| timechart span=1h count by src_ip \| where count > avg(count)*3 AND (_time < "08:00" OR _time > "18:00")`.<br>- **KQL**: `EmailEvents \| where UserId !in (knownUsers) \| summarize HourlyCount=count() by bin(Timestamp, 1h), SenderIP \| where HourlyCount > avg(HourlyCount) * 3 and (hour(Timestamp) < 8 or hour(Timestamp) > 18)`.<br>- **ELK**: `FROM logs-zeek.smtp-* \| WHERE user.name NOT IN ['known_users'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip \| WHERE COUNT() > AVG(COUNT()) * 3 AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18)`. |
| 5. Email Account Access from Compromised Endpoints | Compromised endpoints access email accounts, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Email Logs (DS0004) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*outlook.exe*", "*thunderbird*") \| join host [search index=email sourcetype=zeek_smtp user NOT IN (known_users)] \| stats count by host, CommandLine, user \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("outlook.exe", "thunderbird") \| join kind=inner (EmailEvents \| where UserId !in (knownUsers)) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, UserId \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*outlook.exe*" OR "*thunderbird*") \| JOIN logs-zeek.smtp-* ON host.name WHERE user.name NOT IN ['known_users'] \| STATS COUNT() BY host.name, process.command_line, user.name HAVING COUNT() > 5`. |
| 6. Email Account Access via Browser Automation | Adversaries use browser automation to access email accounts, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*selenium*", "*puppeteer*") \| join host [search index=network sourcetype=zeek_http uri IN ("*mail.google.com*", "*outlook.office365.com*")] \| stats count by host, CommandLine, uri \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("selenium", "puppeteer") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any ("mail.google.com", "outlook.office365.com")) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, RemoteUrl \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*selenium*" OR "*puppeteer*") \| JOIN logs-zeek.http-* ON host.name WHERE http.uri : ("*mail.google.com*" OR "*outlook.office365.com*") \| STATS COUNT() BY host.name, process.command_line, http.uri HAVING COUNT() > 5`. |
| 7. Email Account Access in Linux Environments | Adversaries use Linux tools to access email accounts, as in Turla. | - Process Creation (Linux Auditd)<br>- Email Logs (DS0004) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*mutt*", "*thunderbird*") AND args IN ("*imap*", "*smtp*") \| stats count by host, exe \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("mutt", "thunderbird") and CommandLine has_any ("imap", "smtp") \| summarize count() by HostName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*mutt*" OR "*thunderbird*") AND process.args : ("*imap*" OR "*smtp*") \| STATS COUNT() BY host.name, process.exe HAVING COUNT() > 5`. |
| 8. Email Account Access with Suspicious User Agents | Adversaries use non-standard user agents to access email accounts, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND uri IN ("*mail.google.com*", "*outlook.office365.com*") \| stats count by src_ip, user_agent, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and RemoteUrl has_any ("mail.google.com", "outlook.office365.com") \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND http.uri : ("*mail.google.com*" OR "*outlook.office365.com*") \| STATS COUNT() BY source.ip, http.user_agent, http.uri HAVING COUNT() > 10`. |
| 9. High-Frequency Email Account Access | High-frequency email account access, indicating automated compromise, as in APT41. | - Email Logs (DS0004)<br>- Metrics | - **Splunk**: `index=email sourcetype=zeek_smtp user NOT IN (known_users) \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `EmailEvents \| where UserId !in (knownUsers) \| summarize MinuteCount=count() by bin(Timestamp, 1m), SenderIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.smtp-* \| WHERE user.name NOT IN ['known_users'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 10. Email Account Access via Known Malicious IPs | Email account access from known malicious IPs, as in Volt Typhoon. | - Email Logs (DS0004)<br>- Threat Intelligence | - **Splunk**: `index=email sourcetype=zeek_smtp src_ip IN (threat_intel_ips) \| stats count by src_ip, user \| where count > 10`.<br>- **KQL**: `EmailEvents \| where SenderIP in (threatIntelIPs) \| summarize count() by SenderIP, UserId \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.smtp-* \| WHERE source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY source.ip, user.name HAVING COUNT() > 10`. |

### T1586.003: Cloud Accounts

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Unauthorized Cloud Account Access | Adversaries access cloud accounts for data theft or privilege escalation, as in Volt Typhoon. | - Cloud Audit Logs (AWS CloudTrail, Azure AD)<br>- Authentication Logs (DS0029) | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("ConsoleLogin", "AssumeRole") AND userIdentity NOT IN (authorized_users) \| stats count by src_ip, userIdentity \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("ConsoleLogin", "AssumeRole") and Caller !in (authorizedUsers) \| summarize count() by SourceIP, Caller \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['ConsoleLogin', 'AssumeRole'] AND user.identity NOT IN ['authorized_users'] \| STATS COUNT() BY source.ip, user.identity HAVING COUNT() > 10`. |
| 2. Cloud Account Access via Compromised Credentials | Adversaries use stolen credentials to access cloud accounts, as in APT41. | - Cloud Audit Logs (AWS CloudTrail, Azure AD)<br>- Authentication Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("ConsoleLogin", "AssumeRole") AND src_ip NOT IN (trusted_ips) \| stats count by src_ip, userIdentity \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("ConsoleLogin", "AssumeRole") and SourceIP !in (trustedIPs) \| summarize count() by SourceIP, Caller \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['ConsoleLogin', 'AssumeRole'] AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, user.identity HAVING COUNT() > 10`. |
| 3. Cloud Account Access Outside Business Hours | Cloud account access outside business hours, indicating compromise, as in APT29. | - Cloud Audit Logs (AWS CloudTrail)<br>- Metrics | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("ConsoleLogin", "AssumeRole") \| timechart span=1h count by src_ip \| where count > avg(count)*3 AND (_time < "08:00" OR _time > "18:00")`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("ConsoleLogin", "AssumeRole") \| summarize HourlyCount=count() by bin(Timestamp, 1h), SourceIP \| where HourlyCount > avg(HourlyCount) * 3 and (hour(Timestamp) < 8 or hour(Timestamp) > 18)`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['ConsoleLogin', 'AssumeRole'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip \| WHERE COUNT() > AVG(COUNT()) * 3 AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18)`. |
| 4. Cloud Account Access from Compromised Endpoints | Compromised endpoints access cloud accounts, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Cloud Audit Logs (AWS CloudTrail) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*aws cli*", "*boto3*") \| join host [search index=cloud sourcetype=aws:cloudtrail eventName IN ("ConsoleLogin", "AssumeRole")] \| stats count by host, CommandLine, eventName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("aws cli", "boto3") \| join kind=inner (AWSCloudTrail \| where EventName in ("ConsoleLogin", "AssumeRole")) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, EventName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*aws cli*" OR "*boto3*") \| JOIN logs-aws.cloudtrail-* ON host.name WHERE event.action IN ['ConsoleLogin', 'AssumeRole'] \| STATS COUNT() BY host.name, process.command_line, event.action HAVING COUNT() > 5`. |
| 5. Cloud Account Access via Browser Automation | Adversaries use browser automation to access cloud accounts, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*selenium*", "*puppeteer*") \| join host [search index=network sourcetype=zeek_http uri IN ("*console.aws.amazon.com*", "*portal.azure.com*")] \| stats count by host, CommandLine, uri \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("selenium", "puppeteer") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any ("console.aws.amazon.com", "portal.azure.com")) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, RemoteUrl \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*selenium*" OR "*puppeteer*") \| JOIN logs-zeek.http-* ON host.name WHERE http.uri : ("*console.aws.amazon.com*" OR "*portal.azure.com*") \| STATS COUNT() BY host.name, process.command_line, http.uri HAVING COUNT() > 5`. |
| 6. Cloud Account Access in Linux Environments | Adversaries use Linux tools to access cloud accounts, as in Turla. | - Process Creation (Linux Auditd)<br>- Cloud Audit Logs (AWS CloudTrail) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*aws*", "*az*") AND args IN ("*login*", "*auth*") \| stats count by host, exe \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("aws", "az") and CommandLine has_any ("login", "auth") \| summarize count() by HostName, ProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*aws*" OR "*az*") AND process.args : ("*login*" OR "*auth*") \| STATS COUNT() BY host.name, process.exe HAVING COUNT() > 5`. |
| 7. Cloud Account Access with Suspicious User Agents | Adversaries use non-standard user agents to access cloud accounts, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND uri IN ("*console.aws.amazon.com*", "*portal.azure.com*") \| stats count by src_ip, user_agent, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and RemoteUrl has_any ("console.aws.amazon.com", "portal.azure.com") \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND http.uri : ("*console.aws.amazon.com*" OR "*portal.azure.com*") \| STATS COUNT() BY source.ip, http.user_agent, http.uri HAVING COUNT() > 10`. |
| 8. High-Frequency Cloud Account Access | High-frequency cloud account access, indicating automated compromise, as in APT41. | - Cloud Audit Logs (AWS CloudTrail)<br>- Metrics | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("ConsoleLogin", "AssumeRole") \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("ConsoleLogin", "AssumeRole") \| summarize MinuteCount=count() by bin(Timestamp, 1m), SourceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['ConsoleLogin', 'AssumeRole'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 9. Cloud Account Access via Known Malicious IPs | Cloud account access from known malicious IPs, as in Volt Typhoon. | - Cloud Audit Logs (AWS CloudTrail)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("ConsoleLogin", "AssumeRole") AND src_ip IN (threat_intel_ips) \| stats count by src_ip, eventName \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("ConsoleLogin", "AssumeRole") and SourceIP in (threatIntelIPs) \| summarize count() by SourceIP, EventName \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['ConsoleLogin', 'AssumeRole'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY source.ip, event.action HAVING COUNT() > 10`. |
| 10. Suspicious Cloud Account Role Assumptions | Adversaries assume unauthorized roles in cloud accounts, as in 2025 trends. | - Cloud Audit Logs (AWS CloudTrail)<br>- Authentication Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="AssumeRole" AND userIdentity NOT IN (authorized_users) \| stats count by src_ip, userIdentity, requestParameters.roleArn \| where count > 5`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "AssumeRole" and Caller !in (authorizedUsers) \| summarize count() by SourceIP, Caller, RequestParameters.RoleArn \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action == 'AssumeRole' AND user.identity NOT IN ['authorized_users'] \| STATS COUNT() BY source.ip, user.identity, event.request_parameters.roleArn HAVING COUNT() > 5`. |

### T1587: Develop Capabilities

## T1587.001: Malware

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Malware Deployment via Phishing Emails | Adversaries deploy custom malware via phishing emails, as in Volt Typhoon. | - Email Logs (DS0004)<br>- Email Attachments (DS0004) | - **Splunk**: `index=email sourcetype=zeek_smtp attachment IN ("*.exe", "*.zip", "*.scr") AND src_ip NOT IN (trusted_ips) \| stats count by src_ip, recipient, attachment \| where count > 5`.<br>- **KQL**: `EmailEvents \| where AttachmentName has_any (".exe", ".zip", ".scr") and SenderIP !in (trustedIPs) \| summarize count() by SenderIP, RecipientEmailAddress, AttachmentName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.smtp-* \| WHERE email.attachment : ("*.exe" OR "*.zip" OR "*.scr") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, email.recipient, email.attachment HAVING COUNT() > 5`. |
| 2. Malware C2 Communication | Adversaries use custom malware for C2 communication, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- DNS Logs (DS0001) | - **Splunk**: `index=network sourcetype=zeek_http dest_ip IN (malware_c2_ips) AND response_status_code IN ("200", "404") \| stats count by src_ip, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (malwareC2IPs) and ResponseStatusCode in ("200", "404") \| summarize count() by DeviceIP, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE destination.ip IN ['malware_c2_ips'] AND http.response.status_code IN ['200', '404'] \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 10`. |
| 3. Malware Execution on Compromised Endpoints | Custom malware executed on compromised endpoints, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*powershell.exe*", "*cmd.exe*") AND Image NOT IN (trusted_paths) \| join host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll")] \| stats count by host, Image, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("powershell.exe", "cmd.exe") and ProcessName !in (trustedPaths) \| join kind=inner (DeviceFileEvents \| where FileName has_any (".exe", ".dll")) on DeviceName \| summarize count() by DeviceName, ProcessName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*powershell.exe*" OR "*cmd.exe*") AND process.executable NOT IN ['trusted_paths'] \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.exe" OR "*.dll") \| STATS COUNT() BY host.name, process.executable, file.name HAVING COUNT() > 5`. |
| 4. Malware Execution via Browser Automation | Adversaries use browser automation to execute custom malware, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*selenium*", "*puppeteer*") \| join host [search index=network sourcetype=zeek_http dest_ip IN (malware_c2_ips)] \| stats count by host, CommandLine, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("selenium", "puppeteer") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (malwareC2IPs)) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*selenium*" OR "*puppeteer*") \| JOIN logs-zeek.http-* ON host.name WHERE destination.ip IN ['malware_c2_ips'] \| STATS COUNT() BY host.name, process.command_line, destination.ip HAVING COUNT() > 5`. |
| 5. Malware Execution in Linux Environments | Adversaries deploy custom malware using Linux tools, as in Turla. | - Process Creation (Linux Auditd)<br>- File Creation (Linux Auditd) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*bash*", "*sh*") AND args IN ("*.sh", "*.elf") \| stats count by host, exe, args \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("bash", "sh") and CommandLine has_any (".sh", ".elf") \| summarize count() by HostName, ProcessName, CommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*bash*" OR "*sh*") AND process.args : ("*.sh" OR "*.elf") \| STATS COUNT() BY host.name, process.exe, process.args HAVING COUNT() > 5`. |
| 6. Malware Communication with Suspicious User Agents | Custom malware uses non-standard user agents for C2 communication, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND dest_ip IN (malware_c2_ips) \| stats count by src_ip, user_agent, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and RemoteIP in (malwareC2IPs) \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND destination.ip IN ['malware_c2_ips'] \| STATS COUNT() BY source.ip, http.user_agent, destination.ip HAVING COUNT() > 10`. |
| 7. High-Frequency Malware C2 Connections | High-frequency connections to malware C2 servers, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http dest_ip IN (malware_c2_ips) \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (malwareC2IPs) \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE destination.ip IN ['malware_c2_ips'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 8. Malware Communication via Known Malicious IPs | Custom malware communicates with known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http src_ip IN (threat_intel_ips) AND dest_ip IN (malware_c2_ips) \| stats count by src_ip, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceIP in (threatIntelIPs) and RemoteIP in (malwareC2IPs) \| summarize count() by DeviceIP, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE source.ip IN ['threat_intel_ips'] AND destination.ip IN ['malware_c2_ips'] \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 10`. |
| 9. Malware DNS Queries to Suspicious Domains | Custom malware queries suspicious domains for C2, as in 2025 trends. | - DNS Logs (DS0001)<br>- Threat Intelligence | - **Splunk**: `index=dns sourcetype=zeek_dns query IN (malware_c2_domains) AND src_ip IN (threat_intel_ips) \| stats count by src_ip, query \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and DnsQueryName in (malwareC2Domains) and DeviceIP in (threatIntelIPs) \| summarize count() by DeviceIP, DnsQueryName \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE dns.query IN ['malware_c2_domains'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY source.ip, dns.query HAVING COUNT() > 10`. |
| 10. Malware Communication with Anomalous Ports | Custom malware uses non-standard ports for C2 communication, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn)<br>- Firewall Logs | - **Splunk**: `index=network sourcetype=zeek_conn dest_port NOT IN (80, 443) AND dest_ip IN (malware_c2_ips) \| stats count by src_ip, dest_ip, dest_port \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where RemotePort !in (80, 443) and RemoteIP in (malwareC2IPs) \| summarize count() by DeviceIP, RemoteIP, RemotePort \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE destination.port NOT IN [80, 443] AND destination.ip IN ['malware_c2_ips'] \| STATS COUNT() BY source.ip, destination.ip, destination.port HAVING COUNT() > 10`. |

## T1587.002: Code Signing Certificates

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Malicious Code Signed with Stolen Certificates | Adversaries use stolen code signing certificates to sign malware, as in Volt Typhoon. | - File Creation (DS0013: Sysmon ID 11)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll") AND CertificateIssuer NOT IN (trusted_issuers) \| join host [search index=endpoint sourcetype=sysmon EventCode=1] \| stats count by host, FileName, CertificateIssuer \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".exe", ".dll") and CertificateIssuer !in (trustedIssuers) \| join kind=inner (DeviceProcessEvents) on DeviceName \| summarize count() by DeviceName, FileName, CertificateIssuer \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.exe" OR "*.dll") AND file.certificate.issuer NOT IN ['trusted_issuers'] \| JOIN logs-endpoint.process-* ON host.name \| STATS COUNT() BY host.name, file.name, file.certificate.issuer HAVING COUNT() > 5`. |
| 2. Execution of Code Signed by Unknown Issuers | Adversaries execute code signed by unknown or revoked certificates, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Metadata | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CertificateIssuer NOT IN (trusted_issuers) AND Image IN ("*.exe", "*.dll") \| stats count by host, Image, CertificateIssuer \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where CertificateIssuer !in (trustedIssuers) and ProcessName has_any (".exe", ".dll") \| summarize count() by DeviceName, ProcessName, CertificateIssuer \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.certificate.issuer NOT IN ['trusted_issuers'] AND process.executable : ("*.exe" OR "*.dll") \| STATS COUNT() BY host.name, process.executable, process.certificate.issuer HAVING COUNT() > 5`. |
| 3. Code Signing Certificate Misuse in Cloud Environments | Adversaries misuse stolen code signing certificates in cloud environments, as in 2025 trends. | - Cloud Audit Logs (AWS CloudTrail)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("PutObject", "UploadPart") AND requestParameters IN ("*.exe", "*.dll") AND CertificateIssuer NOT IN (trusted_issuers) \| stats count by src_ip, eventName, CertificateIssuer \| where count > 5`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("PutObject", "UploadPart") and RequestParameters has_any (".exe", ".dll") and CertificateIssuer !in (trustedIssuers) \| summarize count() by SourceIP, EventName, CertificateIssuer \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['PutObject', 'UploadPart'] AND event.request_parameters : ("*.exe" OR "*.dll") AND file.certificate.issuer NOT IN ['trusted_issuers'] \| STATS COUNT() BY source.ip, event.action, file.certificate.issuer HAVING COUNT() > 5`. |
| 4. Code Signing Certificate Misuse via Compromised Endpoints | Compromised endpoints execute code signed with stolen certificates, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CertificateIssuer NOT IN (trusted_issuers) \| join host [search index=network sourcetype=zeek_http dest_ip IN (malware_c2_ips)] \| stats count by host, Image, CertificateIssuer, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where CertificateIssuer !in (trustedIssuers) \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (malwareC2IPs)) on DeviceName \| summarize count() by DeviceName, ProcessName, CertificateIssuer, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.certificate.issuer NOT IN ['trusted_issuers'] \| JOIN logs-zeek.http-* ON host.name WHERE destination.ip IN ['malware_c2_ips'] \| STATS COUNT() BY host.name, process.executable, process.certificate.issuer, destination.ip HAVING COUNT() > 5`. |
| 5. Code Signing Certificate Misuse in Linux Environments | Adversaries use stolen certificates to sign Linux malware, as in Turla. | - Process Creation (Linux Auditd)<br>- File Creation (Linux Auditd) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*.elf") AND certificate_issuer NOT IN (trusted_issuers) \| stats count by host, exe, certificate_issuer \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any (".elf") and CertificateIssuer !in (trustedIssuers) \| summarize count() by HostName, ProcessName, CertificateIssuer \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*.elf") AND process.certificate.issuer NOT IN ['trusted_issuers'] \| STATS COUNT() BY host.name, process.exe, process.certificate.issuer HAVING COUNT() > 5`. |
| 6. Code Signing Certificate Misuse with Suspicious User Agents | Adversaries use non-standard user agents to download signed malware, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND uri IN ("*.exe", "*.dll") AND CertificateIssuer NOT IN (trusted_issuers) \| stats count by src_ip, user_agent, uri, CertificateIssuer \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and RemoteUrl has_any (".exe", ".dll") and CertificateIssuer !in (trustedIssuers) \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteUrl, CertificateIssuer \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND http.uri : ("*.exe" OR "*.dll") AND http.certificate.issuer NOT IN ['trusted_issuers'] \| STATS COUNT() BY source.ip, http.user_agent, http.uri, http.certificate.issuer HAVING COUNT() > 10`. |
| 7. High-Frequency Execution of Signed Code | High-frequency execution of code signed with unknown certificates, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CertificateIssuer NOT IN (trusted_issuers) \| timechart span=1m count by host \| where count > 50`.<br>- **KQL**: `DeviceProcessEvents \| where CertificateIssuer !in (trustedIssuers) \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceName \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.certificate.issuer NOT IN ['trusted_issuers'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), host.name \| WHERE COUNT() > 50`. |
| 8. Code Signing Certificate Misuse via Known Malicious IPs | Signed code downloaded from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http src_ip IN (threat_intel_ips) AND uri IN ("*.exe", "*.dll") AND CertificateIssuer NOT IN (trusted_issuers) \| stats count by src_ip, uri, CertificateIssuer \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceIP in (threatIntelIPs) and RemoteUrl has_any (".exe", ".dll") and CertificateIssuer !in (trustedIssuers) \| summarize count() by DeviceIP, RemoteUrl, CertificateIssuer \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE source.ip IN ['threat_intel_ips'] AND http.uri : ("*.exe" OR "*.dll") AND http.certificate.issuer NOT IN ['trusted_issuers'] \| STATS COUNT() BY source.ip, http.uri, http.certificate.issuer HAVING COUNT() > 10`. |
| 9. Signed Code with Suspicious File Metadata | Signed code with unusual file metadata, indicating compromise, as in 2025 trends. | - File Creation (DS0013: Sysmon ID 11)<br>- File Metadata | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll") AND CertificateIssuer NOT IN (trusted_issuers) AND FileSize < 100KB \| stats count by host, FileName, CertificateIssuer \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".exe", ".dll") and CertificateIssuer !in (trustedIssuers) and FileSize < 100000 \| summarize count() by DeviceName, FileName, CertificateIssuer \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.exe" OR "*.dll") AND file.certificate.issuer NOT IN ['trusted_issuers'] AND file.size < 100000 \| STATS COUNT() BY host.name, file.name, file.certificate.issuer HAVING COUNT() > 5`. |
| 10. Signed Code Execution Outside Business Hours | Execution of signed code with unknown certificates outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CertificateIssuer NOT IN (trusted_issuers) \| timechart span=1h count by host \| where count > avg(count)*3 AND (_time < "08:00" OR _time > "18:00")`.<br>- **KQL**: `DeviceProcessEvents \| where CertificateIssuer !in (trustedIssuers) \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 3 and (hour(Timestamp) < 8 or hour(Timestamp) > 18)`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.certificate.issuer NOT IN ['trusted_issuers'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 3 AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18)`. |

## T1587.003: Digital Certificates

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Malicious Use of Stolen Digital Certificates | Adversaries use stolen digital certificates to sign malicious payloads, as in Volt Typhoon. | - File Creation (DS0013: Sysmon ID 11)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll") AND CertificateIssuer NOT IN (trusted_issuers) \| join host [search index=endpoint sourcetype=sysmon EventCode=1] \| stats count by host, FileName, CertificateIssuer \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".exe", ".dll") and CertificateIssuer !in (trustedIssuers) \| join kind=inner (DeviceProcessEvents) on DeviceName \| summarize count() by DeviceName, FileName, CertificateIssuer \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.exe" OR "*.dll") AND file.certificate.issuer NOT IN ['trusted_issuers'] \| JOIN logs-endpoint.process-* ON host.name \| STATS COUNT() BY host.name, file.name, file.certificate.issuer HAVING COUNT() > 5`. |
| 2. Execution of Code with Untrusted Certificates | Adversaries execute code signed with untrusted or revoked digital certificates, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Metadata | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CertificateIssuer NOT IN (trusted_issuers) AND Image IN ("*.exe", "*.dll") \| stats count by host, Image, CertificateIssuer \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where CertificateIssuer !in (trustedIssuers) and ProcessName has_any (".exe", ".dll") \| summarize count() by DeviceName, ProcessName, CertificateIssuer \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.certificate.issuer NOT IN ['trusted_issuers'] AND process.executable : ("*.exe" OR "*.dll") \| STATS COUNT() BY host.name, process.executable, process.certificate.issuer HAVING COUNT() > 5`. |
| 3. Digital Certificate Misuse in Cloud Environments | Adversaries misuse stolen digital certificates in cloud-hosted applications, as in 2025 trends. | - Cloud Audit Logs (AWS CloudTrail)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("PutObject", "UploadPart") AND requestParameters IN ("*.exe", "*.dll") AND CertificateIssuer NOT IN (trusted_issuers) \| stats count by src_ip, eventName, CertificateIssuer \| where count > 5`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("PutObject", "UploadPart") and RequestParameters has_any (".exe", ".dll") and CertificateIssuer !in (trustedIssuers) \| summarize count() by SourceIP, EventName, CertificateIssuer \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['PutObject', 'UploadPart'] AND event.request_parameters : ("*.exe" OR "*.dll") AND file.certificate.issuer NOT IN ['trusted_issuers'] \| STATS COUNT() BY source.ip, event.action, file.certificate.issuer HAVING COUNT() > 5`. |
| 4. Digital Certificate Misuse via Compromised Endpoints | Compromised endpoints execute code signed with stolen digital certificates, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CertificateIssuer NOT IN (trusted_issuers) \| join host [search index=network sourcetype=zeek_http dest_ip IN (malware_c2_ips)] \| stats count by host, Image, CertificateIssuer, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where CertificateIssuer !in (trustedIssuers) \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (malwareC2IPs)) on DeviceName \| summarize count() by DeviceName, ProcessName, CertificateIssuer, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.certificate.issuer NOT IN ['trusted_issuers'] \| JOIN logs-zeek.http-* ON host.name WHERE destination.ip IN ['malware_c2_ips'] \| STATS COUNT() BY host.name, process.executable, process.certificate.issuer, destination.ip HAVING COUNT() > 5`. |
| 5. Digital Certificate Misuse in Linux Environments | Adversaries use stolen digital certificates to sign Linux malware, as in Turla. | - Process Creation (Linux Auditd)<br>- File Creation (Linux Auditd) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*.elf") AND certificate_issuer NOT IN (trusted_issuers) \| stats count by host, exe, certificate_issuer \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any (".elf") and CertificateIssuer !in (trustedIssuers) \| summarize count() by HostName, ProcessName, CertificateIssuer \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*.elf") AND process.certificate.issuer NOT IN ['trusted_issuers'] \| STATS COUNT() BY host.name, process.exe, process.certificate.issuer HAVING COUNT() > 5`. |
| 6. Digital Certificate Misuse with Suspicious User Agents | Adversaries use non-standard user agents to download code with untrusted certificates, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND uri IN ("*.exe", "*.dll") AND CertificateIssuer NOT IN (trusted_issuers) \| stats count by src_ip, user_agent, uri, CertificateIssuer \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and RemoteUrl has_any (".exe", ".dll") and CertificateIssuer !in (trustedIssuers) \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteUrl, CertificateIssuer \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND http.uri : ("*.exe" OR "*.dll") AND http.certificate.issuer NOT IN ['trusted_issuers'] \| STATS COUNT() BY source.ip, http.user_agent, http.uri, http.certificate.issuer HAVING COUNT() > 10`. |
| 7. High-Frequency Execution of Code with Untrusted Certificates | High-frequency execution of code signed with untrusted certificates, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CertificateIssuer NOT IN (trusted_issuers) \| timechart span=1m count by host \| where count > 50`.<br>- **KQL**: `DeviceProcessEvents \| where CertificateIssuer !in (trustedIssuers) \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceName \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.certificate.issuer NOT IN ['trusted_issuers'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), host.name \| WHERE COUNT() > 50`. |
| 8. Digital Certificate Misuse via Known Malicious IPs | Code with untrusted certificates downloaded from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http src_ip IN (threat_intel_ips) AND uri IN ("*.exe", "*.dll") AND CertificateIssuer NOT IN (trusted_issuers) \| stats count by src_ip, uri, CertificateIssuer \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceIP in (threatIntelIPs) and RemoteUrl has_any (".exe", ".dll") and CertificateIssuer !in (trustedIssuers) \| summarize count() by DeviceIP, RemoteUrl, CertificateIssuer \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE source.ip IN ['threat_intel_ips'] AND http.uri : ("*.exe" OR "*.dll") AND http.certificate.issuer NOT IN ['trusted_issuers'] \| STATS COUNT() BY source.ip, http.uri, http.certificate.issuer HAVING COUNT() > 10`. |
| 9. Code with Untrusted Certificates and Suspicious Metadata | Code signed with untrusted certificates has unusual metadata, as in 2025 trends. | - File Creation (DS0013: Sysmon ID 11)<br>- File Metadata | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.dll") AND CertificateIssuer NOT IN (trusted_issuers) AND FileSize < 100KB \| stats count by host, FileName, CertificateIssuer \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".exe", ".dll") and CertificateIssuer !in (trustedIssuers) and FileSize < 100000 \| summarize count() by DeviceName, FileName, CertificateIssuer \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.exe" OR "*.dll") AND file.certificate.issuer NOT IN ['trusted_issuers'] AND file.size < 100000 \| STATS COUNT() BY host.name, file.name, file.certificate.issuer HAVING COUNT() > 5`. |
| 10. Untrusted Certificate Code Execution Outside Business Hours | Execution of code with untrusted certificates outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CertificateIssuer NOT IN (trusted_issuers) \| timechart span=1h count by host \| where count > avg(count)*3 AND (_time < "08:00" OR _time > "18:00")`.<br>- **KQL**: `DeviceProcessEvents \| where CertificateIssuer !in (trustedIssuers) \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 3 and (hour(Timestamp) < 8 or hour(Timestamp) > 18)`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.certificate.issuer NOT IN ['trusted_issuers'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 3 AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18)`. |

## T1587.004: Exploits

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Exploit Delivery via Phishing Emails | Adversaries deliver exploits via phishing emails, as in Volt Typhoon. | - Email Logs (DS0004)<br>- Email Attachments (DS0004) | - **Splunk**: `index=email sourcetype=zeek_smtp attachment IN ("*.pdf", "*.docx", "*.js") AND src_ip NOT IN (trusted_ips) \| stats count by src_ip, recipient, attachment \| where count > 5`.<br>- **KQL**: `EmailEvents \| where AttachmentName has_any (".pdf", ".docx", ".js") and SenderIP !in (trustedIPs) \| summarize count() by SenderIP, RecipientEmailAddress, AttachmentName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.smtp-* \| WHERE email.attachment : ("*.pdf" OR "*.docx" OR "*.js") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, email.recipient, email.attachment HAVING COUNT() > 5`. |
| 2. Exploit Execution via Network Traffic | Adversaries deliver exploits via HTTP/HTTPS traffic, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http uri IN ("*.pdf", "*.docx", "*.js") AND response_status_code IN ("200", "404") AND dest_ip NOT IN (trusted_ips) \| stats count by src_ip, dest_ip, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any (".pdf", ".docx", ".js") and ResponseStatusCode in ("200", "404") and RemoteIP !in (trustedIPs) \| summarize count() by DeviceIP, RemoteIP, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri : ("*.pdf" OR "*.docx" OR "*.js") AND http.response.status_code IN ['200', '404'] AND destination.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, destination.ip, http.uri HAVING COUNT() > 10`. |
| 3. Exploit Execution on Compromised Endpoints | Compromised endpoints execute exploits from untrusted sources, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*powershell.exe*", "*cmd.exe*") AND Image NOT IN (trusted_paths) \| join host [search index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.pdf", "*.docx", "*.js")] \| stats count by host, Image, FileName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("powershell.exe", "cmd.exe") and ProcessName !in (trustedPaths) \| join kind=inner (DeviceFileEvents \| where FileName has_any (".pdf", ".docx", ".js")) on DeviceName \| summarize count() by DeviceName, ProcessName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*powershell.exe*" OR "*cmd.exe*") AND process.executable NOT IN ['trusted_paths'] \| JOIN logs-endpoint.file-* ON host.name WHERE file.name : ("*.pdf" OR "*.docx" OR "*.js") \| STATS COUNT() BY host.name, process.executable, file.name HAVING COUNT() > 5`. |
| 4. Exploit Delivery via Browser Automation | Adversaries use browser automation to deliver exploits, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*selenium*", "*puppeteer*") \| join host [search index=network sourcetype=zeek_http uri IN ("*.pdf", "*.docx", "*.js")] \| stats count by host, CommandLine, uri \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("selenium", "puppeteer") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any (".pdf", ".docx", ".js")) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, RemoteUrl \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*selenium*" OR "*puppeteer*") \| JOIN logs-zeek.http-* ON host.name WHERE http.uri : ("*.pdf" OR "*.docx" OR "*.js") \| STATS COUNT() BY host.name, process.command_line, http.uri HAVING COUNT() > 5`. |
| 5. Exploit Execution in Linux Environments | Adversaries deploy exploits using Linux tools, as in Turla. | - Process Creation (Linux Auditd)<br>- File Creation (Linux Auditd) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*bash*", "*sh*") AND args IN ("*.sh", "*.py") \| stats count by host, exe, args \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("bash", "sh") and CommandLine has_any (".sh", ".py") \| summarize count() by HostName, ProcessName, CommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*bash*" OR "*sh*") AND process.args : ("*.sh" OR "*.py") \| STATS COUNT() BY host.name, process.exe, process.args HAVING COUNT() > 5`. |
| 6. Exploit Delivery with Suspicious User Agents | Adversaries use non-standard user agents to deliver exploits, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND uri IN ("*.pdf", "*.docx", "*.js") \| stats count by src_ip, user_agent, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and RemoteUrl has_any (".pdf", ".docx", ".js") \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND http.uri : ("*.pdf" OR "*.docx" OR "*.js") \| STATS COUNT() BY source.ip, http.user_agent, http.uri HAVING COUNT() > 10`. |
| 7. High-Frequency Exploit Delivery | High-frequency delivery of exploit files, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http uri IN ("*.pdf", "*.docx", "*.js") \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any (".pdf", ".docx", ".js") \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri : ("*.pdf" OR "*.docx" OR "*.js") \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 8. Exploit Delivery via Known Malicious IPs | Exploits delivered from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http src_ip IN (threat_intel_ips) AND uri IN ("*.pdf", "*.docx", "*.js") \| stats count by src_ip, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceIP in (threatIntelIPs) and RemoteUrl has_any (".pdf", ".docx", ".js") \| summarize count() by DeviceIP, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE source.ip IN ['threat_intel_ips'] AND http.uri : ("*.pdf" OR "*.docx" OR "*.js") \| STATS COUNT() BY source.ip, http.uri HAVING COUNT() > 10`. |
| 9. Exploit Execution with Suspicious File Metadata | Exploits with unusual file metadata executed on endpoints, as in 2025 trends. | - File Creation (DS0013: Sysmon ID 11)<br>- File Metadata | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.pdf", "*.docx", "*.js") AND FileSize < 100KB \| stats count by host, FileName \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".pdf", ".docx", ".js") and FileSize < 100000 \| summarize count() by DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.pdf" OR "*.docx" OR "*.js") AND file.size < 100000 \| STATS COUNT() BY host.name, file.name HAVING COUNT() > 5`. |
| 10. Exploit Execution Outside Business Hours | Exploit execution outside business hours, indicating compromise, as in APT29. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*powershell.exe*", "*cmd.exe*") AND Image NOT IN (trusted_paths) \| timechart span=1h count by host \| where count > avg(count)*3 AND (_time < "08:00" OR _time > "18:00")`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("powershell.exe", "cmd.exe") and ProcessName !in (trustedPaths) \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 3 and (hour(Timestamp) < 8 or hour(Timestamp) > 18)`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*powershell.exe*" OR "*cmd.exe*") AND process.executable NOT IN ['trusted_paths'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 3 AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18)`. |

### T1608: Stage Capabilities

### T1608.001: Upload Malware

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Malware Upload via Phishing Emails | Adversaries upload malware via phishing email attachments, as in Volt Typhoon. | - Email Logs (DS0004)<br>- Email Attachments (DS0004) | - **Splunk**: `index=email sourcetype=zeek_smtp attachment IN ("*.exe", "*.zip", "*.scr") AND src_ip NOT IN (trusted_ips) \| stats count by src_ip, recipient, attachment \| where count > 5`.<br>- **KQL**: `EmailEvents \| where AttachmentName has_any (".exe", ".zip", ".scr") and SenderIP !in (trustedIPs) \| summarize count() by SenderIP, RecipientEmailAddress, AttachmentName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.smtp-* \| WHERE email.attachment : ("*.exe" OR "*.zip" OR "*.scr") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, email.recipient, email.attachment HAVING COUNT() > 5`. |
| 2. Malware Upload to Compromised Servers | Adversaries upload malware to compromised web servers, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- File Creation (DS0013) | - **Splunk**: `index=network sourcetype=zeek_http method=POST AND uri IN ("*.php", "*.asp", "*.jsp") AND dest_ip IN (compromised_servers) \| stats count by src_ip, dest_ip, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and HttpMethod == "POST" and RemoteUrl has_any (".php", ".asp", ".jsp") and RemoteIP in (compromisedServers) \| summarize count() by DeviceIP, RemoteIP, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.method == "POST" AND http.uri : ("*.php" OR "*.asp" OR "*.jsp") AND destination.ip IN ['compromised_servers'] \| STATS COUNT() BY source.ip, destination.ip, http.uri HAVING COUNT() > 10`. |
| 3. Malware Upload via FTP/SFTP | Adversaries upload malware using FTP/SFTP protocols, as in FIN7. | - Network Traffic (DS0003: Zeek FTP)<br>- File Creation (DS0013) | - **Splunk**: `index=network sourcetype=zeek_ftp command IN ("STOR", "PUT") AND dest_ip NOT IN (trusted_ips) \| stats count by src_ip, dest_ip, file_name \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "FTP" and Command has_any ("STOR", "PUT") and RemoteIP !in (trustedIPs) \| summarize count() by DeviceIP, RemoteIP, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.ftp-* \| WHERE ftp.command : ("STOR" OR "PUT") AND destination.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, destination.ip, ftp.file_name HAVING COUNT() > 5`. |
| 4. Malware Upload via Cloud APIs | Adversaries upload malware using cloud service APIs, as in 2025 trends. | - Cloud Audit Logs (AWS CloudTrail, Azure AD) | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("PutObject", "UploadPart") AND requestParameters IN ("*.exe", "*.dll") AND src_ip NOT IN (trusted_ips) \| stats count by src_ip, eventName, requestParameters \| where count > 5`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("PutObject", "UploadPart") and RequestParameters has_any (".exe", ".dll") and SourceIP !in (trustedIPs) \| summarize count() by SourceIP, EventName, RequestParameters \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['PutObject', 'UploadPart'] AND event.request_parameters : ("*.exe" OR "*.dll") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, event.action, event.request_parameters HAVING COUNT() > 5`. |
| 5. Malware Upload in Linux Environments | Adversaries upload malware to Linux servers, as in Turla. | - Process Creation (Linux Auditd)<br>- File Creation (Linux Auditd) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*scp*", "*ftp*") AND args IN ("*.elf", "*.sh") \| stats count by host, exe, args \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("scp", "ftp") and CommandLine has_any (".elf", ".sh") \| summarize count() by HostName, ProcessName, CommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*scp*" OR "*ftp*") AND process.args : ("*.elf" OR "*.sh") \| STATS COUNT() BY host.name, process.exe, process.args HAVING COUNT() > 5`. |
| 6. Malware Upload with Suspicious User Agents | Adversaries use non-standard user agents to upload malware, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND method=POST AND uri IN ("*.exe", "*.dll") \| stats count by src_ip, user_agent, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and HttpMethod == "POST" and RemoteUrl has_any (".exe", ".dll") \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND http.method == "POST" AND http.uri : ("*.exe" OR "*.dll") \| STATS COUNT() BY source.ip, http.user_agent, http.uri HAVING COUNT() > 10`. |
| 7. High-Frequency Malware Uploads | High-frequency uploads of malware files, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http method=POST AND uri IN ("*.exe", "*.dll") \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and HttpMethod == "POST" and RemoteUrl has_any (".exe", ".dll") \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.method == "POST" AND http.uri : ("*.exe" OR "*.dll") \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 8. Malware Upload via Known Malicious IPs | Malware uploaded from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http src_ip IN (threat_intel_ips) AND method=POST AND uri IN ("*.exe", "*.dll") \| stats count by src_ip, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceIP in (threatIntelIPs) and HttpMethod == "POST" and RemoteUrl has_any (".exe", ".dll") \| summarize count() by DeviceIP, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE source.ip IN ['threat_intel_ips'] AND http.method == "POST" AND http.uri : ("*.exe" OR "*.dll") \| STATS COUNT() BY source.ip, http.uri HAVING COUNT() > 10`. |
| 9. Malware Upload to Compromised Cloud Instances | Adversaries upload malware to compromised cloud instances, as in 2025 trends. | - Cloud Audit Logs (AWS CloudTrail)<br>- File Creation (DS0013) | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("PutObject", "UploadPart") AND src_ip IN (compromised_instances) \| stats count by src_ip, eventName, requestParameters \| where count > 5`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("PutObject", "UploadPart") and SourceIP in (compromisedInstances) \| summarize count() by SourceIP, EventName, RequestParameters \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['PutObject', 'UploadPart'] AND source.ip IN ['compromised_instances'] \| STATS COUNT() BY source.ip, event.action, event.request_parameters HAVING COUNT() > 5`. |
| 10. Malware Upload Outside Business Hours | Malware uploads occurring outside business hours, as in APT29. | - Network Traffic (DS0003: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http method=POST AND uri IN ("*.exe", "*.dll") \| timechart span=1h count by src_ip \| where count > avg(count)*3 AND (_time < "08:00" OR _time > "18:00")`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and HttpMethod == "POST" and RemoteUrl has_any (".exe", ".dll") \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceIP \| where HourlyCount > avg(HourlyCount) * 3 and (hour(Timestamp) < 8 or hour(Timestamp) > 18)`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.method == "POST" AND http.uri : ("*.exe" OR "*.dll") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip \| WHERE COUNT() > AVG(COUNT()) * 3 AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18)`. |

### T1608.002: Upload to Cloud Storage

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Malware Upload to Public Cloud Storage | Adversaries upload malware to public cloud storage services, as in Volt Typhoon. | - Cloud Audit Logs (AWS CloudTrail, Azure AD) | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("PutObject", "UploadPart") AND requestParameters IN ("*.exe", "*.dll", "*.zip") AND bucket IN ("public_buckets") \| stats count by src_ip, bucket, requestParameters \| where count > 5`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("PutObject", "UploadPart") and RequestParameters has_any (".exe", ".dll", ".zip") and BucketName in (publicBuckets) \| summarize count() by SourceIP, BucketName, RequestParameters \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['PutObject', 'UploadPart'] AND event.request_parameters : ("*.exe" OR "*.dll" OR "*.zip") AND cloud.bucket IN ['public_buckets'] \| STATS COUNT() BY source.ip, cloud.bucket, event.request_parameters HAVING COUNT() > 5`. |
| 2. Suspicious Cloud Storage Uploads from Untrusted IPs | Adversaries upload files to cloud storage from untrusted IPs, as in APT41. | - Cloud Audit Logs (AWS CloudTrail) | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("PutObject", "UploadPart") AND src_ip NOT IN (trusted_ips) \| stats count by src_ip, eventName, requestParameters \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("PutObject", "UploadPart") and SourceIP !in (trustedIPs) \| summarize count() by SourceIP, EventName, RequestParameters \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['PutObject', 'UploadPart'] AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, event.action, event.request_parameters HAVING COUNT() > 10`. |
| 3. Cloud Storage Uploads with Suspicious File Types | Adversaries upload suspicious file types to cloud storage, as in 2025 trends. | - Cloud Audit Logs (AWS CloudTrail) | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("PutObject", "UploadPart") AND requestParameters IN ("*.exe", "*.dll", "*.scr") \| stats count by src_ip, eventName, requestParameters \| where count > 5`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("PutObject", "UploadPart") and RequestParameters has_any (".exe", ".dll", ".scr") \| summarize count() by SourceIP, EventName, RequestParameters \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['PutObject', 'UploadPart'] AND event.request_parameters : ("*.exe" OR "*.dll" OR "*.scr") \| STATS COUNT() BY source.ip, event.action, event.request_parameters HAVING COUNT() > 5`. |
| 4. Cloud Storage Uploads from Compromised Endpoints | Compromised endpoints upload files to cloud storage, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Cloud Audit Logs (AWS CloudTrail) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*aws cli*", "*boto3*") \| join host [search index=cloud sourcetype=aws:cloudtrail eventName IN ("PutObject", "UploadPart")] \| stats count by host, CommandLine, eventName \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("aws cli", "boto3") \| join kind=inner (AWSCloudTrail \| where EventName in ("PutObject", "UploadPart")) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, EventName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*aws cli*" OR "*boto3*") \| JOIN logs-aws.cloudtrail-* ON host.name WHERE event.action IN ['PutObject', 'UploadPart'] \| STATS COUNT() BY host.name, process.command_line, event.action HAVING COUNT() > 5`. |
| 5. Cloud Storage Uploads in Linux Environments | Adversaries upload files to cloud storage from Linux systems, as in Turla. | - Process Creation (Linux Auditd)<br>- Cloud Audit Logs (AWS CloudTrail) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*aws*", "*az*") AND args IN ("*s3*", "*blob*") \| stats count by host, exe, args \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("aws", "az") and CommandLine has_any ("s3", "blob") \| summarize count() by HostName, ProcessName, CommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*aws*" OR "*az*") AND process.args : ("*s3*" OR "*blob*") \| STATS COUNT() BY host.name, process.exe, process.args HAVING COUNT() > 5`. |
| 6. Cloud Storage Uploads with Suspicious User Agents | Adversaries use non-standard user agents to upload to cloud storage, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Cloud Audit Logs (AWS CloudTrail) | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND uri IN ("*s3.amazonaws.com*", "*blob.core.windows.net*") AND method=POST \| stats count by src_ip, user_agent, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and RemoteUrl has_any ("s3.amazonaws.com", "blob.core.windows.net") and HttpMethod == "POST" \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND http.uri : ("*s3.amazonaws.com*" OR "*blob.core.windows.net*") AND http.method == "POST" \| STATS COUNT() BY source.ip, http.user_agent, http.uri HAVING COUNT() > 10`. |
| 7. High-Frequency Cloud Storage Uploads | High-frequency uploads to cloud storage, indicating staging, as in APT41. | - Cloud Audit Logs (AWS CloudTrail)<br>- Metrics | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("PutObject", "UploadPart") \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("PutObject", "UploadPart") \| summarize MinuteCount=count() by bin(Timestamp, 1m), SourceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['PutObject', 'UploadPart'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 8. Cloud Storage Uploads via Known Malicious IPs | Uploads to cloud storage from known malicious IPs, as in Volt Typhoon. | - Cloud Audit Logs (AWS CloudTrail)<br>- Threat Intelligence | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("PutObject", "UploadPart") AND src_ip IN (threat_intel_ips) \| stats count by src_ip, eventName \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("PutObject", "UploadPart") and SourceIP in (threatIntelIPs) \| summarize count() by SourceIP, EventName \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['PutObject', 'UploadPart'] AND source.ip IN ['threat_intel_ips'] \| STATS COUNT() BY source.ip, event.action HAVING COUNT() > 10`. |
| 9. Cloud Storage Uploads with Suspicious File Names | Adversaries upload files with suspicious names to cloud storage, as in 2025 trends. | - Cloud Audit Logs (AWS CloudTrail) | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("PutObject", "UploadPart") AND requestParameters IN ("*malware*", "*backdoor*", "*exploit*") \| stats count by src_ip, eventName, requestParameters \| where count > 5`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("PutObject", "UploadPart") and RequestParameters has_any ("malware", "backdoor", "exploit") \| summarize count() by SourceIP, EventName, RequestParameters \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['PutObject', 'UploadPart'] AND event.request_parameters : ("*malware*" OR "*backdoor*" OR "*exploit*") \| STATS COUNT() BY source.ip, event.action, event.request_parameters HAVING COUNT() > 5`. |
| 10. Cloud Storage Uploads Outside Business Hours | Uploads to cloud storage outside business hours, as in APT29. | - Cloud Audit Logs (AWS CloudTrail)<br>- Metrics | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("PutObject", "UploadPart") \| timechart span=1h count by src_ip \| where count > avg(count)*3 AND (_time < "08:00" OR _time > "18:00")`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("PutObject", "UploadPart") \| summarize HourlyCount=count() by bin(Timestamp, 1h), SourceIP \| where HourlyCount > avg(HourlyCount) * 3 and (hour(Timestamp) < 8 or hour(Timestamp) > 18)`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['PutObject', 'UploadPart'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip \| WHERE COUNT() > AVG(COUNT()) * 3 AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18)`. |

### T1608.003: Install Digital Certificate

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Unauthorized Digital Certificate Installation | Adversaries install unauthorized digital certificates, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*certutil.exe*", "*openssl*") AND args IN ("*installcert*", "*addstore*") \| stats count by host, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("certutil.exe", "openssl") and ProcessCommandLine has_any ("installcert", "addstore") \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*certutil.exe*" OR "*openssl*") AND process.command_line : ("*installcert*" OR "*addstore*") \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 5`. |
| 2. Digital Certificate Installation via Compromised Endpoints | Compromised endpoints install untrusted certificates, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*certutil.exe*", "*openssl*") \| join host [search index=network sourcetype=zeek_http dest_ip IN (malware_c2_ips)] \| stats count by host, CommandLine, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("certutil.exe", "openssl") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (malwareC2IPs)) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*certutil.exe*" OR "*openssl*") \| JOIN logs-zeek.http-* ON host.name WHERE destination.ip IN ['malware_c2_ips'] \| STATS COUNT() BY host.name, process.command_line, destination.ip HAVING COUNT() > 5`. |
| 3. Digital Certificate Installation in Cloud Environments | Adversaries install certificates in cloud environments, as in 2025 trends. | - Cloud Audit Logs (AWS CloudTrail) | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("PutCertificate", "ImportCertificate") AND userIdentity NOT IN (authorized_users) \| stats count by src_ip, eventName \| where count > 5`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("PutCertificate", "ImportCertificate") and Caller !in (authorizedUsers) \| summarize count() by SourceIP, EventName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['PutCertificate', 'ImportCertificate'] AND user.identity NOT IN ['authorized_users'] \| STATS COUNT() BY source.ip, event.action HAVING COUNT() > 5`. |
| 4. Digital Certificate Installation in Linux Environments | Adversaries install certificates on Linux systems, as in Turla. | - Process Creation (Linux Auditd)<br>- File Creation (Linux Auditd) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*openssl*", "*keytool*") AND args IN ("*cert*") \| stats count by host, exe, args \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("openssl", "keytool") and CommandLine has_any ("cert") \| summarize count() by HostName, ProcessName, CommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*openssl*" OR "*keytool*") AND process.args : ("*cert*") \| STATS COUNT() BY host.name, process.exe, process.args HAVING COUNT() > 5`. |
| 5. Digital Certificate Installation with Suspicious User Agents | Adversaries use non-standard user agents to download certificates, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND uri IN ("*.cer", "*.crt", "*.pem") \| stats count by src_ip, user_agent, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and RemoteUrl has_any (".cer", ".crt", ".pem") \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND http.uri : ("*.cer" OR "*.crt" OR "*.pem") \| STATS COUNT() BY source.ip, http.user_agent, http.uri HAVING COUNT() > 10`. |
| 6. High-Frequency Certificate Installation | High-frequency certificate installations, indicating staging, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*certutil.exe*", "*openssl*") \| timechart span=1m count by host \| where count > 50`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("certutil.exe", "openssl") \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceName \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*certutil.exe*" OR "*openssl*") \| STATS COUNT() BY date_histogram(@timestamp, '1m'), host.name \| WHERE COUNT() > 50`. |
| 7. Certificate Installation via Known Malicious IPs | Certificate installation from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http src_ip IN (threat_intel_ips) AND uri IN ("*.cer", "*.crt", "*.pem") \| stats count by src_ip, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceIP in (threatIntelIPs) and RemoteUrl has_any (".cer", ".crt", ".pem") \| summarize count() by DeviceIP, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE source.ip IN ['threat_intel_ips'] AND http.uri : ("*.cer" OR "*.crt" OR "*.pem") \| STATS COUNT() BY source.ip, http.uri HAVING COUNT() > 10`. |
| 8. Certificate Installation with Suspicious File Metadata | Certificates with unusual metadata installed on endpoints, as in 2025 trends. | - File Creation (DS0013: Sysmon ID 11)<br>- File Metadata | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.cer", "*.crt", "*.pem") AND FileSize < 10KB \| stats count by host, FileName \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".cer", ".crt", ".pem") and FileSize < 10000 \| summarize count() by DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.cer" OR "*.crt" OR "*.pem") AND file.size < 10000 \| STATS COUNT() BY host.name, file.name HAVING COUNT() > 5`. |
| 9. Certificate Installation Outside Business Hours | Certificate installation outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*certutil.exe*", "*openssl*") \| timechart span=1h count by host \| where count > avg(count)*3 AND (_time < "08:00" OR _time > "18:00")`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("certutil.exe", "openssl") \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 3 and (hour(Timestamp) < 8 or hour(Timestamp) > 18)`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*certutil.exe*" OR "*openssl*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 3 AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18)`. |
| 10. Certificate Installation with Suspicious Commands | Adversaries use unusual commands to install certificates, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*certutil.exe -addstore*", "*openssl req*") AND CommandLine NOT IN (known_commands) \| stats count by host, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("certutil.exe -addstore", "openssl req") and ProcessCommandLine !in (knownCommands) \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*certutil.exe -addstore*" OR "*openssl req*") AND process.command_line NOT IN ['known_commands'] \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 5`. |

### T1608.004: Drive-by Download

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Drive-by Download from Malicious Websites | Adversaries deliver malware via drive-by downloads from malicious websites, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http uri IN ("*.exe", "*.zip", "*.scr") AND dest_ip IN (malware_c2_ips) \| stats count by src_ip, dest_ip, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any (".exe", ".zip", ".scr") and RemoteIP in (malwareC2IPs) \| summarize count() by DeviceIP, RemoteIP, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri : ("*.exe" OR "*.zip" OR "*.scr") AND destination.ip IN ['malware_c2_ips'] \| STATS COUNT() BY source.ip, destination.ip, http.uri HAVING COUNT() > 10`. |
| 2. Drive-by Download via Compromised Websites | Adversaries use compromised websites for drive-by downloads, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http dest_ip IN (compromised_websites) AND uri IN ("*.exe", "*.zip") \| stats count by src_ip, dest_ip, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (compromisedWebsites) and RemoteUrl has_any (".exe", ".zip") \| summarize count() by DeviceIP, RemoteIP, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE destination.ip IN ['compromised_websites'] AND http.uri : ("*.exe" OR "*.zip") \| STATS COUNT() BY source.ip, destination.ip, http.uri HAVING COUNT() > 10`. |
| 3. Drive-by Download with Suspicious User Agents | Adversaries use non-standard user agents for drive-by downloads, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND uri IN ("*.exe", "*.zip", "*.scr") \| stats count by src_ip, user_agent, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and RemoteUrl has_any (".exe", ".zip", ".scr") \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND http.uri : ("*.exe" OR "*.zip" OR "*.scr") \| STATS COUNT() BY source.ip, http.user_agent, http.uri HAVING COUNT() > 10`. |
| 4. Drive-by Download via Browser Exploits | Adversaries exploit browsers for drive-by downloads, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*chrome.exe*", "*firefox.exe*") \| join host [search index=network sourcetype=zeek_http uri IN ("*.exe", "*.zip")] \| stats count by host, CommandLine, uri \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("chrome.exe", "firefox.exe") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any (".exe", ".zip")) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, RemoteUrl \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*chrome.exe*" OR "*firefox.exe*") \| JOIN logs-zeek.http-* ON host.name WHERE http.uri : ("*.exe" OR "*.zip") \| STATS COUNT() BY host.name, process.command_line, http.uri HAVING COUNT() > 5`. |
| 5. Drive-by Download in Linux Environments | Adversaries target Linux browsers for drive-by downloads, as in Turla. | - Process Creation (Linux Auditd)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*firefox*", "*chromium*") AND args IN ("*.elf", "*.sh") \| stats count by host, exe, args \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("firefox", "chromium") and CommandLine has_any (".elf", ".sh") \| summarize count() by HostName, ProcessName, CommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*firefox*" OR "*chromium*") AND process.args : ("*.elf" OR "*.sh") \| STATS COUNT() BY host.name, process.exe, process.args HAVING COUNT() > 5`. |
| 6. High-Frequency Drive-by Downloads | High-frequency downloads from suspicious URLs, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http uri IN ("*.exe", "*.zip", "*.scr") \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any (".exe", ".zip", ".scr") \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri : ("*.exe" OR "*.zip" OR "*.scr") \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 7. Drive-by Download via Known Malicious IPs | Downloads from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http src_ip IN (threat_intel_ips) AND uri IN ("*.exe", "*.zip", "*.scr") \| stats count by src_ip, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceIP in (threatIntelIPs) and RemoteUrl has_any (".exe", ".zip", ".scr") \| summarize count() by DeviceIP, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE source.ip IN ['threat_intel_ips'] AND http.uri : ("*.exe" OR "*.zip" OR "*.scr") \| STATS COUNT() BY source.ip, http.uri HAVING COUNT() > 10`. |
| 8. Drive-by Download with Suspicious File Metadata | Downloaded files with unusual metadata, as in 2025 trends. | - File Creation (DS0013: Sysmon ID 11)<br>- File Metadata | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.zip", "*.scr") AND FileSize < 100KB \| stats count by host, FileName \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".exe", ".zip", ".scr") and FileSize < 100000 \| summarize count() by DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.exe" OR "*.zip" OR "*.scr") AND file.size < 100000 \| STATS COUNT() BY host.name, file.name HAVING COUNT() > 5`. |
| 9. Drive-by Download Outside Business Hours | Drive-by downloads occurring outside business hours, as in APT29. | - Network Traffic (DS0003: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http uri IN ("*.exe", "*.zip", "*.scr") \| timechart span=1h count by src_ip \| where count > avg(count)*3 AND (_time < "08:00" OR _time > "18:00")`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any (".exe", ".zip", ".scr") \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceIP \| where HourlyCount > avg(HourlyCount) * 3 and (hour(Timestamp) < 8 or hour(Timestamp) > 18)`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri : ("*.exe" OR "*.zip" OR "*.scr") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip \| WHERE COUNT() > AVG(COUNT()) * 3 AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18)`. |
| 10. Drive-by Download via Suspicious Domains | Downloads from suspicious domains, as in 2025 trends. | - DNS Logs (DS0001)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=dns sourcetype=zeek_dns query IN (malware_c2_domains) \| join src_ip [search index=network sourcetype=zeek_http uri IN ("*.exe", "*.zip")] \| stats count by src_ip, query, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and DnsQueryName in (malwareC2Domains) \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any (".exe", ".zip")) on DeviceIP \| summarize count() by DeviceIP, DnsQueryName, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE dns.query IN ['malware_c2_domains'] \| JOIN logs-zeek.http-* ON source.ip WHERE http.uri : ("*.exe" OR "*.zip") \| STATS COUNT() BY source.ip, dns.query, http.uri HAVING COUNT() > 10`. |

### T1608.005: Link Shortener

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Malicious Link Shortener Usage in Phishing Emails | Adversaries use link shorteners in phishing emails, as in Volt Typhoon. | - Email Logs (DS0004) | - **Splunk**: `index=email sourcetype=zeek_smtp uri IN ("*bit.ly*", "*tinyurl.com*", "*t.co*") AND src_ip NOT IN (trusted_ips) \| stats count by src_ip, recipient, uri \| where count > 5`.<br>- **KQL**: `EmailEvents \| where Url has_any ("bit.ly", "tinyurl.com", "t.co") and SenderIP !in (trustedIPs) \| summarize count() by SenderIP, RecipientEmailAddress, Url \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.smtp-* \| WHERE email.uri : ("*bit.ly*" OR "*tinyurl.com*" OR "*t.co*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, email.recipient, email.uri HAVING COUNT() > 5`. |
| 2. Link Shortener Redirects to Malicious Domains | Adversaries use link shorteners to redirect to malicious domains, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- DNS Logs (DS0001) | - **Splunk**: `index=network sourcetype=zeek_http uri IN ("*bit.ly*", "*tinyurl.com*", "*t.co*") \| join src_ip [search index=dns sourcetype=zeek_dns query IN (malware_c2_domains)] \| stats count by src_ip, uri, query \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any ("bit.ly", "tinyurl.com", "t.co") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "DNS" and DnsQueryName in (malwareC2Domains)) on DeviceIP \| summarize count() by DeviceIP, RemoteUrl, DnsQueryName \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri : ("*bit.ly*" OR "*tinyurl.com*" OR "*t.co*") \| JOIN logs-zeek.dns-* ON source.ip WHERE dns.query IN ['malware_c2_domains'] \| STATS COUNT() BY source.ip, http.uri, dns.query HAVING COUNT() > 10`. |
| 3. Link Shortener Access from Compromised Endpoints | Compromised endpoints access link shorteners, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*chrome.exe*", "*firefox.exe*") \| join host [search index=network sourcetype=zeek_http uri IN ("*bit.ly*", "*tinyurl.com*", "*t.co*")] \| stats count by host, CommandLine, uri \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("chrome.exe", "firefox.exe") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any ("bit.ly", "tinyurl.com", "t.co")) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, RemoteUrl \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*chrome.exe*" OR "*firefox.exe*") \| JOIN logs-zeek.http-* ON host.name WHERE http.uri : ("*bit.ly*" OR "*tinyurl.com*" OR "*t.co*") \| STATS COUNT() BY host.name, process.command_line, http.uri HAVING COUNT() > 5`. |
| 4. Link Shortener Usage with Suspicious User Agents | Adversaries use non-standard user agents to access link shorteners, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND uri IN ("*bit.ly*", "*tinyurl.com*", "*t.co*") \| stats count by src_ip, user_agent, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and RemoteUrl has_any ("bit.ly", "tinyurl.com", "t.co") \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND http.uri : ("*bit.ly*" OR "*tinyurl.com*" OR "*t.co*") \| STATS COUNT() BY source.ip, http.user_agent, http.uri HAVING COUNT() > 10`. |
| 5. Link Shortener Usage in Linux Environments | Adversaries use Linux tools to access link shorteners, as in Turla. | - Process Creation (Linux Auditd)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*curl*", "*wget*") AND args IN ("*bit.ly*", "*tinyurl.com*", "*t.co*") \| stats count by host, exe, args \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("curl", "wget") and CommandLine has_any ("bit.ly", "tinyurl.com", "t.co") \| summarize count() by HostName, ProcessName, CommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*curl*" OR "*wget*") AND process.args : ("*bit.ly*" OR "*tinyurl.com*" OR "*t.co*") \| STATS COUNT() BY host.name, process.exe, process.args HAVING COUNT() > 5`. |
| 6. High-Frequency Link Shortener Access | High-frequency access to link shorteners, indicating staging, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http uri IN ("*bit.ly*", "*tinyurl.com*", "*t.co*") \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any ("bit.ly", "tinyurl.com", "t.co") \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri : ("*bit.ly*" OR "*tinyurl.com*" OR "*t.co*") \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 7. Link Shortener Access via Known Malicious IPs | Access to link shorteners from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http src_ip IN (threat_intel_ips) AND uri IN ("*bit.ly*", "*tinyurl.com*", "*t.co*") \| stats count by src_ip, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceIP in (threatIntelIPs) and RemoteUrl has_any ("bit.ly", "tinyurl.com", "t.co") \| summarize count() by DeviceIP, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE source.ip IN ['threat_intel_ips'] AND http.uri : ("*bit.ly*" OR "*tinyurl.com*" OR "*t.co*") \| STATS COUNT() BY source.ip, http.uri HAVING COUNT() > 10`. |
| 8. Link Shortener Access Outside Business Hours | Access to link shorteners outside business hours, as in APT29. | - Network Traffic (DS0003: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http uri IN ("*bit.ly*", "*tinyurl.com*", "*t.co*") \| timechart span=1h count by src_ip \| where count > avg(count)*3 AND (_time < "08:00" OR _time > "18:00")`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any ("bit.ly", "tinyurl.com", "t.co") \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceIP \| where HourlyCount > avg(HourlyCount) * 3 and (hour(Timestamp) < 8 or hour(Timestamp) > 18)`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri : ("*bit.ly*" OR "*tinyurl.com*" OR "*t.co*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip \| WHERE COUNT() > AVG(COUNT()) * 3 AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18)`. |
| 9. Link Shortener Access via Browser Automation | Adversaries use browser automation to access link shorteners, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*selenium*", "*puppeteer*") \| join host [search index=network sourcetype=zeek_http uri IN ("*bit.ly*", "*tinyurl.com*", "*t.co*")] \| stats count by host, CommandLine, uri \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("selenium", "puppeteer") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any ("bit.ly", "tinyurl.com", "t.co")) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, RemoteUrl \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*selenium*" OR "*puppeteer*") \| JOIN logs-zeek.http-* ON host.name WHERE http.uri : ("*bit.ly*" OR "*tinyurl.com*" OR "*t.co*") \| STATS COUNT() BY host.name, process.command_line, http.uri HAVING COUNT() > 5`. |
| 10. Link Shortener Access with Suspicious Redirects | Link shorteners redirecting to suspicious file types, as in 2025 trends. | - Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=network sourcetype=zeek_http uri IN ("*bit.ly*", "*tinyurl.com*", "*t.co*") AND referer IN ("*.exe", "*.zip", "*.scr") \| stats count by src_ip, uri, referer \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any ("bit.ly", "tinyurl.com", "t.co") and Referer has_any (".exe", ".zip", ".scr") \| summarize count() by DeviceIP, RemoteUrl, Referer \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri : ("*bit.ly*" OR "*tinyurl.com*" OR "*t.co*") AND http.referer : ("*.exe" OR "*.zip" OR "*.scr") \| STATS COUNT() BY source.ip, http.uri, http.referer HAVING COUNT() > 10`. |

### T1608.006: Third-party Software

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Malicious Third-party Software Installation | Adversaries install malicious third-party software, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image NOT IN (trusted_software) AND CommandLine IN ("*.exe", "*.msi") \| stats count by host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName !in (trustedSoftware) and ProcessCommandLine has_any (".exe", ".msi") \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable NOT IN ['trusted_software'] AND process.command_line : ("*.exe" OR "*.msi") \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 2. Third-party Software Downloads from Malicious IPs | Adversaries download third-party software from malicious IPs, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http src_ip IN (threat_intel_ips) AND uri IN ("*.exe", "*.msi") \| stats count by src_ip, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceIP in (threatIntelIPs) and RemoteUrl has_any (".exe", ".msi") \| summarize count() by DeviceIP, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE source.ip IN ['threat_intel_ips'] AND http.uri : ("*.exe" OR "*.msi") \| STATS COUNT() BY source.ip, http.uri HAVING COUNT() > 10`. |
| 3. Third-party Software Execution with Suspicious User Agents | Adversaries use non-standard user agents to download third-party software, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND uri IN ("*.exe", "*.msi") \| stats count by src_ip, user_agent, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and RemoteUrl has_any (".exe", ".msi") \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND http.uri : ("*.exe" OR "*.msi") \| STATS COUNT() BY source.ip, http.user_agent, http.uri HAVING COUNT() > 10`. |
| 4. Third-party Software Installation in Linux Environments | Adversaries install malicious third-party software on Linux systems, as in Turla. | - Process Creation (Linux Auditd)<br>- File Creation (Linux Auditd) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*apt-get*", "*yum*") AND args IN ("*install*") AND args NOT IN (trusted_software) \| stats count by host, exe, args \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("apt-get", "yum") and CommandLine has_any ("install") and CommandLine !has_any (trustedSoftware) \| summarize count() by HostName, ProcessName, CommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*apt-get*" OR "*yum*") AND process.args : ("*install*") AND process.args NOT IN ['trusted_software'] \| STATS COUNT() BY host.name, process.exe, process.args HAVING COUNT() > 5`. |
| 5. Third-party Software Execution via Compromised Endpoints | Compromised endpoints execute malicious third-party software, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image NOT IN (trusted_software) \| join host [search index=network sourcetype=zeek_http dest_ip IN (malware_c2_ips)] \| stats count by host, Image, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName !in (trustedSoftware) \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (malwareC2IPs)) on DeviceName \| summarize count() by DeviceName, ProcessName, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable NOT IN ['trusted_software'] \| JOIN logs-zeek.http-* ON host.name WHERE destination.ip IN ['malware_c2_ips'] \| STATS COUNT() BY host.name, process.executable, destination.ip HAVING COUNT() > 5`. |
| 6. High-Frequency Third-party Software Downloads | High-frequency downloads of third-party software, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http uri IN ("*.exe", "*.msi") \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteUrl has_any (".exe", ".msi") \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.uri : ("*.exe" OR "*.msi") \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 7. Third-party Software Downloads via Known Malicious IPs | Downloads of third-party software from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http src_ip IN (threat_intel_ips) AND uri IN ("*.exe", "*.msi") \| stats count by src_ip, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where DeviceIP in (threatIntelIPs) and RemoteUrl has_any (".exe", ".msi") \| summarize count() by DeviceIP, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE source.ip IN ['threat_intel_ips'] AND http.uri : ("*.exe" OR "*.msi") \| STATS COUNT() BY source.ip, http.uri HAVING COUNT() > 10`. |
| 8. Third-party Software Installation Outside Business Hours | Installation of third-party software outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image NOT IN (trusted_software) \| timechart span=1h count by host \| where count > avg(count)*3 AND (_time < "08:00" OR _time > "18:00")`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName !in (trustedSoftware) \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 3 and (hour(Timestamp) < 8 or hour(Timestamp) > 18)`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable NOT IN ['trusted_software'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 3 AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18)`. |
| 9. Third-party Software with Suspicious File Metadata | Third-party software with unusual metadata, as in 2025 trends. | - File Creation (DS0013: Sysmon ID 11)<br>- File Metadata | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*.exe", "*.msi") AND FileSize < 100KB \| stats count by host, FileName \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any (".exe", ".msi") and FileSize < 100000 \| summarize count() by DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*.exe" OR "*.msi") AND file.size < 100000 \| STATS COUNT() BY host.name, file.name HAVING COUNT() > 5`. |
| 10. Third-party Software Installation via Suspicious Commands | Adversaries use unusual commands to install third-party software, as in 2025 trends. | - Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*msiexec.exe*", "*setup.exe*") AND CommandLine NOT IN (known_commands) \| stats count by host, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("msiexec.exe", "setup.exe") and ProcessCommandLine !in (knownCommands) \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*msiexec.exe*" OR "*setup.exe*") AND process.command_line NOT IN ['known_commands'] \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 5`. |

### T1584: Compromise Infrastructure

### T1584.001: Domains

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Malicious Domain Resolution | Adversaries use compromised domains for C2 communication, as in Volt Typhoon. | - DNS Logs (DS0001)<br>- Threat Intelligence | - **Splunk**: `index=dns sourcetype=zeek_dns query IN (malware_c2_domains) AND src_ip NOT IN (trusted_ips) \| stats count by src_ip, query \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and DnsQueryName in (malwareC2Domains) and DeviceIP !in (trustedIPs) \| summarize count() by DeviceIP, DnsQueryName \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE dns.query IN ['malware_c2_domains'] AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, dns.query HAVING COUNT() > 10`. |
| 2. High-Frequency Domain Queries | High-frequency DNS queries to suspicious domains, indicating C2, as in APT41. | - DNS Logs (DS0001)<br>- Metrics | - **Splunk**: `index=dns sourcetype=zeek_dns query IN (suspicious_domains) \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and DnsQueryName in (suspiciousDomains) \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE dns.query IN ['suspicious_domains'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 3. Domain Resolution from Compromised Endpoints | Compromised endpoints query malicious domains, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- DNS Logs (DS0001) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*powershell.exe*", "*cmd.exe*") \| join host [search index=dns sourcetype=zeek_dns query IN (malware_c2_domains)] \| stats count by host, CommandLine, query \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("powershell.exe", "cmd.exe") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "DNS" and DnsQueryName in (malwareC2Domains)) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, DnsQueryName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*powershell.exe*" OR "*cmd.exe*") \| JOIN logs-zeek.dns-* ON host.name WHERE dns.query IN ['malware_c2_domains'] \| STATS COUNT() BY host.name, process.command_line, dns.query HAVING COUNT() > 5`. |
| 4. Suspicious Domain Resolution with Non-Standard Ports | Adversaries use compromised domains over non-standard ports, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn)<br>- DNS Logs (DS0001) | - **Splunk**: `index=network sourcetype=zeek_conn dest_port NOT IN (80, 443) AND dest_ip IN (malware_c2_ips) \| join src_ip [search index=dns sourcetype=zeek_dns query IN (malware_c2_domains)] \| stats count by src_ip, query, dest_port \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where RemotePort !in (80, 443) and RemoteIP in (malwareC2IPs) \| join kind=inner (DeviceNetworkEvents \| where Protocol == "DNS" and DnsQueryName in (malwareC2Domains)) on DeviceIP \| summarize count() by DeviceIP, DnsQueryName, RemotePort \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE destination.port NOT IN [80, 443] AND destination.ip IN ['malware_c2_ips'] \| JOIN logs-zeek.dns-* ON source.ip WHERE dns.query IN ['malware_c2_domains'] \| STATS COUNT() BY source.ip, dns.query, destination.port HAVING COUNT() > 10`. |
| 5. Domain Resolution in Linux Environments | Adversaries use compromised domains in Linux environments, as in Turla. | - Process Creation (Linux Auditd)<br>- DNS Logs (DS0001) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*curl*", "*wget*") AND args IN (malware_c2_domains) \| stats count by host, exe, args \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("curl", "wget") and CommandLine has_any (malwareC2Domains) \| summarize count() by HostName, ProcessName, CommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*curl*" OR "*wget*") AND process.args : ['malware_c2_domains'] \| STATS COUNT() BY host.name, process.exe, process.args HAVING COUNT() > 5`. |
| 6. Domain Resolution with Suspicious User Agents | Adversaries use non-standard user agents to resolve malicious domains, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- DNS Logs (DS0001) | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) \| join src_ip [search index=dns sourcetype=zeek_dns query IN (malware_c2_domains)] \| stats count by src_ip, user_agent, query \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) \| join kind=inner (DeviceNetworkEvents \| where Protocol == "DNS" and DnsQueryName in (malwareC2Domains)) on DeviceIP \| summarize count() by DeviceIP, AdditionalFields.UserAgent, DnsQueryName \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] \| JOIN logs-zeek.dns-* ON source.ip WHERE dns.query IN ['malware_c2_domains'] \| STATS COUNT() BY source.ip, http.user_agent, dns.query HAVING COUNT() > 10`. |
| 7. Domain Resolution Outside Business Hours | Domain resolutions to malicious domains outside business hours, as in APT29. | - DNS Logs (DS0001)<br>- Metrics | - **Splunk**: `index=dns sourcetype=zeek_dns query IN (malware_c2_domains) \| timechart span=1h count by src_ip \| where count > avg(count)*3 AND (_time < "08:00" OR _time > "18:00")`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and DnsQueryName in (malwareC2Domains) \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceIP \| where HourlyCount > avg(HourlyCount) * 3 and (hour(Timestamp) < 8 or hour(Timestamp) > 18)`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE dns.query IN ['malware_c2_domains'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip \| WHERE COUNT() > AVG(COUNT()) * 3 AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18)`. |
| 8. Domain Resolution to Newly Registered Domains | Adversaries use newly registered domains for C2, as in 2025 trends. | - DNS Logs (DS0001)<br>- Threat Intelligence | - **Splunk**: `index=dns sourcetype=zeek_dns query IN (newly_registered_domains) AND src_ip NOT IN (trusted_ips) \| stats count by src_ip, query \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and DnsQueryName in (newlyRegisteredDomains) and DeviceIP !in (trustedIPs) \| summarize count() by DeviceIP, DnsQueryName \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE dns.query IN ['newly_registered_domains'] AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, dns.query HAVING COUNT() > 10`. |
| 9. Domain Resolution with Anomalous Query Patterns | Adversaries use unusual DNS query patterns for C2, as in APT41. | - DNS Logs (DS0001) | - **Splunk**: `index=dns sourcetype=zeek_dns query IN (malware_c2_domains) \| stats count by src_ip, query \| where count > avg(count)*3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and DnsQueryName in (malwareC2Domains) \| summarize count() by DeviceIP, DnsQueryName \| where count_ > avg(count_) * 3`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE dns.query IN ['malware_c2_domains'] \| STATS COUNT() BY source.ip, dns.query \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 10. Domain Resolution via Compromised Cloud Instances | Compromised cloud instances resolve malicious domains, as in 2025 trends. | - Cloud Audit Logs (AWS CloudTrail)<br>- DNS Logs (DS0001) | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("StartInstances", "RunInstances") AND src_ip IN (compromised_instances) \| join src_ip [search index=dns sourcetype=zeek_dns query IN (malware_c2_domains)] \| stats count by src_ip, eventName, query \| where count > 5`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("StartInstances", "RunInstances") and SourceIP in (compromisedInstances) \| join kind=inner (DeviceNetworkEvents \| where Protocol == "DNS" and DnsQueryName in (malwareC2Domains)) on SourceIP \| summarize count() by SourceIP, EventName, DnsQueryName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['StartInstances', 'RunInstances'] AND source.ip IN ['compromised_instances'] \| JOIN logs-zeek.dns-* ON source.ip WHERE dns.query IN ['malware_c2_domains'] \| STATS COUNT() BY source.ip, event.action, dns.query HAVING COUNT() > 5`. |

### T1584.002: Server

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Compromised Server Used for Malware Hosting | Adversaries use compromised servers to host malware, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- File Creation (DS0013) | - **Splunk**: `index=network sourcetype=zeek_http dest_ip IN (compromised_servers) AND uri IN ("*.exe", "*.zip", "*.scr") \| stats count by src_ip, dest_ip, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (compromisedServers) and RemoteUrl has_any (".exe", ".zip", ".scr") \| summarize count() by DeviceIP, RemoteIP, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE destination.ip IN ['compromised_servers'] AND http.uri : ("*.exe" OR "*.zip" OR "*.scr") \| STATS COUNT() BY source.ip, destination.ip, http.uri HAVING COUNT() > 10`. |
| 2. Compromised Server Used for C2 Communication | Adversaries use compromised servers for C2 communication, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http dest_ip IN (malware_c2_ips) AND response_status_code IN ("200", "404") \| stats count by src_ip, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (malwareC2IPs) and ResponseStatusCode in ("200", "404") \| summarize count() by DeviceIP, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE destination.ip IN ['malware_c2_ips'] AND http.response.status_code IN ['200', '404'] \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 10`. |
| 3. Compromised Server with Suspicious File Uploads | Adversaries upload malicious files to compromised servers, as in FIN7. | - Network Traffic (DS0003: Zeek HTTP)<br>- File Creation (DS0013) | - **Splunk**: `index=network sourcetype=zeek_http method=POST AND uri IN ("*.php", "*.asp", "*.jsp") AND dest_ip IN (compromised_servers) \| stats count by src_ip, dest_ip, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and HttpMethod == "POST" and RemoteUrl has_any (".php", ".asp", ".jsp") and RemoteIP in (compromisedServers) \| summarize count() by DeviceIP, RemoteIP, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.method == "POST" AND http.uri : ("*.php" OR "*.asp" OR "*.jsp") AND destination.ip IN ['compromised_servers'] \| STATS COUNT() BY source.ip, destination.ip, http.uri HAVING COUNT() > 10`. |
| 4. Compromised Server with Suspicious User Agents | Adversaries use non-standard user agents to communicate with compromised servers, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND dest_ip IN (compromised_servers) \| stats count by src_ip, user_agent, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and RemoteIP in (compromisedServers) \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND destination.ip IN ['compromised_servers'] \| STATS COUNT() BY source.ip, http.user_agent, destination.ip HAVING COUNT() > 10`. |
| 5. Compromised Server in Linux Environments | Adversaries use compromised Linux servers for malicious activities, as in Turla. | - Process Creation (Linux Auditd)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*httpd*", "*nginx*") AND args IN ("*.php", "*.sh") \| stats count by host, exe, args \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("httpd", "nginx") and CommandLine has_any (".php", ".sh") \| summarize count() by HostName, ProcessName, CommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*httpd*" OR "*nginx*") AND process.args : ("*.php" OR "*.sh") \| STATS COUNT() BY host.name, process.exe, process.args HAVING COUNT() > 5`. |
| 6. High-Frequency Connections to Compromised Servers | High-frequency connections to compromised servers, indicating C2, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http dest_ip IN (compromised_servers) \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (compromisedServers) \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE destination.ip IN ['compromised_servers'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 7. Compromised Server with Anomalous Ports | Adversaries use non-standard ports on compromised servers, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn)<br>- Firewall Logs | - **Splunk**: `index=network sourcetype=zeek_conn dest_port NOT IN (80, 443) AND dest_ip IN (compromised_servers) \| stats count by src_ip, dest_ip, dest_port \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where RemotePort !in (80, 443) and RemoteIP in (compromisedServers) \| summarize count() by DeviceIP, RemoteIP, RemotePort \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE destination.port NOT IN [80, 443] AND destination.ip IN ['compromised_servers'] \| STATS COUNT() BY source.ip, destination.ip, destination.port HAVING COUNT() > 10`. |
| 8. Compromised Server with Suspicious File Downloads | Adversaries download malicious files from compromised servers, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http dest_ip IN (compromised_servers) AND uri IN ("*.exe", "*.zip", "*.scr") \| stats count by src_ip, dest_ip, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (compromisedServers) and RemoteUrl has_any (".exe", ".zip", ".scr") \| summarize count() by DeviceIP, RemoteIP, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE destination.ip IN ['compromised_servers'] AND http.uri : ("*.exe" OR "*.zip" OR "*.scr") \| STATS COUNT() BY source.ip, destination.ip, http.uri HAVING COUNT() > 10`. |
| 9. Compromised Server in Cloud Environments | Adversaries use compromised cloud servers for malicious activities, as in 2025 trends. | - Cloud Audit Logs (AWS CloudTrail)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("StartInstances", "RunInstances") AND src_ip IN (compromised_instances) \| join src_ip [search index=network sourcetype=zeek_http dest_ip IN (compromised_servers)] \| stats count by src_ip, eventName, dest_ip \| where count > 5`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("StartInstances", "RunInstances") and SourceIP in (compromisedInstances) \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (compromisedServers)) on SourceIP \| summarize count() by SourceIP, EventName, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['StartInstances', 'RunInstances'] AND source.ip IN ['compromised_instances'] \| JOIN logs-zeek.http-* ON source.ip WHERE destination.ip IN ['compromised_servers'] \| STATS COUNT() BY source.ip, event.action, destination.ip HAVING COUNT() > 5`. |
| 10. Compromised Server with Suspicious Admin Activity | Adversaries perform admin activities on compromised servers, as in APT29. | - Cloud Audit Logs (AWS CloudTrail)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("CreateUser", "ModifyInstanceAttribute") AND userIdentity NOT IN (authorized_users) \| stats count by src_ip, eventName \| where count > 5`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("CreateUser", "ModifyInstanceAttribute") and Caller !in (authorizedUsers) \| summarize count() by SourceIP, EventName \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['CreateUser', 'ModifyInstanceAttribute'] AND user.identity NOT IN ['authorized_users'] \| STATS COUNT() BY source.ip, event.action HAVING COUNT() > 5`. |

### T1584.003: DNS Server

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Compromised DNS Server for C2 Resolution | Adversaries use compromised DNS servers for C2 resolution, as in Volt Typhoon. | - DNS Logs (DS0001)<br>- Threat Intelligence | - **Splunk**: `index=dns sourcetype=zeek_dns answer IN (malware_c2_ips) AND src_ip NOT IN (trusted_ips) \| stats count by src_ip, answer \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and DnsAnswer in (malwareC2IPs) and DeviceIP !in (trustedIPs) \| summarize count() by DeviceIP, DnsAnswer \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE dns.answer IN ['malware_c2_ips'] AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, dns.answer HAVING COUNT() > 10`. |
| 2. High-Frequency Queries to Compromised DNS Servers | High-frequency queries to compromised DNS servers, as in APT41. | - DNS Logs (DS0001)<br>- Metrics | - **Splunk**: `index=dns sourcetype=zeek_dns dest_ip IN (compromised_dns_servers) \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and RemoteIP in (compromisedDNSServers) \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE destination.ip IN ['compromised_dns_servers'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 3. Compromised DNS Server Queries from Endpoints | Compromised endpoints query compromised DNS servers, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- DNS Logs (DS0001) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*nslookup*", "*dig*") \| join host [search index=dns sourcetype=zeek_dns dest_ip IN (compromised_dns_servers)] \| stats count by host, CommandLine, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("nslookup", "dig") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "DNS" and RemoteIP in (compromisedDNSServers)) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*nslookup*" OR "*dig*") \| JOIN logs-zeek.dns-* ON host.name WHERE destination.ip IN ['compromised_dns_servers'] \| STATS COUNT() BY host.name, process.command_line, destination.ip HAVING COUNT() > 5`. |
| 4. Compromised DNS Server with Anomalous Ports | Adversaries use non-standard ports on compromised DNS servers, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn)<br>- DNS Logs (DS0001) | - **Splunk**: `index=network sourcetype=zeek_conn dest_port NOT IN (53) AND dest_ip IN (compromised_dns_servers) \| stats count by src_ip, dest_ip, dest_port \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where RemotePort !in (53) and RemoteIP in (compromisedDNSServers) \| summarize count() by DeviceIP, RemoteIP, RemotePort \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE destination.port NOT IN [53] AND destination.ip IN ['compromised_dns_servers'] \| STATS COUNT() BY source.ip, destination.ip, destination.port HAVING COUNT() > 10`. |
| 5. Compromised DNS Server in Linux Environments | Adversaries use compromised DNS servers in Linux environments, as in Turla. | - Process Creation (Linux Auditd)<br>- DNS Logs (DS0001) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*dig*", "*nslookup*") AND args IN (compromised_dns_servers) \| stats count by host, exe, args \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("dig", "nslookup") and CommandLine has_any (compromisedDNSServers) \| summarize count() by HostName, ProcessName, CommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*dig*" OR "*nslookup*") AND process.args : ['compromised_dns_servers'] \| STATS COUNT() BY host.name, process.exe, process.args HAVING COUNT() > 5`. |
| 6. Compromised DNS Server with Suspicious Query Patterns | Adversaries use unusual query patterns to compromised DNS servers, as in APT41. | - DNS Logs (DS0001) | - **Splunk**: `index=dns sourcetype=zeek_dns dest_ip IN (compromised_dns_servers) \| stats count by src_ip, query \| where count > avg(count)*3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and RemoteIP in (compromisedDNSServers) \| summarize count() by DeviceIP, DnsQueryName \| where count_ > avg(count_) * 3`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE destination.ip IN ['compromised_dns_servers'] \| STATS COUNT() BY source.ip, dns.query \| WHERE COUNT() > AVG(COUNT()) * 3`. |
| 7. Compromised DNS Server Queries Outside Business Hours | Queries to compromised DNS servers outside business hours, as in APT29. | - DNS Logs (DS0001)<br>- Metrics | - **Splunk**: `index=dns sourcetype=zeek_dns dest_ip IN (compromised_dns_servers) \| timechart span=1h count by src_ip \| where count > avg(count)*3 AND (_time < "08:00" OR _time > "18:00")`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and RemoteIP in (compromisedDNSServers) \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceIP \| where HourlyCount > avg(HourlyCount) * 3 and (hour(Timestamp) < 8 or hour(Timestamp) > 18)`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE destination.ip IN ['compromised_dns_servers'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip \| WHERE COUNT() > AVG(COUNT()) * 3 AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18)`. |
| 8. Compromised DNS Server with Suspicious Answers | DNS servers return suspicious IPs in responses, as in Volt Typhoon. | - DNS Logs (DS0001)<br>- Threat Intelligence | - **Splunk**: `index=dns sourcetype=zeek_dns answer IN (malware_c2_ips) AND dest_ip IN (compromised_dns_servers) \| stats count by src_ip, answer, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and DnsAnswer in (malwareC2IPs) and RemoteIP in (compromisedDNSServers) \| summarize count() by DeviceIP, DnsAnswer, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE dns.answer IN ['malware_c2_ips'] AND destination.ip IN ['compromised_dns_servers'] \| STATS COUNT() BY source.ip, dns.answer, destination.ip HAVING COUNT() > 10`. |
| 9. Compromised DNS Server in Cloud Environments | Adversaries use compromised cloud-based DNS servers, as in 2025 trends. | - Cloud Audit Logs (AWS CloudTrail)<br>- DNS Logs (DS0001) | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("UpdateResolverEndpoint", "CreateResolverRule") AND src_ip IN (compromised_instances) \| join src_ip [search index=dns sourcetype=zeek_dns dest_ip IN (compromised_dns_servers)] \| stats count by src_ip, eventName, dest_ip \| where count > 5`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("UpdateResolverEndpoint", "CreateResolverRule") and SourceIP in (compromisedInstances) \| join kind=inner (DeviceNetworkEvents \| where Protocol == "DNS" and RemoteIP in (compromisedDNSServers)) on SourceIP \| summarize count() by SourceIP, EventName, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['UpdateResolverEndpoint', 'CreateResolverRule'] AND source.ip IN ['compromised_instances'] \| JOIN logs-zeek.dns-* ON source.ip WHERE destination.ip IN ['compromised_dns_servers'] \| STATS COUNT() BY source.ip, event.action, destination.ip HAVING COUNT() > 5`. |
| 10. Compromised DNS Server with Suspicious User Agents | Adversaries use non-standard user agents to query compromised DNS servers, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- DNS Logs (DS0001) | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) \| join src_ip [search index=dns sourcetype=zeek_dns dest_ip IN (compromised_dns_servers)] \| stats count by src_ip, user_agent, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) \| join kind=inner (DeviceNetworkEvents \| where Protocol == "DNS" and RemoteIP in (compromisedDNSServers)) on DeviceIP \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] \| JOIN logs-zeek.dns-* ON source.ip WHERE destination.ip IN ['compromised_dns_servers'] \| STATS COUNT() BY source.ip, http.user_agent, destination.ip HAVING COUNT() > 10`. |

### T1584.004: Email Accounts

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Compromised Email Accounts for Phishing | Adversaries use compromised email accounts to send phishing emails, as in Volt Typhoon. | - Email Logs (DS0004) | - **Splunk**: `index=email sourcetype=zeek_smtp sender IN (compromised_emails) AND attachment IN ("*.exe", "*.zip", "*.scr") \| stats count by sender, recipient, attachment \| where count > 5`.<br>- **KQL**: `EmailEvents \| where SenderEmailAddress in (compromisedEmails) and AttachmentName has_any (".exe", ".zip", ".scr") \| summarize count() by SenderEmailAddress, RecipientEmailAddress, AttachmentName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.smtp-* \| WHERE email.sender IN ['compromised_emails'] AND email.attachment : ("*.exe" OR "*.zip" OR "*.scr") \| STATS COUNT() BY email.sender, email.recipient, email.attachment HAVING COUNT() > 5`. |
| 2. Compromised Email Accounts for C2 Communication | Adversaries use compromised email accounts for C2 communication, as in APT41. | - Email Logs (DS0004)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=email sourcetype=zeek_smtp sender IN (compromised_emails) \| join src_ip [search index=network sourcetype=zeek_http dest_ip IN (malware_c2_ips)] \| stats count by src_ip, sender, dest_ip \| where count > 10`.<br>- **KQL**: `EmailEvents \| where SenderEmailAddress in (compromisedEmails) \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (malwareC2IPs)) on SenderIP \| summarize count() by SenderIP, SenderEmailAddress, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.smtp-* \| WHERE email.sender IN ['compromised_emails'] \| JOIN logs-zeek.http-* ON source.ip WHERE destination.ip IN ['malware_c2_ips'] \| STATS COUNT() BY source.ip, email.sender, destination.ip HAVING COUNT() > 10`. |
| 3. High-Frequency Email Activity from Compromised Accounts | High-frequency email activity from compromised accounts, as in APT41. | - Email Logs (DS0004)<br>- Metrics | - **Splunk**: `index=email sourcetype=zeek_smtp sender IN (compromised_emails) \| timechart span=1m count by sender \| where count > 50`.<br>- **KQL**: `EmailEvents \| where SenderEmailAddress in (compromisedEmails) \| summarize MinuteCount=count() by bin(Timestamp, 1m), SenderEmailAddress \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.smtp-* \| WHERE email.sender IN ['compromised_emails'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), email.sender \| WHERE COUNT() > 50`. |
| 4. Compromised Email Accounts with Suspicious Attachments | Adversaries send suspicious attachments from compromised email accounts, as in FIN7. | - Email Logs (DS0004) | - **Splunk**: `index=email sourcetype=zeek_smtp sender IN (compromised_emails) AND attachment IN ("*.docx", "*.pdf", "*.js") \| stats count by sender, recipient, attachment \| where count > 5`.<br>- **KQL**: `EmailEvents \| where SenderEmailAddress in (compromisedEmails) and AttachmentName has_any (".docx", ".pdf", ".js") \| summarize count() by SenderEmailAddress, RecipientEmailAddress, AttachmentName \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.smtp-* \| WHERE email.sender IN ['compromised_emails'] AND email.attachment : ("*.docx" OR "*.pdf" OR "*.js") \| STATS COUNT() BY email.sender, email.recipient, email.attachment HAVING COUNT() > 5`. |
| 5. Compromised Email Accounts with Suspicious Links | Adversaries send malicious links from compromised email accounts, as in Volt Typhoon. | - Email Logs (DS0004) | - **Splunk**: `index=email sourcetype=zeek_smtp sender IN (compromised_emails) AND uri IN ("*bit.ly*", "*tinyurl.com*", "*t.co*") \| stats count by sender, recipient, uri \| where count > 5`.<br>- **KQL**: `EmailEvents \| where SenderEmailAddress in (compromisedEmails) and Url has_any ("bit.ly", "tinyurl.com", "t.co") \| summarize count() by SenderEmailAddress, RecipientEmailAddress, Url \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.smtp-* \| WHERE email.sender IN ['compromised_emails'] AND email.uri : ("*bit.ly*" OR "*tinyurl.com*" OR "*t.co*") \| STATS COUNT() BY email.sender, email.recipient, email.uri HAVING COUNT() > 5`. |
| 6. Compromised Email Accounts in Cloud Environments | Adversaries use compromised cloud email accounts, as in 2025 trends. | - Cloud Audit Logs (O365 Audit Logs) | - **Splunk**: `index=cloud sourcetype=o365:audit Operation IN ("Send", "Forward") AND UserId IN (compromised_emails) \| stats count by src_ip, UserId, Operation \| where count > 5`.<br>- **KQL**: `OfficeActivity \| where Operation in ("Send", "Forward") and UserId in (compromisedEmails) \| summarize count() by ClientIP, UserId, Operation \| where count_ > 5`.<br>- **ELK**: `FROM logs-o365.audit-* \| WHERE event.action IN ['Send', 'Forward'] AND user.id IN ['compromised_emails'] \| STATS COUNT() BY source.ip, user.id, event.action HAVING COUNT() > 5`. |
| 7. Compromised Email Accounts with Suspicious User Agents | Adversaries use non-standard user agents with compromised email accounts, as in APT41. | - Email Logs (DS0004)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=email sourcetype=zeek_smtp sender IN (compromised_emails) \| join src_ip [search index=network sourcetype=zeek_http user_agent NOT IN (known_agents)] \| stats count by src_ip, sender, user_agent \| where count > 10`.<br>- **KQL**: `EmailEvents \| where SenderEmailAddress in (compromisedEmails) \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents)) on SenderIP \| summarize count() by SenderIP, SenderEmailAddress, AdditionalFields.UserAgent \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.smtp-* \| WHERE email.sender IN ['compromised_emails'] \| JOIN logs-zeek.http-* ON source.ip WHERE http.user_agent NOT IN ['known_agents'] \| STATS COUNT() BY source.ip, email.sender, http.user_agent HAVING COUNT() > 10`. |
| 8. Compromised Email Accounts Outside Business Hours | Email activity from compromised accounts outside business hours, as in APT29. | - Email Logs (DS0004)<br>- Metrics | - **Splunk**: `index=email sourcetype=zeek_smtp sender IN (compromised_emails) \| timechart span=1h count by sender \| where count > avg(count)*3 AND (_time < "08:00" OR _time > "18:00")`.<br>- **KQL**: `EmailEvents \| where SenderEmailAddress in (compromisedEmails) \| summarize HourlyCount=count() by bin(Timestamp, 1h), SenderEmailAddress \| where HourlyCount > avg(HourlyCount) * 3 and (hour(Timestamp) < 8 or hour(Timestamp) > 18)`.<br>- **ELK**: `FROM logs-zeek.smtp-* \| WHERE email.sender IN ['compromised_emails'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), email.sender \| WHERE COUNT() > AVG(COUNT()) * 3 AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18)`. |
| 9. Compromised Email Accounts with Suspicious Recipients | Adversaries send emails to suspicious recipients from compromised accounts, as in 2025 trends. | - Email Logs (DS0004) | - **Splunk**: `index=email sourcetype=zeek_smtp sender IN (compromised_emails) AND recipient IN (suspicious_recipients) \| stats count by sender, recipient \| where count > 5`.<br>- **KQL**: `EmailEvents \| where SenderEmailAddress in (compromisedEmails) and RecipientEmailAddress in (suspiciousRecipients) \| summarize count() by SenderEmailAddress, RecipientEmailAddress \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.smtp-* \| WHERE email.sender IN ['compromised_emails'] AND email.recipient IN ['suspicious_recipients'] \| STATS COUNT() BY email.sender, email.recipient HAVING COUNT() > 5`. |
| 10. Compromised Email Accounts with Anomalous Login Patterns | Adversaries use compromised email accounts with unusual login patterns, as in APT41. | - Cloud Audit Logs (O365 Audit Logs) | - **Splunk**: `index=cloud sourcetype=o365:audit Operation IN ("UserLoggedIn", "UserLoginFailed") AND UserId IN (compromised_emails) AND src_ip NOT IN (trusted_ips) \| stats count by src_ip, UserId, Operation \| where count > 10`.<br>- **KQL**: `OfficeActivity \| where Operation in ("UserLoggedIn", "UserLoginFailed") and UserId in (compromisedEmails) and ClientIP !in (trustedIPs) \| summarize count() by ClientIP, UserId, Operation \| where count_ > 10`.<br>- **ELK**: `FROM logs-o365.audit-* \| WHERE event.action IN ['UserLoggedIn', 'UserLoginFailed'] AND user.id IN ['compromised_emails'] AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, user.id, event.action HAVING COUNT() > 10`. |

### T1584.005: Botnet

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Botnet C2 Communication | Adversaries use botnets for C2 communication, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http dest_ip IN (botnet_c2_ips) AND response_status_code IN ("200", "404") \| stats count by src_ip, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (botnetC2IPs) and ResponseStatusCode in ("200", "404") \| summarize count() by DeviceIP, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE destination.ip IN ['botnet_c2_ips'] AND http.response.status_code IN ['200', '404'] \| STATS COUNT() BY source.ip, destination.ip HAVING COUNT() > 10`. |
| 2. High-Frequency Botnet Connections | High-frequency connections to botnet C2 servers, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http dest_ip IN (botnet_c2_ips) \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (botnetC2IPs) \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE destination.ip IN ['botnet_c2_ips'] \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 3. Botnet Activity from Compromised Endpoints | Compromised endpoints participate in botnet activities, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*powershell.exe*", "*cmd.exe*") \| join host [search index=network sourcetype=zeek_http dest_ip IN (botnet_c2_ips)] \| stats count by host, CommandLine, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("powershell.exe", "cmd.exe") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (botnetC2IPs)) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*powershell.exe*" OR "*cmd.exe*") \| JOIN logs-zeek.http-* ON host.name WHERE destination.ip IN ['botnet_c2_ips'] \| STATS COUNT() BY host.name, process.command_line, destination.ip HAVING COUNT() > 5`. |
| 4. Botnet Activity with Suspicious User Agents | Adversaries use non-standard user agents in botnet communications, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND dest_ip IN (botnet_c2_ips) \| stats count by src_ip, user_agent, dest_ip \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and RemoteIP in (botnetC2IPs) \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteIP \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND destination.ip IN ['botnet_c2_ips'] \| STATS COUNT() BY source.ip, http.user_agent, destination.ip HAVING COUNT() > 10`. |
| 5. Botnet Activity in Linux Environments | Adversaries use Linux systems in botnets, as in Turla. | - Process Creation (Linux Auditd)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*curl*", "*wget*") AND args IN (botnet_c2_ips) \| stats count by host, exe, args \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("curl", "wget") and CommandLine has_any (botnetC2IPs) \| summarize count() by HostName, ProcessName, CommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*curl*" OR "*wget*") AND process.args : ['botnet_c2_ips'] \| STATS COUNT() BY host.name, process.exe, process.args HAVING COUNT() > 5`. |
| 6. Botnet Activity with Anomalous Ports | Adversaries use non-standard ports for botnet C2, as in 2025 trends. | - Network Traffic (DS0003: Zeek Conn)<br>- Firewall Logs | - **Splunk**: `index=network sourcetype=zeek_conn dest_port NOT IN (80, 443) AND dest_ip IN (botnet_c2_ips) \| stats count by src_ip, dest_ip, dest_port \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where RemotePort !in (80, 443) and RemoteIP in (botnetC2IPs) \| summarize count() by DeviceIP, RemoteIP, RemotePort \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.conn-* \| WHERE destination.port NOT IN [80, 443] AND destination.ip IN ['botnet_c2_ips'] \| STATS COUNT() BY source.ip, destination.ip, destination.port HAVING COUNT() > 10`. |
| 7. Botnet Activity Outside Business Hours | Botnet communications occurring outside business hours, as in APT29. | - Network Traffic (DS0003: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http dest_ip IN (botnet_c2_ips) \| timechart span=1h count by src_ip \| where count > avg(count)*3 AND (_time < "08:00" OR _time > "18:00")`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (botnetC2IPs) \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceIP \| where HourlyCount > avg(HourlyCount) * 3 and (hour(Timestamp) < 8 or hour(Timestamp) > 18)`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE destination.ip IN ['botnet_c2_ips'] \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip \| WHERE COUNT() > AVG(COUNT()) * 3 AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18)`. |
| 8. Botnet Activity with Suspicious DNS Queries | Adversaries use botnets to query suspicious domains, as in Volt Typhoon. | - DNS Logs (DS0001)<br>- Threat Intelligence | - **Splunk**: `index=dns sourcetype=zeek_dns query IN (botnet_c2_domains) AND src_ip IN (botnet_c2_ips) \| stats count by src_ip, query \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DNS" and DnsQueryName in (botnetC2Domains) and DeviceIP in (botnetC2IPs) \| summarize count() by DeviceIP, DnsQueryName \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.dns-* \| WHERE dns.query IN ['botnet_c2_domains'] AND source.ip IN ['botnet_c2_ips'] \| STATS COUNT() BY source.ip, dns.query HAVING COUNT() > 10`. |
| 9. Botnet Activity in Cloud Environments | Adversaries use compromised cloud instances in botnets, as in 2025 trends. | - Cloud Audit Logs (AWS CloudTrail)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("StartInstances", "RunInstances") AND src_ip IN (compromised_instances) \| join src_ip [search index=network sourcetype=zeek_http dest_ip IN (botnet_c2_ips)] \| stats count by src_ip, eventName, dest_ip \| where count > 5`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("StartInstances", "RunInstances") and SourceIP in (compromisedInstances) \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (botnetC2IPs)) on SourceIP \| summarize count() by SourceIP, EventName, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['StartInstances', 'RunInstances'] AND source.ip IN ['compromised_instances'] \| JOIN logs-zeek.http-* ON source.ip WHERE destination.ip IN ['botnet_c2_ips'] \| STATS COUNT() BY source.ip, event.action, destination.ip HAVING COUNT() > 5`. |
| 10. Botnet Activity with Suspicious File Downloads | Adversaries use botnets to download malicious files, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http dest_ip IN (botnet_c2_ips) AND uri IN ("*.exe", "*.zip", "*.scr") \| stats count by src_ip, dest_ip, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (botnetC2IPs) and RemoteUrl has_any (".exe", ".zip", ".scr") \| summarize count() by DeviceIP, RemoteIP, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE destination.ip IN ['botnet_c2_ips'] AND http.uri : ("*.exe" OR "*.zip" OR "*.scr") \| STATS COUNT() BY source.ip, destination.ip, http.uri HAVING COUNT() > 10`. |

### T1599: Search Open Websites/Domains

### T1599.001: Content Injection

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Content Injection via Compromised Web Servers | Adversaries inject malicious content into compromised web servers, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- File Creation (DS0013) | - **Splunk**: `index=network sourcetype=zeek_http method=POST AND uri IN ("*.php", "*.asp", "*.jsp") AND dest_ip IN (compromised_servers) AND content IN ("*script*", "*iframe*") \| stats count by src_ip, dest_ip, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and HttpMethod == "POST" and RemoteUrl has_any (".php", ".asp", ".jsp") and RemoteIP in (compromisedServers) and HttpContent has_any ("script", "iframe") \| summarize count() by DeviceIP, RemoteIP, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.method == "POST" AND http.uri : ("*.php" OR "*.asp" OR "*.jsp") AND destination.ip IN ['compromised_servers'] AND http.content : ("*script*" OR "*iframe*") \| STATS COUNT() BY source.ip, destination.ip, http.uri HAVING COUNT() > 10`. |
| 2. Content Injection via Phishing Emails | Adversaries inject malicious content in phishing emails, as in APT41. | - Email Logs (DS0004) | - **Splunk**: `index=email sourcetype=zeek_smtp content IN ("*script*", "*iframe*") AND src_ip NOT IN (trusted_ips) \| stats count by src_ip, recipient, content \| where count > 5`.<br>- **KQL**: `EmailEvents \| where EmailContent has_any ("script", "iframe") and SenderIP !in (trustedIPs) \| summarize count() by SenderIP, RecipientEmailAddress, EmailContent \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.smtp-* \| WHERE email.content : ("*script*" OR "*iframe*") AND source.ip NOT IN ['trusted_ips'] \| STATS COUNT() BY source.ip, email.recipient, email.content HAVING COUNT() > 5`. |
| 3. Content Injection via Compromised Cloud Instances | Adversaries inject content into compromised cloud-hosted websites, as in 2025 trends. | - Cloud Audit Logs (AWS CloudTrail)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("PutObject", "UploadPart") AND requestParameters IN ("*.html", "*.js") AND src_ip IN (compromised_instances) \| join src_ip [search index=network sourcetype=zeek_http content IN ("*script*", "*iframe*")] \| stats count by src_ip, eventName, content \| where count > 5`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("PutObject", "UploadPart") and RequestParameters has_any (".html", ".js") and SourceIP in (compromisedInstances) \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and HttpContent has_any ("script", "iframe")) on SourceIP \| summarize count() by SourceIP, EventName, HttpContent \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['PutObject', 'UploadPart'] AND event.request_parameters : ("*.html" OR "*.js") AND source.ip IN ['compromised_instances'] \| JOIN logs-zeek.http-* ON source.ip WHERE http.content : ("*script*" OR "*iframe*") \| STATS COUNT() BY source.ip, event.action, http.content HAVING COUNT() > 5`. |
| 4. Content Injection with Suspicious User Agents | Adversaries use non-standard user agents to inject content, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND method=POST AND content IN ("*script*", "*iframe*") \| stats count by src_ip, user_agent, content \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and HttpMethod == "POST" and HttpContent has_any ("script", "iframe") \| summarize count() by DeviceIP, AdditionalFields.UserAgent, HttpContent \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND http.method == "POST" AND http.content : ("*script*" OR "*iframe*") \| STATS COUNT() BY source.ip, http.user_agent, http.content HAVING COUNT() > 10`. |
| 5. Content Injection in Linux Environments | Adversaries inject malicious content into Linux web servers, as in Turla. | - Process Creation (Linux Auditd)<br>- File Creation (Linux Auditd) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*httpd*", "*nginx*") AND args IN ("*.php", "*.html") AND content IN ("*script*", "*iframe*") \| stats count by host, exe, args \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("httpd", "nginx") and CommandLine has_any (".php", ".html") and FileContent has_any ("script", "iframe") \| summarize count() by HostName, ProcessName, CommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*httpd*" OR "*nginx*") AND process.args : ("*.php" OR "*.html") AND file.content : ("*script*" OR "*iframe*") \| STATS COUNT() BY host.name, process.exe, process.args HAVING COUNT() > 5`. |
| 6. High-Frequency Content Injection | High-frequency injection of malicious content, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http method=POST AND content IN ("*script*", "*iframe*") \| timechart span=1m count by src_ip \| where count > 50`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and HttpMethod == "POST" and HttpContent has_any ("script", "iframe") \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceIP \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.method == "POST" AND http.content : ("*script*" OR "*iframe*") \| STATS COUNT() BY date_histogram(@timestamp, '1m'), source.ip \| WHERE COUNT() > 50`. |
| 7. Content Injection via Known Malicious IPs | Adversaries inject content from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http src_ip IN (threat_intel_ips) AND method=POST AND content IN ("*script*", "*iframe*") \| stats count by src_ip, content \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and DeviceIP in (threatIntelIPs) and HttpMethod == "POST" and HttpContent has_any ("script", "iframe") \| summarize count() by DeviceIP, HttpContent \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE source.ip IN ['threat_intel_ips'] AND http.method == "POST" AND http.content : ("*script*" OR "*iframe*") \| STATS COUNT() BY source.ip, http.content HAVING COUNT() > 10`. |
| 8. Content Injection Outside Business Hours | Content injection occurring outside business hours, as in APT29. | - Network Traffic (DS0003: Zeek HTTP)<br>- Metrics | - **Splunk**: `index=network sourcetype=zeek_http method=POST AND content IN ("*script*", "*iframe*") \| timechart span=1h count by src_ip \| where count > avg(count)*3 AND (_time < "08:00" OR _time > "18:00")`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and HttpMethod == "POST" and HttpContent has_any ("script", "iframe") \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceIP \| where HourlyCount > avg(HourlyCount) * 3 and (hour(Timestamp) < 8 or hour(Timestamp) > 18)`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.method == "POST" AND http.content : ("*script*" OR "*iframe*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), source.ip \| WHERE COUNT() > AVG(COUNT()) * 3 AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18)`. |
| 9. Content Injection via Browser Exploits | Adversaries use browser exploits for content injection, as in Cobalt Strike. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine IN ("*chrome.exe*", "*firefox.exe*") \| join host [search index=network sourcetype=zeek_http content IN ("*script*", "*iframe*")] \| stats count by host, CommandLine, content \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine has_any ("chrome.exe", "firefox.exe") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and HttpContent has_any ("script", "iframe")) on DeviceName \| summarize count() by DeviceName, ProcessCommandLine, HttpContent \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.command_line : ("*chrome.exe*" OR "*firefox.exe*") \| JOIN logs-zeek.http-* ON host.name WHERE http.content : ("*script*" OR "*iframe*") \| STATS COUNT() BY host.name, process.command_line, http.content HAVING COUNT() > 5`. |
| 10. Content Injection with Suspicious Redirects | Adversaries inject content that redirects to malicious domains, as in 2025 trends. | - Network Traffic (DS0003: Zeek HTTP)<br>- DNS Logs (DS0001) | - **Splunk**: `index=network sourcetype=zeek_http content IN ("*script*", "*iframe*") AND referer IN (malware_c2_domains) \| stats count by src_ip, content, referer \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and HttpContent has_any ("script", "iframe") and Referer in (malwareC2Domains) \| summarize count() by DeviceIP, HttpContent, Referer \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.content : ("*script*" OR "*iframe*") AND http.referer IN ['malware_c2_domains'] \| STATS COUNT() BY source.ip, http.content, http.referer HAVING COUNT() > 10`. |

### T1610: Exploit Public-Facing Application
### T1610.001: Server Software

| Hypothesis | Description | Data Sources | Hunting Queries |
|-----------|-------------|--------------|-----------------|
| 1. Malicious Server Software Deployment | Adversaries deploy malicious server software on compromised servers, as in Volt Typhoon. | - Process Creation (DS0009: Sysmon ID 1)<br>- File Creation (DS0013: Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*httpd.exe*", "*nginx.exe*") AND CommandLine NOT IN (known_software) \| stats count by host, Image, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("httpd.exe", "nginx.exe") and ProcessCommandLine !in (knownSoftware) \| summarize count() by DeviceName, ProcessName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*httpd.exe*" OR "*nginx.exe*") AND process.command_line NOT IN ['known_software'] \| STATS COUNT() BY host.name, process.executable, process.command_line HAVING COUNT() > 5`. |
| 2. Server Software Deployment from Malicious IPs | Adversaries deploy server software from malicious IPs, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http src_ip IN (threat_intel_ips) AND uri IN ("*.exe", "*.msi") AND content IN ("*httpd*", "*nginx*") \| stats count by src_ip, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and DeviceIP in (threatIntelIPs) and RemoteUrl has_any (".exe", ".msi") and HttpContent has_any ("httpd", "nginx") \| summarize count() by DeviceIP, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE source.ip IN ['threat_intel_ips'] AND http.uri : ("*.exe" OR "*.msi") AND http.content : ("*httpd*" OR "*nginx*") \| STATS COUNT() BY source.ip, http.uri HAVING COUNT() > 10`. |
| 3. Server Software Deployment with Suspicious User Agents | Adversaries use non-standard user agents to deploy server software, as in APT41. | - Network Traffic (DS0003: Zeek HTTP)<br>- Proxy Logs | - **Splunk**: `index=network sourcetype=zeek_http user_agent NOT IN (known_agents) AND uri IN ("*.exe", "*.msi") AND content IN ("*httpd*", "*nginx*") \| stats count by src_ip, user_agent, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.UserAgent !in (knownAgents) and RemoteUrl has_any (".exe", ".msi") and HttpContent has_any ("httpd", "nginx") \| summarize count() by DeviceIP, AdditionalFields.UserAgent, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.user_agent NOT IN ['known_agents'] AND http.uri : ("*.exe" OR "*.msi") AND http.content : ("*httpd*" OR "*nginx*") \| STATS COUNT() BY source.ip, http.user_agent, http.uri HAVING COUNT() > 10`. |
| 4. Server Software Deployment in Linux Environments | Adversaries deploy malicious server software on Linux systems, as in Turla. | - Process Creation (Linux Auditd)<br>- File Creation (Linux Auditd) | - **Splunk**: `index=linux sourcetype=auditd exe IN ("*httpd*", "*nginx*") AND args NOT IN (known_software) \| stats count by host, exe, args \| where count > 5`.<br>- **KQL**: `LinuxAuditd \| where ProcessName has_any ("httpd", "nginx") and CommandLine !has_any (knownSoftware) \| summarize count() by HostName, ProcessName, CommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE process.exe : ("*httpd*" OR "*nginx*") AND process.args NOT IN ['known_software'] \| STATS COUNT() BY host.name, process.exe, process.args HAVING COUNT() > 5`. |
| 5. Server Software Deployment via Compromised Endpoints | Compromised endpoints deploy malicious server software, as in FIN7. | - Process Creation (DS0009: Sysmon ID 1)<br>- Network Traffic (DS0003: Zeek HTTP) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*httpd.exe*", "*nginx.exe*") \| join host [search index=network sourcetype=zeek_http dest_ip IN (malware_c2_ips)] \| stats count by host, Image, dest_ip \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("httpd.exe", "nginx.exe") \| join kind=inner (DeviceNetworkEvents \| where Protocol == "HTTP" and RemoteIP in (malwareC2IPs)) on DeviceName \| summarize count() by DeviceName, ProcessName, RemoteIP \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*httpd.exe*" OR "*nginx.exe*") \| JOIN logs-zeek.http-* ON host.name WHERE destination.ip IN ['malware_c2_ips'] \| STATS COUNT() BY host.name, process.executable, destination.ip HAVING COUNT() > 5`. |
| 6. High-Frequency Server Software Deployment | High-frequency deployment of server software, as in APT41. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*httpd.exe*", "*nginx.exe*") \| timechart span=1m count by host \| where count > 50`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("httpd.exe", "nginx.exe") \| summarize MinuteCount=count() by bin(Timestamp, 1m), DeviceName \| where MinuteCount > 50`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*httpd.exe*" OR "*nginx.exe*") \| STATS COUNT() BY date_histogram(@timestamp, '1m'), host.name \| WHERE COUNT() > 50`. |
| 7. Server Software Deployment via Known Malicious IPs | Deployment of server software from known malicious IPs, as in Volt Typhoon. | - Network Traffic (DS0003: Zeek HTTP)<br>- Threat Intelligence | - **Splunk**: `index=network sourcetype=zeek_http src_ip IN (threat_intel_ips) AND uri IN ("*.exe", "*.msi") AND content IN ("*httpd*", "*nginx*") \| stats count by src_ip, uri \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and DeviceIP in (threatIntelIPs) and RemoteUrl has_any (".exe", ".msi") and HttpContent has_any ("httpd", "nginx") \| summarize count() by DeviceIP, RemoteUrl \| where count_ > 10`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE source.ip IN ['threat_intel_ips'] AND http.uri : ("*.exe" OR "*.msi") AND http.content : ("*httpd*" OR "*nginx*") \| STATS COUNT() BY source.ip, http.uri HAVING COUNT() > 10`. |
| 8. Server Software Deployment Outside Business Hours | Deployment of server software outside business hours, as in APT29. | - Process Creation (DS0009: Sysmon ID 1)<br>- Metrics | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image IN ("*httpd.exe*", "*nginx.exe*") \| timechart span=1h count by host \| where count > avg(count)*3 AND (_time < "08:00" OR _time > "18:00")`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessName has_any ("httpd.exe", "nginx.exe") \| summarize HourlyCount=count() by bin(Timestamp, 1h), DeviceName \| where HourlyCount > avg(HourlyCount) * 3 and (hour(Timestamp) < 8 or hour(Timestamp) > 18)`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.executable : ("*httpd.exe*" OR "*nginx.exe*") \| STATS COUNT() BY date_histogram(@timestamp, '1h'), host.name \| WHERE COUNT() > AVG(COUNT()) * 3 AND (HOUR(@timestamp) < 8 OR HOUR(@timestamp) > 18)`. |
| 9. Server Software Deployment with Suspicious File Metadata | Server software with unusual metadata deployed on endpoints, as in 2025 trends. | - File Creation (DS0013: Sysmon ID 11)<br>- File Metadata | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 FileName IN ("*httpd.exe*", "*nginx.exe*") AND FileSize < 100KB \| stats count by host, FileName \| where count > 5`.<br>- **KQL**: `DeviceFileEvents \| where FileName has_any ("httpd.exe", "nginx.exe") and FileSize < 100000 \| summarize count() by DeviceName, FileName \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.file-* \| WHERE file.name : ("*httpd.exe*" OR "*nginx.exe*") AND file.size < 100000 \| STATS COUNT() BY host.name, file.name HAVING COUNT() > 5`. |
| 10. Server Software Deployment in Cloud Environments | Adversaries deploy malicious server software in cloud environments, as in 2025 trends. | - Cloud Audit Logs (AWS CloudTrail)<br>- Process Creation (DS0009: Sysmon ID 1) | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName IN ("RunInstances", "StartInstances") AND requestParameters IN ("*httpd*", "*nginx*") AND src_ip IN (compromised_instances) \| stats count by src_ip, eventName, requestParameters \| where count > 5`.<br>- **KQL**: `AWSCloudTrail \| where EventName in ("RunInstances", "StartInstances") and RequestParameters has_any ("httpd", "nginx") and SourceIP in (compromisedInstances) \| summarize count() by SourceIP, EventName, RequestParameters \| where count_ > 5`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action IN ['RunInstances', 'StartInstances'] AND event.request_parameters : ("*httpd*" OR "*nginx*") AND source.ip IN ['compromised_instances'] \| STATS COUNT() BY source.ip, event.action, event.request_parameters HAVING COUNT() > 5`. |
