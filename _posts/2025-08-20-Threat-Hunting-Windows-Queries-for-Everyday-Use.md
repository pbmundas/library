---
layout: default
title: Windows Queries - Top 50
category: Threat-Hunting-Queries  # This becomes a main topic in sidebar
---


### Essential Threat Hunting Hypotheses for Windows Environments - Top 50

Threat hunting in Windows environments relies on structured hypotheses to proactively uncover hidden adversaries. These hypotheses are derived from common MITRE ATT&CK techniques, adapted for Windows telemetry (e.g., via Microsoft Defender XDR Advanced Hunting or Microsoft Sentinel using KQL). Each entry below includes:

- **Hypothesis**: A testable assumption about potential malicious activity.
- **Rationale**: Why it's relevant and what threats it targets (e.g., persistence, lateral movement).
- **Sample KQL Query**: A ready-to-run query for validation (assumes access to Advanced Hunting schema tables like DeviceProcessEvents, DeviceNetworkEvents). Adjust time ranges (e.g., `ago(7d)`) and baselines for your environment.
- **Expected Indicators**: Anomalies to investigate if results surface.

Run these weekly or on high-risk events to establish baselines. Prioritize based on your environment's exposure (e.g., RDP-heavy setups).

| #  | Hypothesis | Rationale | Sample KQL Query | Expected Indicators |
|----|------------|-----------|------------------|---------------------|
| 1  | Adversaries are creating or modifying Windows services for persistence (T1543.003). | Attackers abuse services to execute payloads at startup, often via sc.exe or registry changes. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where ProcessCommandLine has "sc create" or FolderCreatedType == "Service" \| project Timestamp, DeviceName, InitiatingProcessCommandLine, ProcessCommandLine \| summarize Count = count() by DeviceName \| where Count > 0` | Unusual service names (e.g., non-standard binaries in C:\Windows\System32). |
| 2  | Suspicious PowerShell execution is occurring without invocation details (T1059.001). | Obfuscated or encoded PowerShell is common for reconnaissance or execution, bypassing basic logging. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where FileName == "powershell.exe" and ProcessCommandLine has_any ("-EncodedCommand", "-enc", "-w hidden") \| project Timestamp, DeviceName, ProcessCommandLine, InitiatingProcessFileName` | Encoded strings or hidden windows; cross-check with ScriptBlockLogging. |
| 3  | Lateral movement via SMB is happening outside normal admin patterns (T1021.002). | Attackers use SMB for remote file shares, often with tools like net use or PsExec. | `DeviceNetworkEvents \| where Timestamp > ago(7d) \| where RemotePort == 445 and ActionType == "ConnectionSuccess" \| summarize Connections = count() by RemoteIP, InitiatingProcessFileName \| where Connections > 5` | High connection volume to internal IPs from non-admin processes. |
| 4  | RDP logons are from anomalous IPs or times (T1021.001). | RDP brute-forcing or hijacking is prevalent for initial access or pivoting. | `DeviceLogonEvents \| where Timestamp > ago(7d) \| where LogonType == "Interactive" and Protocol == "RemoteDesktop" \| summarize Logons = count() by AccountName, RemoteIP \| where Logons > 3` | Logons from external IPs or off-hours; join with IdentityLogonEvents for anomalies. |
| 5  | Scheduled tasks are being created or modified by non-system processes (T1053.005). | Persistence via tasks allows recurring execution, often via schtasks.exe. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where ProcessCommandLine has "schtasks /create" \| project Timestamp, DeviceName, InitiatingProcessFileName, ProcessCommandLine` | Tasks with suspicious paths (e.g., user-writable folders). |
| 6  | WMI is used for remote execution or reconnaissance (T1047). | WMI queries enable stealthy lateral movement or data gathering. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where ProcessCommandLine has "wmic" or FileName in ("wmiprvse.exe", "wmic.exe") \| where ProcessCommandLine !contains "query" \| summarize by DeviceName, ProcessCommandLine` | Non-standard WMI commands targeting remote hosts. |
| 7  | Anomalous command shells (e.g., cmd.exe) spawned from browsers or Office apps (T1059.003). | Living-off-the-land binaries (LOLBins) like cmd are abused for execution post-phishing. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where FileName == "cmd.exe" and InitiatingProcessFileName in ("excel.exe", "winword.exe", "chrome.exe") \| project Timestamp, DeviceName, InitiatingProcessCommandLine` | Shells with encoded args or unusual parent-child relationships. |
| 8  | Registry run keys are modified for persistence (T1547.001). | Attackers add entries to HKLM\Software\Microsoft\Windows\CurrentVersion\Run for auto-execution. | `DeviceRegistryEvents \| where Timestamp > ago(7d) \| where RegistryKey has "CurrentVersion\\Run" and ActionType == "RegistryValueSet" \| project Timestamp, DeviceName, RegistryKey, RegistryValueName, PreviousValue, SetValue` | New entries pointing to suspicious binaries (e.g., %TEMP%). |
| 9  | Net.exe or similar tools used for enumeration (T1087). | Domain recon via net view or net user reveals network structure. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where ProcessCommandLine has_any ("net view", "net user", "net group") \| summarize Executions = count() by DeviceName, AccountName` | High-volume runs from non-admin accounts. |
| 10 | PsExec or similar for remote admin (T1569.002). | Service-based lateral movement with PsExec leaves process artifacts. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where FileName == "PsExec.exe" or ProcessCommandLine has "-s -d" \| project Timestamp, DeviceName, ProcessCommandLine` | Executions targeting multiple remote hosts. |
| 11 | Cobalt Strike beacons via periodic network connections (T1071.001). | C2 communication often shows regular HTTP/S beacons to external IPs. | `DeviceNetworkEvents \| where Timestamp > ago(7d) \| where ActionType == "ConnectionSuccess" and RemotePort in (80, 443) \| summarize Intervals = avg(Timestamp - prev(Timestamp)) by RemoteIP \| where Intervals between (1min .. 5min)` | Consistent intervals (e.g., 60s) to high-reputation IPs. |
| 12 | Brute-force logon failures from single sources (T1110). | Failed auth attempts indicate credential stuffing. | `DeviceLogonEvents \| where Timestamp > ago(7d) \| where LogonType == "Network" and ActionType == "LogonFailed" \| summarize Failures = count() by AccountName, RemoteIP \| where Failures > 10` | >10 failures per IP/account in short bursts. |
| 13 | BITS jobs for download/cradle (T1105). | Background Intelligent Transfer Service used for stealthy file drops. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where ProcessCommandLine has "bitsadmin /create" or FileName == "bitsadmin.exe" \| project Timestamp, DeviceName, ProcessCommandLine` | Jobs downloading from suspicious URLs. |
| 14 | Certutil.exe for encoding/decoding (T1140). | LOLBin for base64 manipulation in payloads. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where FileName == "certutil.exe" and ProcessCommandLine has "-encode" \| project Timestamp, DeviceName, ProcessCommandLine` | Usage outside CA management contexts. |
| 15 | Unusual process from temp directories (T1204.002). | User execution of dropped files in %TEMP%. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where FolderPath has "%TEMP%" or FolderPath has "C:\\Users\\Public" \| summarize by FileName, FolderPath \| where FileName !in ("explorer.exe", "cmd.exe")` | Non-system binaries in writable folders. |
| 16 | Event log clearing attempts (T1070.001). | Attackers clear traces via wevtutil or PowerShell. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where ProcessCommandLine has "wevtutil cl" or ProcessCommandLine has "Clear-EventLog" \| project Timestamp, DeviceName, AccountName` | Executions by non-admins. |
| 17 | High-entropy file creation (T1027). | Packed/obfuscated binaries have high randomness. | `DeviceFileEvents \| where Timestamp > ago(7d) \| where FileName endswith ".exe" \| extend Entropy = iff(FileHasHighEntropy, "High", "Low") \| where Entropy == "High" \| project Timestamp, DeviceName, FileName, SHA256` | New EXEs with entropy >7.5; scan for malware. |
| 18 | Anomalous DNS queries to rare domains (T1071.004). | DNS tunneling or exfil via uncommon resolutions. | `DeviceDnsEvents \| where Timestamp > ago(7d) \| where NameType == "CNAME" or Name has "." and strlen(Name) > 50 \| summarize Queries = count() by Name \| where Queries < 5` | Long or encoded subdomains. |
| 19 | Privileged account creation (T1136). | New admins for escalation. | `DeviceEvents \| where Timestamp > ago(7d) \| where ActionType == "UserAccountCreated" and AdditionalFields has "Admin" \| project Timestamp, DeviceName, AccountName` | Accounts added to Administrators group. |
| 20 | WMIC for process creation (T1047). | Remote WMI process spawning. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where InitiatingProcessCommandLine has "wmic process call create" \| project Timestamp, DeviceName, ProcessCommandLine` | Commands spawning cmd or PowerShell remotely. |
| 21 | Reg.exe for adding firewall exceptions (T1562.004). | Impairing defenses via registry. | `DeviceRegistryEvents \| where Timestamp > ago(7d) \| where RegistryKey has "SYSTEM\\CurrentControlSet\\Services\\SharedAccess" and ActionType == "RegistryValueSet" \| project Timestamp, DeviceName, RegistryValueData` | New inbound rules allowing all traffic. |
| 22 | Unexpected child processes from lsass.exe (T1003.001). | Credential dumping tools spawn from LSASS. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where InitiatingProcessFileName == "lsass.exe" and FileName !in ("winlogon.exe") \| project Timestamp, DeviceName, FileName` | Rare children like mimikatz.exe. |
| 23 | Volume shadow copy deletion (T1003.002). | Disabling backups via vssadmin or PowerShell. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where ProcessCommandLine has "vssadmin delete shadows" \| project Timestamp, DeviceName, AccountName` | Executions by non-backup admins. |
| 24 | Mshta.exe executing JavaScript (T1218.005). | Signed binary for HTA drops. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where FileName == "mshta.exe" and ProcessCommandLine has ".js" \| project Timestamp, DeviceName, ProcessCommandLine` | Inline JS or VBS payloads. |
| 25 | Rundll32.exe with suspicious DLLs (T1218.011). | Reflective DLL loading for evasion. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where FileName == "rundll32.exe" and ProcessCommandLine !has "advpack" \| project Timestamp, DeviceName, ProcessCommandLine` | DLLs from user directories. |
| 26 | High CPU from svchost.exe instances (T1497). | Resource exhaustion via forks. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where FileName == "svchost.exe" \| summarize CPUUsage = avg(CPUUsagePercentage) by ProcessId \| where CPUUsage > 50` | Single instances spiking >50%. |
| 27 | Anomalous logons to domain controllers (T1078). | Pivoting to DCs for privilege escalation. | `DeviceLogonEvents \| where Timestamp > ago(7d) \| where DeviceName has "DC" and LogonType == "Network" \| summarize by AccountName, RemoteIP \| where AccountName !in ("Administrator")` | Non-service accounts from workstations. |
| 28 | PowerShell download cradles (T1105). | IEX (New-Object Net.WebClient).DownloadString. | `DeviceScriptEvents \| where Timestamp > ago(7d) \| where ScriptBlockText has "DownloadString" or ScriptBlockText has "IEX" \| project Timestamp, DeviceName, ScriptBlockText` | URLs to pastebin-like sites. |
| 29 | Share enumeration via net share (T1083). | File share discovery for exfil paths. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where ProcessCommandLine has "net share" \| summarize by DeviceName, AccountName` | Runs from compromised endpoints. |
| 30 | Suspicious at.exe usage (T1053.002). | Legacy scheduler for persistence. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where FileName == "at.exe" \| project Timestamp, DeviceName, ProcessCommandLine` | Any modern usage (deprecated). |
| 31 | Msbuild.exe for macro execution (T1127.001). | Office macros compiled via MSBuild. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where FileName == "msbuild.exe" and ProcessCommandLine has ".xml" \| project Timestamp, DeviceName, ProcessCommandLine` | XML payloads from docs. |
| 32 | Regsvr32.exe for remote DLLs (T1218.010). | Proxy execution via registration. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where FileName == "regsvr32.exe" and ProcessCommandLine has "/s /n /u /i:http" \| project Timestamp, DeviceName, ProcessCommandLine` | HTTP-sourced DLLs. |
| 33 | Unusual file modifications in system directories (T1565). | Dropping payloads in protected folders. | `DeviceFileEvents \| where Timestamp > ago(7d) \| where FolderPath has "C:\\Windows\\System32" and ActionType == "FileCreated" \| where FileName !in (known_good_list) \| project Timestamp, DeviceName, FileName` | Non-Microsoft signed files. |
| 34 | Kerberos ticket anomalies (T1558). | Golden/silver ticket forging. | `DeviceEvents \| where Timestamp > ago(7d) \| where ActionType == "KerberosTicket" and AdditionalFields has "Lifetime" \| where toint(AdditionalFields.Lifetime) > 10h \| project Timestamp, DeviceName` | Tickets >10 hours lifetime. |
| 35 | Fodhelper.exe bypass (T1548.002). | UAC bypass via registry hijack. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where FileName == "fodhelper.exe" and InitiatingProcessFileName == "explorer.exe" \| project Timestamp, DeviceName` | Elevated without prompt. |
| 36 | Installutil.exe for .NET execution (T1218.004). | Hosting malicious assemblies. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where FileName == "InstallUtil.exe" \| project Timestamp, DeviceName, ProcessCommandLine` | Args pointing to EXEs. |
| 37 | Cscript/wscript for VBS drops (T1059.005). | Script interpreters running malicious code. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where FileName in ("cscript.exe", "wscript.exe") and ProcessCommandLine has ".vbs" \| project Timestamp, DeviceName, ProcessCommandLine` | Embedded scripts with downloads. |
| 38 | Disk cleanup via cleanmgr (T1485). | Wiping traces post-exfil. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where FileName == "cleanmgr.exe" and ProcessCommandLine has "/sagerun" \| project Timestamp, DeviceName, AccountName` | Automated runs by users. |
| 39 | Odbcconf.exe for DLL loading (T1218.008). | Signed binary proxying. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where FileName == "odbcconf.exe" and ProcessCommandLine has "/f /a" \| project Timestamp, DeviceName, ProcessCommandLine` | Config files with DLLs. |
| 40 | Suspicious reg add for policies (T1112). | Modifying group policy for persistence. | `DeviceRegistryEvents \| where Timestamp > ago(7d) \| where ProcessCommandLine has "reg add" and RegistryKey has "Software\\Policies" \| project Timestamp, DeviceName, RegistryValueData` | Disabling security features. |
| 41 | Verclsid.exe for COM hijacking (T1546.015). | Component object model abuse. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where FileName == "verclsid.exe" \| project Timestamp, DeviceName, InitiatingProcessFileName` | Spawned from unusual parents. |
| 42 | High-volume reg query (T1012). | System info gathering via registry. | `DeviceRegistryEvents \| where Timestamp > ago(7d) \| where ActionType == "RegistryQuery" and RegistryKey has "HARDWARE\\DESCRIPTION" \| summarize Queries = count() by DeviceName \| where Queries > 50` | Bursts from single processes. |
| 43 | Sdbinst.exe for shim database (T1546.008). | App compatibility shims for injection. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where FileName == "sdbinst.exe" and ProcessCommandLine has "-q" \| project Timestamp, DeviceName, ProcessCommandLine` | Custom databases added. |
| 44 | Dnx.exe for .NET execution (T1059.007). | Legacy .NET host for payloads. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where FileName == "dnx.exe" \| project Timestamp, DeviceName, ProcessCommandLine` | Any usage in modern envs. |
| 45 | Mavinject.exe for DLL injection (T1055.001). | Process hollowing via manifests. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where FileName == "mavinject.exe" and ProcessCommandLine has "/INJECTDLL" \| project Timestamp, DeviceName, ProcessCommandLine` | Targets like explorer.exe. |
| 46 | New-NetFirewallRule via PowerShell (T1562.004). | Disabling host firewall. | `DeviceScriptEvents \| where Timestamp > ago(7d) \| where ScriptBlockText has "New-NetFirewallRule" and ScriptBlockText has "Action=Allow" \| project Timestamp, DeviceName, ScriptBlockText` | Rules allowing broad ports. |
| 47 | Unusual syncappvpublishingserver.exe (T1543.003). | App-V for persistence. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where FileName == "syncappvpublishingserver.exe" \| project Timestamp, DeviceName, InitiatingProcessFileName` | Non-standard spawning. |
| 48 | Reg.exe delete for anti-forensics (T1070.004). | Clearing registry artifacts. | `DeviceRegistryEvents \| where Timestamp > ago(7d) \| where ProcessCommandLine has "reg delete" and RegistryKey has "CurrentVersion\\Run" \| project Timestamp, DeviceName` | Deletions in persistence keys. |
| 49 | High failed RDP from single IP (T1110). | RDP spraying. | `DeviceLogonEvents \| where Timestamp > ago(7d) \| where LogonType == "Interactive" and ActionType == "LogonFailed" and Protocol == "RemoteDesktop" \| summarize by RemoteIP \| where count_ > 20` | >20 failures per external IP. |
| 50 | Anomalous msiexec.exe with MST (T1218.007). | MSI tampering for execution. | `DeviceProcessEvents \| where Timestamp > ago(7d) \| where FileName == "msiexec.exe" and ProcessCommandLine has ".mst" \| project Timestamp, DeviceName, ProcessCommandLine` | Transforms from untrusted sources. |

These cover core tactics like Execution (TA0002), Persistence (TA0003), and Defense Evasion (TA0005). For deeper validation, join tables (e.g., with AlertEvidence) and baseline counts. Explore repos like [cyb3rmik3/KQL-threat-hunting-queries](https://github.com/cyb3rmik3/KQL-threat-hunting-queries) for expansions.
